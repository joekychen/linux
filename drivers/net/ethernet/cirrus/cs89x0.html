<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › ethernet › cirrus › cs89x0.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>cs89x0.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/* cs89x0.c: A Crystal Semiconductor (Now Cirrus Logic) CS89[02]0</span>
<span class="cm"> *           driver for linux.</span>
<span class="cm"> * Written 1996 by Russell Nelson, with reference to skeleton.c</span>
<span class="cm"> * written 1993-1994 by Donald Becker.</span>
<span class="cm"> *</span>
<span class="cm"> * This software may be used and distributed according to the terms</span>
<span class="cm"> * of the GNU General Public License, incorporated herein by reference.</span>
<span class="cm"> *</span>
<span class="cm"> * The author may be reached at nelson@crynwr.com, Crynwr</span>
<span class="cm"> * Software, 521 Pleasant Valley Rd., Potsdam, NY 13676</span>
<span class="cm"> *</span>
<span class="cm"> * Other contributors:</span>
<span class="cm"> * Mike Cruse        : mcruse@cti-ltd.com</span>
<span class="cm"> * Russ Nelson</span>
<span class="cm"> * Melody Lee        : ethernet@crystal.cirrus.com</span>
<span class="cm"> * Alan Cox</span>
<span class="cm"> * Andrew Morton</span>
<span class="cm"> * Oskar Schirmer    : oskar@scara.com</span>
<span class="cm"> * Deepak Saxena     : dsaxena@plexity.net</span>
<span class="cm"> * Dmitry Pervushin  : dpervushin@ru.mvista.com</span>
<span class="cm"> * Deepak Saxena     : dsaxena@plexity.net</span>
<span class="cm"> * Domenico Andreoli : cavokz@gmail.com</span>
<span class="cm"> */</span>


<span class="cm">/*</span>
<span class="cm"> * Set this to zero to disable DMA code</span>
<span class="cm"> *</span>
<span class="cm"> * Note that even if DMA is turned off we still support the &#39;dma&#39; and  &#39;use_dma&#39;</span>
<span class="cm"> * module options so we don&#39;t break any startup scripts.</span>
<span class="cm"> */</span>
<span class="cp">#ifndef CONFIG_ISA_DMA_API</span>
<span class="cp">#define ALLOW_DMA	0</span>
<span class="cp">#else</span>
<span class="cp">#define ALLOW_DMA	1</span>
<span class="cp">#endif</span>

<span class="cm">/*</span>
<span class="cm"> * Set this to zero to remove all the debug statements via</span>
<span class="cm"> * dead code elimination</span>
<span class="cm"> */</span>
<span class="cp">#define DEBUGGING	1</span>

<span class="cm">/* Sources:</span>
<span class="cm"> *	Crynwr packet driver epktisa.</span>
<span class="cm"> *	Crystal Semiconductor data sheets.</span>
<span class="cm"> */</span>

<span class="cp">#define pr_fmt(fmt) KBUILD_MODNAME &quot;: &quot; fmt</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/printk.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/netdevice.h&gt;</span>
<span class="cp">#include &lt;linux/etherdevice.h&gt;</span>
<span class="cp">#include &lt;linux/platform_device.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/fcntl.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/ioport.h&gt;</span>
<span class="cp">#include &lt;linux/in.h&gt;</span>
<span class="cp">#include &lt;linux/skbuff.h&gt;</span>
<span class="cp">#include &lt;linux/spinlock.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/bitops.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/gfp.h&gt;</span>
<span class="cp">#include &lt;linux/io.h&gt;</span>

<span class="cp">#include &lt;asm/irq.h&gt;</span>
<span class="cp">#include &lt;linux/atomic.h&gt;</span>
<span class="cp">#if ALLOW_DMA</span>
<span class="cp">#include &lt;asm/dma.h&gt;</span>
<span class="cp">#endif</span>

<span class="cp">#include &quot;cs89x0.h&quot;</span>

<span class="cp">#define cs89_dbg(val, level, fmt, ...)				\</span>
<span class="cp">do {								\</span>
<span class="cp">	if (val &lt;= net_debug)					\</span>
<span class="cp">		pr_##level(fmt, ##__VA_ARGS__);			\</span>
<span class="cp">} while (0)</span>

<span class="k">static</span> <span class="kt">char</span> <span class="n">version</span><span class="p">[]</span> <span class="n">__initdata</span> <span class="o">=</span>
	<span class="s">&quot;v2.4.3-pre1 Russell Nelson &lt;nelson@crynwr.com&gt;, Andrew Morton&quot;</span><span class="p">;</span>

<span class="cp">#define DRV_NAME &quot;cs89x0&quot;</span>

<span class="cm">/* First, a few definitions that the brave might change.</span>
<span class="cm"> * A zero-terminated list of I/O addresses to be probed. Some special flags..</span>
<span class="cm"> * Addr &amp; 1 = Read back the address port, look for signature and reset</span>
<span class="cm"> * the page window before probing</span>
<span class="cm"> * Addr &amp; 3 = Reset the page window and probe</span>
<span class="cm"> * The CLPS eval board has the Cirrus chip at 0x80090300, in ARM IO space,</span>
<span class="cm"> * but it is possible that a Cirrus board could be plugged into the ISA</span>
<span class="cm"> * slots.</span>
<span class="cm"> */</span>
<span class="cm">/* The cs8900 has 4 IRQ pins, software selectable. cs8900_irq_map maps</span>
<span class="cm"> * them to system IRQ numbers. This mapping is card specific and is set to</span>
<span class="cm"> * the configuration of the Cirrus Eval board for this chip.</span>
<span class="cm"> */</span>
<span class="cp">#if defined(CONFIG_MACH_IXDP2351)</span>
<span class="cp">#define CS89x0_NONISA_IRQ</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">netcard_portlist</span><span class="p">[]</span> <span class="n">__used</span> <span class="n">__initdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">IXDP2351_VIRT_CS8900_BASE</span><span class="p">,</span> <span class="mi">0</span>
<span class="p">};</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cs8900_irq_map</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">IRQ_IXDP2351_CS8900</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
<span class="p">};</span>
<span class="cp">#elif defined(CONFIG_ARCH_IXDP2X01)</span>
<span class="cp">#define CS89x0_NONISA_IRQ</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">netcard_portlist</span><span class="p">[]</span> <span class="n">__used</span> <span class="n">__initdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">IXDP2X01_CS8900_VIRT_BASE</span><span class="p">,</span> <span class="mi">0</span>
<span class="p">};</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cs8900_irq_map</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">IRQ_IXDP2X01_CS8900</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
<span class="p">};</span>
<span class="cp">#else</span>
<span class="cp">#ifndef CONFIG_CS89x0_PLATFORM</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">netcard_portlist</span><span class="p">[]</span> <span class="n">__used</span> <span class="n">__initdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mh">0x300</span><span class="p">,</span> <span class="mh">0x320</span><span class="p">,</span> <span class="mh">0x340</span><span class="p">,</span> <span class="mh">0x360</span><span class="p">,</span> <span class="mh">0x200</span><span class="p">,</span> <span class="mh">0x220</span><span class="p">,</span> <span class="mh">0x240</span><span class="p">,</span>
	<span class="mh">0x260</span><span class="p">,</span> <span class="mh">0x280</span><span class="p">,</span> <span class="mh">0x2a0</span><span class="p">,</span> <span class="mh">0x2c0</span><span class="p">,</span> <span class="mh">0x2e0</span><span class="p">,</span> <span class="mi">0</span>
<span class="p">};</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cs8900_irq_map</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mi">10</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">5</span>
<span class="p">};</span>
<span class="cp">#endif</span>
<span class="cp">#endif</span>

<span class="cp">#if DEBUGGING</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">net_debug</span> <span class="o">=</span> <span class="n">DEBUGGING</span><span class="p">;</span>
<span class="cp">#else</span>
<span class="cp">#define net_debug 0	</span><span class="cm">/* gcc will remove all the debug code for us */</span><span class="cp"></span>
<span class="cp">#endif</span>

<span class="cm">/* The number of low I/O ports used by the ethercard. */</span>
<span class="cp">#define NETCARD_IO_EXTENT	16</span>

<span class="cm">/* we allow the user to override various values normally set in the EEPROM */</span>
<span class="cp">#define FORCE_RJ45	0x0001    </span><span class="cm">/* pick one of these three */</span><span class="cp"></span>
<span class="cp">#define FORCE_AUI	0x0002</span>
<span class="cp">#define FORCE_BNC	0x0004</span>

<span class="cp">#define FORCE_AUTO	0x0010    </span><span class="cm">/* pick one of these three */</span><span class="cp"></span>
<span class="cp">#define FORCE_HALF	0x0020</span>
<span class="cp">#define FORCE_FULL	0x0030</span>

<span class="cm">/* Information that need to be kept for each board. */</span>
<span class="k">struct</span> <span class="n">net_local</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="n">chip_type</span><span class="p">;</span>		<span class="cm">/* one of: CS8900, CS8920, CS8920M */</span>
	<span class="kt">char</span> <span class="n">chip_revision</span><span class="p">;</span>	<span class="cm">/* revision letter of the chip (&#39;A&#39;...) */</span>
	<span class="kt">int</span> <span class="n">send_cmd</span><span class="p">;</span>		<span class="cm">/* the proper send command: TX_NOW, TX_AFTER_381, or TX_AFTER_ALL */</span>
	<span class="kt">int</span> <span class="n">auto_neg_cnf</span><span class="p">;</span>	<span class="cm">/* auto-negotiation word from EEPROM */</span>
	<span class="kt">int</span> <span class="n">adapter_cnf</span><span class="p">;</span>	<span class="cm">/* adapter configuration from EEPROM */</span>
	<span class="kt">int</span> <span class="n">isa_config</span><span class="p">;</span>		<span class="cm">/* ISA configuration from EEPROM */</span>
	<span class="kt">int</span> <span class="n">irq_map</span><span class="p">;</span>		<span class="cm">/* IRQ map from EEPROM */</span>
	<span class="kt">int</span> <span class="n">rx_mode</span><span class="p">;</span>		<span class="cm">/* what mode are we in? 0, RX_MULTCAST_ACCEPT, or RX_ALL_ACCEPT */</span>
	<span class="kt">int</span> <span class="n">curr_rx_cfg</span><span class="p">;</span>	<span class="cm">/* a copy of PP_RxCFG */</span>
	<span class="kt">int</span> <span class="n">linectl</span><span class="p">;</span>		<span class="cm">/* either 0 or LOW_RX_SQUELCH, depending on configuration. */</span>
	<span class="kt">int</span> <span class="n">send_underrun</span><span class="p">;</span>	<span class="cm">/* keep track of how many underruns in a row we get */</span>
	<span class="kt">int</span> <span class="n">force</span><span class="p">;</span>		<span class="cm">/* force various values; see FORCE* above. */</span>
	<span class="n">spinlock_t</span> <span class="n">lock</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">virt_addr</span><span class="p">;</span><span class="cm">/* CS89x0 virtual address. */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">size</span><span class="p">;</span>	<span class="cm">/* Length of CS89x0 memory region. */</span>
<span class="cp">#if ALLOW_DMA</span>
	<span class="kt">int</span> <span class="n">use_dma</span><span class="p">;</span>		<span class="cm">/* Flag: we&#39;re using dma */</span>
	<span class="kt">int</span> <span class="n">dma</span><span class="p">;</span>		<span class="cm">/* DMA channel */</span>
	<span class="kt">int</span> <span class="n">dmasize</span><span class="p">;</span>		<span class="cm">/* 16 or 64 */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">dma_buff</span><span class="p">;</span>	<span class="cm">/* points to the beginning of the buffer */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">end_dma_buff</span><span class="p">;</span>	<span class="cm">/* points to the end of the buffer */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">rx_dma_ptr</span><span class="p">;</span>	<span class="cm">/* points to the next packet  */</span>
<span class="cp">#endif</span>
<span class="p">};</span>

<span class="cm">/* Example routines you must write ;-&gt;. */</span>
<span class="cp">#define tx_done(dev) 1</span>

<span class="cm">/*</span>
<span class="cm"> * Permit &#39;cs89x0_dma=N&#39; in the kernel boot environment</span>
<span class="cm"> */</span>
<span class="cp">#if !defined(MODULE)</span>
<span class="cp">#if ALLOW_DMA</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">g_cs89x0_dma</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">dma_fn</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">g_cs89x0_dma</span> <span class="o">=</span> <span class="n">simple_strtol</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">__setup</span><span class="p">(</span><span class="s">&quot;cs89x0_dma=&quot;</span><span class="p">,</span> <span class="n">dma_fn</span><span class="p">);</span>
<span class="cp">#endif	</span><span class="cm">/* ALLOW_DMA */</span><span class="cp"></span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">g_cs89x0_media__force</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">media_fn</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="s">&quot;rj45&quot;</span><span class="p">))</span>
		<span class="n">g_cs89x0_media__force</span> <span class="o">=</span> <span class="n">FORCE_RJ45</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="s">&quot;aui&quot;</span><span class="p">))</span>
		<span class="n">g_cs89x0_media__force</span> <span class="o">=</span> <span class="n">FORCE_AUI</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="s">&quot;bnc&quot;</span><span class="p">))</span>
		<span class="n">g_cs89x0_media__force</span> <span class="o">=</span> <span class="n">FORCE_BNC</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">__setup</span><span class="p">(</span><span class="s">&quot;cs89x0_media=&quot;</span><span class="p">,</span> <span class="n">media_fn</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="cp">#if defined(CONFIG_MACH_IXDP2351)</span>
<span class="k">static</span> <span class="n">u16</span>
<span class="nf">readword</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">base_addr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">portno</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">__raw_readw</span><span class="p">(</span><span class="n">base_addr</span> <span class="o">+</span> <span class="p">(</span><span class="n">portno</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">writeword</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">base_addr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">portno</span><span class="p">,</span> <span class="n">u16</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__raw_writew</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">base_addr</span> <span class="o">+</span> <span class="p">(</span><span class="n">portno</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">));</span>
<span class="p">}</span>
<span class="cp">#elif defined(CONFIG_ARCH_IXDP2X01)</span>
<span class="k">static</span> <span class="n">u16</span>
<span class="nf">readword</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">base_addr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">portno</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">__raw_readl</span><span class="p">(</span><span class="n">base_addr</span> <span class="o">+</span> <span class="p">(</span><span class="n">portno</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">writeword</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">base_addr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">portno</span><span class="p">,</span> <span class="n">u16</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">base_addr</span> <span class="o">+</span> <span class="p">(</span><span class="n">portno</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">));</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">readwords</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_local</span> <span class="o">*</span><span class="n">lp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">portno</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">length</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">buf8</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">buf</span><span class="p">;</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">u16</span> <span class="n">tmp16</span><span class="p">;</span>

		<span class="n">tmp16</span> <span class="o">=</span> <span class="n">ioread16</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">virt_addr</span> <span class="o">+</span> <span class="n">portno</span><span class="p">);</span>
		<span class="o">*</span><span class="n">buf8</span><span class="o">++</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">tmp16</span><span class="p">;</span>
		<span class="o">*</span><span class="n">buf8</span><span class="o">++</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)(</span><span class="n">tmp16</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">length</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">writewords</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_local</span> <span class="o">*</span><span class="n">lp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">portno</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">length</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">buf8</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">buf</span><span class="p">;</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">u16</span> <span class="n">tmp16</span><span class="p">;</span>

		<span class="n">tmp16</span> <span class="o">=</span> <span class="o">*</span><span class="n">buf8</span><span class="o">++</span><span class="p">;</span>
		<span class="n">tmp16</span> <span class="o">|=</span> <span class="p">(</span><span class="o">*</span><span class="n">buf8</span><span class="o">++</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">iowrite16</span><span class="p">(</span><span class="n">tmp16</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">virt_addr</span> <span class="o">+</span> <span class="n">portno</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">length</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u16</span>
<span class="nf">readreg</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u16</span> <span class="n">regno</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_local</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">iowrite16</span><span class="p">(</span><span class="n">regno</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">virt_addr</span> <span class="o">+</span> <span class="n">ADD_PORT</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ioread16</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">virt_addr</span> <span class="o">+</span> <span class="n">DATA_PORT</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">writereg</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u16</span> <span class="n">regno</span><span class="p">,</span> <span class="n">u16</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_local</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">iowrite16</span><span class="p">(</span><span class="n">regno</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">virt_addr</span> <span class="o">+</span> <span class="n">ADD_PORT</span><span class="p">);</span>
	<span class="n">iowrite16</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">virt_addr</span> <span class="o">+</span> <span class="n">DATA_PORT</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span>
<span class="nf">wait_eeprom_ready</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">timeout</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
	<span class="cm">/* check to see if the EEPROM is ready,</span>
<span class="cm">	 * a timeout is used just in case EEPROM is ready when</span>
<span class="cm">	 * SI_BUSY in the PP_SelfST is clear</span>
<span class="cm">	 */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">readreg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PP_SelfST</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">SI_BUSY</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">jiffies</span> <span class="o">-</span> <span class="n">timeout</span> <span class="o">&gt;=</span> <span class="mi">40</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span>
<span class="nf">get_eeprom_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">off</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">buffer</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">cs89_dbg</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="s">&quot;EEPROM data from %x for %x:&quot;</span><span class="p">,</span> <span class="n">off</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">wait_eeprom_ready</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="cm">/* Now send the EEPROM read command and EEPROM location to read */</span>
		<span class="n">writereg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PP_EECMD</span><span class="p">,</span> <span class="p">(</span><span class="n">off</span> <span class="o">+</span> <span class="n">i</span><span class="p">)</span> <span class="o">|</span> <span class="n">EEPROM_READ_CMD</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">wait_eeprom_ready</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">buffer</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">readreg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PP_EEData</span><span class="p">);</span>
		<span class="n">cs89_dbg</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">cont</span><span class="p">,</span> <span class="s">&quot; %04x&quot;</span><span class="p">,</span> <span class="n">buffer</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="p">}</span>
	<span class="n">cs89_dbg</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">cont</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>  <span class="n">__init</span>
<span class="nf">get_eeprom_cksum</span><span class="p">(</span><span class="kt">int</span> <span class="n">off</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">buffer</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">cksum</span><span class="p">;</span>

	<span class="n">cksum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">cksum</span> <span class="o">+=</span> <span class="n">buffer</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
	<span class="n">cksum</span> <span class="o">&amp;=</span> <span class="mh">0xffff</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cksum</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">write_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">chip_type</span><span class="p">,</span> <span class="kt">int</span> <span class="n">irq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chip_type</span> <span class="o">==</span> <span class="n">CS8900</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifndef CONFIG_CS89x0_PLATFORM</span>
		<span class="cm">/* Search the mapping table for the corresponding IRQ pin. */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">!=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">cs8900_irq_map</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cs8900_irq_map</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">irq</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="cm">/* Not found */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">cs8900_irq_map</span><span class="p">))</span>
			<span class="n">i</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
<span class="cp">#else</span>
		<span class="cm">/* INTRQ0 pin is used for interrupt generation. */</span>
		<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#endif</span>
		<span class="n">writereg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PP_CS8900_ISAINT</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">writereg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PP_CS8920_ISAINT</span><span class="p">,</span> <span class="n">irq</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">count_rx_errors</span><span class="p">(</span><span class="kt">int</span> <span class="n">status</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_errors</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">RX_RUNT</span><span class="p">)</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_length_errors</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">RX_EXTRA_DATA</span><span class="p">)</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_length_errors</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">RX_CRC_ERROR</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">RX_EXTRA_DATA</span> <span class="o">|</span> <span class="n">RX_RUNT</span><span class="p">)))</span>
		<span class="cm">/* per str 172 */</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_crc_errors</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">RX_DRIBBLE</span><span class="p">)</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_frame_errors</span><span class="o">++</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*********************************</span>
<span class="cm"> * This page contains DMA routines</span>
<span class="cm"> *********************************/</span>

<span class="cp">#if ALLOW_DMA</span>

<span class="cp">#define dma_page_eq(ptr1, ptr2) ((long)(ptr1) &gt;&gt; 17 == (long)(ptr2) &gt;&gt; 17)</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">get_dma_channel</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_local</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dma</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">;</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">isa_config</span> <span class="o">|=</span> <span class="n">ISA_RxDMA</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">isa_config</span> <span class="o">&amp;</span> <span class="n">ANY_ISA_DMA</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dma</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">isa_config</span> <span class="o">&amp;</span> <span class="n">DMA_NO_MASK</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">chip_type</span> <span class="o">==</span> <span class="n">CS8900</span><span class="p">)</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dma</span> <span class="o">+=</span> <span class="mi">5</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dma</span> <span class="o">&lt;</span> <span class="mi">5</span> <span class="o">||</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dma</span> <span class="o">&gt;</span> <span class="mi">7</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">lp</span><span class="o">-&gt;</span><span class="n">isa_config</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ANY_ISA_DMA</span><span class="p">;</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">write_dma</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">chip_type</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dma</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_local</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">isa_config</span> <span class="o">&amp;</span> <span class="n">ANY_ISA_DMA</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip_type</span> <span class="o">==</span> <span class="n">CS8900</span><span class="p">)</span>
		<span class="n">writereg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PP_CS8900_ISADMA</span><span class="p">,</span> <span class="n">dma</span> <span class="o">-</span> <span class="mi">5</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">writereg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PP_CS8920_ISADMA</span><span class="p">,</span> <span class="n">dma</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">set_dma_cfg</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_local</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">use_dma</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">isa_config</span> <span class="o">&amp;</span> <span class="n">ANY_ISA_DMA</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cs89_dbg</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">err</span><span class="p">,</span> <span class="s">&quot;set_dma_cfg(): no DMA</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">isa_config</span> <span class="o">&amp;</span> <span class="n">ISA_RxDMA</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">lp</span><span class="o">-&gt;</span><span class="n">curr_rx_cfg</span> <span class="o">|=</span> <span class="n">RX_DMA_ONLY</span><span class="p">;</span>
			<span class="n">cs89_dbg</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="s">&quot;set_dma_cfg(): RX_DMA_ONLY</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">lp</span><span class="o">-&gt;</span><span class="n">curr_rx_cfg</span> <span class="o">|=</span> <span class="n">AUTO_RX_DMA</span><span class="p">;</span>	<span class="cm">/* not that we support it... */</span>
			<span class="n">cs89_dbg</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="s">&quot;set_dma_cfg(): AUTO_RX_DMA</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">dma_bufcfg</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_local</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">use_dma</span><span class="p">)</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">isa_config</span> <span class="o">&amp;</span> <span class="n">ANY_ISA_DMA</span><span class="p">)</span> <span class="o">?</span> <span class="n">RX_DMA_ENBL</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">dma_busctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_local</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">use_dma</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">isa_config</span> <span class="o">&amp;</span> <span class="n">ANY_ISA_DMA</span><span class="p">)</span>
			<span class="n">retval</span> <span class="o">|=</span> <span class="n">RESET_RX_DMA</span><span class="p">;</span> <span class="cm">/* Reset the DMA pointer */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">isa_config</span> <span class="o">&amp;</span> <span class="n">DMA_BURST</span><span class="p">)</span>
			<span class="n">retval</span> <span class="o">|=</span> <span class="n">DMA_BURST_MODE</span><span class="p">;</span> <span class="cm">/* Does ISA config specify DMA burst ? */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">dmasize</span> <span class="o">==</span> <span class="mi">64</span><span class="p">)</span>
			<span class="n">retval</span> <span class="o">|=</span> <span class="n">RX_DMA_SIZE_64K</span><span class="p">;</span> <span class="cm">/* did they ask for 64K? */</span>
		<span class="n">retval</span> <span class="o">|=</span> <span class="n">MEMORY_ON</span><span class="p">;</span>	<span class="cm">/* we need memory enabled to use DMA. */</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">dma_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_local</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">,</span> <span class="n">length</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_dma_ptr</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">bp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">bp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">length</span> <span class="o">=</span> <span class="n">bp</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">bp</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">bp</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>

	<span class="n">cs89_dbg</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="n">debug</span><span class="p">,</span> <span class="s">&quot;%s: receiving DMA packet at %lx, status %x, length %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">bp</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">length</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">RX_OK</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">count_rx_errors</span><span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">skip_this_frame</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Malloc up new buffer. */</span>
	<span class="n">skb</span> <span class="o">=</span> <span class="n">netdev_alloc_skb</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">length</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* I don&#39;t think we want to do this to a stressed system */</span>
		<span class="n">cs89_dbg</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">err</span><span class="p">,</span> <span class="s">&quot;%s: Memory squeeze, dropping packet</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_dropped</span><span class="o">++</span><span class="p">;</span>

		<span class="cm">/* AKPM: advance bp to the next frame */</span>
<span class="nl">skip_this_frame:</span>
		<span class="n">bp</span> <span class="o">+=</span> <span class="p">(</span><span class="n">length</span> <span class="o">+</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">3</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bp</span> <span class="o">&gt;=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">end_dma_buff</span><span class="p">)</span>
			<span class="n">bp</span> <span class="o">-=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">dmasize</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">;</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_dma_ptr</span> <span class="o">=</span> <span class="n">bp</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">skb_reserve</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>	<span class="cm">/* longword align L3 header */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bp</span> <span class="o">+</span> <span class="n">length</span> <span class="o">&gt;</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">end_dma_buff</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">semi_cnt</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">end_dma_buff</span> <span class="o">-</span> <span class="n">bp</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">semi_cnt</span><span class="p">),</span> <span class="n">bp</span><span class="p">,</span> <span class="n">semi_cnt</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">length</span> <span class="o">-</span> <span class="n">semi_cnt</span><span class="p">),</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">dma_buff</span><span class="p">,</span>
		       <span class="n">length</span> <span class="o">-</span> <span class="n">semi_cnt</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">length</span><span class="p">),</span> <span class="n">bp</span><span class="p">,</span> <span class="n">length</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">bp</span> <span class="o">+=</span> <span class="p">(</span><span class="n">length</span> <span class="o">+</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">3</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bp</span> <span class="o">&gt;=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">end_dma_buff</span><span class="p">)</span>
		<span class="n">bp</span> <span class="o">-=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">dmasize</span><span class="o">*</span><span class="mi">1024</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_dma_ptr</span> <span class="o">=</span> <span class="n">bp</span><span class="p">;</span>

	<span class="n">cs89_dbg</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="s">&quot;%s: received %d byte DMA packet of type %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span>
		 <span class="p">((</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">ETH_ALEN</span> <span class="o">+</span> <span class="n">ETH_ALEN</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span>
		  <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">ETH_ALEN</span> <span class="o">+</span> <span class="n">ETH_ALEN</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]));</span>

	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">eth_type_trans</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="n">netif_rx</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_packets</span><span class="o">++</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_bytes</span> <span class="o">+=</span> <span class="n">length</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">release_dma_buff</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_local</span> <span class="o">*</span><span class="n">lp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">dma_buff</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">free_pages</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">dma_buff</span><span class="p">),</span>
			   <span class="n">get_order</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">dmasize</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">));</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">dma_buff</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cp">#endif	</span><span class="cm">/* ALLOW_DMA */</span><span class="cp"></span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">control_dc_dc</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">on_not_off</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_local</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">selfcontrol</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">timenow</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
	<span class="cm">/* control the DC to DC convertor in the SelfControl register.</span>
<span class="cm">	 * Note: This is hooked up to a general purpose pin, might not</span>
<span class="cm">	 * always be a DC to DC convertor.</span>
<span class="cm">	 */</span>

	<span class="n">selfcontrol</span> <span class="o">=</span> <span class="n">HCB1_ENBL</span><span class="p">;</span> <span class="cm">/* Enable the HCB1 bit as an output */</span>
	<span class="k">if</span> <span class="p">(((</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">adapter_cnf</span> <span class="o">&amp;</span> <span class="n">A_CNF_DC_DC_POLARITY</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">^</span> <span class="n">on_not_off</span><span class="p">)</span>
		<span class="n">selfcontrol</span> <span class="o">|=</span> <span class="n">HCB1</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">selfcontrol</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">HCB1</span><span class="p">;</span>
	<span class="n">writereg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PP_SelfCTL</span><span class="p">,</span> <span class="n">selfcontrol</span><span class="p">);</span>

	<span class="cm">/* Wait for the DC/DC converter to power up - 500ms */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">jiffies</span> <span class="o">-</span> <span class="n">timenow</span> <span class="o">&lt;</span> <span class="n">HZ</span><span class="p">)</span>
		<span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* send a test packet - return true if carrier bits are ok */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">send_test_pkt</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_local</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">char</span> <span class="n">test_packet</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
		<span class="mi">0</span><span class="p">,</span> <span class="mi">46</span><span class="p">,</span>		<span class="cm">/* A 46 in network order */</span>
		<span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>		<span class="cm">/* DSAP=0 &amp; SSAP=0 fields */</span>
		<span class="mh">0xf3</span><span class="p">,</span> <span class="mi">0</span>		<span class="cm">/* Control (Test Req + P bit set) */</span>
	<span class="p">};</span>
	<span class="kt">long</span> <span class="n">timenow</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>

	<span class="n">writereg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PP_LineCTL</span><span class="p">,</span> <span class="n">readreg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PP_LineCTL</span><span class="p">)</span> <span class="o">|</span> <span class="n">SERIAL_TX_ON</span><span class="p">);</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">test_packet</span><span class="p">,</span>            <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">test_packet</span> <span class="o">+</span> <span class="n">ETH_ALEN</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>

	<span class="n">iowrite16</span><span class="p">(</span><span class="n">TX_AFTER_ALL</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">virt_addr</span> <span class="o">+</span> <span class="n">TX_CMD_PORT</span><span class="p">);</span>
	<span class="n">iowrite16</span><span class="p">(</span><span class="n">ETH_ZLEN</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">virt_addr</span> <span class="o">+</span> <span class="n">TX_LEN_PORT</span><span class="p">);</span>

	<span class="cm">/* Test to see if the chip has allocated memory for the packet */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">jiffies</span> <span class="o">-</span> <span class="n">timenow</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">readreg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PP_BusST</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">READY_FOR_TX_NOW</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">jiffies</span> <span class="o">-</span> <span class="n">timenow</span> <span class="o">&gt;=</span> <span class="mi">5</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* this shouldn&#39;t happen */</span>

	<span class="cm">/* Write the contents of the packet */</span>
	<span class="n">writewords</span><span class="p">(</span><span class="n">lp</span><span class="p">,</span> <span class="n">TX_FRAME_PORT</span><span class="p">,</span> <span class="n">test_packet</span><span class="p">,</span> <span class="p">(</span><span class="n">ETH_ZLEN</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">cs89_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">debug</span><span class="p">,</span> <span class="s">&quot;Sending test packet &quot;</span><span class="p">);</span>
	<span class="cm">/* wait a couple of jiffies for packet to be received */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">timenow</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span> <span class="n">jiffies</span> <span class="o">-</span> <span class="n">timenow</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">;)</span>
		<span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">readreg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PP_TxEvent</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">TX_SEND_OK_BITS</span><span class="p">)</span> <span class="o">==</span> <span class="n">TX_OK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cs89_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">cont</span><span class="p">,</span> <span class="s">&quot;succeeded</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">cs89_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">cont</span><span class="p">,</span> <span class="s">&quot;failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define DETECTED_NONE  0</span>
<span class="cp">#define DETECTED_RJ45H 1</span>
<span class="cp">#define DETECTED_RJ45F 2</span>
<span class="cp">#define DETECTED_AUI   3</span>
<span class="cp">#define DETECTED_BNC   4</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">detect_tp</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_local</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">timenow</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">fdx</span><span class="p">;</span>

	<span class="n">cs89_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">debug</span><span class="p">,</span> <span class="s">&quot;%s: Attempting TP</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="cm">/* If connected to another full duplex capable 10-Base-T card</span>
<span class="cm">	 * the link pulses seem to be lost when the auto detect bit in</span>
<span class="cm">	 * the LineCTL is set.  To overcome this the auto detect bit will</span>
<span class="cm">	 * be cleared whilst testing the 10-Base-T interface.  This would</span>
<span class="cm">	 * not be necessary for the sparrow chip but is simpler to do it</span>
<span class="cm">	 * anyway.</span>
<span class="cm">	 */</span>
	<span class="n">writereg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PP_LineCTL</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">linectl</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">AUI_ONLY</span><span class="p">);</span>
	<span class="n">control_dc_dc</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* Delay for the hardware to work out if the TP cable is present</span>
<span class="cm">	 * - 150ms</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">timenow</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span> <span class="n">jiffies</span> <span class="o">-</span> <span class="n">timenow</span> <span class="o">&lt;</span> <span class="mi">15</span><span class="p">;)</span>
		<span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">readreg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PP_LineST</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">LINK_OK</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">DETECTED_NONE</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">chip_type</span> <span class="o">==</span> <span class="n">CS8900</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">force</span> <span class="o">&amp;</span> <span class="mh">0xf0</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">		case FORCE_AUTO:</span>
<span class="c">			pr_info(&quot;%s: cs8900 doesn&#39;t autonegotiate\n&quot;,</span>
<span class="c">				dev-&gt;name);</span>
<span class="c">			return DETECTED_NONE;</span>
<span class="cp">#endif</span>
			<span class="cm">/* CS8900 doesn&#39;t support AUTO, change to HALF*/</span>
		<span class="k">case</span> <span class="n">FORCE_AUTO</span>:
			<span class="n">lp</span><span class="o">-&gt;</span><span class="n">force</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">FORCE_AUTO</span><span class="p">;</span>
			<span class="n">lp</span><span class="o">-&gt;</span><span class="n">force</span> <span class="o">|=</span> <span class="n">FORCE_HALF</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">FORCE_HALF</span>:
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">FORCE_FULL</span>:
			<span class="n">writereg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PP_TestCTL</span><span class="p">,</span>
				 <span class="n">readreg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PP_TestCTL</span><span class="p">)</span> <span class="o">|</span> <span class="n">FDX_8900</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">fdx</span> <span class="o">=</span> <span class="n">readreg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PP_TestCTL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">FDX_8900</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">force</span> <span class="o">&amp;</span> <span class="mh">0xf0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">FORCE_AUTO</span>:
			<span class="n">lp</span><span class="o">-&gt;</span><span class="n">auto_neg_cnf</span> <span class="o">=</span> <span class="n">AUTO_NEG_ENABLE</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">FORCE_HALF</span>:
			<span class="n">lp</span><span class="o">-&gt;</span><span class="n">auto_neg_cnf</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">FORCE_FULL</span>:
			<span class="n">lp</span><span class="o">-&gt;</span><span class="n">auto_neg_cnf</span> <span class="o">=</span> <span class="n">RE_NEG_NOW</span> <span class="o">|</span> <span class="n">ALLOW_FDX</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">writereg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PP_AutoNegCTL</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">auto_neg_cnf</span> <span class="o">&amp;</span> <span class="n">AUTO_NEG_MASK</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">auto_neg_cnf</span> <span class="o">&amp;</span> <span class="n">AUTO_NEG_BITS</span><span class="p">)</span> <span class="o">==</span> <span class="n">AUTO_NEG_ENABLE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%s: negotiating duplex...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="k">while</span> <span class="p">(</span><span class="n">readreg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PP_AutoNegST</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">AUTO_NEG_BUSY</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">jiffies</span> <span class="o">-</span> <span class="n">timenow</span> <span class="o">&gt;</span> <span class="mi">4000</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;**** Full / half duplex auto-negotiation timed out ****</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">fdx</span> <span class="o">=</span> <span class="n">readreg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PP_AutoNegST</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">FDX_ACTIVE</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fdx</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">DETECTED_RJ45F</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">DETECTED_RJ45H</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">detect_bnc</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_local</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">cs89_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">debug</span><span class="p">,</span> <span class="s">&quot;%s: Attempting BNC</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="n">control_dc_dc</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">writereg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PP_LineCTL</span><span class="p">,</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">linectl</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">AUTO_AUI_10BASET</span><span class="p">)</span> <span class="o">|</span> <span class="n">AUI_ONLY</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">send_test_pkt</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">DETECTED_BNC</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">DETECTED_NONE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">detect_aui</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_local</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">cs89_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">debug</span><span class="p">,</span> <span class="s">&quot;%s: Attempting AUI</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="n">control_dc_dc</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">writereg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PP_LineCTL</span><span class="p">,</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">linectl</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">AUTO_AUI_10BASET</span><span class="p">)</span> <span class="o">|</span> <span class="n">AUI_ONLY</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">send_test_pkt</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">DETECTED_AUI</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">DETECTED_NONE</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* We have a good packet(s), get it/them out of the buffers. */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">net_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_local</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">,</span> <span class="n">length</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">ioread16</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">virt_addr</span> <span class="o">+</span> <span class="n">RX_FRAME_PORT</span><span class="p">);</span>
	<span class="n">length</span> <span class="o">=</span> <span class="n">ioread16</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">virt_addr</span> <span class="o">+</span> <span class="n">RX_FRAME_PORT</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">RX_OK</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">count_rx_errors</span><span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Malloc up new buffer. */</span>
	<span class="n">skb</span> <span class="o">=</span> <span class="n">netdev_alloc_skb</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">length</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#if 0</span><span class="c">		/* Again, this seems a cruel thing to do */</span>
<span class="c">		pr_warn(&quot;%s: Memory squeeze, dropping packet\n&quot;, dev-&gt;name);</span>
<span class="cp">#endif</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_dropped</span><span class="o">++</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">skb_reserve</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>	<span class="cm">/* longword align L3 header */</span>

	<span class="n">readwords</span><span class="p">(</span><span class="n">lp</span><span class="p">,</span> <span class="n">RX_FRAME_PORT</span><span class="p">,</span> <span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">length</span><span class="p">),</span> <span class="n">length</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">length</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">length</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">ioread16</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">virt_addr</span> <span class="o">+</span> <span class="n">RX_FRAME_PORT</span><span class="p">);</span>

	<span class="n">cs89_dbg</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">debug</span><span class="p">,</span> <span class="s">&quot;%s: received %d byte packet of type %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span>
		 <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">ETH_ALEN</span> <span class="o">+</span> <span class="n">ETH_ALEN</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span>
		 <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">ETH_ALEN</span> <span class="o">+</span> <span class="n">ETH_ALEN</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]);</span>

	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">eth_type_trans</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="n">netif_rx</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_packets</span><span class="o">++</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_bytes</span> <span class="o">+=</span> <span class="n">length</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* The typical workload of the driver:</span>
<span class="cm"> * Handle the network interface interrupts.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">net_interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev_id</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_local</span> <span class="o">*</span><span class="n">lp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">handled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* we MUST read all the events out of the ISQ, otherwise we&#39;ll never</span>
<span class="cm">	 * get interrupted again.  As a consequence, we can&#39;t have any limit</span>
<span class="cm">	 * on the number of times we loop in the interrupt handler.  The</span>
<span class="cm">	 * hardware guarantees that eventually we&#39;ll run out of events.  Of</span>
<span class="cm">	 * course, if you&#39;re on a slow machine, and packets are arriving</span>
<span class="cm">	 * faster than you can read them off, you&#39;re screwed.  Hasta la</span>
<span class="cm">	 * vista, baby!</span>
<span class="cm">	 */</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">status</span> <span class="o">=</span> <span class="n">ioread16</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">virt_addr</span> <span class="o">+</span> <span class="n">ISQ_PORT</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">cs89_dbg</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">debug</span><span class="p">,</span> <span class="s">&quot;%s: event=%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
		<span class="n">handled</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">ISQ_EVENT_MASK</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">ISQ_RECEIVER_EVENT</span>:
			<span class="cm">/* Got a packet(s). */</span>
			<span class="n">net_rx</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">ISQ_TRANSMITTER_EVENT</span>:
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_packets</span><span class="o">++</span><span class="p">;</span>
			<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>	<span class="cm">/* Inform upper layers. */</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">status</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">TX_OK</span> <span class="o">|</span>
				       <span class="n">TX_LOST_CRS</span> <span class="o">|</span>
				       <span class="n">TX_SQE_ERROR</span> <span class="o">|</span>
				       <span class="n">TX_LATE_COL</span> <span class="o">|</span>
				       <span class="n">TX_16_COL</span><span class="p">))</span> <span class="o">!=</span> <span class="n">TX_OK</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">TX_OK</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
					<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_errors</span><span class="o">++</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">TX_LOST_CRS</span><span class="p">)</span>
					<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_carrier_errors</span><span class="o">++</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">TX_SQE_ERROR</span><span class="p">)</span>
					<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_heartbeat_errors</span><span class="o">++</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">TX_LATE_COL</span><span class="p">)</span>
					<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_window_errors</span><span class="o">++</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">TX_16_COL</span><span class="p">)</span>
					<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_aborted_errors</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">ISQ_BUFFER_EVENT</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">READY_FOR_TX</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* we tried to transmit a packet earlier,</span>
<span class="cm">				 * but inexplicably ran out of buffers.</span>
<span class="cm">				 * That shouldn&#39;t happen since we only ever</span>
<span class="cm">				 * load one packet.  Shrug.  Do the right</span>
<span class="cm">				 * thing anyway.</span>
<span class="cm">				 */</span>
				<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>	<span class="cm">/* Inform upper layers. */</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">TX_UNDERRUN</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">cs89_dbg</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">err</span><span class="p">,</span> <span class="s">&quot;%s: transmit underrun</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					 <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
				<span class="n">lp</span><span class="o">-&gt;</span><span class="n">send_underrun</span><span class="o">++</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">send_underrun</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span>
					<span class="n">lp</span><span class="o">-&gt;</span><span class="n">send_cmd</span> <span class="o">=</span> <span class="n">TX_AFTER_381</span><span class="p">;</span>
				<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">send_underrun</span> <span class="o">==</span> <span class="mi">6</span><span class="p">)</span>
					<span class="n">lp</span><span class="o">-&gt;</span><span class="n">send_cmd</span> <span class="o">=</span> <span class="n">TX_AFTER_ALL</span><span class="p">;</span>
				<span class="cm">/* transmit cycle is done, although</span>
<span class="cm">				 * frame wasn&#39;t transmitted - this</span>
<span class="cm">				 * avoids having to wait for the upper</span>
<span class="cm">				 * layers to timeout on us, in the</span>
<span class="cm">				 * event of a tx underrun</span>
<span class="cm">				 */</span>
				<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>	<span class="cm">/* Inform upper layers. */</span>
			<span class="p">}</span>
<span class="cp">#if ALLOW_DMA</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">use_dma</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">RX_DMA</span><span class="p">))</span> <span class="p">{</span>
				<span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="n">readreg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PP_DmaFrameCnt</span><span class="p">);</span>
				<span class="k">while</span> <span class="p">(</span><span class="n">count</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">cs89_dbg</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="n">debug</span><span class="p">,</span>
						 <span class="s">&quot;%s: receiving %d DMA frames</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						 <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
						<span class="n">cs89_dbg</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">debug</span><span class="p">,</span>
							 <span class="s">&quot;%s: receiving %d DMA frames</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
							 <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
					<span class="n">dma_rx</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
					<span class="k">if</span> <span class="p">(</span><span class="o">--</span><span class="n">count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
						<span class="n">count</span> <span class="o">=</span> <span class="n">readreg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PP_DmaFrameCnt</span><span class="p">);</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
						<span class="n">cs89_dbg</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">debug</span><span class="p">,</span>
							 <span class="s">&quot;%s: continuing with %d DMA frames</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
							 <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>
<span class="cp">#endif</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">ISQ_RX_MISS_EVENT</span>:
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_missed_errors</span> <span class="o">+=</span> <span class="p">(</span><span class="n">status</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">ISQ_TX_COL_EVENT</span>:
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">collisions</span> <span class="o">+=</span> <span class="p">(</span><span class="n">status</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">IRQ_RETVAL</span><span class="p">(</span><span class="n">handled</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Open/initialize the board.  This is called (in the current kernel)</span>
<span class="cm">   sometime after booting when the &#39;ifconfig&#39; program is run.</span>

<span class="cm">   This routine should set everything up anew at each open, even</span>
<span class="cm">   registers that &quot;should&quot; only need to be set once at boot, so that</span>
<span class="cm">   there is non-reboot way to recover if something goes wrong.</span>
<span class="cm">*/</span>

<span class="cm">/* AKPM: do we need to do any locking here? */</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">net_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_local</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Allow interrupts to be generated by the chip */</span>
<span class="cm">/* Cirrus&#39; release had this: */</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">		writereg(dev, PP_BusCTL, readreg(dev, PP_BusCTL) | ENABLE_IRQ);</span>
<span class="cp">#endif</span>
<span class="cm">/* And 2.3.47 had this: */</span>
		<span class="n">writereg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PP_BusCTL</span><span class="p">,</span> <span class="n">ENABLE_IRQ</span> <span class="o">|</span> <span class="n">MEMORY_ON</span><span class="p">);</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">CS8920_NO_INTS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">irq_map</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">request_irq</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">net_interrupt</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
						<span class="n">dev</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
					<span class="n">write_irq</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">chip_type</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
					<span class="cm">/* writereg(dev, PP_BufCFG, GENERATE_SW_INTERRUPT); */</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="n">CS8920_NO_INTS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">writereg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PP_BusCTL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>	<span class="cm">/* disable interrupts. */</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;can&#39;t get an interrupt</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">bad_out</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<span class="cp">#if !defined(CS89x0_NONISA_IRQ) &amp;&amp; !defined(CONFIG_CS89x0_PLATFORM)</span>
		<span class="k">if</span> <span class="p">(((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">irq_map</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: IRQ %d is not in our map of allowable IRQs, which is %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">irq_map</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">bad_out</span><span class="p">;</span>
		<span class="p">}</span>
<span class="cp">#endif</span>
<span class="cm">/* FIXME: Cirrus&#39; release had this: */</span>
		<span class="n">writereg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PP_BusCTL</span><span class="p">,</span> <span class="n">readreg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PP_BusCTL</span><span class="p">)</span><span class="o">|</span><span class="n">ENABLE_IRQ</span><span class="p">);</span>
<span class="cm">/* And 2.3.47 had this: */</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">		writereg(dev, PP_BusCTL, ENABLE_IRQ | MEMORY_ON);</span>
<span class="cp">#endif</span>
		<span class="n">write_irq</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">chip_type</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">net_interrupt</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;request_irq(%d) failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">bad_out</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

<span class="cp">#if ALLOW_DMA</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">use_dma</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">isa_config</span> <span class="o">&amp;</span> <span class="n">ANY_ISA_DMA</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">dma_buff</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">__get_dma_pages</span><span class="p">(</span><span class="n">GFP_KERNEL</span><span class="p">,</span>
								<span class="n">get_order</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">dmasize</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">dma_buff</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: cannot get %dK memory for DMA</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">dmasize</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">release_irq</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">cs89_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">debug</span><span class="p">,</span> <span class="s">&quot;%s: dma %lx %lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
			 <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">dma_buff</span><span class="p">,</span>
			 <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">isa_virt_to_bus</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">dma_buff</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">dma_buff</span> <span class="o">&gt;=</span> <span class="n">MAX_DMA_ADDRESS</span> <span class="o">||</span>
		    <span class="o">!</span><span class="n">dma_page_eq</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">dma_buff</span><span class="p">,</span>
				 <span class="n">lp</span><span class="o">-&gt;</span><span class="n">dma_buff</span> <span class="o">+</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">dmasize</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: not usable as DMA buffer</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">release_irq</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">dma_buff</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">dmasize</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">);</span>	<span class="cm">/* Why? */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">request_dma</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: cannot get dma channel %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">release_irq</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">write_dma</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">chip_type</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">);</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_dma_ptr</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">dma_buff</span><span class="p">;</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">end_dma_buff</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">dma_buff</span> <span class="o">+</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">dmasize</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">;</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">disable_dma</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">);</span>
		<span class="n">clear_dma_ff</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">);</span>
		<span class="n">set_dma_mode</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">,</span> <span class="n">DMA_RX_MODE</span><span class="p">);</span> <span class="cm">/* auto_init as well */</span>
		<span class="n">set_dma_addr</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">,</span> <span class="n">isa_virt_to_bus</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">dma_buff</span><span class="p">));</span>
		<span class="n">set_dma_count</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">dmasize</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">);</span>
		<span class="n">enable_dma</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif	</span><span class="cm">/* ALLOW_DMA */</span><span class="cp"></span>

	<span class="cm">/* set the Ethernet address */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ETH_ALEN</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">writereg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PP_IA</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span>
			 <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="mi">2</span><span class="p">]</span> <span class="o">|</span>
			  <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)));</span>

	<span class="cm">/* while we&#39;re testing the interface, leave interrupts disabled */</span>
	<span class="n">writereg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PP_BusCTL</span><span class="p">,</span> <span class="n">MEMORY_ON</span><span class="p">);</span>

	<span class="cm">/* Set the LineCTL quintuplet based on adapter configuration read from EEPROM */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">adapter_cnf</span> <span class="o">&amp;</span> <span class="n">A_CNF_EXTND_10B_2</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">adapter_cnf</span> <span class="o">&amp;</span> <span class="n">A_CNF_LOW_RX_SQUELCH</span><span class="p">))</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">linectl</span> <span class="o">=</span> <span class="n">LOW_RX_SQUELCH</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">linectl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* check to make sure that they have the &quot;right&quot; hardware available */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">adapter_cnf</span> <span class="o">&amp;</span> <span class="n">A_CNF_MEDIA_TYPE</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">A_CNF_MEDIA_10B_T</span>:
		<span class="n">result</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">adapter_cnf</span> <span class="o">&amp;</span> <span class="n">A_CNF_10B_T</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">A_CNF_MEDIA_AUI</span>:
		<span class="n">result</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">adapter_cnf</span> <span class="o">&amp;</span> <span class="n">A_CNF_AUI</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">A_CNF_MEDIA_10B_2</span>:
		<span class="n">result</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">adapter_cnf</span> <span class="o">&amp;</span> <span class="n">A_CNF_10B_2</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">adapter_cnf</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">A_CNF_10B_T</span> <span class="o">|</span>
					    <span class="n">A_CNF_AUI</span> <span class="o">|</span>
					    <span class="n">A_CNF_10B_2</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">result</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: EEPROM is configured for unavailable media</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
<span class="nl">release_dma:</span>
<span class="cp">#if ALLOW_DMA</span>
		<span class="n">free_dma</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">);</span>
<span class="nl">release_irq:</span>
		<span class="n">release_dma_buff</span><span class="p">(</span><span class="n">lp</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="n">writereg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PP_LineCTL</span><span class="p">,</span>
			 <span class="n">readreg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PP_LineCTL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">SERIAL_TX_ON</span> <span class="o">|</span> <span class="n">SERIAL_RX_ON</span><span class="p">));</span>
		<span class="n">free_irq</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">bad_out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* set the hardware to the configured choice */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">adapter_cnf</span> <span class="o">&amp;</span> <span class="n">A_CNF_MEDIA_TYPE</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">A_CNF_MEDIA_10B_T</span>:
		<span class="n">result</span> <span class="o">=</span> <span class="n">detect_tp</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">==</span> <span class="n">DETECTED_NONE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_warn</span><span class="p">(</span><span class="s">&quot;%s: 10Base-T (RJ-45) has no cable</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">auto_neg_cnf</span> <span class="o">&amp;</span> <span class="n">IMM_BIT</span><span class="p">)</span> <span class="cm">/* check &quot;ignore missing media&quot; bit */</span>
				<span class="n">result</span> <span class="o">=</span> <span class="n">DETECTED_RJ45H</span><span class="p">;</span> <span class="cm">/* Yes! I don&#39;t care if I see a link pulse */</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">A_CNF_MEDIA_AUI</span>:
		<span class="n">result</span> <span class="o">=</span> <span class="n">detect_aui</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">==</span> <span class="n">DETECTED_NONE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_warn</span><span class="p">(</span><span class="s">&quot;%s: 10Base-5 (AUI) has no cable</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">auto_neg_cnf</span> <span class="o">&amp;</span> <span class="n">IMM_BIT</span><span class="p">)</span> <span class="cm">/* check &quot;ignore missing media&quot; bit */</span>
				<span class="n">result</span> <span class="o">=</span> <span class="n">DETECTED_AUI</span><span class="p">;</span> <span class="cm">/* Yes! I don&#39;t care if I see a carrrier */</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">A_CNF_MEDIA_10B_2</span>:
		<span class="n">result</span> <span class="o">=</span> <span class="n">detect_bnc</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">==</span> <span class="n">DETECTED_NONE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_warn</span><span class="p">(</span><span class="s">&quot;%s: 10Base-2 (BNC) has no cable</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">auto_neg_cnf</span> <span class="o">&amp;</span> <span class="n">IMM_BIT</span><span class="p">)</span> <span class="cm">/* check &quot;ignore missing media&quot; bit */</span>
				<span class="n">result</span> <span class="o">=</span> <span class="n">DETECTED_BNC</span><span class="p">;</span> <span class="cm">/* Yes! I don&#39;t care if I can xmit a packet */</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">A_CNF_MEDIA_AUTO</span>:
		<span class="n">writereg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PP_LineCTL</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">linectl</span> <span class="o">|</span> <span class="n">AUTO_AUI_10BASET</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">adapter_cnf</span> <span class="o">&amp;</span> <span class="n">A_CNF_10B_T</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">result</span> <span class="o">=</span> <span class="n">detect_tp</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">!=</span> <span class="n">DETECTED_NONE</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">adapter_cnf</span> <span class="o">&amp;</span> <span class="n">A_CNF_AUI</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">result</span> <span class="o">=</span> <span class="n">detect_aui</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">!=</span> <span class="n">DETECTED_NONE</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">adapter_cnf</span> <span class="o">&amp;</span> <span class="n">A_CNF_10B_2</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">result</span> <span class="o">=</span> <span class="n">detect_bnc</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">!=</span> <span class="n">DETECTED_NONE</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: no media detected</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">release_dma</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">DETECTED_NONE</span>:
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: no network cable attached to configured media</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">release_dma</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DETECTED_RJ45H</span>:
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%s: using half-duplex 10Base-T (RJ-45)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DETECTED_RJ45F</span>:
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%s: using full-duplex 10Base-T (RJ-45)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DETECTED_AUI</span>:
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%s: using 10Base-5 (AUI)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DETECTED_BNC</span>:
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%s: using 10Base-2 (BNC)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Turn on both receive and transmit operations */</span>
	<span class="n">writereg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PP_LineCTL</span><span class="p">,</span>
		 <span class="n">readreg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PP_LineCTL</span><span class="p">)</span> <span class="o">|</span> <span class="n">SERIAL_RX_ON</span> <span class="o">|</span> <span class="n">SERIAL_TX_ON</span><span class="p">);</span>

	<span class="cm">/* Receive only error free packets addressed to this card */</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_mode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">writereg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PP_RxCTL</span><span class="p">,</span> <span class="n">DEF_RX_ACCEPT</span><span class="p">);</span>

	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">curr_rx_cfg</span> <span class="o">=</span> <span class="n">RX_OK_ENBL</span> <span class="o">|</span> <span class="n">RX_CRC_ERROR_ENBL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">isa_config</span> <span class="o">&amp;</span> <span class="n">STREAM_TRANSFER</span><span class="p">)</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">curr_rx_cfg</span> <span class="o">|=</span> <span class="n">RX_STREAM_ENBL</span><span class="p">;</span>
<span class="cp">#if ALLOW_DMA</span>
	<span class="n">set_dma_cfg</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">writereg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PP_RxCFG</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">curr_rx_cfg</span><span class="p">);</span>

	<span class="n">writereg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PP_TxCFG</span><span class="p">,</span> <span class="p">(</span><span class="n">TX_LOST_CRS_ENBL</span> <span class="o">|</span>
				 <span class="n">TX_SQE_ERROR_ENBL</span> <span class="o">|</span>
				 <span class="n">TX_OK_ENBL</span> <span class="o">|</span>
				 <span class="n">TX_LATE_COL_ENBL</span> <span class="o">|</span>
				 <span class="n">TX_JBR_ENBL</span> <span class="o">|</span>
				 <span class="n">TX_ANY_COL_ENBL</span> <span class="o">|</span>
				 <span class="n">TX_16_COL_ENBL</span><span class="p">));</span>

	<span class="n">writereg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PP_BufCFG</span><span class="p">,</span> <span class="p">(</span><span class="n">READY_FOR_TX_ENBL</span> <span class="o">|</span>
				  <span class="n">RX_MISS_COUNT_OVRFLOW_ENBL</span> <span class="o">|</span>
<span class="cp">#if ALLOW_DMA</span>
				  <span class="n">dma_bufcfg</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">|</span>
<span class="cp">#endif</span>
				  <span class="n">TX_COL_COUNT_OVRFLOW_ENBL</span> <span class="o">|</span>
				  <span class="n">TX_UNDERRUN_ENBL</span><span class="p">));</span>

	<span class="cm">/* now that we&#39;ve got our act together, enable everything */</span>
	<span class="n">writereg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PP_BusCTL</span><span class="p">,</span> <span class="p">(</span><span class="n">ENABLE_IRQ</span>
				  <span class="o">|</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mem_start</span> <span class="o">?</span> <span class="n">MEMORY_ON</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span> <span class="cm">/* turn memory on */</span>
<span class="cp">#if ALLOW_DMA</span>
				  <span class="o">|</span> <span class="n">dma_busctl</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span>
<span class="cp">#endif</span>
			 <span class="p">));</span>
	<span class="n">netif_start_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">cs89_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">debug</span><span class="p">,</span> <span class="s">&quot;net_open() succeeded</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">bad_out:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* The inverse routine to net_open(). */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">net_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#if ALLOW_DMA</span>
	<span class="k">struct</span> <span class="n">net_local</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">writereg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PP_RxCFG</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">writereg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PP_TxCFG</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">writereg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PP_BufCFG</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">writereg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PP_BusCTL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">free_irq</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>

<span class="cp">#if ALLOW_DMA</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">use_dma</span> <span class="o">&amp;&amp;</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">free_dma</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">);</span>
		<span class="n">release_dma_buff</span><span class="p">(</span><span class="n">lp</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="cm">/* Update the statistics here. */</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Get the current statistics.</span>
<span class="cm"> * This may be called with the card open or closed.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">net_device_stats</span> <span class="o">*</span>
<span class="nf">net_get_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_local</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="cm">/* Update the statistics from the device registers. */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_missed_errors</span> <span class="o">+=</span> <span class="p">(</span><span class="n">readreg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PP_RxMiss</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">collisions</span> <span class="o">+=</span> <span class="p">(</span><span class="n">readreg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PP_TxCol</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">net_timeout</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* If we get here, some higher level has decided we are broken.</span>
<span class="cm">	   There should really be a &quot;kick me&quot; function call instead. */</span>
	<span class="n">cs89_dbg</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">err</span><span class="p">,</span> <span class="s">&quot;%s: transmit timed out, %s?</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
		 <span class="n">tx_done</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;IRQ conflict&quot;</span> <span class="o">:</span> <span class="s">&quot;network cable problem&quot;</span><span class="p">);</span>
	<span class="cm">/* Try to restart the adaptor. */</span>
	<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">netdev_tx_t</span> <span class="nf">net_send_packet</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_local</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">cs89_dbg</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">debug</span><span class="p">,</span> <span class="s">&quot;%s: sent %d byte packet of type %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span>
		 <span class="p">((</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">ETH_ALEN</span> <span class="o">+</span> <span class="n">ETH_ALEN</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span>
		  <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">ETH_ALEN</span> <span class="o">+</span> <span class="n">ETH_ALEN</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]));</span>

	<span class="cm">/* keep the upload from being interrupted, since we</span>
<span class="cm">	 * ask the chip to start transmitting before the</span>
<span class="cm">	 * whole packet has been completely uploaded.</span>
<span class="cm">	 */</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* initiate a transmit sequence */</span>
	<span class="n">iowrite16</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">send_cmd</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">virt_addr</span> <span class="o">+</span> <span class="n">TX_CMD_PORT</span><span class="p">);</span>
	<span class="n">iowrite16</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">virt_addr</span> <span class="o">+</span> <span class="n">TX_LEN_PORT</span><span class="p">);</span>

	<span class="cm">/* Test to see if the chip has allocated memory for the packet */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">readreg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PP_BusST</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">READY_FOR_TX_NOW</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Gasp!  It hasn&#39;t.  But that shouldn&#39;t happen since</span>
<span class="cm">		 * we&#39;re waiting for TxOk, so return 1 and requeue this packet.</span>
<span class="cm">		 */</span>

		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">cs89_dbg</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">err</span><span class="p">,</span> <span class="s">&quot;Tx buffer not free!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">NETDEV_TX_BUSY</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* Write the contents of the packet */</span>
	<span class="n">writewords</span><span class="p">(</span><span class="n">lp</span><span class="p">,</span> <span class="n">TX_FRAME_PORT</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_bytes</span> <span class="o">+=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
	<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

	<span class="cm">/* We DO NOT call netif_wake_queue() here.</span>
<span class="cm">	 * We also DO NOT call netif_start_queue().</span>
<span class="cm">	 *</span>
<span class="cm">	 * Either of these would cause another bottom half run through</span>
<span class="cm">	 * net_send_packet() before this packet has fully gone out.</span>
<span class="cm">	 * That causes us to hit the &quot;Gasp!&quot; above and the send is rescheduled.</span>
<span class="cm">	 * it runs like a dog.  We just return and wait for the Tx completion</span>
<span class="cm">	 * interrupt handler to restart the netdevice layer</span>
<span class="cm">	 */</span>

	<span class="k">return</span> <span class="n">NETDEV_TX_OK</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">set_multicast_list</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_local</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_PROMISC</span><span class="p">)</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_mode</span> <span class="o">=</span> <span class="n">RX_ALL_ACCEPT</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_ALLMULTI</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="n">netdev_mc_empty</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="cm">/* The multicast-accept list is initialized to accept-all,</span>
<span class="cm">		 * and we rely on higher-level filtering for now.</span>
<span class="cm">		 */</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_mode</span> <span class="o">=</span> <span class="n">RX_MULTCAST_ACCEPT</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_mode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">writereg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PP_RxCTL</span><span class="p">,</span> <span class="n">DEF_RX_ACCEPT</span> <span class="o">|</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_mode</span><span class="p">);</span>

	<span class="cm">/* in promiscuous mode, we accept errored packets,</span>
<span class="cm">	 * so we have to enable interrupts on them also</span>
<span class="cm">	 */</span>
	<span class="n">writereg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PP_RxCFG</span><span class="p">,</span>
		 <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">curr_rx_cfg</span> <span class="o">|</span>
		  <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_mode</span> <span class="o">==</span> <span class="n">RX_ALL_ACCEPT</span><span class="p">)</span>
		  <span class="o">?</span> <span class="p">(</span><span class="n">RX_CRC_ERROR_ENBL</span> <span class="o">|</span> <span class="n">RX_RUNT_ENBL</span> <span class="o">|</span> <span class="n">RX_EXTRA_DATA_ENBL</span><span class="p">)</span>
		  <span class="o">:</span> <span class="mi">0</span><span class="p">));</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">set_mac_address</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="n">addr</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">netif_running</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">addr</span><span class="o">-&gt;</span><span class="n">sa_data</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">addr_len</span><span class="p">);</span>

	<span class="n">cs89_dbg</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">debug</span><span class="p">,</span> <span class="s">&quot;%s: Setting MAC address to %pM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">);</span>

	<span class="cm">/* set the Ethernet address */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ETH_ALEN</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">writereg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PP_IA</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span>
			 <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="mi">2</span><span class="p">]</span> <span class="o">|</span>
			  <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)));</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_NET_POLL_CONTROLLER</span>
<span class="cm">/*</span>
<span class="cm"> * Polling receive - used by netconsole and other diagnostic tools</span>
<span class="cm"> * to allow network i/o with interrupts disabled.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">net_poll_controller</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">disable_irq</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
	<span class="n">net_interrupt</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="n">enable_irq</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">net_device_ops</span> <span class="n">net_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">ndo_open</span>		<span class="o">=</span> <span class="n">net_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_stop</span>		<span class="o">=</span> <span class="n">net_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_tx_timeout</span>		<span class="o">=</span> <span class="n">net_timeout</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_start_xmit</span>		<span class="o">=</span> <span class="n">net_send_packet</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_get_stats</span>		<span class="o">=</span> <span class="n">net_get_stats</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_set_rx_mode</span>	<span class="o">=</span> <span class="n">set_multicast_list</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_set_mac_address</span>	<span class="o">=</span> <span class="n">set_mac_address</span><span class="p">,</span>
<span class="cp">#ifdef CONFIG_NET_POLL_CONTROLLER</span>
	<span class="p">.</span><span class="n">ndo_poll_controller</span>	<span class="o">=</span> <span class="n">net_poll_controller</span><span class="p">,</span>
<span class="cp">#endif</span>
	<span class="p">.</span><span class="n">ndo_change_mtu</span>		<span class="o">=</span> <span class="n">eth_change_mtu</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_validate_addr</span>	<span class="o">=</span> <span class="n">eth_validate_addr</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">reset_chip</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#if !defined(CONFIG_MACH_MX31ADS)</span>
<span class="cp">#if !defined(CS89x0_NONISA_IRQ)</span>
	<span class="k">struct</span> <span class="n">net_local</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="cp">#endif </span><span class="cm">/* CS89x0_NONISA_IRQ */</span><span class="cp"></span>
	<span class="kt">int</span> <span class="n">reset_start_time</span><span class="p">;</span>

	<span class="n">writereg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PP_SelfCTL</span><span class="p">,</span> <span class="n">readreg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PP_SelfCTL</span><span class="p">)</span> <span class="o">|</span> <span class="n">POWER_ON_RESET</span><span class="p">);</span>

	<span class="cm">/* wait 30 ms */</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">30</span><span class="p">);</span>

<span class="cp">#if !defined(CS89x0_NONISA_IRQ)</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">chip_type</span> <span class="o">!=</span> <span class="n">CS8900</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Hardware problem requires PNP registers to be reconfigured after a reset */</span>
		<span class="n">iowrite16</span><span class="p">(</span><span class="n">PP_CS8920_ISAINT</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">virt_addr</span> <span class="o">+</span> <span class="n">ADD_PORT</span><span class="p">);</span>
		<span class="n">iowrite8</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">virt_addr</span> <span class="o">+</span> <span class="n">DATA_PORT</span><span class="p">);</span>
		<span class="n">iowrite8</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">virt_addr</span> <span class="o">+</span> <span class="n">DATA_PORT</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>

		<span class="n">iowrite16</span><span class="p">(</span><span class="n">PP_CS8920_ISAMemB</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">virt_addr</span> <span class="o">+</span> <span class="n">ADD_PORT</span><span class="p">);</span>
		<span class="n">iowrite8</span><span class="p">((</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mem_start</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span>
			 <span class="n">lp</span><span class="o">-&gt;</span><span class="n">virt_addr</span> <span class="o">+</span> <span class="n">DATA_PORT</span><span class="p">);</span>
		<span class="n">iowrite8</span><span class="p">((</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mem_start</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span>
			 <span class="n">lp</span><span class="o">-&gt;</span><span class="n">virt_addr</span> <span class="o">+</span> <span class="n">DATA_PORT</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* CS89x0_NONISA_IRQ */</span><span class="cp"></span>

	<span class="cm">/* Wait until the chip is reset */</span>
	<span class="n">reset_start_time</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">readreg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PP_SelfST</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">INIT_DONE</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
	       <span class="n">jiffies</span> <span class="o">-</span> <span class="n">reset_start_time</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span>
		<span class="p">;</span>
<span class="cp">#endif </span><span class="cm">/* !CONFIG_MACH_MX31ADS */</span><span class="cp"></span>
<span class="p">}</span>

<span class="cm">/* This is the real probe routine.</span>
<span class="cm"> * Linux has a history of friendly device probes on the ISA bus.</span>
<span class="cm"> * A good device probes avoids doing writes, and</span>
<span class="cm"> * verifies that the correct device exists and functions.</span>
<span class="cm"> * Return 0 on success.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span>
<span class="nf">cs89x0_probe1</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">modular</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_local</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">rev_type</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">eeprom_buff</span><span class="p">[</span><span class="n">CHKSUM_LEN</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>

	<span class="cm">/* Initialize the device structure. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">modular</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">lp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">lp</span><span class="p">));</span>
		<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
<span class="cp">#ifndef MODULE</span>
<span class="cp">#if ALLOW_DMA</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">g_cs89x0_dma</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">lp</span><span class="o">-&gt;</span><span class="n">use_dma</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">lp</span><span class="o">-&gt;</span><span class="n">dma</span> <span class="o">=</span> <span class="n">g_cs89x0_dma</span><span class="p">;</span>
			<span class="n">lp</span><span class="o">-&gt;</span><span class="n">dmasize</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>	<span class="cm">/* Could make this an option... */</span>
		<span class="p">}</span>
<span class="cp">#endif</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">force</span> <span class="o">=</span> <span class="n">g_cs89x0_media__force</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="p">}</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;PP_addr at %p[%x]: 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">ioaddr</span><span class="p">,</span> <span class="n">ADD_PORT</span><span class="p">,</span> <span class="n">ioread16</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">ADD_PORT</span><span class="p">));</span>
	<span class="n">iowrite16</span><span class="p">(</span><span class="n">PP_ChipID</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">ADD_PORT</span><span class="p">);</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">ioread16</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">DATA_PORT</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">!=</span> <span class="n">CHIP_EISA_ID_SIG</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: incorrect signature at %p[%x]: 0x%x!=&quot;</span>
			 <span class="n">CHIP_EISA_ID_SIG_STR</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ioaddr</span><span class="p">,</span> <span class="n">DATA_PORT</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">virt_addr</span> <span class="o">=</span> <span class="n">ioaddr</span><span class="p">;</span>

	<span class="cm">/* get the chip type */</span>
	<span class="n">rev_type</span> <span class="o">=</span> <span class="n">readreg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PRODUCT_ID_ADD</span><span class="p">);</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">chip_type</span> <span class="o">=</span> <span class="n">rev_type</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">REVISON_BITS</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">chip_revision</span> <span class="o">=</span> <span class="p">((</span><span class="n">rev_type</span> <span class="o">&amp;</span> <span class="n">REVISON_BITS</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">+</span> <span class="sc">&#39;A&#39;</span><span class="p">;</span>

	<span class="cm">/* Check the chip type and revision in order to set the correct</span>
<span class="cm">	 * send command.  CS8920 revision C and CS8900 revision F can use</span>
<span class="cm">	 * the faster send.</span>
<span class="cm">	 */</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">send_cmd</span> <span class="o">=</span> <span class="n">TX_AFTER_381</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">chip_type</span> <span class="o">==</span> <span class="n">CS8900</span> <span class="o">&amp;&amp;</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">chip_revision</span> <span class="o">&gt;=</span> <span class="sc">&#39;F&#39;</span><span class="p">)</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">send_cmd</span> <span class="o">=</span> <span class="n">TX_NOW</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">chip_type</span> <span class="o">!=</span> <span class="n">CS8900</span> <span class="o">&amp;&amp;</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">chip_revision</span> <span class="o">&gt;=</span> <span class="sc">&#39;C&#39;</span><span class="p">)</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">send_cmd</span> <span class="o">=</span> <span class="n">TX_NOW</span><span class="p">;</span>

	<span class="n">pr_info_once</span><span class="p">(</span><span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">version</span><span class="p">);</span>

	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%s: cs89%c0%s rev %c found at %p &quot;</span><span class="p">,</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">chip_type</span> <span class="o">==</span> <span class="n">CS8900</span>  <span class="o">?</span> <span class="sc">&#39;0&#39;</span> <span class="o">:</span> <span class="sc">&#39;2&#39;</span><span class="p">,</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">chip_type</span> <span class="o">==</span> <span class="n">CS8920M</span> <span class="o">?</span> <span class="s">&quot;M&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">chip_revision</span><span class="p">,</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">virt_addr</span><span class="p">);</span>

	<span class="n">reset_chip</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* Here we read the current configuration of the chip.</span>
<span class="cm">	 * If there is no Extended EEPROM then the idea is to not disturb</span>
<span class="cm">	 * the chip configuration, it should have been correctly setup by</span>
<span class="cm">	 * automatic EEPROM read on reset. So, if the chip says it read</span>
<span class="cm">	 * the EEPROM the driver will always do *something* instead of</span>
<span class="cm">	 * complain that adapter_cnf is 0.</span>
<span class="cm">	 */</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">readreg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PP_SelfST</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">EEPROM_OK</span> <span class="o">|</span> <span class="n">EEPROM_PRESENT</span><span class="p">))</span> <span class="o">==</span>
	    <span class="p">(</span><span class="n">EEPROM_OK</span> <span class="o">|</span> <span class="n">EEPROM_PRESENT</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Load the MAC. */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ETH_ALEN</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">Addr</span><span class="p">;</span>
			<span class="n">Addr</span> <span class="o">=</span> <span class="n">readreg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PP_IA</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="mi">2</span><span class="p">);</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">Addr</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">;</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">Addr</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Load the Adapter Configuration.</span>
<span class="cm">		 * Note:  Barring any more specific information from some</span>
<span class="cm">		 * other source (ie EEPROM+Schematics), we would not know</span>
<span class="cm">		 * how to operate a 10Base2 interface on the AUI port.</span>
<span class="cm">		 * However, since we  do read the status of HCB1 and use</span>
<span class="cm">		 * settings that always result in calls to control_dc_dc(dev,0)</span>
<span class="cm">		 * a BNC interface should work if the enable pin</span>
<span class="cm">		 * (dc/dc converter) is on HCB1.</span>
<span class="cm">		 * It will be called AUI however.</span>
<span class="cm">		 */</span>

		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">adapter_cnf</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">i</span> <span class="o">=</span> <span class="n">readreg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PP_LineCTL</span><span class="p">);</span>
		<span class="cm">/* Preserve the setting of the HCB1 pin. */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">i</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">HCB1</span> <span class="o">|</span> <span class="n">HCB1_ENBL</span><span class="p">))</span> <span class="o">==</span> <span class="p">(</span><span class="n">HCB1</span> <span class="o">|</span> <span class="n">HCB1_ENBL</span><span class="p">))</span>
			<span class="n">lp</span><span class="o">-&gt;</span><span class="n">adapter_cnf</span> <span class="o">|=</span> <span class="n">A_CNF_DC_DC_POLARITY</span><span class="p">;</span>
		<span class="cm">/* Save the sqelch bit */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">i</span> <span class="o">&amp;</span> <span class="n">LOW_RX_SQUELCH</span><span class="p">)</span> <span class="o">==</span> <span class="n">LOW_RX_SQUELCH</span><span class="p">)</span>
			<span class="n">lp</span><span class="o">-&gt;</span><span class="n">adapter_cnf</span> <span class="o">|=</span> <span class="n">A_CNF_EXTND_10B_2</span> <span class="o">|</span> <span class="n">A_CNF_LOW_RX_SQUELCH</span><span class="p">;</span>
		<span class="cm">/* Check if the card is in 10Base-t only mode */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">i</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">AUI_ONLY</span> <span class="o">|</span> <span class="n">AUTO_AUI_10BASET</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">lp</span><span class="o">-&gt;</span><span class="n">adapter_cnf</span> <span class="o">|=</span>  <span class="n">A_CNF_10B_T</span> <span class="o">|</span> <span class="n">A_CNF_MEDIA_10B_T</span><span class="p">;</span>
		<span class="cm">/* Check if the card is in AUI only mode */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">i</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">AUI_ONLY</span> <span class="o">|</span> <span class="n">AUTO_AUI_10BASET</span><span class="p">))</span> <span class="o">==</span> <span class="n">AUI_ONLY</span><span class="p">)</span>
			<span class="n">lp</span><span class="o">-&gt;</span><span class="n">adapter_cnf</span> <span class="o">|=</span>  <span class="n">A_CNF_AUI</span> <span class="o">|</span> <span class="n">A_CNF_MEDIA_AUI</span><span class="p">;</span>
		<span class="cm">/* Check if the card is in Auto mode. */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">i</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">AUI_ONLY</span> <span class="o">|</span> <span class="n">AUTO_AUI_10BASET</span><span class="p">))</span> <span class="o">==</span> <span class="n">AUTO_AUI_10BASET</span><span class="p">)</span>
			<span class="n">lp</span><span class="o">-&gt;</span><span class="n">adapter_cnf</span> <span class="o">|=</span>  <span class="n">A_CNF_AUI</span> <span class="o">|</span> <span class="n">A_CNF_10B_T</span> <span class="o">|</span>
				<span class="n">A_CNF_MEDIA_AUI</span> <span class="o">|</span> <span class="n">A_CNF_MEDIA_10B_T</span> <span class="o">|</span> <span class="n">A_CNF_MEDIA_AUTO</span><span class="p">;</span>

		<span class="n">cs89_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="s">&quot;%s: PP_LineCTL=0x%x, adapter_cnf=0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">adapter_cnf</span><span class="p">);</span>

		<span class="cm">/* IRQ. Other chips already probe, see below. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">chip_type</span> <span class="o">==</span> <span class="n">CS8900</span><span class="p">)</span>
			<span class="n">lp</span><span class="o">-&gt;</span><span class="n">isa_config</span> <span class="o">=</span> <span class="n">readreg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PP_CS8900_ISAINT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">INT_NO_MASK</span><span class="p">;</span>

		<span class="n">pr_cont</span><span class="p">(</span><span class="s">&quot;[Cirrus EEPROM] &quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">pr_cont</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* First check to see if an EEPROM is attached. */</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">readreg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PP_SelfST</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">EEPROM_PRESENT</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">pr_warn</span><span class="p">(</span><span class="s">&quot;No EEPROM, relying on command line....</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">get_eeprom_data</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">START_EEPROM_DATA</span><span class="p">,</span> <span class="n">CHKSUM_LEN</span><span class="p">,</span> <span class="n">eeprom_buff</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_warn</span><span class="p">(</span><span class="s">&quot;EEPROM read failed, relying on command line</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">get_eeprom_cksum</span><span class="p">(</span><span class="n">START_EEPROM_DATA</span><span class="p">,</span> <span class="n">CHKSUM_LEN</span><span class="p">,</span> <span class="n">eeprom_buff</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Check if the chip was able to read its own configuration starting</span>
<span class="cm">		   at 0 in the EEPROM*/</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">readreg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PP_SelfST</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">EEPROM_OK</span> <span class="o">|</span> <span class="n">EEPROM_PRESENT</span><span class="p">))</span> <span class="o">!=</span>
		    <span class="p">(</span><span class="n">EEPROM_OK</span> <span class="o">|</span> <span class="n">EEPROM_PRESENT</span><span class="p">))</span>
			<span class="n">pr_warn</span><span class="p">(</span><span class="s">&quot;Extended EEPROM checksum bad and no Cirrus EEPROM, relying on command line</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* This reads an extended EEPROM that is not documented</span>
<span class="cm">		 * in the CS8900 datasheet.</span>
<span class="cm">		 */</span>

		<span class="cm">/* get transmission control word  but keep the autonegotiation bits */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">auto_neg_cnf</span><span class="p">)</span>
			<span class="n">lp</span><span class="o">-&gt;</span><span class="n">auto_neg_cnf</span> <span class="o">=</span> <span class="n">eeprom_buff</span><span class="p">[</span><span class="n">AUTO_NEG_CNF_OFFSET</span> <span class="o">/</span> <span class="mi">2</span><span class="p">];</span>
		<span class="cm">/* Store adapter configuration */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">adapter_cnf</span><span class="p">)</span>
			<span class="n">lp</span><span class="o">-&gt;</span><span class="n">adapter_cnf</span> <span class="o">=</span> <span class="n">eeprom_buff</span><span class="p">[</span><span class="n">ADAPTER_CNF_OFFSET</span> <span class="o">/</span> <span class="mi">2</span><span class="p">];</span>
		<span class="cm">/* Store ISA configuration */</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">isa_config</span> <span class="o">=</span> <span class="n">eeprom_buff</span><span class="p">[</span><span class="n">ISA_CNF_OFFSET</span> <span class="o">/</span> <span class="mi">2</span><span class="p">];</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">mem_start</span> <span class="o">=</span> <span class="n">eeprom_buff</span><span class="p">[</span><span class="n">PACKET_PAGE_OFFSET</span> <span class="o">/</span> <span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>

		<span class="cm">/* eeprom_buff has 32-bit ints, so we can&#39;t just memcpy it */</span>
		<span class="cm">/* store the initial memory base address */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ETH_ALEN</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">eeprom_buff</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">eeprom_buff</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">cs89_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">debug</span><span class="p">,</span> <span class="s">&quot;%s: new adapter_cnf: 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">adapter_cnf</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* allow them to force multiple transceivers.  If they force multiple, autosense */</span>
	<span class="p">{</span>
		<span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">force</span> <span class="o">&amp;</span> <span class="n">FORCE_RJ45</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">lp</span><span class="o">-&gt;</span><span class="n">adapter_cnf</span> <span class="o">|=</span> <span class="n">A_CNF_10B_T</span><span class="p">;</span>
			<span class="n">count</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">force</span> <span class="o">&amp;</span> <span class="n">FORCE_AUI</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">lp</span><span class="o">-&gt;</span><span class="n">adapter_cnf</span> <span class="o">|=</span> <span class="n">A_CNF_AUI</span><span class="p">;</span>
			<span class="n">count</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">force</span> <span class="o">&amp;</span> <span class="n">FORCE_BNC</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">lp</span><span class="o">-&gt;</span><span class="n">adapter_cnf</span> <span class="o">|=</span> <span class="n">A_CNF_10B_2</span><span class="p">;</span>
			<span class="n">count</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">lp</span><span class="o">-&gt;</span><span class="n">adapter_cnf</span> <span class="o">|=</span> <span class="n">A_CNF_MEDIA_AUTO</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">force</span> <span class="o">&amp;</span> <span class="n">FORCE_RJ45</span><span class="p">)</span>
			<span class="n">lp</span><span class="o">-&gt;</span><span class="n">adapter_cnf</span> <span class="o">|=</span> <span class="n">A_CNF_MEDIA_10B_T</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">force</span> <span class="o">&amp;</span> <span class="n">FORCE_AUI</span><span class="p">)</span>
			<span class="n">lp</span><span class="o">-&gt;</span><span class="n">adapter_cnf</span> <span class="o">|=</span> <span class="n">A_CNF_MEDIA_AUI</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">force</span> <span class="o">&amp;</span> <span class="n">FORCE_BNC</span><span class="p">)</span>
			<span class="n">lp</span><span class="o">-&gt;</span><span class="n">adapter_cnf</span> <span class="o">|=</span> <span class="n">A_CNF_MEDIA_10B_2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cs89_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">debug</span><span class="p">,</span> <span class="s">&quot;%s: after force 0x%x, adapter_cnf=0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">force</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">adapter_cnf</span><span class="p">);</span>

	<span class="cm">/* FIXME: We don&#39;t let you set dc-dc polarity or low RX squelch from the command line: add it here */</span>

	<span class="cm">/* FIXME: We don&#39;t let you set the IMM bit from the command line: add it to lp-&gt;auto_neg_cnf here */</span>

	<span class="cm">/* FIXME: we don&#39;t set the Ethernet address on the command line.  Use</span>
<span class="cm">	 * ifconfig IFACE hw ether AABBCCDDEEFF</span>
<span class="cm">	 */</span>

	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;media %s%s%s&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">adapter_cnf</span> <span class="o">&amp;</span> <span class="n">A_CNF_10B_T</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;RJ-45,&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">adapter_cnf</span> <span class="o">&amp;</span> <span class="n">A_CNF_AUI</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;AUI,&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">adapter_cnf</span> <span class="o">&amp;</span> <span class="n">A_CNF_10B_2</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;BNC,&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">);</span>

	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">irq_map</span> <span class="o">=</span> <span class="mh">0xffff</span><span class="p">;</span>

	<span class="cm">/* If this is a CS8900 then no pnp soft */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">chip_type</span> <span class="o">!=</span> <span class="n">CS8900</span> <span class="o">&amp;&amp;</span>
	    <span class="cm">/* Check if the ISA IRQ has been set  */</span>
	    <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">readreg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PP_CS8920_ISAINT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span>
	     <span class="p">(</span><span class="n">i</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">CS8920_NO_INTS</span><span class="p">)))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">)</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">i</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">isa_config</span> <span class="o">&amp;</span> <span class="n">INT_NO_MASK</span><span class="p">;</span>
<span class="cp">#ifndef CONFIG_CS89x0_PLATFORM</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">chip_type</span> <span class="o">==</span> <span class="n">CS8900</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifdef CS89x0_NONISA_IRQ</span>
			<span class="n">i</span> <span class="o">=</span> <span class="n">cs8900_irq_map</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<span class="cp">#else</span>
			<span class="cm">/* Translate the IRQ using the IRQ mapping table. */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">cs8900_irq_map</span><span class="p">))</span>
				<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;invalid ISA interrupt number %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">i</span> <span class="o">=</span> <span class="n">cs8900_irq_map</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

			<span class="n">lp</span><span class="o">-&gt;</span><span class="n">irq_map</span> <span class="o">=</span> <span class="n">CS8900_IRQ_MAP</span><span class="p">;</span> <span class="cm">/* fixed IRQ map for CS8900 */</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">irq_map_buff</span><span class="p">[</span><span class="n">IRQ_MAP_LEN</span><span class="o">/</span><span class="mi">2</span><span class="p">];</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">get_eeprom_data</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">IRQ_MAP_EEPROM_DATA</span><span class="p">,</span>
					    <span class="n">IRQ_MAP_LEN</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span>
					    <span class="n">irq_map_buff</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">irq_map_buff</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">==</span> <span class="n">PNP_IRQ_FRMT</span><span class="p">)</span>
					<span class="n">lp</span><span class="o">-&gt;</span><span class="n">irq_map</span> <span class="o">=</span> <span class="p">((</span><span class="n">irq_map_buff</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span>
						       <span class="p">(</span><span class="n">irq_map_buff</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">));</span>
			<span class="p">}</span>
<span class="cp">#endif</span>
		<span class="p">}</span>
<span class="cp">#endif</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">)</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pr_cont</span><span class="p">(</span><span class="s">&quot; IRQ %d&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>

<span class="cp">#if ALLOW_DMA</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">use_dma</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">get_dma_channel</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">pr_cont</span><span class="p">(</span><span class="s">&quot;, DMA %d&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
<span class="cp">#endif</span>
		<span class="n">pr_cont</span><span class="p">(</span><span class="s">&quot;, programmed I/O&quot;</span><span class="p">);</span>

	<span class="cm">/* print the ethernet address. */</span>
	<span class="n">pr_cont</span><span class="p">(</span><span class="s">&quot;, MAC %pM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">);</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">netdev_ops</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">net_ops</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">watchdog_timeo</span> <span class="o">=</span> <span class="n">HZ</span><span class="p">;</span>

	<span class="n">cs89_dbg</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="s">&quot;cs89x0_probe1() successful</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">register_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out2</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">out2:</span>
	<span class="n">iowrite16</span><span class="p">(</span><span class="n">PP_ChipID</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">virt_addr</span> <span class="o">+</span> <span class="n">ADD_PORT</span><span class="p">);</span>
<span class="nl">out1:</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifndef CONFIG_CS89x0_PLATFORM</span>
<span class="cm">/*</span>
<span class="cm"> * This function converts the I/O port addres used by the cs89x0_probe() and</span>
<span class="cm"> * init_module() functions to the I/O memory address used by the</span>
<span class="cm"> * cs89x0_probe1() function.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span>
<span class="nf">cs89x0_ioport_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ioport</span><span class="p">,</span> <span class="kt">int</span> <span class="n">modular</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_local</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">io_mem</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lp</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">=</span> <span class="n">ioport</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">request_region</span><span class="p">(</span><span class="n">ioport</span><span class="p">,</span> <span class="n">NETCARD_IO_EXTENT</span><span class="p">,</span> <span class="n">DRV_NAME</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">io_mem</span> <span class="o">=</span> <span class="n">ioport_map</span><span class="p">(</span><span class="n">ioport</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">3</span><span class="p">,</span> <span class="n">NETCARD_IO_EXTENT</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">io_mem</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">release</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* if they give us an odd I/O address, then do ONE write to</span>
<span class="cm">	 * the address port, to get it back to address zero, where we</span>
<span class="cm">	 * expect to find the EISA signature word. An IO with a base of 0x3</span>
<span class="cm">	 * will skip the test for the ADD_PORT.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ioport</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cs89_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="s">&quot;%s: odd ioaddr 0x%lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ioport</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">ioport</span> <span class="o">&amp;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">ioread16</span><span class="p">(</span><span class="n">io_mem</span> <span class="o">+</span> <span class="n">ADD_PORT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ADD_MASK</span><span class="p">)</span> <span class="o">!=</span>
			    <span class="n">ADD_SIG</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: bad signature 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ioread16</span><span class="p">(</span><span class="n">io_mem</span> <span class="o">+</span> <span class="n">ADD_PORT</span><span class="p">));</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">unmap</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">cs89x0_probe1</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">io_mem</span><span class="p">,</span> <span class="n">modular</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
<span class="nl">unmap:</span>
	<span class="n">ioport_unmap</span><span class="p">(</span><span class="n">io_mem</span><span class="p">);</span>
<span class="nl">release:</span>
	<span class="n">release_region</span><span class="p">(</span><span class="n">ioport</span><span class="p">,</span> <span class="n">NETCARD_IO_EXTENT</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifndef MODULE</span>
<span class="cm">/* Check for a network adaptor of this type, and return &#39;0&#39; iff one exists.</span>
<span class="cm"> * If dev-&gt;base_addr == 0, probe all likely locations.</span>
<span class="cm"> * If dev-&gt;base_addr == 1, always return failure.</span>
<span class="cm"> * If dev-&gt;base_addr == 2, allocate space for the device and return success</span>
<span class="cm"> * (detachable devices only).</span>
<span class="cm"> * Return 0 on success.</span>
<span class="cm"> */</span>

<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span> <span class="n">__init</span> <span class="nf">cs89x0_probe</span><span class="p">(</span><span class="kt">int</span> <span class="n">unit</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">alloc_etherdev</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_local</span><span class="p">));</span>
	<span class="kt">unsigned</span> <span class="o">*</span><span class="n">port</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">irq</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">io</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ENODEV</span><span class="p">);</span>

	<span class="n">sprintf</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;eth%d&quot;</span><span class="p">,</span> <span class="n">unit</span><span class="p">);</span>
	<span class="n">netdev_boot_setup_check</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">io</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>
	<span class="n">irq</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>

	<span class="n">cs89_dbg</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="s">&quot;cs89x0_probe(0x%x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">io</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">io</span> <span class="o">&gt;</span> <span class="mh">0x1ff</span><span class="p">)</span>	<span class="p">{</span>	<span class="cm">/* Check a single specified location. */</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">cs89x0_ioport_probe</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">io</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">io</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* Don&#39;t probe at all. */</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">port</span> <span class="o">=</span> <span class="n">netcard_portlist</span><span class="p">;</span> <span class="o">*</span><span class="n">port</span><span class="p">;</span> <span class="n">port</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cs89x0_ioport_probe</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">irq</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!*</span><span class="n">port</span><span class="p">)</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">dev</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="n">free_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">pr_warn</span><span class="p">(</span><span class="s">&quot;no cs8900 or cs8920 detected.  Be sure to disable PnP with SETUP</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="n">err</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif</span>
<span class="cp">#endif</span>

<span class="cp">#if defined(MODULE) &amp;&amp; !defined(CONFIG_CS89x0_PLATFORM)</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev_cs89x0</span><span class="p">;</span>

<span class="cm">/* Support the &#39;debug&#39; module parm even if we&#39;re compiled for non-debug to</span>
<span class="cm"> * avoid breaking someone&#39;s startup scripts</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">io</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">irq</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">debug</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">char</span> <span class="n">media</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">duplex</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">use_dma</span><span class="p">;</span>			<span class="cm">/* These generate unused var warnings if ALLOW_DMA = 0 */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">dma</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">dmasize</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>		<span class="cm">/* or 64 */</span>

<span class="n">module_param</span><span class="p">(</span><span class="n">io</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">module_param_string</span><span class="p">(</span><span class="n">media</span><span class="p">,</span> <span class="n">media</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">media</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">duplex</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">dma</span> <span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">dmasize</span> <span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">use_dma</span> <span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">io</span><span class="p">,</span> <span class="s">&quot;cs89x0 I/O base address&quot;</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="s">&quot;cs89x0 IRQ number&quot;</span><span class="p">);</span>
<span class="cp">#if DEBUGGING</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="s">&quot;cs89x0 debug level (0-6)&quot;</span><span class="p">);</span>
<span class="cp">#else</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="s">&quot;(ignored)&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">media</span><span class="p">,</span> <span class="s">&quot;Set cs89x0 adapter(s) media type(s) (rj45,bnc,aui)&quot;</span><span class="p">);</span>
<span class="cm">/* No other value than -1 for duplex seems to be currently interpreted */</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">duplex</span><span class="p">,</span> <span class="s">&quot;(ignored)&quot;</span><span class="p">);</span>
<span class="cp">#if ALLOW_DMA</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">dma</span> <span class="p">,</span> <span class="s">&quot;cs89x0 ISA DMA channel; ignored if use_dma=0&quot;</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">dmasize</span> <span class="p">,</span> <span class="s">&quot;cs89x0 DMA size in kB (16,64); ignored if use_dma=0&quot;</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">use_dma</span> <span class="p">,</span> <span class="s">&quot;cs89x0 using DMA (0-1)&quot;</span><span class="p">);</span>
<span class="cp">#else</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">dma</span> <span class="p">,</span> <span class="s">&quot;(ignored)&quot;</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">dmasize</span> <span class="p">,</span> <span class="s">&quot;(ignored)&quot;</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">use_dma</span> <span class="p">,</span> <span class="s">&quot;(ignored)&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Mike Cruse, Russwll Nelson &lt;nelson@crynwr.com&gt;, Andrew Morton&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * media=t             - specify media type</span>
<span class="cm"> * or media=2</span>
<span class="cm"> * or media=aui</span>
<span class="cm"> * or medai=auto</span>
<span class="cm"> * duplex=0            - specify forced half/full/autonegotiate duplex</span>
<span class="cm"> * debug=#             - debug level</span>
<span class="cm"> *</span>
<span class="cm"> * Default Chip Configuration:</span>
<span class="cm"> * DMA Burst = enabled</span>
<span class="cm"> * IOCHRDY Enabled = enabled</span>
<span class="cm"> * UseSA = enabled</span>
<span class="cm"> * CS8900 defaults to half-duplex if not specified on command-line</span>
<span class="cm"> * CS8920 defaults to autoneg if not specified on command-line</span>
<span class="cm"> * Use reset defaults for other config parameters</span>
<span class="cm"> *</span>
<span class="cm"> * Assumptions:</span>
<span class="cm"> * media type specified is supported (circuitry is present)</span>
<span class="cm"> * if memory address is &gt; 1MB, then required mem decode hw is present</span>
<span class="cm"> * if 10B-2, then agent other than driver will enable DC/DC converter</span>
<span class="cm"> * (hw or software util)</span>
<span class="cm"> */</span>

<span class="kt">int</span> <span class="n">__init</span> <span class="nf">init_module</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">alloc_etherdev</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_local</span><span class="p">));</span>
	<span class="k">struct</span> <span class="n">net_local</span> <span class="o">*</span><span class="n">lp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="cp">#if DEBUGGING</span>
	<span class="n">net_debug</span> <span class="o">=</span> <span class="n">debug</span><span class="p">;</span>
<span class="cp">#else</span>
	<span class="n">debug</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">irq</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">=</span> <span class="n">io</span><span class="p">;</span>
	<span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

<span class="cp">#if ALLOW_DMA</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">use_dma</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">use_dma</span> <span class="o">=</span> <span class="n">use_dma</span><span class="p">;</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">dma</span> <span class="o">=</span> <span class="n">dma</span><span class="p">;</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">dmasize</span> <span class="o">=</span> <span class="n">dmasize</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="cm">/* boy, they&#39;d better get these right */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">media</span><span class="p">,</span> <span class="s">&quot;rj45&quot;</span><span class="p">))</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">adapter_cnf</span> <span class="o">=</span> <span class="n">A_CNF_MEDIA_10B_T</span> <span class="o">|</span> <span class="n">A_CNF_10B_T</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">media</span><span class="p">,</span> <span class="s">&quot;aui&quot;</span><span class="p">))</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">adapter_cnf</span> <span class="o">=</span> <span class="n">A_CNF_MEDIA_AUI</span>   <span class="o">|</span> <span class="n">A_CNF_AUI</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">media</span><span class="p">,</span> <span class="s">&quot;bnc&quot;</span><span class="p">))</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">adapter_cnf</span> <span class="o">=</span> <span class="n">A_CNF_MEDIA_10B_2</span> <span class="o">|</span> <span class="n">A_CNF_10B_2</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">adapter_cnf</span> <span class="o">=</span> <span class="n">A_CNF_MEDIA_10B_T</span> <span class="o">|</span> <span class="n">A_CNF_10B_T</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">duplex</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">auto_neg_cnf</span> <span class="o">=</span> <span class="n">AUTO_NEG_ENABLE</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">io</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Module autoprobing not allowed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Append io=0xNNN</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">io</span> <span class="o">&lt;=</span> <span class="mh">0x1ff</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

<span class="cp">#if ALLOW_DMA</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">use_dma</span> <span class="o">&amp;&amp;</span> <span class="n">dmasize</span> <span class="o">!=</span> <span class="mi">16</span> <span class="o">&amp;&amp;</span> <span class="n">dmasize</span> <span class="o">!=</span> <span class="mi">64</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;dma size must be either 16K or 64K, not %dK</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">dmasize</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">cs89x0_ioport_probe</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">io</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">dev_cs89x0</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="n">free_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">__exit</span>
<span class="nf">cleanup_module</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_local</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev_cs89x0</span><span class="p">);</span>

	<span class="n">unregister_netdev</span><span class="p">(</span><span class="n">dev_cs89x0</span><span class="p">);</span>
	<span class="n">iowrite16</span><span class="p">(</span><span class="n">PP_ChipID</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">virt_addr</span> <span class="o">+</span> <span class="n">ADD_PORT</span><span class="p">);</span>
	<span class="n">ioport_unmap</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">virt_addr</span><span class="p">);</span>
	<span class="n">release_region</span><span class="p">(</span><span class="n">dev_cs89x0</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">,</span> <span class="n">NETCARD_IO_EXTENT</span><span class="p">);</span>
	<span class="n">free_netdev</span><span class="p">(</span><span class="n">dev_cs89x0</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* MODULE &amp;&amp; !CONFIG_CS89x0_PLATFORM */</span><span class="cp"></span>

<span class="cp">#ifdef CONFIG_CS89x0_PLATFORM</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">cs89x0_platform_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">alloc_etherdev</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_local</span><span class="p">));</span>
	<span class="k">struct</span> <span class="n">net_local</span> <span class="o">*</span><span class="n">lp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">mem_res</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">virt_addr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">mem_res</span> <span class="o">=</span> <span class="n">platform_get_resource</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">platform_get_irq</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mem_res</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;memory/interrupt resource missing</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">free</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="n">resource_size</span><span class="p">(</span><span class="n">mem_res</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">request_mem_region</span><span class="p">(</span><span class="n">mem_res</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">,</span> <span class="n">DRV_NAME</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;request_mem_region() failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">free</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">virt_addr</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">mem_res</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">virt_addr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;ioremap() failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">release</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">cs89x0_probe1</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">virt_addr</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;no cs8900 or cs8920 detected</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">unmap</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">platform_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">unmap:</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">virt_addr</span><span class="p">);</span>
<span class="nl">release:</span>
	<span class="n">release_mem_region</span><span class="p">(</span><span class="n">mem_res</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>
<span class="nl">free:</span>
	<span class="n">free_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cs89x0_platform_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">platform_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">net_local</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">mem_res</span><span class="p">;</span>

	<span class="cm">/* This platform_get_resource() call will not return NULL, because</span>
<span class="cm">	 * the same call in cs89x0_platform_probe() has returned a non NULL</span>
<span class="cm">	 * value.</span>
<span class="cm">	 */</span>
	<span class="n">mem_res</span> <span class="o">=</span> <span class="n">platform_get_resource</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">unregister_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">virt_addr</span><span class="p">);</span>
	<span class="n">release_mem_region</span><span class="p">(</span><span class="n">mem_res</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>
	<span class="n">free_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_driver</span> <span class="n">cs89x0_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">driver</span>	<span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="n">DRV_NAME</span><span class="p">,</span>
		<span class="p">.</span><span class="n">owner</span>	<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">remove</span>	<span class="o">=</span> <span class="n">cs89x0_platform_remove</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">cs89x0_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">platform_driver_probe</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs89x0_driver</span><span class="p">,</span> <span class="n">cs89x0_platform_probe</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">cs89x0_init</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">cs89x0_cleanup</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">platform_driver_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs89x0_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_exit</span><span class="p">(</span><span class="n">cs89x0_cleanup</span><span class="p">);</span>

<span class="cp">#endif </span><span class="cm">/* CONFIG_CS89x0_PLATFORM */</span><span class="cp"></span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
