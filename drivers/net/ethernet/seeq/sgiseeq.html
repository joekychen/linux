<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › ethernet › seeq › sgiseeq.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>sgiseeq.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * sgiseeq.c: Seeq8003 ethernet driver for SGI machines.</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 1996 David S. Miller (davem@davemloft.net)</span>
<span class="cm"> */</span>

<span class="cp">#undef DEBUG</span>

<span class="cp">#include &lt;linux/dma-mapping.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/netdevice.h&gt;</span>
<span class="cp">#include &lt;linux/platform_device.h&gt;</span>
<span class="cp">#include &lt;linux/etherdevice.h&gt;</span>
<span class="cp">#include &lt;linux/skbuff.h&gt;</span>

<span class="cp">#include &lt;asm/sgi/hpc3.h&gt;</span>
<span class="cp">#include &lt;asm/sgi/ip22.h&gt;</span>
<span class="cp">#include &lt;asm/sgi/seeq.h&gt;</span>

<span class="cp">#include &quot;sgiseeq.h&quot;</span>

<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">sgiseeqstr</span> <span class="o">=</span> <span class="s">&quot;SGI Seeq8003&quot;</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> * If you want speed, you do something silly, it always has worked for me.  So,</span>
<span class="cm"> * with that in mind, I&#39;ve decided to make this driver look completely like a</span>
<span class="cm"> * stupid Lance from a driver architecture perspective.  Only difference is that</span>
<span class="cm"> * here our &quot;ring buffer&quot; looks and acts like a real Lance one does but is</span>
<span class="cm"> * laid out like how the HPC DMA and the Seeq want it to.  You&#39;d be surprised</span>
<span class="cm"> * how a stupid idea like this can pay off in performance, not to mention</span>
<span class="cm"> * making this driver 2,000 times easier to write. ;-)</span>
<span class="cm"> */</span>

<span class="cm">/* Tune these if we tend to run out often etc. */</span>
<span class="cp">#define SEEQ_RX_BUFFERS  16</span>
<span class="cp">#define SEEQ_TX_BUFFERS  16</span>

<span class="cp">#define PKT_BUF_SZ       1584</span>

<span class="cp">#define NEXT_RX(i)  (((i) + 1) &amp; (SEEQ_RX_BUFFERS - 1))</span>
<span class="cp">#define NEXT_TX(i)  (((i) + 1) &amp; (SEEQ_TX_BUFFERS - 1))</span>
<span class="cp">#define PREV_RX(i)  (((i) - 1) &amp; (SEEQ_RX_BUFFERS - 1))</span>
<span class="cp">#define PREV_TX(i)  (((i) - 1) &amp; (SEEQ_TX_BUFFERS - 1))</span>

<span class="cp">#define TX_BUFFS_AVAIL(sp) ((sp-&gt;tx_old &lt;= sp-&gt;tx_new) ? \</span>
<span class="cp">			    sp-&gt;tx_old + (SEEQ_TX_BUFFERS - 1) - sp-&gt;tx_new : \</span>
<span class="cp">			    sp-&gt;tx_old - sp-&gt;tx_new - 1)</span>

<span class="cp">#define VIRT_TO_DMA(sp, v) ((sp)-&gt;srings_dma +                                 \</span>
<span class="cp">				  (dma_addr_t)((unsigned long)(v) -            \</span>
<span class="cp">					       (unsigned long)((sp)-&gt;rx_desc)))</span>

<span class="cm">/* Copy frames shorter than rx_copybreak, otherwise pass on up in</span>
<span class="cm"> * a full sized sk_buff.  Value of 100 stolen from tulip.c (!alpha).</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">rx_copybreak</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>

<span class="cp">#define PAD_SIZE    (128 - sizeof(struct hpc_dma_desc) - sizeof(void *))</span>

<span class="k">struct</span> <span class="n">sgiseeq_rx_desc</span> <span class="p">{</span>
	<span class="k">volatile</span> <span class="k">struct</span> <span class="n">hpc_dma_desc</span> <span class="n">rdma</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">padding</span><span class="p">[</span><span class="n">PAD_SIZE</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">sgiseeq_tx_desc</span> <span class="p">{</span>
	<span class="k">volatile</span> <span class="k">struct</span> <span class="n">hpc_dma_desc</span> <span class="n">tdma</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">padding</span><span class="p">[</span><span class="n">PAD_SIZE</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Warning: This structure is laid out in a certain way because HPC dma</span>
<span class="cm"> *          descriptors must be 8-byte aligned.  So don&#39;t touch this without</span>
<span class="cm"> *          some care.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">sgiseeq_init_block</span> <span class="p">{</span> <span class="cm">/* Note the name ;-) */</span>
	<span class="k">struct</span> <span class="n">sgiseeq_rx_desc</span> <span class="n">rxvector</span><span class="p">[</span><span class="n">SEEQ_RX_BUFFERS</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">sgiseeq_tx_desc</span> <span class="n">txvector</span><span class="p">[</span><span class="n">SEEQ_TX_BUFFERS</span><span class="p">];</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">sgiseeq_private</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">sgiseeq_init_block</span> <span class="o">*</span><span class="n">srings</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">srings_dma</span><span class="p">;</span>

	<span class="cm">/* Ptrs to the descriptors in uncached space. */</span>
	<span class="k">struct</span> <span class="n">sgiseeq_rx_desc</span> <span class="o">*</span><span class="n">rx_desc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sgiseeq_tx_desc</span> <span class="o">*</span><span class="n">tx_desc</span><span class="p">;</span>

	<span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hpc3_ethregs</span> <span class="o">*</span><span class="n">hregs</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sgiseeq_regs</span> <span class="o">*</span><span class="n">sregs</span><span class="p">;</span>

	<span class="cm">/* Ring entry counters. */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">rx_new</span><span class="p">,</span> <span class="n">tx_new</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">rx_old</span><span class="p">,</span> <span class="n">tx_old</span><span class="p">;</span>

	<span class="kt">int</span> <span class="n">is_edlc</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">control</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">mode</span><span class="p">;</span>

	<span class="n">spinlock_t</span> <span class="n">tx_lock</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">dma_sync_desc_cpu</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dma_cache_sync</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sgiseeq_rx_desc</span><span class="p">),</span>
		       <span class="n">DMA_FROM_DEVICE</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">dma_sync_desc_dev</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dma_cache_sync</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sgiseeq_rx_desc</span><span class="p">),</span>
		       <span class="n">DMA_TO_DEVICE</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">hpc3_eth_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">hpc3_ethregs</span> <span class="o">*</span><span class="n">hregs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">hregs</span><span class="o">-&gt;</span><span class="n">reset</span> <span class="o">=</span> <span class="n">HPC3_ERST_CRESET</span> <span class="o">|</span> <span class="n">HPC3_ERST_CLRIRQ</span><span class="p">;</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>
	<span class="n">hregs</span><span class="o">-&gt;</span><span class="n">reset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">reset_hpc3_and_seeq</span><span class="p">(</span><span class="k">struct</span> <span class="n">hpc3_ethregs</span> <span class="o">*</span><span class="n">hregs</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">sgiseeq_regs</span> <span class="o">*</span><span class="n">sregs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">hregs</span><span class="o">-&gt;</span><span class="n">rx_ctrl</span> <span class="o">=</span> <span class="n">hregs</span><span class="o">-&gt;</span><span class="n">tx_ctrl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">hpc3_eth_reset</span><span class="p">(</span><span class="n">hregs</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#define RSTAT_GO_BITS (SEEQ_RCMD_IGOOD | SEEQ_RCMD_IEOF | SEEQ_RCMD_ISHORT | \</span>
<span class="cp">		       SEEQ_RCMD_IDRIB | SEEQ_RCMD_ICRC)</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">seeq_go</span><span class="p">(</span><span class="k">struct</span> <span class="n">sgiseeq_private</span> <span class="o">*</span><span class="n">sp</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">hpc3_ethregs</span> <span class="o">*</span><span class="n">hregs</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">sgiseeq_regs</span> <span class="o">*</span><span class="n">sregs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">sregs</span><span class="o">-&gt;</span><span class="n">rstat</span> <span class="o">=</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">|</span> <span class="n">RSTAT_GO_BITS</span><span class="p">;</span>
	<span class="n">hregs</span><span class="o">-&gt;</span><span class="n">rx_ctrl</span> <span class="o">=</span> <span class="n">HPC3_ERXCTRL_ACTIVE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">__sgiseeq_set_mac_address</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sgiseeq_private</span> <span class="o">*</span><span class="n">sp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sgiseeq_regs</span> <span class="o">*</span><span class="n">sregs</span> <span class="o">=</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">sregs</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">sregs</span><span class="o">-&gt;</span><span class="n">tstat</span> <span class="o">=</span> <span class="n">SEEQ_TCMD_RB0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">sregs</span><span class="o">-&gt;</span><span class="n">rw</span><span class="p">.</span><span class="n">eth_addr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sgiseeq_set_mac_address</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sgiseeq_private</span> <span class="o">*</span><span class="n">sp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="n">sa</span> <span class="o">=</span> <span class="n">addr</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">sa</span><span class="o">-&gt;</span><span class="n">sa_data</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">addr_len</span><span class="p">);</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">tx_lock</span><span class="p">);</span>
	<span class="n">__sgiseeq_set_mac_address</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">tx_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define TCNTINFO_INIT (HPCDMA_EOX | HPCDMA_ETXD)</span>
<span class="cp">#define RCNTCFG_INIT  (HPCDMA_OWN | HPCDMA_EORP | HPCDMA_XIE)</span>
<span class="cp">#define RCNTINFO_INIT (RCNTCFG_INIT | (PKT_BUF_SZ &amp; HPCDMA_BCNT))</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">seeq_init_ring</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sgiseeq_private</span> <span class="o">*</span><span class="n">sp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">sp</span><span class="o">-&gt;</span><span class="n">rx_new</span> <span class="o">=</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">tx_new</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">sp</span><span class="o">-&gt;</span><span class="n">rx_old</span> <span class="o">=</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">tx_old</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">__sgiseeq_set_mac_address</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* Setup tx ring. */</span>
	<span class="k">for</span><span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">SEEQ_TX_BUFFERS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sp</span><span class="o">-&gt;</span><span class="n">tx_desc</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">tdma</span><span class="p">.</span><span class="n">cntinfo</span> <span class="o">=</span> <span class="n">TCNTINFO_INIT</span><span class="p">;</span>
		<span class="n">dma_sync_desc_dev</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">tx_desc</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="p">}</span>

	<span class="cm">/* And now the rx ring. */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">SEEQ_RX_BUFFERS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">rx_desc</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dma_addr_t</span> <span class="n">dma_addr</span><span class="p">;</span>
			<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="n">netdev_alloc_skb</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PKT_BUF_SZ</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">skb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="n">skb_reserve</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
			<span class="n">dma_addr</span> <span class="o">=</span> <span class="n">dma_map_single</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span><span class="p">,</span>
						  <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">-</span> <span class="mi">2</span><span class="p">,</span>
						  <span class="n">PKT_BUF_SZ</span><span class="p">,</span> <span class="n">DMA_FROM_DEVICE</span><span class="p">);</span>
			<span class="n">sp</span><span class="o">-&gt;</span><span class="n">rx_desc</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">skb</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>
			<span class="n">sp</span><span class="o">-&gt;</span><span class="n">rx_desc</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rdma</span><span class="p">.</span><span class="n">pbuf</span> <span class="o">=</span> <span class="n">dma_addr</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">sp</span><span class="o">-&gt;</span><span class="n">rx_desc</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rdma</span><span class="p">.</span><span class="n">cntinfo</span> <span class="o">=</span> <span class="n">RCNTINFO_INIT</span><span class="p">;</span>
		<span class="n">dma_sync_desc_dev</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">rx_desc</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="p">}</span>
	<span class="n">sp</span><span class="o">-&gt;</span><span class="n">rx_desc</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">].</span><span class="n">rdma</span><span class="p">.</span><span class="n">cntinfo</span> <span class="o">|=</span> <span class="n">HPCDMA_EOR</span><span class="p">;</span>
	<span class="n">dma_sync_desc_dev</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">rx_desc</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">seeq_purge_ring</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sgiseeq_private</span> <span class="o">*</span><span class="n">sp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* clear tx ring. */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">SEEQ_TX_BUFFERS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">tx_desc</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">tx_desc</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">skb</span><span class="p">);</span>
			<span class="n">sp</span><span class="o">-&gt;</span><span class="n">tx_desc</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* And now the rx ring. */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">SEEQ_RX_BUFFERS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">rx_desc</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">rx_desc</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">skb</span><span class="p">);</span>
			<span class="n">sp</span><span class="o">-&gt;</span><span class="n">rx_desc</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cp">#ifdef DEBUG</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">sgiseeq_private</span> <span class="o">*</span><span class="n">gpriv</span><span class="p">;</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">gdev</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sgiseeq_dump_rings</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="kt">int</span> <span class="n">once</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sgiseeq_rx_desc</span> <span class="o">*</span><span class="n">r</span> <span class="o">=</span> <span class="n">gpriv</span><span class="o">-&gt;</span><span class="n">rx_desc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sgiseeq_tx_desc</span> <span class="o">*</span><span class="n">t</span> <span class="o">=</span> <span class="n">gpriv</span><span class="o">-&gt;</span><span class="n">tx_desc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hpc3_ethregs</span> <span class="o">*</span><span class="n">hregs</span> <span class="o">=</span> <span class="n">gpriv</span><span class="o">-&gt;</span><span class="n">hregs</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">once</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">once</span><span class="o">++</span><span class="p">;</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;RING DUMP:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">SEEQ_RX_BUFFERS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;RX [%d]: @(%p) [%08x,%08x,%08x] &quot;</span><span class="p">,</span>
		       <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">r</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span> <span class="n">r</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rdma</span><span class="p">.</span><span class="n">pbuf</span><span class="p">,</span> <span class="n">r</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rdma</span><span class="p">.</span><span class="n">cntinfo</span><span class="p">,</span>
		       <span class="n">r</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rdma</span><span class="p">.</span><span class="n">pnext</span><span class="p">);</span>
		<span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;-- [%d]: @(%p) [%08x,%08x,%08x]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">r</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span> <span class="n">r</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rdma</span><span class="p">.</span><span class="n">pbuf</span><span class="p">,</span> <span class="n">r</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rdma</span><span class="p">.</span><span class="n">cntinfo</span><span class="p">,</span>
		       <span class="n">r</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rdma</span><span class="p">.</span><span class="n">pnext</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">SEEQ_TX_BUFFERS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;TX [%d]: @(%p) [%08x,%08x,%08x] &quot;</span><span class="p">,</span>
		       <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">t</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span> <span class="n">t</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">tdma</span><span class="p">.</span><span class="n">pbuf</span><span class="p">,</span> <span class="n">t</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">tdma</span><span class="p">.</span><span class="n">cntinfo</span><span class="p">,</span>
		       <span class="n">t</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">tdma</span><span class="p">.</span><span class="n">pnext</span><span class="p">);</span>
		<span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;-- [%d]: @(%p) [%08x,%08x,%08x]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">t</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span> <span class="n">t</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">tdma</span><span class="p">.</span><span class="n">pbuf</span><span class="p">,</span> <span class="n">t</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">tdma</span><span class="p">.</span><span class="n">cntinfo</span><span class="p">,</span>
		       <span class="n">t</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">tdma</span><span class="p">.</span><span class="n">pnext</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;INFO: [rx_new = %d rx_old=%d] [tx_new = %d tx_old = %d]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">gpriv</span><span class="o">-&gt;</span><span class="n">rx_new</span><span class="p">,</span> <span class="n">gpriv</span><span class="o">-&gt;</span><span class="n">rx_old</span><span class="p">,</span> <span class="n">gpriv</span><span class="o">-&gt;</span><span class="n">tx_new</span><span class="p">,</span> <span class="n">gpriv</span><span class="o">-&gt;</span><span class="n">tx_old</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;RREGS: rx_cbptr[%08x] rx_ndptr[%08x] rx_ctrl[%08x]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">hregs</span><span class="o">-&gt;</span><span class="n">rx_cbptr</span><span class="p">,</span> <span class="n">hregs</span><span class="o">-&gt;</span><span class="n">rx_ndptr</span><span class="p">,</span> <span class="n">hregs</span><span class="o">-&gt;</span><span class="n">rx_ctrl</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;TREGS: tx_cbptr[%08x] tx_ndptr[%08x] tx_ctrl[%08x]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">hregs</span><span class="o">-&gt;</span><span class="n">tx_cbptr</span><span class="p">,</span> <span class="n">hregs</span><span class="o">-&gt;</span><span class="n">tx_ndptr</span><span class="p">,</span> <span class="n">hregs</span><span class="o">-&gt;</span><span class="n">tx_ctrl</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cp">#define TSTAT_INIT_SEEQ (SEEQ_TCMD_IPT|SEEQ_TCMD_I16|SEEQ_TCMD_IC|SEEQ_TCMD_IUF)</span>
<span class="cp">#define TSTAT_INIT_EDLC ((TSTAT_INIT_SEEQ) | SEEQ_TCMD_RB2)</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">init_seeq</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sgiseeq_private</span> <span class="o">*</span><span class="n">sp</span><span class="p">,</span>
		     <span class="k">struct</span> <span class="n">sgiseeq_regs</span> <span class="o">*</span><span class="n">sregs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hpc3_ethregs</span> <span class="o">*</span><span class="n">hregs</span> <span class="o">=</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">hregs</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">reset_hpc3_and_seeq</span><span class="p">(</span><span class="n">hregs</span><span class="p">,</span> <span class="n">sregs</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">seeq_init_ring</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="cm">/* Setup to field the proper interrupt types. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">is_edlc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sregs</span><span class="o">-&gt;</span><span class="n">tstat</span> <span class="o">=</span> <span class="n">TSTAT_INIT_EDLC</span><span class="p">;</span>
		<span class="n">sregs</span><span class="o">-&gt;</span><span class="n">rw</span><span class="p">.</span><span class="n">wregs</span><span class="p">.</span><span class="n">control</span> <span class="o">=</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">;</span>
		<span class="n">sregs</span><span class="o">-&gt;</span><span class="n">rw</span><span class="p">.</span><span class="n">wregs</span><span class="p">.</span><span class="n">frame_gap</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">sregs</span><span class="o">-&gt;</span><span class="n">tstat</span> <span class="o">=</span> <span class="n">TSTAT_INIT_SEEQ</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">hregs</span><span class="o">-&gt;</span><span class="n">rx_ndptr</span> <span class="o">=</span> <span class="n">VIRT_TO_DMA</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">rx_desc</span><span class="p">);</span>
	<span class="n">hregs</span><span class="o">-&gt;</span><span class="n">tx_ndptr</span> <span class="o">=</span> <span class="n">VIRT_TO_DMA</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">tx_desc</span><span class="p">);</span>

	<span class="n">seeq_go</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span> <span class="n">hregs</span><span class="p">,</span> <span class="n">sregs</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">record_rx_errors</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">SEEQ_RSTAT_OVERF</span> <span class="o">||</span>
	    <span class="n">status</span> <span class="o">&amp;</span> <span class="n">SEEQ_RSTAT_SFRAME</span><span class="p">)</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_over_errors</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">SEEQ_RSTAT_CERROR</span><span class="p">)</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_crc_errors</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">SEEQ_RSTAT_DERROR</span><span class="p">)</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_frame_errors</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">SEEQ_RSTAT_REOF</span><span class="p">)</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_errors</span><span class="o">++</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">rx_maybe_restart</span><span class="p">(</span><span class="k">struct</span> <span class="n">sgiseeq_private</span> <span class="o">*</span><span class="n">sp</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">hpc3_ethregs</span> <span class="o">*</span><span class="n">hregs</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">sgiseeq_regs</span> <span class="o">*</span><span class="n">sregs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">hregs</span><span class="o">-&gt;</span><span class="n">rx_ctrl</span> <span class="o">&amp;</span> <span class="n">HPC3_ERXCTRL_ACTIVE</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">hregs</span><span class="o">-&gt;</span><span class="n">rx_ndptr</span> <span class="o">=</span> <span class="n">VIRT_TO_DMA</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">rx_desc</span> <span class="o">+</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">rx_new</span><span class="p">);</span>
		<span class="n">seeq_go</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span> <span class="n">hregs</span><span class="p">,</span> <span class="n">sregs</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">sgiseeq_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sgiseeq_private</span> <span class="o">*</span><span class="n">sp</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">hpc3_ethregs</span> <span class="o">*</span><span class="n">hregs</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">sgiseeq_regs</span> <span class="o">*</span><span class="n">sregs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sgiseeq_rx_desc</span> <span class="o">*</span><span class="n">rd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">newskb</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">pkt_status</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">orig_end</span> <span class="o">=</span> <span class="n">PREV_RX</span><span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">rx_new</span><span class="p">);</span>

	<span class="cm">/* Service every received packet. */</span>
	<span class="n">rd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">rx_desc</span><span class="p">[</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">rx_new</span><span class="p">];</span>
	<span class="n">dma_sync_desc_cpu</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">rd</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">rd</span><span class="o">-&gt;</span><span class="n">rdma</span><span class="p">.</span><span class="n">cntinfo</span> <span class="o">&amp;</span> <span class="n">HPCDMA_OWN</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">PKT_BUF_SZ</span> <span class="o">-</span> <span class="p">(</span><span class="n">rd</span><span class="o">-&gt;</span><span class="n">rdma</span><span class="p">.</span><span class="n">cntinfo</span> <span class="o">&amp;</span> <span class="n">HPCDMA_BCNT</span><span class="p">)</span> <span class="o">-</span> <span class="mi">3</span><span class="p">;</span>
		<span class="n">dma_unmap_single</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span><span class="p">,</span> <span class="n">rd</span><span class="o">-&gt;</span><span class="n">rdma</span><span class="p">.</span><span class="n">pbuf</span><span class="p">,</span>
				 <span class="n">PKT_BUF_SZ</span><span class="p">,</span> <span class="n">DMA_FROM_DEVICE</span><span class="p">);</span>
		<span class="n">pkt_status</span> <span class="o">=</span> <span class="n">rd</span><span class="o">-&gt;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">len</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pkt_status</span> <span class="o">&amp;</span> <span class="n">SEEQ_RSTAT_FIG</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Packet is OK. */</span>
			<span class="cm">/* We don&#39;t want to receive our own packets */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="n">rd</span><span class="o">-&gt;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="mi">6</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">rx_copybreak</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">skb</span> <span class="o">=</span> <span class="n">rd</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">;</span>
					<span class="n">newskb</span> <span class="o">=</span> <span class="n">netdev_alloc_skb</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PKT_BUF_SZ</span><span class="p">);</span>
					<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">newskb</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">newskb</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>
						<span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
						<span class="k">goto</span> <span class="n">memory_squeeze</span><span class="p">;</span>
					<span class="p">}</span>
					<span class="n">skb_reserve</span><span class="p">(</span><span class="n">newskb</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">skb</span> <span class="o">=</span> <span class="n">netdev_alloc_skb_ip_align</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="p">)</span>
						<span class="n">skb_copy_to_linear_data</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">rd</span><span class="o">-&gt;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>

					<span class="n">newskb</span> <span class="o">=</span> <span class="n">rd</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">;</span>
				<span class="p">}</span>
<span class="nl">memory_squeeze:</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
					<span class="n">skb</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">eth_type_trans</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
					<span class="n">netif_rx</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
					<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_packets</span><span class="o">++</span><span class="p">;</span>
					<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_bytes</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">printk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;%s: Memory squeeze, deferring packet.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
					<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_dropped</span><span class="o">++</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="cm">/* Silently drop my own packets */</span>
				<span class="n">newskb</span> <span class="o">=</span> <span class="n">rd</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">record_rx_errors</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">pkt_status</span><span class="p">);</span>
			<span class="n">newskb</span> <span class="o">=</span> <span class="n">rd</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">rd</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">=</span> <span class="n">newskb</span><span class="p">;</span>
		<span class="n">rd</span><span class="o">-&gt;</span><span class="n">rdma</span><span class="p">.</span><span class="n">pbuf</span> <span class="o">=</span> <span class="n">dma_map_single</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span><span class="p">,</span>
					       <span class="n">newskb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">-</span> <span class="mi">2</span><span class="p">,</span>
					       <span class="n">PKT_BUF_SZ</span><span class="p">,</span> <span class="n">DMA_FROM_DEVICE</span><span class="p">);</span>

		<span class="cm">/* Return the entry to the ring pool. */</span>
		<span class="n">rd</span><span class="o">-&gt;</span><span class="n">rdma</span><span class="p">.</span><span class="n">cntinfo</span> <span class="o">=</span> <span class="n">RCNTINFO_INIT</span><span class="p">;</span>
		<span class="n">sp</span><span class="o">-&gt;</span><span class="n">rx_new</span> <span class="o">=</span> <span class="n">NEXT_RX</span><span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">rx_new</span><span class="p">);</span>
		<span class="n">dma_sync_desc_dev</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">rd</span><span class="p">);</span>
		<span class="n">rd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">rx_desc</span><span class="p">[</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">rx_new</span><span class="p">];</span>
		<span class="n">dma_sync_desc_cpu</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">rd</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">dma_sync_desc_cpu</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">rx_desc</span><span class="p">[</span><span class="n">orig_end</span><span class="p">]);</span>
	<span class="n">sp</span><span class="o">-&gt;</span><span class="n">rx_desc</span><span class="p">[</span><span class="n">orig_end</span><span class="p">].</span><span class="n">rdma</span><span class="p">.</span><span class="n">cntinfo</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">HPCDMA_EOR</span><span class="p">);</span>
	<span class="n">dma_sync_desc_dev</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">rx_desc</span><span class="p">[</span><span class="n">orig_end</span><span class="p">]);</span>
	<span class="n">dma_sync_desc_cpu</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">rx_desc</span><span class="p">[</span><span class="n">PREV_RX</span><span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">rx_new</span><span class="p">)]);</span>
	<span class="n">sp</span><span class="o">-&gt;</span><span class="n">rx_desc</span><span class="p">[</span><span class="n">PREV_RX</span><span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">rx_new</span><span class="p">)].</span><span class="n">rdma</span><span class="p">.</span><span class="n">cntinfo</span> <span class="o">|=</span> <span class="n">HPCDMA_EOR</span><span class="p">;</span>
	<span class="n">dma_sync_desc_dev</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">rx_desc</span><span class="p">[</span><span class="n">PREV_RX</span><span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">rx_new</span><span class="p">)]);</span>
	<span class="n">rx_maybe_restart</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span> <span class="n">hregs</span><span class="p">,</span> <span class="n">sregs</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">tx_maybe_reset_collisions</span><span class="p">(</span><span class="k">struct</span> <span class="n">sgiseeq_private</span> <span class="o">*</span><span class="n">sp</span><span class="p">,</span>
					     <span class="k">struct</span> <span class="n">sgiseeq_regs</span> <span class="o">*</span><span class="n">sregs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">is_edlc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sregs</span><span class="o">-&gt;</span><span class="n">rw</span><span class="p">.</span><span class="n">wregs</span><span class="p">.</span><span class="n">control</span> <span class="o">=</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">control</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">SEEQ_CTRL_XCNT</span><span class="p">);</span>
		<span class="n">sregs</span><span class="o">-&gt;</span><span class="n">rw</span><span class="p">.</span><span class="n">wregs</span><span class="p">.</span><span class="n">control</span> <span class="o">=</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">kick_tx</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">sgiseeq_private</span> <span class="o">*</span><span class="n">sp</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">hpc3_ethregs</span> <span class="o">*</span><span class="n">hregs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sgiseeq_tx_desc</span> <span class="o">*</span><span class="n">td</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">tx_old</span><span class="p">;</span>

	<span class="cm">/* If the HPC aint doin nothin, and there are more packets</span>
<span class="cm">	 * with ETXD cleared and XIU set we must make very certain</span>
<span class="cm">	 * that we restart the HPC else we risk locking up the</span>
<span class="cm">	 * adapter.  The following code is only safe iff the HPCDMA</span>
<span class="cm">	 * is not active!</span>
<span class="cm">	 */</span>
	<span class="n">td</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">tx_desc</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
	<span class="n">dma_sync_desc_cpu</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">td</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">td</span><span class="o">-&gt;</span><span class="n">tdma</span><span class="p">.</span><span class="n">cntinfo</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">HPCDMA_XIU</span> <span class="o">|</span> <span class="n">HPCDMA_ETXD</span><span class="p">))</span> <span class="o">==</span>
	      <span class="p">(</span><span class="n">HPCDMA_XIU</span> <span class="o">|</span> <span class="n">HPCDMA_ETXD</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">i</span> <span class="o">=</span> <span class="n">NEXT_TX</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
		<span class="n">td</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">tx_desc</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">dma_sync_desc_cpu</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">td</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">td</span><span class="o">-&gt;</span><span class="n">tdma</span><span class="p">.</span><span class="n">cntinfo</span> <span class="o">&amp;</span> <span class="n">HPCDMA_XIU</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hregs</span><span class="o">-&gt;</span><span class="n">tx_ndptr</span> <span class="o">=</span> <span class="n">VIRT_TO_DMA</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span> <span class="n">td</span><span class="p">);</span>
		<span class="n">hregs</span><span class="o">-&gt;</span><span class="n">tx_ctrl</span> <span class="o">=</span> <span class="n">HPC3_ETXCTRL_ACTIVE</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">sgiseeq_tx</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sgiseeq_private</span> <span class="o">*</span><span class="n">sp</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">hpc3_ethregs</span> <span class="o">*</span><span class="n">hregs</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">sgiseeq_regs</span> <span class="o">*</span><span class="n">sregs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sgiseeq_tx_desc</span> <span class="o">*</span><span class="n">td</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">status</span> <span class="o">=</span> <span class="n">hregs</span><span class="o">-&gt;</span><span class="n">tx_ctrl</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">j</span><span class="p">;</span>

	<span class="n">tx_maybe_reset_collisions</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span> <span class="n">sregs</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">HPC3_ETXCTRL_ACTIVE</span> <span class="o">|</span> <span class="n">SEEQ_TSTAT_PTRANS</span><span class="p">)))</span> <span class="p">{</span>
		<span class="cm">/* Oops, HPC detected some sort of error. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">SEEQ_TSTAT_R16</span><span class="p">)</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_aborted_errors</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">SEEQ_TSTAT_UFLOW</span><span class="p">)</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_fifo_errors</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">SEEQ_TSTAT_LCLS</span><span class="p">)</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">collisions</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Ack &#39;em... */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">tx_old</span><span class="p">;</span> <span class="n">j</span> <span class="o">!=</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">tx_new</span><span class="p">;</span> <span class="n">j</span> <span class="o">=</span> <span class="n">NEXT_TX</span><span class="p">(</span><span class="n">j</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">td</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">tx_desc</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>

		<span class="n">dma_sync_desc_cpu</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">td</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">td</span><span class="o">-&gt;</span><span class="n">tdma</span><span class="p">.</span><span class="n">cntinfo</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">HPCDMA_XIU</span><span class="p">)))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">td</span><span class="o">-&gt;</span><span class="n">tdma</span><span class="p">.</span><span class="n">cntinfo</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">HPCDMA_ETXD</span><span class="p">)))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">HPC3_ETXCTRL_ACTIVE</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">hregs</span><span class="o">-&gt;</span><span class="n">tx_ndptr</span> <span class="o">=</span> <span class="n">VIRT_TO_DMA</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span> <span class="n">td</span><span class="p">);</span>
				<span class="n">hregs</span><span class="o">-&gt;</span><span class="n">tx_ctrl</span> <span class="o">=</span> <span class="n">HPC3_ETXCTRL_ACTIVE</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_packets</span><span class="o">++</span><span class="p">;</span>
		<span class="n">sp</span><span class="o">-&gt;</span><span class="n">tx_old</span> <span class="o">=</span> <span class="n">NEXT_TX</span><span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">tx_old</span><span class="p">);</span>
		<span class="n">td</span><span class="o">-&gt;</span><span class="n">tdma</span><span class="p">.</span><span class="n">cntinfo</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">HPCDMA_XIU</span> <span class="o">|</span> <span class="n">HPCDMA_XIE</span><span class="p">);</span>
		<span class="n">td</span><span class="o">-&gt;</span><span class="n">tdma</span><span class="p">.</span><span class="n">cntinfo</span> <span class="o">|=</span> <span class="n">HPCDMA_EOX</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">td</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">td</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">);</span>
			<span class="n">td</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">dma_sync_desc_dev</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">td</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">sgiseeq_interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="p">)</span> <span class="n">dev_id</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sgiseeq_private</span> <span class="o">*</span><span class="n">sp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">hpc3_ethregs</span> <span class="o">*</span><span class="n">hregs</span> <span class="o">=</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">hregs</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sgiseeq_regs</span> <span class="o">*</span><span class="n">sregs</span> <span class="o">=</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">sregs</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">tx_lock</span><span class="p">);</span>

	<span class="cm">/* Ack the IRQ and set software state. */</span>
	<span class="n">hregs</span><span class="o">-&gt;</span><span class="n">reset</span> <span class="o">=</span> <span class="n">HPC3_ERST_CLRIRQ</span><span class="p">;</span>

	<span class="cm">/* Always check for received packets. */</span>
	<span class="n">sgiseeq_rx</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">sp</span><span class="p">,</span> <span class="n">hregs</span><span class="p">,</span> <span class="n">sregs</span><span class="p">);</span>

	<span class="cm">/* Only check for tx acks if we have something queued. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">tx_old</span> <span class="o">!=</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">tx_new</span><span class="p">)</span>
		<span class="n">sgiseeq_tx</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">sp</span><span class="p">,</span> <span class="n">hregs</span><span class="p">,</span> <span class="n">sregs</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">TX_BUFFS_AVAIL</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">netif_queue_stopped</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">tx_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sgiseeq_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sgiseeq_private</span> <span class="o">*</span><span class="n">sp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sgiseeq_regs</span> <span class="o">*</span><span class="n">sregs</span> <span class="o">=</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">sregs</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">irq</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">request_irq</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="n">sgiseeq_interrupt</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">sgiseeqstr</span><span class="p">,</span> <span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Seeq8003: Can&#39;t get irq %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">init_seeq</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">sp</span><span class="p">,</span> <span class="n">sregs</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_free_irq</span><span class="p">;</span>

	<span class="n">netif_start_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">out_free_irq:</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sgiseeq_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sgiseeq_private</span> <span class="o">*</span><span class="n">sp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sgiseeq_regs</span> <span class="o">*</span><span class="n">sregs</span> <span class="o">=</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">sregs</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">irq</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>

	<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* Shutdown the Seeq. */</span>
	<span class="n">reset_hpc3_and_seeq</span><span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">hregs</span><span class="p">,</span> <span class="n">sregs</span><span class="p">);</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="n">seeq_purge_ring</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">sgiseeq_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sgiseeq_private</span> <span class="o">*</span><span class="n">sp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sgiseeq_regs</span> <span class="o">*</span><span class="n">sregs</span> <span class="o">=</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">sregs</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">init_seeq</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">sp</span><span class="p">,</span> <span class="n">sregs</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">trans_start</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span> <span class="cm">/* prevent tx timeout */</span>
	<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sgiseeq_start_xmit</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sgiseeq_private</span> <span class="o">*</span><span class="n">sp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">hpc3_ethregs</span> <span class="o">*</span><span class="n">hregs</span> <span class="o">=</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">hregs</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sgiseeq_tx_desc</span> <span class="o">*</span><span class="n">td</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="n">entry</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">tx_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* Setup... */</span>
	<span class="n">len</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="n">ETH_ZLEN</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">skb_padto</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">ETH_ZLEN</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">tx_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">NETDEV_TX_OK</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">ETH_ZLEN</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_bytes</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
	<span class="n">entry</span> <span class="o">=</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">tx_new</span><span class="p">;</span>
	<span class="n">td</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">tx_desc</span><span class="p">[</span><span class="n">entry</span><span class="p">];</span>
	<span class="n">dma_sync_desc_cpu</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">td</span><span class="p">);</span>

	<span class="cm">/* Create entry.  There are so many races with adding a new</span>
<span class="cm">	 * descriptor to the chain:</span>
<span class="cm">	 * 1) Assume that the HPC is off processing a DMA chain while</span>
<span class="cm">	 *    we are changing all of the following.</span>
<span class="cm">	 * 2) Do no allow the HPC to look at a new descriptor until</span>
<span class="cm">	 *    we have completely set up it&#39;s state.  This means, do</span>
<span class="cm">	 *    not clear HPCDMA_EOX in the current last descritptor</span>
<span class="cm">	 *    until the one we are adding looks consistent and could</span>
<span class="cm">	 *    be processes right now.</span>
<span class="cm">	 * 3) The tx interrupt code must notice when we&#39;ve added a new</span>
<span class="cm">	 *    entry and the HPC got to the end of the chain before we</span>
<span class="cm">	 *    added this new entry and restarted it.</span>
<span class="cm">	 */</span>
	<span class="n">td</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>
	<span class="n">td</span><span class="o">-&gt;</span><span class="n">tdma</span><span class="p">.</span><span class="n">pbuf</span> <span class="o">=</span> <span class="n">dma_map_single</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span>
				       <span class="n">len</span><span class="p">,</span> <span class="n">DMA_TO_DEVICE</span><span class="p">);</span>
	<span class="n">td</span><span class="o">-&gt;</span><span class="n">tdma</span><span class="p">.</span><span class="n">cntinfo</span> <span class="o">=</span> <span class="p">(</span><span class="n">len</span> <span class="o">&amp;</span> <span class="n">HPCDMA_BCNT</span><span class="p">)</span> <span class="o">|</span>
	                   <span class="n">HPCDMA_XIU</span> <span class="o">|</span> <span class="n">HPCDMA_EOXP</span> <span class="o">|</span> <span class="n">HPCDMA_XIE</span> <span class="o">|</span> <span class="n">HPCDMA_EOX</span><span class="p">;</span>
	<span class="n">dma_sync_desc_dev</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">td</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">tx_old</span> <span class="o">!=</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">tx_new</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">sgiseeq_tx_desc</span> <span class="o">*</span><span class="n">backend</span><span class="p">;</span>

		<span class="n">backend</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">tx_desc</span><span class="p">[</span><span class="n">PREV_TX</span><span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">tx_new</span><span class="p">)];</span>
		<span class="n">dma_sync_desc_cpu</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">backend</span><span class="p">);</span>
		<span class="n">backend</span><span class="o">-&gt;</span><span class="n">tdma</span><span class="p">.</span><span class="n">cntinfo</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">HPCDMA_EOX</span><span class="p">;</span>
		<span class="n">dma_sync_desc_dev</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">backend</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">sp</span><span class="o">-&gt;</span><span class="n">tx_new</span> <span class="o">=</span> <span class="n">NEXT_TX</span><span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">tx_new</span><span class="p">);</span> <span class="cm">/* Advance. */</span>

	<span class="cm">/* Maybe kick the HPC back into motion. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">hregs</span><span class="o">-&gt;</span><span class="n">tx_ctrl</span> <span class="o">&amp;</span> <span class="n">HPC3_ETXCTRL_ACTIVE</span><span class="p">))</span>
		<span class="n">kick_tx</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">sp</span><span class="p">,</span> <span class="n">hregs</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">TX_BUFFS_AVAIL</span><span class="p">(</span><span class="n">sp</span><span class="p">))</span>
		<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">tx_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">NETDEV_TX_OK</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">timeout</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;%s: transmit timed out, resetting</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="n">sgiseeq_reset</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">trans_start</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span> <span class="cm">/* prevent tx timeout */</span>
	<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sgiseeq_set_multicast</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sgiseeq_private</span> <span class="o">*</span><span class="n">sp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">oldmode</span> <span class="o">=</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">;</span>

	<span class="k">if</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_PROMISC</span><span class="p">)</span>
		<span class="n">sp</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">=</span> <span class="n">SEEQ_RCMD_RANY</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_ALLMULTI</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="n">netdev_mc_empty</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="n">sp</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">=</span> <span class="n">SEEQ_RCMD_RBMCAST</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">sp</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">=</span> <span class="n">SEEQ_RCMD_RBCAST</span><span class="p">;</span>

	<span class="cm">/* XXX I know this sucks, but is there a better way to reprogram</span>
<span class="cm">	 * XXX the receiver? At least, this shouldn&#39;t happen too often.</span>
<span class="cm">	 */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">oldmode</span> <span class="o">!=</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">)</span>
		<span class="n">sgiseeq_reset</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">setup_tx_ring</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">sgiseeq_tx_desc</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
				 <span class="kt">int</span> <span class="n">nbufs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sgiseeq_private</span> <span class="o">*</span><span class="n">sp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">nbufs</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">tdma</span><span class="p">.</span><span class="n">pnext</span> <span class="o">=</span> <span class="n">VIRT_TO_DMA</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span> <span class="n">buf</span> <span class="o">+</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">tdma</span><span class="p">.</span><span class="n">pbuf</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">dma_sync_desc_dev</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="n">i</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">tdma</span><span class="p">.</span><span class="n">pnext</span> <span class="o">=</span> <span class="n">VIRT_TO_DMA</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
	<span class="n">dma_sync_desc_dev</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">setup_rx_ring</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">sgiseeq_rx_desc</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
				 <span class="kt">int</span> <span class="n">nbufs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sgiseeq_private</span> <span class="o">*</span><span class="n">sp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">nbufs</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rdma</span><span class="p">.</span><span class="n">pnext</span> <span class="o">=</span> <span class="n">VIRT_TO_DMA</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span> <span class="n">buf</span> <span class="o">+</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rdma</span><span class="p">.</span><span class="n">pbuf</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">dma_sync_desc_dev</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="n">i</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rdma</span><span class="p">.</span><span class="n">pbuf</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rdma</span><span class="p">.</span><span class="n">pnext</span> <span class="o">=</span> <span class="n">VIRT_TO_DMA</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
	<span class="n">dma_sync_desc_dev</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">net_device_ops</span> <span class="n">sgiseeq_netdev_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">ndo_open</span>		<span class="o">=</span> <span class="n">sgiseeq_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_stop</span>		<span class="o">=</span> <span class="n">sgiseeq_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_start_xmit</span>		<span class="o">=</span> <span class="n">sgiseeq_start_xmit</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_tx_timeout</span>		<span class="o">=</span> <span class="n">timeout</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_set_rx_mode</span>	<span class="o">=</span> <span class="n">sgiseeq_set_multicast</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_set_mac_address</span>	<span class="o">=</span> <span class="n">sgiseeq_set_mac_address</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_change_mtu</span>		<span class="o">=</span> <span class="n">eth_change_mtu</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_validate_addr</span>	<span class="o">=</span> <span class="n">eth_validate_addr</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">sgiseeq_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sgiseeq_platform_data</span> <span class="o">*</span><span class="n">pd</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">platform_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hpc3_regs</span> <span class="o">*</span><span class="n">hpcregs</span> <span class="o">=</span> <span class="n">pd</span><span class="o">-&gt;</span><span class="n">hpc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sgiseeq_init_block</span> <span class="o">*</span><span class="n">sr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">irq</span> <span class="o">=</span> <span class="n">pd</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sgiseeq_private</span> <span class="o">*</span><span class="n">sp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">dev</span> <span class="o">=</span> <span class="n">alloc_etherdev</span><span class="p">(</span><span class="k">sizeof</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sgiseeq_private</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">platform_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="n">sp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* Make private data page aligned */</span>
	<span class="n">sr</span> <span class="o">=</span> <span class="n">dma_alloc_noncoherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">srings</span><span class="p">),</span>
				<span class="o">&amp;</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">srings_dma</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Sgiseeq: Page alloc failed, aborting.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_out_free_dev</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">sp</span><span class="o">-&gt;</span><span class="n">srings</span> <span class="o">=</span> <span class="n">sr</span><span class="p">;</span>
	<span class="n">sp</span><span class="o">-&gt;</span><span class="n">rx_desc</span> <span class="o">=</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">srings</span><span class="o">-&gt;</span><span class="n">rxvector</span><span class="p">;</span>
	<span class="n">sp</span><span class="o">-&gt;</span><span class="n">tx_desc</span> <span class="o">=</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">srings</span><span class="o">-&gt;</span><span class="n">txvector</span><span class="p">;</span>

	<span class="cm">/* A couple calculations now, saves many cycles later. */</span>
	<span class="n">setup_rx_ring</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">rx_desc</span><span class="p">,</span> <span class="n">SEEQ_RX_BUFFERS</span><span class="p">);</span>
	<span class="n">setup_tx_ring</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">tx_desc</span><span class="p">,</span> <span class="n">SEEQ_TX_BUFFERS</span><span class="p">);</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">pd</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>

<span class="cp">#ifdef DEBUG</span>
	<span class="n">gpriv</span> <span class="o">=</span> <span class="n">sp</span><span class="p">;</span>
	<span class="n">gdev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="n">sp</span><span class="o">-&gt;</span><span class="n">sregs</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sgiseeq_regs</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">hpcregs</span><span class="o">-&gt;</span><span class="n">eth_ext</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">sp</span><span class="o">-&gt;</span><span class="n">hregs</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hpcregs</span><span class="o">-&gt;</span><span class="n">ethregs</span><span class="p">;</span>
	<span class="n">sp</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="n">sgiseeqstr</span><span class="p">;</span>
	<span class="n">sp</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">=</span> <span class="n">SEEQ_RCMD_RBCAST</span><span class="p">;</span>

	<span class="cm">/* Setup PIO and DMA transfer timing */</span>
	<span class="n">sp</span><span class="o">-&gt;</span><span class="n">hregs</span><span class="o">-&gt;</span><span class="n">pconfig</span> <span class="o">=</span> <span class="mh">0x161</span><span class="p">;</span>
	<span class="n">sp</span><span class="o">-&gt;</span><span class="n">hregs</span><span class="o">-&gt;</span><span class="n">dconfig</span> <span class="o">=</span> <span class="n">HPC3_EDCFG_FIRQ</span> <span class="o">|</span> <span class="n">HPC3_EDCFG_FEOP</span> <span class="o">|</span>
			     <span class="n">HPC3_EDCFG_FRXDC</span> <span class="o">|</span> <span class="n">HPC3_EDCFG_PTO</span> <span class="o">|</span> <span class="mh">0x026</span><span class="p">;</span>

	<span class="cm">/* Setup PIO and DMA transfer timing */</span>
	<span class="n">sp</span><span class="o">-&gt;</span><span class="n">hregs</span><span class="o">-&gt;</span><span class="n">pconfig</span> <span class="o">=</span> <span class="mh">0x161</span><span class="p">;</span>
	<span class="n">sp</span><span class="o">-&gt;</span><span class="n">hregs</span><span class="o">-&gt;</span><span class="n">dconfig</span> <span class="o">=</span> <span class="n">HPC3_EDCFG_FIRQ</span> <span class="o">|</span> <span class="n">HPC3_EDCFG_FEOP</span> <span class="o">|</span>
			     <span class="n">HPC3_EDCFG_FRXDC</span> <span class="o">|</span> <span class="n">HPC3_EDCFG_PTO</span> <span class="o">|</span> <span class="mh">0x026</span><span class="p">;</span>

	<span class="cm">/* Reset the chip. */</span>
	<span class="n">hpc3_eth_reset</span><span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">hregs</span><span class="p">);</span>

	<span class="n">sp</span><span class="o">-&gt;</span><span class="n">is_edlc</span> <span class="o">=</span> <span class="o">!</span><span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">sregs</span><span class="o">-&gt;</span><span class="n">rw</span><span class="p">.</span><span class="n">rregs</span><span class="p">.</span><span class="n">collision_tx</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">is_edlc</span><span class="p">)</span>
		<span class="n">sp</span><span class="o">-&gt;</span><span class="n">control</span> <span class="o">=</span> <span class="n">SEEQ_CTRL_XCNT</span> <span class="o">|</span> <span class="n">SEEQ_CTRL_ACCNT</span> <span class="o">|</span>
			      <span class="n">SEEQ_CTRL_SFLAG</span> <span class="o">|</span> <span class="n">SEEQ_CTRL_ESHORT</span> <span class="o">|</span>
			      <span class="n">SEEQ_CTRL_ENCARR</span><span class="p">;</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">netdev_ops</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">sgiseeq_netdev_ops</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">watchdog_timeo</span>	<span class="o">=</span> <span class="p">(</span><span class="mi">200</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">)</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span>		<span class="o">=</span> <span class="n">irq</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">register_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Sgiseeq: Cannot register net device, &quot;</span>
		       <span class="s">&quot;aborting.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_out_free_page</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: %s %pM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">sgiseeqstr</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_out_free_page:</span>
	<span class="n">free_page</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">srings</span><span class="p">);</span>
<span class="nl">err_out_free_dev:</span>
	<span class="n">free_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

<span class="nl">err_out:</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__exit</span> <span class="nf">sgiseeq_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">platform_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sgiseeq_private</span> <span class="o">*</span><span class="n">sp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">unregister_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">dma_free_noncoherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">srings</span><span class="p">),</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">srings</span><span class="p">,</span>
			     <span class="n">sp</span><span class="o">-&gt;</span><span class="n">srings_dma</span><span class="p">);</span>
	<span class="n">free_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">platform_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_driver</span> <span class="n">sgiseeq_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">probe</span>	<span class="o">=</span> <span class="n">sgiseeq_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>	<span class="o">=</span> <span class="n">__exit_p</span><span class="p">(</span><span class="n">sgiseeq_remove</span><span class="p">),</span>
	<span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="s">&quot;sgiseeq&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">owner</span>	<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">}</span>
<span class="p">};</span>

<span class="n">module_platform_driver</span><span class="p">(</span><span class="n">sgiseeq_driver</span><span class="p">);</span>

<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;SGI Seeq 8003 driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Linux/MIPS Mailing List &lt;linux-mips@linux-mips.org&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_ALIAS</span><span class="p">(</span><span class="s">&quot;platform:sgiseeq&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
