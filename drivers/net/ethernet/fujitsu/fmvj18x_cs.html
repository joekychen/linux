<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › ethernet › fujitsu › fmvj18x_cs.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>fmvj18x_cs.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*======================================================================</span>
<span class="cm">    fmvj18x_cs.c 2.8 2002/03/23</span>

<span class="cm">    A fmvj18x (and its compatibles) PCMCIA client driver</span>

<span class="cm">    Contributed by Shingo Fujimoto, shingo@flab.fujitsu.co.jp</span>

<span class="cm">    TDK LAK-CD021 and CONTEC C-NET(PC)C support added by </span>
<span class="cm">    Nobuhiro Katayama, kata-n@po.iijnet.or.jp</span>

<span class="cm">    The PCMCIA client code is based on code written by David Hinds.</span>
<span class="cm">    Network code is based on the &quot;FMV-18x driver&quot; by Yutaka TAMIYA</span>
<span class="cm">    but is actually largely Donald Becker&#39;s AT1700 driver, which</span>
<span class="cm">    carries the following attribution:</span>

<span class="cm">    Written 1993-94 by Donald Becker.</span>

<span class="cm">    Copyright 1993 United States Government as represented by the</span>
<span class="cm">    Director, National Security Agency.</span>
<span class="cm">    </span>
<span class="cm">    This software may be used and distributed according to the terms</span>
<span class="cm">    of the GNU General Public License, incorporated herein by reference.</span>
<span class="cm">    </span>
<span class="cm">    The author may be reached as becker@scyld.com, or C/O</span>
<span class="cm">    Scyld Computing Corporation</span>
<span class="cm">    410 Severn Ave., Suite 210</span>
<span class="cm">    Annapolis MD 21403</span>
<span class="cm">   </span>
<span class="cm">======================================================================*/</span>

<span class="cp">#define pr_fmt(fmt) KBUILD_MODNAME &quot;: &quot; fmt</span>

<span class="cp">#define DRV_NAME	&quot;fmvj18x_cs&quot;</span>
<span class="cp">#define DRV_VERSION	&quot;2.9&quot;</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/ptrace.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/timer.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/in.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/ethtool.h&gt;</span>
<span class="cp">#include &lt;linux/netdevice.h&gt;</span>
<span class="cp">#include &lt;linux/etherdevice.h&gt;</span>
<span class="cp">#include &lt;linux/skbuff.h&gt;</span>
<span class="cp">#include &lt;linux/if_arp.h&gt;</span>
<span class="cp">#include &lt;linux/ioport.h&gt;</span>
<span class="cp">#include &lt;linux/crc32.h&gt;</span>

<span class="cp">#include &lt;pcmcia/cistpl.h&gt;</span>
<span class="cp">#include &lt;pcmcia/ciscode.h&gt;</span>
<span class="cp">#include &lt;pcmcia/ds.h&gt;</span>

<span class="cp">#include &lt;asm/uaccess.h&gt;</span>
<span class="cp">#include &lt;asm/io.h&gt;</span>

<span class="cm">/*====================================================================*/</span>

<span class="cm">/* Module parameters */</span>

<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;fmvj18x and compatible PCMCIA ethernet driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

<span class="cp">#define INT_MODULE_PARM(n, v) static int n = v; module_param(n, int, 0)</span>

<span class="cm">/* SRAM configuration */</span>
<span class="cm">/* 0:4KB*2 TX buffer   else:8KB*2 TX buffer */</span>
<span class="n">INT_MODULE_PARM</span><span class="p">(</span><span class="n">sram_config</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>


<span class="cm">/*====================================================================*/</span>
<span class="cm">/*</span>
<span class="cm">    PCMCIA event handlers</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">fmvj18x_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">pcmcia_device</span> <span class="o">*</span><span class="n">link</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">fmvj18x_get_hwinfo</span><span class="p">(</span><span class="k">struct</span> <span class="n">pcmcia_device</span> <span class="o">*</span><span class="n">link</span><span class="p">,</span> <span class="n">u_char</span> <span class="o">*</span><span class="n">node_id</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">fmvj18x_setup_mfc</span><span class="p">(</span><span class="k">struct</span> <span class="n">pcmcia_device</span> <span class="o">*</span><span class="n">link</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">fmvj18x_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">pcmcia_device</span> <span class="o">*</span><span class="n">link</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">fmvj18x_detach</span><span class="p">(</span><span class="k">struct</span> <span class="n">pcmcia_device</span> <span class="o">*</span><span class="n">p_dev</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm">    LAN controller(MBH86960A) specific routines</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">fjn_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ifmap</span> <span class="o">*</span><span class="n">map</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">fjn_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">fjn_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="n">netdev_tx_t</span> <span class="n">fjn_start_xmit</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="n">fjn_interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">fjn_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">fjn_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">set_rx_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">fjn_tx_timeout</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ethtool_ops</span> <span class="n">netdev_ethtool_ops</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm">    card type</span>
<span class="cm"> */</span>
<span class="k">typedef</span> <span class="k">enum</span> <span class="p">{</span> <span class="n">MBH10302</span><span class="p">,</span> <span class="n">MBH10304</span><span class="p">,</span> <span class="n">TDK</span><span class="p">,</span> <span class="n">CONTEC</span><span class="p">,</span> <span class="n">LA501</span><span class="p">,</span> <span class="n">UNGERMANN</span><span class="p">,</span> 
	       <span class="n">XXX10304</span><span class="p">,</span> <span class="n">NEC</span><span class="p">,</span> <span class="n">KME</span>
<span class="p">}</span> <span class="n">cardtype_t</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm">    driver specific data structure</span>
<span class="cm">*/</span>
<span class="k">typedef</span> <span class="k">struct</span> <span class="n">local_info_t</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">pcmcia_device</span>	<span class="o">*</span><span class="n">p_dev</span><span class="p">;</span>
    <span class="kt">long</span> <span class="n">open_time</span><span class="p">;</span>
    <span class="n">uint</span> <span class="n">tx_started</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
    <span class="n">uint</span> <span class="n">tx_queue</span><span class="p">;</span>
    <span class="n">u_short</span> <span class="n">tx_queue_len</span><span class="p">;</span>
    <span class="n">cardtype_t</span> <span class="n">cardtype</span><span class="p">;</span>
    <span class="n">u_short</span> <span class="n">sent</span><span class="p">;</span>
    <span class="n">u_char</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">base</span><span class="p">;</span>
<span class="p">}</span> <span class="n">local_info_t</span><span class="p">;</span>

<span class="cp">#define MC_FILTERBREAK 64</span>

<span class="cm">/*====================================================================*/</span>
<span class="cm">/* </span>
<span class="cm">    ioport offset from the base address </span>
<span class="cm"> */</span>
<span class="cp">#define TX_STATUS               0 </span><span class="cm">/* transmit status register */</span><span class="cp"></span>
<span class="cp">#define RX_STATUS               1 </span><span class="cm">/* receive status register */</span><span class="cp"></span>
<span class="cp">#define TX_INTR                 2 </span><span class="cm">/* transmit interrupt mask register */</span><span class="cp"></span>
<span class="cp">#define RX_INTR                 3 </span><span class="cm">/* receive interrupt mask register */</span><span class="cp"></span>
<span class="cp">#define TX_MODE                 4 </span><span class="cm">/* transmit mode register */</span><span class="cp"></span>
<span class="cp">#define RX_MODE                 5 </span><span class="cm">/* receive mode register */</span><span class="cp"></span>
<span class="cp">#define CONFIG_0                6 </span><span class="cm">/* configuration register 0 */</span><span class="cp"></span>
<span class="cp">#define CONFIG_1                7 </span><span class="cm">/* configuration register 1 */</span><span class="cp"></span>

<span class="cp">#define NODE_ID                 8 </span><span class="cm">/* node ID register            (bank 0) */</span><span class="cp"></span>
<span class="cp">#define MAR_ADR                 8 </span><span class="cm">/* multicast address registers (bank 1) */</span><span class="cp"></span>

<span class="cp">#define DATAPORT                8 </span><span class="cm">/* buffer mem port registers   (bank 2) */</span><span class="cp"></span>
<span class="cp">#define TX_START               10 </span><span class="cm">/* transmit start register */</span><span class="cp"></span>
<span class="cp">#define COL_CTRL               11 </span><span class="cm">/* 16 collision control register */</span><span class="cp"></span>
<span class="cp">#define BMPR12                 12 </span><span class="cm">/* reserved */</span><span class="cp"></span>
<span class="cp">#define BMPR13                 13 </span><span class="cm">/* reserved */</span><span class="cp"></span>
<span class="cp">#define RX_SKIP                14 </span><span class="cm">/* skip received packet register */</span><span class="cp"></span>

<span class="cp">#define LAN_CTRL               16 </span><span class="cm">/* LAN card control register */</span><span class="cp"></span>

<span class="cp">#define MAC_ID               0x1a </span><span class="cm">/* hardware address */</span><span class="cp"></span>
<span class="cp">#define UNGERMANN_MAC_ID     0x18 </span><span class="cm">/* UNGERMANN-BASS hardware address */</span><span class="cp"></span>

<span class="cm">/* </span>
<span class="cm">    control bits </span>
<span class="cm"> */</span>
<span class="cp">#define ENA_TMT_OK           0x80</span>
<span class="cp">#define ENA_TMT_REC          0x20</span>
<span class="cp">#define ENA_COL              0x04</span>
<span class="cp">#define ENA_16_COL           0x02</span>
<span class="cp">#define ENA_TBUS_ERR         0x01</span>

<span class="cp">#define ENA_PKT_RDY          0x80</span>
<span class="cp">#define ENA_BUS_ERR          0x40</span>
<span class="cp">#define ENA_LEN_ERR          0x08</span>
<span class="cp">#define ENA_ALG_ERR          0x04</span>
<span class="cp">#define ENA_CRC_ERR          0x02</span>
<span class="cp">#define ENA_OVR_FLO          0x01</span>

<span class="cm">/* flags */</span>
<span class="cp">#define F_TMT_RDY            0x80 </span><span class="cm">/* can accept new packet */</span><span class="cp"></span>
<span class="cp">#define F_NET_BSY            0x40 </span><span class="cm">/* carrier is detected */</span><span class="cp"></span>
<span class="cp">#define F_TMT_OK             0x20 </span><span class="cm">/* send packet successfully */</span><span class="cp"></span>
<span class="cp">#define F_SRT_PKT            0x10 </span><span class="cm">/* short packet error */</span><span class="cp"></span>
<span class="cp">#define F_COL_ERR            0x04 </span><span class="cm">/* collision error */</span><span class="cp"></span>
<span class="cp">#define F_16_COL             0x02 </span><span class="cm">/* 16 collision error */</span><span class="cp"></span>
<span class="cp">#define F_TBUS_ERR           0x01 </span><span class="cm">/* bus read error */</span><span class="cp"></span>

<span class="cp">#define F_PKT_RDY            0x80 </span><span class="cm">/* packet(s) in buffer */</span><span class="cp"></span>
<span class="cp">#define F_BUS_ERR            0x40 </span><span class="cm">/* bus read error */</span><span class="cp"></span>
<span class="cp">#define F_LEN_ERR            0x08 </span><span class="cm">/* short packet */</span><span class="cp"></span>
<span class="cp">#define F_ALG_ERR            0x04 </span><span class="cm">/* frame error */</span><span class="cp"></span>
<span class="cp">#define F_CRC_ERR            0x02 </span><span class="cm">/* CRC error */</span><span class="cp"></span>
<span class="cp">#define F_OVR_FLO            0x01 </span><span class="cm">/* overflow error */</span><span class="cp"></span>

<span class="cp">#define F_BUF_EMP            0x40 </span><span class="cm">/* receive buffer is empty */</span><span class="cp"></span>

<span class="cp">#define F_SKP_PKT            0x05 </span><span class="cm">/* drop packet in buffer */</span><span class="cp"></span>

<span class="cm">/* default bitmaps */</span>
<span class="cp">#define D_TX_INTR  ( ENA_TMT_OK )</span>
<span class="cp">#define D_RX_INTR  ( ENA_PKT_RDY | ENA_LEN_ERR \</span>
<span class="cp">		   | ENA_ALG_ERR | ENA_CRC_ERR | ENA_OVR_FLO )</span>
<span class="cp">#define TX_STAT_M  ( F_TMT_RDY )</span>
<span class="cp">#define RX_STAT_M  ( F_PKT_RDY | F_LEN_ERR \</span>
<span class="cp">                   | F_ALG_ERR | F_CRC_ERR | F_OVR_FLO )</span>

<span class="cm">/* commands */</span>
<span class="cp">#define D_TX_MODE            0x06 </span><span class="cm">/* no tests, detect carrier */</span><span class="cp"></span>
<span class="cp">#define ID_MATCHED           0x02 </span><span class="cm">/* (RX_MODE) */</span><span class="cp"></span>
<span class="cp">#define RECV_ALL             0x03 </span><span class="cm">/* (RX_MODE) */</span><span class="cp"></span>
<span class="cp">#define CONFIG0_DFL          0x5a </span><span class="cm">/* 16bit bus, 4K x 2 Tx queues */</span><span class="cp"></span>
<span class="cp">#define CONFIG0_DFL_1        0x5e </span><span class="cm">/* 16bit bus, 8K x 2 Tx queues */</span><span class="cp"></span>
<span class="cp">#define CONFIG0_RST          0xda </span><span class="cm">/* Data Link Controller off (CONFIG_0) */</span><span class="cp"></span>
<span class="cp">#define CONFIG0_RST_1        0xde </span><span class="cm">/* Data Link Controller off (CONFIG_0) */</span><span class="cp"></span>
<span class="cp">#define BANK_0               0xa0 </span><span class="cm">/* bank 0 (CONFIG_1) */</span><span class="cp"></span>
<span class="cp">#define BANK_1               0xa4 </span><span class="cm">/* bank 1 (CONFIG_1) */</span><span class="cp"></span>
<span class="cp">#define BANK_2               0xa8 </span><span class="cm">/* bank 2 (CONFIG_1) */</span><span class="cp"></span>
<span class="cp">#define CHIP_OFF             0x80 </span><span class="cm">/* contrl chip power off (CONFIG_1) */</span><span class="cp"></span>
<span class="cp">#define DO_TX                0x80 </span><span class="cm">/* do transmit packet */</span><span class="cp"></span>
<span class="cp">#define SEND_PKT             0x81 </span><span class="cm">/* send a packet */</span><span class="cp"></span>
<span class="cp">#define AUTO_MODE            0x07 </span><span class="cm">/* Auto skip packet on 16 col detected */</span><span class="cp"></span>
<span class="cp">#define MANU_MODE            0x03 </span><span class="cm">/* Stop and skip packet on 16 col */</span><span class="cp"></span>
<span class="cp">#define TDK_AUTO_MODE        0x47 </span><span class="cm">/* Auto skip packet on 16 col detected */</span><span class="cp"></span>
<span class="cp">#define TDK_MANU_MODE        0x43 </span><span class="cm">/* Stop and skip packet on 16 col */</span><span class="cp"></span>
<span class="cp">#define INTR_OFF             0x0d </span><span class="cm">/* LAN controller ignores interrupts */</span><span class="cp"></span>
<span class="cp">#define INTR_ON              0x1d </span><span class="cm">/* LAN controller will catch interrupts */</span><span class="cp"></span>

<span class="cp">#define TX_TIMEOUT		((400*HZ)/1000)</span>

<span class="cp">#define BANK_0U              0x20 </span><span class="cm">/* bank 0 (CONFIG_1) */</span><span class="cp"></span>
<span class="cp">#define BANK_1U              0x24 </span><span class="cm">/* bank 1 (CONFIG_1) */</span><span class="cp"></span>
<span class="cp">#define BANK_2U              0x28 </span><span class="cm">/* bank 2 (CONFIG_1) */</span><span class="cp"></span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">net_device_ops</span> <span class="n">fjn_netdev_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">ndo_open</span> 		<span class="o">=</span> <span class="n">fjn_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_stop</span>		<span class="o">=</span> <span class="n">fjn_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_start_xmit</span> 	<span class="o">=</span> <span class="n">fjn_start_xmit</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_tx_timeout</span> 	<span class="o">=</span> <span class="n">fjn_tx_timeout</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_set_config</span> 	<span class="o">=</span> <span class="n">fjn_config</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_set_rx_mode</span>	<span class="o">=</span> <span class="n">set_rx_mode</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_change_mtu</span>		<span class="o">=</span> <span class="n">eth_change_mtu</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_set_mac_address</span> 	<span class="o">=</span> <span class="n">eth_mac_addr</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_validate_addr</span>	<span class="o">=</span> <span class="n">eth_validate_addr</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">fmvj18x_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">pcmcia_device</span> <span class="o">*</span><span class="n">link</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">local_info_t</span> <span class="o">*</span><span class="n">lp</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>

    <span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;fmvj18x_attach()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

    <span class="cm">/* Make up a FMVJ18x specific data structure */</span>
    <span class="n">dev</span> <span class="o">=</span> <span class="n">alloc_etherdev</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">local_info_t</span><span class="p">));</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="p">)</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
    <span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
    <span class="n">link</span><span class="o">-&gt;</span><span class="n">priv</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
    <span class="n">lp</span><span class="o">-&gt;</span><span class="n">p_dev</span> <span class="o">=</span> <span class="n">link</span><span class="p">;</span>
    <span class="n">lp</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

    <span class="cm">/* The io structure describes IO port mapping */</span>
    <span class="n">link</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">end</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>
    <span class="n">link</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">IO_DATA_PATH_WIDTH_AUTO</span><span class="p">;</span>

    <span class="cm">/* General socket configuration */</span>
    <span class="n">link</span><span class="o">-&gt;</span><span class="n">config_flags</span> <span class="o">|=</span> <span class="n">CONF_ENABLE_IRQ</span><span class="p">;</span>

    <span class="n">dev</span><span class="o">-&gt;</span><span class="n">netdev_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fjn_netdev_ops</span><span class="p">;</span>
    <span class="n">dev</span><span class="o">-&gt;</span><span class="n">watchdog_timeo</span> <span class="o">=</span> <span class="n">TX_TIMEOUT</span><span class="p">;</span>

    <span class="n">SET_ETHTOOL_OPS</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">netdev_ethtool_ops</span><span class="p">);</span>

    <span class="k">return</span> <span class="n">fmvj18x_config</span><span class="p">(</span><span class="n">link</span><span class="p">);</span>
<span class="p">}</span> <span class="cm">/* fmvj18x_attach */</span>

<span class="cm">/*====================================================================*/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">fmvj18x_detach</span><span class="p">(</span><span class="k">struct</span> <span class="n">pcmcia_device</span> <span class="o">*</span><span class="n">link</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">link</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>

    <span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;fmvj18x_detach</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

    <span class="n">unregister_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

    <span class="n">fmvj18x_release</span><span class="p">(</span><span class="n">link</span><span class="p">);</span>

    <span class="n">free_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span> <span class="cm">/* fmvj18x_detach */</span>

<span class="cm">/*====================================================================*/</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mfc_try_io_port</span><span class="p">(</span><span class="k">struct</span> <span class="n">pcmcia_device</span> <span class="o">*</span><span class="n">link</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>
    <span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">serial_base</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span>
	<span class="p">{</span> <span class="mh">0x3f8</span><span class="p">,</span> <span class="mh">0x2f8</span><span class="p">,</span> <span class="mh">0x3e8</span><span class="p">,</span> <span class="mh">0x2e8</span><span class="p">,</span> <span class="mh">0x0</span> <span class="p">};</span>

    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">link</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">=</span> <span class="n">serial_base</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
	<span class="n">link</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">IO_DATA_PATH_WIDTH_8</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
	    <span class="n">link</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">end</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	    <span class="n">pr_notice</span><span class="p">(</span><span class="s">&quot;out of resource for serial</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">pcmcia_request_io</span><span class="p">(</span><span class="n">link</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ungermann_try_io_port</span><span class="p">(</span><span class="k">struct</span> <span class="n">pcmcia_device</span> <span class="o">*</span><span class="n">link</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ioaddr</span><span class="p">;</span>
    <span class="cm">/*</span>
<span class="cm">	Ungermann-Bass Access/CARD accepts 0x300,0x320,0x340,0x360</span>
<span class="cm">	0x380,0x3c0 only for ioport.</span>
<span class="cm">    */</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">ioaddr</span> <span class="o">=</span> <span class="mh">0x300</span><span class="p">;</span> <span class="n">ioaddr</span> <span class="o">&lt;</span> <span class="mh">0x3e0</span><span class="p">;</span> <span class="n">ioaddr</span> <span class="o">+=</span> <span class="mh">0x20</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">link</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">=</span> <span class="n">ioaddr</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">pcmcia_request_io</span><span class="p">(</span><span class="n">link</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
	    <span class="cm">/* calculate ConfigIndex value */</span>
	    <span class="n">link</span><span class="o">-&gt;</span><span class="n">config_index</span> <span class="o">=</span>
		<span class="p">((</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">&amp;</span> <span class="mh">0x0f0</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x22</span><span class="p">;</span>
	    <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>	<span class="cm">/* RequestIO failed */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">fmvj18x_ioprobe</span><span class="p">(</span><span class="k">struct</span> <span class="n">pcmcia_device</span> <span class="o">*</span><span class="n">p_dev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv_data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* strange, but that&#39;s what the code did already before... */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">fmvj18x_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">pcmcia_device</span> <span class="o">*</span><span class="n">link</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">link</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
    <span class="n">local_info_t</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
    <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ioaddr</span><span class="p">;</span>
    <span class="n">cardtype_t</span> <span class="n">cardtype</span><span class="p">;</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">card_name</span> <span class="o">=</span> <span class="s">&quot;unknown&quot;</span><span class="p">;</span>
    <span class="n">u8</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>
    <span class="kt">size_t</span> <span class="n">len</span><span class="p">;</span>
    <span class="n">u_char</span> <span class="n">buggybuf</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>

    <span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;fmvj18x_config</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

    <span class="n">link</span><span class="o">-&gt;</span><span class="n">io_lines</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>

    <span class="n">len</span> <span class="o">=</span> <span class="n">pcmcia_get_tuple</span><span class="p">(</span><span class="n">link</span><span class="p">,</span> <span class="n">CISTPL_FUNCE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buf</span><span class="p">);</span>
    <span class="n">kfree</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">len</span><span class="p">)</span> <span class="p">{</span>
	<span class="cm">/* Yes, I have CISTPL_FUNCE. Let&#39;s check CISTPL_MANFID */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">pcmcia_loop_config</span><span class="p">(</span><span class="n">link</span><span class="p">,</span> <span class="n">fmvj18x_ioprobe</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">failed</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">manf_id</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">MANFID_TDK</span>:
	    <span class="n">cardtype</span> <span class="o">=</span> <span class="n">TDK</span><span class="p">;</span>
	    <span class="k">if</span> <span class="p">(</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">card_id</span> <span class="o">==</span> <span class="n">PRODID_TDK_GN3410</span> <span class="o">||</span>
		<span class="n">link</span><span class="o">-&gt;</span><span class="n">card_id</span> <span class="o">==</span> <span class="n">PRODID_TDK_NP9610</span> <span class="o">||</span>
		<span class="n">link</span><span class="o">-&gt;</span><span class="n">card_id</span> <span class="o">==</span> <span class="n">PRODID_TDK_MN3200</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* MultiFunction Card */</span>
		<span class="n">link</span><span class="o">-&gt;</span><span class="n">config_base</span> <span class="o">=</span> <span class="mh">0x800</span><span class="p">;</span>
		<span class="n">link</span><span class="o">-&gt;</span><span class="n">config_index</span> <span class="o">=</span> <span class="mh">0x47</span><span class="p">;</span>
		<span class="n">link</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">end</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
	    <span class="p">}</span>
	    <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MANFID_NEC</span>:
	    <span class="n">cardtype</span> <span class="o">=</span> <span class="n">NEC</span><span class="p">;</span> <span class="cm">/* MultiFunction Card */</span>
	    <span class="n">link</span><span class="o">-&gt;</span><span class="n">config_base</span> <span class="o">=</span> <span class="mh">0x800</span><span class="p">;</span>
	    <span class="n">link</span><span class="o">-&gt;</span><span class="n">config_index</span> <span class="o">=</span> <span class="mh">0x47</span><span class="p">;</span>
	    <span class="n">link</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">end</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
	    <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MANFID_KME</span>:
	    <span class="n">cardtype</span> <span class="o">=</span> <span class="n">KME</span><span class="p">;</span> <span class="cm">/* MultiFunction Card */</span>
	    <span class="n">link</span><span class="o">-&gt;</span><span class="n">config_base</span> <span class="o">=</span> <span class="mh">0x800</span><span class="p">;</span>
	    <span class="n">link</span><span class="o">-&gt;</span><span class="n">config_index</span> <span class="o">=</span> <span class="mh">0x47</span><span class="p">;</span>
	    <span class="n">link</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">end</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
	    <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MANFID_CONTEC</span>:
	    <span class="n">cardtype</span> <span class="o">=</span> <span class="n">CONTEC</span><span class="p">;</span>
	    <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MANFID_FUJITSU</span>:
	    <span class="k">if</span> <span class="p">(</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">config_base</span> <span class="o">==</span> <span class="mh">0x0fe0</span><span class="p">)</span>
		<span class="n">cardtype</span> <span class="o">=</span> <span class="n">MBH10302</span><span class="p">;</span>
	    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">card_id</span> <span class="o">==</span> <span class="n">PRODID_FUJITSU_MBH10302</span><span class="p">)</span> 
                <span class="cm">/* RATOC REX-5588/9822/4886&#39;s PRODID are 0004(=MBH10302),</span>
<span class="cm">                   but these are MBH10304 based card. */</span> 
		<span class="n">cardtype</span> <span class="o">=</span> <span class="n">MBH10304</span><span class="p">;</span>
	    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">card_id</span> <span class="o">==</span> <span class="n">PRODID_FUJITSU_MBH10304</span><span class="p">)</span>
		<span class="n">cardtype</span> <span class="o">=</span> <span class="n">MBH10304</span><span class="p">;</span>
	    <span class="k">else</span>
		<span class="n">cardtype</span> <span class="o">=</span> <span class="n">LA501</span><span class="p">;</span>
	    <span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
	    <span class="n">cardtype</span> <span class="o">=</span> <span class="n">MBH10304</span><span class="p">;</span>
	<span class="p">}</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	<span class="cm">/* old type card */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">manf_id</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">MANFID_FUJITSU</span>:
	    <span class="k">if</span> <span class="p">(</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">card_id</span> <span class="o">==</span> <span class="n">PRODID_FUJITSU_MBH10304</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cardtype</span> <span class="o">=</span> <span class="n">XXX10304</span><span class="p">;</span>    <span class="cm">/* MBH10304 with buggy CIS */</span>
		<span class="n">link</span><span class="o">-&gt;</span><span class="n">config_index</span> <span class="o">=</span> <span class="mh">0x20</span><span class="p">;</span>
	    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">cardtype</span> <span class="o">=</span> <span class="n">MBH10302</span><span class="p">;</span>    <span class="cm">/* NextCom NC5310, etc. */</span>
		<span class="n">link</span><span class="o">-&gt;</span><span class="n">config_index</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	    <span class="p">}</span>
	    <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MANFID_UNGERMANN</span>:
	    <span class="n">cardtype</span> <span class="o">=</span> <span class="n">UNGERMANN</span><span class="p">;</span>
	    <span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
	    <span class="n">cardtype</span> <span class="o">=</span> <span class="n">MBH10302</span><span class="p">;</span>
	    <span class="n">link</span><span class="o">-&gt;</span><span class="n">config_index</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">end</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">mfc_try_io_port</span><span class="p">(</span><span class="n">link</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="k">goto</span> <span class="n">failed</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cardtype</span> <span class="o">==</span> <span class="n">UNGERMANN</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">ungermann_try_io_port</span><span class="p">(</span><span class="n">link</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="k">goto</span> <span class="n">failed</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span> 
	    <span class="n">ret</span> <span class="o">=</span> <span class="n">pcmcia_request_io</span><span class="p">(</span><span class="n">link</span><span class="p">);</span>
	    <span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		    <span class="k">goto</span> <span class="n">failed</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="n">pcmcia_request_irq</span><span class="p">(</span><span class="n">link</span><span class="p">,</span> <span class="n">fjn_interrupt</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
	    <span class="k">goto</span> <span class="n">failed</span><span class="p">;</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="n">pcmcia_enable_device</span><span class="p">(</span><span class="n">link</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
	    <span class="k">goto</span> <span class="n">failed</span><span class="p">;</span>

    <span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">link</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>
    <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">=</span> <span class="n">link</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">resource_size</span><span class="p">(</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">fmvj18x_setup_mfc</span><span class="p">(</span><span class="n">link</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="k">goto</span> <span class="n">failed</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">ioaddr</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>

    <span class="cm">/* Reset controller */</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">sram_config</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> 
	<span class="n">outb</span><span class="p">(</span><span class="n">CONFIG0_RST</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">CONFIG_0</span><span class="p">);</span>
    <span class="k">else</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">CONFIG0_RST_1</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">CONFIG_0</span><span class="p">);</span>

    <span class="cm">/* Power On chip and select bank 0 */</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">cardtype</span> <span class="o">==</span> <span class="n">MBH10302</span><span class="p">)</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">BANK_0</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">CONFIG_1</span><span class="p">);</span>
    <span class="k">else</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">BANK_0U</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">CONFIG_1</span><span class="p">);</span>
    
    <span class="cm">/* Set hardware address */</span>
    <span class="k">switch</span> <span class="p">(</span><span class="n">cardtype</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">case</span> <span class="n">MBH10304</span>:
    <span class="k">case</span> <span class="n">TDK</span>:
    <span class="k">case</span> <span class="n">LA501</span>:
    <span class="k">case</span> <span class="n">CONTEC</span>:
    <span class="k">case</span> <span class="n">NEC</span>:
    <span class="k">case</span> <span class="n">KME</span>:
	<span class="k">if</span> <span class="p">(</span><span class="n">cardtype</span> <span class="o">==</span> <span class="n">MBH10304</span><span class="p">)</span> <span class="p">{</span>
	    <span class="n">card_name</span> <span class="o">=</span> <span class="s">&quot;FMV-J182&quot;</span><span class="p">;</span>

	    <span class="n">len</span> <span class="o">=</span> <span class="n">pcmcia_get_tuple</span><span class="p">(</span><span class="n">link</span><span class="p">,</span> <span class="n">CISTPL_FUNCE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buf</span><span class="p">);</span>
	    <span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="mi">11</span><span class="p">)</span> <span class="p">{</span>
		    <span class="n">kfree</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
		    <span class="k">goto</span> <span class="n">failed</span><span class="p">;</span>
	    <span class="p">}</span>
	    <span class="cm">/* Read MACID from CIS */</span>
	    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">11</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		    <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
	    <span class="n">kfree</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	    <span class="k">if</span> <span class="p">(</span><span class="n">pcmcia_get_mac_from_cis</span><span class="p">(</span><span class="n">link</span><span class="p">,</span> <span class="n">dev</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">failed</span><span class="p">;</span>
	    <span class="k">if</span><span class="p">(</span> <span class="n">cardtype</span> <span class="o">==</span> <span class="n">TDK</span> <span class="p">)</span> <span class="p">{</span>
		<span class="n">card_name</span> <span class="o">=</span> <span class="s">&quot;TDK LAK-CD021&quot;</span><span class="p">;</span>
	    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span> <span class="n">cardtype</span> <span class="o">==</span> <span class="n">LA501</span> <span class="p">)</span> <span class="p">{</span>
		<span class="n">card_name</span> <span class="o">=</span> <span class="s">&quot;LA501&quot;</span><span class="p">;</span>
	    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span> <span class="n">cardtype</span> <span class="o">==</span> <span class="n">NEC</span> <span class="p">)</span> <span class="p">{</span>
		<span class="n">card_name</span> <span class="o">=</span> <span class="s">&quot;PK-UG-J001&quot;</span><span class="p">;</span>
	    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span> <span class="n">cardtype</span> <span class="o">==</span> <span class="n">KME</span> <span class="p">)</span> <span class="p">{</span>
		<span class="n">card_name</span> <span class="o">=</span> <span class="s">&quot;Panasonic&quot;</span><span class="p">;</span>
	    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">card_name</span> <span class="o">=</span> <span class="s">&quot;C-NET(PC)C&quot;</span><span class="p">;</span>
	    <span class="p">}</span>
	<span class="p">}</span>
	<span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">UNGERMANN</span>:
	<span class="cm">/* Read MACID from register */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> 
	    <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">UNGERMANN_MAC_ID</span> <span class="o">+</span> <span class="n">i</span><span class="p">);</span>
	<span class="n">card_name</span> <span class="o">=</span> <span class="s">&quot;Access/CARD&quot;</span><span class="p">;</span>
	<span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">XXX10304</span>:
	<span class="cm">/* Read MACID from Buggy CIS */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fmvj18x_get_hwinfo</span><span class="p">(</span><span class="n">link</span><span class="p">,</span> <span class="n">buggybuf</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
	    <span class="n">pr_notice</span><span class="p">(</span><span class="s">&quot;unable to read hardware net address</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	    <span class="k">goto</span> <span class="n">failed</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
	    <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">buggybuf</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
	<span class="p">}</span>
	<span class="n">card_name</span> <span class="o">=</span> <span class="s">&quot;FMV-J182&quot;</span><span class="p">;</span>
	<span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">MBH10302</span>:
    <span class="nl">default:</span>
	<span class="cm">/* Read MACID from register */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> 
	    <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">MAC_ID</span> <span class="o">+</span> <span class="n">i</span><span class="p">);</span>
	<span class="n">card_name</span> <span class="o">=</span> <span class="s">&quot;FMV-J181&quot;</span><span class="p">;</span>
	<span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">lp</span><span class="o">-&gt;</span><span class="n">cardtype</span> <span class="o">=</span> <span class="n">cardtype</span><span class="p">;</span>
    <span class="n">SET_NETDEV_DEV</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">register_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">pr_notice</span><span class="p">(</span><span class="s">&quot;register_netdev() failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">goto</span> <span class="n">failed</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="cm">/* print current configuration */</span>
    <span class="n">netdev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s, sram %s, port %#3lx, irq %d, hw_addr %pM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">card_name</span><span class="p">,</span> <span class="n">sram_config</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">?</span> <span class="s">&quot;4K TX*2&quot;</span> <span class="o">:</span> <span class="s">&quot;8K TX*2&quot;</span><span class="p">,</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">);</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
    
<span class="nl">failed:</span>
    <span class="n">fmvj18x_release</span><span class="p">(</span><span class="n">link</span><span class="p">);</span>
    <span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
<span class="p">}</span> <span class="cm">/* fmvj18x_config */</span>
<span class="cm">/*====================================================================*/</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">fmvj18x_get_hwinfo</span><span class="p">(</span><span class="k">struct</span> <span class="n">pcmcia_device</span> <span class="o">*</span><span class="n">link</span><span class="p">,</span> <span class="n">u_char</span> <span class="o">*</span><span class="n">node_id</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">u_char</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">base</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>

    <span class="cm">/* Allocate a small memory window */</span>
    <span class="n">link</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">WIN_DATA_WIDTH_8</span><span class="o">|</span><span class="n">WIN_MEMORY_TYPE_AM</span><span class="o">|</span><span class="n">WIN_ENABLE</span><span class="p">;</span>
    <span class="n">link</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">link</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">end</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">i</span> <span class="o">=</span> <span class="n">pcmcia_request_window</span><span class="p">(</span><span class="n">link</span><span class="p">,</span> <span class="n">link</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="mi">0</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

    <span class="n">base</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="n">resource_size</span><span class="p">(</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">2</span><span class="p">]));</span>
    <span class="n">pcmcia_map_mem_page</span><span class="p">(</span><span class="n">link</span><span class="p">,</span> <span class="n">link</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="mi">0</span><span class="p">);</span>

    <span class="cm">/*</span>
<span class="cm">     *  MBH10304 CISTPL_FUNCE_LAN_NODE_ID format</span>
<span class="cm">     *  22 0d xx xx xx 04 06 yy yy yy yy yy yy ff</span>
<span class="cm">     *  &#39;xx&#39; is garbage.</span>
<span class="cm">     *  &#39;yy&#39; is MAC address.</span>
<span class="cm">    */</span> 
    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mh">0x200</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">readb</span><span class="p">(</span><span class="n">base</span><span class="o">+</span><span class="n">i</span><span class="o">*</span><span class="mi">2</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x22</span><span class="p">)</span> <span class="p">{</span>	
		<span class="k">if</span> <span class="p">(</span><span class="n">readb</span><span class="p">(</span><span class="n">base</span><span class="o">+</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mi">2</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0xff</span> <span class="o">&amp;&amp;</span>
		    <span class="n">readb</span><span class="p">(</span><span class="n">base</span><span class="o">+</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">5</span><span class="p">)</span><span class="o">*</span><span class="mi">2</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x04</span> <span class="o">&amp;&amp;</span>
		    <span class="n">readb</span><span class="p">(</span><span class="n">base</span><span class="o">+</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">6</span><span class="p">)</span><span class="o">*</span><span class="mi">2</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x06</span> <span class="o">&amp;&amp;</span>
		    <span class="n">readb</span><span class="p">(</span><span class="n">base</span><span class="o">+</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">13</span><span class="p">)</span><span class="o">*</span><span class="mi">2</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0xff</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">!=</span> <span class="mh">0x200</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">,</span><span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
	    <span class="n">node_id</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">readb</span><span class="p">(</span><span class="n">base</span><span class="o">+</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">7</span><span class="p">)</span><span class="o">*</span><span class="mi">2</span><span class="p">);</span>
	<span class="p">}</span>
    <span class="p">}</span>

    <span class="n">iounmap</span><span class="p">(</span><span class="n">base</span><span class="p">);</span>
    <span class="n">j</span> <span class="o">=</span> <span class="n">pcmcia_release_window</span><span class="p">(</span><span class="n">link</span><span class="p">,</span> <span class="n">link</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">i</span> <span class="o">!=</span> <span class="mh">0x200</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

<span class="p">}</span> <span class="cm">/* fmvj18x_get_hwinfo */</span>
<span class="cm">/*====================================================================*/</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">fmvj18x_setup_mfc</span><span class="p">(</span><span class="k">struct</span> <span class="n">pcmcia_device</span> <span class="o">*</span><span class="n">link</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">link</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ioaddr</span><span class="p">;</span>
    <span class="n">local_info_t</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

    <span class="cm">/* Allocate a small memory window */</span>
    <span class="n">link</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">WIN_DATA_WIDTH_8</span><span class="o">|</span><span class="n">WIN_MEMORY_TYPE_AM</span><span class="o">|</span><span class="n">WIN_ENABLE</span><span class="p">;</span>
    <span class="n">link</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">=</span> <span class="n">link</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">end</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">i</span> <span class="o">=</span> <span class="n">pcmcia_request_window</span><span class="p">(</span><span class="n">link</span><span class="p">,</span> <span class="n">link</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="mi">0</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

    <span class="n">lp</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span>
		       <span class="n">resource_size</span><span class="p">(</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">3</span><span class="p">]));</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">netdev_notice</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;ioremap failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">i</span> <span class="o">=</span> <span class="n">pcmcia_map_mem_page</span><span class="p">(</span><span class="n">link</span><span class="p">,</span> <span class="n">link</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="mi">0</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">);</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>
    
    <span class="n">ioaddr</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>
    <span class="n">writeb</span><span class="p">(</span><span class="mh">0x47</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">base</span><span class="o">+</span><span class="mh">0x800</span><span class="p">);</span>	<span class="cm">/* Config Option Register of LAN */</span>
    <span class="n">writeb</span><span class="p">(</span><span class="mh">0x0</span><span class="p">,</span>  <span class="n">lp</span><span class="o">-&gt;</span><span class="n">base</span><span class="o">+</span><span class="mh">0x802</span><span class="p">);</span>	<span class="cm">/* Config and Status Register */</span>

    <span class="n">writeb</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">base</span><span class="o">+</span><span class="mh">0x80a</span><span class="p">);</span>	  <span class="cm">/* I/O Base(Low) of LAN */</span>
    <span class="n">writeb</span><span class="p">((</span><span class="n">ioaddr</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">base</span><span class="o">+</span><span class="mh">0x80c</span><span class="p">);</span> <span class="cm">/* I/O Base(High) of LAN */</span>
   
    <span class="n">writeb</span><span class="p">(</span><span class="mh">0x45</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">base</span><span class="o">+</span><span class="mh">0x820</span><span class="p">);</span>	<span class="cm">/* Config Option Register of Modem */</span>
    <span class="n">writeb</span><span class="p">(</span><span class="mh">0x8</span><span class="p">,</span>  <span class="n">lp</span><span class="o">-&gt;</span><span class="n">base</span><span class="o">+</span><span class="mh">0x822</span><span class="p">);</span>	<span class="cm">/* Config and Status Register */</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="p">}</span>
<span class="cm">/*====================================================================*/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">fmvj18x_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">pcmcia_device</span> <span class="o">*</span><span class="n">link</span><span class="p">)</span>
<span class="p">{</span>

    <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">link</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
    <span class="n">local_info_t</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
    <span class="n">u_char</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>

    <span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;fmvj18x_release</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>    <span class="cm">/* set NULL before iounmap */</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">tmp</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="n">pcmcia_disable_device</span><span class="p">(</span><span class="n">link</span><span class="p">);</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">fmvj18x_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">pcmcia_device</span> <span class="o">*</span><span class="n">link</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">link</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">open</span><span class="p">)</span>
		<span class="n">netif_device_detach</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">fmvj18x_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">pcmcia_device</span> <span class="o">*</span><span class="n">link</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">link</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">open</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fjn_reset</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">netif_device_attach</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*====================================================================*/</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">pcmcia_device_id</span> <span class="n">fmvj18x_ids</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">PCMCIA_DEVICE_MANF_CARD</span><span class="p">(</span><span class="mh">0x0004</span><span class="p">,</span> <span class="mh">0x0004</span><span class="p">),</span>
	<span class="n">PCMCIA_DEVICE_PROD_ID12</span><span class="p">(</span><span class="s">&quot;EAGLE Technology&quot;</span><span class="p">,</span> <span class="s">&quot;NE200 ETHERNET LAN MBH10302 04&quot;</span><span class="p">,</span> <span class="mh">0x528c88c4</span><span class="p">,</span> <span class="mh">0x74f91e59</span><span class="p">),</span>
	<span class="n">PCMCIA_DEVICE_PROD_ID12</span><span class="p">(</span><span class="s">&quot;Eiger Labs,Inc&quot;</span><span class="p">,</span> <span class="s">&quot;EPX-10BT PC Card Ethernet 10BT&quot;</span><span class="p">,</span> <span class="mh">0x53af556e</span><span class="p">,</span> <span class="mh">0x877f9922</span><span class="p">),</span>
	<span class="n">PCMCIA_DEVICE_PROD_ID12</span><span class="p">(</span><span class="s">&quot;Eiger labs,Inc.&quot;</span><span class="p">,</span> <span class="s">&quot;EPX-10BT PC Card Ethernet 10BT&quot;</span><span class="p">,</span> <span class="mh">0xf47e6c66</span><span class="p">,</span> <span class="mh">0x877f9922</span><span class="p">),</span>
	<span class="n">PCMCIA_DEVICE_PROD_ID12</span><span class="p">(</span><span class="s">&quot;FUJITSU&quot;</span><span class="p">,</span> <span class="s">&quot;LAN Card(FMV-J182)&quot;</span><span class="p">,</span> <span class="mh">0x6ee5a3d8</span><span class="p">,</span> <span class="mh">0x5baf31db</span><span class="p">),</span>
	<span class="n">PCMCIA_DEVICE_PROD_ID12</span><span class="p">(</span><span class="s">&quot;FUJITSU&quot;</span><span class="p">,</span> <span class="s">&quot;MBH10308&quot;</span><span class="p">,</span> <span class="mh">0x6ee5a3d8</span><span class="p">,</span> <span class="mh">0x3f04875e</span><span class="p">),</span>
	<span class="n">PCMCIA_DEVICE_PROD_ID12</span><span class="p">(</span><span class="s">&quot;FUJITSU TOWA&quot;</span><span class="p">,</span> <span class="s">&quot;LA501&quot;</span><span class="p">,</span> <span class="mh">0xb8451188</span><span class="p">,</span> <span class="mh">0x12939ba2</span><span class="p">),</span>
	<span class="n">PCMCIA_DEVICE_PROD_ID12</span><span class="p">(</span><span class="s">&quot;HITACHI&quot;</span><span class="p">,</span> <span class="s">&quot;HT-4840-11&quot;</span><span class="p">,</span> <span class="mh">0xf4f43949</span><span class="p">,</span> <span class="mh">0x773910f4</span><span class="p">),</span>
	<span class="n">PCMCIA_DEVICE_PROD_ID12</span><span class="p">(</span><span class="s">&quot;NextComK.K.&quot;</span><span class="p">,</span> <span class="s">&quot;NC5310B Ver1.0       &quot;</span><span class="p">,</span> <span class="mh">0x8cef4d3a</span><span class="p">,</span> <span class="mh">0x075fc7b6</span><span class="p">),</span>
	<span class="n">PCMCIA_DEVICE_PROD_ID12</span><span class="p">(</span><span class="s">&quot;NextComK.K.&quot;</span><span class="p">,</span> <span class="s">&quot;NC5310 Ver1.0        &quot;</span><span class="p">,</span> <span class="mh">0x8cef4d3a</span><span class="p">,</span> <span class="mh">0xbccf43e6</span><span class="p">),</span>
	<span class="n">PCMCIA_DEVICE_PROD_ID12</span><span class="p">(</span><span class="s">&quot;RATOC System Inc.&quot;</span><span class="p">,</span> <span class="s">&quot;10BASE_T CARD R280&quot;</span><span class="p">,</span> <span class="mh">0x85c10e17</span><span class="p">,</span> <span class="mh">0xd9413666</span><span class="p">),</span>
	<span class="n">PCMCIA_DEVICE_PROD_ID12</span><span class="p">(</span><span class="s">&quot;TDK&quot;</span><span class="p">,</span> <span class="s">&quot;LAC-CD02x&quot;</span><span class="p">,</span> <span class="mh">0x1eae9475</span><span class="p">,</span> <span class="mh">0x8fa0ee70</span><span class="p">),</span>
	<span class="n">PCMCIA_DEVICE_PROD_ID12</span><span class="p">(</span><span class="s">&quot;TDK&quot;</span><span class="p">,</span> <span class="s">&quot;LAC-CF010&quot;</span><span class="p">,</span> <span class="mh">0x1eae9475</span><span class="p">,</span> <span class="mh">0x7683bc9a</span><span class="p">),</span>
	<span class="n">PCMCIA_DEVICE_PROD_ID1</span><span class="p">(</span><span class="s">&quot;CONTEC Co.,Ltd.&quot;</span><span class="p">,</span> <span class="mh">0x58d8fee2</span><span class="p">),</span>
	<span class="n">PCMCIA_DEVICE_PROD_ID1</span><span class="p">(</span><span class="s">&quot;PCMCIA LAN MBH10304  ES&quot;</span><span class="p">,</span> <span class="mh">0x2599f454</span><span class="p">),</span>
	<span class="n">PCMCIA_DEVICE_PROD_ID1</span><span class="p">(</span><span class="s">&quot;PCMCIA MBH10302&quot;</span><span class="p">,</span> <span class="mh">0x8f4005da</span><span class="p">),</span>
	<span class="n">PCMCIA_DEVICE_PROD_ID1</span><span class="p">(</span><span class="s">&quot;UBKK,V2.0&quot;</span><span class="p">,</span> <span class="mh">0x90888080</span><span class="p">),</span>
	<span class="n">PCMCIA_PFC_DEVICE_PROD_ID12</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;TDK&quot;</span><span class="p">,</span> <span class="s">&quot;GlobalNetworker 3410/3412&quot;</span><span class="p">,</span> <span class="mh">0x1eae9475</span><span class="p">,</span> <span class="mh">0xd9a93bed</span><span class="p">),</span>
	<span class="n">PCMCIA_PFC_DEVICE_PROD_ID12</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;NEC&quot;</span><span class="p">,</span> <span class="s">&quot;PK-UG-J001&quot;</span> <span class="p">,</span><span class="mh">0x18df0ba0</span> <span class="p">,</span><span class="mh">0x831b1064</span><span class="p">),</span>
	<span class="n">PCMCIA_PFC_DEVICE_MANF_CARD</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x0105</span><span class="p">,</span> <span class="mh">0x0d0a</span><span class="p">),</span>
	<span class="n">PCMCIA_PFC_DEVICE_MANF_CARD</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x0105</span><span class="p">,</span> <span class="mh">0x0e0a</span><span class="p">),</span>
	<span class="n">PCMCIA_PFC_DEVICE_MANF_CARD</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x0032</span><span class="p">,</span> <span class="mh">0x0e01</span><span class="p">),</span>
	<span class="n">PCMCIA_PFC_DEVICE_MANF_CARD</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x0032</span><span class="p">,</span> <span class="mh">0x0a05</span><span class="p">),</span>
	<span class="n">PCMCIA_PFC_DEVICE_MANF_CARD</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x0032</span><span class="p">,</span> <span class="mh">0x0b05</span><span class="p">),</span>
	<span class="n">PCMCIA_PFC_DEVICE_MANF_CARD</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x0032</span><span class="p">,</span> <span class="mh">0x1101</span><span class="p">),</span>
	<span class="n">PCMCIA_DEVICE_NULL</span><span class="p">,</span>
<span class="p">};</span>
<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">pcmcia</span><span class="p">,</span> <span class="n">fmvj18x_ids</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pcmcia_driver</span> <span class="n">fmvj18x_cs_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;fmvj18x_cs&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span>		<span class="o">=</span> <span class="n">fmvj18x_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>		<span class="o">=</span> <span class="n">fmvj18x_detach</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span>       <span class="o">=</span> <span class="n">fmvj18x_ids</span><span class="p">,</span>
	<span class="p">.</span><span class="n">suspend</span>	<span class="o">=</span> <span class="n">fmvj18x_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume</span>		<span class="o">=</span> <span class="n">fmvj18x_resume</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">init_fmvj18x_cs</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">pcmcia_register_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fmvj18x_cs_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">exit_fmvj18x_cs</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pcmcia_unregister_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fmvj18x_cs_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">init_fmvj18x_cs</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">exit_fmvj18x_cs</span><span class="p">);</span>

<span class="cm">/*====================================================================*/</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">fjn_interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">dummy</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev_id</span><span class="p">;</span>
    <span class="n">local_info_t</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ioaddr</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">tx_stat</span><span class="p">,</span> <span class="n">rx_stat</span><span class="p">;</span>

    <span class="n">ioaddr</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>

    <span class="cm">/* avoid multiple interrupts */</span>
    <span class="n">outw</span><span class="p">(</span><span class="mh">0x0000</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">TX_INTR</span><span class="p">);</span>

    <span class="cm">/* wait for a while */</span>
    <span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

    <span class="cm">/* get status */</span>
    <span class="n">tx_stat</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">TX_STATUS</span><span class="p">);</span>
    <span class="n">rx_stat</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">RX_STATUS</span><span class="p">);</span>

    <span class="cm">/* clear status */</span>
    <span class="n">outb</span><span class="p">(</span><span class="n">tx_stat</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">TX_STATUS</span><span class="p">);</span>
    <span class="n">outb</span><span class="p">(</span><span class="n">rx_stat</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">RX_STATUS</span><span class="p">);</span>
    
    <span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: interrupt, rx_status %02x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">rx_stat</span><span class="p">);</span>
    <span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;               tx_status %02x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tx_stat</span><span class="p">);</span>
    
    <span class="k">if</span> <span class="p">(</span><span class="n">rx_stat</span> <span class="o">||</span> <span class="p">(</span><span class="n">inb</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">RX_MODE</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">F_BUF_EMP</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
	<span class="cm">/* there is packet(s) in rx buffer */</span>
	<span class="n">fjn_rx</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">tx_stat</span> <span class="o">&amp;</span> <span class="n">F_TMT_RDY</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_packets</span> <span class="o">+=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">sent</span> <span class="p">;</span>
        <span class="n">lp</span><span class="o">-&gt;</span><span class="n">sent</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_queue</span><span class="p">)</span> <span class="p">{</span>
	    <span class="n">outb</span><span class="p">(</span><span class="n">DO_TX</span> <span class="o">|</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_queue</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">TX_START</span><span class="p">);</span>
	    <span class="n">lp</span><span class="o">-&gt;</span><span class="n">sent</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_queue</span> <span class="p">;</span>
	    <span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_queue</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	    <span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_queue_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	    <span class="n">dev</span><span class="o">-&gt;</span><span class="n">trans_start</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	    <span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_started</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: exiting interrupt,</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
    <span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;    tx_status %02x, rx_status %02x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tx_stat</span><span class="p">,</span> <span class="n">rx_stat</span><span class="p">);</span>

    <span class="n">outb</span><span class="p">(</span><span class="n">D_TX_INTR</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">TX_INTR</span><span class="p">);</span>
    <span class="n">outb</span><span class="p">(</span><span class="n">D_RX_INTR</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">RX_INTR</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
	<span class="cm">/* Ack interrupt for multifunction card */</span>
	<span class="n">writeb</span><span class="p">(</span><span class="mh">0x01</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">base</span><span class="o">+</span><span class="mh">0x802</span><span class="p">);</span>
	<span class="n">writeb</span><span class="p">(</span><span class="mh">0x09</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">base</span><span class="o">+</span><span class="mh">0x822</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>

<span class="p">}</span> <span class="cm">/* fjn_interrupt */</span>

<span class="cm">/*====================================================================*/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">fjn_tx_timeout</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">struct</span> <span class="n">local_info_t</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ioaddr</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>

    <span class="n">netdev_notice</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;transmit timed out with status %04x, %s?</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		  <span class="n">htons</span><span class="p">(</span><span class="n">inw</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">TX_STATUS</span><span class="p">)),</span>
		  <span class="n">inb</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">TX_STATUS</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">F_TMT_RDY</span>
		  <span class="o">?</span> <span class="s">&quot;IRQ conflict&quot;</span> <span class="o">:</span> <span class="s">&quot;network cable problem&quot;</span><span class="p">);</span>
    <span class="n">netdev_notice</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;timeout registers: %04x %04x %04x &quot;</span>
		  <span class="s">&quot;%04x %04x %04x %04x %04x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		  <span class="n">htons</span><span class="p">(</span><span class="n">inw</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="mi">0</span><span class="p">)),</span> <span class="n">htons</span><span class="p">(</span><span class="n">inw</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)),</span>
		  <span class="n">htons</span><span class="p">(</span><span class="n">inw</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="mi">4</span><span class="p">)),</span> <span class="n">htons</span><span class="p">(</span><span class="n">inw</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="mi">6</span><span class="p">)),</span>
		  <span class="n">htons</span><span class="p">(</span><span class="n">inw</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="mi">8</span><span class="p">)),</span> <span class="n">htons</span><span class="p">(</span><span class="n">inw</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="mi">10</span><span class="p">)),</span>
		  <span class="n">htons</span><span class="p">(</span><span class="n">inw</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="mi">12</span><span class="p">)),</span> <span class="n">htons</span><span class="p">(</span><span class="n">inw</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="mi">14</span><span class="p">)));</span>
    <span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_errors</span><span class="o">++</span><span class="p">;</span>
    <span class="cm">/* ToDo: We should try to restart the adaptor... */</span>
    <span class="n">local_irq_disable</span><span class="p">();</span>
    <span class="n">fjn_reset</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

    <span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_started</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_queue</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_queue_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">lp</span><span class="o">-&gt;</span><span class="n">sent</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">lp</span><span class="o">-&gt;</span><span class="n">open_time</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
    <span class="n">local_irq_enable</span><span class="p">();</span>
    <span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">netdev_tx_t</span> <span class="nf">fjn_start_xmit</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">struct</span> <span class="n">local_info_t</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ioaddr</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>
    <span class="kt">short</span> <span class="n">length</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
    
    <span class="k">if</span> <span class="p">(</span><span class="n">length</span> <span class="o">&lt;</span> <span class="n">ETH_ZLEN</span><span class="p">)</span>
    <span class="p">{</span>
    	<span class="k">if</span> <span class="p">(</span><span class="n">skb_padto</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">ETH_ZLEN</span><span class="p">))</span>
    		<span class="k">return</span> <span class="n">NETDEV_TX_OK</span><span class="p">;</span>
    	<span class="n">length</span> <span class="o">=</span> <span class="n">ETH_ZLEN</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

    <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">length</span> <span class="o">&gt;</span> <span class="n">ETH_FRAME_LEN</span><span class="p">)</span> <span class="p">{</span>
	    <span class="n">netdev_notice</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Attempting to send a large packet (%d bytes)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">length</span><span class="p">);</span>
	    <span class="k">return</span> <span class="n">NETDEV_TX_BUSY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">netdev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Transmitting a packet of length %lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_bytes</span> <span class="o">+=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>

	<span class="cm">/* Disable both interrupts. */</span>
	<span class="n">outw</span><span class="p">(</span><span class="mh">0x0000</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">TX_INTR</span><span class="p">);</span>

	<span class="cm">/* wait for a while */</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

	<span class="n">outw</span><span class="p">(</span><span class="n">length</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">DATAPORT</span><span class="p">);</span>
	<span class="n">outsw</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">DATAPORT</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="p">(</span><span class="n">length</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_queue</span><span class="o">++</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_queue_len</span> <span class="o">+=</span> <span class="p">((</span><span class="n">length</span><span class="o">+</span><span class="mi">3</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_started</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
	    <span class="cm">/* If the Tx is idle, always trigger a transmit. */</span>
	    <span class="n">outb</span><span class="p">(</span><span class="n">DO_TX</span> <span class="o">|</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_queue</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">TX_START</span><span class="p">);</span>
	    <span class="n">lp</span><span class="o">-&gt;</span><span class="n">sent</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_queue</span> <span class="p">;</span>
	    <span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_queue</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	    <span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_queue_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	    <span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_started</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	    <span class="n">netif_start_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	    <span class="k">if</span><span class="p">(</span> <span class="n">sram_config</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_queue_len</span> <span class="o">&lt;</span> <span class="p">(</span><span class="mi">4096</span> <span class="o">-</span> <span class="p">(</span><span class="n">ETH_FRAME_LEN</span> <span class="o">+</span><span class="mi">2</span><span class="p">))</span> <span class="p">)</span>
		    <span class="cm">/* Yes, there is room for one more packet. */</span>
		    <span class="n">netif_start_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_queue_len</span> <span class="o">&lt;</span> <span class="p">(</span><span class="mi">8192</span> <span class="o">-</span> <span class="p">(</span><span class="n">ETH_FRAME_LEN</span> <span class="o">+</span><span class="mi">2</span><span class="p">))</span> <span class="o">&amp;&amp;</span> 
						<span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_queue</span> <span class="o">&lt;</span> <span class="mi">127</span> <span class="p">)</span>
		    <span class="cm">/* Yes, there is room for one more packet. */</span>
		    <span class="n">netif_start_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	    <span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Re-enable interrupts */</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">D_TX_INTR</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">TX_INTR</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">D_RX_INTR</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">RX_INTR</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">dev_kfree_skb</span> <span class="p">(</span><span class="n">skb</span><span class="p">);</span>

    <span class="k">return</span> <span class="n">NETDEV_TX_OK</span><span class="p">;</span>
<span class="p">}</span> <span class="cm">/* fjn_start_xmit */</span>

<span class="cm">/*====================================================================*/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">fjn_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">struct</span> <span class="n">local_info_t</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ioaddr</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

    <span class="n">netdev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;fjn_reset() called</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

    <span class="cm">/* Reset controller */</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">sram_config</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">)</span> 
	<span class="n">outb</span><span class="p">(</span><span class="n">CONFIG0_RST</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">CONFIG_0</span><span class="p">);</span>
    <span class="k">else</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">CONFIG0_RST_1</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">CONFIG_0</span><span class="p">);</span>

    <span class="cm">/* Power On chip and select bank 0 */</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">cardtype</span> <span class="o">==</span> <span class="n">MBH10302</span><span class="p">)</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">BANK_0</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">CONFIG_1</span><span class="p">);</span>
    <span class="k">else</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">BANK_0U</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">CONFIG_1</span><span class="p">);</span>

    <span class="cm">/* Set Tx modes */</span>
    <span class="n">outb</span><span class="p">(</span><span class="n">D_TX_MODE</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">TX_MODE</span><span class="p">);</span>
    <span class="cm">/* set Rx modes */</span>
    <span class="n">outb</span><span class="p">(</span><span class="n">ID_MATCHED</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">RX_MODE</span><span class="p">);</span>

    <span class="cm">/* Set hardware address */</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> 
        <span class="n">outb</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">NODE_ID</span> <span class="o">+</span> <span class="n">i</span><span class="p">);</span>

    <span class="cm">/* (re)initialize the multicast table */</span>
    <span class="n">set_rx_mode</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

    <span class="cm">/* Switch to bank 2 (runtime mode) */</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">cardtype</span> <span class="o">==</span> <span class="n">MBH10302</span><span class="p">)</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">BANK_2</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">CONFIG_1</span><span class="p">);</span>
    <span class="k">else</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">BANK_2U</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">CONFIG_1</span><span class="p">);</span>

    <span class="cm">/* set 16col ctrl bits */</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">cardtype</span> <span class="o">==</span> <span class="n">TDK</span> <span class="o">||</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">cardtype</span> <span class="o">==</span> <span class="n">CONTEC</span><span class="p">)</span> 
        <span class="n">outb</span><span class="p">(</span><span class="n">TDK_AUTO_MODE</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">COL_CTRL</span><span class="p">);</span>
    <span class="k">else</span>
        <span class="n">outb</span><span class="p">(</span><span class="n">AUTO_MODE</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">COL_CTRL</span><span class="p">);</span>

    <span class="cm">/* clear Reserved Regs */</span>
    <span class="n">outb</span><span class="p">(</span><span class="mh">0x00</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">BMPR12</span><span class="p">);</span>
    <span class="n">outb</span><span class="p">(</span><span class="mh">0x00</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">BMPR13</span><span class="p">);</span>

    <span class="cm">/* reset Skip packet reg. */</span>
    <span class="n">outb</span><span class="p">(</span><span class="mh">0x01</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">RX_SKIP</span><span class="p">);</span>

    <span class="cm">/* Enable Tx and Rx */</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">sram_config</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">)</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">CONFIG0_DFL</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">CONFIG_0</span><span class="p">);</span>
    <span class="k">else</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">CONFIG0_DFL_1</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">CONFIG_0</span><span class="p">);</span>

    <span class="cm">/* Init receive pointer ? */</span>
    <span class="n">inw</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">DATAPORT</span><span class="p">);</span>
    <span class="n">inw</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">DATAPORT</span><span class="p">);</span>

    <span class="cm">/* Clear all status */</span>
    <span class="n">outb</span><span class="p">(</span><span class="mh">0xff</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">TX_STATUS</span><span class="p">);</span>
    <span class="n">outb</span><span class="p">(</span><span class="mh">0xff</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">RX_STATUS</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">cardtype</span> <span class="o">==</span> <span class="n">MBH10302</span><span class="p">)</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">INTR_OFF</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">LAN_CTRL</span><span class="p">);</span>

    <span class="cm">/* Turn on Rx interrupts */</span>
    <span class="n">outb</span><span class="p">(</span><span class="n">D_TX_INTR</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">TX_INTR</span><span class="p">);</span>
    <span class="n">outb</span><span class="p">(</span><span class="n">D_RX_INTR</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">RX_INTR</span><span class="p">);</span>

    <span class="cm">/* Turn on interrupts from LAN card controller */</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">cardtype</span> <span class="o">==</span> <span class="n">MBH10302</span><span class="p">)</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">INTR_ON</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">LAN_CTRL</span><span class="p">);</span>
<span class="p">}</span> <span class="cm">/* fjn_reset */</span>

<span class="cm">/*====================================================================*/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">fjn_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ioaddr</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">boguscount</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>	<span class="cm">/* 5 -&gt; 10: by agy 19940922 */</span>

    <span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: in rx_packet(), rx_status %02x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	  <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">inb</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">RX_STATUS</span><span class="p">));</span>

    <span class="k">while</span> <span class="p">((</span><span class="n">inb</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">RX_MODE</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">F_BUF_EMP</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">u_short</span> <span class="n">status</span> <span class="o">=</span> <span class="n">inw</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">DATAPORT</span><span class="p">);</span>

	<span class="n">netdev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Rxing packet mode %02x status %04x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">inb</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">RX_MODE</span><span class="p">),</span> <span class="n">status</span><span class="p">);</span>
<span class="cp">#ifndef final_version</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
	    <span class="n">outb</span><span class="p">(</span><span class="n">F_SKP_PKT</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">RX_SKIP</span><span class="p">);</span>
	    <span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">status</span> <span class="o">&amp;</span> <span class="mh">0xF0</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x20</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* There was an error. */</span>
	    <span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_errors</span><span class="o">++</span><span class="p">;</span>
	    <span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">F_LEN_ERR</span><span class="p">)</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_length_errors</span><span class="o">++</span><span class="p">;</span>
	    <span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">F_ALG_ERR</span><span class="p">)</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_frame_errors</span><span class="o">++</span><span class="p">;</span>
	    <span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">F_CRC_ERR</span><span class="p">)</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_crc_errors</span><span class="o">++</span><span class="p">;</span>
	    <span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">F_OVR_FLO</span><span class="p">)</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_over_errors</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	    <span class="n">u_short</span> <span class="n">pkt_len</span> <span class="o">=</span> <span class="n">inw</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">DATAPORT</span><span class="p">);</span>
	    <span class="cm">/* Malloc up new buffer. */</span>
	    <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>

	    <span class="k">if</span> <span class="p">(</span><span class="n">pkt_len</span> <span class="o">&gt;</span> <span class="mi">1550</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netdev_notice</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;The FMV-18x claimed a very large packet, size %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			      <span class="n">pkt_len</span><span class="p">);</span>
		<span class="n">outb</span><span class="p">(</span><span class="n">F_SKP_PKT</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">RX_SKIP</span><span class="p">);</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_errors</span><span class="o">++</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	    <span class="p">}</span>
	    <span class="n">skb</span> <span class="o">=</span> <span class="n">netdev_alloc_skb</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">pkt_len</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>
	    <span class="k">if</span> <span class="p">(</span><span class="n">skb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netdev_notice</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Memory squeeze, dropping packet (len %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			      <span class="n">pkt_len</span><span class="p">);</span>
		<span class="n">outb</span><span class="p">(</span><span class="n">F_SKP_PKT</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">RX_SKIP</span><span class="p">);</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_dropped</span><span class="o">++</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	    <span class="p">}</span>

	    <span class="n">skb_reserve</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	    <span class="n">insw</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">DATAPORT</span><span class="p">,</span> <span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">pkt_len</span><span class="p">),</span>
		 <span class="p">(</span><span class="n">pkt_len</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">);</span>
	    <span class="n">skb</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">eth_type_trans</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>

	    <span class="p">{</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: Rxed packet of length %d: &quot;</span><span class="p">,</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">pkt_len</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">14</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot; %02x&quot;</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	    <span class="p">}</span>

	    <span class="n">netif_rx</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	    <span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_packets</span><span class="o">++</span><span class="p">;</span>
	    <span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_bytes</span> <span class="o">+=</span> <span class="n">pkt_len</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">--</span><span class="n">boguscount</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
	    <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="cm">/* If any worth-while packets have been received, dev_rint()</span>
<span class="cm">	   has done a netif_wake_queue() for us and will work on them</span>
<span class="cm">	   when we get to the bottom-half routine. */</span>
<span class="cm">/*</span>
<span class="cm">    if (lp-&gt;cardtype != TDK) {</span>
<span class="cm">	int i;</span>
<span class="cm">	for (i = 0; i &lt; 20; i++) {</span>
<span class="cm">	    if ((inb(ioaddr + RX_MODE) &amp; F_BUF_EMP) == F_BUF_EMP)</span>
<span class="cm">		break;</span>
<span class="cm">	    (void)inw(ioaddr + DATAPORT);  /+ dummy status read +/</span>
<span class="cm">	    outb(F_SKP_PKT, ioaddr + RX_SKIP);</span>
<span class="cm">	}</span>

<span class="cm">	if (i &gt; 0)</span>
<span class="cm">	    pr_debug(&quot;%s: Exint Rx packet with mode %02x after &quot;</span>
<span class="cm">		  &quot;%d ticks.\n&quot;, dev-&gt;name, inb(ioaddr + RX_MODE), i);</span>
<span class="cm">    }</span>
<span class="cm">*/</span>
<span class="p">}</span> <span class="cm">/* fjn_rx */</span>

<span class="cm">/*====================================================================*/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">netdev_get_drvinfo</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">ethtool_drvinfo</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">strlcpy</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">,</span> <span class="n">DRV_NAME</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">));</span>
	<span class="n">strlcpy</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">,</span> <span class="n">DRV_VERSION</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">));</span>
	<span class="n">snprintf</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">bus_info</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">bus_info</span><span class="p">),</span>
		<span class="s">&quot;PCMCIA 0x%lx&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ethtool_ops</span> <span class="n">netdev_ethtool_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">get_drvinfo</span>		<span class="o">=</span> <span class="n">netdev_get_drvinfo</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">fjn_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ifmap</span> <span class="o">*</span><span class="n">map</span><span class="p">){</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">fjn_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">struct</span> <span class="n">local_info_t</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
    <span class="k">struct</span> <span class="n">pcmcia_device</span> <span class="o">*</span><span class="n">link</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">p_dev</span><span class="p">;</span>

    <span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;fjn_open(&#39;%s&#39;).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pcmcia_dev_present</span><span class="p">(</span><span class="n">link</span><span class="p">))</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
    
    <span class="n">link</span><span class="o">-&gt;</span><span class="n">open</span><span class="o">++</span><span class="p">;</span>
    
    <span class="n">fjn_reset</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
    
    <span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_started</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_queue</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_queue_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">lp</span><span class="o">-&gt;</span><span class="n">open_time</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
    <span class="n">netif_start_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
    
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span> <span class="cm">/* fjn_open */</span>

<span class="cm">/*====================================================================*/</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">fjn_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">struct</span> <span class="n">local_info_t</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
    <span class="k">struct</span> <span class="n">pcmcia_device</span> <span class="o">*</span><span class="n">link</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">p_dev</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ioaddr</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>

    <span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;fjn_close(&#39;%s&#39;).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

    <span class="n">lp</span><span class="o">-&gt;</span><span class="n">open_time</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

    <span class="cm">/* Set configuration register 0 to disable Tx and Rx. */</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">sram_config</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">)</span> 
	<span class="n">outb</span><span class="p">(</span><span class="n">CONFIG0_RST</span> <span class="p">,</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">CONFIG_0</span><span class="p">);</span>
    <span class="k">else</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">CONFIG0_RST_1</span> <span class="p">,</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">CONFIG_0</span><span class="p">);</span>

    <span class="cm">/* Update the statistics -- ToDo. */</span>

    <span class="cm">/* Power-down the chip.  Green, green, green! */</span>
    <span class="n">outb</span><span class="p">(</span><span class="n">CHIP_OFF</span> <span class="p">,</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">CONFIG_1</span><span class="p">);</span>

    <span class="cm">/* Set the ethernet adaptor disable IRQ */</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">cardtype</span> <span class="o">==</span> <span class="n">MBH10302</span><span class="p">)</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">INTR_OFF</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">LAN_CTRL</span><span class="p">);</span>

    <span class="n">link</span><span class="o">-&gt;</span><span class="n">open</span><span class="o">--</span><span class="p">;</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span> <span class="cm">/* fjn_close */</span>

<span class="cm">/*====================================================================*/</span>

<span class="cm">/*</span>
<span class="cm">  Set the multicast/promiscuous mode for this adaptor.</span>
<span class="cm">*/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">set_rx_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ioaddr</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>
    <span class="n">u_char</span> <span class="n">mc_filter</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>		 <span class="cm">/* Multicast hash filter */</span>
    <span class="n">u_long</span> <span class="n">flags</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
    
    <span class="kt">int</span> <span class="n">saved_bank</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">saved_config_0</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">CONFIG_0</span><span class="p">);</span>
     
    <span class="n">local_irq_save</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span> 

    <span class="cm">/* Disable Tx and Rx */</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">sram_config</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> 
	<span class="n">outb</span><span class="p">(</span><span class="n">CONFIG0_RST</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">CONFIG_0</span><span class="p">);</span>
    <span class="k">else</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">CONFIG0_RST_1</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">CONFIG_0</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_PROMISC</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">mc_filter</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mc_filter</span><span class="p">));</span>
	<span class="n">outb</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">RX_MODE</span><span class="p">);</span>	<span class="cm">/* Enable promiscuous mode */</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">netdev_mc_count</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">MC_FILTERBREAK</span> <span class="o">||</span>
	       <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_ALLMULTI</span><span class="p">))</span> <span class="p">{</span>
	<span class="cm">/* Too many to filter perfectly -- accept all multicasts. */</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">mc_filter</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mc_filter</span><span class="p">));</span>
	<span class="n">outb</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">RX_MODE</span><span class="p">);</span>	<span class="cm">/* Use normal mode. */</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">netdev_mc_empty</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">mc_filter</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mc_filter</span><span class="p">));</span>
	<span class="n">outb</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">RX_MODE</span><span class="p">);</span>	<span class="cm">/* Ignore almost all multicasts. */</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">netdev_hw_addr</span> <span class="o">*</span><span class="n">ha</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">mc_filter</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mc_filter</span><span class="p">));</span>
	<span class="n">netdev_for_each_mc_addr</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
	    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bit</span> <span class="o">=</span> <span class="n">ether_crc_le</span><span class="p">(</span><span class="n">ETH_ALEN</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">26</span><span class="p">;</span>
	    <span class="n">mc_filter</span><span class="p">[</span><span class="n">bit</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">]</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">bit</span> <span class="o">&amp;</span> <span class="mi">7</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="n">outb</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">RX_MODE</span><span class="p">);</span>	<span class="cm">/* Use normal mode. */</span>
    <span class="p">}</span>

    <span class="cm">/* Switch to bank 1 and set the multicast table. */</span>
    <span class="n">saved_bank</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">CONFIG_1</span><span class="p">);</span>
    <span class="n">outb</span><span class="p">(</span><span class="mh">0xe4</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">CONFIG_1</span><span class="p">);</span>

    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">mc_filter</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">MAR_ADR</span> <span class="o">+</span> <span class="n">i</span><span class="p">);</span>
    <span class="n">outb</span><span class="p">(</span><span class="n">saved_bank</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">CONFIG_1</span><span class="p">);</span>

    <span class="n">outb</span><span class="p">(</span><span class="n">saved_config_0</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">CONFIG_0</span><span class="p">);</span>

    <span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
