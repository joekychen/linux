<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › ethernet › fujitsu › eth16i.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>eth16i.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/* eth16i.c An ICL EtherTeam 16i and 32 EISA ethernet driver for Linux</span>

<span class="cm">   Written 1994-1999 by Mika Kuoppala</span>

<span class="cm">   Copyright (C) 1994-1999 by Mika Kuoppala</span>
<span class="cm">   Based on skeleton.c and heavily on at1700.c by Donald Becker</span>

<span class="cm">   This software may be used and distributed according to the terms</span>
<span class="cm">   of the GNU General Public License, incorporated herein by reference.</span>

<span class="cm">   The author may be reached as miku@iki.fi</span>

<span class="cm">   This driver supports following cards :</span>
<span class="cm">	- ICL EtherTeam 16i</span>
<span class="cm">	- ICL EtherTeam 32 EISA</span>
<span class="cm">	  (Uses true 32 bit transfers rather than 16i compatibility mode)</span>

<span class="cm">   Example Module usage:</span>
<span class="cm">        insmod eth16i.o io=0x2a0 mediatype=bnc</span>

<span class="cm">	mediatype can be one of the following: bnc,tp,dix,auto,eprom</span>

<span class="cm">	&#39;auto&#39; will try to autoprobe mediatype.</span>
<span class="cm">	&#39;eprom&#39; will use whatever type defined in eprom.</span>

<span class="cm">   I have benchmarked driver with PII/300Mhz as a ftp client</span>
<span class="cm">   and 486/33Mhz as a ftp server. Top speed was 1128.37 kilobytes/sec.</span>

<span class="cm">   Sources:</span>
<span class="cm">     - skeleton.c  a sample network driver core for linux,</span>
<span class="cm">       written by Donald Becker &lt;becker@scyld.com&gt;</span>
<span class="cm">     - at1700.c a driver for Allied Telesis AT1700, written</span>
<span class="cm">       by Donald Becker.</span>
<span class="cm">     - e16iSRV.asm a Netware 3.X Server Driver for ICL EtherTeam16i</span>
<span class="cm">       written by Markku Viima</span>
<span class="cm">     - The Fujitsu MB86965 databook.</span>

<span class="cm">   Author thanks following persons due to their valueble assistance:</span>
<span class="cm">        Markku Viima (ICL)</span>
<span class="cm">	Ari Valve (ICL)</span>
<span class="cm">	Donald Becker</span>
<span class="cm">	Kurt Huwig &lt;kurt@huwig.de&gt;</span>

<span class="cm">   Revision history:</span>

<span class="cm">   Version	Date		Description</span>

<span class="cm">   0.01         15.12-94        Initial version (card detection)</span>
<span class="cm">   0.02         23.01-95        Interrupt is now hooked correctly</span>
<span class="cm">   0.03         01.02-95        Rewrote initialization part</span>
<span class="cm">   0.04         07.02-95        Base skeleton done...</span>
<span class="cm">                                Made a few changes to signature checking</span>
<span class="cm">                                to make it a bit reliable.</span>
<span class="cm">                                - fixed bug in tx_buf mapping</span>
<span class="cm">                                - fixed bug in initialization (DLC_EN</span>
<span class="cm">                                  wasn&#39;t enabled when initialization</span>
<span class="cm">                                  was done.)</span>
<span class="cm">   0.05         08.02-95        If there were more than one packet to send,</span>
<span class="cm">                                transmit was jammed due to invalid</span>
<span class="cm">                                register write...now fixed</span>
<span class="cm">   0.06         19.02-95        Rewrote interrupt handling</span>
<span class="cm">   0.07         13.04-95        Wrote EEPROM read routines</span>
<span class="cm">                                Card configuration now set according to</span>
<span class="cm">                                data read from EEPROM</span>
<span class="cm">   0.08         23.06-95        Wrote part that tries to probe used interface</span>
<span class="cm">                                port if AUTO is selected</span>

<span class="cm">   0.09         01.09-95        Added module support</span>

<span class="cm">   0.10         04.09-95        Fixed receive packet allocation to work</span>
<span class="cm">                                with kernels &gt; 1.3.x</span>

<span class="cm">   0.20		20.09-95	Added support for EtherTeam32 EISA</span>

<span class="cm">   0.21         17.10-95        Removed the unnecessary extern</span>
<span class="cm">				init_etherdev() declaration. Some</span>
<span class="cm">				other cleanups.</span>

<span class="cm">   0.22		22.02-96	Receive buffer was not flushed</span>
<span class="cm">				correctly when faulty packet was</span>
<span class="cm">				received. Now fixed.</span>

<span class="cm">   0.23		26.02-96	Made resetting the adapter</span>
<span class="cm">			 	more reliable.</span>

<span class="cm">   0.24		27.02-96	Rewrote faulty packet handling in eth16i_rx</span>

<span class="cm">   0.25		22.05-96	kfree() was missing from cleanup_module.</span>

<span class="cm">   0.26		11.06-96	Sometimes card was not found by</span>
<span class="cm">				check_signature(). Now made more reliable.</span>

<span class="cm">   0.27		23.06-96	Oops. 16 consecutive collisions halted</span>
<span class="cm">				adapter. Now will try to retransmit</span>
<span class="cm">				MAX_COL_16 times before finally giving up.</span>

<span class="cm">   0.28	        28.10-97	Added dev_id parameter (NULL) for free_irq</span>

<span class="cm">   0.29         29.10-97        Multiple card support for module users</span>

<span class="cm">   0.30         30.10-97        Fixed irq allocation bug.</span>
<span class="cm">                                (request_irq moved from probe to open)</span>

<span class="cm">   0.30a        21.08-98        Card detection made more relaxed. Driver</span>
<span class="cm">                                had problems with some TCP/IP-PROM boots</span>
<span class="cm">				to find the card. Suggested by</span>
<span class="cm">				Kurt Huwig &lt;kurt@huwig.de&gt;</span>

<span class="cm">   0.31         28.08-98        Media interface port can now be selected</span>
<span class="cm">                                with module parameters or kernel</span>
<span class="cm">				boot parameters.</span>

<span class="cm">   0.32         31.08-98        IRQ was never freed if open/close</span>
<span class="cm">                                pair wasn&#39;t called. Now fixed.</span>

<span class="cm">   0.33         10.09-98        When eth16i_open() was called after</span>
<span class="cm">                                eth16i_close() chip never recovered.</span>
<span class="cm">				Now more shallow reset is made on</span>
<span class="cm">				close.</span>

<span class="cm">   0.34         29.06-99	Fixed one bad #ifdef.</span>
<span class="cm">				Changed ioaddr -&gt; io for consistency</span>

<span class="cm">   0.35         01.07-99        transmit,-receive bytes were never</span>
<span class="cm">                                updated in stats.</span>

<span class="cm">   Bugs:</span>
<span class="cm">	In some cases the media interface autoprobing code doesn&#39;t find</span>
<span class="cm">	the correct interface type. In this case you can</span>
<span class="cm">	manually choose the interface type in DOS with E16IC.EXE which is</span>
<span class="cm">	configuration software for EtherTeam16i and EtherTeam32 cards.</span>
<span class="cm">	This is also true for IRQ setting. You cannot use module</span>
<span class="cm">	parameter to configure IRQ of the card (yet).</span>

<span class="cm">   To do:</span>
<span class="cm">	- Real multicast support</span>
<span class="cm">	- Rewrite the media interface autoprobing code. Its _horrible_ !</span>
<span class="cm">	- Possibly merge all the MB86965 specific code to external</span>
<span class="cm">	  module for use by eth16.c and Donald&#39;s at1700.c</span>
<span class="cm">	- IRQ configuration with module parameter. I will do</span>
<span class="cm">	  this when i will get enough info about setting</span>
<span class="cm">	  irq without configuration utility.</span>
<span class="cm">*/</span>

<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">version</span> <span class="o">=</span>
    <span class="s">&quot;eth16i.c: v0.35 01-Jul-1999 Mika Kuoppala (miku@iki.fi)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/fcntl.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/ioport.h&gt;</span>
<span class="cp">#include &lt;linux/in.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/spinlock.h&gt;</span>
<span class="cp">#include &lt;linux/netdevice.h&gt;</span>
<span class="cp">#include &lt;linux/etherdevice.h&gt;</span>
<span class="cp">#include &lt;linux/skbuff.h&gt;</span>
<span class="cp">#include &lt;linux/bitops.h&gt;</span>
<span class="cp">#include &lt;linux/jiffies.h&gt;</span>
<span class="cp">#include &lt;linux/io.h&gt;</span>

<span class="cp">#include &lt;asm/dma.h&gt;</span>



<span class="cm">/* Few macros */</span>
<span class="cp">#define BITSET(ioaddr, bnum)   ((outb(((inb(ioaddr)) | (bnum)), ioaddr)))</span>
<span class="cp">#define BITCLR(ioaddr, bnum)   ((outb(((inb(ioaddr)) &amp; (~(bnum))), ioaddr)))</span>

<span class="cm">/* This is the I/O address space for Etherteam 16i adapter. */</span>
<span class="cp">#define ETH16I_IO_EXTENT       32</span>

<span class="cm">/* Ticks before deciding that transmit has timed out */</span>
<span class="cp">#define TX_TIMEOUT             (400*HZ/1000)</span>

<span class="cm">/* Maximum loop count when receiving packets */</span>
<span class="cp">#define MAX_RX_LOOP            20</span>

<span class="cm">/* Some interrupt masks */</span>
<span class="cp">#define ETH16I_INTR_ON	       0xef8a       </span><span class="cm">/* Higher is receive mask */</span><span class="cp"></span>
<span class="cp">#define ETH16I_INTR_OFF	       0x0000</span>

<span class="cm">/* Buffers header status byte meanings */</span>
<span class="cp">#define PKT_GOOD               BIT(5)</span>
<span class="cp">#define PKT_GOOD_RMT           BIT(4)</span>
<span class="cp">#define PKT_SHORT              BIT(3)</span>
<span class="cp">#define PKT_ALIGN_ERR          BIT(2)</span>
<span class="cp">#define PKT_CRC_ERR            BIT(1)</span>
<span class="cp">#define PKT_RX_BUF_OVERFLOW    BIT(0)</span>

<span class="cm">/* Transmit status register (DLCR0) */</span>
<span class="cp">#define TX_STATUS_REG          0</span>
<span class="cp">#define TX_DONE                BIT(7)</span>
<span class="cp">#define NET_BUSY               BIT(6)</span>
<span class="cp">#define TX_PKT_RCD             BIT(5)</span>
<span class="cp">#define CR_LOST                BIT(4)</span>
<span class="cp">#define TX_JABBER_ERR	       BIT(3)</span>
<span class="cp">#define COLLISION              BIT(2)</span>
<span class="cp">#define COLLISIONS_16          BIT(1)</span>

<span class="cm">/* Receive status register (DLCR1) */</span>
<span class="cp">#define RX_STATUS_REG          1</span>
<span class="cp">#define RX_PKT                 BIT(7)  </span><span class="cm">/* Packet received */</span><span class="cp"></span>
<span class="cp">#define BUS_RD_ERR             BIT(6)</span>
<span class="cp">#define SHORT_PKT_ERR          BIT(3)</span>
<span class="cp">#define ALIGN_ERR              BIT(2)</span>
<span class="cp">#define CRC_ERR                BIT(1)</span>
<span class="cp">#define RX_BUF_OVERFLOW        BIT(0)</span>

<span class="cm">/* Transmit Interrupt Enable Register (DLCR2) */</span>
<span class="cp">#define TX_INTR_REG            2</span>
<span class="cp">#define TX_INTR_DONE           BIT(7)</span>
<span class="cp">#define TX_INTR_COL            BIT(2)</span>
<span class="cp">#define TX_INTR_16_COL         BIT(1)</span>

<span class="cm">/* Receive Interrupt Enable Register (DLCR3) */</span>
<span class="cp">#define RX_INTR_REG            3</span>
<span class="cp">#define RX_INTR_RECEIVE        BIT(7)</span>
<span class="cp">#define RX_INTR_SHORT_PKT      BIT(3)</span>
<span class="cp">#define RX_INTR_CRC_ERR        BIT(1)</span>
<span class="cp">#define RX_INTR_BUF_OVERFLOW   BIT(0)</span>

<span class="cm">/* Transmit Mode Register (DLCR4) */</span>
<span class="cp">#define TRANSMIT_MODE_REG      4</span>
<span class="cp">#define LOOPBACK_CONTROL       BIT(1)</span>
<span class="cp">#define CONTROL_OUTPUT         BIT(2)</span>

<span class="cm">/* Receive Mode Register (DLCR5) */</span>
<span class="cp">#define RECEIVE_MODE_REG       5</span>
<span class="cp">#define RX_BUFFER_EMPTY        BIT(6)</span>
<span class="cp">#define ACCEPT_BAD_PACKETS     BIT(5)</span>
<span class="cp">#define RECEIVE_SHORT_ADDR     BIT(4)</span>
<span class="cp">#define ACCEPT_SHORT_PACKETS   BIT(3)</span>
<span class="cp">#define REMOTE_RESET           BIT(2)</span>

<span class="cp">#define ADDRESS_FILTER_MODE    BIT(1) | BIT(0)</span>
<span class="cp">#define REJECT_ALL             0</span>
<span class="cp">#define ACCEPT_ALL             3</span>
<span class="cp">#define MODE_1                 1            </span><span class="cm">/* NODE ID, BC, MC, 2-24th bit */</span><span class="cp"></span>
<span class="cp">#define MODE_2                 2            </span><span class="cm">/* NODE ID, BC, MC, Hash Table */</span><span class="cp"></span>

<span class="cm">/* Configuration Register 0 (DLCR6) */</span>
<span class="cp">#define CONFIG_REG_0           6</span>
<span class="cp">#define DLC_EN                 BIT(7)</span>
<span class="cp">#define SRAM_CYCLE_TIME_100NS  BIT(6)</span>
<span class="cp">#define SYSTEM_BUS_WIDTH_8     BIT(5)       </span><span class="cm">/* 1 = 8bit, 0 = 16bit */</span><span class="cp"></span>
<span class="cp">#define BUFFER_WIDTH_8         BIT(4)       </span><span class="cm">/* 1 = 8bit, 0 = 16bit */</span><span class="cp"></span>
<span class="cp">#define TBS1                   BIT(3)</span>
<span class="cp">#define TBS0                   BIT(2)</span>
<span class="cp">#define SRAM_BS1               BIT(1)       </span><span class="cm">/* 00=8kb,  01=16kb  */</span><span class="cp"></span>
<span class="cp">#define SRAM_BS0               BIT(0)       </span><span class="cm">/* 10=32kb, 11=64kb  */</span><span class="cp"></span>

<span class="cp">#ifndef ETH16I_TX_BUF_SIZE                   </span><span class="cm">/* 0 = 2kb, 1 = 4kb  */</span><span class="cp"></span>
<span class="cp">#define ETH16I_TX_BUF_SIZE     3             </span><span class="cm">/* 2 = 8kb, 3 = 16kb */</span><span class="cp"></span>
<span class="cp">#endif</span>
<span class="cp">#define TX_BUF_1x2048          0</span>
<span class="cp">#define TX_BUF_2x2048          1</span>
<span class="cp">#define TX_BUF_2x4098          2</span>
<span class="cp">#define TX_BUF_2x8192          3</span>

<span class="cm">/* Configuration Register 1 (DLCR7) */</span>
<span class="cp">#define CONFIG_REG_1           7</span>
<span class="cp">#define POWERUP                BIT(5)</span>

<span class="cm">/* Transmit start register */</span>
<span class="cp">#define TRANSMIT_START_REG     10</span>
<span class="cp">#define TRANSMIT_START_RB      2</span>
<span class="cp">#define TX_START               BIT(7)       </span><span class="cm">/* Rest of register bit indicate*/</span><span class="cp"></span>
                                            <span class="cm">/* number of packets in tx buffer*/</span>
<span class="cm">/* Node ID registers (DLCR8-13) */</span>
<span class="cp">#define NODE_ID_0              8</span>
<span class="cp">#define NODE_ID_RB             0</span>

<span class="cm">/* Hash Table registers (HT8-15) */</span>
<span class="cp">#define HASH_TABLE_0           8</span>
<span class="cp">#define HASH_TABLE_RB          1</span>

<span class="cm">/* Buffer memory ports */</span>
<span class="cp">#define BUFFER_MEM_PORT_LB     8</span>
<span class="cp">#define DATAPORT               BUFFER_MEM_PORT_LB</span>
<span class="cp">#define BUFFER_MEM_PORT_HB     9</span>

<span class="cm">/* 16 Collision control register (BMPR11) */</span>
<span class="cp">#define COL_16_REG             11</span>
<span class="cp">#define HALT_ON_16             0x00</span>
<span class="cp">#define RETRANS_AND_HALT_ON_16 0x02</span>

<span class="cm">/* Maximum number of attempts to send after 16 concecutive collisions */</span>
<span class="cp">#define MAX_COL_16	       10</span>

<span class="cm">/* DMA Burst and Transceiver Mode Register (BMPR13) */</span>
<span class="cp">#define TRANSCEIVER_MODE_REG   13</span>
<span class="cp">#define TRANSCEIVER_MODE_RB    2</span>
<span class="cp">#define IO_BASE_UNLOCK	       BIT(7)</span>
<span class="cp">#define LOWER_SQUELCH_TRESH    BIT(6)</span>
<span class="cp">#define LINK_TEST_DISABLE      BIT(5)</span>
<span class="cp">#define AUI_SELECT             BIT(4)</span>
<span class="cp">#define DIS_AUTO_PORT_SEL      BIT(3)</span>

<span class="cm">/* Filter Self Receive Register (BMPR14)  */</span>
<span class="cp">#define FILTER_SELF_RX_REG     14</span>
<span class="cp">#define SKIP_RX_PACKET         BIT(2)</span>
<span class="cp">#define FILTER_SELF_RECEIVE    BIT(0)</span>

<span class="cm">/* EEPROM Control Register (BMPR 16) */</span>
<span class="cp">#define EEPROM_CTRL_REG        16</span>

<span class="cm">/* EEPROM Data Register (BMPR 17) */</span>
<span class="cp">#define EEPROM_DATA_REG        17</span>

<span class="cm">/* NMC93CSx6 EEPROM Control Bits */</span>
<span class="cp">#define CS_0                   0x00</span>
<span class="cp">#define CS_1                   0x20</span>
<span class="cp">#define SK_0                   0x00</span>
<span class="cp">#define SK_1                   0x40</span>
<span class="cp">#define DI_0                   0x00</span>
<span class="cp">#define DI_1                   0x80</span>

<span class="cm">/* NMC93CSx6 EEPROM Instructions */</span>
<span class="cp">#define EEPROM_READ            0x80</span>

<span class="cm">/* NMC93CSx6 EEPROM Addresses */</span>
<span class="cp">#define E_NODEID_0             0x02</span>
<span class="cp">#define E_NODEID_1             0x03</span>
<span class="cp">#define E_NODEID_2             0x04</span>
<span class="cp">#define E_PORT_SELECT          0x14</span>
  <span class="cp">#define E_PORT_BNC           0x00</span>
  <span class="cp">#define E_PORT_DIX           0x01</span>
  <span class="cp">#define E_PORT_TP            0x02</span>
  <span class="cp">#define E_PORT_AUTO          0x03</span>
  <span class="cp">#define E_PORT_FROM_EPROM    0x04</span>
<span class="cp">#define E_PRODUCT_CFG          0x30</span>


<span class="cm">/* Macro to slow down io between EEPROM clock transitions */</span>
<span class="cp">#define eeprom_slow_io() do { int _i = 40; while(--_i &gt; 0) { inb(0x80); }}while(0)</span>

<span class="cm">/* Jumperless Configuration Register (BMPR19) */</span>
<span class="cp">#define JUMPERLESS_CONFIG      19</span>

<span class="cm">/* ID ROM registers, writing to them also resets some parts of chip */</span>
<span class="cp">#define ID_ROM_0               24</span>
<span class="cp">#define ID_ROM_7               31</span>
<span class="cp">#define RESET                  ID_ROM_0</span>

<span class="cm">/* This is the I/O address list to be probed when seeking the card */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">eth16i_portlist</span><span class="p">[]</span> <span class="n">__initdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mh">0x260</span><span class="p">,</span> <span class="mh">0x280</span><span class="p">,</span> <span class="mh">0x2A0</span><span class="p">,</span> <span class="mh">0x240</span><span class="p">,</span> <span class="mh">0x340</span><span class="p">,</span> <span class="mh">0x320</span><span class="p">,</span> <span class="mh">0x380</span><span class="p">,</span> <span class="mh">0x300</span><span class="p">,</span> <span class="mi">0</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">eth32i_portlist</span><span class="p">[]</span> <span class="n">__initdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mh">0x1000</span><span class="p">,</span> <span class="mh">0x2000</span><span class="p">,</span> <span class="mh">0x3000</span><span class="p">,</span> <span class="mh">0x4000</span><span class="p">,</span> <span class="mh">0x5000</span><span class="p">,</span> <span class="mh">0x6000</span><span class="p">,</span> <span class="mh">0x7000</span><span class="p">,</span> <span class="mh">0x8000</span><span class="p">,</span>
	<span class="mh">0x9000</span><span class="p">,</span> <span class="mh">0xA000</span><span class="p">,</span> <span class="mh">0xB000</span><span class="p">,</span> <span class="mh">0xC000</span><span class="p">,</span> <span class="mh">0xD000</span><span class="p">,</span> <span class="mh">0xE000</span><span class="p">,</span> <span class="mh">0xF000</span><span class="p">,</span> <span class="mi">0</span>
<span class="p">};</span>

<span class="cm">/* This is the Interrupt lookup table for Eth16i card */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">eth16i_irqmap</span><span class="p">[]</span> <span class="n">__initdata</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">0</span> <span class="p">};</span>
<span class="cp">#define NUM_OF_ISA_IRQS    4</span>

<span class="cm">/* This is the Interrupt lookup table for Eth32i card */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">eth32i_irqmap</span><span class="p">[]</span> <span class="n">__initdata</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">0</span> <span class="p">};</span>
<span class="cp">#define EISA_IRQ_REG	0xc89</span>
<span class="cp">#define NUM_OF_EISA_IRQS   8</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">eth16i_tx_buf_map</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">2048</span><span class="p">,</span> <span class="mi">2048</span><span class="p">,</span> <span class="mi">4096</span><span class="p">,</span> <span class="mi">8192</span> <span class="p">};</span>

<span class="cm">/* Use 0 for production, 1 for verification, &gt;2 for debug */</span>
<span class="cp">#ifndef ETH16I_DEBUG</span>
<span class="cp">#define ETH16I_DEBUG 0</span>
<span class="cp">#endif</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">eth16i_debug</span> <span class="o">=</span> <span class="n">ETH16I_DEBUG</span><span class="p">;</span>

<span class="cm">/* Information for each board */</span>

<span class="k">struct</span> <span class="n">eth16i_local</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>     <span class="n">tx_started</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>     <span class="n">tx_buf_busy</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span>    <span class="n">tx_queue</span><span class="p">;</span>  <span class="cm">/* Number of packets in transmit buffer */</span>
	<span class="kt">unsigned</span> <span class="kt">short</span>    <span class="n">tx_queue_len</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>      <span class="n">tx_buf_size</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>     <span class="n">open_time</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>     <span class="n">tx_buffered_packets</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>     <span class="n">tx_buffered_bytes</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>     <span class="n">col_16</span><span class="p">;</span>
	<span class="n">spinlock_t</span>	  <span class="n">lock</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/* Function prototypes */</span>

<span class="k">static</span> <span class="kt">int</span>     <span class="n">eth16i_probe1</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ioaddr</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>     <span class="n">eth16i_check_signature</span><span class="p">(</span><span class="kt">int</span> <span class="n">ioaddr</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>     <span class="n">eth16i_probe_port</span><span class="p">(</span><span class="kt">int</span> <span class="n">ioaddr</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>    <span class="n">eth16i_set_port</span><span class="p">(</span><span class="kt">int</span> <span class="n">ioaddr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">porttype</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>     <span class="n">eth16i_send_probe_packet</span><span class="p">(</span><span class="kt">int</span> <span class="n">ioaddr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">b</span><span class="p">,</span> <span class="kt">int</span> <span class="n">l</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>     <span class="n">eth16i_receive_probe_packet</span><span class="p">(</span><span class="kt">int</span> <span class="n">ioaddr</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>     <span class="n">eth16i_get_irq</span><span class="p">(</span><span class="kt">int</span> <span class="n">ioaddr</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>     <span class="n">eth16i_read_eeprom</span><span class="p">(</span><span class="kt">int</span> <span class="n">ioaddr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">offset</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>     <span class="n">eth16i_read_eeprom_word</span><span class="p">(</span><span class="kt">int</span> <span class="n">ioaddr</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>    <span class="n">eth16i_eeprom_cmd</span><span class="p">(</span><span class="kt">int</span> <span class="n">ioaddr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">command</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>     <span class="n">eth16i_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>     <span class="n">eth16i_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="n">netdev_tx_t</span> <span class="n">eth16i_tx</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>    <span class="n">eth16i_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>    <span class="n">eth16i_timeout</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="n">eth16i_interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>    <span class="n">eth16i_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>    <span class="n">eth16i_timeout</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>    <span class="n">eth16i_skip_packet</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>    <span class="n">eth16i_multicast</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>    <span class="n">eth16i_select_regbank</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">regbank</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ioaddr</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>    <span class="n">eth16i_initialize</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">boot</span><span class="p">);</span>

<span class="cp">#if 0</span><span class="c"></span>
<span class="c">static int     eth16i_set_irq(struct net_device *dev);</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef MODULE</span>
<span class="k">static</span> <span class="n">ushort</span>  <span class="n">eth16i_parse_mediatype</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">s</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">char</span> <span class="n">cardname</span><span class="p">[]</span> <span class="n">__initdata</span> <span class="o">=</span> <span class="s">&quot;ICL EtherTeam 16i/32&quot;</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">do_eth16i_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ioaddr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">base_addr</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>

	<span class="k">if</span><span class="p">(</span><span class="n">eth16i_debug</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;Probing started for %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cardname</span><span class="p">);</span>

	<span class="k">if</span><span class="p">(</span><span class="n">base_addr</span> <span class="o">&gt;</span> <span class="mh">0x1ff</span><span class="p">)</span>           <span class="cm">/* Check only single location */</span>
		<span class="k">return</span> <span class="n">eth16i_probe1</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">base_addr</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">base_addr</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>         <span class="cm">/* Don&#39;t probe at all */</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>

	<span class="cm">/* Seek card from the ISA io address space */</span>
	<span class="k">for</span><span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="p">(</span><span class="n">ioaddr</span> <span class="o">=</span> <span class="n">eth16i_portlist</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span><span class="p">(</span><span class="n">eth16i_probe1</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ioaddr</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Seek card from the EISA io address space */</span>
	<span class="k">for</span><span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="p">(</span><span class="n">ioaddr</span> <span class="o">=</span> <span class="n">eth32i_portlist</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span><span class="p">(</span><span class="n">eth16i_probe1</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ioaddr</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifndef MODULE</span>
<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span> <span class="n">__init</span> <span class="nf">eth16i_probe</span><span class="p">(</span><span class="kt">int</span> <span class="n">unit</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">alloc_etherdev</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">eth16i_local</span><span class="p">));</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ENOMEM</span><span class="p">);</span>

	<span class="n">sprintf</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;eth%d&quot;</span><span class="p">,</span> <span class="n">unit</span><span class="p">);</span>
	<span class="n">netdev_boot_setup_check</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">do_eth16i_probe</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">dev</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="n">free_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="n">err</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">net_device_ops</span> <span class="n">eth16i_netdev_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">ndo_open</span>               <span class="o">=</span> <span class="n">eth16i_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_stop</span>               <span class="o">=</span> <span class="n">eth16i_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_start_xmit</span>    	<span class="o">=</span> <span class="n">eth16i_tx</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_set_rx_mode</span>	<span class="o">=</span> <span class="n">eth16i_multicast</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_tx_timeout</span> 	<span class="o">=</span> <span class="n">eth16i_timeout</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_change_mtu</span>		<span class="o">=</span> <span class="n">eth_change_mtu</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_set_mac_address</span> 	<span class="o">=</span> <span class="n">eth_mac_addr</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_validate_addr</span>	<span class="o">=</span> <span class="n">eth_validate_addr</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">eth16i_probe1</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ioaddr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">eth16i_local</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">static</span> <span class="kt">unsigned</span> <span class="n">version_printed</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>

	<span class="cm">/* Let&#39;s grab the region */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">request_region</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">ETH16I_IO_EXTENT</span><span class="p">,</span> <span class="n">cardname</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	  The MB86985 chip has on register which holds information in which</span>
<span class="cm">	  io address the chip lies. First read this register and compare</span>
<span class="cm">	  it to our current io address and if match then this could</span>
<span class="cm">	  be our chip.</span>
<span class="cm">	  */</span>

	<span class="k">if</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">&lt;</span> <span class="mh">0x1000</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span><span class="p">(</span><span class="n">eth16i_portlist</span><span class="p">[(</span><span class="n">inb</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">JUMPERLESS_CONFIG</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x07</span><span class="p">)]</span>
		   <span class="o">!=</span> <span class="n">ioaddr</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Now we will go a bit deeper and try to find the chip&#39;s signature */</span>

	<span class="k">if</span><span class="p">(</span><span class="n">eth16i_check_signature</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	   Now it seems that we have found a ethernet chip in this particular</span>
<span class="cm">	   ioaddr. The MB86985 chip has this feature, that when you read a</span>
<span class="cm">	   certain register it will increase it&#39;s io base address to next</span>
<span class="cm">	   configurable slot. Now when we have found the chip, first thing is</span>
<span class="cm">	   to make sure that the chip&#39;s ioaddr will hold still here.</span>
<span class="cm">	   */</span>

	<span class="n">eth16i_select_regbank</span><span class="p">(</span><span class="n">TRANSCEIVER_MODE_RB</span><span class="p">,</span> <span class="n">ioaddr</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="mh">0x00</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">TRANSCEIVER_MODE_REG</span><span class="p">);</span>

	<span class="n">outb</span><span class="p">(</span><span class="mh">0x00</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">RESET</span><span class="p">);</span>             <span class="cm">/* Reset some parts of chip */</span>
	<span class="n">BITSET</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">CONFIG_REG_0</span><span class="p">,</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">7</span><span class="p">));</span>  <span class="cm">/* Disable the data link */</span>

	<span class="k">if</span><span class="p">(</span> <span class="p">(</span><span class="n">eth16i_debug</span> <span class="o">&amp;</span> <span class="n">version_printed</span><span class="o">++</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">version</span><span class="p">);</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">=</span> <span class="n">ioaddr</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">eth16i_get_irq</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">);</span>

	<span class="cm">/* Try to obtain interrupt vector */</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">retval</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">eth16i_interrupt</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">cardname</span><span class="p">,</span> <span class="n">dev</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s at %#3x, but is unusable due to conflicting IRQ %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">cardname</span><span class="p">,</span> <span class="n">ioaddr</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: %s at %#3x, IRQ %d, &quot;</span><span class="p">,</span>
	       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">cardname</span><span class="p">,</span> <span class="n">ioaddr</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>


	<span class="cm">/* Now we will have to lock the chip&#39;s io address */</span>
	<span class="n">eth16i_select_regbank</span><span class="p">(</span><span class="n">TRANSCEIVER_MODE_RB</span><span class="p">,</span> <span class="n">ioaddr</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="mh">0x38</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">TRANSCEIVER_MODE_REG</span><span class="p">);</span>

	<span class="n">eth16i_initialize</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span> <span class="cm">/* Initialize rest of the chip&#39;s registers */</span>

	<span class="cm">/* Now let&#39;s same some energy by shutting down the chip ;) */</span>
	<span class="n">BITCLR</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">CONFIG_REG_1</span><span class="p">,</span> <span class="n">POWERUP</span><span class="p">);</span>

	<span class="cm">/* Initialize the device structure */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">netdev_ops</span>         <span class="o">=</span> <span class="o">&amp;</span><span class="n">eth16i_netdev_ops</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">watchdog_timeo</span>	<span class="o">=</span> <span class="n">TX_TIMEOUT</span><span class="p">;</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">register_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">out1:</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="n">release_region</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">ETH16I_IO_EXTENT</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">eth16i_initialize</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">boot</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ioaddr</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">node_w</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">node_byte</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Setup station address */</span>
	<span class="n">eth16i_select_regbank</span><span class="p">(</span><span class="n">NODE_ID_RB</span><span class="p">,</span> <span class="n">ioaddr</span><span class="p">);</span>
	<span class="k">for</span><span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">3</span> <span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">node_val</span> <span class="o">=</span> <span class="n">eth16i_read_eeprom</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">E_NODEID_0</span> <span class="o">+</span> <span class="n">i</span><span class="p">);</span>
		<span class="p">((</span><span class="kt">unsigned</span> <span class="kt">short</span> <span class="o">*</span><span class="p">)</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">)[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ntohs</span><span class="p">(</span><span class="n">node_val</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">for</span><span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">outb</span><span class="p">(</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">)[</span><span class="n">i</span><span class="p">],</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">NODE_ID_0</span> <span class="o">+</span> <span class="n">i</span><span class="p">);</span>
		<span class="k">if</span><span class="p">(</span><span class="n">boot</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%02x&quot;</span><span class="p">,</span> <span class="n">inb</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">NODE_ID_0</span> <span class="o">+</span> <span class="n">i</span><span class="p">));</span>
			<span class="k">if</span><span class="p">(</span><span class="n">i</span> <span class="o">!=</span> <span class="mi">5</span><span class="p">)</span>
				<span class="n">printk</span><span class="p">(</span><span class="s">&quot;:&quot;</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Now we will set multicast addresses to accept none */</span>
	<span class="n">eth16i_select_regbank</span><span class="p">(</span><span class="n">HASH_TABLE_RB</span><span class="p">,</span> <span class="n">ioaddr</span><span class="p">);</span>
	<span class="k">for</span><span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">outb</span><span class="p">(</span><span class="mh">0x00</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">HASH_TABLE_0</span> <span class="o">+</span> <span class="n">i</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	  Now let&#39;s disable the transmitter and receiver, set the buffer ram</span>
<span class="cm">	  cycle time, bus width and buffer data path width. Also we shall</span>
<span class="cm">	  set transmit buffer size and total buffer size.</span>
<span class="cm">	  */</span>

	<span class="n">eth16i_select_regbank</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">ioaddr</span><span class="p">);</span>

	<span class="n">node_byte</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">node_w</span> <span class="o">=</span> <span class="n">eth16i_read_eeprom</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">E_PRODUCT_CFG</span><span class="p">);</span>

	<span class="k">if</span><span class="p">(</span> <span class="p">(</span><span class="n">node_w</span> <span class="o">&amp;</span> <span class="mh">0xFF00</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x0800</span><span class="p">)</span>
		<span class="n">node_byte</span> <span class="o">|=</span> <span class="n">BUFFER_WIDTH_8</span><span class="p">;</span>

	<span class="n">node_byte</span> <span class="o">|=</span> <span class="n">SRAM_BS1</span><span class="p">;</span>

	<span class="k">if</span><span class="p">(</span> <span class="p">(</span><span class="n">node_w</span> <span class="o">&amp;</span> <span class="mh">0x00FF</span><span class="p">)</span> <span class="o">==</span> <span class="mi">64</span><span class="p">)</span>
		<span class="n">node_byte</span> <span class="o">|=</span> <span class="n">SRAM_BS0</span><span class="p">;</span>

	<span class="n">node_byte</span> <span class="o">|=</span> <span class="n">DLC_EN</span> <span class="o">|</span> <span class="n">SRAM_CYCLE_TIME_100NS</span> <span class="o">|</span> <span class="p">(</span><span class="n">ETH16I_TX_BUF_SIZE</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">);</span>

	<span class="n">outb</span><span class="p">(</span><span class="n">node_byte</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">CONFIG_REG_0</span><span class="p">);</span>

	<span class="cm">/* We shall halt the transmitting, if 16 collisions are detected */</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">HALT_ON_16</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">COL_16_REG</span><span class="p">);</span>

<span class="cp">#ifdef MODULE</span>
	<span class="cm">/* if_port already set by init_module() */</span>
<span class="cp">#else</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">if_port</span> <span class="o">=</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mem_start</span> <span class="o">&lt;</span> <span class="n">E_PORT_FROM_EPROM</span><span class="p">)</span> <span class="o">?</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">mem_start</span> <span class="o">:</span> <span class="n">E_PORT_FROM_EPROM</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="cm">/* Set interface port type */</span>
	<span class="k">if</span><span class="p">(</span><span class="n">boot</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="k">const</span> <span class="n">porttype</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
			<span class="s">&quot;BNC&quot;</span><span class="p">,</span> <span class="s">&quot;DIX&quot;</span><span class="p">,</span> <span class="s">&quot;TP&quot;</span><span class="p">,</span> <span class="s">&quot;AUTO&quot;</span><span class="p">,</span> <span class="s">&quot;FROM_EPROM&quot;</span>
		<span class="p">};</span>

		<span class="k">switch</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">if_port</span><span class="p">)</span>
		<span class="p">{</span>

		<span class="k">case</span> <span class="n">E_PORT_FROM_EPROM</span>:
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">if_port</span> <span class="o">=</span> <span class="n">eth16i_read_eeprom</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">E_PORT_SELECT</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">E_PORT_AUTO</span>:
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">if_port</span> <span class="o">=</span> <span class="n">eth16i_probe_port</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">E_PORT_BNC</span>:
		<span class="k">case</span> <span class="n">E_PORT_TP</span>:
		<span class="k">case</span> <span class="n">E_PORT_DIX</span>:
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">printk</span><span class="p">(</span><span class="s">&quot; %s interface.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">porttype</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">if_port</span><span class="p">]);</span>

		<span class="n">eth16i_set_port</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">if_port</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Set Receive Mode to normal operation */</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">MODE_2</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">RECEIVE_MODE_REG</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">eth16i_probe_port</span><span class="p">(</span><span class="kt">int</span> <span class="n">ioaddr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retcode</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">dummy_packet</span><span class="p">[</span><span class="mi">64</span><span class="p">];</span>

	<span class="cm">/* Powerup the chip */</span>
	<span class="n">outb</span><span class="p">(</span><span class="mh">0xc0</span> <span class="o">|</span> <span class="n">POWERUP</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">CONFIG_REG_1</span><span class="p">);</span>

	<span class="n">BITSET</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">CONFIG_REG_0</span><span class="p">,</span> <span class="n">DLC_EN</span><span class="p">);</span>

	<span class="n">eth16i_select_regbank</span><span class="p">(</span><span class="n">NODE_ID_RB</span><span class="p">,</span> <span class="n">ioaddr</span><span class="p">);</span>

	<span class="k">for</span><span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dummy_packet</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">NODE_ID_0</span> <span class="o">+</span> <span class="n">i</span><span class="p">);</span>
		<span class="n">dummy_packet</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">NODE_ID_0</span> <span class="o">+</span> <span class="n">i</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">dummy_packet</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="n">dummy_packet</span><span class="p">[</span><span class="mi">13</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x04</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">dummy_packet</span> <span class="o">+</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">dummy_packet</span><span class="p">)</span> <span class="o">-</span> <span class="mi">14</span><span class="p">);</span>

	<span class="n">eth16i_select_regbank</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">ioaddr</span><span class="p">);</span>

	<span class="k">for</span><span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BITSET</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">CONFIG_REG_0</span><span class="p">,</span> <span class="n">DLC_EN</span><span class="p">);</span>
		<span class="n">BITCLR</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">CONFIG_REG_0</span><span class="p">,</span> <span class="n">DLC_EN</span><span class="p">);</span>
		<span class="n">eth16i_set_port</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>

		<span class="k">if</span><span class="p">(</span><span class="n">eth16i_debug</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;Set port number %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>

		<span class="n">retcode</span> <span class="o">=</span> <span class="n">eth16i_send_probe_packet</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">dummy_packet</span><span class="p">,</span> <span class="mi">64</span><span class="p">);</span>
		<span class="k">if</span><span class="p">(</span><span class="n">retcode</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">retcode</span> <span class="o">=</span> <span class="n">eth16i_receive_probe_packet</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">);</span>
			<span class="k">if</span><span class="p">(</span><span class="n">retcode</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span><span class="p">(</span><span class="n">eth16i_debug</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
					<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;Eth16i interface port found at %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
				<span class="k">return</span> <span class="n">i</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span><span class="p">(</span><span class="n">eth16i_debug</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;TRANSMIT_DONE timeout when probing interface port</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span><span class="p">(</span> <span class="n">eth16i_debug</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;Using default port</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">E_PORT_BNC</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">eth16i_set_port</span><span class="p">(</span><span class="kt">int</span> <span class="n">ioaddr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">porttype</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">temp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">eth16i_select_regbank</span><span class="p">(</span><span class="n">TRANSCEIVER_MODE_RB</span><span class="p">,</span> <span class="n">ioaddr</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">LOOPBACK_CONTROL</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">TRANSMIT_MODE_REG</span><span class="p">);</span>

	<span class="n">temp</span> <span class="o">|=</span> <span class="n">DIS_AUTO_PORT_SEL</span><span class="p">;</span>

	<span class="k">switch</span><span class="p">(</span><span class="n">porttype</span><span class="p">)</span> <span class="p">{</span>

	<span class="k">case</span> <span class="n">E_PORT_BNC</span> :
		<span class="n">temp</span> <span class="o">|=</span> <span class="n">AUI_SELECT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">E_PORT_TP</span> :
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">E_PORT_DIX</span> :
		<span class="n">temp</span> <span class="o">|=</span> <span class="n">AUI_SELECT</span><span class="p">;</span>
		<span class="n">BITSET</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">TRANSMIT_MODE_REG</span><span class="p">,</span> <span class="n">CONTROL_OUTPUT</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">outb</span><span class="p">(</span><span class="n">temp</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">TRANSCEIVER_MODE_REG</span><span class="p">);</span>

	<span class="k">if</span><span class="p">(</span><span class="n">eth16i_debug</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;TRANSMIT_MODE_REG = %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">inb</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">TRANSMIT_MODE_REG</span><span class="p">));</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;TRANSCEIVER_MODE_REG = %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">inb</span><span class="p">(</span><span class="n">ioaddr</span><span class="o">+</span><span class="n">TRANSCEIVER_MODE_REG</span><span class="p">));</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">eth16i_send_probe_packet</span><span class="p">(</span><span class="kt">int</span> <span class="n">ioaddr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">b</span><span class="p">,</span> <span class="kt">int</span> <span class="n">l</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">starttime</span><span class="p">;</span>

	<span class="n">outb</span><span class="p">(</span><span class="mh">0xff</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">TX_STATUS_REG</span><span class="p">);</span>

	<span class="n">outw</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">DATAPORT</span><span class="p">);</span>
	<span class="n">outsw</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">DATAPORT</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span> <span class="o">*</span><span class="p">)</span><span class="n">b</span><span class="p">,</span> <span class="p">(</span><span class="n">l</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">starttime</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">TX_START</span> <span class="o">|</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">TRANSMIT_START_REG</span><span class="p">);</span>

	<span class="k">while</span><span class="p">(</span> <span class="p">(</span><span class="n">inb</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">TX_STATUS_REG</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span><span class="p">(</span> <span class="n">time_after</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">starttime</span> <span class="o">+</span> <span class="n">TX_TIMEOUT</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">eth16i_receive_probe_packet</span><span class="p">(</span><span class="kt">int</span> <span class="n">ioaddr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">starttime</span><span class="p">;</span>

	<span class="n">starttime</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>

	<span class="k">while</span><span class="p">((</span><span class="n">inb</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">TX_STATUS_REG</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x20</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span><span class="p">(</span> <span class="n">time_after</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">starttime</span> <span class="o">+</span> <span class="n">TX_TIMEOUT</span><span class="p">))</span> <span class="p">{</span>

			<span class="k">if</span><span class="p">(</span><span class="n">eth16i_debug</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;Timeout occurred waiting transmit packet received</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">starttime</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
			<span class="k">while</span><span class="p">((</span><span class="n">inb</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">RX_STATUS_REG</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span><span class="p">(</span> <span class="n">time_after</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">starttime</span> <span class="o">+</span> <span class="n">TX_TIMEOUT</span><span class="p">))</span> <span class="p">{</span>
					<span class="k">if</span><span class="p">(</span><span class="n">eth16i_debug</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
						<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;Timeout occurred waiting receive packet</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
					<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>

			<span class="k">if</span><span class="p">(</span><span class="n">eth16i_debug</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;RECEIVE_PACKET</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* Found receive packet */</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span><span class="p">(</span><span class="n">eth16i_debug</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;TRANSMIT_PACKET_RECEIVED %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">inb</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">TX_STATUS_REG</span><span class="p">));</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;RX_STATUS_REG = %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">inb</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">RX_STATUS_REG</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* Return success */</span>
<span class="p">}</span>

<span class="cp">#if 0</span><span class="c"></span>
<span class="c">static int eth16i_set_irq(struct net_device* dev)</span>
<span class="c">{</span>
<span class="c">	const int ioaddr = dev-&gt;base_addr;</span>
<span class="c">	const int irq = dev-&gt;irq;</span>
<span class="c">	int i = 0;</span>

<span class="c">	if(ioaddr &lt; 0x1000) {</span>
<span class="c">		while(eth16i_irqmap[i] &amp;&amp; eth16i_irqmap[i] != irq)</span>
<span class="c">			i++;</span>

<span class="c">		if(i &lt; NUM_OF_ISA_IRQS) {</span>
<span class="c">			u8 cbyte = inb(ioaddr + JUMPERLESS_CONFIG);</span>
<span class="c">			cbyte = (cbyte &amp; 0x3F) | (i &lt;&lt; 6);</span>
<span class="c">			outb(cbyte, ioaddr + JUMPERLESS_CONFIG);</span>
<span class="c">			return 0;</span>
<span class="c">		}</span>
<span class="c">	}</span>
<span class="c">	else {</span>
<span class="c">		printk(KERN_NOTICE &quot;%s: EISA Interrupt cannot be set. Use EISA Configuration utility.\n&quot;, dev-&gt;name);</span>
<span class="c">	}</span>

<span class="c">	return -1;</span>

<span class="c">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">eth16i_get_irq</span><span class="p">(</span><span class="kt">int</span> <span class="n">ioaddr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">cbyte</span><span class="p">;</span>

	<span class="k">if</span><span class="p">(</span> <span class="n">ioaddr</span> <span class="o">&lt;</span> <span class="mh">0x1000</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cbyte</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">JUMPERLESS_CONFIG</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">eth16i_irqmap</span><span class="p">[((</span><span class="n">cbyte</span> <span class="o">&amp;</span> <span class="mh">0xC0</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span><span class="p">)];</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>  <span class="cm">/* Oh..the card is EISA so method getting IRQ different */</span>
		<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">cbyte</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">EISA_IRQ_REG</span><span class="p">);</span>
		<span class="k">while</span><span class="p">(</span> <span class="p">(</span><span class="n">cbyte</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cbyte</span> <span class="o">=</span> <span class="n">cbyte</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">index</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="n">eth32i_irqmap</span><span class="p">[</span><span class="n">index</span><span class="p">];</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">eth16i_check_signature</span><span class="p">(</span><span class="kt">int</span> <span class="n">ioaddr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">creg</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span> <span class="p">};</span>

	<span class="k">for</span><span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span> <span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">creg</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">TRANSMIT_MODE_REG</span> <span class="o">+</span> <span class="n">i</span><span class="p">);</span>

		<span class="k">if</span><span class="p">(</span><span class="n">eth16i_debug</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;eth16i: read signature byte %x at %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">creg</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
			       <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">TRANSMIT_MODE_REG</span> <span class="o">+</span> <span class="n">i</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">creg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="mh">0x0F</span><span class="p">;</span>      <span class="cm">/* Mask collision cnr */</span>
	<span class="n">creg</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="mh">0x7F</span><span class="p">;</span>      <span class="cm">/* Mask DCLEN bit */</span>

<span class="cp">#if 0</span><span class="c"></span>
<span class="c">	/*</span>
<span class="c">	   This was removed because the card was sometimes left to state</span>
<span class="c">	   from which it couldn&#39;t be find anymore. If there is need</span>
<span class="c">	   to more strict check still this have to be fixed.</span>
<span class="c">	   */</span>
<span class="c">	if( ! ((creg[0] == 0x06) &amp;&amp; (creg[1] == 0x41)) ) {</span>
<span class="c">		if(creg[1] != 0x42)</span>
<span class="c">			return -1;</span>
<span class="c">	}</span>
<span class="cp">#endif</span>

	<span class="k">if</span><span class="p">(</span> <span class="o">!</span><span class="p">((</span><span class="n">creg</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x36</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">creg</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xE0</span><span class="p">))</span> <span class="p">)</span> <span class="p">{</span>
		<span class="n">creg</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="mh">0x40</span><span class="p">;</span>
		<span class="n">creg</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="mh">0x03</span><span class="p">;</span>

		<span class="k">if</span><span class="p">(</span> <span class="o">!</span><span class="p">((</span><span class="n">creg</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x40</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">creg</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x00</span><span class="p">))</span> <span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span><span class="p">(</span><span class="n">eth16i_read_eeprom</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">E_NODEID_0</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span><span class="p">((</span><span class="n">eth16i_read_eeprom</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">E_NODEID_1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF00</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x4B00</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">eth16i_read_eeprom</span><span class="p">(</span><span class="kt">int</span> <span class="n">ioaddr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">data</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">eth16i_eeprom_cmd</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">EEPROM_READ</span> <span class="o">|</span> <span class="n">offset</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">CS_1</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">EEPROM_CTRL_REG</span><span class="p">);</span>
	<span class="n">data</span> <span class="o">=</span> <span class="n">eth16i_read_eeprom_word</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">CS_0</span> <span class="o">|</span> <span class="n">SK_0</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">EEPROM_CTRL_REG</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">data</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">eth16i_read_eeprom_word</span><span class="p">(</span><span class="kt">int</span> <span class="n">ioaddr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">data</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span><span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">outb</span><span class="p">(</span><span class="n">CS_1</span> <span class="o">|</span> <span class="n">SK_0</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">EEPROM_CTRL_REG</span><span class="p">);</span>
		<span class="n">eeprom_slow_io</span><span class="p">();</span>
		<span class="n">outb</span><span class="p">(</span><span class="n">CS_1</span> <span class="o">|</span> <span class="n">SK_1</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">EEPROM_CTRL_REG</span><span class="p">);</span>
		<span class="n">eeprom_slow_io</span><span class="p">();</span>
		<span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">((</span><span class="n">inb</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">EEPROM_DATA_REG</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">DI_1</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>

		<span class="n">eeprom_slow_io</span><span class="p">();</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">data</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">eth16i_eeprom_cmd</span><span class="p">(</span><span class="kt">int</span> <span class="n">ioaddr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">command</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">outb</span><span class="p">(</span><span class="n">CS_0</span> <span class="o">|</span> <span class="n">SK_0</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">EEPROM_CTRL_REG</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">DI_0</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">EEPROM_DATA_REG</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">CS_1</span> <span class="o">|</span> <span class="n">SK_0</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">EEPROM_CTRL_REG</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">DI_1</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">EEPROM_DATA_REG</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">CS_1</span> <span class="o">|</span> <span class="n">SK_1</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">EEPROM_CTRL_REG</span><span class="p">);</span>

	<span class="k">for</span><span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">short</span> <span class="n">cmd</span> <span class="o">=</span> <span class="p">(</span> <span class="p">(</span><span class="n">command</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">))</span> <span class="o">?</span> <span class="n">DI_1</span> <span class="o">:</span> <span class="n">DI_0</span> <span class="p">);</span>
		<span class="n">outb</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">EEPROM_DATA_REG</span><span class="p">);</span>
		<span class="n">outb</span><span class="p">(</span><span class="n">CS_1</span> <span class="o">|</span> <span class="n">SK_0</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">EEPROM_CTRL_REG</span><span class="p">);</span>
		<span class="n">eeprom_slow_io</span><span class="p">();</span>
		<span class="n">outb</span><span class="p">(</span><span class="n">CS_1</span> <span class="o">|</span> <span class="n">SK_1</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">EEPROM_CTRL_REG</span><span class="p">);</span>
		<span class="n">eeprom_slow_io</span><span class="p">();</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">eth16i_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">eth16i_local</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ioaddr</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>

	<span class="cm">/* Powerup the chip */</span>
	<span class="n">outb</span><span class="p">(</span><span class="mh">0xc0</span> <span class="o">|</span> <span class="n">POWERUP</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">CONFIG_REG_1</span><span class="p">);</span>

	<span class="cm">/* Initialize the chip */</span>
	<span class="n">eth16i_initialize</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* Set the transmit buffer size */</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_buf_size</span> <span class="o">=</span> <span class="n">eth16i_tx_buf_map</span><span class="p">[</span><span class="n">ETH16I_TX_BUF_SIZE</span> <span class="o">&amp;</span> <span class="mh">0x03</span><span class="p">];</span>

	<span class="k">if</span><span class="p">(</span><span class="n">eth16i_debug</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: transmit buffer size %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_buf_size</span><span class="p">);</span>

	<span class="cm">/* Now enable Transmitter and Receiver sections */</span>
	<span class="n">BITCLR</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">CONFIG_REG_0</span><span class="p">,</span> <span class="n">DLC_EN</span><span class="p">);</span>

	<span class="cm">/* Now switch to register bank 2, for run time operation */</span>
	<span class="n">eth16i_select_regbank</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">ioaddr</span><span class="p">);</span>

	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">open_time</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_started</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_queue</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_queue_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Turn on interrupts*/</span>
	<span class="n">outw</span><span class="p">(</span><span class="n">ETH16I_INTR_ON</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">TX_INTR_REG</span><span class="p">);</span>

	<span class="n">netif_start_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">eth16i_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">eth16i_local</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ioaddr</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>

	<span class="n">eth16i_reset</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* Turn off interrupts*/</span>
	<span class="n">outw</span><span class="p">(</span><span class="n">ETH16I_INTR_OFF</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">TX_INTR_REG</span><span class="p">);</span>

	<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">open_time</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Disable transmit and receive */</span>
	<span class="n">BITSET</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">CONFIG_REG_0</span><span class="p">,</span> <span class="n">DLC_EN</span><span class="p">);</span>

	<span class="cm">/* Reset the chip */</span>
	<span class="cm">/* outb(0xff, ioaddr + RESET); */</span>
	<span class="cm">/* outw(0xffff, ioaddr + TX_STATUS_REG);    */</span>

	<span class="n">outb</span><span class="p">(</span><span class="mh">0x00</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">CONFIG_REG_1</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">eth16i_timeout</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">eth16i_local</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ioaddr</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	   If we get here, some higher level has decided that</span>
<span class="cm">	   we are broken. There should really be a &quot;kick me&quot;</span>
<span class="cm">	   function call instead.</span>
<span class="cm">	   */</span>

	<span class="n">outw</span><span class="p">(</span><span class="n">ETH16I_INTR_OFF</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">TX_INTR_REG</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: transmit timed out with status %04x, %s ?</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
	<span class="n">inw</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">TX_STATUS_REG</span><span class="p">),</span>  <span class="p">(</span><span class="n">inb</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">TX_STATUS_REG</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">TX_DONE</span><span class="p">)</span> <span class="o">?</span>
		       <span class="s">&quot;IRQ conflict&quot;</span> <span class="o">:</span> <span class="s">&quot;network cable problem&quot;</span><span class="p">);</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">trans_start</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span> <span class="cm">/* prevent tx timeout */</span>

	<span class="cm">/* Let&#39;s dump all registers */</span>
	<span class="k">if</span><span class="p">(</span><span class="n">eth16i_debug</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: timeout: %02x %02x %02x %02x %02x %02x %02x %02x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">inb</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="mi">0</span><span class="p">),</span>
		       <span class="n">inb</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="n">inb</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="mi">2</span><span class="p">),</span>
		       <span class="n">inb</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="mi">3</span><span class="p">),</span> <span class="n">inb</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="mi">4</span><span class="p">),</span>
		       <span class="n">inb</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="mi">5</span><span class="p">),</span>
		       <span class="n">inb</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="mi">6</span><span class="p">),</span> <span class="n">inb</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="mi">7</span><span class="p">));</span>

		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: transmit start reg: %02x. collision reg %02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">inb</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">TRANSMIT_START_REG</span><span class="p">),</span>
		       <span class="n">inb</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">COL_16_REG</span><span class="p">));</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;lp-&gt;tx_queue = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_queue</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;lp-&gt;tx_queue_len = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_queue_len</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;lp-&gt;tx_started = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_started</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_errors</span><span class="o">++</span><span class="p">;</span>
	<span class="n">eth16i_reset</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">trans_start</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span> <span class="cm">/* prevent tx timeout */</span>
	<span class="n">outw</span><span class="p">(</span><span class="n">ETH16I_INTR_ON</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">TX_INTR_REG</span><span class="p">);</span>
	<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">netdev_tx_t</span> <span class="nf">eth16i_tx</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">eth16i_local</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ioaddr</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ushort</span> <span class="n">length</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">length</span> <span class="o">&lt;</span> <span class="n">ETH_ZLEN</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">skb_padto</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">ETH_ZLEN</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">NETDEV_TX_OK</span><span class="p">;</span>
		<span class="n">length</span> <span class="o">=</span> <span class="n">ETH_ZLEN</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">buf</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

	<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* Turn off TX interrupts */</span>
	<span class="n">outw</span><span class="p">(</span><span class="n">ETH16I_INTR_OFF</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">TX_INTR_REG</span><span class="p">);</span>

	<span class="cm">/* We would be better doing the disable_irq tricks the 3c509 does,</span>
<span class="cm">	   that would make this suck a lot less */</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span><span class="p">(</span> <span class="p">(</span><span class="n">length</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_buf_size</span> <span class="o">-</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_queue_len</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span><span class="p">(</span><span class="n">eth16i_debug</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: Transmit buffer full.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">outw</span><span class="p">(</span><span class="n">length</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">DATAPORT</span><span class="p">);</span>

		<span class="k">if</span><span class="p">(</span> <span class="n">ioaddr</span> <span class="o">&lt;</span> <span class="mh">0x1000</span> <span class="p">)</span>
			<span class="n">outsw</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">DATAPORT</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="p">(</span><span class="n">length</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">frag</span> <span class="o">=</span> <span class="n">length</span> <span class="o">%</span> <span class="mi">4</span><span class="p">;</span>
			<span class="n">outsl</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">DATAPORT</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">length</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">);</span>
			<span class="k">if</span><span class="p">(</span> <span class="n">frag</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">{</span>
				<span class="n">outsw</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">DATAPORT</span><span class="p">,</span> <span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="p">(</span><span class="n">length</span> <span class="o">&amp;</span> <span class="mh">0xFFFC</span><span class="p">)),</span> <span class="mi">1</span><span class="p">);</span>
				<span class="k">if</span><span class="p">(</span> <span class="n">frag</span> <span class="o">==</span> <span class="mi">3</span> <span class="p">)</span>
					<span class="n">outsw</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">DATAPORT</span><span class="p">,</span>
					      <span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="p">(</span><span class="n">length</span> <span class="o">&amp;</span> <span class="mh">0xFFFC</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="p">),</span> <span class="mi">1</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_buffered_packets</span><span class="o">++</span><span class="p">;</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_buffered_bytes</span> <span class="o">=</span> <span class="n">length</span><span class="p">;</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_queue</span><span class="o">++</span><span class="p">;</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_queue_len</span> <span class="o">+=</span> <span class="n">length</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_buf_busy</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_started</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* If the transmitter is idle..always trigger a transmit */</span>
		<span class="n">outb</span><span class="p">(</span><span class="n">TX_START</span> <span class="o">|</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_queue</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">TRANSMIT_START_REG</span><span class="p">);</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_queue</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_queue_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_started</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_queue_len</span> <span class="o">&lt;</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_buf_size</span> <span class="o">-</span> <span class="p">(</span><span class="n">ETH_FRAME_LEN</span> <span class="o">+</span> <span class="mi">2</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* There is still more room for one more packet in tx buffer */</span>
		<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">outw</span><span class="p">(</span><span class="n">ETH16I_INTR_ON</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">TX_INTR_REG</span><span class="p">);</span>
	<span class="cm">/* Turn TX interrupts back on */</span>
	<span class="cm">/* outb(TX_INTR_DONE | TX_INTR_16_COL, ioaddr + TX_INTR_REG); */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">NETDEV_TX_OK</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">eth16i_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ioaddr</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">boguscount</span> <span class="o">=</span> <span class="n">MAX_RX_LOOP</span><span class="p">;</span>

	<span class="cm">/* Loop until all packets have been read */</span>
	<span class="k">while</span><span class="p">(</span> <span class="p">(</span><span class="n">inb</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">RECEIVE_MODE_REG</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">RX_BUFFER_EMPTY</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>

		<span class="cm">/* Read status byte from receive buffer */</span>
		<span class="n">ushort</span> <span class="n">status</span> <span class="o">=</span> <span class="n">inw</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">DATAPORT</span><span class="p">);</span>

		<span class="cm">/* Get the size of the packet from receive buffer */</span>
		<span class="n">ushort</span> <span class="n">pkt_len</span> <span class="o">=</span> <span class="n">inw</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">DATAPORT</span><span class="p">);</span>

		<span class="k">if</span><span class="p">(</span><span class="n">eth16i_debug</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: Receiving packet mode %02x status %04x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
			       <span class="n">inb</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">RECEIVE_MODE_REG</span><span class="p">),</span> <span class="n">status</span><span class="p">);</span>

		<span class="k">if</span><span class="p">(</span> <span class="o">!</span><span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">PKT_GOOD</span><span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_errors</span><span class="o">++</span><span class="p">;</span>

			<span class="k">if</span><span class="p">(</span> <span class="p">(</span><span class="n">pkt_len</span> <span class="o">&lt;</span> <span class="n">ETH_ZLEN</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">pkt_len</span> <span class="o">&gt;</span> <span class="n">ETH_FRAME_LEN</span><span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_length_errors</span><span class="o">++</span><span class="p">;</span>
				<span class="n">eth16i_reset</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
				<span class="k">return</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">else</span> <span class="p">{</span>
				<span class="n">eth16i_skip_packet</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_dropped</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">else</span> <span class="p">{</span>   <span class="cm">/* Ok so now we should have a good packet */</span>
			<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>

			<span class="n">skb</span> <span class="o">=</span> <span class="n">netdev_alloc_skb</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">pkt_len</span> <span class="o">+</span> <span class="mi">3</span><span class="p">);</span>
			<span class="k">if</span><span class="p">(</span> <span class="n">skb</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: Could&#39;n allocate memory for packet (len %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">pkt_len</span><span class="p">);</span>
				<span class="n">eth16i_skip_packet</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_dropped</span><span class="o">++</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">skb_reserve</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span><span class="mi">2</span><span class="p">);</span>

			<span class="cm">/*</span>
<span class="cm">			   Now let&#39;s get the packet out of buffer.</span>
<span class="cm">			   size is (pkt_len + 1) &gt;&gt; 1, cause we are now reading words</span>
<span class="cm">			   and it have to be even aligned.</span>
<span class="cm">			   */</span>

			<span class="k">if</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">&lt;</span> <span class="mh">0x1000</span><span class="p">)</span>
				<span class="n">insw</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">DATAPORT</span><span class="p">,</span> <span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">pkt_len</span><span class="p">),</span>
				     <span class="p">(</span><span class="n">pkt_len</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">);</span>
			<span class="k">else</span> <span class="p">{</span>
				<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">pkt_len</span><span class="p">);</span>
				<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">frag</span> <span class="o">=</span> <span class="n">pkt_len</span> <span class="o">%</span> <span class="mi">4</span><span class="p">;</span>

				<span class="n">insl</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">DATAPORT</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">pkt_len</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">);</span>

				<span class="k">if</span><span class="p">(</span><span class="n">frag</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
					<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">rest</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
					<span class="n">rest</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">inw</span><span class="p">(</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">DATAPORT</span> <span class="p">);</span>
					<span class="k">if</span><span class="p">(</span><span class="n">frag</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span>
						<span class="n">rest</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">inw</span><span class="p">(</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">DATAPORT</span> <span class="p">);</span>

					<span class="n">memcpy</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="p">(</span><span class="n">pkt_len</span> <span class="o">&amp;</span> <span class="mh">0xfffc</span><span class="p">),</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">rest</span><span class="p">,</span> <span class="n">frag</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>

			<span class="n">skb</span><span class="o">-&gt;</span><span class="n">protocol</span><span class="o">=</span><span class="n">eth_type_trans</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>

			<span class="k">if</span><span class="p">(</span> <span class="n">eth16i_debug</span> <span class="o">&gt;</span> <span class="mi">5</span> <span class="p">)</span> <span class="p">{</span>
				<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: Received packet of length %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">pkt_len</span><span class="p">);</span>
				<span class="k">for</span><span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">14</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
					<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot; %02x&quot;</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">netif_rx</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_packets</span><span class="o">++</span><span class="p">;</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_bytes</span> <span class="o">+=</span> <span class="n">pkt_len</span><span class="p">;</span>

		<span class="p">}</span> <span class="cm">/* else */</span>

		<span class="k">if</span><span class="p">(</span><span class="o">--</span><span class="n">boguscount</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

	<span class="p">}</span> <span class="cm">/* while */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">eth16i_interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev_id</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">eth16i_local</span> <span class="o">*</span><span class="n">lp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ioaddr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">status</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">handled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ioaddr</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>
	<span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* Turn off all interrupts from adapter */</span>
	<span class="n">outw</span><span class="p">(</span><span class="n">ETH16I_INTR_OFF</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">TX_INTR_REG</span><span class="p">);</span>

	<span class="cm">/* eth16i_tx won&#39;t be called */</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">inw</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">TX_STATUS_REG</span><span class="p">);</span>      <span class="cm">/* Get the status */</span>
	<span class="n">outw</span><span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">TX_STATUS_REG</span><span class="p">);</span>      <span class="cm">/* Clear status bits */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="n">handled</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span><span class="p">(</span><span class="n">eth16i_debug</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: Interrupt with status %04x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>

	<span class="k">if</span><span class="p">(</span> <span class="n">status</span> <span class="o">&amp;</span> <span class="mh">0x7f00</span> <span class="p">)</span> <span class="p">{</span>

		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_errors</span><span class="o">++</span><span class="p">;</span>

		<span class="k">if</span><span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">BUS_RD_ERR</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: Bus read error.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">if</span><span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">SHORT_PKT_ERR</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="p">)</span>   <span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_length_errors</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span><span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ALIGN_ERR</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="p">)</span>       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_frame_errors</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span><span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">CRC_ERR</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="p">)</span>	    <span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_crc_errors</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span><span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">RX_BUF_OVERFLOW</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="p">)</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_over_errors</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span><span class="p">(</span> <span class="n">status</span> <span class="o">&amp;</span> <span class="mh">0x001a</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_errors</span><span class="o">++</span><span class="p">;</span>

		<span class="k">if</span><span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">CR_LOST</span><span class="p">)</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_carrier_errors</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span><span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">TX_JABBER_ERR</span><span class="p">)</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_window_errors</span><span class="o">++</span><span class="p">;</span>

<span class="cp">#if 0</span><span class="c"></span>
<span class="c">		if(status &amp; COLLISION) {</span>
<span class="c">			dev-&gt;stats.collisions +=</span>
<span class="c">				((inb(ioaddr+TRANSMIT_MODE_REG) &amp; 0xF0) &gt;&gt; 4);</span>
<span class="c">		}</span>
<span class="cp">#endif</span>
		<span class="k">if</span><span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">COLLISIONS_16</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">col_16</span> <span class="o">&lt;</span> <span class="n">MAX_COL_16</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">lp</span><span class="o">-&gt;</span><span class="n">col_16</span><span class="o">++</span><span class="p">;</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">collisions</span><span class="o">++</span><span class="p">;</span>
				<span class="cm">/* Resume transmitting, skip failed packet */</span>
				<span class="n">outb</span><span class="p">(</span><span class="mh">0x02</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">COL_16_REG</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">else</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: bailing out due to many consecutive 16-in-a-row collisions. Network cable problem?</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span><span class="p">(</span> <span class="n">status</span> <span class="o">&amp;</span> <span class="mh">0x00ff</span> <span class="p">)</span> <span class="p">{</span>          <span class="cm">/* Let&#39;s check the transmit status reg */</span>

		<span class="k">if</span><span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">TX_DONE</span><span class="p">)</span> <span class="p">{</span>         <span class="cm">/* The transmit has been done */</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_packets</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_buffered_packets</span><span class="p">;</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_bytes</span> <span class="o">+=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_buffered_bytes</span><span class="p">;</span>
			<span class="n">lp</span><span class="o">-&gt;</span><span class="n">col_16</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

			<span class="k">if</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_queue</span><span class="p">)</span> <span class="p">{</span>           <span class="cm">/* Is there still packets ? */</span>
				<span class="cm">/* There was packet(s) so start transmitting and write also</span>
<span class="cm">				   how many packets there is to be sended */</span>
				<span class="n">outb</span><span class="p">(</span><span class="n">TX_START</span> <span class="o">|</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_queue</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">TRANSMIT_START_REG</span><span class="p">);</span>
				<span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_queue</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_queue_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_started</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">else</span> <span class="p">{</span>
				<span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_started</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span><span class="p">(</span> <span class="p">(</span> <span class="n">status</span> <span class="o">&amp;</span> <span class="mh">0x8000</span> <span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span> <span class="p">(</span><span class="n">inb</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">RECEIVE_MODE_REG</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">RX_BUFFER_EMPTY</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
		<span class="n">eth16i_rx</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>  <span class="cm">/* We have packet in receive buffer */</span>
	<span class="p">}</span>

	<span class="cm">/* Turn interrupts back on */</span>
	<span class="n">outw</span><span class="p">(</span><span class="n">ETH16I_INTR_ON</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">TX_INTR_REG</span><span class="p">);</span>

	<span class="k">if</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_queue_len</span> <span class="o">&lt;</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_buf_size</span> <span class="o">-</span> <span class="p">(</span><span class="n">ETH_FRAME_LEN</span> <span class="o">+</span> <span class="mi">2</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* There is still more room for one more packet in tx buffer */</span>
		<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">IRQ_RETVAL</span><span class="p">(</span><span class="n">handled</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">eth16i_skip_packet</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ioaddr</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>

	<span class="n">inw</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">DATAPORT</span><span class="p">);</span>
	<span class="n">inw</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">DATAPORT</span><span class="p">);</span>
	<span class="n">inw</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">DATAPORT</span><span class="p">);</span>

	<span class="n">outb</span><span class="p">(</span><span class="n">SKIP_RX_PACKET</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">FILTER_SELF_RX_REG</span><span class="p">);</span>
	<span class="k">while</span><span class="p">(</span> <span class="n">inb</span><span class="p">(</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">FILTER_SELF_RX_REG</span> <span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">eth16i_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">eth16i_local</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ioaddr</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>

	<span class="k">if</span><span class="p">(</span><span class="n">eth16i_debug</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: Resetting device.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="n">BITSET</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">CONFIG_REG_0</span><span class="p">,</span> <span class="n">DLC_EN</span><span class="p">);</span>
	<span class="n">outw</span><span class="p">(</span><span class="mh">0xffff</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">TX_STATUS_REG</span><span class="p">);</span>
	<span class="n">eth16i_select_regbank</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">ioaddr</span><span class="p">);</span>

	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_started</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_buf_busy</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_queue</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_queue_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">BITCLR</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">CONFIG_REG_0</span><span class="p">,</span> <span class="n">DLC_EN</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">eth16i_multicast</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ioaddr</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">netdev_mc_empty</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">||</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="o">&amp;</span><span class="p">(</span><span class="n">IFF_ALLMULTI</span><span class="o">|</span><span class="n">IFF_PROMISC</span><span class="p">))</span>
	<span class="p">{</span>
		<span class="n">outb</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">RECEIVE_MODE_REG</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">outb</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">RECEIVE_MODE_REG</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">eth16i_select_regbank</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">banknbr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ioaddr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">data</span><span class="p">;</span>

	<span class="n">data</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">CONFIG_REG_1</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span> <span class="p">((</span><span class="n">data</span> <span class="o">&amp;</span> <span class="mh">0xF3</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span> <span class="p">(</span><span class="n">banknbr</span> <span class="o">&amp;</span> <span class="mh">0x03</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)),</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">CONFIG_REG_1</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef MODULE</span>

<span class="k">static</span> <span class="n">ushort</span> <span class="nf">eth16i_parse_mediatype</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">s</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">E_PORT_FROM_EPROM</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;bnc&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">E_PORT_BNC</span><span class="p">;</span>
        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;tp&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
                <span class="k">return</span> <span class="n">E_PORT_TP</span><span class="p">;</span>
        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;dix&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
                <span class="k">return</span> <span class="n">E_PORT_DIX</span><span class="p">;</span>
        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;auto&quot;</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">E_PORT_AUTO</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">E_PORT_FROM_EPROM</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define MAX_ETH16I_CARDS 4  </span><span class="cm">/* Max number of Eth16i cards per module */</span><span class="cp"></span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev_eth16i</span><span class="p">[</span><span class="n">MAX_ETH16I_CARDS</span><span class="p">];</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">io</span><span class="p">[</span><span class="n">MAX_ETH16I_CARDS</span><span class="p">];</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">static int irq[MAX_ETH16I_CARDS];</span>
<span class="cp">#endif</span>
<span class="k">static</span> <span class="kt">char</span><span class="o">*</span> <span class="n">mediatype</span><span class="p">[</span><span class="n">MAX_ETH16I_CARDS</span><span class="p">];</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">debug</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Mika Kuoppala &lt;miku@iki.fi&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;ICL EtherTeam 16i/32 driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>


<span class="n">module_param_array</span><span class="p">(</span><span class="n">io</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">io</span><span class="p">,</span> <span class="s">&quot;eth16i I/O base address(es)&quot;</span><span class="p">);</span>

<span class="cp">#if 0</span><span class="c"></span>
<span class="c">module_param_array(irq, int, NULL, 0);</span>
<span class="c">MODULE_PARM_DESC(irq, &quot;eth16i interrupt request number&quot;);</span>
<span class="cp">#endif</span>

<span class="n">module_param_array</span><span class="p">(</span><span class="n">mediatype</span><span class="p">,</span> <span class="n">charp</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">mediatype</span><span class="p">,</span> <span class="s">&quot;eth16i media type of interface(s) (bnc,tp,dix,auto,eprom)&quot;</span><span class="p">);</span>

<span class="n">module_param</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="s">&quot;eth16i debug level (0-6)&quot;</span><span class="p">);</span>

<span class="kt">int</span> <span class="n">__init</span> <span class="nf">init_module</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">this_dev</span><span class="p">,</span> <span class="n">found</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">this_dev</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">this_dev</span> <span class="o">&lt;</span> <span class="n">MAX_ETH16I_CARDS</span><span class="p">;</span> <span class="n">this_dev</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev</span> <span class="o">=</span> <span class="n">alloc_etherdev</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">eth16i_local</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">=</span> <span class="n">io</span><span class="p">[</span><span class="n">this_dev</span><span class="p">];</span>

	        <span class="k">if</span><span class="p">(</span><span class="n">debug</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
			<span class="n">eth16i_debug</span> <span class="o">=</span> <span class="n">debug</span><span class="p">;</span>

		<span class="k">if</span><span class="p">(</span><span class="n">eth16i_debug</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;eth16i(%d): interface type %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">this_dev</span><span class="p">,</span> <span class="n">mediatype</span><span class="p">[</span><span class="n">this_dev</span><span class="p">]</span> <span class="o">?</span> <span class="n">mediatype</span><span class="p">[</span><span class="n">this_dev</span><span class="p">]</span> <span class="o">:</span> <span class="s">&quot;none&quot;</span> <span class="p">);</span>

		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">if_port</span> <span class="o">=</span> <span class="n">eth16i_parse_mediatype</span><span class="p">(</span><span class="n">mediatype</span><span class="p">[</span><span class="n">this_dev</span><span class="p">]);</span>

		<span class="k">if</span><span class="p">(</span><span class="n">io</span><span class="p">[</span><span class="n">this_dev</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">this_dev</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* Only autoprobe 1st one */</span>
				<span class="n">free_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;eth16i.c: Presently autoprobing (not recommended) for a single card.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">do_eth16i_probe</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_eth16i</span><span class="p">[</span><span class="n">found</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;eth16i.c No Eth16i card found (i/o = 0x%x).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">io</span><span class="p">[</span><span class="n">this_dev</span><span class="p">]);</span>
		<span class="n">free_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">found</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">__exit</span> <span class="nf">cleanup_module</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">this_dev</span><span class="p">;</span>

	<span class="k">for</span><span class="p">(</span><span class="n">this_dev</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">this_dev</span> <span class="o">&lt;</span> <span class="n">MAX_ETH16I_CARDS</span><span class="p">;</span> <span class="n">this_dev</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev_eth16i</span><span class="p">[</span><span class="n">this_dev</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">unregister_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="n">free_irq</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
			<span class="n">release_region</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">,</span> <span class="n">ETH16I_IO_EXTENT</span><span class="p">);</span>
			<span class="n">free_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* MODULE */</span><span class="cp"></span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
