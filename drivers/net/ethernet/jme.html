<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › ethernet › jme.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>jme.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * JMicron JMC2x0 series PCIe Ethernet Linux Device Driver</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright 2008 JMicron Technology Corporation</span>
<span class="cm"> * http://www.jmicron.com/</span>
<span class="cm"> * Copyright (c) 2009 - 2010 Guo-Fu Tseng &lt;cooldavid@cooldavid.org&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * Author: Guo-Fu Tseng &lt;cooldavid@cooldavid.org&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License as published by</span>
<span class="cm"> * the Free Software Foundation; either version 2 of the License.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful,</span>
<span class="cm"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> * GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with this program; if not, write to the Free Software</span>
<span class="cm"> * Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#define pr_fmt(fmt) KBUILD_MODNAME &quot;: &quot; fmt</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/netdevice.h&gt;</span>
<span class="cp">#include &lt;linux/etherdevice.h&gt;</span>
<span class="cp">#include &lt;linux/ethtool.h&gt;</span>
<span class="cp">#include &lt;linux/mii.h&gt;</span>
<span class="cp">#include &lt;linux/crc32.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/spinlock.h&gt;</span>
<span class="cp">#include &lt;linux/in.h&gt;</span>
<span class="cp">#include &lt;linux/ip.h&gt;</span>
<span class="cp">#include &lt;linux/ipv6.h&gt;</span>
<span class="cp">#include &lt;linux/tcp.h&gt;</span>
<span class="cp">#include &lt;linux/udp.h&gt;</span>
<span class="cp">#include &lt;linux/if_vlan.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;net/ip6_checksum.h&gt;</span>
<span class="cp">#include &quot;jme.h&quot;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">force_pseudohp</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">no_pseudohp</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">no_extplug</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">force_pseudohp</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">force_pseudohp</span><span class="p">,</span>
	<span class="s">&quot;Enable pseudo hot-plug feature manually by driver instead of BIOS.&quot;</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">no_pseudohp</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">no_pseudohp</span><span class="p">,</span> <span class="s">&quot;Disable pseudo hot-plug feature.&quot;</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">no_extplug</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">no_extplug</span><span class="p">,</span>
	<span class="s">&quot;Do not use external plug signal for pseudo hot-plug.&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">jme_mdio_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">phy</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">jme_adapter</span> <span class="o">*</span><span class="n">jme</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">again</span> <span class="o">=</span> <span class="p">(</span><span class="n">reg</span> <span class="o">==</span> <span class="n">MII_BMSR</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">read_again:</span>
	<span class="n">jwrite32</span><span class="p">(</span><span class="n">jme</span><span class="p">,</span> <span class="n">JME_SMI</span><span class="p">,</span> <span class="n">SMI_OP_REQ</span> <span class="o">|</span>
				<span class="n">smi_phy_addr</span><span class="p">(</span><span class="n">phy</span><span class="p">)</span> <span class="o">|</span>
				<span class="n">smi_reg_addr</span><span class="p">(</span><span class="n">reg</span><span class="p">));</span>

	<span class="n">wmb</span><span class="p">();</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">JME_PHY_TIMEOUT</span> <span class="o">*</span> <span class="mi">50</span> <span class="p">;</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">;</span> <span class="o">--</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">jread32</span><span class="p">(</span><span class="n">jme</span><span class="p">,</span> <span class="n">JME_SMI</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">SMI_OP_REQ</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;phy(%d) read timeout : %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">again</span><span class="o">--</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">read_again</span><span class="p">;</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">SMI_DATA_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">SMI_DATA_SHIFT</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">jme_mdio_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span>
				<span class="kt">int</span> <span class="n">phy</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">,</span> <span class="kt">int</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">jme_adapter</span> <span class="o">*</span><span class="n">jme</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">jwrite32</span><span class="p">(</span><span class="n">jme</span><span class="p">,</span> <span class="n">JME_SMI</span><span class="p">,</span> <span class="n">SMI_OP_WRITE</span> <span class="o">|</span> <span class="n">SMI_OP_REQ</span> <span class="o">|</span>
		<span class="p">((</span><span class="n">val</span> <span class="o">&lt;&lt;</span> <span class="n">SMI_DATA_SHIFT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">SMI_DATA_MASK</span><span class="p">)</span> <span class="o">|</span>
		<span class="n">smi_phy_addr</span><span class="p">(</span><span class="n">phy</span><span class="p">)</span> <span class="o">|</span> <span class="n">smi_reg_addr</span><span class="p">(</span><span class="n">reg</span><span class="p">));</span>

	<span class="n">wmb</span><span class="p">();</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">JME_PHY_TIMEOUT</span> <span class="o">*</span> <span class="mi">50</span> <span class="p">;</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">;</span> <span class="o">--</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">jread32</span><span class="p">(</span><span class="n">jme</span><span class="p">,</span> <span class="n">JME_SMI</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">SMI_OP_REQ</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;phy(%d) write timeout : %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">jme_reset_phy_processor</span><span class="p">(</span><span class="k">struct</span> <span class="n">jme_adapter</span> <span class="o">*</span><span class="n">jme</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">jme_mdio_write</span><span class="p">(</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="n">jme</span><span class="o">-&gt;</span><span class="n">mii_if</span><span class="p">.</span><span class="n">phy_id</span><span class="p">,</span>
			<span class="n">MII_ADVERTISE</span><span class="p">,</span> <span class="n">ADVERTISE_ALL</span> <span class="o">|</span>
			<span class="n">ADVERTISE_PAUSE_CAP</span> <span class="o">|</span> <span class="n">ADVERTISE_PAUSE_ASYM</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="n">PCI_DEVICE_ID_JMICRON_JMC250</span><span class="p">)</span>
		<span class="n">jme_mdio_write</span><span class="p">(</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="n">jme</span><span class="o">-&gt;</span><span class="n">mii_if</span><span class="p">.</span><span class="n">phy_id</span><span class="p">,</span>
				<span class="n">MII_CTRL1000</span><span class="p">,</span>
				<span class="n">ADVERTISE_1000FULL</span> <span class="o">|</span> <span class="n">ADVERTISE_1000HALF</span><span class="p">);</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">jme_mdio_read</span><span class="p">(</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="n">jme</span><span class="o">-&gt;</span><span class="n">mii_if</span><span class="p">.</span><span class="n">phy_id</span><span class="p">,</span>
				<span class="n">MII_BMCR</span><span class="p">);</span>

	<span class="n">jme_mdio_write</span><span class="p">(</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="n">jme</span><span class="o">-&gt;</span><span class="n">mii_if</span><span class="p">.</span><span class="n">phy_id</span><span class="p">,</span>
			<span class="n">MII_BMCR</span><span class="p">,</span> <span class="n">val</span> <span class="o">|</span> <span class="n">BMCR_RESET</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">jme_setup_wakeup_frame</span><span class="p">(</span><span class="k">struct</span> <span class="n">jme_adapter</span> <span class="o">*</span><span class="n">jme</span><span class="p">,</span>
		       <span class="k">const</span> <span class="n">u32</span> <span class="o">*</span><span class="n">mask</span><span class="p">,</span> <span class="n">u32</span> <span class="n">crc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">fnr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Setup CRC pattern</span>
<span class="cm">	 */</span>
	<span class="n">jwrite32</span><span class="p">(</span><span class="n">jme</span><span class="p">,</span> <span class="n">JME_WFOI</span><span class="p">,</span> <span class="n">WFOI_CRC_SEL</span> <span class="o">|</span> <span class="p">(</span><span class="n">fnr</span> <span class="o">&amp;</span> <span class="n">WFOI_FRAME_SEL</span><span class="p">));</span>
	<span class="n">wmb</span><span class="p">();</span>
	<span class="n">jwrite32</span><span class="p">(</span><span class="n">jme</span><span class="p">,</span> <span class="n">JME_WFODP</span><span class="p">,</span> <span class="n">crc</span><span class="p">);</span>
	<span class="n">wmb</span><span class="p">();</span>

	<span class="cm">/*</span>
<span class="cm">	 * Setup Mask</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">WAKEUP_FRAME_MASK_DWNR</span> <span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">jwrite32</span><span class="p">(</span><span class="n">jme</span><span class="p">,</span> <span class="n">JME_WFOI</span><span class="p">,</span>
				<span class="p">((</span><span class="n">i</span> <span class="o">&lt;&lt;</span> <span class="n">WFOI_MASK_SHIFT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">WFOI_MASK_SEL</span><span class="p">)</span> <span class="o">|</span>
				<span class="p">(</span><span class="n">fnr</span> <span class="o">&amp;</span> <span class="n">WFOI_FRAME_SEL</span><span class="p">));</span>
		<span class="n">wmb</span><span class="p">();</span>
		<span class="n">jwrite32</span><span class="p">(</span><span class="n">jme</span><span class="p">,</span> <span class="n">JME_WFODP</span><span class="p">,</span> <span class="n">mask</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="n">wmb</span><span class="p">();</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">jme_mac_rxclk_off</span><span class="p">(</span><span class="k">struct</span> <span class="n">jme_adapter</span> <span class="o">*</span><span class="n">jme</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">jme</span><span class="o">-&gt;</span><span class="n">reg_gpreg1</span> <span class="o">|=</span> <span class="n">GPREG1_RXCLKOFF</span><span class="p">;</span>
	<span class="n">jwrite32f</span><span class="p">(</span><span class="n">jme</span><span class="p">,</span> <span class="n">JME_GPREG1</span><span class="p">,</span> <span class="n">jme</span><span class="o">-&gt;</span><span class="n">reg_gpreg1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">jme_mac_rxclk_on</span><span class="p">(</span><span class="k">struct</span> <span class="n">jme_adapter</span> <span class="o">*</span><span class="n">jme</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">jme</span><span class="o">-&gt;</span><span class="n">reg_gpreg1</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">GPREG1_RXCLKOFF</span><span class="p">;</span>
	<span class="n">jwrite32f</span><span class="p">(</span><span class="n">jme</span><span class="p">,</span> <span class="n">JME_GPREG1</span><span class="p">,</span> <span class="n">jme</span><span class="o">-&gt;</span><span class="n">reg_gpreg1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">jme_mac_txclk_off</span><span class="p">(</span><span class="k">struct</span> <span class="n">jme_adapter</span> <span class="o">*</span><span class="n">jme</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">jme</span><span class="o">-&gt;</span><span class="n">reg_ghc</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">GHC_TO_CLK_SRC</span> <span class="o">|</span> <span class="n">GHC_TXMAC_CLK_SRC</span><span class="p">);</span>
	<span class="n">jwrite32f</span><span class="p">(</span><span class="n">jme</span><span class="p">,</span> <span class="n">JME_GHC</span><span class="p">,</span> <span class="n">jme</span><span class="o">-&gt;</span><span class="n">reg_ghc</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">jme_mac_txclk_on</span><span class="p">(</span><span class="k">struct</span> <span class="n">jme_adapter</span> <span class="o">*</span><span class="n">jme</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">speed</span> <span class="o">=</span> <span class="n">jme</span><span class="o">-&gt;</span><span class="n">reg_ghc</span> <span class="o">&amp;</span> <span class="n">GHC_SPEED</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">speed</span> <span class="o">==</span> <span class="n">GHC_SPEED_1000M</span><span class="p">)</span>
		<span class="n">jme</span><span class="o">-&gt;</span><span class="n">reg_ghc</span> <span class="o">|=</span> <span class="n">GHC_TO_CLK_GPHY</span> <span class="o">|</span> <span class="n">GHC_TXMAC_CLK_GPHY</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">jme</span><span class="o">-&gt;</span><span class="n">reg_ghc</span> <span class="o">|=</span> <span class="n">GHC_TO_CLK_PCIE</span> <span class="o">|</span> <span class="n">GHC_TXMAC_CLK_PCIE</span><span class="p">;</span>
	<span class="n">jwrite32f</span><span class="p">(</span><span class="n">jme</span><span class="p">,</span> <span class="n">JME_GHC</span><span class="p">,</span> <span class="n">jme</span><span class="o">-&gt;</span><span class="n">reg_ghc</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">jme_reset_ghc_speed</span><span class="p">(</span><span class="k">struct</span> <span class="n">jme_adapter</span> <span class="o">*</span><span class="n">jme</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">jme</span><span class="o">-&gt;</span><span class="n">reg_ghc</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">GHC_SPEED</span> <span class="o">|</span> <span class="n">GHC_DPX</span><span class="p">);</span>
	<span class="n">jwrite32f</span><span class="p">(</span><span class="n">jme</span><span class="p">,</span> <span class="n">JME_GHC</span><span class="p">,</span> <span class="n">jme</span><span class="o">-&gt;</span><span class="n">reg_ghc</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">jme_reset_250A2_workaround</span><span class="p">(</span><span class="k">struct</span> <span class="n">jme_adapter</span> <span class="o">*</span><span class="n">jme</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">jme</span><span class="o">-&gt;</span><span class="n">reg_gpreg1</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">GPREG1_HALFMODEPATCH</span> <span class="o">|</span>
			     <span class="n">GPREG1_RSSPATCH</span><span class="p">);</span>
	<span class="n">jwrite32</span><span class="p">(</span><span class="n">jme</span><span class="p">,</span> <span class="n">JME_GPREG1</span><span class="p">,</span> <span class="n">jme</span><span class="o">-&gt;</span><span class="n">reg_gpreg1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">jme_assert_ghc_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">jme_adapter</span> <span class="o">*</span><span class="n">jme</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">jme</span><span class="o">-&gt;</span><span class="n">reg_ghc</span> <span class="o">|=</span> <span class="n">GHC_SWRST</span><span class="p">;</span>
	<span class="n">jwrite32f</span><span class="p">(</span><span class="n">jme</span><span class="p">,</span> <span class="n">JME_GHC</span><span class="p">,</span> <span class="n">jme</span><span class="o">-&gt;</span><span class="n">reg_ghc</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">jme_clear_ghc_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">jme_adapter</span> <span class="o">*</span><span class="n">jme</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">jme</span><span class="o">-&gt;</span><span class="n">reg_ghc</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">GHC_SWRST</span><span class="p">;</span>
	<span class="n">jwrite32f</span><span class="p">(</span><span class="n">jme</span><span class="p">,</span> <span class="n">JME_GHC</span><span class="p">,</span> <span class="n">jme</span><span class="o">-&gt;</span><span class="n">reg_ghc</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">jme_reset_mac_processor</span><span class="p">(</span><span class="k">struct</span> <span class="n">jme_adapter</span> <span class="o">*</span><span class="n">jme</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="n">u32</span> <span class="n">mask</span><span class="p">[</span><span class="n">WAKEUP_FRAME_MASK_DWNR</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">};</span>
	<span class="n">u32</span> <span class="n">crc</span> <span class="o">=</span> <span class="mh">0xCDCDCDCD</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">gpreg0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">jme_reset_ghc_speed</span><span class="p">(</span><span class="n">jme</span><span class="p">);</span>
	<span class="n">jme_reset_250A2_workaround</span><span class="p">(</span><span class="n">jme</span><span class="p">);</span>

	<span class="n">jme_mac_rxclk_on</span><span class="p">(</span><span class="n">jme</span><span class="p">);</span>
	<span class="n">jme_mac_txclk_on</span><span class="p">(</span><span class="n">jme</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">jme_assert_ghc_reset</span><span class="p">(</span><span class="n">jme</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">jme_mac_rxclk_off</span><span class="p">(</span><span class="n">jme</span><span class="p">);</span>
	<span class="n">jme_mac_txclk_off</span><span class="p">(</span><span class="n">jme</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">jme_clear_ghc_reset</span><span class="p">(</span><span class="n">jme</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">jme_mac_rxclk_on</span><span class="p">(</span><span class="n">jme</span><span class="p">);</span>
	<span class="n">jme_mac_txclk_on</span><span class="p">(</span><span class="n">jme</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">jme_mac_rxclk_off</span><span class="p">(</span><span class="n">jme</span><span class="p">);</span>
	<span class="n">jme_mac_txclk_off</span><span class="p">(</span><span class="n">jme</span><span class="p">);</span>

	<span class="n">jwrite32</span><span class="p">(</span><span class="n">jme</span><span class="p">,</span> <span class="n">JME_RXDBA_LO</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">);</span>
	<span class="n">jwrite32</span><span class="p">(</span><span class="n">jme</span><span class="p">,</span> <span class="n">JME_RXDBA_HI</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">);</span>
	<span class="n">jwrite32</span><span class="p">(</span><span class="n">jme</span><span class="p">,</span> <span class="n">JME_RXQDC</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">);</span>
	<span class="n">jwrite32</span><span class="p">(</span><span class="n">jme</span><span class="p">,</span> <span class="n">JME_RXNDA</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">);</span>
	<span class="n">jwrite32</span><span class="p">(</span><span class="n">jme</span><span class="p">,</span> <span class="n">JME_TXDBA_LO</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">);</span>
	<span class="n">jwrite32</span><span class="p">(</span><span class="n">jme</span><span class="p">,</span> <span class="n">JME_TXDBA_HI</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">);</span>
	<span class="n">jwrite32</span><span class="p">(</span><span class="n">jme</span><span class="p">,</span> <span class="n">JME_TXQDC</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">);</span>
	<span class="n">jwrite32</span><span class="p">(</span><span class="n">jme</span><span class="p">,</span> <span class="n">JME_TXNDA</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">);</span>

	<span class="n">jwrite32</span><span class="p">(</span><span class="n">jme</span><span class="p">,</span> <span class="n">JME_RXMCHT_LO</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">);</span>
	<span class="n">jwrite32</span><span class="p">(</span><span class="n">jme</span><span class="p">,</span> <span class="n">JME_RXMCHT_HI</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">WAKEUP_FRAME_NR</span> <span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
		<span class="n">jme_setup_wakeup_frame</span><span class="p">(</span><span class="n">jme</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">crc</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">fpgaver</span><span class="p">)</span>
		<span class="n">gpreg0</span> <span class="o">=</span> <span class="n">GPREG0_DEFAULT</span> <span class="o">|</span> <span class="n">GPREG0_LNKINTPOLL</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">gpreg0</span> <span class="o">=</span> <span class="n">GPREG0_DEFAULT</span><span class="p">;</span>
	<span class="n">jwrite32</span><span class="p">(</span><span class="n">jme</span><span class="p">,</span> <span class="n">JME_GPREG0</span><span class="p">,</span> <span class="n">gpreg0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">jme_clear_pm</span><span class="p">(</span><span class="k">struct</span> <span class="n">jme_adapter</span> <span class="o">*</span><span class="n">jme</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">jwrite32</span><span class="p">(</span><span class="n">jme</span><span class="p">,</span> <span class="n">JME_PMCS</span><span class="p">,</span> <span class="n">PMCS_STMASK</span> <span class="o">|</span> <span class="n">jme</span><span class="o">-&gt;</span><span class="n">reg_pmcs</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">jme_reload_eeprom</span><span class="p">(</span><span class="k">struct</span> <span class="n">jme_adapter</span> <span class="o">*</span><span class="n">jme</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">jread32</span><span class="p">(</span><span class="n">jme</span><span class="p">,</span> <span class="n">JME_SMBCSR</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">SMBCSR_EEPROMD</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">SMBCSR_CNACK</span><span class="p">;</span>
		<span class="n">jwrite32</span><span class="p">(</span><span class="n">jme</span><span class="p">,</span> <span class="n">JME_SMBCSR</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">SMBCSR_RELOAD</span><span class="p">;</span>
		<span class="n">jwrite32</span><span class="p">(</span><span class="n">jme</span><span class="p">,</span> <span class="n">JME_SMBCSR</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
		<span class="n">mdelay</span><span class="p">(</span><span class="mi">12</span><span class="p">);</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">JME_EEPROM_RELOAD_TIMEOUT</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="o">--</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">jread32</span><span class="p">(</span><span class="n">jme</span><span class="p">,</span> <span class="n">JME_SMBCSR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">SMBCSR_RELOAD</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;eeprom reload timeout</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">jme_load_macaddr</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">jme_adapter</span> <span class="o">*</span><span class="n">jme</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">macaddr</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">macaddr_lock</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">jread32</span><span class="p">(</span><span class="n">jme</span><span class="p">,</span> <span class="n">JME_RXUMA_LO</span><span class="p">);</span>
	<span class="n">macaddr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span>  <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">;</span>
	<span class="n">macaddr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span>  <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">;</span>
	<span class="n">macaddr</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">;</span>
	<span class="n">macaddr</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">;</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">jread32</span><span class="p">(</span><span class="n">jme</span><span class="p">,</span> <span class="n">JME_RXUMA_HI</span><span class="p">);</span>
	<span class="n">macaddr</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span>  <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">;</span>
	<span class="n">macaddr</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span>  <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">macaddr</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">macaddr_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">jme_set_rx_pcc</span><span class="p">(</span><span class="k">struct</span> <span class="n">jme_adapter</span> <span class="o">*</span><span class="n">jme</span><span class="p">,</span> <span class="kt">int</span> <span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PCC_OFF</span>:
		<span class="n">jwrite32</span><span class="p">(</span><span class="n">jme</span><span class="p">,</span> <span class="n">JME_PCCRX0</span><span class="p">,</span>
			<span class="p">((</span><span class="n">PCC_OFF_TO</span> <span class="o">&lt;&lt;</span> <span class="n">PCCRXTO_SHIFT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">PCCRXTO_MASK</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">((</span><span class="n">PCC_OFF_CNT</span> <span class="o">&lt;&lt;</span> <span class="n">PCCRX_SHIFT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">PCCRX_MASK</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PCC_P1</span>:
		<span class="n">jwrite32</span><span class="p">(</span><span class="n">jme</span><span class="p">,</span> <span class="n">JME_PCCRX0</span><span class="p">,</span>
			<span class="p">((</span><span class="n">PCC_P1_TO</span> <span class="o">&lt;&lt;</span> <span class="n">PCCRXTO_SHIFT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">PCCRXTO_MASK</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">((</span><span class="n">PCC_P1_CNT</span> <span class="o">&lt;&lt;</span> <span class="n">PCCRX_SHIFT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">PCCRX_MASK</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PCC_P2</span>:
		<span class="n">jwrite32</span><span class="p">(</span><span class="n">jme</span><span class="p">,</span> <span class="n">JME_PCCRX0</span><span class="p">,</span>
			<span class="p">((</span><span class="n">PCC_P2_TO</span> <span class="o">&lt;&lt;</span> <span class="n">PCCRXTO_SHIFT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">PCCRXTO_MASK</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">((</span><span class="n">PCC_P2_CNT</span> <span class="o">&lt;&lt;</span> <span class="n">PCCRX_SHIFT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">PCCRX_MASK</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PCC_P3</span>:
		<span class="n">jwrite32</span><span class="p">(</span><span class="n">jme</span><span class="p">,</span> <span class="n">JME_PCCRX0</span><span class="p">,</span>
			<span class="p">((</span><span class="n">PCC_P3_TO</span> <span class="o">&lt;&lt;</span> <span class="n">PCCRXTO_SHIFT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">PCCRXTO_MASK</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">((</span><span class="n">PCC_P3_CNT</span> <span class="o">&lt;&lt;</span> <span class="n">PCCRX_SHIFT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">PCCRX_MASK</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">wmb</span><span class="p">();</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">JME_FLAG_POLL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)))</span>
		<span class="n">netif_info</span><span class="p">(</span><span class="n">jme</span><span class="p">,</span> <span class="n">rx_status</span><span class="p">,</span> <span class="n">jme</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Switched to PCC_P%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">jme_start_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">jme_adapter</span> <span class="o">*</span><span class="n">jme</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">register</span> <span class="k">struct</span> <span class="n">dynpcc_info</span> <span class="o">*</span><span class="n">dpi</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">dpi</span><span class="p">);</span>

	<span class="n">jme_set_rx_pcc</span><span class="p">(</span><span class="n">jme</span><span class="p">,</span> <span class="n">PCC_P1</span><span class="p">);</span>
	<span class="n">dpi</span><span class="o">-&gt;</span><span class="n">cur</span>		<span class="o">=</span> <span class="n">PCC_P1</span><span class="p">;</span>
	<span class="n">dpi</span><span class="o">-&gt;</span><span class="n">attempt</span>		<span class="o">=</span> <span class="n">PCC_P1</span><span class="p">;</span>
	<span class="n">dpi</span><span class="o">-&gt;</span><span class="n">cnt</span>		<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">jwrite32</span><span class="p">(</span><span class="n">jme</span><span class="p">,</span> <span class="n">JME_PCCTX</span><span class="p">,</span>
			<span class="p">((</span><span class="n">PCC_TX_TO</span> <span class="o">&lt;&lt;</span> <span class="n">PCCTXTO_SHIFT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">PCCTXTO_MASK</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">((</span><span class="n">PCC_TX_CNT</span> <span class="o">&lt;&lt;</span> <span class="n">PCCTX_SHIFT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">PCCTX_MASK</span><span class="p">)</span> <span class="o">|</span>
			<span class="n">PCCTXQ0_EN</span>
		<span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Enable Interrupts</span>
<span class="cm">	 */</span>
	<span class="n">jwrite32</span><span class="p">(</span><span class="n">jme</span><span class="p">,</span> <span class="n">JME_IENS</span><span class="p">,</span> <span class="n">INTR_ENABLE</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">jme_stop_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">jme_adapter</span> <span class="o">*</span><span class="n">jme</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * Disable Interrupts</span>
<span class="cm">	 */</span>
	<span class="n">jwrite32f</span><span class="p">(</span><span class="n">jme</span><span class="p">,</span> <span class="n">JME_IENC</span><span class="p">,</span> <span class="n">INTR_ENABLE</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span>
<span class="nf">jme_linkstat_from_phy</span><span class="p">(</span><span class="k">struct</span> <span class="n">jme_adapter</span> <span class="o">*</span><span class="n">jme</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">phylink</span><span class="p">,</span> <span class="n">bmsr</span><span class="p">;</span>

	<span class="n">phylink</span> <span class="o">=</span> <span class="n">jme_mdio_read</span><span class="p">(</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">jme</span><span class="o">-&gt;</span><span class="n">mii_if</span><span class="p">.</span><span class="n">phy_id</span><span class="p">,</span> <span class="mi">17</span><span class="p">);</span>
	<span class="n">bmsr</span> <span class="o">=</span> <span class="n">jme_mdio_read</span><span class="p">(</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">jme</span><span class="o">-&gt;</span><span class="n">mii_if</span><span class="p">.</span><span class="n">phy_id</span><span class="p">,</span> <span class="n">MII_BMSR</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bmsr</span> <span class="o">&amp;</span> <span class="n">BMSR_ANCOMP</span><span class="p">)</span>
		<span class="n">phylink</span> <span class="o">|=</span> <span class="n">PHY_LINK_AUTONEG_COMPLETE</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">phylink</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">jme_set_phyfifo_5level</span><span class="p">(</span><span class="k">struct</span> <span class="n">jme_adapter</span> <span class="o">*</span><span class="n">jme</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">jme_mdio_write</span><span class="p">(</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">jme</span><span class="o">-&gt;</span><span class="n">mii_if</span><span class="p">.</span><span class="n">phy_id</span><span class="p">,</span> <span class="mi">27</span><span class="p">,</span> <span class="mh">0x0004</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">jme_set_phyfifo_8level</span><span class="p">(</span><span class="k">struct</span> <span class="n">jme_adapter</span> <span class="o">*</span><span class="n">jme</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">jme_mdio_write</span><span class="p">(</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">jme</span><span class="o">-&gt;</span><span class="n">mii_if</span><span class="p">.</span><span class="n">phy_id</span><span class="p">,</span> <span class="mi">27</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">jme_check_link</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">testonly</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">jme_adapter</span> <span class="o">*</span><span class="n">jme</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">phylink</span><span class="p">,</span> <span class="n">cnt</span> <span class="o">=</span> <span class="n">JME_SPDRSV_TIMEOUT</span><span class="p">,</span> <span class="n">bmcr</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">linkmsg</span><span class="p">[</span><span class="mi">64</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">linkmsg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">fpgaver</span><span class="p">)</span>
		<span class="n">phylink</span> <span class="o">=</span> <span class="n">jme_linkstat_from_phy</span><span class="p">(</span><span class="n">jme</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">phylink</span> <span class="o">=</span> <span class="n">jread32</span><span class="p">(</span><span class="n">jme</span><span class="p">,</span> <span class="n">JME_PHY_LINK</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">phylink</span> <span class="o">&amp;</span> <span class="n">PHY_LINK_UP</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">phylink</span> <span class="o">&amp;</span> <span class="n">PHY_LINK_AUTONEG_COMPLETE</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * If we did not enable AN</span>
<span class="cm">			 * Speed/Duplex Info should be obtained from SMI</span>
<span class="cm">			 */</span>
			<span class="n">phylink</span> <span class="o">=</span> <span class="n">PHY_LINK_UP</span><span class="p">;</span>

			<span class="n">bmcr</span> <span class="o">=</span> <span class="n">jme_mdio_read</span><span class="p">(</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
						<span class="n">jme</span><span class="o">-&gt;</span><span class="n">mii_if</span><span class="p">.</span><span class="n">phy_id</span><span class="p">,</span>
						<span class="n">MII_BMCR</span><span class="p">);</span>

			<span class="n">phylink</span> <span class="o">|=</span> <span class="p">((</span><span class="n">bmcr</span> <span class="o">&amp;</span> <span class="n">BMCR_SPEED1000</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
					<span class="p">(</span><span class="n">bmcr</span> <span class="o">&amp;</span> <span class="n">BMCR_SPEED100</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span>
					<span class="n">PHY_LINK_SPEED_1000M</span> <span class="o">:</span>
					<span class="p">(</span><span class="n">bmcr</span> <span class="o">&amp;</span> <span class="n">BMCR_SPEED100</span><span class="p">)</span> <span class="o">?</span>
					<span class="n">PHY_LINK_SPEED_100M</span> <span class="o">:</span>
					<span class="n">PHY_LINK_SPEED_10M</span><span class="p">;</span>

			<span class="n">phylink</span> <span class="o">|=</span> <span class="p">(</span><span class="n">bmcr</span> <span class="o">&amp;</span> <span class="n">BMCR_FULLDPLX</span><span class="p">)</span> <span class="o">?</span>
					 <span class="n">PHY_LINK_DUPLEX</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

			<span class="n">strcat</span><span class="p">(</span><span class="n">linkmsg</span><span class="p">,</span> <span class="s">&quot;Forced: &quot;</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * Keep polling for speed/duplex resolve complete</span>
<span class="cm">			 */</span>
			<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">phylink</span> <span class="o">&amp;</span> <span class="n">PHY_LINK_SPEEDDPU_RESOLVED</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
				<span class="o">--</span><span class="n">cnt</span><span class="p">)</span> <span class="p">{</span>

				<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">fpgaver</span><span class="p">)</span>
					<span class="n">phylink</span> <span class="o">=</span> <span class="n">jme_linkstat_from_phy</span><span class="p">(</span><span class="n">jme</span><span class="p">);</span>
				<span class="k">else</span>
					<span class="n">phylink</span> <span class="o">=</span> <span class="n">jread32</span><span class="p">(</span><span class="n">jme</span><span class="p">,</span> <span class="n">JME_PHY_LINK</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cnt</span><span class="p">)</span>
				<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Waiting speed resolve timeout</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

			<span class="n">strcat</span><span class="p">(</span><span class="n">linkmsg</span><span class="p">,</span> <span class="s">&quot;ANed: &quot;</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">phylink</span> <span class="o">==</span> <span class="n">phylink</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">testonly</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

		<span class="n">jme</span><span class="o">-&gt;</span><span class="n">phylink</span> <span class="o">=</span> <span class="n">phylink</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * The speed/duplex setting of jme-&gt;reg_ghc already cleared</span>
<span class="cm">		 * by jme_reset_mac_processor()</span>
<span class="cm">		 */</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">phylink</span> <span class="o">&amp;</span> <span class="n">PHY_LINK_SPEED_MASK</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">PHY_LINK_SPEED_10M</span>:
			<span class="n">jme</span><span class="o">-&gt;</span><span class="n">reg_ghc</span> <span class="o">|=</span> <span class="n">GHC_SPEED_10M</span><span class="p">;</span>
			<span class="n">strcat</span><span class="p">(</span><span class="n">linkmsg</span><span class="p">,</span> <span class="s">&quot;10 Mbps, &quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">PHY_LINK_SPEED_100M</span>:
			<span class="n">jme</span><span class="o">-&gt;</span><span class="n">reg_ghc</span> <span class="o">|=</span> <span class="n">GHC_SPEED_100M</span><span class="p">;</span>
			<span class="n">strcat</span><span class="p">(</span><span class="n">linkmsg</span><span class="p">,</span> <span class="s">&quot;100 Mbps, &quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">PHY_LINK_SPEED_1000M</span>:
			<span class="n">jme</span><span class="o">-&gt;</span><span class="n">reg_ghc</span> <span class="o">|=</span> <span class="n">GHC_SPEED_1000M</span><span class="p">;</span>
			<span class="n">strcat</span><span class="p">(</span><span class="n">linkmsg</span><span class="p">,</span> <span class="s">&quot;1000 Mbps, &quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">phylink</span> <span class="o">&amp;</span> <span class="n">PHY_LINK_DUPLEX</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">jwrite32</span><span class="p">(</span><span class="n">jme</span><span class="p">,</span> <span class="n">JME_TXMCS</span><span class="p">,</span> <span class="n">TXMCS_DEFAULT</span><span class="p">);</span>
			<span class="n">jwrite32</span><span class="p">(</span><span class="n">jme</span><span class="p">,</span> <span class="n">JME_TXTRHD</span><span class="p">,</span> <span class="n">TXTRHD_FULLDUPLEX</span><span class="p">);</span>
			<span class="n">jme</span><span class="o">-&gt;</span><span class="n">reg_ghc</span> <span class="o">|=</span> <span class="n">GHC_DPX</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">jwrite32</span><span class="p">(</span><span class="n">jme</span><span class="p">,</span> <span class="n">JME_TXMCS</span><span class="p">,</span> <span class="n">TXMCS_DEFAULT</span> <span class="o">|</span>
						<span class="n">TXMCS_BACKOFF</span> <span class="o">|</span>
						<span class="n">TXMCS_CARRIERSENSE</span> <span class="o">|</span>
						<span class="n">TXMCS_COLLISION</span><span class="p">);</span>
			<span class="n">jwrite32</span><span class="p">(</span><span class="n">jme</span><span class="p">,</span> <span class="n">JME_TXTRHD</span><span class="p">,</span> <span class="n">TXTRHD_HALFDUPLEX</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">jwrite32</span><span class="p">(</span><span class="n">jme</span><span class="p">,</span> <span class="n">JME_GHC</span><span class="p">,</span> <span class="n">jme</span><span class="o">-&gt;</span><span class="n">reg_ghc</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">is_buggy250</span><span class="p">(</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="n">jme</span><span class="o">-&gt;</span><span class="n">chiprev</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">jme</span><span class="o">-&gt;</span><span class="n">reg_gpreg1</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">GPREG1_HALFMODEPATCH</span> <span class="o">|</span>
					     <span class="n">GPREG1_RSSPATCH</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">phylink</span> <span class="o">&amp;</span> <span class="n">PHY_LINK_DUPLEX</span><span class="p">))</span>
				<span class="n">jme</span><span class="o">-&gt;</span><span class="n">reg_gpreg1</span> <span class="o">|=</span> <span class="n">GPREG1_HALFMODEPATCH</span><span class="p">;</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">phylink</span> <span class="o">&amp;</span> <span class="n">PHY_LINK_SPEED_MASK</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">PHY_LINK_SPEED_10M</span>:
				<span class="n">jme_set_phyfifo_8level</span><span class="p">(</span><span class="n">jme</span><span class="p">);</span>
				<span class="n">jme</span><span class="o">-&gt;</span><span class="n">reg_gpreg1</span> <span class="o">|=</span> <span class="n">GPREG1_RSSPATCH</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">PHY_LINK_SPEED_100M</span>:
				<span class="n">jme_set_phyfifo_5level</span><span class="p">(</span><span class="n">jme</span><span class="p">);</span>
				<span class="n">jme</span><span class="o">-&gt;</span><span class="n">reg_gpreg1</span> <span class="o">|=</span> <span class="n">GPREG1_RSSPATCH</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">PHY_LINK_SPEED_1000M</span>:
				<span class="n">jme_set_phyfifo_8level</span><span class="p">(</span><span class="n">jme</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">jwrite32</span><span class="p">(</span><span class="n">jme</span><span class="p">,</span> <span class="n">JME_GPREG1</span><span class="p">,</span> <span class="n">jme</span><span class="o">-&gt;</span><span class="n">reg_gpreg1</span><span class="p">);</span>

		<span class="n">strcat</span><span class="p">(</span><span class="n">linkmsg</span><span class="p">,</span> <span class="p">(</span><span class="n">phylink</span> <span class="o">&amp;</span> <span class="n">PHY_LINK_DUPLEX</span><span class="p">)</span> <span class="o">?</span>
					<span class="s">&quot;Full-Duplex, &quot;</span> <span class="o">:</span>
					<span class="s">&quot;Half-Duplex, &quot;</span><span class="p">);</span>
		<span class="n">strcat</span><span class="p">(</span><span class="n">linkmsg</span><span class="p">,</span> <span class="p">(</span><span class="n">phylink</span> <span class="o">&amp;</span> <span class="n">PHY_LINK_MDI_STAT</span><span class="p">)</span> <span class="o">?</span>
					<span class="s">&quot;MDI-X&quot;</span> <span class="o">:</span>
					<span class="s">&quot;MDI&quot;</span><span class="p">);</span>
		<span class="n">netif_info</span><span class="p">(</span><span class="n">jme</span><span class="p">,</span> <span class="n">link</span><span class="p">,</span> <span class="n">jme</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Link is up at %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">linkmsg</span><span class="p">);</span>
		<span class="n">netif_carrier_on</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">testonly</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

		<span class="n">netif_info</span><span class="p">(</span><span class="n">jme</span><span class="p">,</span> <span class="n">link</span><span class="p">,</span> <span class="n">jme</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Link is down</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">jme</span><span class="o">-&gt;</span><span class="n">phylink</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">netif_carrier_off</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="p">}</span>

<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">jme_setup_tx_resources</span><span class="p">(</span><span class="k">struct</span> <span class="n">jme_adapter</span> <span class="o">*</span><span class="n">jme</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">jme_ring</span> <span class="o">*</span><span class="n">txring</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">txring</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>

	<span class="n">txring</span><span class="o">-&gt;</span><span class="n">alloc</span> <span class="o">=</span> <span class="n">dma_alloc_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">),</span>
				   <span class="n">TX_RING_ALLOC_SIZE</span><span class="p">(</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">tx_ring_size</span><span class="p">),</span>
				   <span class="o">&amp;</span><span class="p">(</span><span class="n">txring</span><span class="o">-&gt;</span><span class="n">dmaalloc</span><span class="p">),</span>
				   <span class="n">GFP_ATOMIC</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">txring</span><span class="o">-&gt;</span><span class="n">alloc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_set_null</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * 16 Bytes align</span>
<span class="cm">	 */</span>
	<span class="n">txring</span><span class="o">-&gt;</span><span class="n">desc</span>		<span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">ALIGN</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)(</span><span class="n">txring</span><span class="o">-&gt;</span><span class="n">alloc</span><span class="p">),</span>
						<span class="n">RING_DESC_ALIGN</span><span class="p">);</span>
	<span class="n">txring</span><span class="o">-&gt;</span><span class="n">dma</span>		<span class="o">=</span> <span class="n">ALIGN</span><span class="p">(</span><span class="n">txring</span><span class="o">-&gt;</span><span class="n">dmaalloc</span><span class="p">,</span> <span class="n">RING_DESC_ALIGN</span><span class="p">);</span>
	<span class="n">txring</span><span class="o">-&gt;</span><span class="n">next_to_use</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">txring</span><span class="o">-&gt;</span><span class="n">next_to_clean</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">txring</span><span class="o">-&gt;</span><span class="n">nr_free</span><span class="p">,</span> <span class="n">jme</span><span class="o">-&gt;</span><span class="n">tx_ring_size</span><span class="p">);</span>

	<span class="n">txring</span><span class="o">-&gt;</span><span class="n">bufinf</span>		<span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">jme_buffer_info</span><span class="p">)</span> <span class="o">*</span>
					<span class="n">jme</span><span class="o">-&gt;</span><span class="n">tx_ring_size</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">txring</span><span class="o">-&gt;</span><span class="n">bufinf</span><span class="p">)))</span>
		<span class="k">goto</span> <span class="n">err_free_txring</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Initialize Transmit Descriptors</span>
<span class="cm">	 */</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">txring</span><span class="o">-&gt;</span><span class="n">alloc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">TX_RING_ALLOC_SIZE</span><span class="p">(</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">tx_ring_size</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">txring</span><span class="o">-&gt;</span><span class="n">bufinf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
		<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">jme_buffer_info</span><span class="p">)</span> <span class="o">*</span> <span class="n">jme</span><span class="o">-&gt;</span><span class="n">tx_ring_size</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_free_txring:</span>
	<span class="n">dma_free_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">),</span>
			  <span class="n">TX_RING_ALLOC_SIZE</span><span class="p">(</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">tx_ring_size</span><span class="p">),</span>
			  <span class="n">txring</span><span class="o">-&gt;</span><span class="n">alloc</span><span class="p">,</span>
			  <span class="n">txring</span><span class="o">-&gt;</span><span class="n">dmaalloc</span><span class="p">);</span>

<span class="nl">err_set_null:</span>
	<span class="n">txring</span><span class="o">-&gt;</span><span class="n">desc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">txring</span><span class="o">-&gt;</span><span class="n">dmaalloc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">txring</span><span class="o">-&gt;</span><span class="n">dma</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">txring</span><span class="o">-&gt;</span><span class="n">bufinf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">jme_free_tx_resources</span><span class="p">(</span><span class="k">struct</span> <span class="n">jme_adapter</span> <span class="o">*</span><span class="n">jme</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">jme_ring</span> <span class="o">*</span><span class="n">txring</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">txring</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="k">struct</span> <span class="n">jme_buffer_info</span> <span class="o">*</span><span class="n">txbi</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">txring</span><span class="o">-&gt;</span><span class="n">alloc</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">txring</span><span class="o">-&gt;</span><span class="n">bufinf</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">jme</span><span class="o">-&gt;</span><span class="n">tx_ring_size</span> <span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">txbi</span> <span class="o">=</span> <span class="n">txring</span><span class="o">-&gt;</span><span class="n">bufinf</span> <span class="o">+</span> <span class="n">i</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">txbi</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">txbi</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">);</span>
					<span class="n">txbi</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">txbi</span><span class="o">-&gt;</span><span class="n">mapping</span>		<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">txbi</span><span class="o">-&gt;</span><span class="n">len</span>		<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">txbi</span><span class="o">-&gt;</span><span class="n">nr_desc</span>		<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">txbi</span><span class="o">-&gt;</span><span class="n">start_xmit</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">txring</span><span class="o">-&gt;</span><span class="n">bufinf</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">dma_free_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">),</span>
				  <span class="n">TX_RING_ALLOC_SIZE</span><span class="p">(</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">tx_ring_size</span><span class="p">),</span>
				  <span class="n">txring</span><span class="o">-&gt;</span><span class="n">alloc</span><span class="p">,</span>
				  <span class="n">txring</span><span class="o">-&gt;</span><span class="n">dmaalloc</span><span class="p">);</span>

		<span class="n">txring</span><span class="o">-&gt;</span><span class="n">alloc</span>		<span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">txring</span><span class="o">-&gt;</span><span class="n">desc</span>		<span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">txring</span><span class="o">-&gt;</span><span class="n">dmaalloc</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">txring</span><span class="o">-&gt;</span><span class="n">dma</span>		<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">txring</span><span class="o">-&gt;</span><span class="n">bufinf</span>		<span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">txring</span><span class="o">-&gt;</span><span class="n">next_to_use</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">txring</span><span class="o">-&gt;</span><span class="n">next_to_clean</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">txring</span><span class="o">-&gt;</span><span class="n">nr_free</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">jme_enable_tx_engine</span><span class="p">(</span><span class="k">struct</span> <span class="n">jme_adapter</span> <span class="o">*</span><span class="n">jme</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * Select Queue 0</span>
<span class="cm">	 */</span>
	<span class="n">jwrite32</span><span class="p">(</span><span class="n">jme</span><span class="p">,</span> <span class="n">JME_TXCS</span><span class="p">,</span> <span class="n">TXCS_DEFAULT</span> <span class="o">|</span> <span class="n">TXCS_SELECT_QUEUE0</span><span class="p">);</span>
	<span class="n">wmb</span><span class="p">();</span>

	<span class="cm">/*</span>
<span class="cm">	 * Setup TX Queue 0 DMA Bass Address</span>
<span class="cm">	 */</span>
	<span class="n">jwrite32</span><span class="p">(</span><span class="n">jme</span><span class="p">,</span> <span class="n">JME_TXDBA_LO</span><span class="p">,</span> <span class="p">(</span><span class="n">__u64</span><span class="p">)</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">txring</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">dma</span> <span class="o">&amp;</span> <span class="mh">0xFFFFFFFFUL</span><span class="p">);</span>
	<span class="n">jwrite32</span><span class="p">(</span><span class="n">jme</span><span class="p">,</span> <span class="n">JME_TXDBA_HI</span><span class="p">,</span> <span class="p">(</span><span class="n">__u64</span><span class="p">)(</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">txring</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">dma</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">);</span>
	<span class="n">jwrite32</span><span class="p">(</span><span class="n">jme</span><span class="p">,</span> <span class="n">JME_TXNDA</span><span class="p">,</span> <span class="p">(</span><span class="n">__u64</span><span class="p">)</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">txring</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">dma</span> <span class="o">&amp;</span> <span class="mh">0xFFFFFFFFUL</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Setup TX Descptor Count</span>
<span class="cm">	 */</span>
	<span class="n">jwrite32</span><span class="p">(</span><span class="n">jme</span><span class="p">,</span> <span class="n">JME_TXQDC</span><span class="p">,</span> <span class="n">jme</span><span class="o">-&gt;</span><span class="n">tx_ring_size</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Enable TX Engine</span>
<span class="cm">	 */</span>
	<span class="n">wmb</span><span class="p">();</span>
	<span class="n">jwrite32f</span><span class="p">(</span><span class="n">jme</span><span class="p">,</span> <span class="n">JME_TXCS</span><span class="p">,</span> <span class="n">jme</span><span class="o">-&gt;</span><span class="n">reg_txcs</span> <span class="o">|</span>
				<span class="n">TXCS_SELECT_QUEUE0</span> <span class="o">|</span>
				<span class="n">TXCS_ENABLE</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Start clock for TX MAC Processor</span>
<span class="cm">	 */</span>
	<span class="n">jme_mac_txclk_on</span><span class="p">(</span><span class="n">jme</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">jme_restart_tx_engine</span><span class="p">(</span><span class="k">struct</span> <span class="n">jme_adapter</span> <span class="o">*</span><span class="n">jme</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * Restart TX Engine</span>
<span class="cm">	 */</span>
	<span class="n">jwrite32</span><span class="p">(</span><span class="n">jme</span><span class="p">,</span> <span class="n">JME_TXCS</span><span class="p">,</span> <span class="n">jme</span><span class="o">-&gt;</span><span class="n">reg_txcs</span> <span class="o">|</span>
				<span class="n">TXCS_SELECT_QUEUE0</span> <span class="o">|</span>
				<span class="n">TXCS_ENABLE</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">jme_disable_tx_engine</span><span class="p">(</span><span class="k">struct</span> <span class="n">jme_adapter</span> <span class="o">*</span><span class="n">jme</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Disable TX Engine</span>
<span class="cm">	 */</span>
	<span class="n">jwrite32</span><span class="p">(</span><span class="n">jme</span><span class="p">,</span> <span class="n">JME_TXCS</span><span class="p">,</span> <span class="n">jme</span><span class="o">-&gt;</span><span class="n">reg_txcs</span> <span class="o">|</span> <span class="n">TXCS_SELECT_QUEUE0</span><span class="p">);</span>
	<span class="n">wmb</span><span class="p">();</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">jread32</span><span class="p">(</span><span class="n">jme</span><span class="p">,</span> <span class="n">JME_TXCS</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">JME_TX_DISABLE_TIMEOUT</span> <span class="p">;</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">TXCS_ENABLE</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">;</span> <span class="o">--</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">jread32</span><span class="p">(</span><span class="n">jme</span><span class="p">,</span> <span class="n">JME_TXCS</span><span class="p">);</span>
		<span class="n">rmb</span><span class="p">();</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">i</span><span class="p">)</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Disable TX engine timeout</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Stop clock for TX MAC Processor</span>
<span class="cm">	 */</span>
	<span class="n">jme_mac_txclk_off</span><span class="p">(</span><span class="n">jme</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">jme_set_clean_rxdesc</span><span class="p">(</span><span class="k">struct</span> <span class="n">jme_adapter</span> <span class="o">*</span><span class="n">jme</span><span class="p">,</span> <span class="kt">int</span> <span class="n">i</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">jme_ring</span> <span class="o">*</span><span class="n">rxring</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">rxring</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="k">register</span> <span class="k">struct</span> <span class="n">rxdesc</span> <span class="o">*</span><span class="n">rxdesc</span> <span class="o">=</span> <span class="n">rxring</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">jme_buffer_info</span> <span class="o">*</span><span class="n">rxbi</span> <span class="o">=</span> <span class="n">rxring</span><span class="o">-&gt;</span><span class="n">bufinf</span><span class="p">;</span>
	<span class="n">rxdesc</span> <span class="o">+=</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">rxbi</span> <span class="o">+=</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">rxdesc</span><span class="o">-&gt;</span><span class="n">dw</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">rxdesc</span><span class="o">-&gt;</span><span class="n">dw</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">rxdesc</span><span class="o">-&gt;</span><span class="n">desc1</span><span class="p">.</span><span class="n">bufaddrh</span>	<span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">((</span><span class="n">__u64</span><span class="p">)</span><span class="n">rxbi</span><span class="o">-&gt;</span><span class="n">mapping</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">);</span>
	<span class="n">rxdesc</span><span class="o">-&gt;</span><span class="n">desc1</span><span class="p">.</span><span class="n">bufaddrl</span>	<span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span>
					<span class="p">(</span><span class="n">__u64</span><span class="p">)</span><span class="n">rxbi</span><span class="o">-&gt;</span><span class="n">mapping</span> <span class="o">&amp;</span> <span class="mh">0xFFFFFFFFUL</span><span class="p">);</span>
	<span class="n">rxdesc</span><span class="o">-&gt;</span><span class="n">desc1</span><span class="p">.</span><span class="n">datalen</span>	<span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">rxbi</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">NETIF_F_HIGHDMA</span><span class="p">)</span>
		<span class="n">rxdesc</span><span class="o">-&gt;</span><span class="n">desc1</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">RXFLAG_64BIT</span><span class="p">;</span>
	<span class="n">wmb</span><span class="p">();</span>
	<span class="n">rxdesc</span><span class="o">-&gt;</span><span class="n">desc1</span><span class="p">.</span><span class="n">flags</span>	<span class="o">|=</span> <span class="n">RXFLAG_OWN</span> <span class="o">|</span> <span class="n">RXFLAG_INT</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">jme_make_new_rx_buf</span><span class="p">(</span><span class="k">struct</span> <span class="n">jme_adapter</span> <span class="o">*</span><span class="n">jme</span><span class="p">,</span> <span class="kt">int</span> <span class="n">i</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">jme_ring</span> <span class="o">*</span><span class="n">rxring</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">rxring</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="k">struct</span> <span class="n">jme_buffer_info</span> <span class="o">*</span><span class="n">rxbi</span> <span class="o">=</span> <span class="n">rxring</span><span class="o">-&gt;</span><span class="n">bufinf</span> <span class="o">+</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">mapping</span><span class="p">;</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">netdev_alloc_skb</span><span class="p">(</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
		<span class="n">jme</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mtu</span> <span class="o">+</span> <span class="n">RX_EXTRA_LEN</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">mapping</span> <span class="o">=</span> <span class="n">pci_map_page</span><span class="p">(</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">virt_to_page</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">),</span>
			       <span class="n">offset_in_page</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">),</span> <span class="n">skb_tailroom</span><span class="p">(</span><span class="n">skb</span><span class="p">),</span>
			       <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">pci_dma_mapping_error</span><span class="p">(</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">mapping</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">rxbi</span><span class="o">-&gt;</span><span class="n">mapping</span><span class="p">))</span>
		<span class="n">pci_unmap_page</span><span class="p">(</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">rxbi</span><span class="o">-&gt;</span><span class="n">mapping</span><span class="p">,</span>
			       <span class="n">rxbi</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>

	<span class="n">rxbi</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>
	<span class="n">rxbi</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">skb_tailroom</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">rxbi</span><span class="o">-&gt;</span><span class="n">mapping</span> <span class="o">=</span> <span class="n">mapping</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">jme_free_rx_buf</span><span class="p">(</span><span class="k">struct</span> <span class="n">jme_adapter</span> <span class="o">*</span><span class="n">jme</span><span class="p">,</span> <span class="kt">int</span> <span class="n">i</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">jme_ring</span> <span class="o">*</span><span class="n">rxring</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">rxring</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="k">struct</span> <span class="n">jme_buffer_info</span> <span class="o">*</span><span class="n">rxbi</span> <span class="o">=</span> <span class="n">rxring</span><span class="o">-&gt;</span><span class="n">bufinf</span><span class="p">;</span>
	<span class="n">rxbi</span> <span class="o">+=</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rxbi</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pci_unmap_page</span><span class="p">(</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span>
				 <span class="n">rxbi</span><span class="o">-&gt;</span><span class="n">mapping</span><span class="p">,</span>
				 <span class="n">rxbi</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span>
				 <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>
		<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">rxbi</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">);</span>
		<span class="n">rxbi</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">rxbi</span><span class="o">-&gt;</span><span class="n">mapping</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">rxbi</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">jme_free_rx_resources</span><span class="p">(</span><span class="k">struct</span> <span class="n">jme_adapter</span> <span class="o">*</span><span class="n">jme</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">jme_ring</span> <span class="o">*</span><span class="n">rxring</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">rxring</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rxring</span><span class="o">-&gt;</span><span class="n">alloc</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rxring</span><span class="o">-&gt;</span><span class="n">bufinf</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">jme</span><span class="o">-&gt;</span><span class="n">rx_ring_size</span> <span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
				<span class="n">jme_free_rx_buf</span><span class="p">(</span><span class="n">jme</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">rxring</span><span class="o">-&gt;</span><span class="n">bufinf</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">dma_free_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">),</span>
				  <span class="n">RX_RING_ALLOC_SIZE</span><span class="p">(</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">rx_ring_size</span><span class="p">),</span>
				  <span class="n">rxring</span><span class="o">-&gt;</span><span class="n">alloc</span><span class="p">,</span>
				  <span class="n">rxring</span><span class="o">-&gt;</span><span class="n">dmaalloc</span><span class="p">);</span>
		<span class="n">rxring</span><span class="o">-&gt;</span><span class="n">alloc</span>    <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">rxring</span><span class="o">-&gt;</span><span class="n">desc</span>     <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">rxring</span><span class="o">-&gt;</span><span class="n">dmaalloc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">rxring</span><span class="o">-&gt;</span><span class="n">dma</span>      <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">rxring</span><span class="o">-&gt;</span><span class="n">bufinf</span>   <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">rxring</span><span class="o">-&gt;</span><span class="n">next_to_use</span>   <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rxring</span><span class="o">-&gt;</span><span class="n">next_to_clean</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">jme_setup_rx_resources</span><span class="p">(</span><span class="k">struct</span> <span class="n">jme_adapter</span> <span class="o">*</span><span class="n">jme</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">jme_ring</span> <span class="o">*</span><span class="n">rxring</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">rxring</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>

	<span class="n">rxring</span><span class="o">-&gt;</span><span class="n">alloc</span> <span class="o">=</span> <span class="n">dma_alloc_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">),</span>
				   <span class="n">RX_RING_ALLOC_SIZE</span><span class="p">(</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">rx_ring_size</span><span class="p">),</span>
				   <span class="o">&amp;</span><span class="p">(</span><span class="n">rxring</span><span class="o">-&gt;</span><span class="n">dmaalloc</span><span class="p">),</span>
				   <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rxring</span><span class="o">-&gt;</span><span class="n">alloc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_set_null</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * 16 Bytes align</span>
<span class="cm">	 */</span>
	<span class="n">rxring</span><span class="o">-&gt;</span><span class="n">desc</span>		<span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">ALIGN</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)(</span><span class="n">rxring</span><span class="o">-&gt;</span><span class="n">alloc</span><span class="p">),</span>
						<span class="n">RING_DESC_ALIGN</span><span class="p">);</span>
	<span class="n">rxring</span><span class="o">-&gt;</span><span class="n">dma</span>		<span class="o">=</span> <span class="n">ALIGN</span><span class="p">(</span><span class="n">rxring</span><span class="o">-&gt;</span><span class="n">dmaalloc</span><span class="p">,</span> <span class="n">RING_DESC_ALIGN</span><span class="p">);</span>
	<span class="n">rxring</span><span class="o">-&gt;</span><span class="n">next_to_use</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rxring</span><span class="o">-&gt;</span><span class="n">next_to_clean</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">rxring</span><span class="o">-&gt;</span><span class="n">bufinf</span>		<span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">jme_buffer_info</span><span class="p">)</span> <span class="o">*</span>
					<span class="n">jme</span><span class="o">-&gt;</span><span class="n">rx_ring_size</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">rxring</span><span class="o">-&gt;</span><span class="n">bufinf</span><span class="p">)))</span>
		<span class="k">goto</span> <span class="n">err_free_rxring</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Initiallize Receive Descriptors</span>
<span class="cm">	 */</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">rxring</span><span class="o">-&gt;</span><span class="n">bufinf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
		<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">jme_buffer_info</span><span class="p">)</span> <span class="o">*</span> <span class="n">jme</span><span class="o">-&gt;</span><span class="n">rx_ring_size</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">jme</span><span class="o">-&gt;</span><span class="n">rx_ring_size</span> <span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">jme_make_new_rx_buf</span><span class="p">(</span><span class="n">jme</span><span class="p">,</span> <span class="n">i</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">jme_free_rx_resources</span><span class="p">(</span><span class="n">jme</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">jme_set_clean_rxdesc</span><span class="p">(</span><span class="n">jme</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_free_rxring:</span>
	<span class="n">dma_free_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">),</span>
			  <span class="n">RX_RING_ALLOC_SIZE</span><span class="p">(</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">rx_ring_size</span><span class="p">),</span>
			  <span class="n">rxring</span><span class="o">-&gt;</span><span class="n">alloc</span><span class="p">,</span>
			  <span class="n">rxring</span><span class="o">-&gt;</span><span class="n">dmaalloc</span><span class="p">);</span>
<span class="nl">err_set_null:</span>
	<span class="n">rxring</span><span class="o">-&gt;</span><span class="n">desc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">rxring</span><span class="o">-&gt;</span><span class="n">dmaalloc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">rxring</span><span class="o">-&gt;</span><span class="n">dma</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">rxring</span><span class="o">-&gt;</span><span class="n">bufinf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">jme_enable_rx_engine</span><span class="p">(</span><span class="k">struct</span> <span class="n">jme_adapter</span> <span class="o">*</span><span class="n">jme</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * Select Queue 0</span>
<span class="cm">	 */</span>
	<span class="n">jwrite32</span><span class="p">(</span><span class="n">jme</span><span class="p">,</span> <span class="n">JME_RXCS</span><span class="p">,</span> <span class="n">jme</span><span class="o">-&gt;</span><span class="n">reg_rxcs</span> <span class="o">|</span>
				<span class="n">RXCS_QUEUESEL_Q0</span><span class="p">);</span>
	<span class="n">wmb</span><span class="p">();</span>

	<span class="cm">/*</span>
<span class="cm">	 * Setup RX DMA Bass Address</span>
<span class="cm">	 */</span>
	<span class="n">jwrite32</span><span class="p">(</span><span class="n">jme</span><span class="p">,</span> <span class="n">JME_RXDBA_LO</span><span class="p">,</span> <span class="p">(</span><span class="n">__u64</span><span class="p">)(</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">rxring</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">dma</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFFFFFFFFUL</span><span class="p">);</span>
	<span class="n">jwrite32</span><span class="p">(</span><span class="n">jme</span><span class="p">,</span> <span class="n">JME_RXDBA_HI</span><span class="p">,</span> <span class="p">(</span><span class="n">__u64</span><span class="p">)(</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">rxring</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">dma</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">);</span>
	<span class="n">jwrite32</span><span class="p">(</span><span class="n">jme</span><span class="p">,</span> <span class="n">JME_RXNDA</span><span class="p">,</span> <span class="p">(</span><span class="n">__u64</span><span class="p">)(</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">rxring</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">dma</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFFFFFFFFUL</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Setup RX Descriptor Count</span>
<span class="cm">	 */</span>
	<span class="n">jwrite32</span><span class="p">(</span><span class="n">jme</span><span class="p">,</span> <span class="n">JME_RXQDC</span><span class="p">,</span> <span class="n">jme</span><span class="o">-&gt;</span><span class="n">rx_ring_size</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Setup Unicast Filter</span>
<span class="cm">	 */</span>
	<span class="n">jme_set_unicastaddr</span><span class="p">(</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">jme_set_multi</span><span class="p">(</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Enable RX Engine</span>
<span class="cm">	 */</span>
	<span class="n">wmb</span><span class="p">();</span>
	<span class="n">jwrite32f</span><span class="p">(</span><span class="n">jme</span><span class="p">,</span> <span class="n">JME_RXCS</span><span class="p">,</span> <span class="n">jme</span><span class="o">-&gt;</span><span class="n">reg_rxcs</span> <span class="o">|</span>
				<span class="n">RXCS_QUEUESEL_Q0</span> <span class="o">|</span>
				<span class="n">RXCS_ENABLE</span> <span class="o">|</span>
				<span class="n">RXCS_QST</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Start clock for RX MAC Processor</span>
<span class="cm">	 */</span>
	<span class="n">jme_mac_rxclk_on</span><span class="p">(</span><span class="n">jme</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">jme_restart_rx_engine</span><span class="p">(</span><span class="k">struct</span> <span class="n">jme_adapter</span> <span class="o">*</span><span class="n">jme</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * Start RX Engine</span>
<span class="cm">	 */</span>
	<span class="n">jwrite32</span><span class="p">(</span><span class="n">jme</span><span class="p">,</span> <span class="n">JME_RXCS</span><span class="p">,</span> <span class="n">jme</span><span class="o">-&gt;</span><span class="n">reg_rxcs</span> <span class="o">|</span>
				<span class="n">RXCS_QUEUESEL_Q0</span> <span class="o">|</span>
				<span class="n">RXCS_ENABLE</span> <span class="o">|</span>
				<span class="n">RXCS_QST</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">jme_disable_rx_engine</span><span class="p">(</span><span class="k">struct</span> <span class="n">jme_adapter</span> <span class="o">*</span><span class="n">jme</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Disable RX Engine</span>
<span class="cm">	 */</span>
	<span class="n">jwrite32</span><span class="p">(</span><span class="n">jme</span><span class="p">,</span> <span class="n">JME_RXCS</span><span class="p">,</span> <span class="n">jme</span><span class="o">-&gt;</span><span class="n">reg_rxcs</span><span class="p">);</span>
	<span class="n">wmb</span><span class="p">();</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">jread32</span><span class="p">(</span><span class="n">jme</span><span class="p">,</span> <span class="n">JME_RXCS</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">JME_RX_DISABLE_TIMEOUT</span> <span class="p">;</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">RXCS_ENABLE</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">;</span> <span class="o">--</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">jread32</span><span class="p">(</span><span class="n">jme</span><span class="p">,</span> <span class="n">JME_RXCS</span><span class="p">);</span>
		<span class="n">rmb</span><span class="p">();</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">i</span><span class="p">)</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Disable RX engine timeout</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Stop clock for RX MAC Processor</span>
<span class="cm">	 */</span>
	<span class="n">jme_mac_rxclk_off</span><span class="p">(</span><span class="n">jme</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u16</span>
<span class="nf">jme_udpsum</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">csum</span> <span class="o">=</span> <span class="mh">0xFFFFu</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">ETH_HLEN</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">iphdr</span><span class="p">)))</span>
		<span class="k">return</span> <span class="n">csum</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">!=</span> <span class="n">htons</span><span class="p">(</span><span class="n">ETH_P_IP</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">csum</span><span class="p">;</span>
	<span class="n">skb_set_network_header</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">ETH_HLEN</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ip_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">!=</span> <span class="n">IPPROTO_UDP</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">ETH_HLEN</span> <span class="o">+</span>
			<span class="p">(</span><span class="n">ip_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ihl</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">udphdr</span><span class="p">))))</span> <span class="p">{</span>
		<span class="n">skb_reset_network_header</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">csum</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">skb_set_transport_header</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span>
			<span class="n">ETH_HLEN</span> <span class="o">+</span> <span class="p">(</span><span class="n">ip_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ihl</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">));</span>
	<span class="n">csum</span> <span class="o">=</span> <span class="n">udp_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">check</span><span class="p">;</span>
	<span class="n">skb_reset_transport_header</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">skb_reset_network_header</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">csum</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">jme_rxsum_ok</span><span class="p">(</span><span class="k">struct</span> <span class="n">jme_adapter</span> <span class="o">*</span><span class="n">jme</span><span class="p">,</span> <span class="n">u16</span> <span class="n">flags</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">RXWBFLAG_TCPON</span> <span class="o">|</span> <span class="n">RXWBFLAG_UDPON</span> <span class="o">|</span> <span class="n">RXWBFLAG_IPV4</span><span class="p">)))</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">((</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">RXWBFLAG_MF</span> <span class="o">|</span> <span class="n">RXWBFLAG_TCPON</span> <span class="o">|</span> <span class="n">RXWBFLAG_TCPCS</span><span class="p">))</span>
			<span class="o">==</span> <span class="n">RXWBFLAG_TCPON</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">RXWBFLAG_IPV4</span><span class="p">)</span>
			<span class="n">netif_err</span><span class="p">(</span><span class="n">jme</span><span class="p">,</span> <span class="n">rx_err</span><span class="p">,</span> <span class="n">jme</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;TCP Checksum error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">((</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">RXWBFLAG_MF</span> <span class="o">|</span> <span class="n">RXWBFLAG_UDPON</span> <span class="o">|</span> <span class="n">RXWBFLAG_UDPCS</span><span class="p">))</span>
			<span class="o">==</span> <span class="n">RXWBFLAG_UDPON</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">jme_udpsum</span><span class="p">(</span><span class="n">skb</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">RXWBFLAG_IPV4</span><span class="p">)</span>
			<span class="n">netif_err</span><span class="p">(</span><span class="n">jme</span><span class="p">,</span> <span class="n">rx_err</span><span class="p">,</span> <span class="n">jme</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;UDP Checksum error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">((</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">RXWBFLAG_IPV4</span> <span class="o">|</span> <span class="n">RXWBFLAG_IPCS</span><span class="p">))</span>
			<span class="o">==</span> <span class="n">RXWBFLAG_IPV4</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">netif_err</span><span class="p">(</span><span class="n">jme</span><span class="p">,</span> <span class="n">rx_err</span><span class="p">,</span> <span class="n">jme</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;IPv4 Checksum error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">jme_alloc_and_feed_skb</span><span class="p">(</span><span class="k">struct</span> <span class="n">jme_adapter</span> <span class="o">*</span><span class="n">jme</span><span class="p">,</span> <span class="kt">int</span> <span class="n">idx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">jme_ring</span> <span class="o">*</span><span class="n">rxring</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">rxring</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="k">struct</span> <span class="n">rxdesc</span> <span class="o">*</span><span class="n">rxdesc</span> <span class="o">=</span> <span class="n">rxring</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">jme_buffer_info</span> <span class="o">*</span><span class="n">rxbi</span> <span class="o">=</span> <span class="n">rxring</span><span class="o">-&gt;</span><span class="n">bufinf</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">framesize</span><span class="p">;</span>

	<span class="n">rxdesc</span> <span class="o">+=</span> <span class="n">idx</span><span class="p">;</span>
	<span class="n">rxbi</span> <span class="o">+=</span> <span class="n">idx</span><span class="p">;</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">rxbi</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">;</span>
	<span class="n">pci_dma_sync_single_for_cpu</span><span class="p">(</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span>
					<span class="n">rxbi</span><span class="o">-&gt;</span><span class="n">mapping</span><span class="p">,</span>
					<span class="n">rxbi</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span>
					<span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">jme_make_new_rx_buf</span><span class="p">(</span><span class="n">jme</span><span class="p">,</span> <span class="n">idx</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">pci_dma_sync_single_for_device</span><span class="p">(</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span>
						<span class="n">rxbi</span><span class="o">-&gt;</span><span class="n">mapping</span><span class="p">,</span>
						<span class="n">rxbi</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span>
						<span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>

		<span class="o">++</span><span class="p">(</span><span class="n">NET_STAT</span><span class="p">(</span><span class="n">jme</span><span class="p">).</span><span class="n">rx_dropped</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">framesize</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">rxdesc</span><span class="o">-&gt;</span><span class="n">descwb</span><span class="p">.</span><span class="n">framesize</span><span class="p">)</span>
				<span class="o">-</span> <span class="n">RX_PREPAD_SIZE</span><span class="p">;</span>

		<span class="n">skb_reserve</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">RX_PREPAD_SIZE</span><span class="p">);</span>
		<span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">framesize</span><span class="p">);</span>
		<span class="n">skb</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">eth_type_trans</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">jme</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">jme_rxsum_ok</span><span class="p">(</span><span class="n">jme</span><span class="p">,</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">rxdesc</span><span class="o">-&gt;</span><span class="n">descwb</span><span class="p">.</span><span class="n">flags</span><span class="p">),</span> <span class="n">skb</span><span class="p">))</span>
			<span class="n">skb</span><span class="o">-&gt;</span><span class="n">ip_summed</span> <span class="o">=</span> <span class="n">CHECKSUM_UNNECESSARY</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">skb_checksum_none_assert</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">rxdesc</span><span class="o">-&gt;</span><span class="n">descwb</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">RXWBFLAG_TAGON</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">u16</span> <span class="n">vid</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">rxdesc</span><span class="o">-&gt;</span><span class="n">descwb</span><span class="p">.</span><span class="n">vlan</span><span class="p">);</span>

			<span class="n">__vlan_hwaccel_put_tag</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">vid</span><span class="p">);</span>
			<span class="n">NET_STAT</span><span class="p">(</span><span class="n">jme</span><span class="p">).</span><span class="n">rx_bytes</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">jme</span><span class="o">-&gt;</span><span class="n">jme_rx</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">rxdesc</span><span class="o">-&gt;</span><span class="n">descwb</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">RXWBFLAG_DEST</span><span class="p">))</span> <span class="o">==</span>
		    <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">RXWBFLAG_DEST_MUL</span><span class="p">))</span>
			<span class="o">++</span><span class="p">(</span><span class="n">NET_STAT</span><span class="p">(</span><span class="n">jme</span><span class="p">).</span><span class="n">multicast</span><span class="p">);</span>

		<span class="n">NET_STAT</span><span class="p">(</span><span class="n">jme</span><span class="p">).</span><span class="n">rx_bytes</span> <span class="o">+=</span> <span class="n">framesize</span><span class="p">;</span>
		<span class="o">++</span><span class="p">(</span><span class="n">NET_STAT</span><span class="p">(</span><span class="n">jme</span><span class="p">).</span><span class="n">rx_packets</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">jme_set_clean_rxdesc</span><span class="p">(</span><span class="n">jme</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">jme_process_receive</span><span class="p">(</span><span class="k">struct</span> <span class="n">jme_adapter</span> <span class="o">*</span><span class="n">jme</span><span class="p">,</span> <span class="kt">int</span> <span class="n">limit</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">jme_ring</span> <span class="o">*</span><span class="n">rxring</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">rxring</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="k">struct</span> <span class="n">rxdesc</span> <span class="o">*</span><span class="n">rxdesc</span> <span class="o">=</span> <span class="n">rxring</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">ccnt</span><span class="p">,</span> <span class="n">desccnt</span><span class="p">,</span> <span class="n">mask</span> <span class="o">=</span> <span class="n">jme</span><span class="o">-&gt;</span><span class="n">rx_ring_mask</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">atomic_dec_and_test</span><span class="p">(</span><span class="o">&amp;</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">rx_cleaning</span><span class="p">)))</span>
		<span class="k">goto</span> <span class="n">out_inc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">link_changing</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out_inc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">netif_carrier_ok</span><span class="p">(</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">)))</span>
		<span class="k">goto</span> <span class="n">out_inc</span><span class="p">;</span>

	<span class="n">i</span> <span class="o">=</span> <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rxring</span><span class="o">-&gt;</span><span class="n">next_to_clean</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">limit</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rxdesc</span> <span class="o">=</span> <span class="n">rxring</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">;</span>
		<span class="n">rxdesc</span> <span class="o">+=</span> <span class="n">i</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">rxdesc</span><span class="o">-&gt;</span><span class="n">descwb</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">RXWBFLAG_OWN</span><span class="p">))</span> <span class="o">||</span>
		<span class="o">!</span><span class="p">(</span><span class="n">rxdesc</span><span class="o">-&gt;</span><span class="n">descwb</span><span class="p">.</span><span class="n">desccnt</span> <span class="o">&amp;</span> <span class="n">RXWBDCNT_WBCPL</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="o">--</span><span class="n">limit</span><span class="p">;</span>

		<span class="n">rmb</span><span class="p">();</span>
		<span class="n">desccnt</span> <span class="o">=</span> <span class="n">rxdesc</span><span class="o">-&gt;</span><span class="n">descwb</span><span class="p">.</span><span class="n">desccnt</span> <span class="o">&amp;</span> <span class="n">RXWBDCNT_DCNT</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">desccnt</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="o">||</span>
		<span class="n">rxdesc</span><span class="o">-&gt;</span><span class="n">descwb</span><span class="p">.</span><span class="n">errstat</span> <span class="o">&amp;</span> <span class="n">RXWBERR_ALLERR</span><span class="p">))</span> <span class="p">{</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">rxdesc</span><span class="o">-&gt;</span><span class="n">descwb</span><span class="p">.</span><span class="n">errstat</span> <span class="o">&amp;</span> <span class="n">RXWBERR_CRCERR</span><span class="p">)</span>
				<span class="o">++</span><span class="p">(</span><span class="n">NET_STAT</span><span class="p">(</span><span class="n">jme</span><span class="p">).</span><span class="n">rx_crc_errors</span><span class="p">);</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rxdesc</span><span class="o">-&gt;</span><span class="n">descwb</span><span class="p">.</span><span class="n">errstat</span> <span class="o">&amp;</span> <span class="n">RXWBERR_OVERUN</span><span class="p">)</span>
				<span class="o">++</span><span class="p">(</span><span class="n">NET_STAT</span><span class="p">(</span><span class="n">jme</span><span class="p">).</span><span class="n">rx_fifo_errors</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="o">++</span><span class="p">(</span><span class="n">NET_STAT</span><span class="p">(</span><span class="n">jme</span><span class="p">).</span><span class="n">rx_errors</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">desccnt</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
				<span class="n">limit</span> <span class="o">-=</span> <span class="n">desccnt</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

			<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="n">i</span><span class="p">,</span> <span class="n">ccnt</span> <span class="o">=</span> <span class="n">desccnt</span> <span class="p">;</span> <span class="n">ccnt</span><span class="o">--</span> <span class="p">;</span> <span class="p">)</span> <span class="p">{</span>
				<span class="n">jme_set_clean_rxdesc</span><span class="p">(</span><span class="n">jme</span><span class="p">,</span> <span class="n">j</span><span class="p">);</span>
				<span class="n">j</span> <span class="o">=</span> <span class="p">(</span><span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">mask</span><span class="p">);</span>
			<span class="p">}</span>

		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">jme_alloc_and_feed_skb</span><span class="p">(</span><span class="n">jme</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">i</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="n">desccnt</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">mask</span><span class="p">);</span>
	<span class="p">}</span>

<span class="nl">out:</span>
	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rxring</span><span class="o">-&gt;</span><span class="n">next_to_clean</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>

<span class="nl">out_inc:</span>
	<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">rx_cleaning</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">limit</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="n">limit</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">jme_attempt_pcc</span><span class="p">(</span><span class="k">struct</span> <span class="n">dynpcc_info</span> <span class="o">*</span><span class="n">dpi</span><span class="p">,</span> <span class="kt">int</span> <span class="n">atmp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">atmp</span> <span class="o">==</span> <span class="n">dpi</span><span class="o">-&gt;</span><span class="n">cur</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dpi</span><span class="o">-&gt;</span><span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dpi</span><span class="o">-&gt;</span><span class="n">attempt</span> <span class="o">==</span> <span class="n">atmp</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">++</span><span class="p">(</span><span class="n">dpi</span><span class="o">-&gt;</span><span class="n">cnt</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dpi</span><span class="o">-&gt;</span><span class="n">attempt</span> <span class="o">=</span> <span class="n">atmp</span><span class="p">;</span>
		<span class="n">dpi</span><span class="o">-&gt;</span><span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">jme_dynamic_pcc</span><span class="p">(</span><span class="k">struct</span> <span class="n">jme_adapter</span> <span class="o">*</span><span class="n">jme</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">register</span> <span class="k">struct</span> <span class="n">dynpcc_info</span> <span class="o">*</span><span class="n">dpi</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">dpi</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">NET_STAT</span><span class="p">(</span><span class="n">jme</span><span class="p">).</span><span class="n">rx_bytes</span> <span class="o">-</span> <span class="n">dpi</span><span class="o">-&gt;</span><span class="n">last_bytes</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">PCC_P3_THRESHOLD</span><span class="p">)</span>
		<span class="n">jme_attempt_pcc</span><span class="p">(</span><span class="n">dpi</span><span class="p">,</span> <span class="n">PCC_P3</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">NET_STAT</span><span class="p">(</span><span class="n">jme</span><span class="p">).</span><span class="n">rx_packets</span> <span class="o">-</span> <span class="n">dpi</span><span class="o">-&gt;</span><span class="n">last_pkts</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">PCC_P2_THRESHOLD</span> <span class="o">||</span>
		 <span class="n">dpi</span><span class="o">-&gt;</span><span class="n">intr_cnt</span> <span class="o">&gt;</span> <span class="n">PCC_INTR_THRESHOLD</span><span class="p">)</span>
		<span class="n">jme_attempt_pcc</span><span class="p">(</span><span class="n">dpi</span><span class="p">,</span> <span class="n">PCC_P2</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">jme_attempt_pcc</span><span class="p">(</span><span class="n">dpi</span><span class="p">,</span> <span class="n">PCC_P1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">dpi</span><span class="o">-&gt;</span><span class="n">attempt</span> <span class="o">!=</span> <span class="n">dpi</span><span class="o">-&gt;</span><span class="n">cur</span> <span class="o">&amp;&amp;</span> <span class="n">dpi</span><span class="o">-&gt;</span><span class="n">cnt</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dpi</span><span class="o">-&gt;</span><span class="n">attempt</span> <span class="o">&lt;</span> <span class="n">dpi</span><span class="o">-&gt;</span><span class="n">cur</span><span class="p">)</span>
			<span class="n">tasklet_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">rxclean_task</span><span class="p">);</span>
		<span class="n">jme_set_rx_pcc</span><span class="p">(</span><span class="n">jme</span><span class="p">,</span> <span class="n">dpi</span><span class="o">-&gt;</span><span class="n">attempt</span><span class="p">);</span>
		<span class="n">dpi</span><span class="o">-&gt;</span><span class="n">cur</span> <span class="o">=</span> <span class="n">dpi</span><span class="o">-&gt;</span><span class="n">attempt</span><span class="p">;</span>
		<span class="n">dpi</span><span class="o">-&gt;</span><span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">jme_start_pcc_timer</span><span class="p">(</span><span class="k">struct</span> <span class="n">jme_adapter</span> <span class="o">*</span><span class="n">jme</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dynpcc_info</span> <span class="o">*</span><span class="n">dpi</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">dpi</span><span class="p">);</span>
	<span class="n">dpi</span><span class="o">-&gt;</span><span class="n">last_bytes</span>		<span class="o">=</span> <span class="n">NET_STAT</span><span class="p">(</span><span class="n">jme</span><span class="p">).</span><span class="n">rx_bytes</span><span class="p">;</span>
	<span class="n">dpi</span><span class="o">-&gt;</span><span class="n">last_pkts</span>		<span class="o">=</span> <span class="n">NET_STAT</span><span class="p">(</span><span class="n">jme</span><span class="p">).</span><span class="n">rx_packets</span><span class="p">;</span>
	<span class="n">dpi</span><span class="o">-&gt;</span><span class="n">intr_cnt</span>		<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">jwrite32</span><span class="p">(</span><span class="n">jme</span><span class="p">,</span> <span class="n">JME_TMCSR</span><span class="p">,</span>
		<span class="n">TMCSR_EN</span> <span class="o">|</span> <span class="p">((</span><span class="mh">0xFFFFFF</span> <span class="o">-</span> <span class="n">PCC_INTERVAL_US</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">TMCSR_CNT</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">jme_stop_pcc_timer</span><span class="p">(</span><span class="k">struct</span> <span class="n">jme_adapter</span> <span class="o">*</span><span class="n">jme</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">jwrite32</span><span class="p">(</span><span class="n">jme</span><span class="p">,</span> <span class="n">JME_TMCSR</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">jme_shutdown_nic</span><span class="p">(</span><span class="k">struct</span> <span class="n">jme_adapter</span> <span class="o">*</span><span class="n">jme</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">phylink</span><span class="p">;</span>

	<span class="n">phylink</span> <span class="o">=</span> <span class="n">jme_linkstat_from_phy</span><span class="p">(</span><span class="n">jme</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">phylink</span> <span class="o">&amp;</span> <span class="n">PHY_LINK_UP</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Disable all interrupt before issue timer</span>
<span class="cm">		 */</span>
		<span class="n">jme_stop_irq</span><span class="p">(</span><span class="n">jme</span><span class="p">);</span>
		<span class="n">jwrite32</span><span class="p">(</span><span class="n">jme</span><span class="p">,</span> <span class="n">JME_TIMER2</span><span class="p">,</span> <span class="n">TMCSR_EN</span> <span class="o">|</span> <span class="mh">0xFFFFFE</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">jme_pcc_tasklet</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">jme_adapter</span> <span class="o">*</span><span class="n">jme</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">jme_adapter</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span> <span class="o">=</span> <span class="n">jme</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">JME_FLAG_SHUTDOWN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">jme_shutdown_nic</span><span class="p">(</span><span class="n">jme</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">netif_carrier_ok</span><span class="p">(</span><span class="n">netdev</span><span class="p">)</span> <span class="o">||</span>
		<span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">link_changing</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
	<span class="p">))</span> <span class="p">{</span>
		<span class="n">jme_stop_pcc_timer</span><span class="p">(</span><span class="n">jme</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">JME_FLAG_POLL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)))</span>
		<span class="n">jme_dynamic_pcc</span><span class="p">(</span><span class="n">jme</span><span class="p">);</span>

	<span class="n">jme_start_pcc_timer</span><span class="p">(</span><span class="n">jme</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">jme_polling_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">jme_adapter</span> <span class="o">*</span><span class="n">jme</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">jme_set_rx_pcc</span><span class="p">(</span><span class="n">jme</span><span class="p">,</span> <span class="n">PCC_OFF</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">jme_interrupt_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">jme_adapter</span> <span class="o">*</span><span class="n">jme</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">jme_set_rx_pcc</span><span class="p">(</span><span class="n">jme</span><span class="p">,</span> <span class="n">PCC_P1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span>
<span class="nf">jme_pseudo_hotplug_enabled</span><span class="p">(</span><span class="k">struct</span> <span class="n">jme_adapter</span> <span class="o">*</span><span class="n">jme</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">apmc</span><span class="p">;</span>
	<span class="n">apmc</span> <span class="o">=</span> <span class="n">jread32</span><span class="p">(</span><span class="n">jme</span><span class="p">,</span> <span class="n">JME_APMC</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">apmc</span> <span class="o">&amp;</span> <span class="n">JME_APMC_PSEUDO_HP_EN</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">jme_start_shutdown_timer</span><span class="p">(</span><span class="k">struct</span> <span class="n">jme_adapter</span> <span class="o">*</span><span class="n">jme</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">apmc</span><span class="p">;</span>

	<span class="n">apmc</span> <span class="o">=</span> <span class="n">jread32</span><span class="p">(</span><span class="n">jme</span><span class="p">,</span> <span class="n">JME_APMC</span><span class="p">)</span> <span class="o">|</span> <span class="n">JME_APMC_PCIE_SD_EN</span><span class="p">;</span>
	<span class="n">apmc</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">JME_APMC_EPIEN_CTRL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">no_extplug</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">jwrite32f</span><span class="p">(</span><span class="n">jme</span><span class="p">,</span> <span class="n">JME_APMC</span><span class="p">,</span> <span class="n">apmc</span> <span class="o">|</span> <span class="n">JME_APMC_EPIEN_CTRL_EN</span><span class="p">);</span>
		<span class="n">wmb</span><span class="p">();</span>
	<span class="p">}</span>
	<span class="n">jwrite32f</span><span class="p">(</span><span class="n">jme</span><span class="p">,</span> <span class="n">JME_APMC</span><span class="p">,</span> <span class="n">apmc</span><span class="p">);</span>

	<span class="n">jwrite32f</span><span class="p">(</span><span class="n">jme</span><span class="p">,</span> <span class="n">JME_TIMER2</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">JME_FLAG_SHUTDOWN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">jwrite32</span><span class="p">(</span><span class="n">jme</span><span class="p">,</span> <span class="n">JME_TMCSR</span><span class="p">,</span>
		<span class="n">TMCSR_EN</span> <span class="o">|</span> <span class="p">((</span><span class="mh">0xFFFFFF</span> <span class="o">-</span> <span class="n">APMC_PHP_SHUTDOWN_DELAY</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">TMCSR_CNT</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">jme_stop_shutdown_timer</span><span class="p">(</span><span class="k">struct</span> <span class="n">jme_adapter</span> <span class="o">*</span><span class="n">jme</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">apmc</span><span class="p">;</span>

	<span class="n">jwrite32f</span><span class="p">(</span><span class="n">jme</span><span class="p">,</span> <span class="n">JME_TMCSR</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">jwrite32f</span><span class="p">(</span><span class="n">jme</span><span class="p">,</span> <span class="n">JME_TIMER2</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">JME_FLAG_SHUTDOWN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>

	<span class="n">apmc</span> <span class="o">=</span> <span class="n">jread32</span><span class="p">(</span><span class="n">jme</span><span class="p">,</span> <span class="n">JME_APMC</span><span class="p">);</span>
	<span class="n">apmc</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">JME_APMC_PCIE_SD_EN</span> <span class="o">|</span> <span class="n">JME_APMC_EPIEN_CTRL</span><span class="p">);</span>
	<span class="n">jwrite32f</span><span class="p">(</span><span class="n">jme</span><span class="p">,</span> <span class="n">JME_APMC</span><span class="p">,</span> <span class="n">apmc</span> <span class="o">|</span> <span class="n">JME_APMC_EPIEN_CTRL_DIS</span><span class="p">);</span>
	<span class="n">wmb</span><span class="p">();</span>
	<span class="n">jwrite32f</span><span class="p">(</span><span class="n">jme</span><span class="p">,</span> <span class="n">JME_APMC</span><span class="p">,</span> <span class="n">apmc</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">jme_link_change_tasklet</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">jme_adapter</span> <span class="o">*</span><span class="n">jme</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">jme_adapter</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span> <span class="o">=</span> <span class="n">jme</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">atomic_dec_and_test</span><span class="p">(</span><span class="o">&amp;</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">link_changing</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">link_changing</span><span class="p">);</span>
		<span class="n">netif_info</span><span class="p">(</span><span class="n">jme</span><span class="p">,</span> <span class="n">intr</span><span class="p">,</span> <span class="n">jme</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Get link change lock failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">link_changing</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">netif_info</span><span class="p">(</span><span class="n">jme</span><span class="p">,</span> <span class="n">intr</span><span class="p">,</span> <span class="n">jme</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Waiting link change lock</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">jme_check_link</span><span class="p">(</span><span class="n">netdev</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">jme</span><span class="o">-&gt;</span><span class="n">old_mtu</span> <span class="o">==</span> <span class="n">netdev</span><span class="o">-&gt;</span><span class="n">mtu</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">jme</span><span class="o">-&gt;</span><span class="n">old_mtu</span> <span class="o">=</span> <span class="n">netdev</span><span class="o">-&gt;</span><span class="n">mtu</span><span class="p">;</span>
	<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">jme_pseudo_hotplug_enabled</span><span class="p">(</span><span class="n">jme</span><span class="p">))</span>
		<span class="n">jme_stop_shutdown_timer</span><span class="p">(</span><span class="n">jme</span><span class="p">);</span>

	<span class="n">jme_stop_pcc_timer</span><span class="p">(</span><span class="n">jme</span><span class="p">);</span>
	<span class="n">tasklet_disable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">txclean_task</span><span class="p">);</span>
	<span class="n">tasklet_disable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">rxclean_task</span><span class="p">);</span>
	<span class="n">tasklet_disable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">rxempty_task</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">netif_carrier_ok</span><span class="p">(</span><span class="n">netdev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">jme_disable_rx_engine</span><span class="p">(</span><span class="n">jme</span><span class="p">);</span>
		<span class="n">jme_disable_tx_engine</span><span class="p">(</span><span class="n">jme</span><span class="p">);</span>
		<span class="n">jme_reset_mac_processor</span><span class="p">(</span><span class="n">jme</span><span class="p">);</span>
		<span class="n">jme_free_rx_resources</span><span class="p">(</span><span class="n">jme</span><span class="p">);</span>
		<span class="n">jme_free_tx_resources</span><span class="p">(</span><span class="n">jme</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">JME_FLAG_POLL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
			<span class="n">jme_polling_mode</span><span class="p">(</span><span class="n">jme</span><span class="p">);</span>

		<span class="n">netif_carrier_off</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">jme_check_link</span><span class="p">(</span><span class="n">netdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">netif_carrier_ok</span><span class="p">(</span><span class="n">netdev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">jme_setup_rx_resources</span><span class="p">(</span><span class="n">jme</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Allocating resources for RX error, Device STOPPED!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out_enable_tasklet</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">rc</span> <span class="o">=</span> <span class="n">jme_setup_tx_resources</span><span class="p">(</span><span class="n">jme</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Allocating resources for TX error, Device STOPPED!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">err_out_free_rx_resources</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">jme_enable_rx_engine</span><span class="p">(</span><span class="n">jme</span><span class="p">);</span>
		<span class="n">jme_enable_tx_engine</span><span class="p">(</span><span class="n">jme</span><span class="p">);</span>

		<span class="n">netif_start_queue</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">JME_FLAG_POLL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
			<span class="n">jme_interrupt_mode</span><span class="p">(</span><span class="n">jme</span><span class="p">);</span>

		<span class="n">jme_start_pcc_timer</span><span class="p">(</span><span class="n">jme</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">jme_pseudo_hotplug_enabled</span><span class="p">(</span><span class="n">jme</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">jme_start_shutdown_timer</span><span class="p">(</span><span class="n">jme</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">goto</span> <span class="n">out_enable_tasklet</span><span class="p">;</span>

<span class="nl">err_out_free_rx_resources:</span>
	<span class="n">jme_free_rx_resources</span><span class="p">(</span><span class="n">jme</span><span class="p">);</span>
<span class="nl">out_enable_tasklet:</span>
	<span class="n">tasklet_enable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">txclean_task</span><span class="p">);</span>
	<span class="n">tasklet_hi_enable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">rxclean_task</span><span class="p">);</span>
	<span class="n">tasklet_hi_enable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">rxempty_task</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">link_changing</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">jme_rx_clean_tasklet</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">jme_adapter</span> <span class="o">*</span><span class="n">jme</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">jme_adapter</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dynpcc_info</span> <span class="o">*</span><span class="n">dpi</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">dpi</span><span class="p">);</span>

	<span class="n">jme_process_receive</span><span class="p">(</span><span class="n">jme</span><span class="p">,</span> <span class="n">jme</span><span class="o">-&gt;</span><span class="n">rx_ring_size</span><span class="p">);</span>
	<span class="o">++</span><span class="p">(</span><span class="n">dpi</span><span class="o">-&gt;</span><span class="n">intr_cnt</span><span class="p">);</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">jme_poll</span><span class="p">(</span><span class="n">JME_NAPI_HOLDER</span><span class="p">(</span><span class="n">holder</span><span class="p">),</span> <span class="n">JME_NAPI_WEIGHT</span><span class="p">(</span><span class="n">budget</span><span class="p">))</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">jme_adapter</span> <span class="o">*</span><span class="n">jme</span> <span class="o">=</span> <span class="n">jme_napi_priv</span><span class="p">(</span><span class="n">holder</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">rest</span><span class="p">;</span>

	<span class="n">rest</span> <span class="o">=</span> <span class="n">jme_process_receive</span><span class="p">(</span><span class="n">jme</span><span class="p">,</span> <span class="n">JME_NAPI_WEIGHT_VAL</span><span class="p">(</span><span class="n">budget</span><span class="p">));</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">rx_empty</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">rx_empty</span><span class="p">);</span>
		<span class="o">++</span><span class="p">(</span><span class="n">NET_STAT</span><span class="p">(</span><span class="n">jme</span><span class="p">).</span><span class="n">rx_dropped</span><span class="p">);</span>
		<span class="n">jme_restart_rx_engine</span><span class="p">(</span><span class="n">jme</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">rx_empty</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rest</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">JME_RX_COMPLETE</span><span class="p">(</span><span class="n">netdev</span><span class="p">,</span> <span class="n">holder</span><span class="p">);</span>
		<span class="n">jme_interrupt_mode</span><span class="p">(</span><span class="n">jme</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">JME_NAPI_WEIGHT_SET</span><span class="p">(</span><span class="n">budget</span><span class="p">,</span> <span class="n">rest</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">JME_NAPI_WEIGHT_VAL</span><span class="p">(</span><span class="n">budget</span><span class="p">)</span> <span class="o">-</span> <span class="n">rest</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">jme_rx_empty_tasklet</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">jme_adapter</span> <span class="o">*</span><span class="n">jme</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">jme_adapter</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">link_changing</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">netif_carrier_ok</span><span class="p">(</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">)))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">netif_info</span><span class="p">(</span><span class="n">jme</span><span class="p">,</span> <span class="n">rx_status</span><span class="p">,</span> <span class="n">jme</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;RX Queue Full!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">jme_rx_clean_tasklet</span><span class="p">(</span><span class="n">arg</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">rx_empty</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">rx_empty</span><span class="p">);</span>
		<span class="o">++</span><span class="p">(</span><span class="n">NET_STAT</span><span class="p">(</span><span class="n">jme</span><span class="p">).</span><span class="n">rx_dropped</span><span class="p">);</span>
		<span class="n">jme_restart_rx_engine</span><span class="p">(</span><span class="n">jme</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">rx_empty</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">jme_wake_queue_if_stopped</span><span class="p">(</span><span class="k">struct</span> <span class="n">jme_adapter</span> <span class="o">*</span><span class="n">jme</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">jme_ring</span> <span class="o">*</span><span class="n">txring</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">txring</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>

	<span class="n">smp_wmb</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">netif_queue_stopped</span><span class="p">(</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	<span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">txring</span><span class="o">-&gt;</span><span class="n">nr_free</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">tx_wake_threshold</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">netif_info</span><span class="p">(</span><span class="n">jme</span><span class="p">,</span> <span class="n">tx_done</span><span class="p">,</span> <span class="n">jme</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;TX Queue Waked</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">jme_tx_clean_tasklet</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">jme_adapter</span> <span class="o">*</span><span class="n">jme</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">jme_adapter</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">jme_ring</span> <span class="o">*</span><span class="n">txring</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">txring</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="k">struct</span> <span class="n">txdesc</span> <span class="o">*</span><span class="n">txdesc</span> <span class="o">=</span> <span class="n">txring</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">jme_buffer_info</span> <span class="o">*</span><span class="n">txbi</span> <span class="o">=</span> <span class="n">txring</span><span class="o">-&gt;</span><span class="n">bufinf</span><span class="p">,</span> <span class="o">*</span><span class="n">ctxbi</span><span class="p">,</span> <span class="o">*</span><span class="n">ttxbi</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">max</span><span class="p">,</span> <span class="n">err</span><span class="p">,</span> <span class="n">mask</span><span class="p">;</span>

	<span class="n">tx_dbg</span><span class="p">(</span><span class="n">jme</span><span class="p">,</span> <span class="s">&quot;Into txclean</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">atomic_dec_and_test</span><span class="p">(</span><span class="o">&amp;</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">tx_cleaning</span><span class="p">)))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">link_changing</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">netif_carrier_ok</span><span class="p">(</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">)))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">max</span> <span class="o">=</span> <span class="n">jme</span><span class="o">-&gt;</span><span class="n">tx_ring_size</span> <span class="o">-</span> <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">txring</span><span class="o">-&gt;</span><span class="n">nr_free</span><span class="p">);</span>
	<span class="n">mask</span> <span class="o">=</span> <span class="n">jme</span><span class="o">-&gt;</span><span class="n">tx_ring_mask</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">txring</span><span class="o">-&gt;</span><span class="n">next_to_clean</span><span class="p">)</span> <span class="p">;</span> <span class="n">cnt</span> <span class="o">&lt;</span> <span class="n">max</span> <span class="p">;</span> <span class="p">)</span> <span class="p">{</span>

		<span class="n">ctxbi</span> <span class="o">=</span> <span class="n">txbi</span> <span class="o">+</span> <span class="n">i</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">ctxbi</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">&amp;&amp;</span>
		<span class="o">!</span><span class="p">(</span><span class="n">txdesc</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">descwb</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">TXWBFLAG_OWN</span><span class="p">)))</span> <span class="p">{</span>

			<span class="n">tx_dbg</span><span class="p">(</span><span class="n">jme</span><span class="p">,</span> <span class="s">&quot;txclean: %d+%d@%lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">i</span><span class="p">,</span> <span class="n">ctxbi</span><span class="o">-&gt;</span><span class="n">nr_desc</span><span class="p">,</span> <span class="n">jiffies</span><span class="p">);</span>

			<span class="n">err</span> <span class="o">=</span> <span class="n">txdesc</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">descwb</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">TXWBFLAG_ALLERR</span><span class="p">;</span>

			<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">1</span> <span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">ctxbi</span><span class="o">-&gt;</span><span class="n">nr_desc</span> <span class="p">;</span> <span class="o">++</span><span class="n">j</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ttxbi</span> <span class="o">=</span> <span class="n">txbi</span> <span class="o">+</span> <span class="p">((</span><span class="n">i</span> <span class="o">+</span> <span class="n">j</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">mask</span><span class="p">));</span>
				<span class="n">txdesc</span><span class="p">[(</span><span class="n">i</span> <span class="o">+</span> <span class="n">j</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">mask</span><span class="p">)].</span><span class="n">dw</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

				<span class="n">pci_unmap_page</span><span class="p">(</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span>
						 <span class="n">ttxbi</span><span class="o">-&gt;</span><span class="n">mapping</span><span class="p">,</span>
						 <span class="n">ttxbi</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span>
						 <span class="n">PCI_DMA_TODEVICE</span><span class="p">);</span>

				<span class="n">ttxbi</span><span class="o">-&gt;</span><span class="n">mapping</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">ttxbi</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">ctxbi</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">);</span>

			<span class="n">cnt</span> <span class="o">+=</span> <span class="n">ctxbi</span><span class="o">-&gt;</span><span class="n">nr_desc</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">err</span><span class="p">))</span> <span class="p">{</span>
				<span class="o">++</span><span class="p">(</span><span class="n">NET_STAT</span><span class="p">(</span><span class="n">jme</span><span class="p">).</span><span class="n">tx_carrier_errors</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="o">++</span><span class="p">(</span><span class="n">NET_STAT</span><span class="p">(</span><span class="n">jme</span><span class="p">).</span><span class="n">tx_packets</span><span class="p">);</span>
				<span class="n">NET_STAT</span><span class="p">(</span><span class="n">jme</span><span class="p">).</span><span class="n">tx_bytes</span> <span class="o">+=</span> <span class="n">ctxbi</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">ctxbi</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">ctxbi</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">ctxbi</span><span class="o">-&gt;</span><span class="n">start_xmit</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">i</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="n">ctxbi</span><span class="o">-&gt;</span><span class="n">nr_desc</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">;</span>

		<span class="n">ctxbi</span><span class="o">-&gt;</span><span class="n">nr_desc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">tx_dbg</span><span class="p">(</span><span class="n">jme</span><span class="p">,</span> <span class="s">&quot;txclean: done %d@%lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">jiffies</span><span class="p">);</span>
	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">txring</span><span class="o">-&gt;</span><span class="n">next_to_clean</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
	<span class="n">atomic_add</span><span class="p">(</span><span class="n">cnt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">txring</span><span class="o">-&gt;</span><span class="n">nr_free</span><span class="p">);</span>

	<span class="n">jme_wake_queue_if_stopped</span><span class="p">(</span><span class="n">jme</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">tx_cleaning</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">jme_intr_msi</span><span class="p">(</span><span class="k">struct</span> <span class="n">jme_adapter</span> <span class="o">*</span><span class="n">jme</span><span class="p">,</span> <span class="n">u32</span> <span class="n">intrstat</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * Disable interrupt</span>
<span class="cm">	 */</span>
	<span class="n">jwrite32f</span><span class="p">(</span><span class="n">jme</span><span class="p">,</span> <span class="n">JME_IENC</span><span class="p">,</span> <span class="n">INTR_ENABLE</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">intrstat</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">INTR_LINKCH</span> <span class="o">|</span> <span class="n">INTR_SWINTR</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Link change event is critical</span>
<span class="cm">		 * all other events are ignored</span>
<span class="cm">		 */</span>
		<span class="n">jwrite32</span><span class="p">(</span><span class="n">jme</span><span class="p">,</span> <span class="n">JME_IEVE</span><span class="p">,</span> <span class="n">intrstat</span><span class="p">);</span>
		<span class="n">tasklet_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">linkch_task</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_reenable</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">intrstat</span> <span class="o">&amp;</span> <span class="n">INTR_TMINTR</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">jwrite32</span><span class="p">(</span><span class="n">jme</span><span class="p">,</span> <span class="n">JME_IEVE</span><span class="p">,</span> <span class="n">INTR_TMINTR</span><span class="p">);</span>
		<span class="n">tasklet_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">pcc_task</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">intrstat</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">INTR_PCCTXTO</span> <span class="o">|</span> <span class="n">INTR_PCCTX</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">jwrite32</span><span class="p">(</span><span class="n">jme</span><span class="p">,</span> <span class="n">JME_IEVE</span><span class="p">,</span> <span class="n">INTR_PCCTXTO</span> <span class="o">|</span> <span class="n">INTR_PCCTX</span> <span class="o">|</span> <span class="n">INTR_TX0</span><span class="p">);</span>
		<span class="n">tasklet_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">txclean_task</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">intrstat</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">INTR_PCCRX0TO</span> <span class="o">|</span> <span class="n">INTR_PCCRX0</span> <span class="o">|</span> <span class="n">INTR_RX0EMP</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">jwrite32</span><span class="p">(</span><span class="n">jme</span><span class="p">,</span> <span class="n">JME_IEVE</span><span class="p">,</span> <span class="p">(</span><span class="n">intrstat</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">INTR_PCCRX0TO</span> <span class="o">|</span>
						     <span class="n">INTR_PCCRX0</span> <span class="o">|</span>
						     <span class="n">INTR_RX0EMP</span><span class="p">))</span> <span class="o">|</span>
					<span class="n">INTR_RX0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">JME_FLAG_POLL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">intrstat</span> <span class="o">&amp;</span> <span class="n">INTR_RX0EMP</span><span class="p">)</span>
			<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">rx_empty</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">intrstat</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">INTR_PCCRX0TO</span> <span class="o">|</span> <span class="n">INTR_PCCRX0</span> <span class="o">|</span> <span class="n">INTR_RX0EMP</span><span class="p">)))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">JME_RX_SCHEDULE_PREP</span><span class="p">(</span><span class="n">jme</span><span class="p">)))</span> <span class="p">{</span>
				<span class="n">jme_polling_mode</span><span class="p">(</span><span class="n">jme</span><span class="p">);</span>
				<span class="n">JME_RX_SCHEDULE</span><span class="p">(</span><span class="n">jme</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">intrstat</span> <span class="o">&amp;</span> <span class="n">INTR_RX0EMP</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">rx_empty</span><span class="p">);</span>
			<span class="n">tasklet_hi_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">rxempty_task</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">intrstat</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">INTR_PCCRX0TO</span> <span class="o">|</span> <span class="n">INTR_PCCRX0</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">tasklet_hi_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">rxclean_task</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

<span class="nl">out_reenable:</span>
	<span class="cm">/*</span>
<span class="cm">	 * Re-enable interrupt</span>
<span class="cm">	 */</span>
	<span class="n">jwrite32f</span><span class="p">(</span><span class="n">jme</span><span class="p">,</span> <span class="n">JME_IENS</span><span class="p">,</span> <span class="n">INTR_ENABLE</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span>
<span class="nf">jme_intr</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span> <span class="o">=</span> <span class="n">dev_id</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">jme_adapter</span> <span class="o">*</span><span class="n">jme</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">intrstat</span><span class="p">;</span>

	<span class="n">intrstat</span> <span class="o">=</span> <span class="n">jread32</span><span class="p">(</span><span class="n">jme</span><span class="p">,</span> <span class="n">JME_IEVE</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Check if it&#39;s really an interrupt for us</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">((</span><span class="n">intrstat</span> <span class="o">&amp;</span> <span class="n">INTR_ENABLE</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Check if the device still exist</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">intrstat</span> <span class="o">==</span> <span class="o">~</span><span class="p">((</span><span class="n">typeof</span><span class="p">(</span><span class="n">intrstat</span><span class="p">))</span><span class="mi">0</span><span class="p">)))</span>
		<span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>

	<span class="n">jme_intr_msi</span><span class="p">(</span><span class="n">jme</span><span class="p">,</span> <span class="n">intrstat</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span>
<span class="nf">jme_msi</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span> <span class="o">=</span> <span class="n">dev_id</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">jme_adapter</span> <span class="o">*</span><span class="n">jme</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">intrstat</span><span class="p">;</span>

	<span class="n">intrstat</span> <span class="o">=</span> <span class="n">jread32</span><span class="p">(</span><span class="n">jme</span><span class="p">,</span> <span class="n">JME_IEVE</span><span class="p">);</span>

	<span class="n">jme_intr_msi</span><span class="p">(</span><span class="n">jme</span><span class="p">,</span> <span class="n">intrstat</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">jme_reset_link</span><span class="p">(</span><span class="k">struct</span> <span class="n">jme_adapter</span> <span class="o">*</span><span class="n">jme</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">jwrite32</span><span class="p">(</span><span class="n">jme</span><span class="p">,</span> <span class="n">JME_TMCSR</span><span class="p">,</span> <span class="n">TMCSR_SWIT</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">jme_restart_an</span><span class="p">(</span><span class="k">struct</span> <span class="n">jme_adapter</span> <span class="o">*</span><span class="n">jme</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">bmcr</span><span class="p">;</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">phy_lock</span><span class="p">);</span>
	<span class="n">bmcr</span> <span class="o">=</span> <span class="n">jme_mdio_read</span><span class="p">(</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">jme</span><span class="o">-&gt;</span><span class="n">mii_if</span><span class="p">.</span><span class="n">phy_id</span><span class="p">,</span> <span class="n">MII_BMCR</span><span class="p">);</span>
	<span class="n">bmcr</span> <span class="o">|=</span> <span class="p">(</span><span class="n">BMCR_ANENABLE</span> <span class="o">|</span> <span class="n">BMCR_ANRESTART</span><span class="p">);</span>
	<span class="n">jme_mdio_write</span><span class="p">(</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">jme</span><span class="o">-&gt;</span><span class="n">mii_if</span><span class="p">.</span><span class="n">phy_id</span><span class="p">,</span> <span class="n">MII_BMCR</span><span class="p">,</span> <span class="n">bmcr</span><span class="p">);</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">phy_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">jme_request_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">jme_adapter</span> <span class="o">*</span><span class="n">jme</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span> <span class="o">=</span> <span class="n">jme</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">irq_handler_t</span> <span class="n">handler</span> <span class="o">=</span> <span class="n">jme_intr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">irq_flags</span> <span class="o">=</span> <span class="n">IRQF_SHARED</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pci_enable_msi</span><span class="p">(</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">JME_FLAG_MSI</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">handler</span> <span class="o">=</span> <span class="n">jme_msi</span><span class="p">;</span>
		<span class="n">irq_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">handler</span><span class="p">,</span> <span class="n">irq_flags</span><span class="p">,</span> <span class="n">netdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
			  <span class="n">netdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netdev_err</span><span class="p">(</span><span class="n">netdev</span><span class="p">,</span>
			   <span class="s">&quot;Unable to request %s interrupt (return: %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">test_bit</span><span class="p">(</span><span class="n">JME_FLAG_MSI</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;MSI&quot;</span> <span class="o">:</span> <span class="s">&quot;INTx&quot;</span><span class="p">,</span>
			   <span class="n">rc</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">JME_FLAG_MSI</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">pci_disable_msi</span><span class="p">(</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">);</span>
			<span class="n">clear_bit</span><span class="p">(</span><span class="n">JME_FLAG_MSI</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">jme</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">jme_free_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">jme_adapter</span> <span class="o">*</span><span class="n">jme</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">jme</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">JME_FLAG_MSI</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pci_disable_msi</span><span class="p">(</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">);</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">JME_FLAG_MSI</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">jme</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">jme</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">jme_new_phy_on</span><span class="p">(</span><span class="k">struct</span> <span class="n">jme_adapter</span> <span class="o">*</span><span class="n">jme</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">reg</span><span class="p">;</span>

	<span class="n">reg</span> <span class="o">=</span> <span class="n">jread32</span><span class="p">(</span><span class="n">jme</span><span class="p">,</span> <span class="n">JME_PHY_PWR</span><span class="p">);</span>
	<span class="n">reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">PHY_PWR_DWN1SEL</span> <span class="o">|</span> <span class="n">PHY_PWR_DWN1SW</span> <span class="o">|</span>
		 <span class="n">PHY_PWR_DWN2</span> <span class="o">|</span> <span class="n">PHY_PWR_CLKSEL</span><span class="p">);</span>
	<span class="n">jwrite32</span><span class="p">(</span><span class="n">jme</span><span class="p">,</span> <span class="n">JME_PHY_PWR</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

	<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_PRIV_PE1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="p">);</span>
	<span class="n">reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PE1_GPREG0_PBG</span><span class="p">;</span>
	<span class="n">reg</span> <span class="o">|=</span> <span class="n">PE1_GPREG0_ENBG</span><span class="p">;</span>
	<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_PRIV_PE1</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">jme_new_phy_off</span><span class="p">(</span><span class="k">struct</span> <span class="n">jme_adapter</span> <span class="o">*</span><span class="n">jme</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">reg</span><span class="p">;</span>

	<span class="n">reg</span> <span class="o">=</span> <span class="n">jread32</span><span class="p">(</span><span class="n">jme</span><span class="p">,</span> <span class="n">JME_PHY_PWR</span><span class="p">);</span>
	<span class="n">reg</span> <span class="o">|=</span> <span class="n">PHY_PWR_DWN1SEL</span> <span class="o">|</span> <span class="n">PHY_PWR_DWN1SW</span> <span class="o">|</span>
	       <span class="n">PHY_PWR_DWN2</span> <span class="o">|</span> <span class="n">PHY_PWR_CLKSEL</span><span class="p">;</span>
	<span class="n">jwrite32</span><span class="p">(</span><span class="n">jme</span><span class="p">,</span> <span class="n">JME_PHY_PWR</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

	<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_PRIV_PE1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="p">);</span>
	<span class="n">reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PE1_GPREG0_PBG</span><span class="p">;</span>
	<span class="n">reg</span> <span class="o">|=</span> <span class="n">PE1_GPREG0_PDD3COLD</span><span class="p">;</span>
	<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_PRIV_PE1</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">jme_phy_on</span><span class="p">(</span><span class="k">struct</span> <span class="n">jme_adapter</span> <span class="o">*</span><span class="n">jme</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">bmcr</span><span class="p">;</span>

	<span class="n">bmcr</span> <span class="o">=</span> <span class="n">jme_mdio_read</span><span class="p">(</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">jme</span><span class="o">-&gt;</span><span class="n">mii_if</span><span class="p">.</span><span class="n">phy_id</span><span class="p">,</span> <span class="n">MII_BMCR</span><span class="p">);</span>
	<span class="n">bmcr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">BMCR_PDOWN</span><span class="p">;</span>
	<span class="n">jme_mdio_write</span><span class="p">(</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">jme</span><span class="o">-&gt;</span><span class="n">mii_if</span><span class="p">.</span><span class="n">phy_id</span><span class="p">,</span> <span class="n">MII_BMCR</span><span class="p">,</span> <span class="n">bmcr</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">new_phy_power_ctrl</span><span class="p">(</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">chip_main_rev</span><span class="p">))</span>
		<span class="n">jme_new_phy_on</span><span class="p">(</span><span class="n">jme</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">jme_phy_off</span><span class="p">(</span><span class="k">struct</span> <span class="n">jme_adapter</span> <span class="o">*</span><span class="n">jme</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">bmcr</span><span class="p">;</span>

	<span class="n">bmcr</span> <span class="o">=</span> <span class="n">jme_mdio_read</span><span class="p">(</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">jme</span><span class="o">-&gt;</span><span class="n">mii_if</span><span class="p">.</span><span class="n">phy_id</span><span class="p">,</span> <span class="n">MII_BMCR</span><span class="p">);</span>
	<span class="n">bmcr</span> <span class="o">|=</span> <span class="n">BMCR_PDOWN</span><span class="p">;</span>
	<span class="n">jme_mdio_write</span><span class="p">(</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">jme</span><span class="o">-&gt;</span><span class="n">mii_if</span><span class="p">.</span><span class="n">phy_id</span><span class="p">,</span> <span class="n">MII_BMCR</span><span class="p">,</span> <span class="n">bmcr</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">new_phy_power_ctrl</span><span class="p">(</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">chip_main_rev</span><span class="p">))</span>
		<span class="n">jme_new_phy_off</span><span class="p">(</span><span class="n">jme</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">jme_phy_specreg_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">jme_adapter</span> <span class="o">*</span><span class="n">jme</span><span class="p">,</span> <span class="n">u32</span> <span class="n">specreg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">phy_addr</span><span class="p">;</span>

	<span class="n">phy_addr</span> <span class="o">=</span> <span class="n">JM_PHY_SPEC_REG_READ</span> <span class="o">|</span> <span class="n">specreg</span><span class="p">;</span>
	<span class="n">jme_mdio_write</span><span class="p">(</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">jme</span><span class="o">-&gt;</span><span class="n">mii_if</span><span class="p">.</span><span class="n">phy_id</span><span class="p">,</span> <span class="n">JM_PHY_SPEC_ADDR_REG</span><span class="p">,</span>
			<span class="n">phy_addr</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">jme_mdio_read</span><span class="p">(</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">jme</span><span class="o">-&gt;</span><span class="n">mii_if</span><span class="p">.</span><span class="n">phy_id</span><span class="p">,</span>
			<span class="n">JM_PHY_SPEC_DATA_REG</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">jme_phy_specreg_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">jme_adapter</span> <span class="o">*</span><span class="n">jme</span><span class="p">,</span> <span class="n">u32</span> <span class="n">ext_reg</span><span class="p">,</span> <span class="n">u32</span> <span class="n">phy_data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">phy_addr</span><span class="p">;</span>

	<span class="n">phy_addr</span> <span class="o">=</span> <span class="n">JM_PHY_SPEC_REG_WRITE</span> <span class="o">|</span> <span class="n">ext_reg</span><span class="p">;</span>
	<span class="n">jme_mdio_write</span><span class="p">(</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">jme</span><span class="o">-&gt;</span><span class="n">mii_if</span><span class="p">.</span><span class="n">phy_id</span><span class="p">,</span> <span class="n">JM_PHY_SPEC_DATA_REG</span><span class="p">,</span>
			<span class="n">phy_data</span><span class="p">);</span>
	<span class="n">jme_mdio_write</span><span class="p">(</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">jme</span><span class="o">-&gt;</span><span class="n">mii_if</span><span class="p">.</span><span class="n">phy_id</span><span class="p">,</span> <span class="n">JM_PHY_SPEC_ADDR_REG</span><span class="p">,</span>
			<span class="n">phy_addr</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">jme_phy_calibration</span><span class="p">(</span><span class="k">struct</span> <span class="n">jme_adapter</span> <span class="o">*</span><span class="n">jme</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">ctrl1000</span><span class="p">,</span> <span class="n">phy_data</span><span class="p">;</span>

	<span class="n">jme_phy_off</span><span class="p">(</span><span class="n">jme</span><span class="p">);</span>
	<span class="n">jme_phy_on</span><span class="p">(</span><span class="n">jme</span><span class="p">);</span>
	<span class="cm">/*  Enabel PHY test mode 1 */</span>
	<span class="n">ctrl1000</span> <span class="o">=</span> <span class="n">jme_mdio_read</span><span class="p">(</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">jme</span><span class="o">-&gt;</span><span class="n">mii_if</span><span class="p">.</span><span class="n">phy_id</span><span class="p">,</span> <span class="n">MII_CTRL1000</span><span class="p">);</span>
	<span class="n">ctrl1000</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PHY_GAD_TEST_MODE_MSK</span><span class="p">;</span>
	<span class="n">ctrl1000</span> <span class="o">|=</span> <span class="n">PHY_GAD_TEST_MODE_1</span><span class="p">;</span>
	<span class="n">jme_mdio_write</span><span class="p">(</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">jme</span><span class="o">-&gt;</span><span class="n">mii_if</span><span class="p">.</span><span class="n">phy_id</span><span class="p">,</span> <span class="n">MII_CTRL1000</span><span class="p">,</span> <span class="n">ctrl1000</span><span class="p">);</span>

	<span class="n">phy_data</span> <span class="o">=</span> <span class="n">jme_phy_specreg_read</span><span class="p">(</span><span class="n">jme</span><span class="p">,</span> <span class="n">JM_PHY_EXT_COMM_2_REG</span><span class="p">);</span>
	<span class="n">phy_data</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">JM_PHY_EXT_COMM_2_CALI_MODE_0</span><span class="p">;</span>
	<span class="n">phy_data</span> <span class="o">|=</span> <span class="n">JM_PHY_EXT_COMM_2_CALI_LATCH</span> <span class="o">|</span>
			<span class="n">JM_PHY_EXT_COMM_2_CALI_ENABLE</span><span class="p">;</span>
	<span class="n">jme_phy_specreg_write</span><span class="p">(</span><span class="n">jme</span><span class="p">,</span> <span class="n">JM_PHY_EXT_COMM_2_REG</span><span class="p">,</span> <span class="n">phy_data</span><span class="p">);</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>
	<span class="n">phy_data</span> <span class="o">=</span> <span class="n">jme_phy_specreg_read</span><span class="p">(</span><span class="n">jme</span><span class="p">,</span> <span class="n">JM_PHY_EXT_COMM_2_REG</span><span class="p">);</span>
	<span class="n">phy_data</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">JM_PHY_EXT_COMM_2_CALI_ENABLE</span> <span class="o">|</span>
			<span class="n">JM_PHY_EXT_COMM_2_CALI_MODE_0</span> <span class="o">|</span>
			<span class="n">JM_PHY_EXT_COMM_2_CALI_LATCH</span><span class="p">);</span>
	<span class="n">jme_phy_specreg_write</span><span class="p">(</span><span class="n">jme</span><span class="p">,</span> <span class="n">JM_PHY_EXT_COMM_2_REG</span><span class="p">,</span> <span class="n">phy_data</span><span class="p">);</span>

	<span class="cm">/*  Disable PHY test mode */</span>
	<span class="n">ctrl1000</span> <span class="o">=</span> <span class="n">jme_mdio_read</span><span class="p">(</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">jme</span><span class="o">-&gt;</span><span class="n">mii_if</span><span class="p">.</span><span class="n">phy_id</span><span class="p">,</span> <span class="n">MII_CTRL1000</span><span class="p">);</span>
	<span class="n">ctrl1000</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PHY_GAD_TEST_MODE_MSK</span><span class="p">;</span>
	<span class="n">jme_mdio_write</span><span class="p">(</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">jme</span><span class="o">-&gt;</span><span class="n">mii_if</span><span class="p">.</span><span class="n">phy_id</span><span class="p">,</span> <span class="n">MII_CTRL1000</span><span class="p">,</span> <span class="n">ctrl1000</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">jme_phy_setEA</span><span class="p">(</span><span class="k">struct</span> <span class="n">jme_adapter</span> <span class="o">*</span><span class="n">jme</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">phy_comm0</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">phy_comm1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">nic_ctrl</span><span class="p">;</span>

	<span class="n">pci_read_config_byte</span><span class="p">(</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_PRIV_SHARE_NICCTRL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nic_ctrl</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">nic_ctrl</span> <span class="o">&amp;</span> <span class="mh">0x3</span><span class="p">)</span> <span class="o">==</span> <span class="n">JME_FLAG_PHYEA_ENABLE</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PCI_DEVICE_ID_JMICRON_JMC250</span>:
		<span class="k">if</span> <span class="p">(((</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">chip_main_rev</span> <span class="o">==</span> <span class="mi">5</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			<span class="p">((</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">chip_sub_rev</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">chip_sub_rev</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">||</span>
			<span class="p">(</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">chip_sub_rev</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)))</span> <span class="o">||</span>
			<span class="p">(</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">chip_main_rev</span> <span class="o">&gt;=</span> <span class="mi">6</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">phy_comm0</span> <span class="o">=</span> <span class="mh">0x008A</span><span class="p">;</span>
			<span class="n">phy_comm1</span> <span class="o">=</span> <span class="mh">0x4109</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">chip_main_rev</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			<span class="p">((</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">chip_sub_rev</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">chip_sub_rev</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)))</span>
			<span class="n">phy_comm0</span> <span class="o">=</span> <span class="mh">0xE088</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PCI_DEVICE_ID_JMICRON_JMC260</span>:
		<span class="k">if</span> <span class="p">(((</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">chip_main_rev</span> <span class="o">==</span> <span class="mi">5</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			<span class="p">((</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">chip_sub_rev</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">chip_sub_rev</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">||</span>
			<span class="p">(</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">chip_sub_rev</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)))</span> <span class="o">||</span>
			<span class="p">(</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">chip_main_rev</span> <span class="o">&gt;=</span> <span class="mi">6</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">phy_comm0</span> <span class="o">=</span> <span class="mh">0x008A</span><span class="p">;</span>
			<span class="n">phy_comm1</span> <span class="o">=</span> <span class="mh">0x4109</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">chip_main_rev</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			<span class="p">((</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">chip_sub_rev</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">chip_sub_rev</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)))</span>
			<span class="n">phy_comm0</span> <span class="o">=</span> <span class="mh">0xE088</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">chip_main_rev</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">chip_sub_rev</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span>
			<span class="n">phy_comm0</span> <span class="o">=</span> <span class="mh">0x608A</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">chip_main_rev</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">chip_sub_rev</span> <span class="o">==</span> <span class="mi">2</span><span class="p">))</span>
			<span class="n">phy_comm0</span> <span class="o">=</span> <span class="mh">0x408A</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phy_comm0</span><span class="p">)</span>
		<span class="n">jme_phy_specreg_write</span><span class="p">(</span><span class="n">jme</span><span class="p">,</span> <span class="n">JM_PHY_EXT_COMM_0_REG</span><span class="p">,</span> <span class="n">phy_comm0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phy_comm1</span><span class="p">)</span>
		<span class="n">jme_phy_specreg_write</span><span class="p">(</span><span class="n">jme</span><span class="p">,</span> <span class="n">JM_PHY_EXT_COMM_1_REG</span><span class="p">,</span> <span class="n">phy_comm1</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">jme_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">jme_adapter</span> <span class="o">*</span><span class="n">jme</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">jme_clear_pm</span><span class="p">(</span><span class="n">jme</span><span class="p">);</span>
	<span class="n">JME_NAPI_ENABLE</span><span class="p">(</span><span class="n">jme</span><span class="p">);</span>

	<span class="n">tasklet_enable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">linkch_task</span><span class="p">);</span>
	<span class="n">tasklet_enable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">txclean_task</span><span class="p">);</span>
	<span class="n">tasklet_hi_enable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">rxclean_task</span><span class="p">);</span>
	<span class="n">tasklet_hi_enable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">rxempty_task</span><span class="p">);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">jme_request_irq</span><span class="p">(</span><span class="n">jme</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>

	<span class="n">jme_start_irq</span><span class="p">(</span><span class="n">jme</span><span class="p">);</span>

	<span class="n">jme_phy_on</span><span class="p">(</span><span class="n">jme</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">JME_FLAG_SSET</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
		<span class="n">jme_set_settings</span><span class="p">(</span><span class="n">netdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">old_ecmd</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">jme_reset_phy_processor</span><span class="p">(</span><span class="n">jme</span><span class="p">);</span>
	<span class="n">jme_phy_calibration</span><span class="p">(</span><span class="n">jme</span><span class="p">);</span>
	<span class="n">jme_phy_setEA</span><span class="p">(</span><span class="n">jme</span><span class="p">);</span>
	<span class="n">jme_reset_link</span><span class="p">(</span><span class="n">jme</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_out:</span>
	<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="n">netif_carrier_off</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">jme_set_100m_half</span><span class="p">(</span><span class="k">struct</span> <span class="n">jme_adapter</span> <span class="o">*</span><span class="n">jme</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">bmcr</span><span class="p">,</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="n">jme_phy_on</span><span class="p">(</span><span class="n">jme</span><span class="p">);</span>
	<span class="n">bmcr</span> <span class="o">=</span> <span class="n">jme_mdio_read</span><span class="p">(</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">jme</span><span class="o">-&gt;</span><span class="n">mii_if</span><span class="p">.</span><span class="n">phy_id</span><span class="p">,</span> <span class="n">MII_BMCR</span><span class="p">);</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">bmcr</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">BMCR_ANENABLE</span> <span class="o">|</span> <span class="n">BMCR_SPEED100</span> <span class="o">|</span>
		       <span class="n">BMCR_SPEED1000</span> <span class="o">|</span> <span class="n">BMCR_FULLDPLX</span><span class="p">);</span>
	<span class="n">tmp</span> <span class="o">|=</span> <span class="n">BMCR_SPEED100</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bmcr</span> <span class="o">!=</span> <span class="n">tmp</span><span class="p">)</span>
		<span class="n">jme_mdio_write</span><span class="p">(</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">jme</span><span class="o">-&gt;</span><span class="n">mii_if</span><span class="p">.</span><span class="n">phy_id</span><span class="p">,</span> <span class="n">MII_BMCR</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">fpgaver</span><span class="p">)</span>
		<span class="n">jwrite32</span><span class="p">(</span><span class="n">jme</span><span class="p">,</span> <span class="n">JME_GHC</span><span class="p">,</span> <span class="n">GHC_SPEED_100M</span> <span class="o">|</span> <span class="n">GHC_LINK_POLL</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">jwrite32</span><span class="p">(</span><span class="n">jme</span><span class="p">,</span> <span class="n">JME_GHC</span><span class="p">,</span> <span class="n">GHC_SPEED_100M</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#define JME_WAIT_LINK_TIME 2000 </span><span class="cm">/* 2000ms */</span><span class="cp"></span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">jme_wait_link</span><span class="p">(</span><span class="k">struct</span> <span class="n">jme_adapter</span> <span class="o">*</span><span class="n">jme</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">phylink</span><span class="p">,</span> <span class="n">to</span> <span class="o">=</span> <span class="n">JME_WAIT_LINK_TIME</span><span class="p">;</span>

	<span class="n">mdelay</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
	<span class="n">phylink</span> <span class="o">=</span> <span class="n">jme_linkstat_from_phy</span><span class="p">(</span><span class="n">jme</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">phylink</span> <span class="o">&amp;</span> <span class="n">PHY_LINK_UP</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">to</span> <span class="o">-=</span> <span class="mi">10</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mdelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
		<span class="n">phylink</span> <span class="o">=</span> <span class="n">jme_linkstat_from_phy</span><span class="p">(</span><span class="n">jme</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">jme_powersave_phy</span><span class="p">(</span><span class="k">struct</span> <span class="n">jme_adapter</span> <span class="o">*</span><span class="n">jme</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">reg_pmcs</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">jme_set_100m_half</span><span class="p">(</span><span class="n">jme</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">reg_pmcs</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">PMCS_LFEN</span> <span class="o">|</span> <span class="n">PMCS_LREN</span><span class="p">))</span>
			<span class="n">jme_wait_link</span><span class="p">(</span><span class="n">jme</span><span class="p">);</span>
		<span class="n">jme_clear_pm</span><span class="p">(</span><span class="n">jme</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">jme_phy_off</span><span class="p">(</span><span class="n">jme</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">jme_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">jme_adapter</span> <span class="o">*</span><span class="n">jme</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>

	<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="n">netif_carrier_off</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>

	<span class="n">jme_stop_irq</span><span class="p">(</span><span class="n">jme</span><span class="p">);</span>
	<span class="n">jme_free_irq</span><span class="p">(</span><span class="n">jme</span><span class="p">);</span>

	<span class="n">JME_NAPI_DISABLE</span><span class="p">(</span><span class="n">jme</span><span class="p">);</span>

	<span class="n">tasklet_disable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">linkch_task</span><span class="p">);</span>
	<span class="n">tasklet_disable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">txclean_task</span><span class="p">);</span>
	<span class="n">tasklet_disable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">rxclean_task</span><span class="p">);</span>
	<span class="n">tasklet_disable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">rxempty_task</span><span class="p">);</span>

	<span class="n">jme_disable_rx_engine</span><span class="p">(</span><span class="n">jme</span><span class="p">);</span>
	<span class="n">jme_disable_tx_engine</span><span class="p">(</span><span class="n">jme</span><span class="p">);</span>
	<span class="n">jme_reset_mac_processor</span><span class="p">(</span><span class="n">jme</span><span class="p">);</span>
	<span class="n">jme_free_rx_resources</span><span class="p">(</span><span class="n">jme</span><span class="p">);</span>
	<span class="n">jme_free_tx_resources</span><span class="p">(</span><span class="n">jme</span><span class="p">);</span>
	<span class="n">jme</span><span class="o">-&gt;</span><span class="n">phylink</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">jme_phy_off</span><span class="p">(</span><span class="n">jme</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">jme_alloc_txdesc</span><span class="p">(</span><span class="k">struct</span> <span class="n">jme_adapter</span> <span class="o">*</span><span class="n">jme</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">jme_ring</span> <span class="o">*</span><span class="n">txring</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">txring</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="kt">int</span> <span class="n">idx</span><span class="p">,</span> <span class="n">nr_alloc</span><span class="p">,</span> <span class="n">mask</span> <span class="o">=</span> <span class="n">jme</span><span class="o">-&gt;</span><span class="n">tx_ring_mask</span><span class="p">;</span>

	<span class="n">idx</span> <span class="o">=</span> <span class="n">txring</span><span class="o">-&gt;</span><span class="n">next_to_use</span><span class="p">;</span>
	<span class="n">nr_alloc</span> <span class="o">=</span> <span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">nr_frags</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">txring</span><span class="o">-&gt;</span><span class="n">nr_free</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">nr_alloc</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">atomic_sub</span><span class="p">(</span><span class="n">nr_alloc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">txring</span><span class="o">-&gt;</span><span class="n">nr_free</span><span class="p">);</span>

	<span class="n">txring</span><span class="o">-&gt;</span><span class="n">next_to_use</span> <span class="o">=</span> <span class="p">(</span><span class="n">txring</span><span class="o">-&gt;</span><span class="n">next_to_use</span> <span class="o">+</span> <span class="n">nr_alloc</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">idx</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">jme_fill_tx_map</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">txdesc</span> <span class="o">*</span><span class="n">txdesc</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">jme_buffer_info</span> <span class="o">*</span><span class="n">txbi</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">page</span><span class="p">,</span>
		<span class="n">u32</span> <span class="n">page_offset</span><span class="p">,</span>
		<span class="n">u32</span> <span class="n">len</span><span class="p">,</span>
		<span class="n">bool</span> <span class="n">hidma</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dma_addr_t</span> <span class="n">dmaaddr</span><span class="p">;</span>

	<span class="n">dmaaddr</span> <span class="o">=</span> <span class="n">pci_map_page</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span>
				<span class="n">page</span><span class="p">,</span>
				<span class="n">page_offset</span><span class="p">,</span>
				<span class="n">len</span><span class="p">,</span>
				<span class="n">PCI_DMA_TODEVICE</span><span class="p">);</span>

	<span class="n">pci_dma_sync_single_for_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span>
				       <span class="n">dmaaddr</span><span class="p">,</span>
				       <span class="n">len</span><span class="p">,</span>
				       <span class="n">PCI_DMA_TODEVICE</span><span class="p">);</span>

	<span class="n">txdesc</span><span class="o">-&gt;</span><span class="n">dw</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">txdesc</span><span class="o">-&gt;</span><span class="n">dw</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">txdesc</span><span class="o">-&gt;</span><span class="n">desc2</span><span class="p">.</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">TXFLAG_OWN</span><span class="p">;</span>
	<span class="n">txdesc</span><span class="o">-&gt;</span><span class="n">desc2</span><span class="p">.</span><span class="n">flags</span>	<span class="o">|=</span> <span class="p">(</span><span class="n">hidma</span><span class="p">)</span> <span class="o">?</span> <span class="n">TXFLAG_64BIT</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">txdesc</span><span class="o">-&gt;</span><span class="n">desc2</span><span class="p">.</span><span class="n">datalen</span>	<span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">len</span><span class="p">);</span>
	<span class="n">txdesc</span><span class="o">-&gt;</span><span class="n">desc2</span><span class="p">.</span><span class="n">bufaddrh</span>	<span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">((</span><span class="n">__u64</span><span class="p">)</span><span class="n">dmaaddr</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">);</span>
	<span class="n">txdesc</span><span class="o">-&gt;</span><span class="n">desc2</span><span class="p">.</span><span class="n">bufaddrl</span>	<span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span>
					<span class="p">(</span><span class="n">__u64</span><span class="p">)</span><span class="n">dmaaddr</span> <span class="o">&amp;</span> <span class="mh">0xFFFFFFFFUL</span><span class="p">);</span>

	<span class="n">txbi</span><span class="o">-&gt;</span><span class="n">mapping</span> <span class="o">=</span> <span class="n">dmaaddr</span><span class="p">;</span>
	<span class="n">txbi</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">jme_map_tx_skb</span><span class="p">(</span><span class="k">struct</span> <span class="n">jme_adapter</span> <span class="o">*</span><span class="n">jme</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">idx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">jme_ring</span> <span class="o">*</span><span class="n">txring</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">txring</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="k">struct</span> <span class="n">txdesc</span> <span class="o">*</span><span class="n">txdesc</span> <span class="o">=</span> <span class="n">txring</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">,</span> <span class="o">*</span><span class="n">ctxdesc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">jme_buffer_info</span> <span class="o">*</span><span class="n">txbi</span> <span class="o">=</span> <span class="n">txring</span><span class="o">-&gt;</span><span class="n">bufinf</span><span class="p">,</span> <span class="o">*</span><span class="n">ctxbi</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">hidma</span> <span class="o">=</span> <span class="n">jme</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">NETIF_F_HIGHDMA</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">nr_frags</span> <span class="o">=</span> <span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">nr_frags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">mask</span> <span class="o">=</span> <span class="n">jme</span><span class="o">-&gt;</span><span class="n">tx_ring_mask</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">skb_frag_struct</span> <span class="o">*</span><span class="n">frag</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">len</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nr_frags</span> <span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">frag</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">frags</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">ctxdesc</span> <span class="o">=</span> <span class="n">txdesc</span> <span class="o">+</span> <span class="p">((</span><span class="n">idx</span> <span class="o">+</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">mask</span><span class="p">));</span>
		<span class="n">ctxbi</span> <span class="o">=</span> <span class="n">txbi</span> <span class="o">+</span> <span class="p">((</span><span class="n">idx</span> <span class="o">+</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">mask</span><span class="p">));</span>

		<span class="n">jme_fill_tx_map</span><span class="p">(</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">ctxdesc</span><span class="p">,</span> <span class="n">ctxbi</span><span class="p">,</span>
				<span class="n">skb_frag_page</span><span class="p">(</span><span class="n">frag</span><span class="p">),</span>
				<span class="n">frag</span><span class="o">-&gt;</span><span class="n">page_offset</span><span class="p">,</span> <span class="n">skb_frag_size</span><span class="p">(</span><span class="n">frag</span><span class="p">),</span> <span class="n">hidma</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">len</span> <span class="o">=</span> <span class="n">skb_is_nonlinear</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="o">?</span> <span class="n">skb_headlen</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="o">:</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
	<span class="n">ctxdesc</span> <span class="o">=</span> <span class="n">txdesc</span> <span class="o">+</span> <span class="p">((</span><span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">mask</span><span class="p">));</span>
	<span class="n">ctxbi</span> <span class="o">=</span> <span class="n">txbi</span> <span class="o">+</span> <span class="p">((</span><span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">mask</span><span class="p">));</span>
	<span class="n">jme_fill_tx_map</span><span class="p">(</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">ctxdesc</span><span class="p">,</span> <span class="n">ctxbi</span><span class="p">,</span> <span class="n">virt_to_page</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">),</span>
			<span class="n">offset_in_page</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">),</span> <span class="n">len</span><span class="p">,</span> <span class="n">hidma</span><span class="p">);</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">jme_expand_header</span><span class="p">(</span><span class="k">struct</span> <span class="n">jme_adapter</span> <span class="o">*</span><span class="n">jme</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">gso_size</span> <span class="o">&amp;&amp;</span>
			<span class="n">skb_header_cloned</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			<span class="n">pskb_expand_head</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">jme_tx_tso</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="n">__le16</span> <span class="o">*</span><span class="n">mss</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="o">*</span><span class="n">mss</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">gso_size</span> <span class="o">&lt;&lt;</span> <span class="n">TXDESC_MSS_SHIFT</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">mss</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">TXFLAG_LSEN</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">==</span> <span class="n">htons</span><span class="p">(</span><span class="n">ETH_P_IP</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">iphdr</span> <span class="o">*</span><span class="n">iph</span> <span class="o">=</span> <span class="n">ip_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

			<span class="n">iph</span><span class="o">-&gt;</span><span class="n">check</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">tcp_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">check</span> <span class="o">=</span> <span class="o">~</span><span class="n">csum_tcpudp_magic</span><span class="p">(</span><span class="n">iph</span><span class="o">-&gt;</span><span class="n">saddr</span><span class="p">,</span>
								<span class="n">iph</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
								<span class="n">IPPROTO_TCP</span><span class="p">,</span>
								<span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">ipv6hdr</span> <span class="o">*</span><span class="n">ip6h</span> <span class="o">=</span> <span class="n">ipv6_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

			<span class="n">tcp_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">check</span> <span class="o">=</span> <span class="o">~</span><span class="n">csum_ipv6_magic</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ip6h</span><span class="o">-&gt;</span><span class="n">saddr</span><span class="p">,</span>
								<span class="o">&amp;</span><span class="n">ip6h</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
								<span class="n">IPPROTO_TCP</span><span class="p">,</span>
								<span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">jme_tx_csum</span><span class="p">(</span><span class="k">struct</span> <span class="n">jme_adapter</span> <span class="o">*</span><span class="n">jme</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">ip_summed</span> <span class="o">==</span> <span class="n">CHECKSUM_PARTIAL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="n">ip_proto</span><span class="p">;</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">protocol</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">htons</span><span class="p">(</span><span class="n">ETH_P_IP</span><span class="p">)</span>:
			<span class="n">ip_proto</span> <span class="o">=</span> <span class="n">ip_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">protocol</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">htons</span><span class="p">(</span><span class="n">ETH_P_IPV6</span><span class="p">)</span>:
			<span class="n">ip_proto</span> <span class="o">=</span> <span class="n">ipv6_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">nexthdr</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">ip_proto</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">ip_proto</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">IPPROTO_TCP</span>:
			<span class="o">*</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">TXFLAG_TCPCS</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">IPPROTO_UDP</span>:
			<span class="o">*</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">TXFLAG_UDPCS</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">netif_err</span><span class="p">(</span><span class="n">jme</span><span class="p">,</span> <span class="n">tx_err</span><span class="p">,</span> <span class="n">jme</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Error upper layer protocol</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">jme_tx_vlan</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="n">__le16</span> <span class="o">*</span><span class="n">vlan</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vlan_tx_tag_present</span><span class="p">(</span><span class="n">skb</span><span class="p">))</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">TXFLAG_TAGON</span><span class="p">;</span>
		<span class="o">*</span><span class="n">vlan</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">vlan_tx_tag_get</span><span class="p">(</span><span class="n">skb</span><span class="p">));</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">jme_fill_tx_desc</span><span class="p">(</span><span class="k">struct</span> <span class="n">jme_adapter</span> <span class="o">*</span><span class="n">jme</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">idx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">jme_ring</span> <span class="o">*</span><span class="n">txring</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">txring</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="k">struct</span> <span class="n">txdesc</span> <span class="o">*</span><span class="n">txdesc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">jme_buffer_info</span> <span class="o">*</span><span class="n">txbi</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">txdesc</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">txdesc</span> <span class="o">*</span><span class="p">)</span><span class="n">txring</span><span class="o">-&gt;</span><span class="n">desc</span> <span class="o">+</span> <span class="n">idx</span><span class="p">;</span>
	<span class="n">txbi</span> <span class="o">=</span> <span class="n">txring</span><span class="o">-&gt;</span><span class="n">bufinf</span> <span class="o">+</span> <span class="n">idx</span><span class="p">;</span>

	<span class="n">txdesc</span><span class="o">-&gt;</span><span class="n">dw</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">txdesc</span><span class="o">-&gt;</span><span class="n">dw</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">txdesc</span><span class="o">-&gt;</span><span class="n">dw</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">txdesc</span><span class="o">-&gt;</span><span class="n">dw</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">txdesc</span><span class="o">-&gt;</span><span class="n">desc1</span><span class="p">.</span><span class="n">pktsize</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * Set OWN bit at final.</span>
<span class="cm">	 * When kernel transmit faster than NIC.</span>
<span class="cm">	 * And NIC trying to send this descriptor before we tell</span>
<span class="cm">	 * it to start sending this TX queue.</span>
<span class="cm">	 * Other fields are already filled correctly.</span>
<span class="cm">	 */</span>
	<span class="n">wmb</span><span class="p">();</span>
	<span class="n">flags</span> <span class="o">=</span> <span class="n">TXFLAG_OWN</span> <span class="o">|</span> <span class="n">TXFLAG_INT</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * Set checksum flags while not tso</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">jme_tx_tso</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">txdesc</span><span class="o">-&gt;</span><span class="n">desc1</span><span class="p">.</span><span class="n">mss</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">flags</span><span class="p">))</span>
		<span class="n">jme_tx_csum</span><span class="p">(</span><span class="n">jme</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">jme_tx_vlan</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">txdesc</span><span class="o">-&gt;</span><span class="n">desc1</span><span class="p">.</span><span class="n">vlan</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">jme_map_tx_skb</span><span class="p">(</span><span class="n">jme</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>
	<span class="n">txdesc</span><span class="o">-&gt;</span><span class="n">desc1</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">flags</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * Set tx buffer info after telling NIC to send</span>
<span class="cm">	 * For better tx_clean timing</span>
<span class="cm">	 */</span>
	<span class="n">wmb</span><span class="p">();</span>
	<span class="n">txbi</span><span class="o">-&gt;</span><span class="n">nr_desc</span> <span class="o">=</span> <span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">nr_frags</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">txbi</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>
	<span class="n">txbi</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
	<span class="n">txbi</span><span class="o">-&gt;</span><span class="n">start_xmit</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">txbi</span><span class="o">-&gt;</span><span class="n">start_xmit</span><span class="p">)</span>
		<span class="n">txbi</span><span class="o">-&gt;</span><span class="n">start_xmit</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0UL</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">jme_stop_queue_if_full</span><span class="p">(</span><span class="k">struct</span> <span class="n">jme_adapter</span> <span class="o">*</span><span class="n">jme</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">jme_ring</span> <span class="o">*</span><span class="n">txring</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">txring</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="k">struct</span> <span class="n">jme_buffer_info</span> <span class="o">*</span><span class="n">txbi</span> <span class="o">=</span> <span class="n">txring</span><span class="o">-&gt;</span><span class="n">bufinf</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">idx</span> <span class="o">=</span> <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">txring</span><span class="o">-&gt;</span><span class="n">next_to_clean</span><span class="p">);</span>

	<span class="n">txbi</span> <span class="o">+=</span> <span class="n">idx</span><span class="p">;</span>

	<span class="n">smp_wmb</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">txring</span><span class="o">-&gt;</span><span class="n">nr_free</span><span class="p">)</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">MAX_SKB_FRAGS</span><span class="o">+</span><span class="mi">2</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">netif_info</span><span class="p">(</span><span class="n">jme</span><span class="p">,</span> <span class="n">tx_queued</span><span class="p">,</span> <span class="n">jme</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;TX Queue Paused</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">smp_wmb</span><span class="p">();</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">txring</span><span class="o">-&gt;</span><span class="n">nr_free</span><span class="p">)</span>
			<span class="o">&gt;=</span> <span class="p">(</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">tx_wake_threshold</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
			<span class="n">netif_info</span><span class="p">(</span><span class="n">jme</span><span class="p">,</span> <span class="n">tx_queued</span><span class="p">,</span> <span class="n">jme</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;TX Queue Fast Waked</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">txbi</span><span class="o">-&gt;</span><span class="n">start_xmit</span> <span class="o">&amp;&amp;</span>
			<span class="p">(</span><span class="n">jiffies</span> <span class="o">-</span> <span class="n">txbi</span><span class="o">-&gt;</span><span class="n">start_xmit</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">TX_TIMEOUT</span> <span class="o">&amp;&amp;</span>
			<span class="n">txbi</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">netif_info</span><span class="p">(</span><span class="n">jme</span><span class="p">,</span> <span class="n">tx_queued</span><span class="p">,</span> <span class="n">jme</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			   <span class="s">&quot;TX Queue Stopped %d@%lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">jiffies</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This function is already protected by netif_tx_lock()</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="n">netdev_tx_t</span>
<span class="nf">jme_start_xmit</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">jme_adapter</span> <span class="o">*</span><span class="n">jme</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">idx</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">jme_expand_header</span><span class="p">(</span><span class="n">jme</span><span class="p">,</span> <span class="n">skb</span><span class="p">)))</span> <span class="p">{</span>
		<span class="o">++</span><span class="p">(</span><span class="n">NET_STAT</span><span class="p">(</span><span class="n">jme</span><span class="p">).</span><span class="n">tx_dropped</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">NETDEV_TX_OK</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">idx</span> <span class="o">=</span> <span class="n">jme_alloc_txdesc</span><span class="p">(</span><span class="n">jme</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">idx</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
		<span class="n">netif_err</span><span class="p">(</span><span class="n">jme</span><span class="p">,</span> <span class="n">tx_err</span><span class="p">,</span> <span class="n">jme</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			  <span class="s">&quot;BUG! Tx ring full when queue awake!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="k">return</span> <span class="n">NETDEV_TX_BUSY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">jme_fill_tx_desc</span><span class="p">(</span><span class="n">jme</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>

	<span class="n">jwrite32</span><span class="p">(</span><span class="n">jme</span><span class="p">,</span> <span class="n">JME_TXCS</span><span class="p">,</span> <span class="n">jme</span><span class="o">-&gt;</span><span class="n">reg_txcs</span> <span class="o">|</span>
				<span class="n">TXCS_SELECT_QUEUE0</span> <span class="o">|</span>
				<span class="n">TXCS_QUEUE0S</span> <span class="o">|</span>
				<span class="n">TXCS_ENABLE</span><span class="p">);</span>

	<span class="n">tx_dbg</span><span class="p">(</span><span class="n">jme</span><span class="p">,</span> <span class="s">&quot;xmit: %d+%d@%lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">idx</span><span class="p">,</span> <span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">nr_frags</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="n">jiffies</span><span class="p">);</span>
	<span class="n">jme_stop_queue_if_full</span><span class="p">(</span><span class="n">jme</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">NETDEV_TX_OK</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">jme_set_unicastaddr</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">jme_adapter</span> <span class="o">*</span><span class="n">jme</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span> <span class="o">|</span>
	      <span class="p">(</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span> <span class="o">|</span>
	      <span class="p">(</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">&lt;&lt;</span>  <span class="mi">8</span> <span class="o">|</span>
	      <span class="p">(</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="n">jwrite32</span><span class="p">(</span><span class="n">jme</span><span class="p">,</span> <span class="n">JME_RXUMA_LO</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span> <span class="o">|</span>
	      <span class="p">(</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="n">jwrite32</span><span class="p">(</span><span class="n">jme</span><span class="p">,</span> <span class="n">JME_RXUMA_HI</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">jme_set_macaddr</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">jme_adapter</span> <span class="o">*</span><span class="n">jme</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="n">addr</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">netif_running</span><span class="p">(</span><span class="n">netdev</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">macaddr_lock</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">addr</span><span class="o">-&gt;</span><span class="n">sa_data</span><span class="p">,</span> <span class="n">netdev</span><span class="o">-&gt;</span><span class="n">addr_len</span><span class="p">);</span>
	<span class="n">jme_set_unicastaddr</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">macaddr_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">jme_set_multi</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">jme_adapter</span> <span class="o">*</span><span class="n">jme</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">mc_hash</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{};</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">rxmcs_lock</span><span class="p">);</span>

	<span class="n">jme</span><span class="o">-&gt;</span><span class="n">reg_rxmcs</span> <span class="o">|=</span> <span class="n">RXMCS_BRDFRAME</span> <span class="o">|</span> <span class="n">RXMCS_UNIFRAME</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_PROMISC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">jme</span><span class="o">-&gt;</span><span class="n">reg_rxmcs</span> <span class="o">|=</span> <span class="n">RXMCS_ALLFRAME</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_ALLMULTI</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">jme</span><span class="o">-&gt;</span><span class="n">reg_rxmcs</span> <span class="o">|=</span> <span class="n">RXMCS_ALLMULFRAME</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_MULTICAST</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">netdev_hw_addr</span> <span class="o">*</span><span class="n">ha</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">bit_nr</span><span class="p">;</span>

		<span class="n">jme</span><span class="o">-&gt;</span><span class="n">reg_rxmcs</span> <span class="o">|=</span> <span class="n">RXMCS_MULFRAME</span> <span class="o">|</span> <span class="n">RXMCS_MULFILTERED</span><span class="p">;</span>
		<span class="n">netdev_for_each_mc_addr</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">netdev</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">bit_nr</span> <span class="o">=</span> <span class="n">ether_crc</span><span class="p">(</span><span class="n">ETH_ALEN</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3F</span><span class="p">;</span>
			<span class="n">mc_hash</span><span class="p">[</span><span class="n">bit_nr</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span><span class="p">]</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">bit_nr</span> <span class="o">&amp;</span> <span class="mh">0x1F</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">jwrite32</span><span class="p">(</span><span class="n">jme</span><span class="p">,</span> <span class="n">JME_RXMCHT_LO</span><span class="p">,</span> <span class="n">mc_hash</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="n">jwrite32</span><span class="p">(</span><span class="n">jme</span><span class="p">,</span> <span class="n">JME_RXMCHT_HI</span><span class="p">,</span> <span class="n">mc_hash</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
	<span class="p">}</span>

	<span class="n">wmb</span><span class="p">();</span>
	<span class="n">jwrite32</span><span class="p">(</span><span class="n">jme</span><span class="p">,</span> <span class="n">JME_RXMCS</span><span class="p">,</span> <span class="n">jme</span><span class="o">-&gt;</span><span class="n">reg_rxmcs</span><span class="p">);</span>

	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">rxmcs_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">jme_change_mtu</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">new_mtu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">jme_adapter</span> <span class="o">*</span><span class="n">jme</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">new_mtu</span> <span class="o">==</span> <span class="n">jme</span><span class="o">-&gt;</span><span class="n">old_mtu</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(((</span><span class="n">new_mtu</span> <span class="o">+</span> <span class="n">ETH_HLEN</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">MAX_ETHERNET_JUMBO_PACKET_SIZE</span><span class="p">)</span> <span class="o">||</span>
		<span class="p">((</span><span class="n">new_mtu</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">IPV6_MIN_MTU</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>


	<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">mtu</span> <span class="o">=</span> <span class="n">new_mtu</span><span class="p">;</span>
	<span class="n">netdev_update_features</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>

	<span class="n">jme_restart_rx_engine</span><span class="p">(</span><span class="n">jme</span><span class="p">);</span>
	<span class="n">jme_reset_link</span><span class="p">(</span><span class="n">jme</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">jme_tx_timeout</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">jme_adapter</span> <span class="o">*</span><span class="n">jme</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>

	<span class="n">jme</span><span class="o">-&gt;</span><span class="n">phylink</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">jme_reset_phy_processor</span><span class="p">(</span><span class="n">jme</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">JME_FLAG_SSET</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
		<span class="n">jme_set_settings</span><span class="p">(</span><span class="n">netdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">old_ecmd</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Force to Reset the link again</span>
<span class="cm">	 */</span>
	<span class="n">jme_reset_link</span><span class="p">(</span><span class="n">jme</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">jme_pause_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">jme_adapter</span> <span class="o">*</span><span class="n">jme</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">link_changing</span><span class="p">);</span>

	<span class="n">jme_set_rx_pcc</span><span class="p">(</span><span class="n">jme</span><span class="p">,</span> <span class="n">PCC_OFF</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">JME_FLAG_POLL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">JME_NAPI_DISABLE</span><span class="p">(</span><span class="n">jme</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">tasklet_disable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">rxclean_task</span><span class="p">);</span>
		<span class="n">tasklet_disable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">rxempty_task</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">jme_resume_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">jme_adapter</span> <span class="o">*</span><span class="n">jme</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dynpcc_info</span> <span class="o">*</span><span class="n">dpi</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">dpi</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">JME_FLAG_POLL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">JME_NAPI_ENABLE</span><span class="p">(</span><span class="n">jme</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">tasklet_hi_enable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">rxclean_task</span><span class="p">);</span>
		<span class="n">tasklet_hi_enable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">rxempty_task</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">dpi</span><span class="o">-&gt;</span><span class="n">cur</span>		<span class="o">=</span> <span class="n">PCC_P1</span><span class="p">;</span>
	<span class="n">dpi</span><span class="o">-&gt;</span><span class="n">attempt</span>		<span class="o">=</span> <span class="n">PCC_P1</span><span class="p">;</span>
	<span class="n">dpi</span><span class="o">-&gt;</span><span class="n">cnt</span>		<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">jme_set_rx_pcc</span><span class="p">(</span><span class="n">jme</span><span class="p">,</span> <span class="n">PCC_P1</span><span class="p">);</span>

	<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">link_changing</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">jme_get_drvinfo</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span>
		     <span class="k">struct</span> <span class="n">ethtool_drvinfo</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">jme_adapter</span> <span class="o">*</span><span class="n">jme</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>

	<span class="n">strlcpy</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">,</span> <span class="n">DRV_NAME</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">));</span>
	<span class="n">strlcpy</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">,</span> <span class="n">DRV_VERSION</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">));</span>
	<span class="n">strlcpy</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">bus_info</span><span class="p">,</span> <span class="n">pci_name</span><span class="p">(</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">),</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">bus_info</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">jme_get_regs_len</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">JME_REG_LEN</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">mmapio_memcpy</span><span class="p">(</span><span class="k">struct</span> <span class="n">jme_adapter</span> <span class="o">*</span><span class="n">jme</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="n">u32</span> <span class="n">reg</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">len</span> <span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">)</span>
		<span class="n">p</span><span class="p">[</span><span class="n">i</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">jread32</span><span class="p">(</span><span class="n">jme</span><span class="p">,</span> <span class="n">reg</span> <span class="o">+</span> <span class="n">i</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">mdio_memcpy</span><span class="p">(</span><span class="k">struct</span> <span class="n">jme_adapter</span> <span class="o">*</span><span class="n">jme</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reg_nr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u16</span> <span class="o">*</span><span class="n">p16</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span> <span class="o">*</span><span class="p">)</span><span class="n">p</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">reg_nr</span> <span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
		<span class="n">p16</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">jme_mdio_read</span><span class="p">(</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">jme</span><span class="o">-&gt;</span><span class="n">mii_if</span><span class="p">.</span><span class="n">phy_id</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">jme_get_regs</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ethtool_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">jme_adapter</span> <span class="o">*</span><span class="n">jme</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">p32</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="n">p</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="n">JME_REG_LEN</span><span class="p">);</span>

	<span class="n">regs</span><span class="o">-&gt;</span><span class="n">version</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">mmapio_memcpy</span><span class="p">(</span><span class="n">jme</span><span class="p">,</span> <span class="n">p32</span><span class="p">,</span> <span class="n">JME_MAC</span><span class="p">,</span> <span class="n">JME_MAC_LEN</span><span class="p">);</span>

	<span class="n">p32</span> <span class="o">+=</span> <span class="mh">0x100</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">mmapio_memcpy</span><span class="p">(</span><span class="n">jme</span><span class="p">,</span> <span class="n">p32</span><span class="p">,</span> <span class="n">JME_PHY</span><span class="p">,</span> <span class="n">JME_PHY_LEN</span><span class="p">);</span>

	<span class="n">p32</span> <span class="o">+=</span> <span class="mh">0x100</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">mmapio_memcpy</span><span class="p">(</span><span class="n">jme</span><span class="p">,</span> <span class="n">p32</span><span class="p">,</span> <span class="n">JME_MISC</span><span class="p">,</span> <span class="n">JME_MISC_LEN</span><span class="p">);</span>

	<span class="n">p32</span> <span class="o">+=</span> <span class="mh">0x100</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">mmapio_memcpy</span><span class="p">(</span><span class="n">jme</span><span class="p">,</span> <span class="n">p32</span><span class="p">,</span> <span class="n">JME_RSS</span><span class="p">,</span> <span class="n">JME_RSS_LEN</span><span class="p">);</span>

	<span class="n">p32</span> <span class="o">+=</span> <span class="mh">0x100</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">mdio_memcpy</span><span class="p">(</span><span class="n">jme</span><span class="p">,</span> <span class="n">p32</span><span class="p">,</span> <span class="n">JME_PHY_REG_NR</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">jme_get_coalesce</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ethtool_coalesce</span> <span class="o">*</span><span class="n">ecmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">jme_adapter</span> <span class="o">*</span><span class="n">jme</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>

	<span class="n">ecmd</span><span class="o">-&gt;</span><span class="n">tx_coalesce_usecs</span> <span class="o">=</span> <span class="n">PCC_TX_TO</span><span class="p">;</span>
	<span class="n">ecmd</span><span class="o">-&gt;</span><span class="n">tx_max_coalesced_frames</span> <span class="o">=</span> <span class="n">PCC_TX_CNT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">JME_FLAG_POLL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ecmd</span><span class="o">-&gt;</span><span class="n">use_adaptive_rx_coalesce</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">ecmd</span><span class="o">-&gt;</span><span class="n">rx_coalesce_usecs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ecmd</span><span class="o">-&gt;</span><span class="n">rx_max_coalesced_frames</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ecmd</span><span class="o">-&gt;</span><span class="n">use_adaptive_rx_coalesce</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">dpi</span><span class="p">.</span><span class="n">cur</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PCC_P1</span>:
		<span class="n">ecmd</span><span class="o">-&gt;</span><span class="n">rx_coalesce_usecs</span> <span class="o">=</span> <span class="n">PCC_P1_TO</span><span class="p">;</span>
		<span class="n">ecmd</span><span class="o">-&gt;</span><span class="n">rx_max_coalesced_frames</span> <span class="o">=</span> <span class="n">PCC_P1_CNT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PCC_P2</span>:
		<span class="n">ecmd</span><span class="o">-&gt;</span><span class="n">rx_coalesce_usecs</span> <span class="o">=</span> <span class="n">PCC_P2_TO</span><span class="p">;</span>
		<span class="n">ecmd</span><span class="o">-&gt;</span><span class="n">rx_max_coalesced_frames</span> <span class="o">=</span> <span class="n">PCC_P2_CNT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PCC_P3</span>:
		<span class="n">ecmd</span><span class="o">-&gt;</span><span class="n">rx_coalesce_usecs</span> <span class="o">=</span> <span class="n">PCC_P3_TO</span><span class="p">;</span>
		<span class="n">ecmd</span><span class="o">-&gt;</span><span class="n">rx_max_coalesced_frames</span> <span class="o">=</span> <span class="n">PCC_P3_CNT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">jme_set_coalesce</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ethtool_coalesce</span> <span class="o">*</span><span class="n">ecmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">jme_adapter</span> <span class="o">*</span><span class="n">jme</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">dynpcc_info</span> <span class="o">*</span><span class="n">dpi</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">dpi</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">netif_running</span><span class="p">(</span><span class="n">netdev</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ecmd</span><span class="o">-&gt;</span><span class="n">use_adaptive_rx_coalesce</span> <span class="o">&amp;&amp;</span>
	    <span class="n">test_bit</span><span class="p">(</span><span class="n">JME_FLAG_POLL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">JME_FLAG_POLL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">jme</span><span class="o">-&gt;</span><span class="n">jme_rx</span> <span class="o">=</span> <span class="n">netif_rx</span><span class="p">;</span>
		<span class="n">dpi</span><span class="o">-&gt;</span><span class="n">cur</span>		<span class="o">=</span> <span class="n">PCC_P1</span><span class="p">;</span>
		<span class="n">dpi</span><span class="o">-&gt;</span><span class="n">attempt</span>		<span class="o">=</span> <span class="n">PCC_P1</span><span class="p">;</span>
		<span class="n">dpi</span><span class="o">-&gt;</span><span class="n">cnt</span>		<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">jme_set_rx_pcc</span><span class="p">(</span><span class="n">jme</span><span class="p">,</span> <span class="n">PCC_P1</span><span class="p">);</span>
		<span class="n">jme_interrupt_mode</span><span class="p">(</span><span class="n">jme</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ecmd</span><span class="o">-&gt;</span><span class="n">use_adaptive_rx_coalesce</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		   <span class="o">!</span><span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">JME_FLAG_POLL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">JME_FLAG_POLL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">jme</span><span class="o">-&gt;</span><span class="n">jme_rx</span> <span class="o">=</span> <span class="n">netif_receive_skb</span><span class="p">;</span>
		<span class="n">jme_interrupt_mode</span><span class="p">(</span><span class="n">jme</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">jme_get_pauseparam</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">ethtool_pauseparam</span> <span class="o">*</span><span class="n">ecmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">jme_adapter</span> <span class="o">*</span><span class="n">jme</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">ecmd</span><span class="o">-&gt;</span><span class="n">tx_pause</span> <span class="o">=</span> <span class="p">(</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">reg_txpfc</span> <span class="o">&amp;</span> <span class="n">TXPFC_PF_EN</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ecmd</span><span class="o">-&gt;</span><span class="n">rx_pause</span> <span class="o">=</span> <span class="p">(</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">reg_rxmcs</span> <span class="o">&amp;</span> <span class="n">RXMCS_FLOWCTRL</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">phy_lock</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">jme_mdio_read</span><span class="p">(</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">jme</span><span class="o">-&gt;</span><span class="n">mii_if</span><span class="p">.</span><span class="n">phy_id</span><span class="p">,</span> <span class="n">MII_ADVERTISE</span><span class="p">);</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">phy_lock</span><span class="p">);</span>

	<span class="n">ecmd</span><span class="o">-&gt;</span><span class="n">autoneg</span> <span class="o">=</span>
		<span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ADVERTISE_PAUSE_CAP</span> <span class="o">|</span> <span class="n">ADVERTISE_PAUSE_ASYM</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">jme_set_pauseparam</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">ethtool_pauseparam</span> <span class="o">*</span><span class="n">ecmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">jme_adapter</span> <span class="o">*</span><span class="n">jme</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(((</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">reg_txpfc</span> <span class="o">&amp;</span> <span class="n">TXPFC_PF_EN</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">^</span>
		<span class="p">(</span><span class="n">ecmd</span><span class="o">-&gt;</span><span class="n">tx_pause</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ecmd</span><span class="o">-&gt;</span><span class="n">tx_pause</span><span class="p">)</span>
			<span class="n">jme</span><span class="o">-&gt;</span><span class="n">reg_txpfc</span> <span class="o">|=</span> <span class="n">TXPFC_PF_EN</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">jme</span><span class="o">-&gt;</span><span class="n">reg_txpfc</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">TXPFC_PF_EN</span><span class="p">;</span>

		<span class="n">jwrite32</span><span class="p">(</span><span class="n">jme</span><span class="p">,</span> <span class="n">JME_TXPFC</span><span class="p">,</span> <span class="n">jme</span><span class="o">-&gt;</span><span class="n">reg_txpfc</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">rxmcs_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(((</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">reg_rxmcs</span> <span class="o">&amp;</span> <span class="n">RXMCS_FLOWCTRL</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">^</span>
		<span class="p">(</span><span class="n">ecmd</span><span class="o">-&gt;</span><span class="n">rx_pause</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ecmd</span><span class="o">-&gt;</span><span class="n">rx_pause</span><span class="p">)</span>
			<span class="n">jme</span><span class="o">-&gt;</span><span class="n">reg_rxmcs</span> <span class="o">|=</span> <span class="n">RXMCS_FLOWCTRL</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">jme</span><span class="o">-&gt;</span><span class="n">reg_rxmcs</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">RXMCS_FLOWCTRL</span><span class="p">;</span>

		<span class="n">jwrite32</span><span class="p">(</span><span class="n">jme</span><span class="p">,</span> <span class="n">JME_RXMCS</span><span class="p">,</span> <span class="n">jme</span><span class="o">-&gt;</span><span class="n">reg_rxmcs</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">rxmcs_lock</span><span class="p">);</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">phy_lock</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">jme_mdio_read</span><span class="p">(</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">jme</span><span class="o">-&gt;</span><span class="n">mii_if</span><span class="p">.</span><span class="n">phy_id</span><span class="p">,</span> <span class="n">MII_ADVERTISE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(((</span><span class="n">val</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ADVERTISE_PAUSE_CAP</span> <span class="o">|</span> <span class="n">ADVERTISE_PAUSE_ASYM</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">^</span>
		<span class="p">(</span><span class="n">ecmd</span><span class="o">-&gt;</span><span class="n">autoneg</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ecmd</span><span class="o">-&gt;</span><span class="n">autoneg</span><span class="p">)</span>
			<span class="n">val</span> <span class="o">|=</span> <span class="p">(</span><span class="n">ADVERTISE_PAUSE_CAP</span> <span class="o">|</span> <span class="n">ADVERTISE_PAUSE_ASYM</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">ADVERTISE_PAUSE_CAP</span> <span class="o">|</span> <span class="n">ADVERTISE_PAUSE_ASYM</span><span class="p">);</span>

		<span class="n">jme_mdio_write</span><span class="p">(</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">jme</span><span class="o">-&gt;</span><span class="n">mii_if</span><span class="p">.</span><span class="n">phy_id</span><span class="p">,</span>
				<span class="n">MII_ADVERTISE</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">phy_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">jme_get_wol</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">ethtool_wolinfo</span> <span class="o">*</span><span class="n">wol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">jme_adapter</span> <span class="o">*</span><span class="n">jme</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>

	<span class="n">wol</span><span class="o">-&gt;</span><span class="n">supported</span> <span class="o">=</span> <span class="n">WAKE_MAGIC</span> <span class="o">|</span> <span class="n">WAKE_PHY</span><span class="p">;</span>

	<span class="n">wol</span><span class="o">-&gt;</span><span class="n">wolopts</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">reg_pmcs</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">PMCS_LFEN</span> <span class="o">|</span> <span class="n">PMCS_LREN</span><span class="p">))</span>
		<span class="n">wol</span><span class="o">-&gt;</span><span class="n">wolopts</span> <span class="o">|=</span> <span class="n">WAKE_PHY</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">reg_pmcs</span> <span class="o">&amp;</span> <span class="n">PMCS_MFEN</span><span class="p">)</span>
		<span class="n">wol</span><span class="o">-&gt;</span><span class="n">wolopts</span> <span class="o">|=</span> <span class="n">WAKE_MAGIC</span><span class="p">;</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">jme_set_wol</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">ethtool_wolinfo</span> <span class="o">*</span><span class="n">wol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">jme_adapter</span> <span class="o">*</span><span class="n">jme</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wol</span><span class="o">-&gt;</span><span class="n">wolopts</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">WAKE_MAGICSECURE</span> <span class="o">|</span>
				<span class="n">WAKE_UCAST</span> <span class="o">|</span>
				<span class="n">WAKE_MCAST</span> <span class="o">|</span>
				<span class="n">WAKE_BCAST</span> <span class="o">|</span>
				<span class="n">WAKE_ARP</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>

	<span class="n">jme</span><span class="o">-&gt;</span><span class="n">reg_pmcs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wol</span><span class="o">-&gt;</span><span class="n">wolopts</span> <span class="o">&amp;</span> <span class="n">WAKE_PHY</span><span class="p">)</span>
		<span class="n">jme</span><span class="o">-&gt;</span><span class="n">reg_pmcs</span> <span class="o">|=</span> <span class="n">PMCS_LFEN</span> <span class="o">|</span> <span class="n">PMCS_LREN</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wol</span><span class="o">-&gt;</span><span class="n">wolopts</span> <span class="o">&amp;</span> <span class="n">WAKE_MAGIC</span><span class="p">)</span>
		<span class="n">jme</span><span class="o">-&gt;</span><span class="n">reg_pmcs</span> <span class="o">|=</span> <span class="n">PMCS_MFEN</span><span class="p">;</span>

	<span class="n">jwrite32</span><span class="p">(</span><span class="n">jme</span><span class="p">,</span> <span class="n">JME_PMCS</span><span class="p">,</span> <span class="n">jme</span><span class="o">-&gt;</span><span class="n">reg_pmcs</span><span class="p">);</span>
	<span class="n">device_set_wakeup_enable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">!!</span><span class="p">(</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">reg_pmcs</span><span class="p">));</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">jme_get_settings</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span>
		     <span class="k">struct</span> <span class="n">ethtool_cmd</span> <span class="o">*</span><span class="n">ecmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">jme_adapter</span> <span class="o">*</span><span class="n">jme</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">phy_lock</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">mii_ethtool_gset</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">mii_if</span><span class="p">),</span> <span class="n">ecmd</span><span class="p">);</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">phy_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">jme_set_settings</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span>
		     <span class="k">struct</span> <span class="n">ethtool_cmd</span> <span class="o">*</span><span class="n">ecmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">jme_adapter</span> <span class="o">*</span><span class="n">jme</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">,</span> <span class="n">fdc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ethtool_cmd_speed</span><span class="p">(</span><span class="n">ecmd</span><span class="p">)</span> <span class="o">==</span> <span class="n">SPEED_1000</span>
	    <span class="o">&amp;&amp;</span> <span class="n">ecmd</span><span class="o">-&gt;</span><span class="n">autoneg</span> <span class="o">!=</span> <span class="n">AUTONEG_ENABLE</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Check If user changed duplex only while force_media.</span>
<span class="cm">	 * Hardware would not generate link change interrupt.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">mii_if</span><span class="p">.</span><span class="n">force_media</span> <span class="o">&amp;&amp;</span>
	<span class="n">ecmd</span><span class="o">-&gt;</span><span class="n">autoneg</span> <span class="o">!=</span> <span class="n">AUTONEG_ENABLE</span> <span class="o">&amp;&amp;</span>
	<span class="p">(</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">mii_if</span><span class="p">.</span><span class="n">full_duplex</span> <span class="o">!=</span> <span class="n">ecmd</span><span class="o">-&gt;</span><span class="n">duplex</span><span class="p">))</span>
		<span class="n">fdc</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">phy_lock</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">mii_ethtool_sset</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">mii_if</span><span class="p">),</span> <span class="n">ecmd</span><span class="p">);</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">phy_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fdc</span><span class="p">)</span>
			<span class="n">jme_reset_link</span><span class="p">(</span><span class="n">jme</span><span class="p">);</span>
		<span class="n">jme</span><span class="o">-&gt;</span><span class="n">old_ecmd</span> <span class="o">=</span> <span class="o">*</span><span class="n">ecmd</span><span class="p">;</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">JME_FLAG_SSET</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">jme_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ifreq</span> <span class="o">*</span><span class="n">rq</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">jme_adapter</span> <span class="o">*</span><span class="n">jme</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">mii_ioctl_data</span> <span class="o">*</span><span class="n">mii_data</span> <span class="o">=</span> <span class="n">if_mii</span><span class="p">(</span><span class="n">rq</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">duplex_chg</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">SIOCSMIIREG</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u16</span> <span class="n">val</span> <span class="o">=</span> <span class="n">mii_data</span><span class="o">-&gt;</span><span class="n">val_in</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">BMCR_RESET</span><span class="o">|</span><span class="n">BMCR_ANENABLE</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">BMCR_SPEED1000</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">phy_lock</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">generic_mii_ioctl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">mii_if</span><span class="p">,</span> <span class="n">mii_data</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">duplex_chg</span><span class="p">);</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">phy_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rc</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">SIOCSMIIREG</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">duplex_chg</span><span class="p">)</span>
			<span class="n">jme_reset_link</span><span class="p">(</span><span class="n">jme</span><span class="p">);</span>
		<span class="n">jme_get_settings</span><span class="p">(</span><span class="n">netdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">old_ecmd</span><span class="p">);</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">JME_FLAG_SSET</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span>
<span class="nf">jme_get_link</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">jme_adapter</span> <span class="o">*</span><span class="n">jme</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">jread32</span><span class="p">(</span><span class="n">jme</span><span class="p">,</span> <span class="n">JME_PHY_LINK</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">PHY_LINK_UP</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span>
<span class="nf">jme_get_msglevel</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">jme_adapter</span> <span class="o">*</span><span class="n">jme</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">jme</span><span class="o">-&gt;</span><span class="n">msg_enable</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">jme_set_msglevel</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">jme_adapter</span> <span class="o">*</span><span class="n">jme</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="n">jme</span><span class="o">-&gt;</span><span class="n">msg_enable</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">netdev_features_t</span>
<span class="nf">jme_fix_features</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span> <span class="n">netdev_features_t</span> <span class="n">features</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">mtu</span> <span class="o">&gt;</span> <span class="mi">1900</span><span class="p">)</span>
		<span class="n">features</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">NETIF_F_ALL_TSO</span> <span class="o">|</span> <span class="n">NETIF_F_ALL_CSUM</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">features</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">jme_set_features</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span> <span class="n">netdev_features_t</span> <span class="n">features</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">jme_adapter</span> <span class="o">*</span><span class="n">jme</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">rxmcs_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">NETIF_F_RXCSUM</span><span class="p">)</span>
		<span class="n">jme</span><span class="o">-&gt;</span><span class="n">reg_rxmcs</span> <span class="o">|=</span> <span class="n">RXMCS_CHECKSUM</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">jme</span><span class="o">-&gt;</span><span class="n">reg_rxmcs</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">RXMCS_CHECKSUM</span><span class="p">;</span>
	<span class="n">jwrite32</span><span class="p">(</span><span class="n">jme</span><span class="p">,</span> <span class="n">JME_RXMCS</span><span class="p">,</span> <span class="n">jme</span><span class="o">-&gt;</span><span class="n">reg_rxmcs</span><span class="p">);</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">rxmcs_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">jme_nway_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">jme_adapter</span> <span class="o">*</span><span class="n">jme</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="n">jme_restart_an</span><span class="p">(</span><span class="n">jme</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u8</span>
<span class="nf">jme_smb_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">jme_adapter</span> <span class="o">*</span><span class="n">jme</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">to</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">jread32</span><span class="p">(</span><span class="n">jme</span><span class="p">,</span> <span class="n">JME_SMBCSR</span><span class="p">);</span>
	<span class="n">to</span> <span class="o">=</span> <span class="n">JME_SMB_BUSY_TIMEOUT</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">SMBCSR_BUSY</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">--</span><span class="n">to</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">jread32</span><span class="p">(</span><span class="n">jme</span><span class="p">,</span> <span class="n">JME_SMBCSR</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">to</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netif_err</span><span class="p">(</span><span class="n">jme</span><span class="p">,</span> <span class="n">hw</span><span class="p">,</span> <span class="n">jme</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;SMB Bus Busy</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mh">0xFF</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">jwrite32</span><span class="p">(</span><span class="n">jme</span><span class="p">,</span> <span class="n">JME_SMBINTF</span><span class="p">,</span>
		<span class="p">((</span><span class="n">addr</span> <span class="o">&lt;&lt;</span> <span class="n">SMBINTF_HWADDR_SHIFT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">SMBINTF_HWADDR</span><span class="p">)</span> <span class="o">|</span>
		<span class="n">SMBINTF_HWRWN_READ</span> <span class="o">|</span>
		<span class="n">SMBINTF_HWCMD</span><span class="p">);</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">jread32</span><span class="p">(</span><span class="n">jme</span><span class="p">,</span> <span class="n">JME_SMBINTF</span><span class="p">);</span>
	<span class="n">to</span> <span class="o">=</span> <span class="n">JME_SMB_BUSY_TIMEOUT</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">SMBINTF_HWCMD</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">--</span><span class="n">to</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">jread32</span><span class="p">(</span><span class="n">jme</span><span class="p">,</span> <span class="n">JME_SMBINTF</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">to</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netif_err</span><span class="p">(</span><span class="n">jme</span><span class="p">,</span> <span class="n">hw</span><span class="p">,</span> <span class="n">jme</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;SMB Bus Busy</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mh">0xFF</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">SMBINTF_HWDATR</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">SMBINTF_HWDATR_SHIFT</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">jme_smb_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">jme_adapter</span> <span class="o">*</span><span class="n">jme</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">addr</span><span class="p">,</span> <span class="n">u8</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">to</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">jread32</span><span class="p">(</span><span class="n">jme</span><span class="p">,</span> <span class="n">JME_SMBCSR</span><span class="p">);</span>
	<span class="n">to</span> <span class="o">=</span> <span class="n">JME_SMB_BUSY_TIMEOUT</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">SMBCSR_BUSY</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">--</span><span class="n">to</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">jread32</span><span class="p">(</span><span class="n">jme</span><span class="p">,</span> <span class="n">JME_SMBCSR</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">to</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netif_err</span><span class="p">(</span><span class="n">jme</span><span class="p">,</span> <span class="n">hw</span><span class="p">,</span> <span class="n">jme</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;SMB Bus Busy</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">jwrite32</span><span class="p">(</span><span class="n">jme</span><span class="p">,</span> <span class="n">JME_SMBINTF</span><span class="p">,</span>
		<span class="p">((</span><span class="n">data</span> <span class="o">&lt;&lt;</span> <span class="n">SMBINTF_HWDATW_SHIFT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">SMBINTF_HWDATW</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">((</span><span class="n">addr</span> <span class="o">&lt;&lt;</span> <span class="n">SMBINTF_HWADDR_SHIFT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">SMBINTF_HWADDR</span><span class="p">)</span> <span class="o">|</span>
		<span class="n">SMBINTF_HWRWN_WRITE</span> <span class="o">|</span>
		<span class="n">SMBINTF_HWCMD</span><span class="p">);</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">jread32</span><span class="p">(</span><span class="n">jme</span><span class="p">,</span> <span class="n">JME_SMBINTF</span><span class="p">);</span>
	<span class="n">to</span> <span class="o">=</span> <span class="n">JME_SMB_BUSY_TIMEOUT</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">SMBINTF_HWCMD</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">--</span><span class="n">to</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">jread32</span><span class="p">(</span><span class="n">jme</span><span class="p">,</span> <span class="n">JME_SMBINTF</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">to</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netif_err</span><span class="p">(</span><span class="n">jme</span><span class="p">,</span> <span class="n">hw</span><span class="p">,</span> <span class="n">jme</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;SMB Bus Busy</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mdelay</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">jme_get_eeprom_len</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">jme_adapter</span> <span class="o">*</span><span class="n">jme</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">jread32</span><span class="p">(</span><span class="n">jme</span><span class="p">,</span> <span class="n">JME_SMBCSR</span><span class="p">);</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">SMBCSR_EEPROMD</span><span class="p">)</span> <span class="o">?</span> <span class="n">JME_SMB_LEN</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">jme_get_eeprom</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">ethtool_eeprom</span> <span class="o">*</span><span class="n">eeprom</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">jme_adapter</span> <span class="o">*</span><span class="n">jme</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">offset</span> <span class="o">=</span> <span class="n">eeprom</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">,</span> <span class="n">len</span> <span class="o">=</span> <span class="n">eeprom</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * ethtool will check the boundary for us</span>
<span class="cm">	 */</span>
	<span class="n">eeprom</span><span class="o">-&gt;</span><span class="n">magic</span> <span class="o">=</span> <span class="n">JME_EEPROM_MAGIC</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">len</span> <span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
		<span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">jme_smb_read</span><span class="p">(</span><span class="n">jme</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="n">offset</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">jme_set_eeprom</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">ethtool_eeprom</span> <span class="o">*</span><span class="n">eeprom</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">jme_adapter</span> <span class="o">*</span><span class="n">jme</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">offset</span> <span class="o">=</span> <span class="n">eeprom</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">,</span> <span class="n">len</span> <span class="o">=</span> <span class="n">eeprom</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">eeprom</span><span class="o">-&gt;</span><span class="n">magic</span> <span class="o">!=</span> <span class="n">JME_EEPROM_MAGIC</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * ethtool will check the boundary for us</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">len</span> <span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
		<span class="n">jme_smb_write</span><span class="p">(</span><span class="n">jme</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="n">offset</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ethtool_ops</span> <span class="n">jme_ethtool_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">get_drvinfo</span>            <span class="o">=</span> <span class="n">jme_get_drvinfo</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_regs_len</span>		<span class="o">=</span> <span class="n">jme_get_regs_len</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_regs</span>		<span class="o">=</span> <span class="n">jme_get_regs</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_coalesce</span>		<span class="o">=</span> <span class="n">jme_get_coalesce</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_coalesce</span>		<span class="o">=</span> <span class="n">jme_set_coalesce</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_pauseparam</span>		<span class="o">=</span> <span class="n">jme_get_pauseparam</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_pauseparam</span>		<span class="o">=</span> <span class="n">jme_set_pauseparam</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_wol</span>		<span class="o">=</span> <span class="n">jme_get_wol</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_wol</span>		<span class="o">=</span> <span class="n">jme_set_wol</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_settings</span>		<span class="o">=</span> <span class="n">jme_get_settings</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_settings</span>		<span class="o">=</span> <span class="n">jme_set_settings</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_link</span>		<span class="o">=</span> <span class="n">jme_get_link</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_msglevel</span>           <span class="o">=</span> <span class="n">jme_get_msglevel</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_msglevel</span>           <span class="o">=</span> <span class="n">jme_set_msglevel</span><span class="p">,</span>
	<span class="p">.</span><span class="n">nway_reset</span>             <span class="o">=</span> <span class="n">jme_nway_reset</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_eeprom_len</span>		<span class="o">=</span> <span class="n">jme_get_eeprom_len</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_eeprom</span>		<span class="o">=</span> <span class="n">jme_get_eeprom</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_eeprom</span>		<span class="o">=</span> <span class="n">jme_set_eeprom</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">jme_pci_dma64</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="n">PCI_DEVICE_ID_JMICRON_JMC250</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">pci_set_dma_mask</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">64</span><span class="p">)))</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pci_set_consistent_dma_mask</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">64</span><span class="p">)))</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="n">PCI_DEVICE_ID_JMICRON_JMC250</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">pci_set_dma_mask</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">40</span><span class="p">)))</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pci_set_consistent_dma_mask</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">40</span><span class="p">)))</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pci_set_dma_mask</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">32</span><span class="p">)))</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pci_set_consistent_dma_mask</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">32</span><span class="p">)))</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">jme_phy_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">jme_adapter</span> <span class="o">*</span><span class="n">jme</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">reg26</span><span class="p">;</span>

	<span class="n">reg26</span> <span class="o">=</span> <span class="n">jme_mdio_read</span><span class="p">(</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">jme</span><span class="o">-&gt;</span><span class="n">mii_if</span><span class="p">.</span><span class="n">phy_id</span><span class="p">,</span> <span class="mi">26</span><span class="p">);</span>
	<span class="n">jme_mdio_write</span><span class="p">(</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">jme</span><span class="o">-&gt;</span><span class="n">mii_if</span><span class="p">.</span><span class="n">phy_id</span><span class="p">,</span> <span class="mi">26</span><span class="p">,</span> <span class="n">reg26</span> <span class="o">|</span> <span class="mh">0x1000</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">jme_check_hw_ver</span><span class="p">(</span><span class="k">struct</span> <span class="n">jme_adapter</span> <span class="o">*</span><span class="n">jme</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">chipmode</span><span class="p">;</span>

	<span class="n">chipmode</span> <span class="o">=</span> <span class="n">jread32</span><span class="p">(</span><span class="n">jme</span><span class="p">,</span> <span class="n">JME_CHIPMODE</span><span class="p">);</span>

	<span class="n">jme</span><span class="o">-&gt;</span><span class="n">fpgaver</span> <span class="o">=</span> <span class="p">(</span><span class="n">chipmode</span> <span class="o">&amp;</span> <span class="n">CM_FPGAVER_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">CM_FPGAVER_SHIFT</span><span class="p">;</span>
	<span class="n">jme</span><span class="o">-&gt;</span><span class="n">chiprev</span> <span class="o">=</span> <span class="p">(</span><span class="n">chipmode</span> <span class="o">&amp;</span> <span class="n">CM_CHIPREV_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">CM_CHIPREV_SHIFT</span><span class="p">;</span>
	<span class="n">jme</span><span class="o">-&gt;</span><span class="n">chip_main_rev</span> <span class="o">=</span> <span class="n">jme</span><span class="o">-&gt;</span><span class="n">chiprev</span> <span class="o">&amp;</span> <span class="mh">0xF</span><span class="p">;</span>
	<span class="n">jme</span><span class="o">-&gt;</span><span class="n">chip_sub_rev</span> <span class="o">=</span> <span class="p">(</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">chiprev</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xF</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">net_device_ops</span> <span class="n">jme_netdev_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">ndo_open</span>		<span class="o">=</span> <span class="n">jme_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_stop</span>		<span class="o">=</span> <span class="n">jme_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_validate_addr</span>	<span class="o">=</span> <span class="n">eth_validate_addr</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_do_ioctl</span>		<span class="o">=</span> <span class="n">jme_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_start_xmit</span>		<span class="o">=</span> <span class="n">jme_start_xmit</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_set_mac_address</span>	<span class="o">=</span> <span class="n">jme_set_macaddr</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_set_rx_mode</span>	<span class="o">=</span> <span class="n">jme_set_multi</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_change_mtu</span>		<span class="o">=</span> <span class="n">jme_change_mtu</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_tx_timeout</span>		<span class="o">=</span> <span class="n">jme_tx_timeout</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_fix_features</span>       <span class="o">=</span> <span class="n">jme_fix_features</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_set_features</span>       <span class="o">=</span> <span class="n">jme_set_features</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span>
<span class="nf">jme_init_one</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span>
	     <span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="o">*</span><span class="n">ent</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">using_dac</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">jme_adapter</span> <span class="o">*</span><span class="n">jme</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">bmcr</span><span class="p">,</span> <span class="n">bmsr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">apmc</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * set up PCI device basics</span>
<span class="cm">	 */</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">pci_enable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Cannot enable PCI device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">using_dac</span> <span class="o">=</span> <span class="n">jme_pci_dma64</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">using_dac</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Cannot set PCI DMA Mask</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_out_disable_pdev</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">pci_resource_flags</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">IORESOURCE_MEM</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;No PCI resource region found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_out_disable_pdev</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">pci_request_regions</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">DRV_NAME</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Cannot obtain PCI resource region</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_out_disable_pdev</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pci_set_master</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * alloc and init net device</span>
<span class="cm">	 */</span>
	<span class="n">netdev</span> <span class="o">=</span> <span class="n">alloc_etherdev</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">jme</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">netdev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_out_release_regions</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">netdev_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">jme_netdev_ops</span><span class="p">;</span>
	<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">ethtool_ops</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">jme_ethtool_ops</span><span class="p">;</span>
	<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">watchdog_timeo</span>		<span class="o">=</span> <span class="n">TX_TIMEOUT</span><span class="p">;</span>
	<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">hw_features</span>		<span class="o">=</span>	<span class="n">NETIF_F_IP_CSUM</span> <span class="o">|</span>
						<span class="n">NETIF_F_IPV6_CSUM</span> <span class="o">|</span>
						<span class="n">NETIF_F_SG</span> <span class="o">|</span>
						<span class="n">NETIF_F_TSO</span> <span class="o">|</span>
						<span class="n">NETIF_F_TSO6</span> <span class="o">|</span>
						<span class="n">NETIF_F_RXCSUM</span><span class="p">;</span>
	<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">features</span>		<span class="o">=</span>	<span class="n">NETIF_F_IP_CSUM</span> <span class="o">|</span>
						<span class="n">NETIF_F_IPV6_CSUM</span> <span class="o">|</span>
						<span class="n">NETIF_F_SG</span> <span class="o">|</span>
						<span class="n">NETIF_F_TSO</span> <span class="o">|</span>
						<span class="n">NETIF_F_TSO6</span> <span class="o">|</span>
						<span class="n">NETIF_F_HW_VLAN_TX</span> <span class="o">|</span>
						<span class="n">NETIF_F_HW_VLAN_RX</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">using_dac</span><span class="p">)</span>
		<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">features</span>	<span class="o">|=</span>	<span class="n">NETIF_F_HIGHDMA</span><span class="p">;</span>

	<span class="n">SET_NETDEV_DEV</span><span class="p">(</span><span class="n">netdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">netdev</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * init adapter info</span>
<span class="cm">	 */</span>
	<span class="n">jme</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="n">jme</span><span class="o">-&gt;</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">pdev</span><span class="p">;</span>
	<span class="n">jme</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">netdev</span><span class="p">;</span>
	<span class="n">jme</span><span class="o">-&gt;</span><span class="n">jme_rx</span> <span class="o">=</span> <span class="n">netif_rx</span><span class="p">;</span>
	<span class="n">jme</span><span class="o">-&gt;</span><span class="n">old_mtu</span> <span class="o">=</span> <span class="n">netdev</span><span class="o">-&gt;</span><span class="n">mtu</span> <span class="o">=</span> <span class="mi">1500</span><span class="p">;</span>
	<span class="n">jme</span><span class="o">-&gt;</span><span class="n">phylink</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">jme</span><span class="o">-&gt;</span><span class="n">tx_ring_size</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">;</span>
	<span class="n">jme</span><span class="o">-&gt;</span><span class="n">tx_ring_mask</span> <span class="o">=</span> <span class="n">jme</span><span class="o">-&gt;</span><span class="n">tx_ring_size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">jme</span><span class="o">-&gt;</span><span class="n">tx_wake_threshold</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">9</span><span class="p">;</span>
	<span class="n">jme</span><span class="o">-&gt;</span><span class="n">rx_ring_size</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">9</span><span class="p">;</span>
	<span class="n">jme</span><span class="o">-&gt;</span><span class="n">rx_ring_mask</span> <span class="o">=</span> <span class="n">jme</span><span class="o">-&gt;</span><span class="n">rx_ring_size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">jme</span><span class="o">-&gt;</span><span class="n">msg_enable</span> <span class="o">=</span> <span class="n">JME_DEF_MSG_ENABLE</span><span class="p">;</span>
	<span class="n">jme</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">pci_resource_start</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
			     <span class="n">pci_resource_len</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Mapping PCI resource region error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_out_free_netdev</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">no_pseudohp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">apmc</span> <span class="o">=</span> <span class="n">jread32</span><span class="p">(</span><span class="n">jme</span><span class="p">,</span> <span class="n">JME_APMC</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">JME_APMC_PSEUDO_HP_EN</span><span class="p">;</span>
		<span class="n">jwrite32</span><span class="p">(</span><span class="n">jme</span><span class="p">,</span> <span class="n">JME_APMC</span><span class="p">,</span> <span class="n">apmc</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">force_pseudohp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">apmc</span> <span class="o">=</span> <span class="n">jread32</span><span class="p">(</span><span class="n">jme</span><span class="p">,</span> <span class="n">JME_APMC</span><span class="p">)</span> <span class="o">|</span> <span class="n">JME_APMC_PSEUDO_HP_EN</span><span class="p">;</span>
		<span class="n">jwrite32</span><span class="p">(</span><span class="n">jme</span><span class="p">,</span> <span class="n">JME_APMC</span><span class="p">,</span> <span class="n">apmc</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">NETIF_NAPI_SET</span><span class="p">(</span><span class="n">netdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">,</span> <span class="n">jme_poll</span><span class="p">,</span> <span class="n">jme</span><span class="o">-&gt;</span><span class="n">rx_ring_size</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">)</span>

	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">phy_lock</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">macaddr_lock</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">rxmcs_lock</span><span class="p">);</span>

	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">link_changing</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">rx_cleaning</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">tx_cleaning</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">rx_empty</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">tasklet_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">pcc_task</span><span class="p">,</span>
		     <span class="n">jme_pcc_tasklet</span><span class="p">,</span>
		     <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">jme</span><span class="p">);</span>
	<span class="n">tasklet_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">linkch_task</span><span class="p">,</span>
		     <span class="n">jme_link_change_tasklet</span><span class="p">,</span>
		     <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">jme</span><span class="p">);</span>
	<span class="n">tasklet_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">txclean_task</span><span class="p">,</span>
		     <span class="n">jme_tx_clean_tasklet</span><span class="p">,</span>
		     <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">jme</span><span class="p">);</span>
	<span class="n">tasklet_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">rxclean_task</span><span class="p">,</span>
		     <span class="n">jme_rx_clean_tasklet</span><span class="p">,</span>
		     <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">jme</span><span class="p">);</span>
	<span class="n">tasklet_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">rxempty_task</span><span class="p">,</span>
		     <span class="n">jme_rx_empty_tasklet</span><span class="p">,</span>
		     <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">jme</span><span class="p">);</span>
	<span class="n">tasklet_disable_nosync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">linkch_task</span><span class="p">);</span>
	<span class="n">tasklet_disable_nosync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">txclean_task</span><span class="p">);</span>
	<span class="n">tasklet_disable_nosync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">rxclean_task</span><span class="p">);</span>
	<span class="n">tasklet_disable_nosync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">rxempty_task</span><span class="p">);</span>
	<span class="n">jme</span><span class="o">-&gt;</span><span class="n">dpi</span><span class="p">.</span><span class="n">cur</span> <span class="o">=</span> <span class="n">PCC_P1</span><span class="p">;</span>

	<span class="n">jme</span><span class="o">-&gt;</span><span class="n">reg_ghc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">jme</span><span class="o">-&gt;</span><span class="n">reg_rxcs</span> <span class="o">=</span> <span class="n">RXCS_DEFAULT</span><span class="p">;</span>
	<span class="n">jme</span><span class="o">-&gt;</span><span class="n">reg_rxmcs</span> <span class="o">=</span> <span class="n">RXMCS_DEFAULT</span><span class="p">;</span>
	<span class="n">jme</span><span class="o">-&gt;</span><span class="n">reg_txpfc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">jme</span><span class="o">-&gt;</span><span class="n">reg_pmcs</span> <span class="o">=</span> <span class="n">PMCS_MFEN</span><span class="p">;</span>
	<span class="n">jme</span><span class="o">-&gt;</span><span class="n">reg_gpreg1</span> <span class="o">=</span> <span class="n">GPREG1_DEFAULT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">reg_rxmcs</span> <span class="o">&amp;</span> <span class="n">RXMCS_CHECKSUM</span><span class="p">)</span>
		<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">|=</span> <span class="n">NETIF_F_RXCSUM</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Get Max Read Req Size from PCI Config Space</span>
<span class="cm">	 */</span>
	<span class="n">pci_read_config_byte</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_DCSR_MRRS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">mrrs</span><span class="p">);</span>
	<span class="n">jme</span><span class="o">-&gt;</span><span class="n">mrrs</span> <span class="o">&amp;=</span> <span class="n">PCI_DCSR_MRRS_MASK</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">mrrs</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">MRRS_128B</span>:
		<span class="n">jme</span><span class="o">-&gt;</span><span class="n">reg_txcs</span> <span class="o">=</span> <span class="n">TXCS_DEFAULT</span> <span class="o">|</span> <span class="n">TXCS_DMASIZE_128B</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MRRS_256B</span>:
		<span class="n">jme</span><span class="o">-&gt;</span><span class="n">reg_txcs</span> <span class="o">=</span> <span class="n">TXCS_DEFAULT</span> <span class="o">|</span> <span class="n">TXCS_DMASIZE_256B</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">jme</span><span class="o">-&gt;</span><span class="n">reg_txcs</span> <span class="o">=</span> <span class="n">TXCS_DEFAULT</span> <span class="o">|</span> <span class="n">TXCS_DMASIZE_512B</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Must check before reset_mac_processor</span>
<span class="cm">	 */</span>
	<span class="n">jme_check_hw_ver</span><span class="p">(</span><span class="n">jme</span><span class="p">);</span>
	<span class="n">jme</span><span class="o">-&gt;</span><span class="n">mii_if</span><span class="p">.</span><span class="n">dev</span> <span class="o">=</span> <span class="n">netdev</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">fpgaver</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">jme</span><span class="o">-&gt;</span><span class="n">mii_if</span><span class="p">.</span><span class="n">phy_id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span> <span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">32</span> <span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">bmcr</span> <span class="o">=</span> <span class="n">jme_mdio_read</span><span class="p">(</span><span class="n">netdev</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">MII_BMCR</span><span class="p">);</span>
			<span class="n">bmsr</span> <span class="o">=</span> <span class="n">jme_mdio_read</span><span class="p">(</span><span class="n">netdev</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">MII_BMSR</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">bmcr</span> <span class="o">!=</span> <span class="mh">0xFFFFU</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">bmcr</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">bmsr</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">jme</span><span class="o">-&gt;</span><span class="n">mii_if</span><span class="p">.</span><span class="n">phy_id</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">mii_if</span><span class="p">.</span><span class="n">phy_id</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Can not find phy_id</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">err_out_unmap</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">jme</span><span class="o">-&gt;</span><span class="n">reg_ghc</span> <span class="o">|=</span> <span class="n">GHC_LINK_POLL</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">jme</span><span class="o">-&gt;</span><span class="n">mii_if</span><span class="p">.</span><span class="n">phy_id</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="n">PCI_DEVICE_ID_JMICRON_JMC250</span><span class="p">)</span>
		<span class="n">jme</span><span class="o">-&gt;</span><span class="n">mii_if</span><span class="p">.</span><span class="n">supports_gmii</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">jme</span><span class="o">-&gt;</span><span class="n">mii_if</span><span class="p">.</span><span class="n">supports_gmii</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">jme</span><span class="o">-&gt;</span><span class="n">mii_if</span><span class="p">.</span><span class="n">phy_id_mask</span> <span class="o">=</span> <span class="mh">0x1F</span><span class="p">;</span>
	<span class="n">jme</span><span class="o">-&gt;</span><span class="n">mii_if</span><span class="p">.</span><span class="n">reg_num_mask</span> <span class="o">=</span> <span class="mh">0x1F</span><span class="p">;</span>
	<span class="n">jme</span><span class="o">-&gt;</span><span class="n">mii_if</span><span class="p">.</span><span class="n">mdio_read</span> <span class="o">=</span> <span class="n">jme_mdio_read</span><span class="p">;</span>
	<span class="n">jme</span><span class="o">-&gt;</span><span class="n">mii_if</span><span class="p">.</span><span class="n">mdio_write</span> <span class="o">=</span> <span class="n">jme_mdio_write</span><span class="p">;</span>

	<span class="n">jme_clear_pm</span><span class="p">(</span><span class="n">jme</span><span class="p">);</span>
	<span class="n">pci_set_power_state</span><span class="p">(</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_D0</span><span class="p">);</span>
	<span class="n">device_set_wakeup_enable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>

	<span class="n">jme_set_phyfifo_5level</span><span class="p">(</span><span class="n">jme</span><span class="p">);</span>
	<span class="n">jme</span><span class="o">-&gt;</span><span class="n">pcirev</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">revision</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">fpgaver</span><span class="p">)</span>
		<span class="n">jme_phy_init</span><span class="p">(</span><span class="n">jme</span><span class="p">);</span>
	<span class="n">jme_phy_off</span><span class="p">(</span><span class="n">jme</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Reset MAC processor and reload EEPROM for MAC Address</span>
<span class="cm">	 */</span>
	<span class="n">jme_reset_mac_processor</span><span class="p">(</span><span class="n">jme</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">jme_reload_eeprom</span><span class="p">(</span><span class="n">jme</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Reload eeprom for reading MAC Address error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_out_unmap</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">jme_load_macaddr</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Tell stack that we are not ready to work until open()</span>
<span class="cm">	 */</span>
	<span class="n">netif_carrier_off</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">register_netdev</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Cannot register net device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_out_unmap</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">netif_info</span><span class="p">(</span><span class="n">jme</span><span class="p">,</span> <span class="n">probe</span><span class="p">,</span> <span class="n">jme</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s%s chiprev:%x pcirev:%x macaddr:%pM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="p">(</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="n">PCI_DEVICE_ID_JMICRON_JMC250</span><span class="p">)</span> <span class="o">?</span>
		   <span class="s">&quot;JMC250 Gigabit Ethernet&quot;</span> <span class="o">:</span>
		   <span class="p">(</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="n">PCI_DEVICE_ID_JMICRON_JMC260</span><span class="p">)</span> <span class="o">?</span>
		   <span class="s">&quot;JMC260 Fast Ethernet&quot;</span> <span class="o">:</span> <span class="s">&quot;Unknown&quot;</span><span class="p">,</span>
		   <span class="p">(</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">fpgaver</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; (FPGA)&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		   <span class="p">(</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">fpgaver</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="n">jme</span><span class="o">-&gt;</span><span class="n">fpgaver</span> <span class="o">:</span> <span class="n">jme</span><span class="o">-&gt;</span><span class="n">chiprev</span><span class="p">,</span>
		   <span class="n">jme</span><span class="o">-&gt;</span><span class="n">pcirev</span><span class="p">,</span> <span class="n">netdev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_out_unmap:</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">);</span>
<span class="nl">err_out_free_netdev:</span>
	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">free_netdev</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
<span class="nl">err_out_release_regions:</span>
	<span class="n">pci_release_regions</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
<span class="nl">err_out_disable_pdev:</span>
	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
<span class="nl">err_out:</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devexit</span>
<span class="nf">jme_remove_one</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">jme_adapter</span> <span class="o">*</span><span class="n">jme</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>

	<span class="n">unregister_netdev</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">);</span>
	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">free_netdev</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="n">pci_release_regions</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">jme_shutdown</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">jme_adapter</span> <span class="o">*</span><span class="n">jme</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>

	<span class="n">jme_powersave_phy</span><span class="p">(</span><span class="n">jme</span><span class="p">);</span>
	<span class="n">pci_pme_active</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_PM_SLEEP</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">jme_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">to_pci_dev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">jme_adapter</span> <span class="o">*</span><span class="n">jme</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">netif_running</span><span class="p">(</span><span class="n">netdev</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">link_changing</span><span class="p">);</span>

	<span class="n">netif_device_detach</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="n">jme_stop_irq</span><span class="p">(</span><span class="n">jme</span><span class="p">);</span>

	<span class="n">tasklet_disable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">txclean_task</span><span class="p">);</span>
	<span class="n">tasklet_disable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">rxclean_task</span><span class="p">);</span>
	<span class="n">tasklet_disable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">rxempty_task</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">netif_carrier_ok</span><span class="p">(</span><span class="n">netdev</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">JME_FLAG_POLL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
			<span class="n">jme_polling_mode</span><span class="p">(</span><span class="n">jme</span><span class="p">);</span>

		<span class="n">jme_stop_pcc_timer</span><span class="p">(</span><span class="n">jme</span><span class="p">);</span>
		<span class="n">jme_disable_rx_engine</span><span class="p">(</span><span class="n">jme</span><span class="p">);</span>
		<span class="n">jme_disable_tx_engine</span><span class="p">(</span><span class="n">jme</span><span class="p">);</span>
		<span class="n">jme_reset_mac_processor</span><span class="p">(</span><span class="n">jme</span><span class="p">);</span>
		<span class="n">jme_free_rx_resources</span><span class="p">(</span><span class="n">jme</span><span class="p">);</span>
		<span class="n">jme_free_tx_resources</span><span class="p">(</span><span class="n">jme</span><span class="p">);</span>
		<span class="n">netif_carrier_off</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
		<span class="n">jme</span><span class="o">-&gt;</span><span class="n">phylink</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">tasklet_enable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">txclean_task</span><span class="p">);</span>
	<span class="n">tasklet_hi_enable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">rxclean_task</span><span class="p">);</span>
	<span class="n">tasklet_hi_enable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">rxempty_task</span><span class="p">);</span>

	<span class="n">jme_powersave_phy</span><span class="p">(</span><span class="n">jme</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">jme_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">to_pci_dev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">jme_adapter</span> <span class="o">*</span><span class="n">jme</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">netif_running</span><span class="p">(</span><span class="n">netdev</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">jme_clear_pm</span><span class="p">(</span><span class="n">jme</span><span class="p">);</span>
	<span class="n">jme_phy_on</span><span class="p">(</span><span class="n">jme</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">JME_FLAG_SSET</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
		<span class="n">jme_set_settings</span><span class="p">(</span><span class="n">netdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">old_ecmd</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">jme_reset_phy_processor</span><span class="p">(</span><span class="n">jme</span><span class="p">);</span>
	<span class="n">jme_phy_calibration</span><span class="p">(</span><span class="n">jme</span><span class="p">);</span>
	<span class="n">jme_phy_setEA</span><span class="p">(</span><span class="n">jme</span><span class="p">);</span>
	<span class="n">jme_start_irq</span><span class="p">(</span><span class="n">jme</span><span class="p">);</span>
	<span class="n">netif_device_attach</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>

	<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">jme</span><span class="o">-&gt;</span><span class="n">link_changing</span><span class="p">);</span>

	<span class="n">jme_reset_link</span><span class="p">(</span><span class="n">jme</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">SIMPLE_DEV_PM_OPS</span><span class="p">(</span><span class="n">jme_pm_ops</span><span class="p">,</span> <span class="n">jme_suspend</span><span class="p">,</span> <span class="n">jme_resume</span><span class="p">);</span>
<span class="cp">#define JME_PM_OPS (&amp;jme_pm_ops)</span>

<span class="cp">#else</span>

<span class="cp">#define JME_PM_OPS NULL</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="n">DEFINE_PCI_DEVICE_TABLE</span><span class="p">(</span><span class="n">jme_pci_tbl</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">JMICRON</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_JMICRON_JMC250</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">JMICRON</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_JMICRON_JMC260</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_driver</span> <span class="n">jme_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>           <span class="o">=</span> <span class="n">DRV_NAME</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span>       <span class="o">=</span> <span class="n">jme_pci_tbl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span>          <span class="o">=</span> <span class="n">jme_init_one</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>         <span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">jme_remove_one</span><span class="p">),</span>
	<span class="p">.</span><span class="n">shutdown</span>       <span class="o">=</span> <span class="n">jme_shutdown</span><span class="p">,</span>
	<span class="p">.</span><span class="n">driver</span><span class="p">.</span><span class="n">pm</span>	<span class="o">=</span> <span class="n">JME_PM_OPS</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span>
<span class="nf">jme_init_module</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;JMicron JMC2XX ethernet driver version %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">DRV_VERSION</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">pci_register_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">jme_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span>
<span class="nf">jme_cleanup_module</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pci_unregister_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">jme_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">jme_init_module</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">jme_cleanup_module</span><span class="p">);</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Guo-Fu Tseng &lt;cooldavid@cooldavid.org&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;JMicron JMC2x0 PCI Express Ethernet driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_VERSION</span><span class="p">(</span><span class="n">DRV_VERSION</span><span class="p">);</span>
<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">jme_pci_tbl</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
