<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › ethernet › microchip › enc28j60.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>enc28j60.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Microchip ENC28J60 ethernet driver (MAC + PHY)</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2007 Eurek srl</span>
<span class="cm"> * Author: Claudio Lanconelli &lt;lanconelli.claudio@eptar.com&gt;</span>
<span class="cm"> * based on enc28j60.c written by David Anders for 2.4 kernel version</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License as published by</span>
<span class="cm"> * the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> * (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> * $Id: enc28j60.c,v 1.22 2007/12/20 10:47:01 claudio Exp $</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/fcntl.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/netdevice.h&gt;</span>
<span class="cp">#include &lt;linux/etherdevice.h&gt;</span>
<span class="cp">#include &lt;linux/ethtool.h&gt;</span>
<span class="cp">#include &lt;linux/tcp.h&gt;</span>
<span class="cp">#include &lt;linux/skbuff.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/spi/spi.h&gt;</span>

<span class="cp">#include &quot;enc28j60_hw.h&quot;</span>

<span class="cp">#define DRV_NAME	&quot;enc28j60&quot;</span>
<span class="cp">#define DRV_VERSION	&quot;1.01&quot;</span>

<span class="cp">#define SPI_OPLEN	1</span>

<span class="cp">#define ENC28J60_MSG_DEFAULT	\</span>
<span class="cp">	(NETIF_MSG_PROBE | NETIF_MSG_IFUP | NETIF_MSG_IFDOWN | NETIF_MSG_LINK)</span>

<span class="cm">/* Buffer size required for the largest SPI transfer (i.e., reading a</span>
<span class="cm"> * frame). */</span>
<span class="cp">#define SPI_TRANSFER_BUF_LEN	(4 + MAX_FRAMELEN)</span>

<span class="cp">#define TX_TIMEOUT	(4 * HZ)</span>

<span class="cm">/* Max TX retries in case of collision as suggested by errata datasheet */</span>
<span class="cp">#define MAX_TX_RETRYCOUNT	16</span>

<span class="k">enum</span> <span class="p">{</span>
	<span class="n">RXFILTER_NORMAL</span><span class="p">,</span>
	<span class="n">RXFILTER_MULTI</span><span class="p">,</span>
	<span class="n">RXFILTER_PROMISC</span>
<span class="p">};</span>

<span class="cm">/* Driver local data */</span>
<span class="k">struct</span> <span class="n">enc28j60_net</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">spi_device</span> <span class="o">*</span><span class="n">spi</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mutex</span> <span class="n">lock</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">tx_skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">work_struct</span> <span class="n">tx_work</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">work_struct</span> <span class="n">irq_work</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">work_struct</span> <span class="n">setrx_work</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">work_struct</span> <span class="n">restart_work</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">bank</span><span class="p">;</span>		<span class="cm">/* current register bank selected */</span>
	<span class="n">u16</span> <span class="n">next_pk_ptr</span><span class="p">;</span>	<span class="cm">/* next packet pointer within FIFO */</span>
	<span class="n">u16</span> <span class="n">max_pk_counter</span><span class="p">;</span>	<span class="cm">/* statistics: max packet counter */</span>
	<span class="n">u16</span> <span class="n">tx_retry_count</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">hw_enable</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">full_duplex</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rxfilter</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">msg_enable</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">spi_transfer_buf</span><span class="p">[</span><span class="n">SPI_TRANSFER_BUF_LEN</span><span class="p">];</span>
<span class="p">};</span>

<span class="cm">/* use ethtool to change the level for any given device */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="p">{</span>
	<span class="n">u32</span> <span class="n">msg_enable</span><span class="p">;</span>
<span class="p">}</span> <span class="n">debug</span> <span class="o">=</span> <span class="p">{</span> <span class="o">-</span><span class="mi">1</span> <span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * SPI read buffer</span>
<span class="cm"> * wait for the SPI transfer and copy received data to destination</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">spi_read_buf</span><span class="p">(</span><span class="k">struct</span> <span class="n">enc28j60_net</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">rx_buf</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">spi_transfer_buf</span> <span class="o">+</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">tx_buf</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">spi_transfer_buf</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">spi_transfer</span> <span class="n">t</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">tx_buf</span> <span class="o">=</span> <span class="n">tx_buf</span><span class="p">,</span>
		<span class="p">.</span><span class="n">rx_buf</span> <span class="o">=</span> <span class="n">rx_buf</span><span class="p">,</span>
		<span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">SPI_OPLEN</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="k">struct</span> <span class="n">spi_message</span> <span class="n">msg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">tx_buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">ENC28J60_READ_BUF_MEM</span><span class="p">;</span>
	<span class="n">tx_buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">tx_buf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">tx_buf</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* don&#39;t care */</span>

	<span class="n">spi_message_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">msg</span><span class="p">);</span>
	<span class="n">spi_message_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">t</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msg</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">spi_sync</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">spi</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msg</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rx_buf</span><span class="p">[</span><span class="n">SPI_OPLEN</span><span class="p">],</span> <span class="n">len</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">msg</span><span class="p">.</span><span class="n">status</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&amp;&amp;</span> <span class="n">netif_msg_drv</span><span class="p">(</span><span class="n">priv</span><span class="p">))</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="n">DRV_NAME</span> <span class="s">&quot;: %s() failed: ret = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * SPI write buffer</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">spi_write_buf</span><span class="p">(</span><span class="k">struct</span> <span class="n">enc28j60_net</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">,</span>
			 <span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">SPI_TRANSFER_BUF_LEN</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">||</span> <span class="n">len</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">spi_transfer_buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">ENC28J60_WRITE_BUF_MEM</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">spi_transfer_buf</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">data</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">spi_write</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">spi</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">spi_transfer_buf</span><span class="p">,</span> <span class="n">len</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&amp;&amp;</span> <span class="n">netif_msg_drv</span><span class="p">(</span><span class="n">priv</span><span class="p">))</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="n">DRV_NAME</span> <span class="s">&quot;: %s() failed: ret = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * basic SPI read operation</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">u8</span> <span class="nf">spi_read_op</span><span class="p">(</span><span class="k">struct</span> <span class="n">enc28j60_net</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="n">u8</span> <span class="n">op</span><span class="p">,</span>
			   <span class="n">u8</span> <span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">tx_buf</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="n">u8</span> <span class="n">rx_buf</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="n">u8</span> <span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">slen</span> <span class="o">=</span> <span class="n">SPI_OPLEN</span><span class="p">;</span>

	<span class="cm">/* do dummy read if needed */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">addr</span> <span class="o">&amp;</span> <span class="n">SPRD_MASK</span><span class="p">)</span>
		<span class="n">slen</span><span class="o">++</span><span class="p">;</span>

	<span class="n">tx_buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">op</span> <span class="o">|</span> <span class="p">(</span><span class="n">addr</span> <span class="o">&amp;</span> <span class="n">ADDR_MASK</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">spi_write_then_read</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">spi</span><span class="p">,</span> <span class="n">tx_buf</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">rx_buf</span><span class="p">,</span> <span class="n">slen</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="n">DRV_NAME</span> <span class="s">&quot;: %s() failed: ret = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">rx_buf</span><span class="p">[</span><span class="n">slen</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>

	<span class="k">return</span> <span class="n">val</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * basic SPI write operation</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">spi_write_op</span><span class="p">(</span><span class="k">struct</span> <span class="n">enc28j60_net</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="n">u8</span> <span class="n">op</span><span class="p">,</span>
			<span class="n">u8</span> <span class="n">addr</span><span class="p">,</span> <span class="n">u8</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">spi_transfer_buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">op</span> <span class="o">|</span> <span class="p">(</span><span class="n">addr</span> <span class="o">&amp;</span> <span class="n">ADDR_MASK</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">spi_transfer_buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">spi_write</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">spi</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">spi_transfer_buf</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&amp;&amp;</span> <span class="n">netif_msg_drv</span><span class="p">(</span><span class="n">priv</span><span class="p">))</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="n">DRV_NAME</span> <span class="s">&quot;: %s() failed: ret = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">enc28j60_soft_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">enc28j60_net</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">netif_msg_hw</span><span class="p">(</span><span class="n">priv</span><span class="p">))</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="n">DRV_NAME</span> <span class="s">&quot;: %s() enter</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">spi_write_op</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">ENC28J60_SOFT_RESET</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ENC28J60_SOFT_RESET</span><span class="p">);</span>
	<span class="cm">/* Errata workaround #1, CLKRDY check is unreliable,</span>
<span class="cm">	 * delay at least 1 mS instead */</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">2000</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * select the current register bank if necessary</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">enc28j60_set_bank</span><span class="p">(</span><span class="k">struct</span> <span class="n">enc28j60_net</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="n">u8</span> <span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">b</span> <span class="o">=</span> <span class="p">(</span><span class="n">addr</span> <span class="o">&amp;</span> <span class="n">BANK_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span><span class="p">;</span>

	<span class="cm">/* These registers (EIE, EIR, ESTAT, ECON2, ECON1)</span>
<span class="cm">	 * are present in all banks, no need to switch bank</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">addr</span> <span class="o">&gt;=</span> <span class="n">EIE</span> <span class="o">&amp;&amp;</span> <span class="n">addr</span> <span class="o">&lt;=</span> <span class="n">ECON1</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* Clear or set each bank selection bit as needed */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">b</span> <span class="o">&amp;</span> <span class="n">ECON1_BSEL0</span><span class="p">)</span> <span class="o">!=</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">bank</span> <span class="o">&amp;</span> <span class="n">ECON1_BSEL0</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">b</span> <span class="o">&amp;</span> <span class="n">ECON1_BSEL0</span><span class="p">)</span>
			<span class="n">spi_write_op</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">ENC28J60_BIT_FIELD_SET</span><span class="p">,</span> <span class="n">ECON1</span><span class="p">,</span>
					<span class="n">ECON1_BSEL0</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">spi_write_op</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">ENC28J60_BIT_FIELD_CLR</span><span class="p">,</span> <span class="n">ECON1</span><span class="p">,</span>
					<span class="n">ECON1_BSEL0</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">b</span> <span class="o">&amp;</span> <span class="n">ECON1_BSEL1</span><span class="p">)</span> <span class="o">!=</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">bank</span> <span class="o">&amp;</span> <span class="n">ECON1_BSEL1</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">b</span> <span class="o">&amp;</span> <span class="n">ECON1_BSEL1</span><span class="p">)</span>
			<span class="n">spi_write_op</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">ENC28J60_BIT_FIELD_SET</span><span class="p">,</span> <span class="n">ECON1</span><span class="p">,</span>
					<span class="n">ECON1_BSEL1</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">spi_write_op</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">ENC28J60_BIT_FIELD_CLR</span><span class="p">,</span> <span class="n">ECON1</span><span class="p">,</span>
					<span class="n">ECON1_BSEL1</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">bank</span> <span class="o">=</span> <span class="n">b</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Register access routines through the SPI bus.</span>
<span class="cm"> * Every register access comes in two flavours:</span>
<span class="cm"> * - nolock_xxx: caller needs to invoke mutex_lock, usually to access</span>
<span class="cm"> *   atomically more than one register</span>
<span class="cm"> * - locked_xxx: caller doesn&#39;t need to invoke mutex_lock, single access</span>
<span class="cm"> *</span>
<span class="cm"> * Some registers can be accessed through the bit field clear and</span>
<span class="cm"> * bit field set to avoid a read modify write cycle.</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * Register bit field Set</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">nolock_reg_bfset</span><span class="p">(</span><span class="k">struct</span> <span class="n">enc28j60_net</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
				      <span class="n">u8</span> <span class="n">addr</span><span class="p">,</span> <span class="n">u8</span> <span class="n">mask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">enc28j60_set_bank</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
	<span class="n">spi_write_op</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">ENC28J60_BIT_FIELD_SET</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">mask</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">locked_reg_bfset</span><span class="p">(</span><span class="k">struct</span> <span class="n">enc28j60_net</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
				      <span class="n">u8</span> <span class="n">addr</span><span class="p">,</span> <span class="n">u8</span> <span class="n">mask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">nolock_reg_bfset</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">mask</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Register bit field Clear</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">nolock_reg_bfclr</span><span class="p">(</span><span class="k">struct</span> <span class="n">enc28j60_net</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
				      <span class="n">u8</span> <span class="n">addr</span><span class="p">,</span> <span class="n">u8</span> <span class="n">mask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">enc28j60_set_bank</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
	<span class="n">spi_write_op</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">ENC28J60_BIT_FIELD_CLR</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">mask</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">locked_reg_bfclr</span><span class="p">(</span><span class="k">struct</span> <span class="n">enc28j60_net</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
				      <span class="n">u8</span> <span class="n">addr</span><span class="p">,</span> <span class="n">u8</span> <span class="n">mask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">nolock_reg_bfclr</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">mask</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Register byte read</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">nolock_regb_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">enc28j60_net</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
				     <span class="n">u8</span> <span class="n">address</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">enc28j60_set_bank</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">address</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">spi_read_op</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">ENC28J60_READ_CTRL_REG</span><span class="p">,</span> <span class="n">address</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">locked_regb_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">enc28j60_net</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
				     <span class="n">u8</span> <span class="n">address</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">nolock_regb_read</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">address</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Register word read</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">nolock_regw_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">enc28j60_net</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
				     <span class="n">u8</span> <span class="n">address</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rl</span><span class="p">,</span> <span class="n">rh</span><span class="p">;</span>

	<span class="n">enc28j60_set_bank</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">address</span><span class="p">);</span>
	<span class="n">rl</span> <span class="o">=</span> <span class="n">spi_read_op</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">ENC28J60_READ_CTRL_REG</span><span class="p">,</span> <span class="n">address</span><span class="p">);</span>
	<span class="n">rh</span> <span class="o">=</span> <span class="n">spi_read_op</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">ENC28J60_READ_CTRL_REG</span><span class="p">,</span> <span class="n">address</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">rh</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">rl</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">locked_regw_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">enc28j60_net</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
				     <span class="n">u8</span> <span class="n">address</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">nolock_regw_read</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">address</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Register byte write</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">nolock_regb_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">enc28j60_net</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
				       <span class="n">u8</span> <span class="n">address</span><span class="p">,</span> <span class="n">u8</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">enc28j60_set_bank</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">address</span><span class="p">);</span>
	<span class="n">spi_write_op</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">ENC28J60_WRITE_CTRL_REG</span><span class="p">,</span> <span class="n">address</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">locked_regb_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">enc28j60_net</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
				       <span class="n">u8</span> <span class="n">address</span><span class="p">,</span> <span class="n">u8</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">nolock_regb_write</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">address</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Register word write</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">nolock_regw_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">enc28j60_net</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
				       <span class="n">u8</span> <span class="n">address</span><span class="p">,</span> <span class="n">u16</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">enc28j60_set_bank</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">address</span><span class="p">);</span>
	<span class="n">spi_write_op</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">ENC28J60_WRITE_CTRL_REG</span><span class="p">,</span> <span class="n">address</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="n">data</span><span class="p">);</span>
	<span class="n">spi_write_op</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">ENC28J60_WRITE_CTRL_REG</span><span class="p">,</span> <span class="n">address</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
		     <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="p">(</span><span class="n">data</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">locked_regw_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">enc28j60_net</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
				       <span class="n">u8</span> <span class="n">address</span><span class="p">,</span> <span class="n">u16</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">nolock_regw_write</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">address</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Buffer memory read</span>
<span class="cm"> * Select the starting address and execute a SPI buffer read</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">enc28j60_mem_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">enc28j60_net</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
				     <span class="n">u16</span> <span class="n">addr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">nolock_regw_write</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">ERDPTL</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_ENC28J60_WRITEVERIFY</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">netif_msg_drv</span><span class="p">(</span><span class="n">priv</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">u16</span> <span class="n">reg</span><span class="p">;</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="n">nolock_regw_read</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">ERDPTL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">reg</span> <span class="o">!=</span> <span class="n">addr</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="n">DRV_NAME</span> <span class="s">&quot;: %s() error writing ERDPT &quot;</span>
				<span class="s">&quot;(0x%04x - 0x%04x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="n">spi_read_buf</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Write packet to enc28j60 TX buffer memory</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">enc28j60_packet_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">enc28j60_net</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="cm">/* Set the write pointer to start of transmit buffer area */</span>
	<span class="n">nolock_regw_write</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">EWRPTL</span><span class="p">,</span> <span class="n">TXSTART_INIT</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_ENC28J60_WRITEVERIFY</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">netif_msg_drv</span><span class="p">(</span><span class="n">priv</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">u16</span> <span class="n">reg</span><span class="p">;</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="n">nolock_regw_read</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">EWRPTL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">reg</span> <span class="o">!=</span> <span class="n">TXSTART_INIT</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="n">DRV_NAME</span>
				<span class="s">&quot;: %s() ERWPT:0x%04x != 0x%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">TXSTART_INIT</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="cm">/* Set the TXND pointer to correspond to the packet size given */</span>
	<span class="n">nolock_regw_write</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">ETXNDL</span><span class="p">,</span> <span class="n">TXSTART_INIT</span> <span class="o">+</span> <span class="n">len</span><span class="p">);</span>
	<span class="cm">/* write per-packet control byte */</span>
	<span class="n">spi_write_op</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">ENC28J60_WRITE_BUF_MEM</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">netif_msg_hw</span><span class="p">(</span><span class="n">priv</span><span class="p">))</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="n">DRV_NAME</span>
			<span class="s">&quot;: %s() after control byte ERWPT:0x%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">nolock_regw_read</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">EWRPTL</span><span class="p">));</span>
	<span class="cm">/* copy the packet into the transmit buffer */</span>
	<span class="n">spi_write_buf</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">netif_msg_hw</span><span class="p">(</span><span class="n">priv</span><span class="p">))</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="n">DRV_NAME</span>
			 <span class="s">&quot;: %s() after write packet ERWPT:0x%04x, len=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">__func__</span><span class="p">,</span> <span class="n">nolock_regw_read</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">EWRPTL</span><span class="p">),</span> <span class="n">len</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">msec20_to_jiffies</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">poll_ready</span><span class="p">(</span><span class="k">struct</span> <span class="n">enc28j60_net</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="n">u8</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u8</span> <span class="n">mask</span><span class="p">,</span> <span class="n">u8</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">timeout</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">msec20_to_jiffies</span><span class="p">;</span>

	<span class="cm">/* 20 msec timeout read */</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">nolock_regb_read</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">reg</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">)</span> <span class="o">!=</span> <span class="n">val</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">time_after</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">timeout</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">netif_msg_drv</span><span class="p">(</span><span class="n">priv</span><span class="p">))</span>
				<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">spi</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					<span class="s">&quot;reg %02x ready timeout!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">cpu_relax</span><span class="p">();</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Wait until the PHY operation is complete.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">wait_phy_ready</span><span class="p">(</span><span class="k">struct</span> <span class="n">enc28j60_net</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">poll_ready</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">MISTAT</span><span class="p">,</span> <span class="n">MISTAT_BUSY</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * PHY register read</span>
<span class="cm"> * PHY registers are not accessed directly, but through the MII</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">u16</span> <span class="nf">enc28j60_phy_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">enc28j60_net</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="n">u8</span> <span class="n">address</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="cm">/* set the PHY register address */</span>
	<span class="n">nolock_regb_write</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">MIREGADR</span><span class="p">,</span> <span class="n">address</span><span class="p">);</span>
	<span class="cm">/* start the register read operation */</span>
	<span class="n">nolock_regb_write</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">MICMD</span><span class="p">,</span> <span class="n">MICMD_MIIRD</span><span class="p">);</span>
	<span class="cm">/* wait until the PHY read completes */</span>
	<span class="n">wait_phy_ready</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="cm">/* quit reading */</span>
	<span class="n">nolock_regb_write</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">MICMD</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
	<span class="cm">/* return the data */</span>
	<span class="n">ret</span>  <span class="o">=</span> <span class="n">nolock_regw_read</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">MIRDL</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">enc28j60_phy_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">enc28j60_net</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="n">u8</span> <span class="n">address</span><span class="p">,</span> <span class="n">u16</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="cm">/* set the PHY register address */</span>
	<span class="n">nolock_regb_write</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">MIREGADR</span><span class="p">,</span> <span class="n">address</span><span class="p">);</span>
	<span class="cm">/* write the PHY data */</span>
	<span class="n">nolock_regw_write</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">MIWRL</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
	<span class="cm">/* wait until the PHY write completes and return */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">wait_phy_ready</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Program the hardware MAC address from dev-&gt;dev_addr.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">enc28j60_set_hw_macaddr</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">enc28j60_net</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw_enable</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">netif_msg_drv</span><span class="p">(</span><span class="n">priv</span><span class="p">))</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="n">DRV_NAME</span>
				<span class="s">&quot;: %s: Setting MAC address to %pM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">ndev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ndev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">);</span>
		<span class="cm">/* NOTE: MAC address in ENC28J60 is byte-backward */</span>
		<span class="n">nolock_regb_write</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">MAADR5</span><span class="p">,</span> <span class="n">ndev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="n">nolock_regb_write</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">MAADR4</span><span class="p">,</span> <span class="n">ndev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
		<span class="n">nolock_regb_write</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">MAADR3</span><span class="p">,</span> <span class="n">ndev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
		<span class="n">nolock_regb_write</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">MAADR2</span><span class="p">,</span> <span class="n">ndev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
		<span class="n">nolock_regb_write</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">MAADR1</span><span class="p">,</span> <span class="n">ndev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">4</span><span class="p">]);</span>
		<span class="n">nolock_regb_write</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">MAADR0</span><span class="p">,</span> <span class="n">ndev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">5</span><span class="p">]);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">netif_msg_drv</span><span class="p">(</span><span class="n">priv</span><span class="p">))</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="n">DRV_NAME</span>
				<span class="s">&quot;: %s() Hardware must be disabled to set &quot;</span>
				<span class="s">&quot;Mac address</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Store the new hardware address in dev-&gt;dev_addr, and update the MAC.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">enc28j60_set_mac_address</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="n">address</span> <span class="o">=</span> <span class="n">addr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">netif_running</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_valid_ether_addr</span><span class="p">(</span><span class="n">address</span><span class="o">-&gt;</span><span class="n">sa_data</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EADDRNOTAVAIL</span><span class="p">;</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">addr_assign_type</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">NET_ADDR_RANDOM</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">address</span><span class="o">-&gt;</span><span class="n">sa_data</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">addr_len</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">enc28j60_set_hw_macaddr</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Debug routine to dump useful register contents</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">enc28j60_dump_regs</span><span class="p">(</span><span class="k">struct</span> <span class="n">enc28j60_net</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">msg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="n">DRV_NAME</span> <span class="s">&quot; %s</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;HwRevID: 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;Cntrl: ECON1 ECON2 ESTAT  EIR  EIE</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;       0x%02x  0x%02x  0x%02x  0x%02x  0x%02x</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;MAC  : MACON1 MACON3 MACON4</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;       0x%02x   0x%02x   0x%02x</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;Rx   : ERXST  ERXND  ERXWRPT ERXRDPT ERXFCON EPKTCNT MAMXFL</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;       0x%04x 0x%04x 0x%04x  0x%04x  &quot;</span>
		<span class="s">&quot;0x%02x    0x%02x    0x%04x</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;Tx   : ETXST  ETXND  MACLCON1 MACLCON2 MAPHSUP</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;       0x%04x 0x%04x 0x%02x     0x%02x     0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">msg</span><span class="p">,</span> <span class="n">nolock_regb_read</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">EREVID</span><span class="p">),</span>
		<span class="n">nolock_regb_read</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">ECON1</span><span class="p">),</span> <span class="n">nolock_regb_read</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">ECON2</span><span class="p">),</span>
		<span class="n">nolock_regb_read</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">ESTAT</span><span class="p">),</span> <span class="n">nolock_regb_read</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">EIR</span><span class="p">),</span>
		<span class="n">nolock_regb_read</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">EIE</span><span class="p">),</span> <span class="n">nolock_regb_read</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">MACON1</span><span class="p">),</span>
		<span class="n">nolock_regb_read</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">MACON3</span><span class="p">),</span> <span class="n">nolock_regb_read</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">MACON4</span><span class="p">),</span>
		<span class="n">nolock_regw_read</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">ERXSTL</span><span class="p">),</span> <span class="n">nolock_regw_read</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">ERXNDL</span><span class="p">),</span>
		<span class="n">nolock_regw_read</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">ERXWRPTL</span><span class="p">),</span>
		<span class="n">nolock_regw_read</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">ERXRDPTL</span><span class="p">),</span>
		<span class="n">nolock_regb_read</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">ERXFCON</span><span class="p">),</span>
		<span class="n">nolock_regb_read</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">EPKTCNT</span><span class="p">),</span>
		<span class="n">nolock_regw_read</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">MAMXFLL</span><span class="p">),</span> <span class="n">nolock_regw_read</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">ETXSTL</span><span class="p">),</span>
		<span class="n">nolock_regw_read</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">ETXNDL</span><span class="p">),</span>
		<span class="n">nolock_regb_read</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">MACLCON1</span><span class="p">),</span>
		<span class="n">nolock_regb_read</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">MACLCON2</span><span class="p">),</span>
		<span class="n">nolock_regb_read</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">MAPHSUP</span><span class="p">));</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * ERXRDPT need to be set always at odd addresses, refer to errata datasheet</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">u16</span> <span class="nf">erxrdpt_workaround</span><span class="p">(</span><span class="n">u16</span> <span class="n">next_packet_ptr</span><span class="p">,</span> <span class="n">u16</span> <span class="n">start</span><span class="p">,</span> <span class="n">u16</span> <span class="n">end</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">erxrdpt</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">next_packet_ptr</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">&lt;</span> <span class="n">start</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">next_packet_ptr</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">&gt;</span> <span class="n">end</span><span class="p">))</span>
		<span class="n">erxrdpt</span> <span class="o">=</span> <span class="n">end</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">erxrdpt</span> <span class="o">=</span> <span class="n">next_packet_ptr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">erxrdpt</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Calculate wrap around when reading beyond the end of the RX buffer</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">u16</span> <span class="nf">rx_packet_start</span><span class="p">(</span><span class="n">u16</span> <span class="n">ptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ptr</span> <span class="o">+</span> <span class="n">RSV_SIZE</span> <span class="o">&gt;</span> <span class="n">RXEND_INIT</span><span class="p">)</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">ptr</span> <span class="o">+</span> <span class="n">RSV_SIZE</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">RXEND_INIT</span> <span class="o">-</span> <span class="n">RXSTART_INIT</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">ptr</span> <span class="o">+</span> <span class="n">RSV_SIZE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nolock_rxfifo_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">enc28j60_net</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="n">u16</span> <span class="n">start</span><span class="p">,</span> <span class="n">u16</span> <span class="n">end</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">erxrdpt</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">start</span> <span class="o">&gt;</span> <span class="mh">0x1FFF</span> <span class="o">||</span> <span class="n">end</span> <span class="o">&gt;</span> <span class="mh">0x1FFF</span> <span class="o">||</span> <span class="n">start</span> <span class="o">&gt;</span> <span class="n">end</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">netif_msg_drv</span><span class="p">(</span><span class="n">priv</span><span class="p">))</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">DRV_NAME</span> <span class="s">&quot;: %s(%d, %d) RXFIFO &quot;</span>
				<span class="s">&quot;bad parameters!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* set receive buffer start + end */</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">next_pk_ptr</span> <span class="o">=</span> <span class="n">start</span><span class="p">;</span>
	<span class="n">nolock_regw_write</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">ERXSTL</span><span class="p">,</span> <span class="n">start</span><span class="p">);</span>
	<span class="n">erxrdpt</span> <span class="o">=</span> <span class="n">erxrdpt_workaround</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">next_pk_ptr</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">);</span>
	<span class="n">nolock_regw_write</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">ERXRDPTL</span><span class="p">,</span> <span class="n">erxrdpt</span><span class="p">);</span>
	<span class="n">nolock_regw_write</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">ERXNDL</span><span class="p">,</span> <span class="n">end</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nolock_txfifo_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">enc28j60_net</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="n">u16</span> <span class="n">start</span><span class="p">,</span> <span class="n">u16</span> <span class="n">end</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">start</span> <span class="o">&gt;</span> <span class="mh">0x1FFF</span> <span class="o">||</span> <span class="n">end</span> <span class="o">&gt;</span> <span class="mh">0x1FFF</span> <span class="o">||</span> <span class="n">start</span> <span class="o">&gt;</span> <span class="n">end</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">netif_msg_drv</span><span class="p">(</span><span class="n">priv</span><span class="p">))</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">DRV_NAME</span> <span class="s">&quot;: %s(%d, %d) TXFIFO &quot;</span>
				<span class="s">&quot;bad parameters!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* set transmit buffer start + end */</span>
	<span class="n">nolock_regw_write</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">ETXSTL</span><span class="p">,</span> <span class="n">start</span><span class="p">);</span>
	<span class="n">nolock_regw_write</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">ETXNDL</span><span class="p">,</span> <span class="n">end</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Low power mode shrinks power consumption about 100x, so we&#39;d like</span>
<span class="cm"> * the chip to be in that mode whenever it&#39;s inactive.  (However, we</span>
<span class="cm"> * can&#39;t stay in lowpower mode during suspend with WOL active.)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">enc28j60_lowpower</span><span class="p">(</span><span class="k">struct</span> <span class="n">enc28j60_net</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="n">bool</span> <span class="n">is_low</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">netif_msg_drv</span><span class="p">(</span><span class="n">priv</span><span class="p">))</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">spi</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s power...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">is_low</span> <span class="o">?</span> <span class="s">&quot;low&quot;</span> <span class="o">:</span> <span class="s">&quot;high&quot;</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is_low</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">nolock_reg_bfclr</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">ECON1</span><span class="p">,</span> <span class="n">ECON1_RXEN</span><span class="p">);</span>
		<span class="n">poll_ready</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">ESTAT</span><span class="p">,</span> <span class="n">ESTAT_RXBUSY</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">poll_ready</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">ECON1</span><span class="p">,</span> <span class="n">ECON1_TXRTS</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="cm">/* ECON2_VRPS was set during initialization */</span>
		<span class="n">nolock_reg_bfset</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">ECON2</span><span class="p">,</span> <span class="n">ECON2_PWRSV</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">nolock_reg_bfclr</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">ECON2</span><span class="p">,</span> <span class="n">ECON2_PWRSV</span><span class="p">);</span>
		<span class="n">poll_ready</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">ESTAT</span><span class="p">,</span> <span class="n">ESTAT_CLKRDY</span><span class="p">,</span> <span class="n">ESTAT_CLKRDY</span><span class="p">);</span>
		<span class="cm">/* caller sets ECON1_RXEN */</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">enc28j60_hw_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">enc28j60_net</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">reg</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">netif_msg_drv</span><span class="p">(</span><span class="n">priv</span><span class="p">))</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="n">DRV_NAME</span> <span class="s">&quot;: %s() - %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">full_duplex</span> <span class="o">?</span> <span class="s">&quot;FullDuplex&quot;</span> <span class="o">:</span> <span class="s">&quot;HalfDuplex&quot;</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="cm">/* first reset the chip */</span>
	<span class="n">enc28j60_soft_reset</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="cm">/* Clear ECON1 */</span>
	<span class="n">spi_write_op</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">ENC28J60_WRITE_CTRL_REG</span><span class="p">,</span> <span class="n">ECON1</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">bank</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw_enable</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_retry_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">max_pk_counter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rxfilter</span> <span class="o">=</span> <span class="n">RXFILTER_NORMAL</span><span class="p">;</span>
	<span class="cm">/* enable address auto increment and voltage regulator powersave */</span>
	<span class="n">nolock_regb_write</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">ECON2</span><span class="p">,</span> <span class="n">ECON2_AUTOINC</span> <span class="o">|</span> <span class="n">ECON2_VRPS</span><span class="p">);</span>

	<span class="n">nolock_rxfifo_init</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">RXSTART_INIT</span><span class="p">,</span> <span class="n">RXEND_INIT</span><span class="p">);</span>
	<span class="n">nolock_txfifo_init</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">TXSTART_INIT</span><span class="p">,</span> <span class="n">TXEND_INIT</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Check the RevID.</span>
<span class="cm">	 * If it&#39;s 0x00 or 0xFF probably the enc28j60 is not mounted or</span>
<span class="cm">	 * damaged</span>
<span class="cm">	 */</span>
	<span class="n">reg</span> <span class="o">=</span> <span class="n">locked_regb_read</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">EREVID</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">netif_msg_drv</span><span class="p">(</span><span class="n">priv</span><span class="p">))</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="n">DRV_NAME</span> <span class="s">&quot;: chip RevID: 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reg</span> <span class="o">==</span> <span class="mh">0x00</span> <span class="o">||</span> <span class="n">reg</span> <span class="o">==</span> <span class="mh">0xff</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">netif_msg_drv</span><span class="p">(</span><span class="n">priv</span><span class="p">))</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="n">DRV_NAME</span> <span class="s">&quot;: %s() Invalid RevId %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* default filter mode: (unicast OR broadcast) AND crc valid */</span>
	<span class="n">locked_regb_write</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">ERXFCON</span><span class="p">,</span>
			    <span class="n">ERXFCON_UCEN</span> <span class="o">|</span> <span class="n">ERXFCON_CRCEN</span> <span class="o">|</span> <span class="n">ERXFCON_BCEN</span><span class="p">);</span>

	<span class="cm">/* enable MAC receive */</span>
	<span class="n">locked_regb_write</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">MACON1</span><span class="p">,</span>
			    <span class="n">MACON1_MARXEN</span> <span class="o">|</span> <span class="n">MACON1_TXPAUS</span> <span class="o">|</span> <span class="n">MACON1_RXPAUS</span><span class="p">);</span>
	<span class="cm">/* enable automatic padding and CRC operations */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">full_duplex</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">locked_regb_write</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">MACON3</span><span class="p">,</span>
				    <span class="n">MACON3_PADCFG0</span> <span class="o">|</span> <span class="n">MACON3_TXCRCEN</span> <span class="o">|</span>
				    <span class="n">MACON3_FRMLNEN</span> <span class="o">|</span> <span class="n">MACON3_FULDPX</span><span class="p">);</span>
		<span class="cm">/* set inter-frame gap (non-back-to-back) */</span>
		<span class="n">locked_regb_write</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">MAIPGL</span><span class="p">,</span> <span class="mh">0x12</span><span class="p">);</span>
		<span class="cm">/* set inter-frame gap (back-to-back) */</span>
		<span class="n">locked_regb_write</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">MABBIPG</span><span class="p">,</span> <span class="mh">0x15</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">locked_regb_write</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">MACON3</span><span class="p">,</span>
				    <span class="n">MACON3_PADCFG0</span> <span class="o">|</span> <span class="n">MACON3_TXCRCEN</span> <span class="o">|</span>
				    <span class="n">MACON3_FRMLNEN</span><span class="p">);</span>
		<span class="n">locked_regb_write</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">MACON4</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">);</span>	<span class="cm">/* DEFER bit */</span>
		<span class="cm">/* set inter-frame gap (non-back-to-back) */</span>
		<span class="n">locked_regw_write</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">MAIPGL</span><span class="p">,</span> <span class="mh">0x0C12</span><span class="p">);</span>
		<span class="cm">/* set inter-frame gap (back-to-back) */</span>
		<span class="n">locked_regb_write</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">MABBIPG</span><span class="p">,</span> <span class="mh">0x12</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	 * MACLCON1 (default)</span>
<span class="cm">	 * MACLCON2 (default)</span>
<span class="cm">	 * Set the maximum packet size which the controller will accept</span>
<span class="cm">	 */</span>
	<span class="n">locked_regw_write</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">MAMXFLL</span><span class="p">,</span> <span class="n">MAX_FRAMELEN</span><span class="p">);</span>

	<span class="cm">/* Configure LEDs */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">enc28j60_phy_write</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">PHLCON</span><span class="p">,</span> <span class="n">ENC28J60_LAMPS_MODE</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">full_duplex</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">enc28j60_phy_write</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">PHCON1</span><span class="p">,</span> <span class="n">PHCON1_PDPXMD</span><span class="p">))</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">enc28j60_phy_write</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">PHCON2</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">))</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">enc28j60_phy_write</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">PHCON1</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">))</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">enc28j60_phy_write</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">PHCON2</span><span class="p">,</span> <span class="n">PHCON2_HDLDIS</span><span class="p">))</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">netif_msg_hw</span><span class="p">(</span><span class="n">priv</span><span class="p">))</span>
		<span class="n">enc28j60_dump_regs</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="s">&quot;Hw initialized.&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">enc28j60_hw_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">enc28j60_net</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* enable interrupts */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">netif_msg_hw</span><span class="p">(</span><span class="n">priv</span><span class="p">))</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="n">DRV_NAME</span> <span class="s">&quot;: %s() enabling interrupts.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">);</span>

	<span class="n">enc28j60_phy_write</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">PHIE</span><span class="p">,</span> <span class="n">PHIE_PGEIE</span> <span class="o">|</span> <span class="n">PHIE_PLNKIE</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">nolock_reg_bfclr</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">EIR</span><span class="p">,</span> <span class="n">EIR_DMAIF</span> <span class="o">|</span> <span class="n">EIR_LINKIF</span> <span class="o">|</span>
			 <span class="n">EIR_TXIF</span> <span class="o">|</span> <span class="n">EIR_TXERIF</span> <span class="o">|</span> <span class="n">EIR_RXERIF</span> <span class="o">|</span> <span class="n">EIR_PKTIF</span><span class="p">);</span>
	<span class="n">nolock_regb_write</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">EIE</span><span class="p">,</span> <span class="n">EIE_INTIE</span> <span class="o">|</span> <span class="n">EIE_PKTIE</span> <span class="o">|</span> <span class="n">EIE_LINKIE</span> <span class="o">|</span>
			  <span class="n">EIE_TXIE</span> <span class="o">|</span> <span class="n">EIE_TXERIE</span> <span class="o">|</span> <span class="n">EIE_RXERIE</span><span class="p">);</span>

	<span class="cm">/* enable receive logic */</span>
	<span class="n">nolock_reg_bfset</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">ECON1</span><span class="p">,</span> <span class="n">ECON1_RXEN</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw_enable</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">enc28j60_hw_disable</span><span class="p">(</span><span class="k">struct</span> <span class="n">enc28j60_net</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="cm">/* disable interrutps and packet reception */</span>
	<span class="n">nolock_regb_write</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">EIE</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
	<span class="n">nolock_reg_bfclr</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">ECON1</span><span class="p">,</span> <span class="n">ECON1_RXEN</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw_enable</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">enc28j60_setlink</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">,</span> <span class="n">u8</span> <span class="n">autoneg</span><span class="p">,</span> <span class="n">u16</span> <span class="n">speed</span><span class="p">,</span> <span class="n">u8</span> <span class="n">duplex</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">enc28j60_net</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw_enable</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* link is in low power mode now; duplex setting</span>
<span class="cm">		 * will take effect on next enc28j60_hw_init().</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">autoneg</span> <span class="o">==</span> <span class="n">AUTONEG_DISABLE</span> <span class="o">&amp;&amp;</span> <span class="n">speed</span> <span class="o">==</span> <span class="n">SPEED_10</span><span class="p">)</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">full_duplex</span> <span class="o">=</span> <span class="p">(</span><span class="n">duplex</span> <span class="o">==</span> <span class="n">DUPLEX_FULL</span><span class="p">);</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">netif_msg_link</span><span class="p">(</span><span class="n">priv</span><span class="p">))</span>
				<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					<span class="s">&quot;unsupported link setting</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">netif_msg_link</span><span class="p">(</span><span class="n">priv</span><span class="p">))</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Warning: hw must be disabled &quot;</span>
				<span class="s">&quot;to set link mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Read the Transmit Status Vector</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">enc28j60_read_tsv</span><span class="p">(</span><span class="k">struct</span> <span class="n">enc28j60_net</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="n">u8</span> <span class="n">tsv</span><span class="p">[</span><span class="n">TSV_SIZE</span><span class="p">])</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">endptr</span><span class="p">;</span>

	<span class="n">endptr</span> <span class="o">=</span> <span class="n">locked_regw_read</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">ETXNDL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">netif_msg_hw</span><span class="p">(</span><span class="n">priv</span><span class="p">))</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="n">DRV_NAME</span> <span class="s">&quot;: reading TSV at addr:0x%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">endptr</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">enc28j60_mem_read</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">endptr</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">TSV_SIZE</span><span class="p">,</span> <span class="n">tsv</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">enc28j60_dump_tsv</span><span class="p">(</span><span class="k">struct</span> <span class="n">enc28j60_net</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">msg</span><span class="p">,</span>
				<span class="n">u8</span> <span class="n">tsv</span><span class="p">[</span><span class="n">TSV_SIZE</span><span class="p">])</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">tmp1</span><span class="p">,</span> <span class="n">tmp2</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="n">DRV_NAME</span> <span class="s">&quot;: %s - TSV:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">msg</span><span class="p">);</span>
	<span class="n">tmp1</span> <span class="o">=</span> <span class="n">tsv</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="n">tmp1</span> <span class="o">&lt;&lt;=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">tmp1</span> <span class="o">|=</span> <span class="n">tsv</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

	<span class="n">tmp2</span> <span class="o">=</span> <span class="n">tsv</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
	<span class="n">tmp2</span> <span class="o">&lt;&lt;=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">tmp2</span> <span class="o">|=</span> <span class="n">tsv</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="n">DRV_NAME</span> <span class="s">&quot;: ByteCount: %d, CollisionCount: %d,&quot;</span>
		<span class="s">&quot; TotByteOnWire: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tmp1</span><span class="p">,</span> <span class="n">tsv</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">,</span> <span class="n">tmp2</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="n">DRV_NAME</span> <span class="s">&quot;: TxDone: %d, CRCErr:%d, LenChkErr: %d,&quot;</span>
		<span class="s">&quot; LenOutOfRange: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">TSV_GETBIT</span><span class="p">(</span><span class="n">tsv</span><span class="p">,</span> <span class="n">TSV_TXDONE</span><span class="p">),</span>
		<span class="n">TSV_GETBIT</span><span class="p">(</span><span class="n">tsv</span><span class="p">,</span> <span class="n">TSV_TXCRCERROR</span><span class="p">),</span>
		<span class="n">TSV_GETBIT</span><span class="p">(</span><span class="n">tsv</span><span class="p">,</span> <span class="n">TSV_TXLENCHKERROR</span><span class="p">),</span>
		<span class="n">TSV_GETBIT</span><span class="p">(</span><span class="n">tsv</span><span class="p">,</span> <span class="n">TSV_TXLENOUTOFRANGE</span><span class="p">));</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="n">DRV_NAME</span> <span class="s">&quot;: Multicast: %d, Broadcast: %d, &quot;</span>
		<span class="s">&quot;PacketDefer: %d, ExDefer: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">TSV_GETBIT</span><span class="p">(</span><span class="n">tsv</span><span class="p">,</span> <span class="n">TSV_TXMULTICAST</span><span class="p">),</span>
		<span class="n">TSV_GETBIT</span><span class="p">(</span><span class="n">tsv</span><span class="p">,</span> <span class="n">TSV_TXBROADCAST</span><span class="p">),</span>
		<span class="n">TSV_GETBIT</span><span class="p">(</span><span class="n">tsv</span><span class="p">,</span> <span class="n">TSV_TXPACKETDEFER</span><span class="p">),</span>
		<span class="n">TSV_GETBIT</span><span class="p">(</span><span class="n">tsv</span><span class="p">,</span> <span class="n">TSV_TXEXDEFER</span><span class="p">));</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="n">DRV_NAME</span> <span class="s">&quot;: ExCollision: %d, LateCollision: %d, &quot;</span>
		 <span class="s">&quot;Giant: %d, Underrun: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">TSV_GETBIT</span><span class="p">(</span><span class="n">tsv</span><span class="p">,</span> <span class="n">TSV_TXEXCOLLISION</span><span class="p">),</span>
		 <span class="n">TSV_GETBIT</span><span class="p">(</span><span class="n">tsv</span><span class="p">,</span> <span class="n">TSV_TXLATECOLLISION</span><span class="p">),</span>
		 <span class="n">TSV_GETBIT</span><span class="p">(</span><span class="n">tsv</span><span class="p">,</span> <span class="n">TSV_TXGIANT</span><span class="p">),</span> <span class="n">TSV_GETBIT</span><span class="p">(</span><span class="n">tsv</span><span class="p">,</span> <span class="n">TSV_TXUNDERRUN</span><span class="p">));</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="n">DRV_NAME</span> <span class="s">&quot;: ControlFrame: %d, PauseFrame: %d, &quot;</span>
		 <span class="s">&quot;BackPressApp: %d, VLanTagFrame: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">TSV_GETBIT</span><span class="p">(</span><span class="n">tsv</span><span class="p">,</span> <span class="n">TSV_TXCONTROLFRAME</span><span class="p">),</span>
		 <span class="n">TSV_GETBIT</span><span class="p">(</span><span class="n">tsv</span><span class="p">,</span> <span class="n">TSV_TXPAUSEFRAME</span><span class="p">),</span>
		 <span class="n">TSV_GETBIT</span><span class="p">(</span><span class="n">tsv</span><span class="p">,</span> <span class="n">TSV_BACKPRESSUREAPP</span><span class="p">),</span>
		 <span class="n">TSV_GETBIT</span><span class="p">(</span><span class="n">tsv</span><span class="p">,</span> <span class="n">TSV_TXVLANTAGFRAME</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Receive Status vector</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">enc28j60_dump_rsv</span><span class="p">(</span><span class="k">struct</span> <span class="n">enc28j60_net</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">msg</span><span class="p">,</span>
			      <span class="n">u16</span> <span class="n">pk_ptr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="n">u16</span> <span class="n">sts</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="n">DRV_NAME</span> <span class="s">&quot;: %s - NextPk: 0x%04x - RSV:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">msg</span><span class="p">,</span> <span class="n">pk_ptr</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="n">DRV_NAME</span> <span class="s">&quot;: ByteCount: %d, DribbleNibble: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span>
		 <span class="n">RSV_GETBIT</span><span class="p">(</span><span class="n">sts</span><span class="p">,</span> <span class="n">RSV_DRIBBLENIBBLE</span><span class="p">));</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="n">DRV_NAME</span> <span class="s">&quot;: RxOK: %d, CRCErr:%d, LenChkErr: %d,&quot;</span>
		 <span class="s">&quot; LenOutOfRange: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">RSV_GETBIT</span><span class="p">(</span><span class="n">sts</span><span class="p">,</span> <span class="n">RSV_RXOK</span><span class="p">),</span>
		 <span class="n">RSV_GETBIT</span><span class="p">(</span><span class="n">sts</span><span class="p">,</span> <span class="n">RSV_CRCERROR</span><span class="p">),</span>
		 <span class="n">RSV_GETBIT</span><span class="p">(</span><span class="n">sts</span><span class="p">,</span> <span class="n">RSV_LENCHECKERR</span><span class="p">),</span>
		 <span class="n">RSV_GETBIT</span><span class="p">(</span><span class="n">sts</span><span class="p">,</span> <span class="n">RSV_LENOUTOFRANGE</span><span class="p">));</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="n">DRV_NAME</span> <span class="s">&quot;: Multicast: %d, Broadcast: %d, &quot;</span>
		 <span class="s">&quot;LongDropEvent: %d, CarrierEvent: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">RSV_GETBIT</span><span class="p">(</span><span class="n">sts</span><span class="p">,</span> <span class="n">RSV_RXMULTICAST</span><span class="p">),</span>
		 <span class="n">RSV_GETBIT</span><span class="p">(</span><span class="n">sts</span><span class="p">,</span> <span class="n">RSV_RXBROADCAST</span><span class="p">),</span>
		 <span class="n">RSV_GETBIT</span><span class="p">(</span><span class="n">sts</span><span class="p">,</span> <span class="n">RSV_RXLONGEVDROPEV</span><span class="p">),</span>
		 <span class="n">RSV_GETBIT</span><span class="p">(</span><span class="n">sts</span><span class="p">,</span> <span class="n">RSV_CARRIEREV</span><span class="p">));</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="n">DRV_NAME</span> <span class="s">&quot;: ControlFrame: %d, PauseFrame: %d,&quot;</span>
		 <span class="s">&quot; UnknownOp: %d, VLanTagFrame: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">RSV_GETBIT</span><span class="p">(</span><span class="n">sts</span><span class="p">,</span> <span class="n">RSV_RXCONTROLFRAME</span><span class="p">),</span>
		 <span class="n">RSV_GETBIT</span><span class="p">(</span><span class="n">sts</span><span class="p">,</span> <span class="n">RSV_RXPAUSEFRAME</span><span class="p">),</span>
		 <span class="n">RSV_GETBIT</span><span class="p">(</span><span class="n">sts</span><span class="p">,</span> <span class="n">RSV_RXUNKNOWNOPCODE</span><span class="p">),</span>
		 <span class="n">RSV_GETBIT</span><span class="p">(</span><span class="n">sts</span><span class="p">,</span> <span class="n">RSV_RXTYPEVLAN</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dump_packet</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">msg</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="n">DRV_NAME</span> <span class="s">&quot;: %s - packet len:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="n">print_hex_dump</span><span class="p">(</span><span class="n">KERN_DEBUG</span><span class="p">,</span> <span class="s">&quot;pk data: &quot;</span><span class="p">,</span> <span class="n">DUMP_PREFIX_OFFSET</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
			<span class="n">data</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Hardware receive function.</span>
<span class="cm"> * Read the buffer memory, update the FIFO pointer to free the buffer,</span>
<span class="cm"> * check the status vector and decrement the packet counter.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">enc28j60_hw_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">enc28j60_net</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">erxrdpt</span><span class="p">,</span> <span class="n">next_packet</span><span class="p">,</span> <span class="n">rxstat</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">rsv</span><span class="p">[</span><span class="n">RSV_SIZE</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">netif_msg_rx_status</span><span class="p">(</span><span class="n">priv</span><span class="p">))</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="n">DRV_NAME</span> <span class="s">&quot;: RX pk_addr:0x%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">next_pk_ptr</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">next_pk_ptr</span> <span class="o">&gt;</span> <span class="n">RXEND_INIT</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">netif_msg_rx_err</span><span class="p">(</span><span class="n">priv</span><span class="p">))</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;%s() Invalid packet address!! 0x%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">next_pk_ptr</span><span class="p">);</span>
		<span class="cm">/* packet address corrupted: reset RX logic */</span>
		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="n">nolock_reg_bfclr</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">ECON1</span><span class="p">,</span> <span class="n">ECON1_RXEN</span><span class="p">);</span>
		<span class="n">nolock_reg_bfset</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">ECON1</span><span class="p">,</span> <span class="n">ECON1_RXRST</span><span class="p">);</span>
		<span class="n">nolock_reg_bfclr</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">ECON1</span><span class="p">,</span> <span class="n">ECON1_RXRST</span><span class="p">);</span>
		<span class="n">nolock_rxfifo_init</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">RXSTART_INIT</span><span class="p">,</span> <span class="n">RXEND_INIT</span><span class="p">);</span>
		<span class="n">nolock_reg_bfclr</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">EIR</span><span class="p">,</span> <span class="n">EIR_RXERIF</span><span class="p">);</span>
		<span class="n">nolock_reg_bfset</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">ECON1</span><span class="p">,</span> <span class="n">ECON1_RXEN</span><span class="p">);</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="n">ndev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_errors</span><span class="o">++</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* Read next packet pointer and rx status vector */</span>
	<span class="n">enc28j60_mem_read</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">next_pk_ptr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">rsv</span><span class="p">),</span> <span class="n">rsv</span><span class="p">);</span>

	<span class="n">next_packet</span> <span class="o">=</span> <span class="n">rsv</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="n">next_packet</span> <span class="o">&lt;&lt;=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">next_packet</span> <span class="o">|=</span> <span class="n">rsv</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

	<span class="n">len</span> <span class="o">=</span> <span class="n">rsv</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="n">len</span> <span class="o">&lt;&lt;=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">len</span> <span class="o">|=</span> <span class="n">rsv</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>

	<span class="n">rxstat</span> <span class="o">=</span> <span class="n">rsv</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
	<span class="n">rxstat</span> <span class="o">&lt;&lt;=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">rxstat</span> <span class="o">|=</span> <span class="n">rsv</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">netif_msg_rx_status</span><span class="p">(</span><span class="n">priv</span><span class="p">))</span>
		<span class="n">enc28j60_dump_rsv</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">next_packet</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">rxstat</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">RSV_GETBIT</span><span class="p">(</span><span class="n">rxstat</span><span class="p">,</span> <span class="n">RSV_RXOK</span><span class="p">)</span> <span class="o">||</span> <span class="n">len</span> <span class="o">&gt;</span> <span class="n">MAX_FRAMELEN</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">netif_msg_rx_err</span><span class="p">(</span><span class="n">priv</span><span class="p">))</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Rx Error (%04x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rxstat</span><span class="p">);</span>
		<span class="n">ndev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_errors</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">RSV_GETBIT</span><span class="p">(</span><span class="n">rxstat</span><span class="p">,</span> <span class="n">RSV_CRCERROR</span><span class="p">))</span>
			<span class="n">ndev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_crc_errors</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">RSV_GETBIT</span><span class="p">(</span><span class="n">rxstat</span><span class="p">,</span> <span class="n">RSV_LENCHECKERR</span><span class="p">))</span>
			<span class="n">ndev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_frame_errors</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">MAX_FRAMELEN</span><span class="p">)</span>
			<span class="n">ndev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_over_errors</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">skb</span> <span class="o">=</span> <span class="n">netdev_alloc_skb</span><span class="p">(</span><span class="n">ndev</span><span class="p">,</span> <span class="n">len</span> <span class="o">+</span> <span class="n">NET_IP_ALIGN</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">netif_msg_rx_err</span><span class="p">(</span><span class="n">priv</span><span class="p">))</span>
				<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					<span class="s">&quot;out of memory for Rx&#39;d frame</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">ndev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_dropped</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">skb_reserve</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">NET_IP_ALIGN</span><span class="p">);</span>
			<span class="cm">/* copy the packet from the receive buffer */</span>
			<span class="n">enc28j60_mem_read</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span>
				<span class="n">rx_packet_start</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">next_pk_ptr</span><span class="p">),</span>
				<span class="n">len</span><span class="p">,</span> <span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">len</span><span class="p">));</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">netif_msg_pktdata</span><span class="p">(</span><span class="n">priv</span><span class="p">))</span>
				<span class="n">dump_packet</span><span class="p">(</span><span class="n">__func__</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
			<span class="n">skb</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">eth_type_trans</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">ndev</span><span class="p">);</span>
			<span class="cm">/* update statistics */</span>
			<span class="n">ndev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_packets</span><span class="o">++</span><span class="p">;</span>
			<span class="n">ndev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_bytes</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
			<span class="n">netif_rx_ni</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	 * Move the RX read pointer to the start of the next</span>
<span class="cm">	 * received packet.</span>
<span class="cm">	 * This frees the memory we just read out</span>
<span class="cm">	 */</span>
	<span class="n">erxrdpt</span> <span class="o">=</span> <span class="n">erxrdpt_workaround</span><span class="p">(</span><span class="n">next_packet</span><span class="p">,</span> <span class="n">RXSTART_INIT</span><span class="p">,</span> <span class="n">RXEND_INIT</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">netif_msg_hw</span><span class="p">(</span><span class="n">priv</span><span class="p">))</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="n">DRV_NAME</span> <span class="s">&quot;: %s() ERXRDPT:0x%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">erxrdpt</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">nolock_regw_write</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">ERXRDPTL</span><span class="p">,</span> <span class="n">erxrdpt</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_ENC28J60_WRITEVERIFY</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">netif_msg_drv</span><span class="p">(</span><span class="n">priv</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">u16</span> <span class="n">reg</span><span class="p">;</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="n">nolock_regw_read</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">ERXRDPTL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">reg</span> <span class="o">!=</span> <span class="n">erxrdpt</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="n">DRV_NAME</span> <span class="s">&quot;: %s() ERXRDPT verify &quot;</span>
				<span class="s">&quot;error (0x%04x - 0x%04x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
				<span class="n">reg</span><span class="p">,</span> <span class="n">erxrdpt</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">next_pk_ptr</span> <span class="o">=</span> <span class="n">next_packet</span><span class="p">;</span>
	<span class="cm">/* we are done with this packet, decrement the packet counter */</span>
	<span class="n">nolock_reg_bfset</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">ECON2</span><span class="p">,</span> <span class="n">ECON2_PKTDEC</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Calculate free space in RxFIFO</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">enc28j60_get_free_rxfifo</span><span class="p">(</span><span class="k">struct</span> <span class="n">enc28j60_net</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">epkcnt</span><span class="p">,</span> <span class="n">erxst</span><span class="p">,</span> <span class="n">erxnd</span><span class="p">,</span> <span class="n">erxwr</span><span class="p">,</span> <span class="n">erxrd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">free_space</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">epkcnt</span> <span class="o">=</span> <span class="n">nolock_regb_read</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">EPKTCNT</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">epkcnt</span> <span class="o">&gt;=</span> <span class="mi">255</span><span class="p">)</span>
		<span class="n">free_space</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">erxst</span> <span class="o">=</span> <span class="n">nolock_regw_read</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">ERXSTL</span><span class="p">);</span>
		<span class="n">erxnd</span> <span class="o">=</span> <span class="n">nolock_regw_read</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">ERXNDL</span><span class="p">);</span>
		<span class="n">erxwr</span> <span class="o">=</span> <span class="n">nolock_regw_read</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">ERXWRPTL</span><span class="p">);</span>
		<span class="n">erxrd</span> <span class="o">=</span> <span class="n">nolock_regw_read</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">ERXRDPTL</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">erxwr</span> <span class="o">&gt;</span> <span class="n">erxrd</span><span class="p">)</span>
			<span class="n">free_space</span> <span class="o">=</span> <span class="p">(</span><span class="n">erxnd</span> <span class="o">-</span> <span class="n">erxst</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">erxwr</span> <span class="o">-</span> <span class="n">erxrd</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">erxwr</span> <span class="o">==</span> <span class="n">erxrd</span><span class="p">)</span>
			<span class="n">free_space</span> <span class="o">=</span> <span class="p">(</span><span class="n">erxnd</span> <span class="o">-</span> <span class="n">erxst</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">free_space</span> <span class="o">=</span> <span class="n">erxrd</span> <span class="o">-</span> <span class="n">erxwr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">netif_msg_rx_status</span><span class="p">(</span><span class="n">priv</span><span class="p">))</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="n">DRV_NAME</span> <span class="s">&quot;: %s() free_space = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">free_space</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">free_space</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Access the PHY to determine link status</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">enc28j60_check_link_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">enc28j60_net</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
	<span class="n">u16</span> <span class="n">reg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">duplex</span><span class="p">;</span>

	<span class="n">reg</span> <span class="o">=</span> <span class="n">enc28j60_phy_read</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">PHSTAT2</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">netif_msg_hw</span><span class="p">(</span><span class="n">priv</span><span class="p">))</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="n">DRV_NAME</span> <span class="s">&quot;: %s() PHSTAT1: %04x, &quot;</span>
			<span class="s">&quot;PHSTAT2: %04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
			<span class="n">enc28j60_phy_read</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">PHSTAT1</span><span class="p">),</span> <span class="n">reg</span><span class="p">);</span>
	<span class="n">duplex</span> <span class="o">=</span> <span class="n">reg</span> <span class="o">&amp;</span> <span class="n">PHSTAT2_DPXSTAT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="n">PHSTAT2_LSTAT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netif_carrier_on</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">netif_msg_ifup</span><span class="p">(</span><span class="n">priv</span><span class="p">))</span>
			<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;link up - %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">duplex</span> <span class="o">?</span> <span class="s">&quot;Full duplex&quot;</span> <span class="o">:</span> <span class="s">&quot;Half duplex&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">netif_msg_ifdown</span><span class="p">(</span><span class="n">priv</span><span class="p">))</span>
			<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;link down</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">netif_carrier_off</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">enc28j60_tx_clear</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">,</span> <span class="n">bool</span> <span class="n">err</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">enc28j60_net</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="n">ndev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_errors</span><span class="o">++</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">ndev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_packets</span><span class="o">++</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span>
			<span class="n">ndev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_bytes</span> <span class="o">+=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
		<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="p">);</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">locked_reg_bfclr</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">ECON1</span><span class="p">,</span> <span class="n">ECON1_TXRTS</span><span class="p">);</span>
	<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * RX handler</span>
<span class="cm"> * ignore PKTIF because is unreliable! (look at the errata datasheet)</span>
<span class="cm"> * check EPKTCNT is the suggested workaround.</span>
<span class="cm"> * We don&#39;t need to clear interrupt flag, automatically done when</span>
<span class="cm"> * enc28j60_hw_rx() decrements the packet counter.</span>
<span class="cm"> * Returns how many packet processed.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">enc28j60_rx_interrupt</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">enc28j60_net</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">pk_counter</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">pk_counter</span> <span class="o">=</span> <span class="n">locked_regb_read</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">EPKTCNT</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pk_counter</span> <span class="o">&amp;&amp;</span> <span class="n">netif_msg_intr</span><span class="p">(</span><span class="n">priv</span><span class="p">))</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="n">DRV_NAME</span> <span class="s">&quot;: intRX, pk_cnt: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pk_counter</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pk_counter</span> <span class="o">&gt;</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">max_pk_counter</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* update statistics */</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">max_pk_counter</span> <span class="o">=</span> <span class="n">pk_counter</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">netif_msg_rx_status</span><span class="p">(</span><span class="n">priv</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">max_pk_counter</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="n">DRV_NAME</span> <span class="s">&quot;: RX max_pk_cnt: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">priv</span><span class="o">-&gt;</span><span class="n">max_pk_counter</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">pk_counter</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">pk_counter</span><span class="o">--</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">enc28j60_hw_rx</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">enc28j60_irq_work_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">enc28j60_net</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span>
		<span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">enc28j60_net</span><span class="p">,</span> <span class="n">irq_work</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">intflags</span><span class="p">,</span> <span class="n">loop</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">netif_msg_intr</span><span class="p">(</span><span class="n">priv</span><span class="p">))</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="n">DRV_NAME</span> <span class="s">&quot;: %s() enter</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="cm">/* disable further interrupts */</span>
	<span class="n">locked_reg_bfclr</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">EIE</span><span class="p">,</span> <span class="n">EIE_INTIE</span><span class="p">);</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">loop</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">intflags</span> <span class="o">=</span> <span class="n">locked_regb_read</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">EIR</span><span class="p">);</span>
		<span class="cm">/* DMA interrupt handler (not currently used) */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">intflags</span> <span class="o">&amp;</span> <span class="n">EIR_DMAIF</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">loop</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">netif_msg_intr</span><span class="p">(</span><span class="n">priv</span><span class="p">))</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="n">DRV_NAME</span>
					<span class="s">&quot;: intDMA(%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">loop</span><span class="p">);</span>
			<span class="n">locked_reg_bfclr</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">EIR</span><span class="p">,</span> <span class="n">EIR_DMAIF</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="cm">/* LINK changed handler */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">intflags</span> <span class="o">&amp;</span> <span class="n">EIR_LINKIF</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">loop</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">netif_msg_intr</span><span class="p">(</span><span class="n">priv</span><span class="p">))</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="n">DRV_NAME</span>
					<span class="s">&quot;: intLINK(%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">loop</span><span class="p">);</span>
			<span class="n">enc28j60_check_link_status</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
			<span class="cm">/* read PHIR to clear the flag */</span>
			<span class="n">enc28j60_phy_read</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">PHIR</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="cm">/* TX complete handler */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">intflags</span> <span class="o">&amp;</span> <span class="n">EIR_TXIF</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">bool</span> <span class="n">err</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
			<span class="n">loop</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">netif_msg_intr</span><span class="p">(</span><span class="n">priv</span><span class="p">))</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="n">DRV_NAME</span>
					<span class="s">&quot;: intTX(%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">loop</span><span class="p">);</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_retry_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">locked_regb_read</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">ESTAT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ESTAT_TXABRT</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">netif_msg_tx_err</span><span class="p">(</span><span class="n">priv</span><span class="p">))</span>
					<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
						<span class="s">&quot;Tx Error (aborted)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">err</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">netif_msg_tx_done</span><span class="p">(</span><span class="n">priv</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">u8</span> <span class="n">tsv</span><span class="p">[</span><span class="n">TSV_SIZE</span><span class="p">];</span>
				<span class="n">enc28j60_read_tsv</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">tsv</span><span class="p">);</span>
				<span class="n">enc28j60_dump_tsv</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="s">&quot;Tx Done&quot;</span><span class="p">,</span> <span class="n">tsv</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">enc28j60_tx_clear</span><span class="p">(</span><span class="n">ndev</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
			<span class="n">locked_reg_bfclr</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">EIR</span><span class="p">,</span> <span class="n">EIR_TXIF</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="cm">/* TX Error handler */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">intflags</span> <span class="o">&amp;</span> <span class="n">EIR_TXERIF</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u8</span> <span class="n">tsv</span><span class="p">[</span><span class="n">TSV_SIZE</span><span class="p">];</span>

			<span class="n">loop</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">netif_msg_intr</span><span class="p">(</span><span class="n">priv</span><span class="p">))</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="n">DRV_NAME</span>
					<span class="s">&quot;: intTXErr(%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">loop</span><span class="p">);</span>
			<span class="n">locked_reg_bfclr</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">ECON1</span><span class="p">,</span> <span class="n">ECON1_TXRTS</span><span class="p">);</span>
			<span class="n">enc28j60_read_tsv</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">tsv</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">netif_msg_tx_err</span><span class="p">(</span><span class="n">priv</span><span class="p">))</span>
				<span class="n">enc28j60_dump_tsv</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="s">&quot;Tx Error&quot;</span><span class="p">,</span> <span class="n">tsv</span><span class="p">);</span>
			<span class="cm">/* Reset TX logic */</span>
			<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
			<span class="n">nolock_reg_bfset</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">ECON1</span><span class="p">,</span> <span class="n">ECON1_TXRST</span><span class="p">);</span>
			<span class="n">nolock_reg_bfclr</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">ECON1</span><span class="p">,</span> <span class="n">ECON1_TXRST</span><span class="p">);</span>
			<span class="n">nolock_txfifo_init</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">TXSTART_INIT</span><span class="p">,</span> <span class="n">TXEND_INIT</span><span class="p">);</span>
			<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
			<span class="cm">/* Transmit Late collision check for retransmit */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">TSV_GETBIT</span><span class="p">(</span><span class="n">tsv</span><span class="p">,</span> <span class="n">TSV_TXLATECOLLISION</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">netif_msg_tx_err</span><span class="p">(</span><span class="n">priv</span><span class="p">))</span>
					<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="n">DRV_NAME</span>
						<span class="s">&quot;: LateCollision TXErr (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_retry_count</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_retry_count</span><span class="o">++</span> <span class="o">&lt;</span> <span class="n">MAX_TX_RETRYCOUNT</span><span class="p">)</span>
					<span class="n">locked_reg_bfset</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">ECON1</span><span class="p">,</span>
							   <span class="n">ECON1_TXRTS</span><span class="p">);</span>
				<span class="k">else</span>
					<span class="n">enc28j60_tx_clear</span><span class="p">(</span><span class="n">ndev</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="n">enc28j60_tx_clear</span><span class="p">(</span><span class="n">ndev</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
			<span class="n">locked_reg_bfclr</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">EIR</span><span class="p">,</span> <span class="n">EIR_TXERIF</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="cm">/* RX Error handler */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">intflags</span> <span class="o">&amp;</span> <span class="n">EIR_RXERIF</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">loop</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">netif_msg_intr</span><span class="p">(</span><span class="n">priv</span><span class="p">))</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="n">DRV_NAME</span>
					<span class="s">&quot;: intRXErr(%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">loop</span><span class="p">);</span>
			<span class="cm">/* Check free FIFO space to flag RX overrun */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">enc28j60_get_free_rxfifo</span><span class="p">(</span><span class="n">priv</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">netif_msg_rx_err</span><span class="p">(</span><span class="n">priv</span><span class="p">))</span>
					<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="n">DRV_NAME</span>
						<span class="s">&quot;: RX Overrun</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">ndev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_dropped</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">locked_reg_bfclr</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">EIR</span><span class="p">,</span> <span class="n">EIR_RXERIF</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="cm">/* RX handler */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">enc28j60_rx_interrupt</span><span class="p">(</span><span class="n">ndev</span><span class="p">))</span>
			<span class="n">loop</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">loop</span><span class="p">);</span>

	<span class="cm">/* re-enable interrupts */</span>
	<span class="n">locked_reg_bfset</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">EIE</span><span class="p">,</span> <span class="n">EIE_INTIE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">netif_msg_intr</span><span class="p">(</span><span class="n">priv</span><span class="p">))</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="n">DRV_NAME</span> <span class="s">&quot;: %s() exit</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Hardware transmit function.</span>
<span class="cm"> * Fill the buffer memory and send the contents of the transmit buffer</span>
<span class="cm"> * onto the network</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">enc28j60_hw_tx</span><span class="p">(</span><span class="k">struct</span> <span class="n">enc28j60_net</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">netif_msg_tx_queued</span><span class="p">(</span><span class="n">priv</span><span class="p">))</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="n">DRV_NAME</span>
			<span class="s">&quot;: Tx Packet Len:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">netif_msg_pktdata</span><span class="p">(</span><span class="n">priv</span><span class="p">))</span>
		<span class="n">dump_packet</span><span class="p">(</span><span class="n">__func__</span><span class="p">,</span>
			    <span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
	<span class="n">enc28j60_packet_write</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_ENC28J60_WRITEVERIFY</span>
	<span class="cm">/* readback and verify written data */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">netif_msg_drv</span><span class="p">(</span><span class="n">priv</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">test_len</span><span class="p">,</span> <span class="n">k</span><span class="p">;</span>
		<span class="n">u8</span> <span class="n">test_buf</span><span class="p">[</span><span class="mi">64</span><span class="p">];</span> <span class="cm">/* limit the test to the first 64 bytes */</span>
		<span class="kt">int</span> <span class="n">okflag</span><span class="p">;</span>

		<span class="n">test_len</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_len</span> <span class="o">&gt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">test_buf</span><span class="p">))</span>
			<span class="n">test_len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">test_buf</span><span class="p">);</span>

		<span class="cm">/* + 1 to skip control byte */</span>
		<span class="n">enc28j60_mem_read</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">TXSTART_INIT</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">test_len</span><span class="p">,</span> <span class="n">test_buf</span><span class="p">);</span>
		<span class="n">okflag</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">test_len</span><span class="p">;</span> <span class="n">k</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">!=</span> <span class="n">test_buf</span><span class="p">[</span><span class="n">k</span><span class="p">])</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="n">DRV_NAME</span>
					 <span class="s">&quot;: Error, %d location differ: &quot;</span>
					 <span class="s">&quot;0x%02x-0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span>
					 <span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">test_buf</span><span class="p">[</span><span class="n">k</span><span class="p">]);</span>
				<span class="n">okflag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">okflag</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="n">DRV_NAME</span> <span class="s">&quot;: Tx write buffer, &quot;</span>
				<span class="s">&quot;verify ERROR!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="cm">/* set TX request flag */</span>
	<span class="n">locked_reg_bfset</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">ECON1</span><span class="p">,</span> <span class="n">ECON1_TXRTS</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">netdev_tx_t</span> <span class="nf">enc28j60_send_packet</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">enc28j60_net</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">netif_msg_tx_queued</span><span class="p">(</span><span class="n">priv</span><span class="p">))</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="n">DRV_NAME</span> <span class="s">&quot;: %s() enter</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="cm">/* If some error occurs while trying to transmit this</span>
<span class="cm">	 * packet, you should return &#39;1&#39; from this function.</span>
<span class="cm">	 * In such a case you _may not_ do anything to the</span>
<span class="cm">	 * SKB, it is still owned by the network queueing</span>
<span class="cm">	 * layer when an error is returned.  This means you</span>
<span class="cm">	 * may not modify any SKB fields, you may not free</span>
<span class="cm">	 * the SKB, etc.</span>
<span class="cm">	 */</span>
	<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* Remember the skb for deferred processing */</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_skb</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>
	<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_work</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">NETDEV_TX_OK</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">enc28j60_tx_work_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">enc28j60_net</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span>
		<span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">enc28j60_net</span><span class="p">,</span> <span class="n">tx_work</span><span class="p">);</span>

	<span class="cm">/* actual delivery of data */</span>
	<span class="n">enc28j60_hw_tx</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">enc28j60_irq</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">enc28j60_net</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">dev_id</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Can&#39;t do anything in interrupt context because we need to</span>
<span class="cm">	 * block (spi_sync() is blocking) so fire of the interrupt</span>
<span class="cm">	 * handling workqueue.</span>
<span class="cm">	 * Remember that we access enc28j60 registers through SPI bus</span>
<span class="cm">	 * via spi_sync() call.</span>
<span class="cm">	 */</span>
	<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">irq_work</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">enc28j60_tx_timeout</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">enc28j60_net</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">netif_msg_timer</span><span class="p">(</span><span class="n">priv</span><span class="p">))</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">DRV_NAME</span> <span class="s">&quot; tx timeout</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">ndev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_errors</span><span class="o">++</span><span class="p">;</span>
	<span class="cm">/* can&#39;t restart safely under softirq */</span>
	<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">restart_work</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Open/initialize the board. This is called (in the current kernel)</span>
<span class="cm"> * sometime after booting when the &#39;ifconfig&#39; program is run.</span>
<span class="cm"> *</span>
<span class="cm"> * This routine should set everything up anew at each open, even</span>
<span class="cm"> * registers that &quot;should&quot; only need to be set once at boot, so that</span>
<span class="cm"> * there is non-reboot way to recover if something goes wrong.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">enc28j60_net_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">enc28j60_net</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">netif_msg_drv</span><span class="p">(</span><span class="n">priv</span><span class="p">))</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="n">DRV_NAME</span> <span class="s">&quot;: %s() enter</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_valid_ether_addr</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">netif_msg_ifup</span><span class="p">(</span><span class="n">priv</span><span class="p">))</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;invalid MAC address %pM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EADDRNOTAVAIL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* Reset the hardware here (and take it out of low power mode) */</span>
	<span class="n">enc28j60_lowpower</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
	<span class="n">enc28j60_hw_disable</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">enc28j60_hw_init</span><span class="p">(</span><span class="n">priv</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">netif_msg_ifup</span><span class="p">(</span><span class="n">priv</span><span class="p">))</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;hw_reset() failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* Update the MAC address (in case user has changed it) */</span>
	<span class="n">enc28j60_set_hw_macaddr</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="cm">/* Enable interrupts */</span>
	<span class="n">enc28j60_hw_enable</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="cm">/* check link status */</span>
	<span class="n">enc28j60_check_link_status</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="cm">/* We are now ready to accept transmit requests from</span>
<span class="cm">	 * the queueing layer of the networking.</span>
<span class="cm">	 */</span>
	<span class="n">netif_start_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* The inverse routine to net_open(). */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">enc28j60_net_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">enc28j60_net</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">netif_msg_drv</span><span class="p">(</span><span class="n">priv</span><span class="p">))</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="n">DRV_NAME</span> <span class="s">&quot;: %s() enter</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">enc28j60_hw_disable</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="n">enc28j60_lowpower</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
	<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Set or clear the multicast filter for this adapter</span>
<span class="cm"> * num_addrs == -1	Promiscuous mode, receive all packets</span>
<span class="cm"> * num_addrs == 0	Normal mode, filter out multicast packets</span>
<span class="cm"> * num_addrs &gt; 0	Multicast mode, receive normal and MC packets</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">enc28j60_set_multicast_list</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">enc28j60_net</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">oldfilter</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rxfilter</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_PROMISC</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">netif_msg_link</span><span class="p">(</span><span class="n">priv</span><span class="p">))</span>
			<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;promiscuous mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rxfilter</span> <span class="o">=</span> <span class="n">RXFILTER_PROMISC</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_ALLMULTI</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="n">netdev_mc_empty</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">netif_msg_link</span><span class="p">(</span><span class="n">priv</span><span class="p">))</span>
			<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%smulticast mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_ALLMULTI</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;all-&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rxfilter</span> <span class="o">=</span> <span class="n">RXFILTER_MULTI</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">netif_msg_link</span><span class="p">(</span><span class="n">priv</span><span class="p">))</span>
			<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;normal mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rxfilter</span> <span class="o">=</span> <span class="n">RXFILTER_NORMAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">oldfilter</span> <span class="o">!=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rxfilter</span><span class="p">)</span>
		<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">setrx_work</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">enc28j60_setrx_work_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">enc28j60_net</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span>
		<span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">enc28j60_net</span><span class="p">,</span> <span class="n">setrx_work</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rxfilter</span> <span class="o">==</span> <span class="n">RXFILTER_PROMISC</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">netif_msg_drv</span><span class="p">(</span><span class="n">priv</span><span class="p">))</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="n">DRV_NAME</span> <span class="s">&quot;: promiscuous mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">locked_regb_write</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">ERXFCON</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rxfilter</span> <span class="o">==</span> <span class="n">RXFILTER_MULTI</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">netif_msg_drv</span><span class="p">(</span><span class="n">priv</span><span class="p">))</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="n">DRV_NAME</span> <span class="s">&quot;: multicast mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">locked_regb_write</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">ERXFCON</span><span class="p">,</span>
					<span class="n">ERXFCON_UCEN</span> <span class="o">|</span> <span class="n">ERXFCON_CRCEN</span> <span class="o">|</span>
					<span class="n">ERXFCON_BCEN</span> <span class="o">|</span> <span class="n">ERXFCON_MCEN</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">netif_msg_drv</span><span class="p">(</span><span class="n">priv</span><span class="p">))</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="n">DRV_NAME</span> <span class="s">&quot;: normal mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">locked_regb_write</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">ERXFCON</span><span class="p">,</span>
					<span class="n">ERXFCON_UCEN</span> <span class="o">|</span> <span class="n">ERXFCON_CRCEN</span> <span class="o">|</span>
					<span class="n">ERXFCON_BCEN</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">enc28j60_restart_work_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">enc28j60_net</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span>
			<span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">enc28j60_net</span><span class="p">,</span> <span class="n">restart_work</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">rtnl_lock</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">netif_running</span><span class="p">(</span><span class="n">ndev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">enc28j60_net_close</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">enc28j60_net_open</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">ret</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot; could not restart %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
			<span class="n">dev_close</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">rtnl_unlock</span><span class="p">();</span>
<span class="p">}</span>

<span class="cm">/* ......................... ETHTOOL SUPPORT ........................... */</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">enc28j60_get_drvinfo</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ethtool_drvinfo</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">strlcpy</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">,</span> <span class="n">DRV_NAME</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">));</span>
	<span class="n">strlcpy</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">,</span> <span class="n">DRV_VERSION</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">));</span>
	<span class="n">strlcpy</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">bus_info</span><span class="p">,</span>
		<span class="n">dev_name</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span><span class="p">),</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">bus_info</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">enc28j60_get_settings</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ethtool_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">enc28j60_net</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">transceiver</span> <span class="o">=</span> <span class="n">XCVR_INTERNAL</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">supported</span>	<span class="o">=</span> <span class="n">SUPPORTED_10baseT_Half</span>
			<span class="o">|</span> <span class="n">SUPPORTED_10baseT_Full</span>
			<span class="o">|</span> <span class="n">SUPPORTED_TP</span><span class="p">;</span>
	<span class="n">ethtool_cmd_speed_set</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span>  <span class="n">SPEED_10</span><span class="p">);</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">duplex</span>	<span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">full_duplex</span> <span class="o">?</span> <span class="n">DUPLEX_FULL</span> <span class="o">:</span> <span class="n">DUPLEX_HALF</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">port</span>	<span class="o">=</span> <span class="n">PORT_TP</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">autoneg</span>	<span class="o">=</span> <span class="n">AUTONEG_DISABLE</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">enc28j60_set_settings</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ethtool_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">enc28j60_setlink</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">autoneg</span><span class="p">,</span>
				<span class="n">ethtool_cmd_speed</span><span class="p">(</span><span class="n">cmd</span><span class="p">),</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">duplex</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">enc28j60_get_msglevel</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">enc28j60_net</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">msg_enable</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">enc28j60_set_msglevel</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">enc28j60_net</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">msg_enable</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ethtool_ops</span> <span class="n">enc28j60_ethtool_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">get_settings</span>	<span class="o">=</span> <span class="n">enc28j60_get_settings</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_settings</span>	<span class="o">=</span> <span class="n">enc28j60_set_settings</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_drvinfo</span>	<span class="o">=</span> <span class="n">enc28j60_get_drvinfo</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_msglevel</span>	<span class="o">=</span> <span class="n">enc28j60_get_msglevel</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_msglevel</span>	<span class="o">=</span> <span class="n">enc28j60_set_msglevel</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">enc28j60_chipset_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">enc28j60_net</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">enc28j60_hw_init</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">net_device_ops</span> <span class="n">enc28j60_netdev_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">ndo_open</span>		<span class="o">=</span> <span class="n">enc28j60_net_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_stop</span>		<span class="o">=</span> <span class="n">enc28j60_net_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_start_xmit</span>		<span class="o">=</span> <span class="n">enc28j60_send_packet</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_set_rx_mode</span>	<span class="o">=</span> <span class="n">enc28j60_set_multicast_list</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_set_mac_address</span>	<span class="o">=</span> <span class="n">enc28j60_set_mac_address</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_tx_timeout</span>		<span class="o">=</span> <span class="n">enc28j60_tx_timeout</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_change_mtu</span>		<span class="o">=</span> <span class="n">eth_change_mtu</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_validate_addr</span>	<span class="o">=</span> <span class="n">eth_validate_addr</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">enc28j60_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">spi_device</span> <span class="o">*</span><span class="n">spi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">enc28j60_net</span> <span class="o">*</span><span class="n">priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">netif_msg_drv</span><span class="p">(</span><span class="o">&amp;</span><span class="n">debug</span><span class="p">))</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">spi</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">DRV_NAME</span> <span class="s">&quot; Ethernet driver %s loaded</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">DRV_VERSION</span><span class="p">);</span>

	<span class="n">dev</span> <span class="o">=</span> <span class="n">alloc_etherdev</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">enc28j60_net</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">error_alloc</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">netdev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>	<span class="cm">/* priv to netdev reference */</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">spi</span> <span class="o">=</span> <span class="n">spi</span><span class="p">;</span>	<span class="cm">/* priv to spi reference */</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">msg_enable</span> <span class="o">=</span> <span class="n">netif_msg_init</span><span class="p">(</span><span class="n">debug</span><span class="p">.</span><span class="n">msg_enable</span><span class="p">,</span>
						<span class="n">ENC28J60_MSG_DEFAULT</span><span class="p">);</span>
	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_work</span><span class="p">,</span> <span class="n">enc28j60_tx_work_handler</span><span class="p">);</span>
	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">setrx_work</span><span class="p">,</span> <span class="n">enc28j60_setrx_work_handler</span><span class="p">);</span>
	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">irq_work</span><span class="p">,</span> <span class="n">enc28j60_irq_work_handler</span><span class="p">);</span>
	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">restart_work</span><span class="p">,</span> <span class="n">enc28j60_restart_work_handler</span><span class="p">);</span>
	<span class="n">dev_set_drvdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">spi</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">priv</span><span class="p">);</span>	<span class="cm">/* spi to priv reference */</span>
	<span class="n">SET_NETDEV_DEV</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">spi</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">enc28j60_chipset_init</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">netif_msg_probe</span><span class="p">(</span><span class="n">priv</span><span class="p">))</span>
			<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">spi</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">DRV_NAME</span> <span class="s">&quot; chip not found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">error_irq</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">eth_hw_addr_random</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">enc28j60_set_hw_macaddr</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* Board setup must set the relevant edge trigger type;</span>
<span class="cm">	 * level triggers won&#39;t currently work.</span>
<span class="cm">	 */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">spi</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">enc28j60_irq</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">DRV_NAME</span><span class="p">,</span> <span class="n">priv</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">netif_msg_probe</span><span class="p">(</span><span class="n">priv</span><span class="p">))</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">spi</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">DRV_NAME</span> <span class="s">&quot;: request irq %d failed &quot;</span>
				<span class="s">&quot;(ret = %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">spi</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">error_irq</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">if_port</span> <span class="o">=</span> <span class="n">IF_PORT_10BASET</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">spi</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">netdev_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">enc28j60_netdev_ops</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">watchdog_timeo</span> <span class="o">=</span> <span class="n">TX_TIMEOUT</span><span class="p">;</span>
	<span class="n">SET_ETHTOOL_OPS</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">enc28j60_ethtool_ops</span><span class="p">);</span>

	<span class="n">enc28j60_lowpower</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">register_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">netif_msg_probe</span><span class="p">(</span><span class="n">priv</span><span class="p">))</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">spi</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;register netdev &quot;</span> <span class="n">DRV_NAME</span>
				<span class="s">&quot; failed (ret = %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">error_register</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">DRV_NAME</span> <span class="s">&quot; driver registered</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">error_register:</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">spi</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">priv</span><span class="p">);</span>
<span class="nl">error_irq:</span>
	<span class="n">free_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="nl">error_alloc:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devexit</span> <span class="nf">enc28j60_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">spi_device</span> <span class="o">*</span><span class="n">spi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">enc28j60_net</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">spi</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">netif_msg_drv</span><span class="p">(</span><span class="n">priv</span><span class="p">))</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="n">DRV_NAME</span> <span class="s">&quot;: remove</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">unregister_netdev</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">);</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">spi</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">priv</span><span class="p">);</span>
	<span class="n">free_netdev</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">spi_driver</span> <span class="n">enc28j60_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="p">{</span>
		   <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">DRV_NAME</span><span class="p">,</span>
		   <span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	 <span class="p">},</span>
	<span class="p">.</span><span class="n">probe</span> <span class="o">=</span> <span class="n">enc28j60_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span> <span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">enc28j60_remove</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">enc28j60_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">msec20_to_jiffies</span> <span class="o">=</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">spi_register_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">enc28j60_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">enc28j60_init</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">enc28j60_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">spi_unregister_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">enc28j60_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_exit</span><span class="p">(</span><span class="n">enc28j60_exit</span><span class="p">);</span>

<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="n">DRV_NAME</span> <span class="s">&quot; ethernet driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Claudio Lanconelli &lt;lanconelli.claudio@eptar.com&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">module_param_named</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="n">debug</span><span class="p">.</span><span class="n">msg_enable</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="s">&quot;Debug verbosity level (0=none, ..., ffff=all)&quot;</span><span class="p">);</span>
<span class="n">MODULE_ALIAS</span><span class="p">(</span><span class="s">&quot;spi:&quot;</span> <span class="n">DRV_NAME</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
