<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › ethernet › broadcom › b44.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>b44.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/* b44.c: Broadcom 44xx/47xx Fast Ethernet device driver.</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2002 David S. Miller (davem@redhat.com)</span>
<span class="cm"> * Copyright (C) 2004 Pekka Pietikainen (pp@ee.oulu.fi)</span>
<span class="cm"> * Copyright (C) 2004 Florian Schirmer (jolt@tuxbox.org)</span>
<span class="cm"> * Copyright (C) 2006 Felix Fietkau (nbd@openwrt.org)</span>
<span class="cm"> * Copyright (C) 2006 Broadcom Corporation.</span>
<span class="cm"> * Copyright (C) 2007 Michael Buesch &lt;m@bues.ch&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * Distribute under GPL.</span>
<span class="cm"> */</span>

<span class="cp">#define pr_fmt(fmt) KBUILD_MODNAME &quot;: &quot; fmt</span>

<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/moduleparam.h&gt;</span>
<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/netdevice.h&gt;</span>
<span class="cp">#include &lt;linux/ethtool.h&gt;</span>
<span class="cp">#include &lt;linux/mii.h&gt;</span>
<span class="cp">#include &lt;linux/if_ether.h&gt;</span>
<span class="cp">#include &lt;linux/if_vlan.h&gt;</span>
<span class="cp">#include &lt;linux/etherdevice.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/dma-mapping.h&gt;</span>
<span class="cp">#include &lt;linux/ssb/ssb.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>

<span class="cp">#include &lt;asm/uaccess.h&gt;</span>
<span class="cp">#include &lt;asm/io.h&gt;</span>
<span class="cp">#include &lt;asm/irq.h&gt;</span>


<span class="cp">#include &quot;b44.h&quot;</span>

<span class="cp">#define DRV_MODULE_NAME		&quot;b44&quot;</span>
<span class="cp">#define DRV_MODULE_VERSION	&quot;2.0&quot;</span>
<span class="cp">#define DRV_DESCRIPTION		&quot;Broadcom 44xx/47xx 10/100 PCI ethernet driver&quot;</span>

<span class="cp">#define B44_DEF_MSG_ENABLE	  \</span>
<span class="cp">	(NETIF_MSG_DRV		| \</span>
<span class="cp">	 NETIF_MSG_PROBE	| \</span>
<span class="cp">	 NETIF_MSG_LINK		| \</span>
<span class="cp">	 NETIF_MSG_TIMER	| \</span>
<span class="cp">	 NETIF_MSG_IFDOWN	| \</span>
<span class="cp">	 NETIF_MSG_IFUP		| \</span>
<span class="cp">	 NETIF_MSG_RX_ERR	| \</span>
<span class="cp">	 NETIF_MSG_TX_ERR)</span>

<span class="cm">/* length of time before we decide the hardware is borked,</span>
<span class="cm"> * and dev-&gt;tx_timeout() should be called to fix the problem</span>
<span class="cm"> */</span>
<span class="cp">#define B44_TX_TIMEOUT			(5 * HZ)</span>

<span class="cm">/* hardware minimum and maximum for a single frame&#39;s data payload */</span>
<span class="cp">#define B44_MIN_MTU			60</span>
<span class="cp">#define B44_MAX_MTU			1500</span>

<span class="cp">#define B44_RX_RING_SIZE		512</span>
<span class="cp">#define B44_DEF_RX_RING_PENDING		200</span>
<span class="cp">#define B44_RX_RING_BYTES	(sizeof(struct dma_desc) * \</span>
<span class="cp">				 B44_RX_RING_SIZE)</span>
<span class="cp">#define B44_TX_RING_SIZE		512</span>
<span class="cp">#define B44_DEF_TX_RING_PENDING		(B44_TX_RING_SIZE - 1)</span>
<span class="cp">#define B44_TX_RING_BYTES	(sizeof(struct dma_desc) * \</span>
<span class="cp">				 B44_TX_RING_SIZE)</span>

<span class="cp">#define TX_RING_GAP(BP)	\</span>
<span class="cp">	(B44_TX_RING_SIZE - (BP)-&gt;tx_pending)</span>
<span class="cp">#define TX_BUFFS_AVAIL(BP)						\</span>
<span class="cp">	(((BP)-&gt;tx_cons &lt;= (BP)-&gt;tx_prod) ?				\</span>
<span class="cp">	  (BP)-&gt;tx_cons + (BP)-&gt;tx_pending - (BP)-&gt;tx_prod :		\</span>
<span class="cp">	  (BP)-&gt;tx_cons - (BP)-&gt;tx_prod - TX_RING_GAP(BP))</span>
<span class="cp">#define NEXT_TX(N)		(((N) + 1) &amp; (B44_TX_RING_SIZE - 1))</span>

<span class="cp">#define RX_PKT_OFFSET		(RX_HEADER_LEN + 2)</span>
<span class="cp">#define RX_PKT_BUF_SZ		(1536 + RX_PKT_OFFSET)</span>

<span class="cm">/* minimum number of free TX descriptors required to wake up TX process */</span>
<span class="cp">#define B44_TX_WAKEUP_THRESH		(B44_TX_RING_SIZE / 4)</span>

<span class="cm">/* b44 internal pattern match filter info */</span>
<span class="cp">#define B44_PATTERN_BASE	0x400</span>
<span class="cp">#define B44_PATTERN_SIZE	0x80</span>
<span class="cp">#define B44_PMASK_BASE		0x600</span>
<span class="cp">#define B44_PMASK_SIZE		0x10</span>
<span class="cp">#define B44_MAX_PATTERNS	16</span>
<span class="cp">#define B44_ETHIPV6UDP_HLEN	62</span>
<span class="cp">#define B44_ETHIPV4UDP_HLEN	42</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Felix Fietkau, Florian Schirmer, Pekka Pietikainen, David S. Miller&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="n">DRV_DESCRIPTION</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_VERSION</span><span class="p">(</span><span class="n">DRV_MODULE_VERSION</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">b44_debug</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>	<span class="cm">/* -1 == use B44_DEF_MSG_ENABLE as value */</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">b44_debug</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">b44_debug</span><span class="p">,</span> <span class="s">&quot;B44 bitmapped debugging message enable value&quot;</span><span class="p">);</span>


<span class="cp">#ifdef CONFIG_B44_PCI</span>
<span class="k">static</span> <span class="n">DEFINE_PCI_DEVICE_TABLE</span><span class="p">(</span><span class="n">b44_pci_tbl</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_BROADCOM</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_BCM4401</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_BROADCOM</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_BCM4401B0</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_BROADCOM</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_BCM4401B1</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">0</span> <span class="p">}</span> <span class="cm">/* terminate list with empty entry */</span>
<span class="p">};</span>
<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">b44_pci_tbl</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_driver</span> <span class="n">b44_pci_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="n">DRV_MODULE_NAME</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span>	<span class="o">=</span> <span class="n">b44_pci_tbl</span><span class="p">,</span>
<span class="p">};</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_B44_PCI */</span><span class="cp"></span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ssb_device_id</span> <span class="n">b44_ssb_tbl</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">SSB_DEVICE</span><span class="p">(</span><span class="n">SSB_VENDOR_BROADCOM</span><span class="p">,</span> <span class="n">SSB_DEV_ETHERNET</span><span class="p">,</span> <span class="n">SSB_ANY_REV</span><span class="p">),</span>
	<span class="n">SSB_DEVTABLE_END</span>
<span class="p">};</span>
<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">ssb</span><span class="p">,</span> <span class="n">b44_ssb_tbl</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">b44_halt</span><span class="p">(</span><span class="k">struct</span> <span class="n">b44</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">b44_init_rings</span><span class="p">(</span><span class="k">struct</span> <span class="n">b44</span> <span class="o">*</span><span class="p">);</span>

<span class="cp">#define B44_FULL_RESET		1</span>
<span class="cp">#define B44_FULL_RESET_SKIP_PHY	2</span>
<span class="cp">#define B44_PARTIAL_RESET	3</span>
<span class="cp">#define B44_CHIP_RESET_FULL	4</span>
<span class="cp">#define B44_CHIP_RESET_PARTIAL	5</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">b44_init_hw</span><span class="p">(</span><span class="k">struct</span> <span class="n">b44</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">dma_desc_sync_size</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">instance</span><span class="p">;</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">b44_gstrings</span><span class="p">[][</span><span class="n">ETH_GSTRING_LEN</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
<span class="cp">#define _B44(x...)	# x,</span>
<span class="n">B44_STAT_REG_DECLARE</span>
<span class="cp">#undef _B44</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">b44_sync_dma_desc_for_device</span><span class="p">(</span><span class="k">struct</span> <span class="n">ssb_device</span> <span class="o">*</span><span class="n">sdev</span><span class="p">,</span>
						<span class="n">dma_addr_t</span> <span class="n">dma_base</span><span class="p">,</span>
						<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">offset</span><span class="p">,</span>
						<span class="k">enum</span> <span class="n">dma_data_direction</span> <span class="n">dir</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dma_sync_single_for_device</span><span class="p">(</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">dma_dev</span><span class="p">,</span> <span class="n">dma_base</span> <span class="o">+</span> <span class="n">offset</span><span class="p">,</span>
				   <span class="n">dma_desc_sync_size</span><span class="p">,</span> <span class="n">dir</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">b44_sync_dma_desc_for_cpu</span><span class="p">(</span><span class="k">struct</span> <span class="n">ssb_device</span> <span class="o">*</span><span class="n">sdev</span><span class="p">,</span>
					     <span class="n">dma_addr_t</span> <span class="n">dma_base</span><span class="p">,</span>
					     <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">offset</span><span class="p">,</span>
					     <span class="k">enum</span> <span class="n">dma_data_direction</span> <span class="n">dir</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dma_sync_single_for_cpu</span><span class="p">(</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">dma_dev</span><span class="p">,</span> <span class="n">dma_base</span> <span class="o">+</span> <span class="n">offset</span><span class="p">,</span>
				<span class="n">dma_desc_sync_size</span><span class="p">,</span> <span class="n">dir</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="nf">br32</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">b44</span> <span class="o">*</span><span class="n">bp</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">ssb_read32</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">sdev</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">bw32</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">b44</span> <span class="o">*</span><span class="n">bp</span><span class="p">,</span>
			<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">reg</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ssb_write32</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">sdev</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">b44_wait_bit</span><span class="p">(</span><span class="k">struct</span> <span class="n">b44</span> <span class="o">*</span><span class="n">bp</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">reg</span><span class="p">,</span>
			<span class="n">u32</span> <span class="n">bit</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">timeout</span><span class="p">,</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">clear</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">timeout</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">val</span> <span class="o">=</span> <span class="n">br32</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">clear</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">bit</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">clear</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">bit</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">timeout</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">net_ratelimit</span><span class="p">())</span>
			<span class="n">netdev_err</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;BUG!  Timeout waiting for bit %08x of register %lx to %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				   <span class="n">bit</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">clear</span> <span class="o">?</span> <span class="s">&quot;clear&quot;</span> <span class="o">:</span> <span class="s">&quot;set&quot;</span><span class="p">);</span>

		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">__b44_cam_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">b44</span> <span class="o">*</span><span class="n">bp</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">index</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">bw32</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">B44_CAM_CTRL</span><span class="p">,</span> <span class="p">(</span><span class="n">CAM_CTRL_READ</span> <span class="o">|</span>
			    <span class="p">(</span><span class="n">index</span> <span class="o">&lt;&lt;</span> <span class="n">CAM_CTRL_INDEX_SHIFT</span><span class="p">)));</span>

	<span class="n">b44_wait_bit</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">B44_CAM_CTRL</span><span class="p">,</span> <span class="n">CAM_CTRL_BUSY</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">br32</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">B44_CAM_DATA_LO</span><span class="p">);</span>

	<span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">;</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">;</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">;</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">br32</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">B44_CAM_DATA_HI</span><span class="p">);</span>

	<span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">;</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">__b44_cam_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">b44</span> <span class="o">*</span><span class="n">bp</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">index</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">val</span>  <span class="o">=</span> <span class="p">((</span><span class="n">u32</span><span class="p">)</span> <span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">;</span>
	<span class="n">val</span> <span class="o">|=</span> <span class="p">((</span><span class="n">u32</span><span class="p">)</span> <span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
	<span class="n">val</span> <span class="o">|=</span> <span class="p">((</span><span class="n">u32</span><span class="p">)</span> <span class="n">data</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span> <span class="o">&lt;&lt;</span>  <span class="mi">8</span><span class="p">;</span>
	<span class="n">val</span> <span class="o">|=</span> <span class="p">((</span><span class="n">u32</span><span class="p">)</span> <span class="n">data</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span> <span class="o">&lt;&lt;</span>  <span class="mi">0</span><span class="p">;</span>
	<span class="n">bw32</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">B44_CAM_DATA_LO</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">CAM_DATA_HI_VALID</span> <span class="o">|</span>
	       <span class="p">(((</span><span class="n">u32</span><span class="p">)</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span>
	       <span class="p">(((</span><span class="n">u32</span><span class="p">)</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">));</span>
	<span class="n">bw32</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">B44_CAM_DATA_HI</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="n">bw32</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">B44_CAM_CTRL</span><span class="p">,</span> <span class="p">(</span><span class="n">CAM_CTRL_WRITE</span> <span class="o">|</span>
			    <span class="p">(</span><span class="n">index</span> <span class="o">&lt;&lt;</span> <span class="n">CAM_CTRL_INDEX_SHIFT</span><span class="p">)));</span>
	<span class="n">b44_wait_bit</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">B44_CAM_CTRL</span><span class="p">,</span> <span class="n">CAM_CTRL_BUSY</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">__b44_disable_ints</span><span class="p">(</span><span class="k">struct</span> <span class="n">b44</span> <span class="o">*</span><span class="n">bp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bw32</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">B44_IMASK</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">b44_disable_ints</span><span class="p">(</span><span class="k">struct</span> <span class="n">b44</span> <span class="o">*</span><span class="n">bp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__b44_disable_ints</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>

	<span class="cm">/* Flush posted writes. */</span>
	<span class="n">br32</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">B44_IMASK</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">b44_enable_ints</span><span class="p">(</span><span class="k">struct</span> <span class="n">b44</span> <span class="o">*</span><span class="n">bp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bw32</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">B44_IMASK</span><span class="p">,</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">imask</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">__b44_readphy</span><span class="p">(</span><span class="k">struct</span> <span class="n">b44</span> <span class="o">*</span><span class="n">bp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">phy_addr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">bw32</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">B44_EMAC_ISTAT</span><span class="p">,</span> <span class="n">EMAC_INT_MII</span><span class="p">);</span>
	<span class="n">bw32</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">B44_MDIO_DATA</span><span class="p">,</span> <span class="p">(</span><span class="n">MDIO_DATA_SB_START</span> <span class="o">|</span>
			     <span class="p">(</span><span class="n">MDIO_OP_READ</span> <span class="o">&lt;&lt;</span> <span class="n">MDIO_DATA_OP_SHIFT</span><span class="p">)</span> <span class="o">|</span>
			     <span class="p">(</span><span class="n">phy_addr</span> <span class="o">&lt;&lt;</span> <span class="n">MDIO_DATA_PMD_SHIFT</span><span class="p">)</span> <span class="o">|</span>
			     <span class="p">(</span><span class="n">reg</span> <span class="o">&lt;&lt;</span> <span class="n">MDIO_DATA_RA_SHIFT</span><span class="p">)</span> <span class="o">|</span>
			     <span class="p">(</span><span class="n">MDIO_TA_VALID</span> <span class="o">&lt;&lt;</span> <span class="n">MDIO_DATA_TA_SHIFT</span><span class="p">)));</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">b44_wait_bit</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">B44_EMAC_ISTAT</span><span class="p">,</span> <span class="n">EMAC_INT_MII</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="o">*</span><span class="n">val</span> <span class="o">=</span> <span class="n">br32</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">B44_MDIO_DATA</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">MDIO_DATA_DATA</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">__b44_writephy</span><span class="p">(</span><span class="k">struct</span> <span class="n">b44</span> <span class="o">*</span><span class="n">bp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">phy_addr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u32</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bw32</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">B44_EMAC_ISTAT</span><span class="p">,</span> <span class="n">EMAC_INT_MII</span><span class="p">);</span>
	<span class="n">bw32</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">B44_MDIO_DATA</span><span class="p">,</span> <span class="p">(</span><span class="n">MDIO_DATA_SB_START</span> <span class="o">|</span>
			     <span class="p">(</span><span class="n">MDIO_OP_WRITE</span> <span class="o">&lt;&lt;</span> <span class="n">MDIO_DATA_OP_SHIFT</span><span class="p">)</span> <span class="o">|</span>
			     <span class="p">(</span><span class="n">phy_addr</span> <span class="o">&lt;&lt;</span> <span class="n">MDIO_DATA_PMD_SHIFT</span><span class="p">)</span> <span class="o">|</span>
			     <span class="p">(</span><span class="n">reg</span> <span class="o">&lt;&lt;</span> <span class="n">MDIO_DATA_RA_SHIFT</span><span class="p">)</span> <span class="o">|</span>
			     <span class="p">(</span><span class="n">MDIO_TA_VALID</span> <span class="o">&lt;&lt;</span> <span class="n">MDIO_DATA_TA_SHIFT</span><span class="p">)</span> <span class="o">|</span>
			     <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">MDIO_DATA_DATA</span><span class="p">)));</span>
	<span class="k">return</span> <span class="n">b44_wait_bit</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">B44_EMAC_ISTAT</span><span class="p">,</span> <span class="n">EMAC_INT_MII</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">b44_readphy</span><span class="p">(</span><span class="k">struct</span> <span class="n">b44</span> <span class="o">*</span><span class="n">bp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">phy_addr</span> <span class="o">==</span> <span class="n">B44_PHY_ADDR_NO_PHY</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">__b44_readphy</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">phy_addr</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">b44_writephy</span><span class="p">(</span><span class="k">struct</span> <span class="n">b44</span> <span class="o">*</span><span class="n">bp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u32</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">phy_addr</span> <span class="o">==</span> <span class="n">B44_PHY_ADDR_NO_PHY</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">__b44_writephy</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">phy_addr</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* miilib interface */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">b44_mii_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">phy_id</span><span class="p">,</span> <span class="kt">int</span> <span class="n">location</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">b44</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="n">__b44_readphy</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy_id</span><span class="p">,</span> <span class="n">location</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="mh">0xffffffff</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">val</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">b44_mii_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">phy_id</span><span class="p">,</span> <span class="kt">int</span> <span class="n">location</span><span class="p">,</span>
			 <span class="kt">int</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">b44</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">__b44_writephy</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy_id</span><span class="p">,</span> <span class="n">location</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">b44_phy_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">b44</span> <span class="o">*</span><span class="n">bp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">phy_addr</span> <span class="o">==</span> <span class="n">B44_PHY_ADDR_NO_PHY</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">b44_writephy</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">MII_BMCR</span><span class="p">,</span> <span class="n">BMCR_RESET</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">b44_readphy</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">MII_BMCR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">BMCR_RESET</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">netdev_err</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;PHY Reset would not complete</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">__b44_set_flow_ctrl</span><span class="p">(</span><span class="k">struct</span> <span class="n">b44</span> <span class="o">*</span><span class="n">bp</span><span class="p">,</span> <span class="n">u32</span> <span class="n">pause_flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">bp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">B44_FLAG_TX_PAUSE</span> <span class="o">|</span> <span class="n">B44_FLAG_RX_PAUSE</span><span class="p">);</span>
	<span class="n">bp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">pause_flags</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">br32</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">B44_RXCONFIG</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pause_flags</span> <span class="o">&amp;</span> <span class="n">B44_FLAG_RX_PAUSE</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">RXCONFIG_FLOW</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">RXCONFIG_FLOW</span><span class="p">;</span>
	<span class="n">bw32</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">B44_RXCONFIG</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">br32</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">B44_MAC_FLOW</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pause_flags</span> <span class="o">&amp;</span> <span class="n">B44_FLAG_TX_PAUSE</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="p">(</span><span class="n">MAC_FLOW_PAUSE_ENAB</span> <span class="o">|</span>
			<span class="p">(</span><span class="mh">0xc0</span> <span class="o">&amp;</span> <span class="n">MAC_FLOW_RX_HI_WATER</span><span class="p">));</span>
	<span class="k">else</span>
		<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MAC_FLOW_PAUSE_ENAB</span><span class="p">;</span>
	<span class="n">bw32</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">B44_MAC_FLOW</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">b44_set_flow_ctrl</span><span class="p">(</span><span class="k">struct</span> <span class="n">b44</span> <span class="o">*</span><span class="n">bp</span><span class="p">,</span> <span class="n">u32</span> <span class="n">local</span><span class="p">,</span> <span class="n">u32</span> <span class="n">remote</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">pause_enab</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* The driver supports only rx pause by default because</span>
<span class="cm">	   the b44 mac tx pause mechanism generates excessive</span>
<span class="cm">	   pause frames.</span>
<span class="cm">	   Use ethtool to turn on b44 tx pause if necessary.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">local</span> <span class="o">&amp;</span> <span class="n">ADVERTISE_PAUSE_CAP</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">local</span> <span class="o">&amp;</span> <span class="n">ADVERTISE_PAUSE_ASYM</span><span class="p">)){</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">remote</span> <span class="o">&amp;</span> <span class="n">LPA_PAUSE_ASYM</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="o">!</span><span class="p">(</span><span class="n">remote</span> <span class="o">&amp;</span> <span class="n">LPA_PAUSE_CAP</span><span class="p">))</span>
			<span class="n">pause_enab</span> <span class="o">|=</span> <span class="n">B44_FLAG_RX_PAUSE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">__b44_set_flow_ctrl</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">pause_enab</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_BCM47XX</span>
<span class="cp">#include &lt;asm/mach-bcm47xx/nvram.h&gt;</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">b44_wap54g10_workaround</span><span class="p">(</span><span class="k">struct</span> <span class="n">b44</span> <span class="o">*</span><span class="n">bp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">20</span><span class="p">];</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * workaround for bad hardware design in Linksys WAP54G v1.0</span>
<span class="cm">	 * see https://dev.openwrt.org/ticket/146</span>
<span class="cm">	 * check and reset bit &quot;isolate&quot;</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nvram_getenv</span><span class="p">(</span><span class="s">&quot;boardnum&quot;</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">simple_strtoul</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">__b44_readphy</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">MII_BMCR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">BMCR_ISOLATE</span><span class="p">))</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">BMCR_ISOLATE</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">__b44_writephy</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">MII_BMCR</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span><span class="p">;</span>
<span class="nl">error:</span>
	<span class="n">pr_warning</span><span class="p">(</span><span class="s">&quot;PHY: cannot reset MII transceiver isolate bit</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#else</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">b44_wap54g10_workaround</span><span class="p">(</span><span class="k">struct</span> <span class="n">b44</span> <span class="o">*</span><span class="n">bp</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">b44_setup_phy</span><span class="p">(</span><span class="k">struct</span> <span class="n">b44</span> <span class="o">*</span><span class="n">bp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">b44_wap54g10_workaround</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">phy_addr</span> <span class="o">==</span> <span class="n">B44_PHY_ADDR_NO_PHY</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">b44_readphy</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">B44_MII_ALEDCTRL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">b44_writephy</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">B44_MII_ALEDCTRL</span><span class="p">,</span>
				<span class="n">val</span> <span class="o">&amp;</span> <span class="n">MII_ALEDCTRL_ALLMSK</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">b44_readphy</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">B44_MII_TLEDCTRL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">b44_writephy</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">B44_MII_TLEDCTRL</span><span class="p">,</span>
				<span class="n">val</span> <span class="o">|</span> <span class="n">MII_TLEDCTRL_ENABLE</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">B44_FLAG_FORCE_LINK</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">adv</span> <span class="o">=</span> <span class="n">ADVERTISE_CSMA</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">B44_FLAG_ADV_10HALF</span><span class="p">)</span>
			<span class="n">adv</span> <span class="o">|=</span> <span class="n">ADVERTISE_10HALF</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">B44_FLAG_ADV_10FULL</span><span class="p">)</span>
			<span class="n">adv</span> <span class="o">|=</span> <span class="n">ADVERTISE_10FULL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">B44_FLAG_ADV_100HALF</span><span class="p">)</span>
			<span class="n">adv</span> <span class="o">|=</span> <span class="n">ADVERTISE_100HALF</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">B44_FLAG_ADV_100FULL</span><span class="p">)</span>
			<span class="n">adv</span> <span class="o">|=</span> <span class="n">ADVERTISE_100FULL</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">B44_FLAG_PAUSE_AUTO</span><span class="p">)</span>
			<span class="n">adv</span> <span class="o">|=</span> <span class="n">ADVERTISE_PAUSE_CAP</span> <span class="o">|</span> <span class="n">ADVERTISE_PAUSE_ASYM</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">b44_writephy</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">MII_ADVERTISE</span><span class="p">,</span> <span class="n">adv</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">b44_writephy</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">MII_BMCR</span><span class="p">,</span> <span class="p">(</span><span class="n">BMCR_ANENABLE</span> <span class="o">|</span>
						       <span class="n">BMCR_ANRESTART</span><span class="p">)))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">bmcr</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">b44_readphy</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">MII_BMCR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bmcr</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="n">bmcr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">BMCR_FULLDPLX</span> <span class="o">|</span> <span class="n">BMCR_ANENABLE</span> <span class="o">|</span> <span class="n">BMCR_SPEED100</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">B44_FLAG_100_BASE_T</span><span class="p">)</span>
			<span class="n">bmcr</span> <span class="o">|=</span> <span class="n">BMCR_SPEED100</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">B44_FLAG_FULL_DUPLEX</span><span class="p">)</span>
			<span class="n">bmcr</span> <span class="o">|=</span> <span class="n">BMCR_FULLDPLX</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">b44_writephy</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">MII_BMCR</span><span class="p">,</span> <span class="n">bmcr</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

		<span class="cm">/* Since we will not be negotiating there is no safe way</span>
<span class="cm">		 * to determine if the link partner supports flow control</span>
<span class="cm">		 * or not.  So just disable it completely in this case.</span>
<span class="cm">		 */</span>
		<span class="n">b44_set_flow_ctrl</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">b44_stats_update</span><span class="p">(</span><span class="k">struct</span> <span class="n">b44</span> <span class="o">*</span><span class="n">bp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">reg</span><span class="p">;</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">val</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">hw_stats</span><span class="p">.</span><span class="n">tx_good_octets</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">reg</span> <span class="o">=</span> <span class="n">B44_TX_GOOD_O</span><span class="p">;</span> <span class="n">reg</span> <span class="o">&lt;=</span> <span class="n">B44_TX_PAUSE</span><span class="p">;</span> <span class="n">reg</span> <span class="o">+=</span> <span class="mi">4UL</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">val</span><span class="o">++</span> <span class="o">+=</span> <span class="n">br32</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Pad */</span>
	<span class="n">reg</span> <span class="o">+=</span> <span class="mi">8</span><span class="o">*</span><span class="mi">4UL</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">reg</span> <span class="o">=</span> <span class="n">B44_RX_GOOD_O</span><span class="p">;</span> <span class="n">reg</span> <span class="o">&lt;=</span> <span class="n">B44_RX_NPAUSE</span><span class="p">;</span> <span class="n">reg</span> <span class="o">+=</span> <span class="mi">4UL</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">val</span><span class="o">++</span> <span class="o">+=</span> <span class="n">br32</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">b44_link_report</span><span class="p">(</span><span class="k">struct</span> <span class="n">b44</span> <span class="o">*</span><span class="n">bp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">netif_carrier_ok</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">netdev_info</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Link is down</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">netdev_info</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Link is up at %d Mbps, %s duplex</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">B44_FLAG_100_BASE_T</span><span class="p">)</span> <span class="o">?</span> <span class="mi">100</span> <span class="o">:</span> <span class="mi">10</span><span class="p">,</span>
			    <span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">B44_FLAG_FULL_DUPLEX</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;full&quot;</span> <span class="o">:</span> <span class="s">&quot;half&quot;</span><span class="p">);</span>

		<span class="n">netdev_info</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Flow control is %s for TX and %s for RX</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">B44_FLAG_TX_PAUSE</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;on&quot;</span> <span class="o">:</span> <span class="s">&quot;off&quot;</span><span class="p">,</span>
			    <span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">B44_FLAG_RX_PAUSE</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;on&quot;</span> <span class="o">:</span> <span class="s">&quot;off&quot;</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">b44_check_phy</span><span class="p">(</span><span class="k">struct</span> <span class="n">b44</span> <span class="o">*</span><span class="n">bp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">bmsr</span><span class="p">,</span> <span class="n">aux</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">phy_addr</span> <span class="o">==</span> <span class="n">B44_PHY_ADDR_NO_PHY</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">B44_FLAG_100_BASE_T</span><span class="p">;</span>
		<span class="n">bp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">B44_FLAG_FULL_DUPLEX</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">netif_carrier_ok</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">u32</span> <span class="n">val</span> <span class="o">=</span> <span class="n">br32</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">B44_TX_CTRL</span><span class="p">);</span>
			<span class="n">val</span> <span class="o">|=</span> <span class="n">TX_CTRL_DUPLEX</span><span class="p">;</span>
			<span class="n">bw32</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">B44_TX_CTRL</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
			<span class="n">netif_carrier_on</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
			<span class="n">b44_link_report</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">b44_readphy</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">MII_BMSR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bmsr</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">b44_readphy</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">B44_MII_AUXCTRL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">aux</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">bmsr</span> <span class="o">!=</span> <span class="mh">0xffff</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">aux</span> <span class="o">&amp;</span> <span class="n">MII_AUXCTRL_SPEED</span><span class="p">)</span>
			<span class="n">bp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">B44_FLAG_100_BASE_T</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">bp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">B44_FLAG_100_BASE_T</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">aux</span> <span class="o">&amp;</span> <span class="n">MII_AUXCTRL_DUPLEX</span><span class="p">)</span>
			<span class="n">bp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">B44_FLAG_FULL_DUPLEX</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">bp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">B44_FLAG_FULL_DUPLEX</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">netif_carrier_ok</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">bmsr</span> <span class="o">&amp;</span> <span class="n">BMSR_LSTATUS</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">u32</span> <span class="n">val</span> <span class="o">=</span> <span class="n">br32</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">B44_TX_CTRL</span><span class="p">);</span>
			<span class="n">u32</span> <span class="n">local_adv</span><span class="p">,</span> <span class="n">remote_adv</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">B44_FLAG_FULL_DUPLEX</span><span class="p">)</span>
				<span class="n">val</span> <span class="o">|=</span> <span class="n">TX_CTRL_DUPLEX</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">TX_CTRL_DUPLEX</span><span class="p">;</span>
			<span class="n">bw32</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">B44_TX_CTRL</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">B44_FLAG_FORCE_LINK</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="o">!</span><span class="n">b44_readphy</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">MII_ADVERTISE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">local_adv</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="o">!</span><span class="n">b44_readphy</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">MII_LPA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">remote_adv</span><span class="p">))</span>
				<span class="n">b44_set_flow_ctrl</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">local_adv</span><span class="p">,</span> <span class="n">remote_adv</span><span class="p">);</span>

			<span class="cm">/* Link now up */</span>
			<span class="n">netif_carrier_on</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
			<span class="n">b44_link_report</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">netif_carrier_ok</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">bmsr</span> <span class="o">&amp;</span> <span class="n">BMSR_LSTATUS</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* Link now down */</span>
			<span class="n">netif_carrier_off</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
			<span class="n">b44_link_report</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">bmsr</span> <span class="o">&amp;</span> <span class="n">BMSR_RFAULT</span><span class="p">)</span>
			<span class="n">netdev_warn</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Remote fault detected in PHY</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bmsr</span> <span class="o">&amp;</span> <span class="n">BMSR_JCD</span><span class="p">)</span>
			<span class="n">netdev_warn</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Jabber detected in PHY</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">b44_timer</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">__opaque</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">b44</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">b44</span> <span class="o">*</span><span class="p">)</span> <span class="n">__opaque</span><span class="p">;</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">b44_check_phy</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>

	<span class="n">b44_stats_update</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>

	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">,</span> <span class="n">round_jiffies</span><span class="p">(</span><span class="n">jiffies</span> <span class="o">+</span> <span class="n">HZ</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">b44_tx</span><span class="p">(</span><span class="k">struct</span> <span class="n">b44</span> <span class="o">*</span><span class="n">bp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">cur</span><span class="p">,</span> <span class="n">cons</span><span class="p">;</span>

	<span class="n">cur</span>  <span class="o">=</span> <span class="n">br32</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">B44_DMATX_STAT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">DMATX_STAT_CDMASK</span><span class="p">;</span>
	<span class="n">cur</span> <span class="o">/=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">dma_desc</span><span class="p">);</span>

	<span class="cm">/* XXX needs updating when NETIF_F_SG is supported */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">cons</span> <span class="o">=</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">tx_cons</span><span class="p">;</span> <span class="n">cons</span> <span class="o">!=</span> <span class="n">cur</span><span class="p">;</span> <span class="n">cons</span> <span class="o">=</span> <span class="n">NEXT_TX</span><span class="p">(</span><span class="n">cons</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ring_info</span> <span class="o">*</span><span class="n">rp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">tx_buffers</span><span class="p">[</span><span class="n">cons</span><span class="p">];</span>
		<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="n">rp</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">;</span>

		<span class="n">BUG_ON</span><span class="p">(</span><span class="n">skb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">);</span>

		<span class="n">dma_unmap_single</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">dma_dev</span><span class="p">,</span>
				 <span class="n">rp</span><span class="o">-&gt;</span><span class="n">mapping</span><span class="p">,</span>
				 <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span>
				 <span class="n">DMA_TO_DEVICE</span><span class="p">);</span>
		<span class="n">rp</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">dev_kfree_skb_irq</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">bp</span><span class="o">-&gt;</span><span class="n">tx_cons</span> <span class="o">=</span> <span class="n">cons</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">netif_queue_stopped</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">TX_BUFFS_AVAIL</span><span class="p">(</span><span class="n">bp</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">B44_TX_WAKEUP_THRESH</span><span class="p">)</span>
		<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">bw32</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">B44_GPTIMER</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Works like this.  This chip writes a &#39;struct rx_header&quot; 30 bytes</span>
<span class="cm"> * before the DMA address you give it.  So we allocate 30 more bytes</span>
<span class="cm"> * for the RX buffer, DMA map all of it, skb_reserve the 30 bytes, then</span>
<span class="cm"> * point the chip at 30 bytes past where the rx_header will go.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">b44_alloc_rx_skb</span><span class="p">(</span><span class="k">struct</span> <span class="n">b44</span> <span class="o">*</span><span class="n">bp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">src_idx</span><span class="p">,</span> <span class="n">u32</span> <span class="n">dest_idx_unmasked</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dma_desc</span> <span class="o">*</span><span class="n">dp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ring_info</span> <span class="o">*</span><span class="n">src_map</span><span class="p">,</span> <span class="o">*</span><span class="n">map</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rx_header</span> <span class="o">*</span><span class="n">rh</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">mapping</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">dest_idx</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ctrl</span><span class="p">;</span>

	<span class="n">src_map</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">src_idx</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">src_map</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">rx_buffers</span><span class="p">[</span><span class="n">src_idx</span><span class="p">];</span>
	<span class="n">dest_idx</span> <span class="o">=</span> <span class="n">dest_idx_unmasked</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">B44_RX_RING_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">map</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">rx_buffers</span><span class="p">[</span><span class="n">dest_idx</span><span class="p">];</span>
	<span class="n">skb</span> <span class="o">=</span> <span class="n">netdev_alloc_skb</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">RX_PKT_BUF_SZ</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">mapping</span> <span class="o">=</span> <span class="n">dma_map_single</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">dma_dev</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span>
				 <span class="n">RX_PKT_BUF_SZ</span><span class="p">,</span>
				 <span class="n">DMA_FROM_DEVICE</span><span class="p">);</span>

	<span class="cm">/* Hardware bug work-around, the chip is unable to do PCI DMA</span>
<span class="cm">	   to/from anything above 1GB :-( */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dma_mapping_error</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">dma_dev</span><span class="p">,</span> <span class="n">mapping</span><span class="p">)</span> <span class="o">||</span>
		<span class="n">mapping</span> <span class="o">+</span> <span class="n">RX_PKT_BUF_SZ</span> <span class="o">&gt;</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">30</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Sigh... */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dma_mapping_error</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">dma_dev</span><span class="p">,</span> <span class="n">mapping</span><span class="p">))</span>
			<span class="n">dma_unmap_single</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">dma_dev</span><span class="p">,</span> <span class="n">mapping</span><span class="p">,</span>
					     <span class="n">RX_PKT_BUF_SZ</span><span class="p">,</span> <span class="n">DMA_FROM_DEVICE</span><span class="p">);</span>
		<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="n">skb</span> <span class="o">=</span> <span class="n">__netdev_alloc_skb</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">RX_PKT_BUF_SZ</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="o">|</span><span class="n">GFP_DMA</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">skb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="n">mapping</span> <span class="o">=</span> <span class="n">dma_map_single</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">dma_dev</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span>
					 <span class="n">RX_PKT_BUF_SZ</span><span class="p">,</span>
					 <span class="n">DMA_FROM_DEVICE</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dma_mapping_error</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">dma_dev</span><span class="p">,</span> <span class="n">mapping</span><span class="p">)</span> <span class="o">||</span>
		    <span class="n">mapping</span> <span class="o">+</span> <span class="n">RX_PKT_BUF_SZ</span> <span class="o">&gt;</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">30</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dma_mapping_error</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">dma_dev</span><span class="p">,</span> <span class="n">mapping</span><span class="p">))</span>
				<span class="n">dma_unmap_single</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">dma_dev</span><span class="p">,</span> <span class="n">mapping</span><span class="p">,</span> <span class="n">RX_PKT_BUF_SZ</span><span class="p">,</span><span class="n">DMA_FROM_DEVICE</span><span class="p">);</span>
			<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">bp</span><span class="o">-&gt;</span><span class="n">force_copybreak</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rh</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">rx_header</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

	<span class="n">rh</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">rh</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">map</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>
	<span class="n">map</span><span class="o">-&gt;</span><span class="n">mapping</span> <span class="o">=</span> <span class="n">mapping</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">src_map</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">src_map</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">ctrl</span> <span class="o">=</span> <span class="p">(</span><span class="n">DESC_CTRL_LEN</span> <span class="o">&amp;</span> <span class="n">RX_PKT_BUF_SZ</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dest_idx</span> <span class="o">==</span> <span class="p">(</span><span class="n">B44_RX_RING_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
		<span class="n">ctrl</span> <span class="o">|=</span> <span class="n">DESC_CTRL_EOT</span><span class="p">;</span>

	<span class="n">dp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">dest_idx</span><span class="p">];</span>
	<span class="n">dp</span><span class="o">-&gt;</span><span class="n">ctrl</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">ctrl</span><span class="p">);</span>
	<span class="n">dp</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">((</span><span class="n">u32</span><span class="p">)</span> <span class="n">mapping</span> <span class="o">+</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">dma_offset</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">B44_FLAG_RX_RING_HACK</span><span class="p">)</span>
		<span class="n">b44_sync_dma_desc_for_device</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">sdev</span><span class="p">,</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">rx_ring_dma</span><span class="p">,</span>
			                    <span class="n">dest_idx</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">dp</span><span class="p">),</span>
			                    <span class="n">DMA_BIDIRECTIONAL</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">RX_PKT_BUF_SZ</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">b44_recycle_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">b44</span> <span class="o">*</span><span class="n">bp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">src_idx</span><span class="p">,</span> <span class="n">u32</span> <span class="n">dest_idx_unmasked</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dma_desc</span> <span class="o">*</span><span class="n">src_desc</span><span class="p">,</span> <span class="o">*</span><span class="n">dest_desc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ring_info</span> <span class="o">*</span><span class="n">src_map</span><span class="p">,</span> <span class="o">*</span><span class="n">dest_map</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rx_header</span> <span class="o">*</span><span class="n">rh</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">dest_idx</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">ctrl</span><span class="p">;</span>

	<span class="n">dest_idx</span> <span class="o">=</span> <span class="n">dest_idx_unmasked</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">B44_RX_RING_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">dest_desc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">dest_idx</span><span class="p">];</span>
	<span class="n">dest_map</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">rx_buffers</span><span class="p">[</span><span class="n">dest_idx</span><span class="p">];</span>
	<span class="n">src_desc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">src_idx</span><span class="p">];</span>
	<span class="n">src_map</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">rx_buffers</span><span class="p">[</span><span class="n">src_idx</span><span class="p">];</span>

	<span class="n">dest_map</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">=</span> <span class="n">src_map</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">;</span>
	<span class="n">rh</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">rx_header</span> <span class="o">*</span><span class="p">)</span> <span class="n">src_map</span><span class="o">-&gt;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">rh</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">rh</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dest_map</span><span class="o">-&gt;</span><span class="n">mapping</span> <span class="o">=</span> <span class="n">src_map</span><span class="o">-&gt;</span><span class="n">mapping</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">B44_FLAG_RX_RING_HACK</span><span class="p">)</span>
		<span class="n">b44_sync_dma_desc_for_cpu</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">sdev</span><span class="p">,</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">rx_ring_dma</span><span class="p">,</span>
			                 <span class="n">src_idx</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">src_desc</span><span class="p">),</span>
			                 <span class="n">DMA_BIDIRECTIONAL</span><span class="p">);</span>

	<span class="n">ctrl</span> <span class="o">=</span> <span class="n">src_desc</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dest_idx</span> <span class="o">==</span> <span class="p">(</span><span class="n">B44_RX_RING_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
		<span class="n">ctrl</span> <span class="o">|=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">DESC_CTRL_EOT</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">ctrl</span> <span class="o">&amp;=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="o">~</span><span class="n">DESC_CTRL_EOT</span><span class="p">);</span>

	<span class="n">dest_desc</span><span class="o">-&gt;</span><span class="n">ctrl</span> <span class="o">=</span> <span class="n">ctrl</span><span class="p">;</span>
	<span class="n">dest_desc</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">=</span> <span class="n">src_desc</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">;</span>

	<span class="n">src_map</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">B44_FLAG_RX_RING_HACK</span><span class="p">)</span>
		<span class="n">b44_sync_dma_desc_for_device</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">sdev</span><span class="p">,</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">rx_ring_dma</span><span class="p">,</span>
					     <span class="n">dest_idx</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">dest_desc</span><span class="p">),</span>
					     <span class="n">DMA_BIDIRECTIONAL</span><span class="p">);</span>

	<span class="n">dma_sync_single_for_device</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">dma_dev</span><span class="p">,</span> <span class="n">dest_map</span><span class="o">-&gt;</span><span class="n">mapping</span><span class="p">,</span>
				   <span class="n">RX_PKT_BUF_SZ</span><span class="p">,</span>
				   <span class="n">DMA_FROM_DEVICE</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">b44_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">b44</span> <span class="o">*</span><span class="n">bp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">budget</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">received</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">cons</span><span class="p">,</span> <span class="n">prod</span><span class="p">;</span>

	<span class="n">received</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">prod</span>  <span class="o">=</span> <span class="n">br32</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">B44_DMARX_STAT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">DMARX_STAT_CDMASK</span><span class="p">;</span>
	<span class="n">prod</span> <span class="o">/=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">dma_desc</span><span class="p">);</span>
	<span class="n">cons</span> <span class="o">=</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">rx_cons</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">cons</span> <span class="o">!=</span> <span class="n">prod</span> <span class="o">&amp;&amp;</span> <span class="n">budget</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ring_info</span> <span class="o">*</span><span class="n">rp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">rx_buffers</span><span class="p">[</span><span class="n">cons</span><span class="p">];</span>
		<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="n">rp</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">;</span>
		<span class="n">dma_addr_t</span> <span class="n">map</span> <span class="o">=</span> <span class="n">rp</span><span class="o">-&gt;</span><span class="n">mapping</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">rx_header</span> <span class="o">*</span><span class="n">rh</span><span class="p">;</span>
		<span class="n">u16</span> <span class="n">len</span><span class="p">;</span>

		<span class="n">dma_sync_single_for_cpu</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">dma_dev</span><span class="p">,</span> <span class="n">map</span><span class="p">,</span>
					<span class="n">RX_PKT_BUF_SZ</span><span class="p">,</span>
					<span class="n">DMA_FROM_DEVICE</span><span class="p">);</span>
		<span class="n">rh</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">rx_header</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">rh</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">len</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">RX_PKT_BUF_SZ</span> <span class="o">-</span> <span class="n">RX_PKT_OFFSET</span><span class="p">))</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">rh</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">RX_FLAG_ERRORS</span><span class="p">)))</span> <span class="p">{</span>
		<span class="nl">drop_it:</span>
			<span class="n">b44_recycle_rx</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">cons</span><span class="p">,</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">rx_prod</span><span class="p">);</span>
		<span class="nl">drop_it_no_recycle:</span>
			<span class="n">bp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_dropped</span><span class="o">++</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">next_pkt</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

			<span class="k">do</span> <span class="p">{</span>
				<span class="n">udelay</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
				<span class="n">barrier</span><span class="p">();</span>
				<span class="n">len</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">rh</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">len</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">i</span><span class="o">++</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">drop_it</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Omit CRC. */</span>
		<span class="n">len</span> <span class="o">-=</span> <span class="mi">4</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">force_copybreak</span> <span class="o">&amp;&amp;</span> <span class="n">len</span> <span class="o">&gt;</span> <span class="n">RX_COPY_THRESHOLD</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">skb_size</span><span class="p">;</span>
			<span class="n">skb_size</span> <span class="o">=</span> <span class="n">b44_alloc_rx_skb</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">cons</span><span class="p">,</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">rx_prod</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">skb_size</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">drop_it</span><span class="p">;</span>
			<span class="n">dma_unmap_single</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">dma_dev</span><span class="p">,</span> <span class="n">map</span><span class="p">,</span>
					 <span class="n">skb_size</span><span class="p">,</span> <span class="n">DMA_FROM_DEVICE</span><span class="p">);</span>
			<span class="cm">/* Leave out rx_header */</span>
			<span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">len</span> <span class="o">+</span> <span class="n">RX_PKT_OFFSET</span><span class="p">);</span>
			<span class="n">skb_pull</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">RX_PKT_OFFSET</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">copy_skb</span><span class="p">;</span>

			<span class="n">b44_recycle_rx</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">cons</span><span class="p">,</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">rx_prod</span><span class="p">);</span>
			<span class="n">copy_skb</span> <span class="o">=</span> <span class="n">netdev_alloc_skb</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">len</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">copy_skb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">drop_it_no_recycle</span><span class="p">;</span>

			<span class="n">skb_reserve</span><span class="p">(</span><span class="n">copy_skb</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
			<span class="n">skb_put</span><span class="p">(</span><span class="n">copy_skb</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
			<span class="cm">/* DMA sync done above, copy just the actual packet */</span>
			<span class="n">skb_copy_from_linear_data_offset</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">RX_PKT_OFFSET</span><span class="p">,</span>
							 <span class="n">copy_skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
			<span class="n">skb</span> <span class="o">=</span> <span class="n">copy_skb</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">skb_checksum_none_assert</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="n">skb</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">eth_type_trans</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">netif_receive_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="n">received</span><span class="o">++</span><span class="p">;</span>
		<span class="n">budget</span><span class="o">--</span><span class="p">;</span>
	<span class="nl">next_pkt:</span>
		<span class="n">bp</span><span class="o">-&gt;</span><span class="n">rx_prod</span> <span class="o">=</span> <span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">rx_prod</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span>
			<span class="p">(</span><span class="n">B44_RX_RING_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">cons</span> <span class="o">=</span> <span class="p">(</span><span class="n">cons</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">B44_RX_RING_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">bp</span><span class="o">-&gt;</span><span class="n">rx_cons</span> <span class="o">=</span> <span class="n">cons</span><span class="p">;</span>
	<span class="n">bw32</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">B44_DMARX_PTR</span><span class="p">,</span> <span class="n">cons</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">dma_desc</span><span class="p">));</span>

	<span class="k">return</span> <span class="n">received</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">b44_poll</span><span class="p">(</span><span class="k">struct</span> <span class="n">napi_struct</span> <span class="o">*</span><span class="n">napi</span><span class="p">,</span> <span class="kt">int</span> <span class="n">budget</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">b44</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">napi</span><span class="p">,</span> <span class="k">struct</span> <span class="n">b44</span><span class="p">,</span> <span class="n">napi</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">work_done</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">istat</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ISTAT_TX</span> <span class="o">|</span> <span class="n">ISTAT_TO</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* spin_lock(&amp;bp-&gt;tx_lock); */</span>
		<span class="n">b44_tx</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
		<span class="cm">/* spin_unlock(&amp;bp-&gt;tx_lock); */</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">istat</span> <span class="o">&amp;</span> <span class="n">ISTAT_RFO</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* fast recovery, in ~20msec */</span>
		<span class="n">bp</span><span class="o">-&gt;</span><span class="n">istat</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ISTAT_RFO</span><span class="p">;</span>
		<span class="n">b44_disable_ints</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
		<span class="n">ssb_device_enable</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">sdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span> <span class="cm">/* resets ISTAT_RFO */</span>
		<span class="n">b44_init_rings</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
		<span class="n">b44_init_hw</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">B44_FULL_RESET_SKIP_PHY</span><span class="p">);</span>
		<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">work_done</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">istat</span> <span class="o">&amp;</span> <span class="n">ISTAT_RX</span><span class="p">)</span>
		<span class="n">work_done</span> <span class="o">+=</span> <span class="n">b44_rx</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">budget</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">istat</span> <span class="o">&amp;</span> <span class="n">ISTAT_ERRORS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">b44_halt</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
		<span class="n">b44_init_rings</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
		<span class="n">b44_init_hw</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">B44_FULL_RESET_SKIP_PHY</span><span class="p">);</span>
		<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">work_done</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">work_done</span> <span class="o">&lt;</span> <span class="n">budget</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">napi_complete</span><span class="p">(</span><span class="n">napi</span><span class="p">);</span>
		<span class="n">b44_enable_ints</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">work_done</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">b44_interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev_id</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">b44</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">istat</span><span class="p">,</span> <span class="n">imask</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">handled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">istat</span> <span class="o">=</span> <span class="n">br32</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">B44_ISTAT</span><span class="p">);</span>
	<span class="n">imask</span> <span class="o">=</span> <span class="n">br32</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">B44_IMASK</span><span class="p">);</span>

	<span class="cm">/* The interrupt mask register controls which interrupt bits</span>
<span class="cm">	 * will actually raise an interrupt to the CPU when set by hw/firmware,</span>
<span class="cm">	 * but doesn&#39;t mask off the bits.</span>
<span class="cm">	 */</span>
	<span class="n">istat</span> <span class="o">&amp;=</span> <span class="n">imask</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">istat</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">handled</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">netif_running</span><span class="p">(</span><span class="n">dev</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">netdev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;late interrupt</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">irq_ack</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">napi_schedule_prep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* NOTE: These writes are posted by the readback of</span>
<span class="cm">			 *       the ISTAT register below.</span>
<span class="cm">			 */</span>
			<span class="n">bp</span><span class="o">-&gt;</span><span class="n">istat</span> <span class="o">=</span> <span class="n">istat</span><span class="p">;</span>
			<span class="n">__b44_disable_ints</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
			<span class="n">__napi_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">);</span>
		<span class="p">}</span>

<span class="nl">irq_ack:</span>
		<span class="n">bw32</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">B44_ISTAT</span><span class="p">,</span> <span class="n">istat</span><span class="p">);</span>
		<span class="n">br32</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">B44_ISTAT</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">IRQ_RETVAL</span><span class="p">(</span><span class="n">handled</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">b44_tx_timeout</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">b44</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">netdev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;transmit timed out, resetting</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">b44_halt</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
	<span class="n">b44_init_rings</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
	<span class="n">b44_init_hw</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">B44_FULL_RESET</span><span class="p">);</span>

	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">b44_enable_ints</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>

	<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">netdev_tx_t</span> <span class="nf">b44_start_xmit</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">b44</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="n">NETDEV_TX_OK</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">mapping</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">len</span><span class="p">,</span> <span class="n">entry</span><span class="p">,</span> <span class="n">ctrl</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">len</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* This is a hard error, log it. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">TX_BUFFS_AVAIL</span><span class="p">(</span><span class="n">bp</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">netdev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;BUG! Tx Ring full when queue awake!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mapping</span> <span class="o">=</span> <span class="n">dma_map_single</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">dma_dev</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">DMA_TO_DEVICE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dma_mapping_error</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">dma_dev</span><span class="p">,</span> <span class="n">mapping</span><span class="p">)</span> <span class="o">||</span> <span class="n">mapping</span> <span class="o">+</span> <span class="n">len</span> <span class="o">&gt;</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">30</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">bounce_skb</span><span class="p">;</span>

		<span class="cm">/* Chip can&#39;t handle DMA to/from &gt;1GB, use bounce buffer */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dma_mapping_error</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">dma_dev</span><span class="p">,</span> <span class="n">mapping</span><span class="p">))</span>
			<span class="n">dma_unmap_single</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">dma_dev</span><span class="p">,</span> <span class="n">mapping</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span>
					     <span class="n">DMA_TO_DEVICE</span><span class="p">);</span>

		<span class="n">bounce_skb</span> <span class="o">=</span> <span class="n">__netdev_alloc_skb</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span> <span class="o">|</span> <span class="n">GFP_DMA</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bounce_skb</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>

		<span class="n">mapping</span> <span class="o">=</span> <span class="n">dma_map_single</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">dma_dev</span><span class="p">,</span> <span class="n">bounce_skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span>
					 <span class="n">len</span><span class="p">,</span> <span class="n">DMA_TO_DEVICE</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dma_mapping_error</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">dma_dev</span><span class="p">,</span> <span class="n">mapping</span><span class="p">)</span> <span class="o">||</span> <span class="n">mapping</span> <span class="o">+</span> <span class="n">len</span> <span class="o">&gt;</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">30</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dma_mapping_error</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">dma_dev</span><span class="p">,</span> <span class="n">mapping</span><span class="p">))</span>
				<span class="n">dma_unmap_single</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">dma_dev</span><span class="p">,</span> <span class="n">mapping</span><span class="p">,</span>
						     <span class="n">len</span><span class="p">,</span> <span class="n">DMA_TO_DEVICE</span><span class="p">);</span>
			<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">bounce_skb</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">skb_copy_from_linear_data</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">skb_put</span><span class="p">(</span><span class="n">bounce_skb</span><span class="p">,</span> <span class="n">len</span><span class="p">),</span> <span class="n">len</span><span class="p">);</span>
		<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="n">skb</span> <span class="o">=</span> <span class="n">bounce_skb</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">entry</span> <span class="o">=</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">tx_prod</span><span class="p">;</span>
	<span class="n">bp</span><span class="o">-&gt;</span><span class="n">tx_buffers</span><span class="p">[</span><span class="n">entry</span><span class="p">].</span><span class="n">skb</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>
	<span class="n">bp</span><span class="o">-&gt;</span><span class="n">tx_buffers</span><span class="p">[</span><span class="n">entry</span><span class="p">].</span><span class="n">mapping</span> <span class="o">=</span> <span class="n">mapping</span><span class="p">;</span>

	<span class="n">ctrl</span>  <span class="o">=</span> <span class="p">(</span><span class="n">len</span> <span class="o">&amp;</span> <span class="n">DESC_CTRL_LEN</span><span class="p">);</span>
	<span class="n">ctrl</span> <span class="o">|=</span> <span class="n">DESC_CTRL_IOC</span> <span class="o">|</span> <span class="n">DESC_CTRL_SOF</span> <span class="o">|</span> <span class="n">DESC_CTRL_EOF</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">entry</span> <span class="o">==</span> <span class="p">(</span><span class="n">B44_TX_RING_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
		<span class="n">ctrl</span> <span class="o">|=</span> <span class="n">DESC_CTRL_EOT</span><span class="p">;</span>

	<span class="n">bp</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">[</span><span class="n">entry</span><span class="p">].</span><span class="n">ctrl</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">ctrl</span><span class="p">);</span>
	<span class="n">bp</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">[</span><span class="n">entry</span><span class="p">].</span><span class="n">addr</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">((</span><span class="n">u32</span><span class="p">)</span> <span class="n">mapping</span><span class="o">+</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">dma_offset</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">B44_FLAG_TX_RING_HACK</span><span class="p">)</span>
		<span class="n">b44_sync_dma_desc_for_device</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">sdev</span><span class="p">,</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">tx_ring_dma</span><span class="p">,</span>
			                    <span class="n">entry</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
			                    <span class="n">DMA_TO_DEVICE</span><span class="p">);</span>

	<span class="n">entry</span> <span class="o">=</span> <span class="n">NEXT_TX</span><span class="p">(</span><span class="n">entry</span><span class="p">);</span>

	<span class="n">bp</span><span class="o">-&gt;</span><span class="n">tx_prod</span> <span class="o">=</span> <span class="n">entry</span><span class="p">;</span>

	<span class="n">wmb</span><span class="p">();</span>

	<span class="n">bw32</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">B44_DMATX_PTR</span><span class="p">,</span> <span class="n">entry</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">dma_desc</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">B44_FLAG_BUGGY_TXPTR</span><span class="p">)</span>
		<span class="n">bw32</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">B44_DMATX_PTR</span><span class="p">,</span> <span class="n">entry</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">dma_desc</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">B44_FLAG_REORDER_BUG</span><span class="p">)</span>
		<span class="n">br32</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">B44_DMATX_PTR</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">TX_BUFFS_AVAIL</span><span class="p">(</span><span class="n">bp</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

<span class="nl">out_unlock:</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

<span class="nl">err_out:</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">NETDEV_TX_BUSY</span><span class="p">;</span>
	<span class="k">goto</span> <span class="n">out_unlock</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">b44_change_mtu</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">new_mtu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">b44</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">new_mtu</span> <span class="o">&lt;</span> <span class="n">B44_MIN_MTU</span> <span class="o">||</span> <span class="n">new_mtu</span> <span class="o">&gt;</span> <span class="n">B44_MAX_MTU</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">netif_running</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* We&#39;ll just catch it later when the</span>
<span class="cm">		 * device is up&#39;d.</span>
<span class="cm">		 */</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">mtu</span> <span class="o">=</span> <span class="n">new_mtu</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">b44_halt</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">mtu</span> <span class="o">=</span> <span class="n">new_mtu</span><span class="p">;</span>
	<span class="n">b44_init_rings</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
	<span class="n">b44_init_hw</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">B44_FULL_RESET</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">b44_enable_ints</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Free up pending packets in all rx/tx rings.</span>
<span class="cm"> *</span>
<span class="cm"> * The chip has been shut down and the driver detached from</span>
<span class="cm"> * the networking, so no interrupts or new tx packets will</span>
<span class="cm"> * end up in the driver.  bp-&gt;lock is not held and we are not</span>
<span class="cm"> * in an interrupt context and thus may sleep.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">b44_free_rings</span><span class="p">(</span><span class="k">struct</span> <span class="n">b44</span> <span class="o">*</span><span class="n">bp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ring_info</span> <span class="o">*</span><span class="n">rp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">B44_RX_RING_SIZE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">rx_buffers</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">dma_unmap_single</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">dma_dev</span><span class="p">,</span> <span class="n">rp</span><span class="o">-&gt;</span><span class="n">mapping</span><span class="p">,</span> <span class="n">RX_PKT_BUF_SZ</span><span class="p">,</span>
				 <span class="n">DMA_FROM_DEVICE</span><span class="p">);</span>
		<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">);</span>
		<span class="n">rp</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* XXX needs changes once NETIF_F_SG is set... */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">B44_TX_RING_SIZE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">tx_buffers</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">dma_unmap_single</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">dma_dev</span><span class="p">,</span> <span class="n">rp</span><span class="o">-&gt;</span><span class="n">mapping</span><span class="p">,</span> <span class="n">rp</span><span class="o">-&gt;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span>
				 <span class="n">DMA_TO_DEVICE</span><span class="p">);</span>
		<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">);</span>
		<span class="n">rp</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* Initialize tx/rx rings for packet processing.</span>
<span class="cm"> *</span>
<span class="cm"> * The chip has been shut down and the driver detached from</span>
<span class="cm"> * the networking, so no interrupts or new tx packets will</span>
<span class="cm"> * end up in the driver.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">b44_init_rings</span><span class="p">(</span><span class="k">struct</span> <span class="n">b44</span> <span class="o">*</span><span class="n">bp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">b44_free_rings</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">B44_RX_RING_BYTES</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">B44_TX_RING_BYTES</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">B44_FLAG_RX_RING_HACK</span><span class="p">)</span>
		<span class="n">dma_sync_single_for_device</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">dma_dev</span><span class="p">,</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">rx_ring_dma</span><span class="p">,</span>
					   <span class="n">DMA_TABLE_BYTES</span><span class="p">,</span> <span class="n">DMA_BIDIRECTIONAL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">B44_FLAG_TX_RING_HACK</span><span class="p">)</span>
		<span class="n">dma_sync_single_for_device</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">dma_dev</span><span class="p">,</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">tx_ring_dma</span><span class="p">,</span>
					   <span class="n">DMA_TABLE_BYTES</span><span class="p">,</span> <span class="n">DMA_TO_DEVICE</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">rx_pending</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">b44_alloc_rx_skb</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Must not be invoked with interrupt sources disabled and</span>
<span class="cm"> * the hardware shutdown down.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">b44_free_consistent</span><span class="p">(</span><span class="k">struct</span> <span class="n">b44</span> <span class="o">*</span><span class="n">bp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">rx_buffers</span><span class="p">);</span>
	<span class="n">bp</span><span class="o">-&gt;</span><span class="n">rx_buffers</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">tx_buffers</span><span class="p">);</span>
	<span class="n">bp</span><span class="o">-&gt;</span><span class="n">tx_buffers</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">B44_FLAG_RX_RING_HACK</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dma_unmap_single</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">dma_dev</span><span class="p">,</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">rx_ring_dma</span><span class="p">,</span>
					 <span class="n">DMA_TABLE_BYTES</span><span class="p">,</span> <span class="n">DMA_BIDIRECTIONAL</span><span class="p">);</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">dma_free_coherent</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">dma_dev</span><span class="p">,</span> <span class="n">DMA_TABLE_BYTES</span><span class="p">,</span>
					  <span class="n">bp</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">,</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">rx_ring_dma</span><span class="p">);</span>
		<span class="n">bp</span><span class="o">-&gt;</span><span class="n">rx_ring</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">bp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">B44_FLAG_RX_RING_HACK</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">B44_FLAG_TX_RING_HACK</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dma_unmap_single</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">dma_dev</span><span class="p">,</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">tx_ring_dma</span><span class="p">,</span>
					 <span class="n">DMA_TABLE_BYTES</span><span class="p">,</span> <span class="n">DMA_TO_DEVICE</span><span class="p">);</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">dma_free_coherent</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">dma_dev</span><span class="p">,</span> <span class="n">DMA_TABLE_BYTES</span><span class="p">,</span>
					  <span class="n">bp</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">,</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">tx_ring_dma</span><span class="p">);</span>
		<span class="n">bp</span><span class="o">-&gt;</span><span class="n">tx_ring</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">bp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">B44_FLAG_TX_RING_HACK</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Must not be invoked with interrupt sources disabled and</span>
<span class="cm"> * the hardware shutdown down.  Can sleep.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">b44_alloc_consistent</span><span class="p">(</span><span class="k">struct</span> <span class="n">b44</span> <span class="o">*</span><span class="n">bp</span><span class="p">,</span> <span class="n">gfp_t</span> <span class="n">gfp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">size</span><span class="p">;</span>

	<span class="n">size</span>  <span class="o">=</span> <span class="n">B44_RX_RING_SIZE</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ring_info</span><span class="p">);</span>
	<span class="n">bp</span><span class="o">-&gt;</span><span class="n">rx_buffers</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">gfp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">rx_buffers</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_err</span><span class="p">;</span>

	<span class="n">size</span> <span class="o">=</span> <span class="n">B44_TX_RING_SIZE</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ring_info</span><span class="p">);</span>
	<span class="n">bp</span><span class="o">-&gt;</span><span class="n">tx_buffers</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">gfp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">tx_buffers</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_err</span><span class="p">;</span>

	<span class="n">size</span> <span class="o">=</span> <span class="n">DMA_TABLE_BYTES</span><span class="p">;</span>
	<span class="n">bp</span><span class="o">-&gt;</span><span class="n">rx_ring</span> <span class="o">=</span> <span class="n">dma_alloc_coherent</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">dma_dev</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span>
					 <span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">rx_ring_dma</span><span class="p">,</span> <span class="n">gfp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Allocation may have failed due to pci_alloc_consistent</span>
<span class="cm">		   insisting on use of GFP_DMA, which is more restrictive</span>
<span class="cm">		   than necessary...  */</span>
		<span class="k">struct</span> <span class="n">dma_desc</span> <span class="o">*</span><span class="n">rx_ring</span><span class="p">;</span>
		<span class="n">dma_addr_t</span> <span class="n">rx_ring_dma</span><span class="p">;</span>

		<span class="n">rx_ring</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">gfp</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rx_ring</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_err</span><span class="p">;</span>

		<span class="n">rx_ring_dma</span> <span class="o">=</span> <span class="n">dma_map_single</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">dma_dev</span><span class="p">,</span> <span class="n">rx_ring</span><span class="p">,</span>
					     <span class="n">DMA_TABLE_BYTES</span><span class="p">,</span>
					     <span class="n">DMA_BIDIRECTIONAL</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">dma_mapping_error</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">dma_dev</span><span class="p">,</span> <span class="n">rx_ring_dma</span><span class="p">)</span> <span class="o">||</span>
			<span class="n">rx_ring_dma</span> <span class="o">+</span> <span class="n">size</span> <span class="o">&gt;</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">30</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">rx_ring</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out_err</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">bp</span><span class="o">-&gt;</span><span class="n">rx_ring</span> <span class="o">=</span> <span class="n">rx_ring</span><span class="p">;</span>
		<span class="n">bp</span><span class="o">-&gt;</span><span class="n">rx_ring_dma</span> <span class="o">=</span> <span class="n">rx_ring_dma</span><span class="p">;</span>
		<span class="n">bp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">B44_FLAG_RX_RING_HACK</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">bp</span><span class="o">-&gt;</span><span class="n">tx_ring</span> <span class="o">=</span> <span class="n">dma_alloc_coherent</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">dma_dev</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span>
					 <span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">tx_ring_dma</span><span class="p">,</span> <span class="n">gfp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Allocation may have failed due to ssb_dma_alloc_consistent</span>
<span class="cm">		   insisting on use of GFP_DMA, which is more restrictive</span>
<span class="cm">		   than necessary...  */</span>
		<span class="k">struct</span> <span class="n">dma_desc</span> <span class="o">*</span><span class="n">tx_ring</span><span class="p">;</span>
		<span class="n">dma_addr_t</span> <span class="n">tx_ring_dma</span><span class="p">;</span>

		<span class="n">tx_ring</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">gfp</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tx_ring</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_err</span><span class="p">;</span>

		<span class="n">tx_ring_dma</span> <span class="o">=</span> <span class="n">dma_map_single</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">dma_dev</span><span class="p">,</span> <span class="n">tx_ring</span><span class="p">,</span>
					     <span class="n">DMA_TABLE_BYTES</span><span class="p">,</span>
					     <span class="n">DMA_TO_DEVICE</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">dma_mapping_error</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">dma_dev</span><span class="p">,</span> <span class="n">tx_ring_dma</span><span class="p">)</span> <span class="o">||</span>
			<span class="n">tx_ring_dma</span> <span class="o">+</span> <span class="n">size</span> <span class="o">&gt;</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">30</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">tx_ring</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out_err</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">bp</span><span class="o">-&gt;</span><span class="n">tx_ring</span> <span class="o">=</span> <span class="n">tx_ring</span><span class="p">;</span>
		<span class="n">bp</span><span class="o">-&gt;</span><span class="n">tx_ring_dma</span> <span class="o">=</span> <span class="n">tx_ring_dma</span><span class="p">;</span>
		<span class="n">bp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">B44_FLAG_TX_RING_HACK</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">out_err:</span>
	<span class="n">b44_free_consistent</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* bp-&gt;lock is held. */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">b44_clear_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">b44</span> <span class="o">*</span><span class="n">bp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">reg</span><span class="p">;</span>

	<span class="n">bw32</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">B44_MIB_CTRL</span><span class="p">,</span> <span class="n">MIB_CTRL_CLR_ON_READ</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">reg</span> <span class="o">=</span> <span class="n">B44_TX_GOOD_O</span><span class="p">;</span> <span class="n">reg</span> <span class="o">&lt;=</span> <span class="n">B44_TX_PAUSE</span><span class="p">;</span> <span class="n">reg</span> <span class="o">+=</span> <span class="mi">4UL</span><span class="p">)</span>
		<span class="n">br32</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">reg</span> <span class="o">=</span> <span class="n">B44_RX_GOOD_O</span><span class="p">;</span> <span class="n">reg</span> <span class="o">&lt;=</span> <span class="n">B44_RX_NPAUSE</span><span class="p">;</span> <span class="n">reg</span> <span class="o">+=</span> <span class="mi">4UL</span><span class="p">)</span>
		<span class="n">br32</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* bp-&gt;lock is held. */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">b44_chip_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">b44</span> <span class="o">*</span><span class="n">bp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reset_kind</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ssb_device</span> <span class="o">*</span><span class="n">sdev</span> <span class="o">=</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">sdev</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">was_enabled</span><span class="p">;</span>

	<span class="n">was_enabled</span> <span class="o">=</span> <span class="n">ssb_device_is_enabled</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">sdev</span><span class="p">);</span>

	<span class="n">ssb_device_enable</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">sdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">ssb_pcicore_dev_irqvecs_enable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">pcicore</span><span class="p">,</span> <span class="n">sdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">was_enabled</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bw32</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">B44_RCV_LAZY</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">bw32</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">B44_ENET_CTRL</span><span class="p">,</span> <span class="n">ENET_CTRL_DISABLE</span><span class="p">);</span>
		<span class="n">b44_wait_bit</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">B44_ENET_CTRL</span><span class="p">,</span> <span class="n">ENET_CTRL_DISABLE</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">bw32</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">B44_DMATX_CTRL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">bp</span><span class="o">-&gt;</span><span class="n">tx_prod</span> <span class="o">=</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">tx_cons</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">br32</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">B44_DMARX_STAT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">DMARX_STAT_EMASK</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">b44_wait_bit</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">B44_DMARX_STAT</span><span class="p">,</span> <span class="n">DMARX_STAT_SIDLE</span><span class="p">,</span>
				     <span class="mi">100</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">bw32</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">B44_DMARX_CTRL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">bp</span><span class="o">-&gt;</span><span class="n">rx_prod</span> <span class="o">=</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">rx_cons</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">b44_clear_stats</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Don&#39;t enable PHY if we are doing a partial reset</span>
<span class="cm">	 * we are probably going to power down</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reset_kind</span> <span class="o">==</span> <span class="n">B44_CHIP_RESET_PARTIAL</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">bustype</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SSB_BUSTYPE_SSB</span>:
		<span class="n">bw32</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">B44_MDIO_CTRL</span><span class="p">,</span> <span class="p">(</span><span class="n">MDIO_CTRL_PREAMBLE</span> <span class="o">|</span>
		     <span class="p">(</span><span class="n">DIV_ROUND_CLOSEST</span><span class="p">(</span><span class="n">ssb_clockspeed</span><span class="p">(</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">),</span>
					<span class="n">B44_MDC_RATIO</span><span class="p">)</span>
		     <span class="o">&amp;</span> <span class="n">MDIO_CTRL_MAXF_MASK</span><span class="p">)));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SSB_BUSTYPE_PCI</span>:
		<span class="n">bw32</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">B44_MDIO_CTRL</span><span class="p">,</span> <span class="p">(</span><span class="n">MDIO_CTRL_PREAMBLE</span> <span class="o">|</span>
		     <span class="p">(</span><span class="mh">0x0d</span> <span class="o">&amp;</span> <span class="n">MDIO_CTRL_MAXF_MASK</span><span class="p">)));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SSB_BUSTYPE_PCMCIA</span>:
	<span class="k">case</span> <span class="n">SSB_BUSTYPE_SDIO</span>:
		<span class="n">WARN_ON</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span> <span class="cm">/* A device with this bus does not exist. */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">br32</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">B44_MDIO_CTRL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">br32</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">B44_DEVCTRL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">DEVCTRL_IPP</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">bw32</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">B44_ENET_CTRL</span><span class="p">,</span> <span class="n">ENET_CTRL_EPSEL</span><span class="p">);</span>
		<span class="n">br32</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">B44_ENET_CTRL</span><span class="p">);</span>
		<span class="n">bp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">B44_FLAG_INTERNAL_PHY</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">val</span> <span class="o">=</span> <span class="n">br32</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">B44_DEVCTRL</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">DEVCTRL_EPR</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">bw32</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">B44_DEVCTRL</span><span class="p">,</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">DEVCTRL_EPR</span><span class="p">));</span>
			<span class="n">br32</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">B44_DEVCTRL</span><span class="p">);</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">bp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">B44_FLAG_INTERNAL_PHY</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* bp-&gt;lock is held. */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">b44_halt</span><span class="p">(</span><span class="k">struct</span> <span class="n">b44</span> <span class="o">*</span><span class="n">bp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">b44_disable_ints</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
	<span class="cm">/* reset PHY */</span>
	<span class="n">b44_phy_reset</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
	<span class="cm">/* power down PHY */</span>
	<span class="n">netdev_info</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;powering down PHY</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">bw32</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">B44_MAC_CTRL</span><span class="p">,</span> <span class="n">MAC_CTRL_PHY_PDOWN</span><span class="p">);</span>
	<span class="cm">/* now reset the chip, but without enabling the MAC&amp;PHY</span>
<span class="cm">	 * part of it. This has to be done _after_ we shut down the PHY */</span>
	<span class="n">b44_chip_reset</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">B44_CHIP_RESET_PARTIAL</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* bp-&gt;lock is held. */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">__b44_set_mac_addr</span><span class="p">(</span><span class="k">struct</span> <span class="n">b44</span> <span class="o">*</span><span class="n">bp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bw32</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">B44_CAM_CTRL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_PROMISC</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>

		<span class="n">__b44_cam_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">br32</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">B44_CAM_CTRL</span><span class="p">);</span>
		<span class="n">bw32</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">B44_CAM_CTRL</span><span class="p">,</span> <span class="n">val</span> <span class="o">|</span> <span class="n">CAM_CTRL_ENABLE</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">b44_set_mac_addr</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">b44</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="n">addr</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">netif_running</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_valid_ether_addr</span><span class="p">(</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">sa_data</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">addr</span><span class="o">-&gt;</span><span class="n">sa_data</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">addr_len</span><span class="p">);</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">br32</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">B44_RXCONFIG</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">RXCONFIG_CAM_ABSENT</span><span class="p">))</span>
		<span class="n">__b44_set_mac_addr</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>

	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Called at device open time to get the chip ready for</span>
<span class="cm"> * packet processing.  Invoked with bp-&gt;lock held.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__b44_set_rx_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">b44_init_hw</span><span class="p">(</span><span class="k">struct</span> <span class="n">b44</span> <span class="o">*</span><span class="n">bp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reset_kind</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">b44_chip_reset</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">B44_CHIP_RESET_FULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reset_kind</span> <span class="o">==</span> <span class="n">B44_FULL_RESET</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">b44_phy_reset</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
		<span class="n">b44_setup_phy</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Enable CRC32, set proper LED modes and power on PHY */</span>
	<span class="n">bw32</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">B44_MAC_CTRL</span><span class="p">,</span> <span class="n">MAC_CTRL_CRC32_ENAB</span> <span class="o">|</span> <span class="n">MAC_CTRL_PHY_LEDCTRL</span><span class="p">);</span>
	<span class="n">bw32</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">B44_RCV_LAZY</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">RCV_LAZY_FC_SHIFT</span><span class="p">));</span>

	<span class="cm">/* This sets the MAC address too.  */</span>
	<span class="n">__b44_set_rx_mode</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* MTU + eth header + possible VLAN tag + struct rx_header */</span>
	<span class="n">bw32</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">B44_RXMAXLEN</span><span class="p">,</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mtu</span> <span class="o">+</span> <span class="n">ETH_HLEN</span> <span class="o">+</span> <span class="mi">8</span> <span class="o">+</span> <span class="n">RX_HEADER_LEN</span><span class="p">);</span>
	<span class="n">bw32</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">B44_TXMAXLEN</span><span class="p">,</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mtu</span> <span class="o">+</span> <span class="n">ETH_HLEN</span> <span class="o">+</span> <span class="mi">8</span> <span class="o">+</span> <span class="n">RX_HEADER_LEN</span><span class="p">);</span>

	<span class="n">bw32</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">B44_TX_WMARK</span><span class="p">,</span> <span class="mi">56</span><span class="p">);</span> <span class="cm">/* XXX magic */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reset_kind</span> <span class="o">==</span> <span class="n">B44_PARTIAL_RESET</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bw32</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">B44_DMARX_CTRL</span><span class="p">,</span> <span class="p">(</span><span class="n">DMARX_CTRL_ENABLE</span> <span class="o">|</span>
				      <span class="p">(</span><span class="n">RX_PKT_OFFSET</span> <span class="o">&lt;&lt;</span> <span class="n">DMARX_CTRL_ROSHIFT</span><span class="p">)));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">bw32</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">B44_DMATX_CTRL</span><span class="p">,</span> <span class="n">DMATX_CTRL_ENABLE</span><span class="p">);</span>
		<span class="n">bw32</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">B44_DMATX_ADDR</span><span class="p">,</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">tx_ring_dma</span> <span class="o">+</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">dma_offset</span><span class="p">);</span>
		<span class="n">bw32</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">B44_DMARX_CTRL</span><span class="p">,</span> <span class="p">(</span><span class="n">DMARX_CTRL_ENABLE</span> <span class="o">|</span>
				      <span class="p">(</span><span class="n">RX_PKT_OFFSET</span> <span class="o">&lt;&lt;</span> <span class="n">DMARX_CTRL_ROSHIFT</span><span class="p">)));</span>
		<span class="n">bw32</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">B44_DMARX_ADDR</span><span class="p">,</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">rx_ring_dma</span> <span class="o">+</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">dma_offset</span><span class="p">);</span>

		<span class="n">bw32</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">B44_DMARX_PTR</span><span class="p">,</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">rx_pending</span><span class="p">);</span>
		<span class="n">bp</span><span class="o">-&gt;</span><span class="n">rx_prod</span> <span class="o">=</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">rx_pending</span><span class="p">;</span>

		<span class="n">bw32</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">B44_MIB_CTRL</span><span class="p">,</span> <span class="n">MIB_CTRL_CLR_ON_READ</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">br32</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">B44_ENET_CTRL</span><span class="p">);</span>
	<span class="n">bw32</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">B44_ENET_CTRL</span><span class="p">,</span> <span class="p">(</span><span class="n">val</span> <span class="o">|</span> <span class="n">ENET_CTRL_ENABLE</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">b44_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">b44</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">b44_alloc_consistent</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">napi_enable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">);</span>

	<span class="n">b44_init_rings</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
	<span class="n">b44_init_hw</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">B44_FULL_RESET</span><span class="p">);</span>

	<span class="n">b44_check_phy</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">b44_interrupt</span><span class="p">,</span> <span class="n">IRQF_SHARED</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">napi_disable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">);</span>
		<span class="n">b44_chip_reset</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">B44_CHIP_RESET_PARTIAL</span><span class="p">);</span>
		<span class="n">b44_free_rings</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
		<span class="n">b44_free_consistent</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">init_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
	<span class="n">bp</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">HZ</span><span class="p">;</span>
	<span class="n">bp</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">bp</span><span class="p">;</span>
	<span class="n">bp</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="n">b44_timer</span><span class="p">;</span>
	<span class="n">add_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>

	<span class="n">b44_enable_ints</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
	<span class="n">netif_start_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_NET_POLL_CONTROLLER</span>
<span class="cm">/*</span>
<span class="cm"> * Polling receive - used by netconsole and other diagnostic tools</span>
<span class="cm"> * to allow network i/o with interrupts disabled.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">b44_poll_controller</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">disable_irq</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
	<span class="n">b44_interrupt</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="n">enable_irq</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bwfilter_table</span><span class="p">(</span><span class="k">struct</span> <span class="n">b44</span> <span class="o">*</span><span class="n">bp</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">pp</span><span class="p">,</span> <span class="n">u32</span> <span class="n">bytes</span><span class="p">,</span> <span class="n">u32</span> <span class="n">table_offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">pattern</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span> <span class="n">pp</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">bytes</span><span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">bw32</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">B44_FILT_ADDR</span><span class="p">,</span> <span class="n">table_offset</span> <span class="o">+</span> <span class="n">i</span><span class="p">);</span>
		<span class="n">bw32</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">B44_FILT_DATA</span><span class="p">,</span> <span class="n">pattern</span><span class="p">[</span><span class="n">i</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">)]);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">b44_magic_pattern</span><span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="n">macaddr</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">ppattern</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">pmask</span><span class="p">,</span> <span class="kt">int</span> <span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">magicsync</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">k</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">len</span> <span class="o">=</span> <span class="n">offset</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ethaddr_bytes</span> <span class="o">=</span> <span class="n">ETH_ALEN</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">ppattern</span> <span class="o">+</span> <span class="n">offset</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">magicsync</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">magicsync</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">len</span><span class="o">++</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="p">)</span> <span class="n">pmask</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">B44_MAX_PATTERNS</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">B44_PATTERN_SIZE</span> <span class="o">-</span> <span class="n">len</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">ETH_ALEN</span><span class="p">)</span>
			<span class="n">ethaddr_bytes</span> <span class="o">=</span> <span class="n">ETH_ALEN</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">ethaddr_bytes</span> <span class="o">=</span> <span class="n">B44_PATTERN_SIZE</span> <span class="o">-</span> <span class="n">len</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ethaddr_bytes</span> <span class="o">&lt;=</span><span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">k</span><span class="o">&lt;</span> <span class="n">ethaddr_bytes</span><span class="p">;</span> <span class="n">k</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ppattern</span><span class="p">[</span><span class="n">offset</span> <span class="o">+</span> <span class="n">magicsync</span> <span class="o">+</span>
				<span class="p">(</span><span class="n">j</span> <span class="o">*</span> <span class="n">ETH_ALEN</span><span class="p">)</span> <span class="o">+</span> <span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">macaddr</span><span class="p">[</span><span class="n">k</span><span class="p">];</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">len</span><span class="o">++</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="p">)</span> <span class="n">pmask</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Setup magic packet patterns in the b44 WOL</span>
<span class="cm"> * pattern matching filter.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">b44_setup_pseudo_magicp</span><span class="p">(</span><span class="k">struct</span> <span class="n">b44</span> <span class="o">*</span><span class="n">bp</span><span class="p">)</span>
<span class="p">{</span>

	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">plen0</span><span class="p">,</span> <span class="n">plen1</span><span class="p">,</span> <span class="n">plen2</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">pwol_pattern</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">pwol_mask</span><span class="p">[</span><span class="n">B44_PMASK_SIZE</span><span class="p">];</span>

	<span class="n">pwol_pattern</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">B44_PATTERN_SIZE</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pwol_pattern</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Memory not available for WOL</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Ipv4 magic packet pattern - pattern 0.*/</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">pwol_mask</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">B44_PMASK_SIZE</span><span class="p">);</span>
	<span class="n">plen0</span> <span class="o">=</span> <span class="n">b44_magic_pattern</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">pwol_pattern</span><span class="p">,</span> <span class="n">pwol_mask</span><span class="p">,</span>
				  <span class="n">B44_ETHIPV4UDP_HLEN</span><span class="p">);</span>

   	<span class="n">bwfilter_table</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">pwol_pattern</span><span class="p">,</span> <span class="n">B44_PATTERN_SIZE</span><span class="p">,</span> <span class="n">B44_PATTERN_BASE</span><span class="p">);</span>
   	<span class="n">bwfilter_table</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">pwol_mask</span><span class="p">,</span> <span class="n">B44_PMASK_SIZE</span><span class="p">,</span> <span class="n">B44_PMASK_BASE</span><span class="p">);</span>

	<span class="cm">/* Raw ethernet II magic packet pattern - pattern 1 */</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">pwol_pattern</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">B44_PATTERN_SIZE</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">pwol_mask</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">B44_PMASK_SIZE</span><span class="p">);</span>
	<span class="n">plen1</span> <span class="o">=</span> <span class="n">b44_magic_pattern</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">pwol_pattern</span><span class="p">,</span> <span class="n">pwol_mask</span><span class="p">,</span>
				  <span class="n">ETH_HLEN</span><span class="p">);</span>

   	<span class="n">bwfilter_table</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">pwol_pattern</span><span class="p">,</span> <span class="n">B44_PATTERN_SIZE</span><span class="p">,</span>
		       <span class="n">B44_PATTERN_BASE</span> <span class="o">+</span> <span class="n">B44_PATTERN_SIZE</span><span class="p">);</span>
  	<span class="n">bwfilter_table</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">pwol_mask</span><span class="p">,</span> <span class="n">B44_PMASK_SIZE</span><span class="p">,</span>
		       <span class="n">B44_PMASK_BASE</span> <span class="o">+</span> <span class="n">B44_PMASK_SIZE</span><span class="p">);</span>

	<span class="cm">/* Ipv6 magic packet pattern - pattern 2 */</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">pwol_pattern</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">B44_PATTERN_SIZE</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">pwol_mask</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">B44_PMASK_SIZE</span><span class="p">);</span>
	<span class="n">plen2</span> <span class="o">=</span> <span class="n">b44_magic_pattern</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">pwol_pattern</span><span class="p">,</span> <span class="n">pwol_mask</span><span class="p">,</span>
				  <span class="n">B44_ETHIPV6UDP_HLEN</span><span class="p">);</span>

   	<span class="n">bwfilter_table</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">pwol_pattern</span><span class="p">,</span> <span class="n">B44_PATTERN_SIZE</span><span class="p">,</span>
		       <span class="n">B44_PATTERN_BASE</span> <span class="o">+</span> <span class="n">B44_PATTERN_SIZE</span> <span class="o">+</span> <span class="n">B44_PATTERN_SIZE</span><span class="p">);</span>
  	<span class="n">bwfilter_table</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">pwol_mask</span><span class="p">,</span> <span class="n">B44_PMASK_SIZE</span><span class="p">,</span>
		       <span class="n">B44_PMASK_BASE</span> <span class="o">+</span> <span class="n">B44_PMASK_SIZE</span> <span class="o">+</span> <span class="n">B44_PMASK_SIZE</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">pwol_pattern</span><span class="p">);</span>

	<span class="cm">/* set these pattern&#39;s lengths: one less than each real length */</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">plen0</span> <span class="o">|</span> <span class="p">(</span><span class="n">plen1</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">plen2</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="n">WKUP_LEN_ENABLE_THREE</span><span class="p">;</span>
	<span class="n">bw32</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">B44_WKUP_LEN</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

	<span class="cm">/* enable wakeup pattern matching */</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">br32</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">B44_DEVCTRL</span><span class="p">);</span>
	<span class="n">bw32</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">B44_DEVCTRL</span><span class="p">,</span> <span class="n">val</span> <span class="o">|</span> <span class="n">DEVCTRL_PFE</span><span class="p">);</span>

<span class="p">}</span>

<span class="cp">#ifdef CONFIG_B44_PCI</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">b44_setup_wol_pci</span><span class="p">(</span><span class="k">struct</span> <span class="n">b44</span> <span class="o">*</span><span class="n">bp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">val</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">bustype</span> <span class="o">!=</span> <span class="n">SSB_BUSTYPE_SSB</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bw32</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">SSB_TMSLOW</span><span class="p">,</span> <span class="n">br32</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">SSB_TMSLOW</span><span class="p">)</span> <span class="o">|</span> <span class="n">SSB_TMSLOW_PE</span><span class="p">);</span>
		<span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">host_pci</span><span class="p">,</span> <span class="n">SSB_PMCSR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
		<span class="n">pci_write_config_word</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">host_pci</span><span class="p">,</span> <span class="n">SSB_PMCSR</span><span class="p">,</span> <span class="n">val</span> <span class="o">|</span> <span class="n">SSB_PE</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="cp">#else</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">b44_setup_wol_pci</span><span class="p">(</span><span class="k">struct</span> <span class="n">b44</span> <span class="o">*</span><span class="n">bp</span><span class="p">)</span> <span class="p">{</span> <span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_B44_PCI */</span><span class="cp"></span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">b44_setup_wol</span><span class="p">(</span><span class="k">struct</span> <span class="n">b44</span> <span class="o">*</span><span class="n">bp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">bw32</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">B44_RXCONFIG</span><span class="p">,</span> <span class="n">RXCONFIG_ALLMULTI</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">B44_FLAG_B0_ANDLATER</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">bw32</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">B44_WKUP_LEN</span><span class="p">,</span> <span class="n">WKUP_LEN_DISABLE</span><span class="p">);</span>

		<span class="n">val</span> <span class="o">=</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span> <span class="o">|</span>
			<span class="n">bp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span> <span class="o">|</span>
			<span class="n">bp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span> <span class="o">|</span>
			<span class="n">bp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
		<span class="n">bw32</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">B44_ADDR_LO</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

		<span class="n">val</span> <span class="o">=</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span> <span class="o">|</span>
			<span class="n">bp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
		<span class="n">bw32</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">B44_ADDR_HI</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

		<span class="n">val</span> <span class="o">=</span> <span class="n">br32</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">B44_DEVCTRL</span><span class="p">);</span>
		<span class="n">bw32</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">B44_DEVCTRL</span><span class="p">,</span> <span class="n">val</span> <span class="o">|</span> <span class="n">DEVCTRL_MPM</span> <span class="o">|</span> <span class="n">DEVCTRL_PFE</span><span class="p">);</span>

 	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
 		<span class="n">b44_setup_pseudo_magicp</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
 	<span class="p">}</span>
	<span class="n">b44_setup_wol_pci</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">b44_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">b44</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">napi_disable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">);</span>

	<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">b44_halt</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
	<span class="n">b44_free_rings</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
	<span class="n">netif_carrier_off</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">free_irq</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">B44_FLAG_WOL_ENABLE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">b44_init_hw</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">B44_PARTIAL_RESET</span><span class="p">);</span>
		<span class="n">b44_setup_wol</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">b44_free_consistent</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">net_device_stats</span> <span class="o">*</span><span class="nf">b44_get_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">b44</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">net_device_stats</span> <span class="o">*</span><span class="n">nstat</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">b44_hw_stats</span> <span class="o">*</span><span class="n">hwstat</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">hw_stats</span><span class="p">;</span>

	<span class="cm">/* Convert HW stats into netdevice stats. */</span>
	<span class="n">nstat</span><span class="o">-&gt;</span><span class="n">rx_packets</span> <span class="o">=</span> <span class="n">hwstat</span><span class="o">-&gt;</span><span class="n">rx_pkts</span><span class="p">;</span>
	<span class="n">nstat</span><span class="o">-&gt;</span><span class="n">tx_packets</span> <span class="o">=</span> <span class="n">hwstat</span><span class="o">-&gt;</span><span class="n">tx_pkts</span><span class="p">;</span>
	<span class="n">nstat</span><span class="o">-&gt;</span><span class="n">rx_bytes</span>   <span class="o">=</span> <span class="n">hwstat</span><span class="o">-&gt;</span><span class="n">rx_octets</span><span class="p">;</span>
	<span class="n">nstat</span><span class="o">-&gt;</span><span class="n">tx_bytes</span>   <span class="o">=</span> <span class="n">hwstat</span><span class="o">-&gt;</span><span class="n">tx_octets</span><span class="p">;</span>
	<span class="n">nstat</span><span class="o">-&gt;</span><span class="n">tx_errors</span>  <span class="o">=</span> <span class="p">(</span><span class="n">hwstat</span><span class="o">-&gt;</span><span class="n">tx_jabber_pkts</span> <span class="o">+</span>
			     <span class="n">hwstat</span><span class="o">-&gt;</span><span class="n">tx_oversize_pkts</span> <span class="o">+</span>
			     <span class="n">hwstat</span><span class="o">-&gt;</span><span class="n">tx_underruns</span> <span class="o">+</span>
			     <span class="n">hwstat</span><span class="o">-&gt;</span><span class="n">tx_excessive_cols</span> <span class="o">+</span>
			     <span class="n">hwstat</span><span class="o">-&gt;</span><span class="n">tx_late_cols</span><span class="p">);</span>
	<span class="n">nstat</span><span class="o">-&gt;</span><span class="n">multicast</span>  <span class="o">=</span> <span class="n">hwstat</span><span class="o">-&gt;</span><span class="n">tx_multicast_pkts</span><span class="p">;</span>
	<span class="n">nstat</span><span class="o">-&gt;</span><span class="n">collisions</span> <span class="o">=</span> <span class="n">hwstat</span><span class="o">-&gt;</span><span class="n">tx_total_cols</span><span class="p">;</span>

	<span class="n">nstat</span><span class="o">-&gt;</span><span class="n">rx_length_errors</span> <span class="o">=</span> <span class="p">(</span><span class="n">hwstat</span><span class="o">-&gt;</span><span class="n">rx_oversize_pkts</span> <span class="o">+</span>
				   <span class="n">hwstat</span><span class="o">-&gt;</span><span class="n">rx_undersize</span><span class="p">);</span>
	<span class="n">nstat</span><span class="o">-&gt;</span><span class="n">rx_over_errors</span>   <span class="o">=</span> <span class="n">hwstat</span><span class="o">-&gt;</span><span class="n">rx_missed_pkts</span><span class="p">;</span>
	<span class="n">nstat</span><span class="o">-&gt;</span><span class="n">rx_frame_errors</span>  <span class="o">=</span> <span class="n">hwstat</span><span class="o">-&gt;</span><span class="n">rx_align_errs</span><span class="p">;</span>
	<span class="n">nstat</span><span class="o">-&gt;</span><span class="n">rx_crc_errors</span>    <span class="o">=</span> <span class="n">hwstat</span><span class="o">-&gt;</span><span class="n">rx_crc_errs</span><span class="p">;</span>
	<span class="n">nstat</span><span class="o">-&gt;</span><span class="n">rx_errors</span>        <span class="o">=</span> <span class="p">(</span><span class="n">hwstat</span><span class="o">-&gt;</span><span class="n">rx_jabber_pkts</span> <span class="o">+</span>
				   <span class="n">hwstat</span><span class="o">-&gt;</span><span class="n">rx_oversize_pkts</span> <span class="o">+</span>
				   <span class="n">hwstat</span><span class="o">-&gt;</span><span class="n">rx_missed_pkts</span> <span class="o">+</span>
				   <span class="n">hwstat</span><span class="o">-&gt;</span><span class="n">rx_crc_align_errs</span> <span class="o">+</span>
				   <span class="n">hwstat</span><span class="o">-&gt;</span><span class="n">rx_undersize</span> <span class="o">+</span>
				   <span class="n">hwstat</span><span class="o">-&gt;</span><span class="n">rx_crc_errs</span> <span class="o">+</span>
				   <span class="n">hwstat</span><span class="o">-&gt;</span><span class="n">rx_align_errs</span> <span class="o">+</span>
				   <span class="n">hwstat</span><span class="o">-&gt;</span><span class="n">rx_symbol_errs</span><span class="p">);</span>

	<span class="n">nstat</span><span class="o">-&gt;</span><span class="n">tx_aborted_errors</span> <span class="o">=</span> <span class="n">hwstat</span><span class="o">-&gt;</span><span class="n">tx_underruns</span><span class="p">;</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">	/* Carrier lost counter seems to be broken for some devices */</span>
<span class="c">	nstat-&gt;tx_carrier_errors = hwstat-&gt;tx_carrier_lost;</span>
<span class="cp">#endif</span>

	<span class="k">return</span> <span class="n">nstat</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">__b44_load_mcast</span><span class="p">(</span><span class="k">struct</span> <span class="n">b44</span> <span class="o">*</span><span class="n">bp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">netdev_hw_addr</span> <span class="o">*</span><span class="n">ha</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">num_ents</span><span class="p">;</span>

	<span class="n">num_ents</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="n">netdev_mc_count</span><span class="p">(</span><span class="n">dev</span><span class="p">),</span> <span class="n">B44_MCAST_TABLE_SIZE</span><span class="p">);</span>
	<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">netdev_for_each_mc_addr</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">num_ents</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">__b44_cam_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">i</span><span class="o">++</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">__b44_set_rx_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">b44</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">br32</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">B44_RXCONFIG</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">RXCONFIG_PROMISC</span> <span class="o">|</span> <span class="n">RXCONFIG_ALLMULTI</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_PROMISC</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">RXCONFIG_CAM_ABSENT</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">RXCONFIG_PROMISC</span><span class="p">;</span>
		<span class="n">bw32</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">B44_RXCONFIG</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">zero</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">};</span>
		<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="n">__b44_set_mac_addr</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_ALLMULTI</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">netdev_mc_count</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">B44_MCAST_TABLE_SIZE</span><span class="p">))</span>
			<span class="n">val</span> <span class="o">|=</span> <span class="n">RXCONFIG_ALLMULTI</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">i</span> <span class="o">=</span> <span class="n">__b44_load_mcast</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>

		<span class="k">for</span> <span class="p">(;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">64</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">__b44_cam_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">zero</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>

		<span class="n">bw32</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">B44_RXCONFIG</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
        	<span class="n">val</span> <span class="o">=</span> <span class="n">br32</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">B44_CAM_CTRL</span><span class="p">);</span>
	        <span class="n">bw32</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">B44_CAM_CTRL</span><span class="p">,</span> <span class="n">val</span> <span class="o">|</span> <span class="n">CAM_CTRL_ENABLE</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">b44_set_rx_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">b44</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">__b44_set_rx_mode</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">b44_get_msglevel</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">b44</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">msg_enable</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">b44_set_msglevel</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">b44</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">bp</span><span class="o">-&gt;</span><span class="n">msg_enable</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">b44_get_drvinfo</span> <span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ethtool_drvinfo</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">b44</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ssb_bus</span> <span class="o">*</span><span class="n">bus</span> <span class="o">=</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">;</span>

	<span class="n">strlcpy</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">,</span> <span class="n">DRV_MODULE_NAME</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">));</span>
	<span class="n">strlcpy</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">,</span> <span class="n">DRV_MODULE_VERSION</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">));</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">bustype</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SSB_BUSTYPE_PCI</span>:
		<span class="n">strlcpy</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">bus_info</span><span class="p">,</span> <span class="n">pci_name</span><span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">host_pci</span><span class="p">),</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">bus_info</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SSB_BUSTYPE_SSB</span>:
		<span class="n">strlcpy</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">bus_info</span><span class="p">,</span> <span class="s">&quot;SSB&quot;</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">bus_info</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SSB_BUSTYPE_PCMCIA</span>:
	<span class="k">case</span> <span class="n">SSB_BUSTYPE_SDIO</span>:
		<span class="n">WARN_ON</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span> <span class="cm">/* A device with this bus does not exist. */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">b44_nway_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">b44</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">bmcr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">b44_readphy</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">MII_BMCR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bmcr</span><span class="p">);</span>
	<span class="n">b44_readphy</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">MII_BMCR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bmcr</span><span class="p">);</span>
	<span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bmcr</span> <span class="o">&amp;</span> <span class="n">BMCR_ANENABLE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">b44_writephy</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">MII_BMCR</span><span class="p">,</span>
			     <span class="n">bmcr</span> <span class="o">|</span> <span class="n">BMCR_ANRESTART</span><span class="p">);</span>
		<span class="n">r</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">b44_get_settings</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ethtool_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">b44</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">supported</span> <span class="o">=</span> <span class="p">(</span><span class="n">SUPPORTED_Autoneg</span><span class="p">);</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">supported</span> <span class="o">|=</span> <span class="p">(</span><span class="n">SUPPORTED_100baseT_Half</span> <span class="o">|</span>
			  <span class="n">SUPPORTED_100baseT_Full</span> <span class="o">|</span>
			  <span class="n">SUPPORTED_10baseT_Half</span> <span class="o">|</span>
			  <span class="n">SUPPORTED_10baseT_Full</span> <span class="o">|</span>
			  <span class="n">SUPPORTED_MII</span><span class="p">);</span>

	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">advertising</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">B44_FLAG_ADV_10HALF</span><span class="p">)</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">advertising</span> <span class="o">|=</span> <span class="n">ADVERTISED_10baseT_Half</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">B44_FLAG_ADV_10FULL</span><span class="p">)</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">advertising</span> <span class="o">|=</span> <span class="n">ADVERTISED_10baseT_Full</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">B44_FLAG_ADV_100HALF</span><span class="p">)</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">advertising</span> <span class="o">|=</span> <span class="n">ADVERTISED_100baseT_Half</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">B44_FLAG_ADV_100FULL</span><span class="p">)</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">advertising</span> <span class="o">|=</span> <span class="n">ADVERTISED_100baseT_Full</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">advertising</span> <span class="o">|=</span> <span class="n">ADVERTISED_Pause</span> <span class="o">|</span> <span class="n">ADVERTISED_Asym_Pause</span><span class="p">;</span>
	<span class="n">ethtool_cmd_speed_set</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="p">((</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">B44_FLAG_100_BASE_T</span><span class="p">)</span> <span class="o">?</span>
				    <span class="n">SPEED_100</span> <span class="o">:</span> <span class="n">SPEED_10</span><span class="p">));</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">duplex</span> <span class="o">=</span> <span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">B44_FLAG_FULL_DUPLEX</span><span class="p">)</span> <span class="o">?</span>
		<span class="n">DUPLEX_FULL</span> <span class="o">:</span> <span class="n">DUPLEX_HALF</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">phy_address</span> <span class="o">=</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">phy_addr</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">transceiver</span> <span class="o">=</span> <span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">B44_FLAG_INTERNAL_PHY</span><span class="p">)</span> <span class="o">?</span>
		<span class="n">XCVR_INTERNAL</span> <span class="o">:</span> <span class="n">XCVR_EXTERNAL</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">autoneg</span> <span class="o">=</span> <span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">B44_FLAG_FORCE_LINK</span><span class="p">)</span> <span class="o">?</span>
		<span class="n">AUTONEG_DISABLE</span> <span class="o">:</span> <span class="n">AUTONEG_ENABLE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">autoneg</span> <span class="o">==</span> <span class="n">AUTONEG_ENABLE</span><span class="p">)</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">advertising</span> <span class="o">|=</span> <span class="n">ADVERTISED_Autoneg</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">netif_running</span><span class="p">(</span><span class="n">dev</span><span class="p">)){</span>
		<span class="n">ethtool_cmd_speed_set</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">duplex</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">maxtxpkt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">maxrxpkt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">b44_set_settings</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ethtool_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">b44</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">speed</span> <span class="o">=</span> <span class="n">ethtool_cmd_speed</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>

	<span class="cm">/* We do not support gigabit. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">autoneg</span> <span class="o">==</span> <span class="n">AUTONEG_ENABLE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">advertising</span> <span class="o">&amp;</span>
		    <span class="p">(</span><span class="n">ADVERTISED_1000baseT_Half</span> <span class="o">|</span>
		     <span class="n">ADVERTISED_1000baseT_Full</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">speed</span> <span class="o">!=</span> <span class="n">SPEED_100</span> <span class="o">&amp;&amp;</span>
		    <span class="n">speed</span> <span class="o">!=</span> <span class="n">SPEED_10</span><span class="p">)</span> <span class="o">||</span>
		   <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">duplex</span> <span class="o">!=</span> <span class="n">DUPLEX_HALF</span> <span class="o">&amp;&amp;</span>
		    <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">duplex</span> <span class="o">!=</span> <span class="n">DUPLEX_FULL</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">autoneg</span> <span class="o">==</span> <span class="n">AUTONEG_ENABLE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">B44_FLAG_FORCE_LINK</span> <span class="o">|</span>
			       <span class="n">B44_FLAG_100_BASE_T</span> <span class="o">|</span>
			       <span class="n">B44_FLAG_FULL_DUPLEX</span> <span class="o">|</span>
			       <span class="n">B44_FLAG_ADV_10HALF</span> <span class="o">|</span>
			       <span class="n">B44_FLAG_ADV_10FULL</span> <span class="o">|</span>
			       <span class="n">B44_FLAG_ADV_100HALF</span> <span class="o">|</span>
			       <span class="n">B44_FLAG_ADV_100FULL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">advertising</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">bp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="p">(</span><span class="n">B44_FLAG_ADV_10HALF</span> <span class="o">|</span>
				      <span class="n">B44_FLAG_ADV_10FULL</span> <span class="o">|</span>
				      <span class="n">B44_FLAG_ADV_100HALF</span> <span class="o">|</span>
				      <span class="n">B44_FLAG_ADV_100FULL</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">advertising</span> <span class="o">&amp;</span> <span class="n">ADVERTISED_10baseT_Half</span><span class="p">)</span>
				<span class="n">bp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">B44_FLAG_ADV_10HALF</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">advertising</span> <span class="o">&amp;</span> <span class="n">ADVERTISED_10baseT_Full</span><span class="p">)</span>
				<span class="n">bp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">B44_FLAG_ADV_10FULL</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">advertising</span> <span class="o">&amp;</span> <span class="n">ADVERTISED_100baseT_Half</span><span class="p">)</span>
				<span class="n">bp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">B44_FLAG_ADV_100HALF</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">advertising</span> <span class="o">&amp;</span> <span class="n">ADVERTISED_100baseT_Full</span><span class="p">)</span>
				<span class="n">bp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">B44_FLAG_ADV_100FULL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">bp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">B44_FLAG_FORCE_LINK</span><span class="p">;</span>
		<span class="n">bp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">B44_FLAG_100_BASE_T</span> <span class="o">|</span> <span class="n">B44_FLAG_FULL_DUPLEX</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">speed</span> <span class="o">==</span> <span class="n">SPEED_100</span><span class="p">)</span>
			<span class="n">bp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">B44_FLAG_100_BASE_T</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">duplex</span> <span class="o">==</span> <span class="n">DUPLEX_FULL</span><span class="p">)</span>
			<span class="n">bp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">B44_FLAG_FULL_DUPLEX</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">netif_running</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="n">b44_setup_phy</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>

	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">b44_get_ringparam</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">ethtool_ringparam</span> <span class="o">*</span><span class="n">ering</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">b44</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">ering</span><span class="o">-&gt;</span><span class="n">rx_max_pending</span> <span class="o">=</span> <span class="n">B44_RX_RING_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">ering</span><span class="o">-&gt;</span><span class="n">rx_pending</span> <span class="o">=</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">rx_pending</span><span class="p">;</span>

	<span class="cm">/* XXX ethtool lacks a tx_max_pending, oops... */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">b44_set_ringparam</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">ethtool_ringparam</span> <span class="o">*</span><span class="n">ering</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">b44</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ering</span><span class="o">-&gt;</span><span class="n">rx_pending</span> <span class="o">&gt;</span> <span class="n">B44_RX_RING_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">ering</span><span class="o">-&gt;</span><span class="n">rx_mini_pending</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">ering</span><span class="o">-&gt;</span><span class="n">rx_jumbo_pending</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">ering</span><span class="o">-&gt;</span><span class="n">tx_pending</span> <span class="o">&gt;</span> <span class="n">B44_TX_RING_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">bp</span><span class="o">-&gt;</span><span class="n">rx_pending</span> <span class="o">=</span> <span class="n">ering</span><span class="o">-&gt;</span><span class="n">rx_pending</span><span class="p">;</span>
	<span class="n">bp</span><span class="o">-&gt;</span><span class="n">tx_pending</span> <span class="o">=</span> <span class="n">ering</span><span class="o">-&gt;</span><span class="n">tx_pending</span><span class="p">;</span>

	<span class="n">b44_halt</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
	<span class="n">b44_init_rings</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
	<span class="n">b44_init_hw</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">B44_FULL_RESET</span><span class="p">);</span>
	<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">b44_enable_ints</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">b44_get_pauseparam</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">ethtool_pauseparam</span> <span class="o">*</span><span class="n">epause</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">b44</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">epause</span><span class="o">-&gt;</span><span class="n">autoneg</span> <span class="o">=</span>
		<span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">B44_FLAG_PAUSE_AUTO</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">epause</span><span class="o">-&gt;</span><span class="n">rx_pause</span> <span class="o">=</span>
		<span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">B44_FLAG_RX_PAUSE</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">epause</span><span class="o">-&gt;</span><span class="n">tx_pause</span> <span class="o">=</span>
		<span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">B44_FLAG_TX_PAUSE</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">b44_set_pauseparam</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">ethtool_pauseparam</span> <span class="o">*</span><span class="n">epause</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">b44</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">epause</span><span class="o">-&gt;</span><span class="n">autoneg</span><span class="p">)</span>
		<span class="n">bp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">B44_FLAG_PAUSE_AUTO</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">bp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">B44_FLAG_PAUSE_AUTO</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">epause</span><span class="o">-&gt;</span><span class="n">rx_pause</span><span class="p">)</span>
		<span class="n">bp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">B44_FLAG_RX_PAUSE</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">bp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">B44_FLAG_RX_PAUSE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">epause</span><span class="o">-&gt;</span><span class="n">tx_pause</span><span class="p">)</span>
		<span class="n">bp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">B44_FLAG_TX_PAUSE</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">bp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">B44_FLAG_TX_PAUSE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">B44_FLAG_PAUSE_AUTO</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">b44_halt</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
		<span class="n">b44_init_rings</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
		<span class="n">b44_init_hw</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">B44_FULL_RESET</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">__b44_set_flow_ctrl</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">b44_enable_ints</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">b44_get_strings</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">stringset</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span><span class="p">(</span><span class="n">stringset</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ETH_SS_STATS</span>:
		<span class="n">memcpy</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="o">*</span><span class="n">b44_gstrings</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">b44_gstrings</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">b44_get_sset_count</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">sset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">sset</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ETH_SS_STATS</span>:
		<span class="k">return</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">b44_gstrings</span><span class="p">);</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">b44_get_ethtool_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">ethtool_stats</span> <span class="o">*</span><span class="n">stats</span><span class="p">,</span> <span class="n">u64</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">b44</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">val</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">hw_stats</span><span class="p">.</span><span class="n">tx_good_octets</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">b44_stats_update</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">b44_gstrings</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="o">*</span><span class="n">data</span><span class="o">++</span> <span class="o">=</span> <span class="o">*</span><span class="n">val</span><span class="o">++</span><span class="p">;</span>

	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">b44_get_wol</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ethtool_wolinfo</span> <span class="o">*</span><span class="n">wol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">b44</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">wol</span><span class="o">-&gt;</span><span class="n">supported</span> <span class="o">=</span> <span class="n">WAKE_MAGIC</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">B44_FLAG_WOL_ENABLE</span><span class="p">)</span>
		<span class="n">wol</span><span class="o">-&gt;</span><span class="n">wolopts</span> <span class="o">=</span> <span class="n">WAKE_MAGIC</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">wol</span><span class="o">-&gt;</span><span class="n">wolopts</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wol</span><span class="o">-&gt;</span><span class="n">sopass</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">wol</span><span class="o">-&gt;</span><span class="n">sopass</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">b44_set_wol</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ethtool_wolinfo</span> <span class="o">*</span><span class="n">wol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">b44</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wol</span><span class="o">-&gt;</span><span class="n">wolopts</span> <span class="o">&amp;</span> <span class="n">WAKE_MAGIC</span><span class="p">)</span>
		<span class="n">bp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">B44_FLAG_WOL_ENABLE</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">bp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">B44_FLAG_WOL_ENABLE</span><span class="p">;</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ethtool_ops</span> <span class="n">b44_ethtool_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">get_drvinfo</span>		<span class="o">=</span> <span class="n">b44_get_drvinfo</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_settings</span>		<span class="o">=</span> <span class="n">b44_get_settings</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_settings</span>		<span class="o">=</span> <span class="n">b44_set_settings</span><span class="p">,</span>
	<span class="p">.</span><span class="n">nway_reset</span>		<span class="o">=</span> <span class="n">b44_nway_reset</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_link</span>		<span class="o">=</span> <span class="n">ethtool_op_get_link</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_wol</span>		<span class="o">=</span> <span class="n">b44_get_wol</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_wol</span>		<span class="o">=</span> <span class="n">b44_set_wol</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_ringparam</span>		<span class="o">=</span> <span class="n">b44_get_ringparam</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_ringparam</span>		<span class="o">=</span> <span class="n">b44_set_ringparam</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_pauseparam</span>		<span class="o">=</span> <span class="n">b44_get_pauseparam</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_pauseparam</span>		<span class="o">=</span> <span class="n">b44_set_pauseparam</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_msglevel</span>		<span class="o">=</span> <span class="n">b44_get_msglevel</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_msglevel</span>		<span class="o">=</span> <span class="n">b44_set_msglevel</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_strings</span>		<span class="o">=</span> <span class="n">b44_get_strings</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_sset_count</span>		<span class="o">=</span> <span class="n">b44_get_sset_count</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_ethtool_stats</span>	<span class="o">=</span> <span class="n">b44_get_ethtool_stats</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">b44_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ifreq</span> <span class="o">*</span><span class="n">ifr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mii_ioctl_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">if_mii</span><span class="p">(</span><span class="n">ifr</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">b44</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">netif_running</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">generic_mii_ioctl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">mii_if</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">b44_get_invariants</span><span class="p">(</span><span class="k">struct</span> <span class="n">b44</span> <span class="o">*</span><span class="n">bp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ssb_device</span> <span class="o">*</span><span class="n">sdev</span> <span class="o">=</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">sdev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">addr</span><span class="p">;</span>

	<span class="n">bp</span><span class="o">-&gt;</span><span class="n">dma_offset</span> <span class="o">=</span> <span class="n">ssb_dma_translation</span><span class="p">(</span><span class="n">sdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">bustype</span> <span class="o">==</span> <span class="n">SSB_BUSTYPE_SSB</span> <span class="o">&amp;&amp;</span>
	    <span class="n">instance</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">addr</span> <span class="o">=</span> <span class="n">sdev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">sprom</span><span class="p">.</span><span class="n">et1mac</span><span class="p">;</span>
		<span class="n">bp</span><span class="o">-&gt;</span><span class="n">phy_addr</span> <span class="o">=</span> <span class="n">sdev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">sprom</span><span class="p">.</span><span class="n">et1phyaddr</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">addr</span> <span class="o">=</span> <span class="n">sdev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">sprom</span><span class="p">.</span><span class="n">et0mac</span><span class="p">;</span>
		<span class="n">bp</span><span class="o">-&gt;</span><span class="n">phy_addr</span> <span class="o">=</span> <span class="n">sdev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">sprom</span><span class="p">.</span><span class="n">et0phyaddr</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* Some ROMs have buggy PHY addresses with the high</span>
<span class="cm">	 * bits set (sign extension?). Truncate them to a</span>
<span class="cm">	 * valid PHY address. */</span>
	<span class="n">bp</span><span class="o">-&gt;</span><span class="n">phy_addr</span> <span class="o">&amp;=</span> <span class="mh">0x1F</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_valid_ether_addr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">0</span><span class="p">])){</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Invalid MAC address found in EEPROM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">perm_addr</span><span class="p">,</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">addr_len</span><span class="p">);</span>

	<span class="n">bp</span><span class="o">-&gt;</span><span class="n">imask</span> <span class="o">=</span> <span class="n">IMASK_DEF</span><span class="p">;</span>

	<span class="cm">/* XXX - really required?</span>
<span class="cm">	   bp-&gt;flags |= B44_FLAG_BUGGY_TXPTR;</span>
<span class="cm">	*/</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">revision</span> <span class="o">&gt;=</span> <span class="mi">7</span><span class="p">)</span>
		<span class="n">bp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">B44_FLAG_B0_ANDLATER</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">net_device_ops</span> <span class="n">b44_netdev_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">ndo_open</span>		<span class="o">=</span> <span class="n">b44_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_stop</span>		<span class="o">=</span> <span class="n">b44_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_start_xmit</span>		<span class="o">=</span> <span class="n">b44_start_xmit</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_get_stats</span>		<span class="o">=</span> <span class="n">b44_get_stats</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_set_rx_mode</span>	<span class="o">=</span> <span class="n">b44_set_rx_mode</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_set_mac_address</span>	<span class="o">=</span> <span class="n">b44_set_mac_addr</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_validate_addr</span>	<span class="o">=</span> <span class="n">eth_validate_addr</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_do_ioctl</span>		<span class="o">=</span> <span class="n">b44_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_tx_timeout</span>		<span class="o">=</span> <span class="n">b44_tx_timeout</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_change_mtu</span>		<span class="o">=</span> <span class="n">b44_change_mtu</span><span class="p">,</span>
<span class="cp">#ifdef CONFIG_NET_POLL_CONTROLLER</span>
	<span class="p">.</span><span class="n">ndo_poll_controller</span>	<span class="o">=</span> <span class="n">b44_poll_controller</span><span class="p">,</span>
<span class="cp">#endif</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">b44_init_one</span><span class="p">(</span><span class="k">struct</span> <span class="n">ssb_device</span> <span class="o">*</span><span class="n">sdev</span><span class="p">,</span>
				  <span class="k">const</span> <span class="k">struct</span> <span class="n">ssb_device_id</span> <span class="o">*</span><span class="n">ent</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">b44</span> <span class="o">*</span><span class="n">bp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">instance</span><span class="o">++</span><span class="p">;</span>

	<span class="n">pr_info_once</span><span class="p">(</span><span class="s">&quot;%s version %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">DRV_DESCRIPTION</span><span class="p">,</span> <span class="n">DRV_MODULE_VERSION</span><span class="p">);</span>

	<span class="n">dev</span> <span class="o">=</span> <span class="n">alloc_etherdev</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">bp</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">SET_NETDEV_DEV</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">sdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* No interesting netdevice features in this card... */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">|=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">bp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">bp</span><span class="o">-&gt;</span><span class="n">sdev</span> <span class="o">=</span> <span class="n">sdev</span><span class="p">;</span>
	<span class="n">bp</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	<span class="n">bp</span><span class="o">-&gt;</span><span class="n">force_copybreak</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">bp</span><span class="o">-&gt;</span><span class="n">msg_enable</span> <span class="o">=</span> <span class="n">netif_msg_init</span><span class="p">(</span><span class="n">b44_debug</span><span class="p">,</span> <span class="n">B44_DEF_MSG_ENABLE</span><span class="p">);</span>

	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">bp</span><span class="o">-&gt;</span><span class="n">rx_pending</span> <span class="o">=</span> <span class="n">B44_DEF_RX_RING_PENDING</span><span class="p">;</span>
	<span class="n">bp</span><span class="o">-&gt;</span><span class="n">tx_pending</span> <span class="o">=</span> <span class="n">B44_DEF_TX_RING_PENDING</span><span class="p">;</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">netdev_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">b44_netdev_ops</span><span class="p">;</span>
	<span class="n">netif_napi_add</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">,</span> <span class="n">b44_poll</span><span class="p">,</span> <span class="mi">64</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">watchdog_timeo</span> <span class="o">=</span> <span class="n">B44_TX_TIMEOUT</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">sdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>
	<span class="n">SET_ETHTOOL_OPS</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">b44_ethtool_ops</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">ssb_bus_powerup</span><span class="p">(</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;Failed to powerup the bus</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_out_free_dev</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dma_set_mask</span><span class="p">(</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">dma_dev</span><span class="p">,</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">30</span><span class="p">))</span> <span class="o">||</span>
	    <span class="n">dma_set_coherent_mask</span><span class="p">(</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">dma_dev</span><span class="p">,</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">30</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;Required 30BIT DMA mask unsupported by the system</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_out_powerdown</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">b44_get_invariants</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;Problem fetching invariants of chip, aborting</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_out_powerdown</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">bp</span><span class="o">-&gt;</span><span class="n">mii_if</span><span class="p">.</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	<span class="n">bp</span><span class="o">-&gt;</span><span class="n">mii_if</span><span class="p">.</span><span class="n">mdio_read</span> <span class="o">=</span> <span class="n">b44_mii_read</span><span class="p">;</span>
	<span class="n">bp</span><span class="o">-&gt;</span><span class="n">mii_if</span><span class="p">.</span><span class="n">mdio_write</span> <span class="o">=</span> <span class="n">b44_mii_write</span><span class="p">;</span>
	<span class="n">bp</span><span class="o">-&gt;</span><span class="n">mii_if</span><span class="p">.</span><span class="n">phy_id</span> <span class="o">=</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">phy_addr</span><span class="p">;</span>
	<span class="n">bp</span><span class="o">-&gt;</span><span class="n">mii_if</span><span class="p">.</span><span class="n">phy_id_mask</span> <span class="o">=</span> <span class="mh">0x1f</span><span class="p">;</span>
	<span class="n">bp</span><span class="o">-&gt;</span><span class="n">mii_if</span><span class="p">.</span><span class="n">reg_num_mask</span> <span class="o">=</span> <span class="mh">0x1f</span><span class="p">;</span>

	<span class="cm">/* By default, advertise all speed/duplex settings. */</span>
	<span class="n">bp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="p">(</span><span class="n">B44_FLAG_ADV_10HALF</span> <span class="o">|</span> <span class="n">B44_FLAG_ADV_10FULL</span> <span class="o">|</span>
		      <span class="n">B44_FLAG_ADV_100HALF</span> <span class="o">|</span> <span class="n">B44_FLAG_ADV_100FULL</span><span class="p">);</span>

	<span class="cm">/* By default, auto-negotiate PAUSE. */</span>
	<span class="n">bp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">B44_FLAG_PAUSE_AUTO</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">register_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Cannot register net device, aborting</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_out_powerdown</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">netif_carrier_off</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">ssb_set_drvdata</span><span class="p">(</span><span class="n">sdev</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* Chip reset provides power to the b44 MAC &amp; PCI cores, which</span>
<span class="cm">	 * is necessary for MAC register access.</span>
<span class="cm">	 */</span>
	<span class="n">b44_chip_reset</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">B44_CHIP_RESET_FULL</span><span class="p">);</span>

	<span class="cm">/* do a phy reset to test if there is an active phy */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">b44_phy_reset</span><span class="p">(</span><span class="n">bp</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">bp</span><span class="o">-&gt;</span><span class="n">phy_addr</span> <span class="o">=</span> <span class="n">B44_PHY_ADDR_NO_PHY</span><span class="p">;</span>

	<span class="n">netdev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s %pM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">DRV_DESCRIPTION</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_out_powerdown:</span>
	<span class="n">ssb_bus_may_powerdown</span><span class="p">(</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">);</span>

<span class="nl">err_out_free_dev:</span>
	<span class="n">free_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devexit</span> <span class="nf">b44_remove_one</span><span class="p">(</span><span class="k">struct</span> <span class="n">ssb_device</span> <span class="o">*</span><span class="n">sdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">ssb_get_drvdata</span><span class="p">(</span><span class="n">sdev</span><span class="p">);</span>

	<span class="n">unregister_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">ssb_device_disable</span><span class="p">(</span><span class="n">sdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">ssb_bus_may_powerdown</span><span class="p">(</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">);</span>
	<span class="n">free_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">ssb_pcihost_set_power_state</span><span class="p">(</span><span class="n">sdev</span><span class="p">,</span> <span class="n">PCI_D3hot</span><span class="p">);</span>
	<span class="n">ssb_set_drvdata</span><span class="p">(</span><span class="n">sdev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">b44_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">ssb_device</span> <span class="o">*</span><span class="n">sdev</span><span class="p">,</span> <span class="n">pm_message_t</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">ssb_get_drvdata</span><span class="p">(</span><span class="n">sdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">b44</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">netif_running</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">b44_halt</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
	<span class="n">netif_carrier_off</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">netif_device_detach</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">b44_free_rings</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>

	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">free_irq</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">B44_FLAG_WOL_ENABLE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">b44_init_hw</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">B44_PARTIAL_RESET</span><span class="p">);</span>
		<span class="n">b44_setup_wol</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">ssb_pcihost_set_power_state</span><span class="p">(</span><span class="n">sdev</span><span class="p">,</span> <span class="n">PCI_D3hot</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">b44_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">ssb_device</span> <span class="o">*</span><span class="n">sdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">ssb_get_drvdata</span><span class="p">(</span><span class="n">sdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">b44</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">ssb_bus_powerup</span><span class="p">(</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;Failed to powerup the bus</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">netif_running</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">b44_init_rings</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
	<span class="n">b44_init_hw</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">B44_FULL_RESET</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * As a shared interrupt, the handler can be called immediately. To be</span>
<span class="cm">	 * able to check the interrupt status the hardware must already be</span>
<span class="cm">	 * powered back on (b44_init_hw).</span>
<span class="cm">	 */</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">b44_interrupt</span><span class="p">,</span> <span class="n">IRQF_SHARED</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netdev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;request_irq failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="n">b44_halt</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
		<span class="n">b44_free_rings</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
		<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">netif_device_attach</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">b44_enable_ints</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
	<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ssb_driver</span> <span class="n">b44_ssb_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="n">DRV_MODULE_NAME</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span>	<span class="o">=</span> <span class="n">b44_ssb_tbl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span>		<span class="o">=</span> <span class="n">b44_init_one</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>		<span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">b44_remove_one</span><span class="p">),</span>
	<span class="p">.</span><span class="n">suspend</span>	<span class="o">=</span> <span class="n">b44_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume</span>		<span class="o">=</span> <span class="n">b44_resume</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">b44_pci_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_B44_PCI</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">ssb_pcihost_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">b44_pci_driver</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">b44_pci_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef CONFIG_B44_PCI</span>
	<span class="n">ssb_pcihost_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">b44_pci_driver</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">b44_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dma_desc_align_size</span> <span class="o">=</span> <span class="n">dma_get_cache_alignment</span><span class="p">();</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="cm">/* Setup paramaters for syncing RX/TX DMA descriptors */</span>
	<span class="n">dma_desc_sync_size</span> <span class="o">=</span> <span class="n">max_t</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">,</span> <span class="n">dma_desc_align_size</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">dma_desc</span><span class="p">));</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">b44_pci_init</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">ssb_driver_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">b44_ssb_driver</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="n">b44_pci_exit</span><span class="p">();</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">b44_cleanup</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ssb_driver_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">b44_ssb_driver</span><span class="p">);</span>
	<span class="n">b44_pci_exit</span><span class="p">();</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">b44_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">b44_cleanup</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
