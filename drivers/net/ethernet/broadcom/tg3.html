<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › ethernet › broadcom › tg3.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>tg3.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * tg3.c: Broadcom Tigon3 ethernet driver.</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2001, 2002, 2003, 2004 David S. Miller (davem@redhat.com)</span>
<span class="cm"> * Copyright (C) 2001, 2002, 2003 Jeff Garzik (jgarzik@pobox.com)</span>
<span class="cm"> * Copyright (C) 2004 Sun Microsystems Inc.</span>
<span class="cm"> * Copyright (C) 2005-2012 Broadcom Corporation.</span>
<span class="cm"> *</span>
<span class="cm"> * Firmware is:</span>
<span class="cm"> *	Derived from proprietary unpublished source code,</span>
<span class="cm"> *	Copyright (C) 2000-2003 Broadcom Corporation.</span>
<span class="cm"> *</span>
<span class="cm"> *	Permission is hereby granted for the distribution of this firmware</span>
<span class="cm"> *	data in hexadecimal or equivalent format, provided this copyright</span>
<span class="cm"> *	notice is accompanying it.</span>
<span class="cm"> */</span>


<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/moduleparam.h&gt;</span>
<span class="cp">#include &lt;linux/stringify.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/compiler.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/in.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/ioport.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/netdevice.h&gt;</span>
<span class="cp">#include &lt;linux/etherdevice.h&gt;</span>
<span class="cp">#include &lt;linux/skbuff.h&gt;</span>
<span class="cp">#include &lt;linux/ethtool.h&gt;</span>
<span class="cp">#include &lt;linux/mdio.h&gt;</span>
<span class="cp">#include &lt;linux/mii.h&gt;</span>
<span class="cp">#include &lt;linux/phy.h&gt;</span>
<span class="cp">#include &lt;linux/brcmphy.h&gt;</span>
<span class="cp">#include &lt;linux/if_vlan.h&gt;</span>
<span class="cp">#include &lt;linux/ip.h&gt;</span>
<span class="cp">#include &lt;linux/tcp.h&gt;</span>
<span class="cp">#include &lt;linux/workqueue.h&gt;</span>
<span class="cp">#include &lt;linux/prefetch.h&gt;</span>
<span class="cp">#include &lt;linux/dma-mapping.h&gt;</span>
<span class="cp">#include &lt;linux/firmware.h&gt;</span>

<span class="cp">#include &lt;net/checksum.h&gt;</span>
<span class="cp">#include &lt;net/ip.h&gt;</span>

<span class="cp">#include &lt;linux/io.h&gt;</span>
<span class="cp">#include &lt;asm/byteorder.h&gt;</span>
<span class="cp">#include &lt;linux/uaccess.h&gt;</span>

<span class="cp">#ifdef CONFIG_SPARC</span>
<span class="cp">#include &lt;asm/idprom.h&gt;</span>
<span class="cp">#include &lt;asm/prom.h&gt;</span>
<span class="cp">#endif</span>

<span class="cp">#define BAR_0	0</span>
<span class="cp">#define BAR_2	2</span>

<span class="cp">#include &quot;tg3.h&quot;</span>

<span class="cm">/* Functions &amp; macros to verify TG3_FLAGS types */</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">_tg3_flag</span><span class="p">(</span><span class="k">enum</span> <span class="n">TG3_FLAGS</span> <span class="n">flag</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">bits</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">test_bit</span><span class="p">(</span><span class="n">flag</span><span class="p">,</span> <span class="n">bits</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">_tg3_flag_set</span><span class="p">(</span><span class="k">enum</span> <span class="n">TG3_FLAGS</span> <span class="n">flag</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">bits</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">flag</span><span class="p">,</span> <span class="n">bits</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">_tg3_flag_clear</span><span class="p">(</span><span class="k">enum</span> <span class="n">TG3_FLAGS</span> <span class="n">flag</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">bits</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">flag</span><span class="p">,</span> <span class="n">bits</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#define tg3_flag(tp, flag)				\</span>
<span class="cp">	_tg3_flag(TG3_FLAG_##flag, (tp)-&gt;tg3_flags)</span>
<span class="cp">#define tg3_flag_set(tp, flag)				\</span>
<span class="cp">	_tg3_flag_set(TG3_FLAG_##flag, (tp)-&gt;tg3_flags)</span>
<span class="cp">#define tg3_flag_clear(tp, flag)			\</span>
<span class="cp">	_tg3_flag_clear(TG3_FLAG_##flag, (tp)-&gt;tg3_flags)</span>

<span class="cp">#define DRV_MODULE_NAME		&quot;tg3&quot;</span>
<span class="cp">#define TG3_MAJ_NUM			3</span>
<span class="cp">#define TG3_MIN_NUM			123</span>
<span class="cp">#define DRV_MODULE_VERSION	\</span>
<span class="cp">	__stringify(TG3_MAJ_NUM) &quot;.&quot; __stringify(TG3_MIN_NUM)</span>
<span class="cp">#define DRV_MODULE_RELDATE	&quot;March 21, 2012&quot;</span>

<span class="cp">#define RESET_KIND_SHUTDOWN	0</span>
<span class="cp">#define RESET_KIND_INIT		1</span>
<span class="cp">#define RESET_KIND_SUSPEND	2</span>

<span class="cp">#define TG3_DEF_RX_MODE		0</span>
<span class="cp">#define TG3_DEF_TX_MODE		0</span>
<span class="cp">#define TG3_DEF_MSG_ENABLE	  \</span>
<span class="cp">	(NETIF_MSG_DRV		| \</span>
<span class="cp">	 NETIF_MSG_PROBE	| \</span>
<span class="cp">	 NETIF_MSG_LINK		| \</span>
<span class="cp">	 NETIF_MSG_TIMER	| \</span>
<span class="cp">	 NETIF_MSG_IFDOWN	| \</span>
<span class="cp">	 NETIF_MSG_IFUP		| \</span>
<span class="cp">	 NETIF_MSG_RX_ERR	| \</span>
<span class="cp">	 NETIF_MSG_TX_ERR)</span>

<span class="cp">#define TG3_GRC_LCLCTL_PWRSW_DELAY	100</span>

<span class="cm">/* length of time before we decide the hardware is borked,</span>
<span class="cm"> * and dev-&gt;tx_timeout() should be called to fix the problem</span>
<span class="cm"> */</span>

<span class="cp">#define TG3_TX_TIMEOUT			(5 * HZ)</span>

<span class="cm">/* hardware minimum and maximum for a single frame&#39;s data payload */</span>
<span class="cp">#define TG3_MIN_MTU			60</span>
<span class="cp">#define TG3_MAX_MTU(tp)	\</span>
<span class="cp">	(tg3_flag(tp, JUMBO_CAPABLE) ? 9000 : 1500)</span>

<span class="cm">/* These numbers seem to be hard coded in the NIC firmware somehow.</span>
<span class="cm"> * You can&#39;t change the ring sizes, but you can change where you place</span>
<span class="cm"> * them in the NIC onboard memory.</span>
<span class="cm"> */</span>
<span class="cp">#define TG3_RX_STD_RING_SIZE(tp) \</span>
<span class="cp">	(tg3_flag(tp, LRG_PROD_RING_CAP) ? \</span>
<span class="cp">	 TG3_RX_STD_MAX_SIZE_5717 : TG3_RX_STD_MAX_SIZE_5700)</span>
<span class="cp">#define TG3_DEF_RX_RING_PENDING		200</span>
<span class="cp">#define TG3_RX_JMB_RING_SIZE(tp) \</span>
<span class="cp">	(tg3_flag(tp, LRG_PROD_RING_CAP) ? \</span>
<span class="cp">	 TG3_RX_JMB_MAX_SIZE_5717 : TG3_RX_JMB_MAX_SIZE_5700)</span>
<span class="cp">#define TG3_DEF_RX_JUMBO_RING_PENDING	100</span>

<span class="cm">/* Do not place this n-ring entries value into the tp struct itself,</span>
<span class="cm"> * we really want to expose these constants to GCC so that modulo et</span>
<span class="cm"> * al.  operations are done with shifts and masks instead of with</span>
<span class="cm"> * hw multiply/modulo instructions.  Another solution would be to</span>
<span class="cm"> * replace things like &#39;% foo&#39; with &#39;&amp; (foo - 1)&#39;.</span>
<span class="cm"> */</span>

<span class="cp">#define TG3_TX_RING_SIZE		512</span>
<span class="cp">#define TG3_DEF_TX_RING_PENDING		(TG3_TX_RING_SIZE - 1)</span>

<span class="cp">#define TG3_RX_STD_RING_BYTES(tp) \</span>
<span class="cp">	(sizeof(struct tg3_rx_buffer_desc) * TG3_RX_STD_RING_SIZE(tp))</span>
<span class="cp">#define TG3_RX_JMB_RING_BYTES(tp) \</span>
<span class="cp">	(sizeof(struct tg3_ext_rx_buffer_desc) * TG3_RX_JMB_RING_SIZE(tp))</span>
<span class="cp">#define TG3_RX_RCB_RING_BYTES(tp) \</span>
<span class="cp">	(sizeof(struct tg3_rx_buffer_desc) * (tp-&gt;rx_ret_ring_mask + 1))</span>
<span class="cp">#define TG3_TX_RING_BYTES	(sizeof(struct tg3_tx_buffer_desc) * \</span>
<span class="cp">				 TG3_TX_RING_SIZE)</span>
<span class="cp">#define NEXT_TX(N)		(((N) + 1) &amp; (TG3_TX_RING_SIZE - 1))</span>

<span class="cp">#define TG3_DMA_BYTE_ENAB		64</span>

<span class="cp">#define TG3_RX_STD_DMA_SZ		1536</span>
<span class="cp">#define TG3_RX_JMB_DMA_SZ		9046</span>

<span class="cp">#define TG3_RX_DMA_TO_MAP_SZ(x)		((x) + TG3_DMA_BYTE_ENAB)</span>

<span class="cp">#define TG3_RX_STD_MAP_SZ		TG3_RX_DMA_TO_MAP_SZ(TG3_RX_STD_DMA_SZ)</span>
<span class="cp">#define TG3_RX_JMB_MAP_SZ		TG3_RX_DMA_TO_MAP_SZ(TG3_RX_JMB_DMA_SZ)</span>

<span class="cp">#define TG3_RX_STD_BUFF_RING_SIZE(tp) \</span>
<span class="cp">	(sizeof(struct ring_info) * TG3_RX_STD_RING_SIZE(tp))</span>

<span class="cp">#define TG3_RX_JMB_BUFF_RING_SIZE(tp) \</span>
<span class="cp">	(sizeof(struct ring_info) * TG3_RX_JMB_RING_SIZE(tp))</span>

<span class="cm">/* Due to a hardware bug, the 5701 can only DMA to memory addresses</span>
<span class="cm"> * that are at least dword aligned when used in PCIX mode.  The driver</span>
<span class="cm"> * works around this bug by double copying the packet.  This workaround</span>
<span class="cm"> * is built into the normal double copy length check for efficiency.</span>
<span class="cm"> *</span>
<span class="cm"> * However, the double copy is only necessary on those architectures</span>
<span class="cm"> * where unaligned memory accesses are inefficient.  For those architectures</span>
<span class="cm"> * where unaligned memory accesses incur little penalty, we can reintegrate</span>
<span class="cm"> * the 5701 in the normal rx path.  Doing so saves a device structure</span>
<span class="cm"> * dereference by hardcoding the double copy threshold in place.</span>
<span class="cm"> */</span>
<span class="cp">#define TG3_RX_COPY_THRESHOLD		256</span>
<span class="cp">#if NET_IP_ALIGN == 0 || defined(CONFIG_HAVE_EFFICIENT_UNALIGNED_ACCESS)</span>
	<span class="cp">#define TG3_RX_COPY_THRESH(tp)	TG3_RX_COPY_THRESHOLD</span>
<span class="cp">#else</span>
	<span class="cp">#define TG3_RX_COPY_THRESH(tp)	((tp)-&gt;rx_copy_thresh)</span>
<span class="cp">#endif</span>

<span class="cp">#if (NET_IP_ALIGN != 0)</span>
<span class="cp">#define TG3_RX_OFFSET(tp)	((tp)-&gt;rx_offset)</span>
<span class="cp">#else</span>
<span class="cp">#define TG3_RX_OFFSET(tp)	(NET_SKB_PAD)</span>
<span class="cp">#endif</span>

<span class="cm">/* minimum number of free TX descriptors required to wake up TX process */</span>
<span class="cp">#define TG3_TX_WAKEUP_THRESH(tnapi)		((tnapi)-&gt;tx_pending / 4)</span>
<span class="cp">#define TG3_TX_BD_DMA_MAX_2K		2048</span>
<span class="cp">#define TG3_TX_BD_DMA_MAX_4K		4096</span>

<span class="cp">#define TG3_RAW_IP_ALIGN 2</span>

<span class="cp">#define TG3_FW_UPDATE_TIMEOUT_SEC	5</span>
<span class="cp">#define TG3_FW_UPDATE_FREQ_SEC		(TG3_FW_UPDATE_TIMEOUT_SEC / 2)</span>

<span class="cp">#define FIRMWARE_TG3		&quot;tigon/tg3.bin&quot;</span>
<span class="cp">#define FIRMWARE_TG3TSO		&quot;tigon/tg3_tso.bin&quot;</span>
<span class="cp">#define FIRMWARE_TG3TSO5	&quot;tigon/tg3_tso5.bin&quot;</span>

<span class="k">static</span> <span class="kt">char</span> <span class="n">version</span><span class="p">[]</span> <span class="n">__devinitdata</span> <span class="o">=</span>
	<span class="n">DRV_MODULE_NAME</span> <span class="s">&quot;.c:v&quot;</span> <span class="n">DRV_MODULE_VERSION</span> <span class="s">&quot; (&quot;</span> <span class="n">DRV_MODULE_RELDATE</span> <span class="s">&quot;)&quot;</span><span class="p">;</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;David S. Miller (davem@redhat.com) and Jeff Garzik (jgarzik@pobox.com)&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Broadcom Tigon3 ethernet driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_VERSION</span><span class="p">(</span><span class="n">DRV_MODULE_VERSION</span><span class="p">);</span>
<span class="n">MODULE_FIRMWARE</span><span class="p">(</span><span class="n">FIRMWARE_TG3</span><span class="p">);</span>
<span class="n">MODULE_FIRMWARE</span><span class="p">(</span><span class="n">FIRMWARE_TG3TSO</span><span class="p">);</span>
<span class="n">MODULE_FIRMWARE</span><span class="p">(</span><span class="n">FIRMWARE_TG3TSO5</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">tg3_debug</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>	<span class="cm">/* -1 == use TG3_DEF_MSG_ENABLE as value */</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">tg3_debug</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">tg3_debug</span><span class="p">,</span> <span class="s">&quot;Tigon3 bitmapped debugging message enable value&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="n">DEFINE_PCI_DEVICE_TABLE</span><span class="p">(</span><span class="n">tg3_pci_tbl</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span><span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_BROADCOM</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_TIGON3_5700</span><span class="p">)},</span>
	<span class="p">{</span><span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_BROADCOM</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_TIGON3_5701</span><span class="p">)},</span>
	<span class="p">{</span><span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_BROADCOM</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_TIGON3_5702</span><span class="p">)},</span>
	<span class="p">{</span><span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_BROADCOM</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_TIGON3_5703</span><span class="p">)},</span>
	<span class="p">{</span><span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_BROADCOM</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_TIGON3_5704</span><span class="p">)},</span>
	<span class="p">{</span><span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_BROADCOM</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_TIGON3_5702FE</span><span class="p">)},</span>
	<span class="p">{</span><span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_BROADCOM</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_TIGON3_5705</span><span class="p">)},</span>
	<span class="p">{</span><span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_BROADCOM</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_TIGON3_5705_2</span><span class="p">)},</span>
	<span class="p">{</span><span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_BROADCOM</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_TIGON3_5705M</span><span class="p">)},</span>
	<span class="p">{</span><span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_BROADCOM</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_TIGON3_5705M_2</span><span class="p">)},</span>
	<span class="p">{</span><span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_BROADCOM</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_TIGON3_5702X</span><span class="p">)},</span>
	<span class="p">{</span><span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_BROADCOM</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_TIGON3_5703X</span><span class="p">)},</span>
	<span class="p">{</span><span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_BROADCOM</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_TIGON3_5704S</span><span class="p">)},</span>
	<span class="p">{</span><span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_BROADCOM</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_TIGON3_5702A3</span><span class="p">)},</span>
	<span class="p">{</span><span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_BROADCOM</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_TIGON3_5703A3</span><span class="p">)},</span>
	<span class="p">{</span><span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_BROADCOM</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_TIGON3_5782</span><span class="p">)},</span>
	<span class="p">{</span><span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_BROADCOM</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_TIGON3_5788</span><span class="p">)},</span>
	<span class="p">{</span><span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_BROADCOM</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_TIGON3_5789</span><span class="p">)},</span>
	<span class="p">{</span><span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_BROADCOM</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_TIGON3_5901</span><span class="p">)},</span>
	<span class="p">{</span><span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_BROADCOM</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_TIGON3_5901_2</span><span class="p">)},</span>
	<span class="p">{</span><span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_BROADCOM</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_TIGON3_5704S_2</span><span class="p">)},</span>
	<span class="p">{</span><span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_BROADCOM</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_TIGON3_5705F</span><span class="p">)},</span>
	<span class="p">{</span><span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_BROADCOM</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_TIGON3_5721</span><span class="p">)},</span>
	<span class="p">{</span><span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_BROADCOM</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_TIGON3_5722</span><span class="p">)},</span>
	<span class="p">{</span><span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_BROADCOM</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_TIGON3_5751</span><span class="p">)},</span>
	<span class="p">{</span><span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_BROADCOM</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_TIGON3_5751M</span><span class="p">)},</span>
	<span class="p">{</span><span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_BROADCOM</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_TIGON3_5751F</span><span class="p">)},</span>
	<span class="p">{</span><span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_BROADCOM</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_TIGON3_5752</span><span class="p">)},</span>
	<span class="p">{</span><span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_BROADCOM</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_TIGON3_5752M</span><span class="p">)},</span>
	<span class="p">{</span><span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_BROADCOM</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_TIGON3_5753</span><span class="p">)},</span>
	<span class="p">{</span><span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_BROADCOM</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_TIGON3_5753M</span><span class="p">)},</span>
	<span class="p">{</span><span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_BROADCOM</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_TIGON3_5753F</span><span class="p">)},</span>
	<span class="p">{</span><span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_BROADCOM</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_TIGON3_5754</span><span class="p">)},</span>
	<span class="p">{</span><span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_BROADCOM</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_TIGON3_5754M</span><span class="p">)},</span>
	<span class="p">{</span><span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_BROADCOM</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_TIGON3_5755</span><span class="p">)},</span>
	<span class="p">{</span><span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_BROADCOM</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_TIGON3_5755M</span><span class="p">)},</span>
	<span class="p">{</span><span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_BROADCOM</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_TIGON3_5756</span><span class="p">)},</span>
	<span class="p">{</span><span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_BROADCOM</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_TIGON3_5786</span><span class="p">)},</span>
	<span class="p">{</span><span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_BROADCOM</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_TIGON3_5787</span><span class="p">)},</span>
	<span class="p">{</span><span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_BROADCOM</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_TIGON3_5787M</span><span class="p">)},</span>
	<span class="p">{</span><span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_BROADCOM</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_TIGON3_5787F</span><span class="p">)},</span>
	<span class="p">{</span><span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_BROADCOM</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_TIGON3_5714</span><span class="p">)},</span>
	<span class="p">{</span><span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_BROADCOM</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_TIGON3_5714S</span><span class="p">)},</span>
	<span class="p">{</span><span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_BROADCOM</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_TIGON3_5715</span><span class="p">)},</span>
	<span class="p">{</span><span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_BROADCOM</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_TIGON3_5715S</span><span class="p">)},</span>
	<span class="p">{</span><span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_BROADCOM</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_TIGON3_5780</span><span class="p">)},</span>
	<span class="p">{</span><span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_BROADCOM</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_TIGON3_5780S</span><span class="p">)},</span>
	<span class="p">{</span><span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_BROADCOM</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_TIGON3_5781</span><span class="p">)},</span>
	<span class="p">{</span><span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_BROADCOM</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_TIGON3_5906</span><span class="p">)},</span>
	<span class="p">{</span><span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_BROADCOM</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_TIGON3_5906M</span><span class="p">)},</span>
	<span class="p">{</span><span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_BROADCOM</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_TIGON3_5784</span><span class="p">)},</span>
	<span class="p">{</span><span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_BROADCOM</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_TIGON3_5764</span><span class="p">)},</span>
	<span class="p">{</span><span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_BROADCOM</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_TIGON3_5723</span><span class="p">)},</span>
	<span class="p">{</span><span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_BROADCOM</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_TIGON3_5761</span><span class="p">)},</span>
	<span class="p">{</span><span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_BROADCOM</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_TIGON3_5761E</span><span class="p">)},</span>
	<span class="p">{</span><span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_BROADCOM</span><span class="p">,</span> <span class="n">TG3PCI_DEVICE_TIGON3_5761S</span><span class="p">)},</span>
	<span class="p">{</span><span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_BROADCOM</span><span class="p">,</span> <span class="n">TG3PCI_DEVICE_TIGON3_5761SE</span><span class="p">)},</span>
	<span class="p">{</span><span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_BROADCOM</span><span class="p">,</span> <span class="n">TG3PCI_DEVICE_TIGON3_5785_G</span><span class="p">)},</span>
	<span class="p">{</span><span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_BROADCOM</span><span class="p">,</span> <span class="n">TG3PCI_DEVICE_TIGON3_5785_F</span><span class="p">)},</span>
	<span class="p">{</span><span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_BROADCOM</span><span class="p">,</span> <span class="n">TG3PCI_DEVICE_TIGON3_57780</span><span class="p">)},</span>
	<span class="p">{</span><span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_BROADCOM</span><span class="p">,</span> <span class="n">TG3PCI_DEVICE_TIGON3_57760</span><span class="p">)},</span>
	<span class="p">{</span><span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_BROADCOM</span><span class="p">,</span> <span class="n">TG3PCI_DEVICE_TIGON3_57790</span><span class="p">)},</span>
	<span class="p">{</span><span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_BROADCOM</span><span class="p">,</span> <span class="n">TG3PCI_DEVICE_TIGON3_57788</span><span class="p">)},</span>
	<span class="p">{</span><span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_BROADCOM</span><span class="p">,</span> <span class="n">TG3PCI_DEVICE_TIGON3_5717</span><span class="p">)},</span>
	<span class="p">{</span><span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_BROADCOM</span><span class="p">,</span> <span class="n">TG3PCI_DEVICE_TIGON3_5718</span><span class="p">)},</span>
	<span class="p">{</span><span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_BROADCOM</span><span class="p">,</span> <span class="n">TG3PCI_DEVICE_TIGON3_57781</span><span class="p">)},</span>
	<span class="p">{</span><span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_BROADCOM</span><span class="p">,</span> <span class="n">TG3PCI_DEVICE_TIGON3_57785</span><span class="p">)},</span>
	<span class="p">{</span><span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_BROADCOM</span><span class="p">,</span> <span class="n">TG3PCI_DEVICE_TIGON3_57761</span><span class="p">)},</span>
	<span class="p">{</span><span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_BROADCOM</span><span class="p">,</span> <span class="n">TG3PCI_DEVICE_TIGON3_57765</span><span class="p">)},</span>
	<span class="p">{</span><span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_BROADCOM</span><span class="p">,</span> <span class="n">TG3PCI_DEVICE_TIGON3_57791</span><span class="p">)},</span>
	<span class="p">{</span><span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_BROADCOM</span><span class="p">,</span> <span class="n">TG3PCI_DEVICE_TIGON3_57795</span><span class="p">)},</span>
	<span class="p">{</span><span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_BROADCOM</span><span class="p">,</span> <span class="n">TG3PCI_DEVICE_TIGON3_5719</span><span class="p">)},</span>
	<span class="p">{</span><span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_BROADCOM</span><span class="p">,</span> <span class="n">TG3PCI_DEVICE_TIGON3_5720</span><span class="p">)},</span>
	<span class="p">{</span><span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_SYSKONNECT</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_SYSKONNECT_9DXX</span><span class="p">)},</span>
	<span class="p">{</span><span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_SYSKONNECT</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_SYSKONNECT_9MXX</span><span class="p">)},</span>
	<span class="p">{</span><span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_ALTIMA</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_ALTIMA_AC1000</span><span class="p">)},</span>
	<span class="p">{</span><span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_ALTIMA</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_ALTIMA_AC1001</span><span class="p">)},</span>
	<span class="p">{</span><span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_ALTIMA</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_ALTIMA_AC1003</span><span class="p">)},</span>
	<span class="p">{</span><span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_ALTIMA</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_ALTIMA_AC9100</span><span class="p">)},</span>
	<span class="p">{</span><span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_APPLE</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_APPLE_TIGON3</span><span class="p">)},</span>
	<span class="p">{</span><span class="n">PCI_DEVICE</span><span class="p">(</span><span class="mh">0x10cf</span><span class="p">,</span> <span class="mh">0x11a2</span><span class="p">)},</span> <span class="cm">/* Fujitsu 1000base-SX with BCM5703SKHB */</span>
	<span class="p">{}</span>
<span class="p">};</span>

<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">tg3_pci_tbl</span><span class="p">);</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="p">{</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="n">string</span><span class="p">[</span><span class="n">ETH_GSTRING_LEN</span><span class="p">];</span>
<span class="p">}</span> <span class="n">ethtool_stats_keys</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="s">&quot;rx_octets&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;rx_fragments&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;rx_ucast_packets&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;rx_mcast_packets&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;rx_bcast_packets&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;rx_fcs_errors&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;rx_align_errors&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;rx_xon_pause_rcvd&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;rx_xoff_pause_rcvd&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;rx_mac_ctrl_rcvd&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;rx_xoff_entered&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;rx_frame_too_long_errors&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;rx_jabbers&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;rx_undersize_packets&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;rx_in_length_errors&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;rx_out_length_errors&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;rx_64_or_less_octet_packets&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;rx_65_to_127_octet_packets&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;rx_128_to_255_octet_packets&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;rx_256_to_511_octet_packets&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;rx_512_to_1023_octet_packets&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;rx_1024_to_1522_octet_packets&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;rx_1523_to_2047_octet_packets&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;rx_2048_to_4095_octet_packets&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;rx_4096_to_8191_octet_packets&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;rx_8192_to_9022_octet_packets&quot;</span> <span class="p">},</span>

	<span class="p">{</span> <span class="s">&quot;tx_octets&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;tx_collisions&quot;</span> <span class="p">},</span>

	<span class="p">{</span> <span class="s">&quot;tx_xon_sent&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;tx_xoff_sent&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;tx_flow_control&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;tx_mac_errors&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;tx_single_collisions&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;tx_mult_collisions&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;tx_deferred&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;tx_excessive_collisions&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;tx_late_collisions&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;tx_collide_2times&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;tx_collide_3times&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;tx_collide_4times&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;tx_collide_5times&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;tx_collide_6times&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;tx_collide_7times&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;tx_collide_8times&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;tx_collide_9times&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;tx_collide_10times&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;tx_collide_11times&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;tx_collide_12times&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;tx_collide_13times&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;tx_collide_14times&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;tx_collide_15times&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;tx_ucast_packets&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;tx_mcast_packets&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;tx_bcast_packets&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;tx_carrier_sense_errors&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;tx_discards&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;tx_errors&quot;</span> <span class="p">},</span>

	<span class="p">{</span> <span class="s">&quot;dma_writeq_full&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;dma_write_prioq_full&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;rxbds_empty&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;rx_discards&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;rx_errors&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;rx_threshold_hit&quot;</span> <span class="p">},</span>

	<span class="p">{</span> <span class="s">&quot;dma_readq_full&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;dma_read_prioq_full&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;tx_comp_queue_full&quot;</span> <span class="p">},</span>

	<span class="p">{</span> <span class="s">&quot;ring_set_send_prod_index&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;ring_status_update&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;nic_irqs&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;nic_avoided_irqs&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;nic_tx_threshold_hit&quot;</span> <span class="p">},</span>

	<span class="p">{</span> <span class="s">&quot;mbuf_lwm_thresh_hit&quot;</span> <span class="p">},</span>
<span class="p">};</span>

<span class="cp">#define TG3_NUM_STATS	ARRAY_SIZE(ethtool_stats_keys)</span>


<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="p">{</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="n">string</span><span class="p">[</span><span class="n">ETH_GSTRING_LEN</span><span class="p">];</span>
<span class="p">}</span> <span class="n">ethtool_test_keys</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="s">&quot;nvram test        (online) &quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;link test         (online) &quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;register test     (offline)&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;memory test       (offline)&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;mac loopback test (offline)&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;phy loopback test (offline)&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;ext loopback test (offline)&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;interrupt test    (offline)&quot;</span> <span class="p">},</span>
<span class="p">};</span>

<span class="cp">#define TG3_NUM_TEST	ARRAY_SIZE(ethtool_test_keys)</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">tg3_write32</span><span class="p">(</span><span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span><span class="p">,</span> <span class="n">u32</span> <span class="n">off</span><span class="p">,</span> <span class="n">u32</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">off</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">tg3_read32</span><span class="p">(</span><span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span><span class="p">,</span> <span class="n">u32</span> <span class="n">off</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">readl</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">off</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tg3_ape_write32</span><span class="p">(</span><span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span><span class="p">,</span> <span class="n">u32</span> <span class="n">off</span><span class="p">,</span> <span class="n">u32</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">aperegs</span> <span class="o">+</span> <span class="n">off</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">tg3_ape_read32</span><span class="p">(</span><span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span><span class="p">,</span> <span class="n">u32</span> <span class="n">off</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">readl</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">aperegs</span> <span class="o">+</span> <span class="n">off</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tg3_write_indirect_reg32</span><span class="p">(</span><span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span><span class="p">,</span> <span class="n">u32</span> <span class="n">off</span><span class="p">,</span> <span class="n">u32</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">indirect_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">TG3PCI_REG_BASE_ADDR</span><span class="p">,</span> <span class="n">off</span><span class="p">);</span>
	<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">TG3PCI_REG_DATA</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">indirect_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tg3_write_flush_reg32</span><span class="p">(</span><span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span><span class="p">,</span> <span class="n">u32</span> <span class="n">off</span><span class="p">,</span> <span class="n">u32</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">off</span><span class="p">);</span>
	<span class="n">readl</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">off</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">tg3_read_indirect_reg32</span><span class="p">(</span><span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span><span class="p">,</span> <span class="n">u32</span> <span class="n">off</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">indirect_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">TG3PCI_REG_BASE_ADDR</span><span class="p">,</span> <span class="n">off</span><span class="p">);</span>
	<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">TG3PCI_REG_DATA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">indirect_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">val</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tg3_write_indirect_mbox</span><span class="p">(</span><span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span><span class="p">,</span> <span class="n">u32</span> <span class="n">off</span><span class="p">,</span> <span class="n">u32</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">off</span> <span class="o">==</span> <span class="p">(</span><span class="n">MAILBOX_RCVRET_CON_IDX_0</span> <span class="o">+</span> <span class="n">TG3_64BIT_REG_LOW</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">TG3PCI_RCV_RET_RING_CON_IDX</span> <span class="o">+</span>
				       <span class="n">TG3_64BIT_REG_LOW</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">off</span> <span class="o">==</span> <span class="n">TG3_RX_STD_PROD_IDX_REG</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">TG3PCI_STD_RING_PROD_IDX</span> <span class="o">+</span>
				       <span class="n">TG3_64BIT_REG_LOW</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">indirect_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">TG3PCI_REG_BASE_ADDR</span><span class="p">,</span> <span class="n">off</span> <span class="o">+</span> <span class="mh">0x5600</span><span class="p">);</span>
	<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">TG3PCI_REG_DATA</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">indirect_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* In indirect mode when disabling interrupts, we also need</span>
<span class="cm">	 * to clear the interrupt bit in the GRC local ctrl register.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">off</span> <span class="o">==</span> <span class="p">(</span><span class="n">MAILBOX_INTERRUPT_0</span> <span class="o">+</span> <span class="n">TG3_64BIT_REG_LOW</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">val</span> <span class="o">==</span> <span class="mh">0x1</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">TG3PCI_MISC_LOCAL_CTRL</span><span class="p">,</span>
				       <span class="n">tp</span><span class="o">-&gt;</span><span class="n">grc_local_ctrl</span><span class="o">|</span><span class="n">GRC_LCLCTRL_CLEARINT</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">tg3_read_indirect_mbox</span><span class="p">(</span><span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span><span class="p">,</span> <span class="n">u32</span> <span class="n">off</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">indirect_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">TG3PCI_REG_BASE_ADDR</span><span class="p">,</span> <span class="n">off</span> <span class="o">+</span> <span class="mh">0x5600</span><span class="p">);</span>
	<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">TG3PCI_REG_DATA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">indirect_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">val</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* usec_wait specifies the wait time in usec when writing to certain registers</span>
<span class="cm"> * where it is unsafe to read back the register without some delay.</span>
<span class="cm"> * GRC_LOCAL_CTRL is one example if the GPIOs are toggled to switch power.</span>
<span class="cm"> * TG3PCI_CLOCK_CTRL is another example if the clock frequencies are changed.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">_tw32_flush</span><span class="p">(</span><span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span><span class="p">,</span> <span class="n">u32</span> <span class="n">off</span><span class="p">,</span> <span class="n">u32</span> <span class="n">val</span><span class="p">,</span> <span class="n">u32</span> <span class="n">usec_wait</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">PCIX_TARGET_HWBUG</span><span class="p">)</span> <span class="o">||</span> <span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">ICH_WORKAROUND</span><span class="p">))</span>
		<span class="cm">/* Non-posted methods */</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">write32</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">off</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Posted method */</span>
		<span class="n">tg3_write32</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">off</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">usec_wait</span><span class="p">)</span>
			<span class="n">udelay</span><span class="p">(</span><span class="n">usec_wait</span><span class="p">);</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">read32</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">off</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/* Wait again after the read for the posted method to guarantee that</span>
<span class="cm">	 * the wait time is met.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">usec_wait</span><span class="p">)</span>
		<span class="n">udelay</span><span class="p">(</span><span class="n">usec_wait</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">tw32_mailbox_flush</span><span class="p">(</span><span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span><span class="p">,</span> <span class="n">u32</span> <span class="n">off</span><span class="p">,</span> <span class="n">u32</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">write32_mbox</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">off</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">MBOX_WRITE_REORDER</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">ICH_WORKAROUND</span><span class="p">))</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">read32_mbox</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">off</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tg3_write32_tx_mbox</span><span class="p">(</span><span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span><span class="p">,</span> <span class="n">u32</span> <span class="n">off</span><span class="p">,</span> <span class="n">u32</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">mbox</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">off</span><span class="p">;</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">mbox</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">TXD_MBOX_HWBUG</span><span class="p">))</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">mbox</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">MBOX_WRITE_REORDER</span><span class="p">))</span>
		<span class="n">readl</span><span class="p">(</span><span class="n">mbox</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">tg3_read32_mbox_5906</span><span class="p">(</span><span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span><span class="p">,</span> <span class="n">u32</span> <span class="n">off</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">readl</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">off</span> <span class="o">+</span> <span class="n">GRCMBOX_BASE</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tg3_write32_mbox_5906</span><span class="p">(</span><span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span><span class="p">,</span> <span class="n">u32</span> <span class="n">off</span><span class="p">,</span> <span class="n">u32</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">off</span> <span class="o">+</span> <span class="n">GRCMBOX_BASE</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#define tw32_mailbox(reg, val)		tp-&gt;write32_mbox(tp, reg, val)</span>
<span class="cp">#define tw32_mailbox_f(reg, val)	tw32_mailbox_flush(tp, (reg), (val))</span>
<span class="cp">#define tw32_rx_mbox(reg, val)		tp-&gt;write32_rx_mbox(tp, reg, val)</span>
<span class="cp">#define tw32_tx_mbox(reg, val)		tp-&gt;write32_tx_mbox(tp, reg, val)</span>
<span class="cp">#define tr32_mailbox(reg)		tp-&gt;read32_mbox(tp, reg)</span>

<span class="cp">#define tw32(reg, val)			tp-&gt;write32(tp, reg, val)</span>
<span class="cp">#define tw32_f(reg, val)		_tw32_flush(tp, (reg), (val), 0)</span>
<span class="cp">#define tw32_wait_f(reg, val, us)	_tw32_flush(tp, (reg), (val), (us))</span>
<span class="cp">#define tr32(reg)			tp-&gt;read32(tp, reg)</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tg3_write_mem</span><span class="p">(</span><span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span><span class="p">,</span> <span class="n">u32</span> <span class="n">off</span><span class="p">,</span> <span class="n">u32</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">ASIC_REV_5906</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">off</span> <span class="o">&gt;=</span> <span class="n">NIC_SRAM_STATS_BLK</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">off</span> <span class="o">&lt;</span> <span class="n">NIC_SRAM_TX_BUFFER_DESC</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">indirect_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">SRAM_USE_CONFIG</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">TG3PCI_MEM_WIN_BASE_ADDR</span><span class="p">,</span> <span class="n">off</span><span class="p">);</span>
		<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">TG3PCI_MEM_WIN_DATA</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

		<span class="cm">/* Always leave this as zero. */</span>
		<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">TG3PCI_MEM_WIN_BASE_ADDR</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">tw32_f</span><span class="p">(</span><span class="n">TG3PCI_MEM_WIN_BASE_ADDR</span><span class="p">,</span> <span class="n">off</span><span class="p">);</span>
		<span class="n">tw32_f</span><span class="p">(</span><span class="n">TG3PCI_MEM_WIN_DATA</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

		<span class="cm">/* Always leave this as zero. */</span>
		<span class="n">tw32_f</span><span class="p">(</span><span class="n">TG3PCI_MEM_WIN_BASE_ADDR</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">indirect_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tg3_read_mem</span><span class="p">(</span><span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span><span class="p">,</span> <span class="n">u32</span> <span class="n">off</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">ASIC_REV_5906</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">off</span> <span class="o">&gt;=</span> <span class="n">NIC_SRAM_STATS_BLK</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">off</span> <span class="o">&lt;</span> <span class="n">NIC_SRAM_TX_BUFFER_DESC</span><span class="p">))</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">indirect_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">SRAM_USE_CONFIG</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">TG3PCI_MEM_WIN_BASE_ADDR</span><span class="p">,</span> <span class="n">off</span><span class="p">);</span>
		<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">TG3PCI_MEM_WIN_DATA</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

		<span class="cm">/* Always leave this as zero. */</span>
		<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">TG3PCI_MEM_WIN_BASE_ADDR</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">tw32_f</span><span class="p">(</span><span class="n">TG3PCI_MEM_WIN_BASE_ADDR</span><span class="p">,</span> <span class="n">off</span><span class="p">);</span>
		<span class="o">*</span><span class="n">val</span> <span class="o">=</span> <span class="n">tr32</span><span class="p">(</span><span class="n">TG3PCI_MEM_WIN_DATA</span><span class="p">);</span>

		<span class="cm">/* Always leave this as zero. */</span>
		<span class="n">tw32_f</span><span class="p">(</span><span class="n">TG3PCI_MEM_WIN_BASE_ADDR</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">indirect_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tg3_ape_lock_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">regbase</span><span class="p">,</span> <span class="n">bit</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">ASIC_REV_5761</span><span class="p">)</span>
		<span class="n">regbase</span> <span class="o">=</span> <span class="n">TG3_APE_LOCK_GRANT</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">regbase</span> <span class="o">=</span> <span class="n">TG3_APE_PER_LOCK_GRANT</span><span class="p">;</span>

	<span class="cm">/* Make sure the driver hasn&#39;t any stale locks. */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">TG3_APE_LOCK_PHY0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">TG3_APE_LOCK_GPIO</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">TG3_APE_LOCK_PHY0</span>:
		<span class="k">case</span> <span class="n">TG3_APE_LOCK_PHY1</span>:
		<span class="k">case</span> <span class="n">TG3_APE_LOCK_PHY2</span>:
		<span class="k">case</span> <span class="n">TG3_APE_LOCK_PHY3</span>:
			<span class="n">bit</span> <span class="o">=</span> <span class="n">APE_LOCK_GRANT_DRIVER</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_fn</span><span class="p">)</span>
				<span class="n">bit</span> <span class="o">=</span> <span class="n">APE_LOCK_GRANT_DRIVER</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">bit</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_fn</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">tg3_ape_write32</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">regbase</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">i</span><span class="p">,</span> <span class="n">bit</span><span class="p">);</span>
	<span class="p">}</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tg3_ape_lock</span><span class="p">(</span><span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">locknum</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">off</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">status</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="n">gnt</span><span class="p">,</span> <span class="n">bit</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">ENABLE_APE</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">locknum</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">TG3_APE_LOCK_GPIO</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">ASIC_REV_5761</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TG3_APE_LOCK_GRC</span>:
	<span class="k">case</span> <span class="n">TG3_APE_LOCK_MEM</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_fn</span><span class="p">)</span>
			<span class="n">bit</span> <span class="o">=</span> <span class="n">APE_LOCK_REQ_DRIVER</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">bit</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_fn</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">ASIC_REV_5761</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">req</span> <span class="o">=</span> <span class="n">TG3_APE_LOCK_REQ</span><span class="p">;</span>
		<span class="n">gnt</span> <span class="o">=</span> <span class="n">TG3_APE_LOCK_GRANT</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">req</span> <span class="o">=</span> <span class="n">TG3_APE_PER_LOCK_REQ</span><span class="p">;</span>
		<span class="n">gnt</span> <span class="o">=</span> <span class="n">TG3_APE_PER_LOCK_GRANT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">off</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">locknum</span><span class="p">;</span>

	<span class="n">tg3_ape_write32</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">req</span> <span class="o">+</span> <span class="n">off</span><span class="p">,</span> <span class="n">bit</span><span class="p">);</span>

	<span class="cm">/* Wait for up to 1 millisecond to acquire lock. */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">tg3_ape_read32</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">gnt</span> <span class="o">+</span> <span class="n">off</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="n">bit</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="n">bit</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Revoke the lock request. */</span>
		<span class="n">tg3_ape_write32</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">gnt</span> <span class="o">+</span> <span class="n">off</span><span class="p">,</span> <span class="n">bit</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tg3_ape_unlock</span><span class="p">(</span><span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">locknum</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">gnt</span><span class="p">,</span> <span class="n">bit</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">ENABLE_APE</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">locknum</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">TG3_APE_LOCK_GPIO</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">ASIC_REV_5761</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TG3_APE_LOCK_GRC</span>:
	<span class="k">case</span> <span class="n">TG3_APE_LOCK_MEM</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_fn</span><span class="p">)</span>
			<span class="n">bit</span> <span class="o">=</span> <span class="n">APE_LOCK_GRANT_DRIVER</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">bit</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_fn</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">ASIC_REV_5761</span><span class="p">)</span>
		<span class="n">gnt</span> <span class="o">=</span> <span class="n">TG3_APE_LOCK_GRANT</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">gnt</span> <span class="o">=</span> <span class="n">TG3_APE_PER_LOCK_GRANT</span><span class="p">;</span>

	<span class="n">tg3_ape_write32</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">gnt</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">locknum</span><span class="p">,</span> <span class="n">bit</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tg3_ape_send_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span><span class="p">,</span> <span class="n">u32</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">apedata</span><span class="p">;</span>

	<span class="cm">/* NCSI does not support APE events */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">APE_HAS_NCSI</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">apedata</span> <span class="o">=</span> <span class="n">tg3_ape_read32</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">TG3_APE_SEG_SIG</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">apedata</span> <span class="o">!=</span> <span class="n">APE_SEG_SIG_MAGIC</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">apedata</span> <span class="o">=</span> <span class="n">tg3_ape_read32</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">TG3_APE_FW_STATUS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">apedata</span> <span class="o">&amp;</span> <span class="n">APE_FW_STATUS_READY</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* Wait for up to 1 millisecond for APE to service previous event. */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tg3_ape_lock</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">TG3_APE_LOCK_MEM</span><span class="p">))</span>
			<span class="k">return</span><span class="p">;</span>

		<span class="n">apedata</span> <span class="o">=</span> <span class="n">tg3_ape_read32</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">TG3_APE_EVENT_STATUS</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">apedata</span> <span class="o">&amp;</span> <span class="n">APE_EVENT_STATUS_EVENT_PENDING</span><span class="p">))</span>
			<span class="n">tg3_ape_write32</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">TG3_APE_EVENT_STATUS</span><span class="p">,</span>
					<span class="n">event</span> <span class="o">|</span> <span class="n">APE_EVENT_STATUS_EVENT_PENDING</span><span class="p">);</span>

		<span class="n">tg3_ape_unlock</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">TG3_APE_LOCK_MEM</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">apedata</span> <span class="o">&amp;</span> <span class="n">APE_EVENT_STATUS_EVENT_PENDING</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">udelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">apedata</span> <span class="o">&amp;</span> <span class="n">APE_EVENT_STATUS_EVENT_PENDING</span><span class="p">))</span>
		<span class="n">tg3_ape_write32</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">TG3_APE_EVENT</span><span class="p">,</span> <span class="n">APE_EVENT_1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tg3_ape_driver_state_change</span><span class="p">(</span><span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">kind</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">event</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">apedata</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">ENABLE_APE</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">kind</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">RESET_KIND_INIT</span>:
		<span class="n">tg3_ape_write32</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">TG3_APE_HOST_SEG_SIG</span><span class="p">,</span>
				<span class="n">APE_HOST_SEG_SIG_MAGIC</span><span class="p">);</span>
		<span class="n">tg3_ape_write32</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">TG3_APE_HOST_SEG_LEN</span><span class="p">,</span>
				<span class="n">APE_HOST_SEG_LEN_MAGIC</span><span class="p">);</span>
		<span class="n">apedata</span> <span class="o">=</span> <span class="n">tg3_ape_read32</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">TG3_APE_HOST_INIT_COUNT</span><span class="p">);</span>
		<span class="n">tg3_ape_write32</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">TG3_APE_HOST_INIT_COUNT</span><span class="p">,</span> <span class="o">++</span><span class="n">apedata</span><span class="p">);</span>
		<span class="n">tg3_ape_write32</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">TG3_APE_HOST_DRIVER_ID</span><span class="p">,</span>
			<span class="n">APE_HOST_DRIVER_ID_MAGIC</span><span class="p">(</span><span class="n">TG3_MAJ_NUM</span><span class="p">,</span> <span class="n">TG3_MIN_NUM</span><span class="p">));</span>
		<span class="n">tg3_ape_write32</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">TG3_APE_HOST_BEHAVIOR</span><span class="p">,</span>
				<span class="n">APE_HOST_BEHAV_NO_PHYLOCK</span><span class="p">);</span>
		<span class="n">tg3_ape_write32</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">TG3_APE_HOST_DRVR_STATE</span><span class="p">,</span>
				    <span class="n">TG3_APE_HOST_DRVR_STATE_START</span><span class="p">);</span>

		<span class="n">event</span> <span class="o">=</span> <span class="n">APE_EVENT_STATUS_STATE_START</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">RESET_KIND_SHUTDOWN</span>:
		<span class="cm">/* With the interface we are currently using,</span>
<span class="cm">		 * APE does not track driver state.  Wiping</span>
<span class="cm">		 * out the HOST SEGMENT SIGNATURE forces</span>
<span class="cm">		 * the APE to assume OS absent status.</span>
<span class="cm">		 */</span>
		<span class="n">tg3_ape_write32</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">TG3_APE_HOST_SEG_SIG</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">device_may_wakeup</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">WOL_ENABLE</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">tg3_ape_write32</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">TG3_APE_HOST_WOL_SPEED</span><span class="p">,</span>
					    <span class="n">TG3_APE_HOST_WOL_SPEED_AUTO</span><span class="p">);</span>
			<span class="n">apedata</span> <span class="o">=</span> <span class="n">TG3_APE_HOST_DRVR_STATE_WOL</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">apedata</span> <span class="o">=</span> <span class="n">TG3_APE_HOST_DRVR_STATE_UNLOAD</span><span class="p">;</span>

		<span class="n">tg3_ape_write32</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">TG3_APE_HOST_DRVR_STATE</span><span class="p">,</span> <span class="n">apedata</span><span class="p">);</span>

		<span class="n">event</span> <span class="o">=</span> <span class="n">APE_EVENT_STATUS_STATE_UNLOAD</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">RESET_KIND_SUSPEND</span>:
		<span class="n">event</span> <span class="o">=</span> <span class="n">APE_EVENT_STATUS_STATE_SUSPEND</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">event</span> <span class="o">|=</span> <span class="n">APE_EVENT_STATUS_DRIVER_EVNT</span> <span class="o">|</span> <span class="n">APE_EVENT_STATUS_STATE_CHNGE</span><span class="p">;</span>

	<span class="n">tg3_ape_send_event</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tg3_disable_ints</span><span class="p">(</span><span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">tw32</span><span class="p">(</span><span class="n">TG3PCI_MISC_HOST_CTRL</span><span class="p">,</span>
	     <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">misc_host_ctrl</span> <span class="o">|</span> <span class="n">MISC_HOST_CTRL_MASK_PCI_INT</span><span class="p">));</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">irq_max</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">tw32_mailbox_f</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">int_mbox</span><span class="p">,</span> <span class="mh">0x00000001</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tg3_enable_ints</span><span class="p">(</span><span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">irq_sync</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">wmb</span><span class="p">();</span>

	<span class="n">tw32</span><span class="p">(</span><span class="n">TG3PCI_MISC_HOST_CTRL</span><span class="p">,</span>
	     <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">misc_host_ctrl</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">MISC_HOST_CTRL_MASK_PCI_INT</span><span class="p">));</span>

	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">coal_now</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">coalesce_mode</span> <span class="o">|</span> <span class="n">HOSTCC_MODE_ENABLE</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">irq_cnt</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">tg3_napi</span> <span class="o">*</span><span class="n">tnapi</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="n">tw32_mailbox_f</span><span class="p">(</span><span class="n">tnapi</span><span class="o">-&gt;</span><span class="n">int_mbox</span><span class="p">,</span> <span class="n">tnapi</span><span class="o">-&gt;</span><span class="n">last_tag</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">1</span><span class="n">SHOT_MSI</span><span class="p">))</span>
			<span class="n">tw32_mailbox_f</span><span class="p">(</span><span class="n">tnapi</span><span class="o">-&gt;</span><span class="n">int_mbox</span><span class="p">,</span> <span class="n">tnapi</span><span class="o">-&gt;</span><span class="n">last_tag</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">);</span>

		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">coal_now</span> <span class="o">|=</span> <span class="n">tnapi</span><span class="o">-&gt;</span><span class="n">coal_now</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Force an initial interrupt */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">TAGGED_STATUS</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">hw_status</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">SD_STATUS_UPDATED</span><span class="p">))</span>
		<span class="n">tw32</span><span class="p">(</span><span class="n">GRC_LOCAL_CTRL</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">grc_local_ctrl</span> <span class="o">|</span> <span class="n">GRC_LCLCTRL_SETINT</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">tw32</span><span class="p">(</span><span class="n">HOSTCC_MODE</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">coal_now</span><span class="p">);</span>

	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">coal_now</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">coal_now</span> <span class="o">|</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">coal_now</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">tg3_has_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">tg3_napi</span> <span class="o">*</span><span class="n">tnapi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="n">tnapi</span><span class="o">-&gt;</span><span class="n">tp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tg3_hw_status</span> <span class="o">*</span><span class="n">sblk</span> <span class="o">=</span> <span class="n">tnapi</span><span class="o">-&gt;</span><span class="n">hw_status</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">work_exists</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* check for phy events */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">USE_LINKCHG_REG</span><span class="p">)</span> <span class="o">||</span> <span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">POLL_SERDES</span><span class="p">)))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sblk</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">SD_STATUS_LINK_CHG</span><span class="p">)</span>
			<span class="n">work_exists</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* check for TX work to do */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sblk</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">tx_consumer</span> <span class="o">!=</span> <span class="n">tnapi</span><span class="o">-&gt;</span><span class="n">tx_cons</span><span class="p">)</span>
		<span class="n">work_exists</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* check for RX work to do */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tnapi</span><span class="o">-&gt;</span><span class="n">rx_rcb_prod_idx</span> <span class="o">&amp;&amp;</span>
	    <span class="o">*</span><span class="p">(</span><span class="n">tnapi</span><span class="o">-&gt;</span><span class="n">rx_rcb_prod_idx</span><span class="p">)</span> <span class="o">!=</span> <span class="n">tnapi</span><span class="o">-&gt;</span><span class="n">rx_rcb_ptr</span><span class="p">)</span>
		<span class="n">work_exists</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">work_exists</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* tg3_int_reenable</span>
<span class="cm"> *  similar to tg3_enable_ints, but it accurately determines whether there</span>
<span class="cm"> *  is new work pending and can return without flushing the PIO write</span>
<span class="cm"> *  which reenables interrupts</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">tg3_int_reenable</span><span class="p">(</span><span class="k">struct</span> <span class="n">tg3_napi</span> <span class="o">*</span><span class="n">tnapi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="n">tnapi</span><span class="o">-&gt;</span><span class="n">tp</span><span class="p">;</span>

	<span class="n">tw32_mailbox</span><span class="p">(</span><span class="n">tnapi</span><span class="o">-&gt;</span><span class="n">int_mbox</span><span class="p">,</span> <span class="n">tnapi</span><span class="o">-&gt;</span><span class="n">last_tag</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">);</span>
	<span class="n">mmiowb</span><span class="p">();</span>

	<span class="cm">/* When doing tagged status, this work check is unnecessary.</span>
<span class="cm">	 * The last_tag we write above tells the chip which piece of</span>
<span class="cm">	 * work we&#39;ve completed.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">TAGGED_STATUS</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">tg3_has_work</span><span class="p">(</span><span class="n">tnapi</span><span class="p">))</span>
		<span class="n">tw32</span><span class="p">(</span><span class="n">HOSTCC_MODE</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">coalesce_mode</span> <span class="o">|</span>
		     <span class="n">HOSTCC_MODE_ENABLE</span> <span class="o">|</span> <span class="n">tnapi</span><span class="o">-&gt;</span><span class="n">coal_now</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tg3_switch_clocks</span><span class="p">(</span><span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">clock_ctrl</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">orig_clock_ctrl</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">CPMU_PRESENT</span><span class="p">)</span> <span class="o">||</span> <span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">5780</span><span class="n">_CLASS</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">clock_ctrl</span> <span class="o">=</span> <span class="n">tr32</span><span class="p">(</span><span class="n">TG3PCI_CLOCK_CTRL</span><span class="p">);</span>

	<span class="n">orig_clock_ctrl</span> <span class="o">=</span> <span class="n">clock_ctrl</span><span class="p">;</span>
	<span class="n">clock_ctrl</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="n">CLOCK_CTRL_FORCE_CLKRUN</span> <span class="o">|</span>
		       <span class="n">CLOCK_CTRL_CLKRUN_OENABLE</span> <span class="o">|</span>
		       <span class="mh">0x1f</span><span class="p">);</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_clock_ctrl</span> <span class="o">=</span> <span class="n">clock_ctrl</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">5705</span><span class="n">_PLUS</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">orig_clock_ctrl</span> <span class="o">&amp;</span> <span class="n">CLOCK_CTRL_625_CORE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">tw32_wait_f</span><span class="p">(</span><span class="n">TG3PCI_CLOCK_CTRL</span><span class="p">,</span>
				    <span class="n">clock_ctrl</span> <span class="o">|</span> <span class="n">CLOCK_CTRL_625_CORE</span><span class="p">,</span> <span class="mi">40</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">orig_clock_ctrl</span> <span class="o">&amp;</span> <span class="n">CLOCK_CTRL_44MHZ_CORE</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tw32_wait_f</span><span class="p">(</span><span class="n">TG3PCI_CLOCK_CTRL</span><span class="p">,</span>
			    <span class="n">clock_ctrl</span> <span class="o">|</span>
			    <span class="p">(</span><span class="n">CLOCK_CTRL_44MHZ_CORE</span> <span class="o">|</span> <span class="n">CLOCK_CTRL_ALTCLK</span><span class="p">),</span>
			    <span class="mi">40</span><span class="p">);</span>
		<span class="n">tw32_wait_f</span><span class="p">(</span><span class="n">TG3PCI_CLOCK_CTRL</span><span class="p">,</span>
			    <span class="n">clock_ctrl</span> <span class="o">|</span> <span class="p">(</span><span class="n">CLOCK_CTRL_ALTCLK</span><span class="p">),</span>
			    <span class="mi">40</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">tw32_wait_f</span><span class="p">(</span><span class="n">TG3PCI_CLOCK_CTRL</span><span class="p">,</span> <span class="n">clock_ctrl</span><span class="p">,</span> <span class="mi">40</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#define PHY_BUSY_LOOPS	5000</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tg3_readphy</span><span class="p">(</span><span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">frame_val</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">loops</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">mi_mode</span> <span class="o">&amp;</span> <span class="n">MAC_MI_MODE_AUTO_POLL</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tw32_f</span><span class="p">(</span><span class="n">MAC_MI_MODE</span><span class="p">,</span>
		     <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">mi_mode</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">MAC_MI_MODE_AUTO_POLL</span><span class="p">));</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">80</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="o">*</span><span class="n">val</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>

	<span class="n">frame_val</span>  <span class="o">=</span> <span class="p">((</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">phy_addr</span> <span class="o">&lt;&lt;</span> <span class="n">MI_COM_PHY_ADDR_SHIFT</span><span class="p">)</span> <span class="o">&amp;</span>
		      <span class="n">MI_COM_PHY_ADDR_MASK</span><span class="p">);</span>
	<span class="n">frame_val</span> <span class="o">|=</span> <span class="p">((</span><span class="n">reg</span> <span class="o">&lt;&lt;</span> <span class="n">MI_COM_REG_ADDR_SHIFT</span><span class="p">)</span> <span class="o">&amp;</span>
		      <span class="n">MI_COM_REG_ADDR_MASK</span><span class="p">);</span>
	<span class="n">frame_val</span> <span class="o">|=</span> <span class="p">(</span><span class="n">MI_COM_CMD_READ</span> <span class="o">|</span> <span class="n">MI_COM_START</span><span class="p">);</span>

	<span class="n">tw32_f</span><span class="p">(</span><span class="n">MAC_MI_COM</span><span class="p">,</span> <span class="n">frame_val</span><span class="p">);</span>

	<span class="n">loops</span> <span class="o">=</span> <span class="n">PHY_BUSY_LOOPS</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">loops</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
		<span class="n">frame_val</span> <span class="o">=</span> <span class="n">tr32</span><span class="p">(</span><span class="n">MAC_MI_COM</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">frame_val</span> <span class="o">&amp;</span> <span class="n">MI_COM_BUSY</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
			<span class="n">frame_val</span> <span class="o">=</span> <span class="n">tr32</span><span class="p">(</span><span class="n">MAC_MI_COM</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">loops</span> <span class="o">-=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">loops</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">val</span> <span class="o">=</span> <span class="n">frame_val</span> <span class="o">&amp;</span> <span class="n">MI_COM_DATA_MASK</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">mi_mode</span> <span class="o">&amp;</span> <span class="n">MAC_MI_MODE_AUTO_POLL</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tw32_f</span><span class="p">(</span><span class="n">MAC_MI_MODE</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">mi_mode</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">80</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tg3_writephy</span><span class="p">(</span><span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u32</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">frame_val</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">loops</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">phy_flags</span> <span class="o">&amp;</span> <span class="n">TG3_PHYFLG_IS_FET</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">reg</span> <span class="o">==</span> <span class="n">MII_CTRL1000</span> <span class="o">||</span> <span class="n">reg</span> <span class="o">==</span> <span class="n">MII_TG3_AUX_CTRL</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">mi_mode</span> <span class="o">&amp;</span> <span class="n">MAC_MI_MODE_AUTO_POLL</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tw32_f</span><span class="p">(</span><span class="n">MAC_MI_MODE</span><span class="p">,</span>
		     <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">mi_mode</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">MAC_MI_MODE_AUTO_POLL</span><span class="p">));</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">80</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">frame_val</span>  <span class="o">=</span> <span class="p">((</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">phy_addr</span> <span class="o">&lt;&lt;</span> <span class="n">MI_COM_PHY_ADDR_SHIFT</span><span class="p">)</span> <span class="o">&amp;</span>
		      <span class="n">MI_COM_PHY_ADDR_MASK</span><span class="p">);</span>
	<span class="n">frame_val</span> <span class="o">|=</span> <span class="p">((</span><span class="n">reg</span> <span class="o">&lt;&lt;</span> <span class="n">MI_COM_REG_ADDR_SHIFT</span><span class="p">)</span> <span class="o">&amp;</span>
		      <span class="n">MI_COM_REG_ADDR_MASK</span><span class="p">);</span>
	<span class="n">frame_val</span> <span class="o">|=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">MI_COM_DATA_MASK</span><span class="p">);</span>
	<span class="n">frame_val</span> <span class="o">|=</span> <span class="p">(</span><span class="n">MI_COM_CMD_WRITE</span> <span class="o">|</span> <span class="n">MI_COM_START</span><span class="p">);</span>

	<span class="n">tw32_f</span><span class="p">(</span><span class="n">MAC_MI_COM</span><span class="p">,</span> <span class="n">frame_val</span><span class="p">);</span>

	<span class="n">loops</span> <span class="o">=</span> <span class="n">PHY_BUSY_LOOPS</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">loops</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
		<span class="n">frame_val</span> <span class="o">=</span> <span class="n">tr32</span><span class="p">(</span><span class="n">MAC_MI_COM</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">frame_val</span> <span class="o">&amp;</span> <span class="n">MI_COM_BUSY</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
			<span class="n">frame_val</span> <span class="o">=</span> <span class="n">tr32</span><span class="p">(</span><span class="n">MAC_MI_COM</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">loops</span> <span class="o">-=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">loops</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">mi_mode</span> <span class="o">&amp;</span> <span class="n">MAC_MI_MODE_AUTO_POLL</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tw32_f</span><span class="p">(</span><span class="n">MAC_MI_MODE</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">mi_mode</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">80</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tg3_phy_cl45_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span><span class="p">,</span> <span class="n">u32</span> <span class="n">devad</span><span class="p">,</span> <span class="n">u32</span> <span class="n">addr</span><span class="p">,</span> <span class="n">u32</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">tg3_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">MII_TG3_MMD_CTRL</span><span class="p">,</span> <span class="n">devad</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">tg3_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">MII_TG3_MMD_ADDRESS</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">tg3_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">MII_TG3_MMD_CTRL</span><span class="p">,</span>
			   <span class="n">MII_TG3_MMD_CTRL_DATA_NOINC</span> <span class="o">|</span> <span class="n">devad</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">tg3_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">MII_TG3_MMD_ADDRESS</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

<span class="nl">done:</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tg3_phy_cl45_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span><span class="p">,</span> <span class="n">u32</span> <span class="n">devad</span><span class="p">,</span> <span class="n">u32</span> <span class="n">addr</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">tg3_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">MII_TG3_MMD_CTRL</span><span class="p">,</span> <span class="n">devad</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">tg3_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">MII_TG3_MMD_ADDRESS</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">tg3_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">MII_TG3_MMD_CTRL</span><span class="p">,</span>
			   <span class="n">MII_TG3_MMD_CTRL_DATA_NOINC</span> <span class="o">|</span> <span class="n">devad</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">tg3_readphy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">MII_TG3_MMD_ADDRESS</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

<span class="nl">done:</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tg3_phydsp_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span><span class="p">,</span> <span class="n">u32</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">tg3_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">MII_TG3_DSP_ADDRESS</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">tg3_readphy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">MII_TG3_DSP_RW_PORT</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tg3_phydsp_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span><span class="p">,</span> <span class="n">u32</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u32</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">tg3_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">MII_TG3_DSP_ADDRESS</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">tg3_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">MII_TG3_DSP_RW_PORT</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tg3_phy_auxctl_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">tg3_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">MII_TG3_AUX_CTRL</span><span class="p">,</span>
			   <span class="p">(</span><span class="n">reg</span> <span class="o">&lt;&lt;</span> <span class="n">MII_TG3_AUXCTL_MISC_RDSEL_SHIFT</span><span class="p">)</span> <span class="o">|</span>
			   <span class="n">MII_TG3_AUXCTL_SHDWSEL_MISC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">tg3_readphy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">MII_TG3_AUX_CTRL</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tg3_phy_auxctl_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u32</span> <span class="n">set</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reg</span> <span class="o">==</span> <span class="n">MII_TG3_AUXCTL_SHDWSEL_MISC</span><span class="p">)</span>
		<span class="n">set</span> <span class="o">|=</span> <span class="n">MII_TG3_AUXCTL_MISC_WREN</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">tg3_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">MII_TG3_AUX_CTRL</span><span class="p">,</span> <span class="n">set</span> <span class="o">|</span> <span class="n">reg</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#define TG3_PHY_AUXCTL_SMDSP_ENABLE(tp) \</span>
<span class="cp">	tg3_phy_auxctl_write((tp), MII_TG3_AUXCTL_SHDWSEL_AUXCTL, \</span>
<span class="cp">			     MII_TG3_AUXCTL_ACTL_SMDSP_ENA | \</span>
<span class="cp">			     MII_TG3_AUXCTL_ACTL_TX_6DB)</span>

<span class="cp">#define TG3_PHY_AUXCTL_SMDSP_DISABLE(tp) \</span>
<span class="cp">	tg3_phy_auxctl_write((tp), MII_TG3_AUXCTL_SHDWSEL_AUXCTL, \</span>
<span class="cp">			     MII_TG3_AUXCTL_ACTL_TX_6DB);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tg3_bmcr_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">phy_control</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">limit</span><span class="p">,</span> <span class="n">err</span><span class="p">;</span>

	<span class="cm">/* OK, reset it, and poll the BMCR_RESET bit until it</span>
<span class="cm">	 * clears or we time out.</span>
<span class="cm">	 */</span>
	<span class="n">phy_control</span> <span class="o">=</span> <span class="n">BMCR_RESET</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">tg3_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">MII_BMCR</span><span class="p">,</span> <span class="n">phy_control</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="n">limit</span> <span class="o">=</span> <span class="mi">5000</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">limit</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">tg3_readphy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">MII_BMCR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">phy_control</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">phy_control</span> <span class="o">&amp;</span> <span class="n">BMCR_RESET</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">40</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">limit</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tg3_mdio_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">mii_bus</span> <span class="o">*</span><span class="n">bp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mii_id</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tg3_readphy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">))</span>
		<span class="n">val</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">val</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tg3_mdio_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">mii_bus</span> <span class="o">*</span><span class="n">bp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mii_id</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u16</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tg3_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">val</span><span class="p">))</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tg3_mdio_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">mii_bus</span> <span class="o">*</span><span class="n">bp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tg3_mdio_config_5785</span><span class="p">(</span><span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">phy_device</span> <span class="o">*</span><span class="n">phydev</span><span class="p">;</span>

	<span class="n">phydev</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">mdio_bus</span><span class="o">-&gt;</span><span class="n">phy_map</span><span class="p">[</span><span class="n">TG3_PHY_MII_ADDR</span><span class="p">];</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">phydev</span><span class="o">-&gt;</span><span class="n">drv</span><span class="o">-&gt;</span><span class="n">phy_id</span> <span class="o">&amp;</span> <span class="n">phydev</span><span class="o">-&gt;</span><span class="n">drv</span><span class="o">-&gt;</span><span class="n">phy_id_mask</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PHY_ID_BCM50610</span>:
	<span class="k">case</span> <span class="n">PHY_ID_BCM50610M</span>:
		<span class="n">val</span> <span class="o">=</span> <span class="n">MAC_PHYCFG2_50610_LED_MODES</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PHY_ID_BCMAC131</span>:
		<span class="n">val</span> <span class="o">=</span> <span class="n">MAC_PHYCFG2_AC131_LED_MODES</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PHY_ID_RTL8211C</span>:
		<span class="n">val</span> <span class="o">=</span> <span class="n">MAC_PHYCFG2_RTL8211C_LED_MODES</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PHY_ID_RTL8201E</span>:
		<span class="n">val</span> <span class="o">=</span> <span class="n">MAC_PHYCFG2_RTL8201E_LED_MODES</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">phydev</span><span class="o">-&gt;</span><span class="n">interface</span> <span class="o">!=</span> <span class="n">PHY_INTERFACE_MODE_RGMII</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tw32</span><span class="p">(</span><span class="n">MAC_PHYCFG2</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

		<span class="n">val</span> <span class="o">=</span> <span class="n">tr32</span><span class="p">(</span><span class="n">MAC_PHYCFG1</span><span class="p">);</span>
		<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">MAC_PHYCFG1_RGMII_INT</span> <span class="o">|</span>
			 <span class="n">MAC_PHYCFG1_RXCLK_TO_MASK</span> <span class="o">|</span> <span class="n">MAC_PHYCFG1_TXCLK_TO_MASK</span><span class="p">);</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">MAC_PHYCFG1_RXCLK_TIMEOUT</span> <span class="o">|</span> <span class="n">MAC_PHYCFG1_TXCLK_TIMEOUT</span><span class="p">;</span>
		<span class="n">tw32</span><span class="p">(</span><span class="n">MAC_PHYCFG1</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">RGMII_INBAND_DISABLE</span><span class="p">))</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">MAC_PHYCFG2_EMODE_MASK_MASK</span> <span class="o">|</span>
		       <span class="n">MAC_PHYCFG2_FMODE_MASK_MASK</span> <span class="o">|</span>
		       <span class="n">MAC_PHYCFG2_GMODE_MASK_MASK</span> <span class="o">|</span>
		       <span class="n">MAC_PHYCFG2_ACT_MASK_MASK</span>   <span class="o">|</span>
		       <span class="n">MAC_PHYCFG2_QUAL_MASK_MASK</span> <span class="o">|</span>
		       <span class="n">MAC_PHYCFG2_INBAND_ENABLE</span><span class="p">;</span>

	<span class="n">tw32</span><span class="p">(</span><span class="n">MAC_PHYCFG2</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">tr32</span><span class="p">(</span><span class="n">MAC_PHYCFG1</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">MAC_PHYCFG1_RXCLK_TO_MASK</span> <span class="o">|</span> <span class="n">MAC_PHYCFG1_TXCLK_TO_MASK</span> <span class="o">|</span>
		 <span class="n">MAC_PHYCFG1_RGMII_EXT_RX_DEC</span> <span class="o">|</span> <span class="n">MAC_PHYCFG1_RGMII_SND_STAT_EN</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">RGMII_INBAND_DISABLE</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">RGMII_EXT_IBND_RX_EN</span><span class="p">))</span>
			<span class="n">val</span> <span class="o">|=</span> <span class="n">MAC_PHYCFG1_RGMII_EXT_RX_DEC</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">RGMII_EXT_IBND_TX_EN</span><span class="p">))</span>
			<span class="n">val</span> <span class="o">|=</span> <span class="n">MAC_PHYCFG1_RGMII_SND_STAT_EN</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">val</span> <span class="o">|=</span> <span class="n">MAC_PHYCFG1_RXCLK_TIMEOUT</span> <span class="o">|</span> <span class="n">MAC_PHYCFG1_TXCLK_TIMEOUT</span> <span class="o">|</span>
	       <span class="n">MAC_PHYCFG1_RGMII_INT</span> <span class="o">|</span> <span class="n">MAC_PHYCFG1_TXC_DRV</span><span class="p">;</span>
	<span class="n">tw32</span><span class="p">(</span><span class="n">MAC_PHYCFG1</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">tr32</span><span class="p">(</span><span class="n">MAC_EXT_RGMII_MODE</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">MAC_RGMII_MODE_RX_INT_B</span> <span class="o">|</span>
		 <span class="n">MAC_RGMII_MODE_RX_QUALITY</span> <span class="o">|</span>
		 <span class="n">MAC_RGMII_MODE_RX_ACTIVITY</span> <span class="o">|</span>
		 <span class="n">MAC_RGMII_MODE_RX_ENG_DET</span> <span class="o">|</span>
		 <span class="n">MAC_RGMII_MODE_TX_ENABLE</span> <span class="o">|</span>
		 <span class="n">MAC_RGMII_MODE_TX_LOWPWR</span> <span class="o">|</span>
		 <span class="n">MAC_RGMII_MODE_TX_RESET</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">RGMII_INBAND_DISABLE</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">RGMII_EXT_IBND_RX_EN</span><span class="p">))</span>
			<span class="n">val</span> <span class="o">|=</span> <span class="n">MAC_RGMII_MODE_RX_INT_B</span> <span class="o">|</span>
			       <span class="n">MAC_RGMII_MODE_RX_QUALITY</span> <span class="o">|</span>
			       <span class="n">MAC_RGMII_MODE_RX_ACTIVITY</span> <span class="o">|</span>
			       <span class="n">MAC_RGMII_MODE_RX_ENG_DET</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">RGMII_EXT_IBND_TX_EN</span><span class="p">))</span>
			<span class="n">val</span> <span class="o">|=</span> <span class="n">MAC_RGMII_MODE_TX_ENABLE</span> <span class="o">|</span>
			       <span class="n">MAC_RGMII_MODE_TX_LOWPWR</span> <span class="o">|</span>
			       <span class="n">MAC_RGMII_MODE_TX_RESET</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">tw32</span><span class="p">(</span><span class="n">MAC_EXT_RGMII_MODE</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tg3_mdio_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">mi_mode</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MAC_MI_MODE_AUTO_POLL</span><span class="p">;</span>
	<span class="n">tw32_f</span><span class="p">(</span><span class="n">MAC_MI_MODE</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">mi_mode</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">80</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">MDIOBUS_INITED</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">ASIC_REV_5785</span><span class="p">)</span>
		<span class="n">tg3_mdio_config_5785</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tg3_mdio_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">reg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">phy_device</span> <span class="o">*</span><span class="n">phydev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">5717</span><span class="n">_PLUS</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">is_serdes</span><span class="p">;</span>

		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">phy_addr</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_fn</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span> <span class="o">!=</span> <span class="n">CHIPREV_ID_5717_A0</span><span class="p">)</span>
			<span class="n">is_serdes</span> <span class="o">=</span> <span class="n">tr32</span><span class="p">(</span><span class="n">SG_DIG_STATUS</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">SG_DIG_IS_SERDES</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">is_serdes</span> <span class="o">=</span> <span class="n">tr32</span><span class="p">(</span><span class="n">TG3_CPMU_PHY_STRAP</span><span class="p">)</span> <span class="o">&amp;</span>
				    <span class="n">TG3_CPMU_PHY_STRAP_IS_SERDES</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">is_serdes</span><span class="p">)</span>
			<span class="n">tp</span><span class="o">-&gt;</span><span class="n">phy_addr</span> <span class="o">+=</span> <span class="mi">7</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">phy_addr</span> <span class="o">=</span> <span class="n">TG3_PHY_MII_ADDR</span><span class="p">;</span>

	<span class="n">tg3_mdio_start</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">USE_PHYLIB</span><span class="p">)</span> <span class="o">||</span> <span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">MDIOBUS_INITED</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">mdio_bus</span> <span class="o">=</span> <span class="n">mdiobus_alloc</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">mdio_bus</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">mdio_bus</span><span class="o">-&gt;</span><span class="n">name</span>     <span class="o">=</span> <span class="s">&quot;tg3 mdio bus&quot;</span><span class="p">;</span>
	<span class="n">snprintf</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">mdio_bus</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">MII_BUS_ID_SIZE</span><span class="p">,</span> <span class="s">&quot;%x&quot;</span><span class="p">,</span>
		 <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">number</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">);</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">mdio_bus</span><span class="o">-&gt;</span><span class="n">priv</span>     <span class="o">=</span> <span class="n">tp</span><span class="p">;</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">mdio_bus</span><span class="o">-&gt;</span><span class="n">parent</span>   <span class="o">=</span> <span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">mdio_bus</span><span class="o">-&gt;</span><span class="n">read</span>     <span class="o">=</span> <span class="o">&amp;</span><span class="n">tg3_mdio_read</span><span class="p">;</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">mdio_bus</span><span class="o">-&gt;</span><span class="n">write</span>    <span class="o">=</span> <span class="o">&amp;</span><span class="n">tg3_mdio_write</span><span class="p">;</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">mdio_bus</span><span class="o">-&gt;</span><span class="n">reset</span>    <span class="o">=</span> <span class="o">&amp;</span><span class="n">tg3_mdio_reset</span><span class="p">;</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">mdio_bus</span><span class="o">-&gt;</span><span class="n">phy_mask</span> <span class="o">=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">TG3_PHY_MII_ADDR</span><span class="p">);</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">mdio_bus</span><span class="o">-&gt;</span><span class="n">irq</span>      <span class="o">=</span> <span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">mdio_irq</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">PHY_MAX_ADDR</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">mdio_bus</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">PHY_POLL</span><span class="p">;</span>

	<span class="cm">/* The bus registration will look for all the PHYs on the mdio bus.</span>
<span class="cm">	 * Unfortunately, it does not ensure the PHY is powered up before</span>
<span class="cm">	 * accessing the PHY ID registers.  A chip reset is the</span>
<span class="cm">	 * quickest way to bring the device back to an operational state..</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tg3_readphy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">MII_BMCR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="n">BMCR_PDOWN</span><span class="p">))</span>
		<span class="n">tg3_bmcr_reset</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>

	<span class="n">i</span> <span class="o">=</span> <span class="n">mdiobus_register</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">mdio_bus</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;mdiobus_reg failed (0x%x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="n">mdiobus_free</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">mdio_bus</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">i</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">phydev</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">mdio_bus</span><span class="o">-&gt;</span><span class="n">phy_map</span><span class="p">[</span><span class="n">TG3_PHY_MII_ADDR</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">phydev</span> <span class="o">||</span> <span class="o">!</span><span class="n">phydev</span><span class="o">-&gt;</span><span class="n">drv</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;No PHY devices</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">mdiobus_unregister</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">mdio_bus</span><span class="p">);</span>
		<span class="n">mdiobus_free</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">mdio_bus</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">phydev</span><span class="o">-&gt;</span><span class="n">drv</span><span class="o">-&gt;</span><span class="n">phy_id</span> <span class="o">&amp;</span> <span class="n">phydev</span><span class="o">-&gt;</span><span class="n">drv</span><span class="o">-&gt;</span><span class="n">phy_id_mask</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PHY_ID_BCM57780</span>:
		<span class="n">phydev</span><span class="o">-&gt;</span><span class="n">interface</span> <span class="o">=</span> <span class="n">PHY_INTERFACE_MODE_GMII</span><span class="p">;</span>
		<span class="n">phydev</span><span class="o">-&gt;</span><span class="n">dev_flags</span> <span class="o">|=</span> <span class="n">PHY_BRCM_AUTO_PWRDWN_ENABLE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PHY_ID_BCM50610</span>:
	<span class="k">case</span> <span class="n">PHY_ID_BCM50610M</span>:
		<span class="n">phydev</span><span class="o">-&gt;</span><span class="n">dev_flags</span> <span class="o">|=</span> <span class="n">PHY_BRCM_CLEAR_RGMII_MODE</span> <span class="o">|</span>
				     <span class="n">PHY_BRCM_RX_REFCLK_UNUSED</span> <span class="o">|</span>
				     <span class="n">PHY_BRCM_DIS_TXCRXC_NOENRGY</span> <span class="o">|</span>
				     <span class="n">PHY_BRCM_AUTO_PWRDWN_ENABLE</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">RGMII_INBAND_DISABLE</span><span class="p">))</span>
			<span class="n">phydev</span><span class="o">-&gt;</span><span class="n">dev_flags</span> <span class="o">|=</span> <span class="n">PHY_BRCM_STD_IBND_DISABLE</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">RGMII_EXT_IBND_RX_EN</span><span class="p">))</span>
			<span class="n">phydev</span><span class="o">-&gt;</span><span class="n">dev_flags</span> <span class="o">|=</span> <span class="n">PHY_BRCM_EXT_IBND_RX_ENABLE</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">RGMII_EXT_IBND_TX_EN</span><span class="p">))</span>
			<span class="n">phydev</span><span class="o">-&gt;</span><span class="n">dev_flags</span> <span class="o">|=</span> <span class="n">PHY_BRCM_EXT_IBND_TX_ENABLE</span><span class="p">;</span>
		<span class="cm">/* fallthru */</span>
	<span class="k">case</span> <span class="n">PHY_ID_RTL8211C</span>:
		<span class="n">phydev</span><span class="o">-&gt;</span><span class="n">interface</span> <span class="o">=</span> <span class="n">PHY_INTERFACE_MODE_RGMII</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PHY_ID_RTL8201E</span>:
	<span class="k">case</span> <span class="n">PHY_ID_BCMAC131</span>:
		<span class="n">phydev</span><span class="o">-&gt;</span><span class="n">interface</span> <span class="o">=</span> <span class="n">PHY_INTERFACE_MODE_MII</span><span class="p">;</span>
		<span class="n">phydev</span><span class="o">-&gt;</span><span class="n">dev_flags</span> <span class="o">|=</span> <span class="n">PHY_BRCM_AUTO_PWRDWN_ENABLE</span><span class="p">;</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">phy_flags</span> <span class="o">|=</span> <span class="n">TG3_PHYFLG_IS_FET</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">tg3_flag_set</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">MDIOBUS_INITED</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">ASIC_REV_5785</span><span class="p">)</span>
		<span class="n">tg3_mdio_config_5785</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tg3_mdio_fini</span><span class="p">(</span><span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">MDIOBUS_INITED</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">tg3_flag_clear</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">MDIOBUS_INITED</span><span class="p">);</span>
		<span class="n">mdiobus_unregister</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">mdio_bus</span><span class="p">);</span>
		<span class="n">mdiobus_free</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">mdio_bus</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* tp-&gt;lock is held. */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">tg3_generate_fw_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">tr32</span><span class="p">(</span><span class="n">GRC_RX_CPU_EVENT</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">|=</span> <span class="n">GRC_RX_CPU_DRIVER_EVENT</span><span class="p">;</span>
	<span class="n">tw32_f</span><span class="p">(</span><span class="n">GRC_RX_CPU_EVENT</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">last_event_jiffies</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define TG3_FW_EVENT_TIMEOUT_USEC 2500</span>

<span class="cm">/* tp-&gt;lock is held. */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">tg3_wait_for_event_ack</span><span class="p">(</span><span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">delay_cnt</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">time_remain</span><span class="p">;</span>

	<span class="cm">/* If enough time has passed, no wait is necessary. */</span>
	<span class="n">time_remain</span> <span class="o">=</span> <span class="p">(</span><span class="kt">long</span><span class="p">)(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">last_event_jiffies</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">+</span>
		      <span class="n">usecs_to_jiffies</span><span class="p">(</span><span class="n">TG3_FW_EVENT_TIMEOUT_USEC</span><span class="p">))</span> <span class="o">-</span>
		      <span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">jiffies</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">time_remain</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* Check if we can shorten the wait time. */</span>
	<span class="n">delay_cnt</span> <span class="o">=</span> <span class="n">jiffies_to_usecs</span><span class="p">(</span><span class="n">time_remain</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">delay_cnt</span> <span class="o">&gt;</span> <span class="n">TG3_FW_EVENT_TIMEOUT_USEC</span><span class="p">)</span>
		<span class="n">delay_cnt</span> <span class="o">=</span> <span class="n">TG3_FW_EVENT_TIMEOUT_USEC</span><span class="p">;</span>
	<span class="n">delay_cnt</span> <span class="o">=</span> <span class="p">(</span><span class="n">delay_cnt</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">delay_cnt</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">tr32</span><span class="p">(</span><span class="n">GRC_RX_CPU_EVENT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">GRC_RX_CPU_DRIVER_EVENT</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">8</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* tp-&gt;lock is held. */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">tg3_phy_gather_ump_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">reg</span><span class="p">,</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tg3_readphy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">MII_BMCR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="p">))</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">reg</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tg3_readphy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">MII_BMSR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="p">))</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">);</span>
	<span class="o">*</span><span class="n">data</span><span class="o">++</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tg3_readphy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">MII_ADVERTISE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="p">))</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">reg</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tg3_readphy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">MII_LPA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="p">))</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">);</span>
	<span class="o">*</span><span class="n">data</span><span class="o">++</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">phy_flags</span> <span class="o">&amp;</span> <span class="n">TG3_PHYFLG_MII_SERDES</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tg3_readphy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">MII_CTRL1000</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="p">))</span>
			<span class="n">val</span> <span class="o">=</span> <span class="n">reg</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tg3_readphy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">MII_STAT1000</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="p">))</span>
			<span class="n">val</span> <span class="o">|=</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="o">*</span><span class="n">data</span><span class="o">++</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tg3_readphy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">MII_PHYADDR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="p">))</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">reg</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="o">*</span><span class="n">data</span><span class="o">++</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* tp-&gt;lock is held. */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">tg3_ump_link_report</span><span class="p">(</span><span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">data</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">5780</span><span class="n">_CLASS</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">ENABLE_ASF</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">tg3_phy_gather_ump_data</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>

	<span class="n">tg3_wait_for_event_ack</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>

	<span class="n">tg3_write_mem</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">NIC_SRAM_FW_CMD_MBOX</span><span class="p">,</span> <span class="n">FWCMD_NICDRV_LINK_UPDATE</span><span class="p">);</span>
	<span class="n">tg3_write_mem</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">NIC_SRAM_FW_CMD_LEN_MBOX</span><span class="p">,</span> <span class="mi">14</span><span class="p">);</span>
	<span class="n">tg3_write_mem</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">NIC_SRAM_FW_CMD_DATA_MBOX</span> <span class="o">+</span> <span class="mh">0x0</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="n">tg3_write_mem</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">NIC_SRAM_FW_CMD_DATA_MBOX</span> <span class="o">+</span> <span class="mh">0x4</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
	<span class="n">tg3_write_mem</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">NIC_SRAM_FW_CMD_DATA_MBOX</span> <span class="o">+</span> <span class="mh">0x8</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
	<span class="n">tg3_write_mem</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">NIC_SRAM_FW_CMD_DATA_MBOX</span> <span class="o">+</span> <span class="mh">0xc</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>

	<span class="n">tg3_generate_fw_event</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* tp-&gt;lock is held. */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">tg3_stop_fw</span><span class="p">(</span><span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">ENABLE_ASF</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">ENABLE_APE</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Wait for RX cpu to ACK the previous event. */</span>
		<span class="n">tg3_wait_for_event_ack</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>

		<span class="n">tg3_write_mem</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">NIC_SRAM_FW_CMD_MBOX</span><span class="p">,</span> <span class="n">FWCMD_NICDRV_PAUSE_FW</span><span class="p">);</span>

		<span class="n">tg3_generate_fw_event</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>

		<span class="cm">/* Wait for RX cpu to ACK this event. */</span>
		<span class="n">tg3_wait_for_event_ack</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* tp-&gt;lock is held. */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">tg3_write_sig_pre_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">kind</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">tg3_write_mem</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">NIC_SRAM_FIRMWARE_MBOX</span><span class="p">,</span>
		      <span class="n">NIC_SRAM_FIRMWARE_MBOX_MAGIC1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">ASF_NEW_HANDSHAKE</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">kind</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">RESET_KIND_INIT</span>:
			<span class="n">tg3_write_mem</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">NIC_SRAM_FW_DRV_STATE_MBOX</span><span class="p">,</span>
				      <span class="n">DRV_STATE_START</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">RESET_KIND_SHUTDOWN</span>:
			<span class="n">tg3_write_mem</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">NIC_SRAM_FW_DRV_STATE_MBOX</span><span class="p">,</span>
				      <span class="n">DRV_STATE_UNLOAD</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">RESET_KIND_SUSPEND</span>:
			<span class="n">tg3_write_mem</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">NIC_SRAM_FW_DRV_STATE_MBOX</span><span class="p">,</span>
				      <span class="n">DRV_STATE_SUSPEND</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="nl">default:</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">kind</span> <span class="o">==</span> <span class="n">RESET_KIND_INIT</span> <span class="o">||</span>
	    <span class="n">kind</span> <span class="o">==</span> <span class="n">RESET_KIND_SUSPEND</span><span class="p">)</span>
		<span class="n">tg3_ape_driver_state_change</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">kind</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* tp-&gt;lock is held. */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">tg3_write_sig_post_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">kind</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">ASF_NEW_HANDSHAKE</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">kind</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">RESET_KIND_INIT</span>:
			<span class="n">tg3_write_mem</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">NIC_SRAM_FW_DRV_STATE_MBOX</span><span class="p">,</span>
				      <span class="n">DRV_STATE_START_DONE</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">RESET_KIND_SHUTDOWN</span>:
			<span class="n">tg3_write_mem</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">NIC_SRAM_FW_DRV_STATE_MBOX</span><span class="p">,</span>
				      <span class="n">DRV_STATE_UNLOAD_DONE</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="nl">default:</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">kind</span> <span class="o">==</span> <span class="n">RESET_KIND_SHUTDOWN</span><span class="p">)</span>
		<span class="n">tg3_ape_driver_state_change</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">kind</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* tp-&gt;lock is held. */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">tg3_write_sig_legacy</span><span class="p">(</span><span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">kind</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">ENABLE_ASF</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">kind</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">RESET_KIND_INIT</span>:
			<span class="n">tg3_write_mem</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">NIC_SRAM_FW_DRV_STATE_MBOX</span><span class="p">,</span>
				      <span class="n">DRV_STATE_START</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">RESET_KIND_SHUTDOWN</span>:
			<span class="n">tg3_write_mem</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">NIC_SRAM_FW_DRV_STATE_MBOX</span><span class="p">,</span>
				      <span class="n">DRV_STATE_UNLOAD</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">RESET_KIND_SUSPEND</span>:
			<span class="n">tg3_write_mem</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">NIC_SRAM_FW_DRV_STATE_MBOX</span><span class="p">,</span>
				      <span class="n">DRV_STATE_SUSPEND</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="nl">default:</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tg3_poll_fw</span><span class="p">(</span><span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">ASIC_REV_5906</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Wait up to 20ms for init done. */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">200</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tr32</span><span class="p">(</span><span class="n">VCPU_STATUS</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">VCPU_STATUS_INIT_DONE</span><span class="p">)</span>
				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Wait for firmware initialization to complete. */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">100000</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tg3_read_mem</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">NIC_SRAM_FIRMWARE_MBOX</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">==</span> <span class="o">~</span><span class="n">NIC_SRAM_FIRMWARE_MBOX_MAGIC1</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Chip might not be fitted with firmware.  Some Sun onboard</span>
<span class="cm">	 * parts are configured like that.  So don&#39;t signal the timeout</span>
<span class="cm">	 * of the above loop as an error, but do report the lack of</span>
<span class="cm">	 * running firmware once.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">100000</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">NO_FWARE_REPORTED</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">tg3_flag_set</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">NO_FWARE_REPORTED</span><span class="p">);</span>

		<span class="n">netdev_info</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;No firmware running</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span> <span class="o">==</span> <span class="n">CHIPREV_ID_57765_A0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* The 57765 A0 needs a little more</span>
<span class="cm">		 * time to do some important work.</span>
<span class="cm">		 */</span>
		<span class="n">mdelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tg3_link_report</span><span class="p">(</span><span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">netif_carrier_ok</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">netif_info</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">link</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Link is down</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">tg3_ump_link_report</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">netif_msg_link</span><span class="p">(</span><span class="n">tp</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">netdev_info</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Link is up at %d Mbps, %s duplex</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">link_config</span><span class="p">.</span><span class="n">active_speed</span> <span class="o">==</span> <span class="n">SPEED_1000</span> <span class="o">?</span>
			     <span class="mi">1000</span> <span class="o">:</span>
			     <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">link_config</span><span class="p">.</span><span class="n">active_speed</span> <span class="o">==</span> <span class="n">SPEED_100</span> <span class="o">?</span>
			      <span class="mi">100</span> <span class="o">:</span> <span class="mi">10</span><span class="p">)),</span>
			    <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">link_config</span><span class="p">.</span><span class="n">active_duplex</span> <span class="o">==</span> <span class="n">DUPLEX_FULL</span> <span class="o">?</span>
			     <span class="s">&quot;full&quot;</span> <span class="o">:</span> <span class="s">&quot;half&quot;</span><span class="p">));</span>

		<span class="n">netdev_info</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Flow control is %s for TX and %s for RX</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">link_config</span><span class="p">.</span><span class="n">active_flowctrl</span> <span class="o">&amp;</span> <span class="n">FLOW_CTRL_TX</span><span class="p">)</span> <span class="o">?</span>
			    <span class="s">&quot;on&quot;</span> <span class="o">:</span> <span class="s">&quot;off&quot;</span><span class="p">,</span>
			    <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">link_config</span><span class="p">.</span><span class="n">active_flowctrl</span> <span class="o">&amp;</span> <span class="n">FLOW_CTRL_RX</span><span class="p">)</span> <span class="o">?</span>
			    <span class="s">&quot;on&quot;</span> <span class="o">:</span> <span class="s">&quot;off&quot;</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">phy_flags</span> <span class="o">&amp;</span> <span class="n">TG3_PHYFLG_EEE_CAP</span><span class="p">)</span>
			<span class="n">netdev_info</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;EEE is %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				    <span class="n">tp</span><span class="o">-&gt;</span><span class="n">setlpicnt</span> <span class="o">?</span> <span class="s">&quot;enabled&quot;</span> <span class="o">:</span> <span class="s">&quot;disabled&quot;</span><span class="p">);</span>

		<span class="n">tg3_ump_link_report</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u16</span> <span class="nf">tg3_advert_flowctrl_1000X</span><span class="p">(</span><span class="n">u8</span> <span class="n">flow_ctrl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">miireg</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">flow_ctrl</span> <span class="o">&amp;</span> <span class="n">FLOW_CTRL_TX</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">flow_ctrl</span> <span class="o">&amp;</span> <span class="n">FLOW_CTRL_RX</span><span class="p">))</span>
		<span class="n">miireg</span> <span class="o">=</span> <span class="n">ADVERTISE_1000XPAUSE</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">flow_ctrl</span> <span class="o">&amp;</span> <span class="n">FLOW_CTRL_TX</span><span class="p">)</span>
		<span class="n">miireg</span> <span class="o">=</span> <span class="n">ADVERTISE_1000XPSE_ASYM</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">flow_ctrl</span> <span class="o">&amp;</span> <span class="n">FLOW_CTRL_RX</span><span class="p">)</span>
		<span class="n">miireg</span> <span class="o">=</span> <span class="n">ADVERTISE_1000XPAUSE</span> <span class="o">|</span> <span class="n">ADVERTISE_1000XPSE_ASYM</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">miireg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">miireg</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u8</span> <span class="nf">tg3_resolve_flowctrl_1000X</span><span class="p">(</span><span class="n">u16</span> <span class="n">lcladv</span><span class="p">,</span> <span class="n">u16</span> <span class="n">rmtadv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">cap</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lcladv</span> <span class="o">&amp;</span> <span class="n">rmtadv</span> <span class="o">&amp;</span> <span class="n">ADVERTISE_1000XPAUSE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cap</span> <span class="o">=</span> <span class="n">FLOW_CTRL_TX</span> <span class="o">|</span> <span class="n">FLOW_CTRL_RX</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">lcladv</span> <span class="o">&amp;</span> <span class="n">rmtadv</span> <span class="o">&amp;</span> <span class="n">ADVERTISE_1000XPSE_ASYM</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lcladv</span> <span class="o">&amp;</span> <span class="n">ADVERTISE_1000XPAUSE</span><span class="p">)</span>
			<span class="n">cap</span> <span class="o">=</span> <span class="n">FLOW_CTRL_RX</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rmtadv</span> <span class="o">&amp;</span> <span class="n">ADVERTISE_1000XPAUSE</span><span class="p">)</span>
			<span class="n">cap</span> <span class="o">=</span> <span class="n">FLOW_CTRL_TX</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">cap</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tg3_setup_flow_control</span><span class="p">(</span><span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span><span class="p">,</span> <span class="n">u32</span> <span class="n">lcladv</span><span class="p">,</span> <span class="n">u32</span> <span class="n">rmtadv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">autoneg</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">flowctrl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">old_rx_mode</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">rx_mode</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">old_tx_mode</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">tx_mode</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">USE_PHYLIB</span><span class="p">))</span>
		<span class="n">autoneg</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">mdio_bus</span><span class="o">-&gt;</span><span class="n">phy_map</span><span class="p">[</span><span class="n">TG3_PHY_MII_ADDR</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">autoneg</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">autoneg</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">link_config</span><span class="p">.</span><span class="n">autoneg</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">autoneg</span> <span class="o">==</span> <span class="n">AUTONEG_ENABLE</span> <span class="o">&amp;&amp;</span> <span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">PAUSE_AUTONEG</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">phy_flags</span> <span class="o">&amp;</span> <span class="n">TG3_PHYFLG_ANY_SERDES</span><span class="p">)</span>
			<span class="n">flowctrl</span> <span class="o">=</span> <span class="n">tg3_resolve_flowctrl_1000X</span><span class="p">(</span><span class="n">lcladv</span><span class="p">,</span> <span class="n">rmtadv</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">flowctrl</span> <span class="o">=</span> <span class="n">mii_resolve_flowctrl_fdx</span><span class="p">(</span><span class="n">lcladv</span><span class="p">,</span> <span class="n">rmtadv</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">flowctrl</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">link_config</span><span class="p">.</span><span class="n">flowctrl</span><span class="p">;</span>

	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">link_config</span><span class="p">.</span><span class="n">active_flowctrl</span> <span class="o">=</span> <span class="n">flowctrl</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">flowctrl</span> <span class="o">&amp;</span> <span class="n">FLOW_CTRL_RX</span><span class="p">)</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">rx_mode</span> <span class="o">|=</span> <span class="n">RX_MODE_FLOW_CTRL_ENABLE</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">rx_mode</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">RX_MODE_FLOW_CTRL_ENABLE</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">old_rx_mode</span> <span class="o">!=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">rx_mode</span><span class="p">)</span>
		<span class="n">tw32_f</span><span class="p">(</span><span class="n">MAC_RX_MODE</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">rx_mode</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">flowctrl</span> <span class="o">&amp;</span> <span class="n">FLOW_CTRL_TX</span><span class="p">)</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">tx_mode</span> <span class="o">|=</span> <span class="n">TX_MODE_FLOW_CTRL_ENABLE</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">tx_mode</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">TX_MODE_FLOW_CTRL_ENABLE</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">old_tx_mode</span> <span class="o">!=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">tx_mode</span><span class="p">)</span>
		<span class="n">tw32_f</span><span class="p">(</span><span class="n">MAC_TX_MODE</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">tx_mode</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tg3_adjust_link</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">oldflowctrl</span><span class="p">,</span> <span class="n">linkmesg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">mac_mode</span><span class="p">,</span> <span class="n">lcl_adv</span><span class="p">,</span> <span class="n">rmt_adv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">phy_device</span> <span class="o">*</span><span class="n">phydev</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">mdio_bus</span><span class="o">-&gt;</span><span class="n">phy_map</span><span class="p">[</span><span class="n">TG3_PHY_MII_ADDR</span><span class="p">];</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">mac_mode</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">mac_mode</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">MAC_MODE_PORT_MODE_MASK</span> <span class="o">|</span>
				    <span class="n">MAC_MODE_HALF_DUPLEX</span><span class="p">);</span>

	<span class="n">oldflowctrl</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">link_config</span><span class="p">.</span><span class="n">active_flowctrl</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">phydev</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">lcl_adv</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">rmt_adv</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">phydev</span><span class="o">-&gt;</span><span class="n">speed</span> <span class="o">==</span> <span class="n">SPEED_100</span> <span class="o">||</span> <span class="n">phydev</span><span class="o">-&gt;</span><span class="n">speed</span> <span class="o">==</span> <span class="n">SPEED_10</span><span class="p">)</span>
			<span class="n">mac_mode</span> <span class="o">|=</span> <span class="n">MAC_MODE_PORT_MODE_MII</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">phydev</span><span class="o">-&gt;</span><span class="n">speed</span> <span class="o">==</span> <span class="n">SPEED_1000</span> <span class="o">||</span>
			 <span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">!=</span> <span class="n">ASIC_REV_5785</span><span class="p">)</span>
			<span class="n">mac_mode</span> <span class="o">|=</span> <span class="n">MAC_MODE_PORT_MODE_GMII</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">mac_mode</span> <span class="o">|=</span> <span class="n">MAC_MODE_PORT_MODE_MII</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">phydev</span><span class="o">-&gt;</span><span class="n">duplex</span> <span class="o">==</span> <span class="n">DUPLEX_HALF</span><span class="p">)</span>
			<span class="n">mac_mode</span> <span class="o">|=</span> <span class="n">MAC_MODE_HALF_DUPLEX</span><span class="p">;</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">lcl_adv</span> <span class="o">=</span> <span class="n">mii_advertise_flowctrl</span><span class="p">(</span>
				  <span class="n">tp</span><span class="o">-&gt;</span><span class="n">link_config</span><span class="p">.</span><span class="n">flowctrl</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">phydev</span><span class="o">-&gt;</span><span class="n">pause</span><span class="p">)</span>
				<span class="n">rmt_adv</span> <span class="o">=</span> <span class="n">LPA_PAUSE_CAP</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">phydev</span><span class="o">-&gt;</span><span class="n">asym_pause</span><span class="p">)</span>
				<span class="n">rmt_adv</span> <span class="o">|=</span> <span class="n">LPA_PAUSE_ASYM</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">tg3_setup_flow_control</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">lcl_adv</span><span class="p">,</span> <span class="n">rmt_adv</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">mac_mode</span> <span class="o">|=</span> <span class="n">MAC_MODE_PORT_MODE_GMII</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mac_mode</span> <span class="o">!=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">mac_mode</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">mac_mode</span> <span class="o">=</span> <span class="n">mac_mode</span><span class="p">;</span>
		<span class="n">tw32_f</span><span class="p">(</span><span class="n">MAC_MODE</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">mac_mode</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">40</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">ASIC_REV_5785</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">phydev</span><span class="o">-&gt;</span><span class="n">speed</span> <span class="o">==</span> <span class="n">SPEED_10</span><span class="p">)</span>
			<span class="n">tw32</span><span class="p">(</span><span class="n">MAC_MI_STAT</span><span class="p">,</span>
			     <span class="n">MAC_MI_STAT_10MBPS_MODE</span> <span class="o">|</span>
			     <span class="n">MAC_MI_STAT_LNKSTAT_ATTN_ENAB</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">tw32</span><span class="p">(</span><span class="n">MAC_MI_STAT</span><span class="p">,</span> <span class="n">MAC_MI_STAT_LNKSTAT_ATTN_ENAB</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">phydev</span><span class="o">-&gt;</span><span class="n">speed</span> <span class="o">==</span> <span class="n">SPEED_1000</span> <span class="o">&amp;&amp;</span> <span class="n">phydev</span><span class="o">-&gt;</span><span class="n">duplex</span> <span class="o">==</span> <span class="n">DUPLEX_HALF</span><span class="p">)</span>
		<span class="n">tw32</span><span class="p">(</span><span class="n">MAC_TX_LENGTHS</span><span class="p">,</span>
		     <span class="p">((</span><span class="mi">2</span> <span class="o">&lt;&lt;</span> <span class="n">TX_LENGTHS_IPG_CRS_SHIFT</span><span class="p">)</span> <span class="o">|</span>
		      <span class="p">(</span><span class="mi">6</span> <span class="o">&lt;&lt;</span> <span class="n">TX_LENGTHS_IPG_SHIFT</span><span class="p">)</span> <span class="o">|</span>
		      <span class="p">(</span><span class="mh">0xff</span> <span class="o">&lt;&lt;</span> <span class="n">TX_LENGTHS_SLOT_TIME_SHIFT</span><span class="p">)));</span>
	<span class="k">else</span>
		<span class="n">tw32</span><span class="p">(</span><span class="n">MAC_TX_LENGTHS</span><span class="p">,</span>
		     <span class="p">((</span><span class="mi">2</span> <span class="o">&lt;&lt;</span> <span class="n">TX_LENGTHS_IPG_CRS_SHIFT</span><span class="p">)</span> <span class="o">|</span>
		      <span class="p">(</span><span class="mi">6</span> <span class="o">&lt;&lt;</span> <span class="n">TX_LENGTHS_IPG_SHIFT</span><span class="p">)</span> <span class="o">|</span>
		      <span class="p">(</span><span class="mi">32</span> <span class="o">&lt;&lt;</span> <span class="n">TX_LENGTHS_SLOT_TIME_SHIFT</span><span class="p">)));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">phydev</span><span class="o">-&gt;</span><span class="n">link</span> <span class="o">!=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">old_link</span> <span class="o">||</span>
	    <span class="n">phydev</span><span class="o">-&gt;</span><span class="n">speed</span> <span class="o">!=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">link_config</span><span class="p">.</span><span class="n">active_speed</span> <span class="o">||</span>
	    <span class="n">phydev</span><span class="o">-&gt;</span><span class="n">duplex</span> <span class="o">!=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">link_config</span><span class="p">.</span><span class="n">active_duplex</span> <span class="o">||</span>
	    <span class="n">oldflowctrl</span> <span class="o">!=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">link_config</span><span class="p">.</span><span class="n">active_flowctrl</span><span class="p">)</span>
		<span class="n">linkmesg</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">old_link</span> <span class="o">=</span> <span class="n">phydev</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">;</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">link_config</span><span class="p">.</span><span class="n">active_speed</span> <span class="o">=</span> <span class="n">phydev</span><span class="o">-&gt;</span><span class="n">speed</span><span class="p">;</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">link_config</span><span class="p">.</span><span class="n">active_duplex</span> <span class="o">=</span> <span class="n">phydev</span><span class="o">-&gt;</span><span class="n">duplex</span><span class="p">;</span>

	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">linkmesg</span><span class="p">)</span>
		<span class="n">tg3_link_report</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tg3_phy_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">phy_device</span> <span class="o">*</span><span class="n">phydev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">phy_flags</span> <span class="o">&amp;</span> <span class="n">TG3_PHYFLG_IS_CONNECTED</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Bring the PHY back to a known state. */</span>
	<span class="n">tg3_bmcr_reset</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>

	<span class="n">phydev</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">mdio_bus</span><span class="o">-&gt;</span><span class="n">phy_map</span><span class="p">[</span><span class="n">TG3_PHY_MII_ADDR</span><span class="p">];</span>

	<span class="cm">/* Attach the MAC to the PHY. */</span>
	<span class="n">phydev</span> <span class="o">=</span> <span class="n">phy_connect</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">dev_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phydev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">),</span> <span class="n">tg3_adjust_link</span><span class="p">,</span>
			     <span class="n">phydev</span><span class="o">-&gt;</span><span class="n">dev_flags</span><span class="p">,</span> <span class="n">phydev</span><span class="o">-&gt;</span><span class="n">interface</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">phydev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Could not attach to PHY</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">phydev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Mask with MAC supported features. */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">phydev</span><span class="o">-&gt;</span><span class="n">interface</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PHY_INTERFACE_MODE_GMII</span>:
	<span class="k">case</span> <span class="n">PHY_INTERFACE_MODE_RGMII</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">phy_flags</span> <span class="o">&amp;</span> <span class="n">TG3_PHYFLG_10_100_ONLY</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">phydev</span><span class="o">-&gt;</span><span class="n">supported</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="n">PHY_GBIT_FEATURES</span> <span class="o">|</span>
					      <span class="n">SUPPORTED_Pause</span> <span class="o">|</span>
					      <span class="n">SUPPORTED_Asym_Pause</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* fallthru */</span>
	<span class="k">case</span> <span class="n">PHY_INTERFACE_MODE_MII</span>:
		<span class="n">phydev</span><span class="o">-&gt;</span><span class="n">supported</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="n">PHY_BASIC_FEATURES</span> <span class="o">|</span>
				      <span class="n">SUPPORTED_Pause</span> <span class="o">|</span>
				      <span class="n">SUPPORTED_Asym_Pause</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">phy_disconnect</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">mdio_bus</span><span class="o">-&gt;</span><span class="n">phy_map</span><span class="p">[</span><span class="n">TG3_PHY_MII_ADDR</span><span class="p">]);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">phy_flags</span> <span class="o">|=</span> <span class="n">TG3_PHYFLG_IS_CONNECTED</span><span class="p">;</span>

	<span class="n">phydev</span><span class="o">-&gt;</span><span class="n">advertising</span> <span class="o">=</span> <span class="n">phydev</span><span class="o">-&gt;</span><span class="n">supported</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tg3_phy_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">phy_device</span> <span class="o">*</span><span class="n">phydev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">phy_flags</span> <span class="o">&amp;</span> <span class="n">TG3_PHYFLG_IS_CONNECTED</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">phydev</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">mdio_bus</span><span class="o">-&gt;</span><span class="n">phy_map</span><span class="p">[</span><span class="n">TG3_PHY_MII_ADDR</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">phy_flags</span> <span class="o">&amp;</span> <span class="n">TG3_PHYFLG_IS_LOW_POWER</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">phy_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">TG3_PHYFLG_IS_LOW_POWER</span><span class="p">;</span>
		<span class="n">phydev</span><span class="o">-&gt;</span><span class="n">speed</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">link_config</span><span class="p">.</span><span class="n">speed</span><span class="p">;</span>
		<span class="n">phydev</span><span class="o">-&gt;</span><span class="n">duplex</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">link_config</span><span class="p">.</span><span class="n">duplex</span><span class="p">;</span>
		<span class="n">phydev</span><span class="o">-&gt;</span><span class="n">autoneg</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">link_config</span><span class="p">.</span><span class="n">autoneg</span><span class="p">;</span>
		<span class="n">phydev</span><span class="o">-&gt;</span><span class="n">advertising</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">link_config</span><span class="p">.</span><span class="n">advertising</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">phy_start</span><span class="p">(</span><span class="n">phydev</span><span class="p">);</span>

	<span class="n">phy_start_aneg</span><span class="p">(</span><span class="n">phydev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tg3_phy_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">phy_flags</span> <span class="o">&amp;</span> <span class="n">TG3_PHYFLG_IS_CONNECTED</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">phy_stop</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">mdio_bus</span><span class="o">-&gt;</span><span class="n">phy_map</span><span class="p">[</span><span class="n">TG3_PHY_MII_ADDR</span><span class="p">]);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tg3_phy_fini</span><span class="p">(</span><span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">phy_flags</span> <span class="o">&amp;</span> <span class="n">TG3_PHYFLG_IS_CONNECTED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">phy_disconnect</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">mdio_bus</span><span class="o">-&gt;</span><span class="n">phy_map</span><span class="p">[</span><span class="n">TG3_PHY_MII_ADDR</span><span class="p">]);</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">phy_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">TG3_PHYFLG_IS_CONNECTED</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tg3_phy_set_extloopbk</span><span class="p">(</span><span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">phy_flags</span> <span class="o">&amp;</span> <span class="n">TG3_PHYFLG_IS_FET</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">phy_id</span> <span class="o">&amp;</span> <span class="n">TG3_PHY_ID_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">TG3_PHY_ID_BCM5401</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Cannot do read-modify-write on 5401 */</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">tg3_phy_auxctl_write</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span>
					   <span class="n">MII_TG3_AUXCTL_SHDWSEL_AUXCTL</span><span class="p">,</span>
					   <span class="n">MII_TG3_AUXCTL_ACTL_EXTLOOPBK</span> <span class="o">|</span>
					   <span class="mh">0x4c20</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">tg3_phy_auxctl_read</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span>
				  <span class="n">MII_TG3_AUXCTL_SHDWSEL_AUXCTL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">|=</span> <span class="n">MII_TG3_AUXCTL_ACTL_EXTLOOPBK</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">tg3_phy_auxctl_write</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span>
				   <span class="n">MII_TG3_AUXCTL_SHDWSEL_AUXCTL</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

<span class="nl">done:</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tg3_phy_fet_toggle_apd</span><span class="p">(</span><span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span><span class="p">,</span> <span class="n">bool</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">phytest</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tg3_readphy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">MII_TG3_FET_TEST</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">phytest</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">phy</span><span class="p">;</span>

		<span class="n">tg3_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">MII_TG3_FET_TEST</span><span class="p">,</span>
			     <span class="n">phytest</span> <span class="o">|</span> <span class="n">MII_TG3_FET_SHADOW_EN</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tg3_readphy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">MII_TG3_FET_SHDW_AUXSTAT2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">phy</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">enable</span><span class="p">)</span>
				<span class="n">phy</span> <span class="o">|=</span> <span class="n">MII_TG3_FET_SHDW_AUXSTAT2_APD</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">phy</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MII_TG3_FET_SHDW_AUXSTAT2_APD</span><span class="p">;</span>
			<span class="n">tg3_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">MII_TG3_FET_SHDW_AUXSTAT2</span><span class="p">,</span> <span class="n">phy</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">tg3_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">MII_TG3_FET_TEST</span><span class="p">,</span> <span class="n">phytest</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tg3_phy_toggle_apd</span><span class="p">(</span><span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span><span class="p">,</span> <span class="n">bool</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">reg</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">5705</span><span class="n">_PLUS</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">5717</span><span class="n">_PLUS</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	     <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">phy_flags</span> <span class="o">&amp;</span> <span class="n">TG3_PHYFLG_MII_SERDES</span><span class="p">)))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">phy_flags</span> <span class="o">&amp;</span> <span class="n">TG3_PHYFLG_IS_FET</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tg3_phy_fet_toggle_apd</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">enable</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">reg</span> <span class="o">=</span> <span class="n">MII_TG3_MISC_SHDW_WREN</span> <span class="o">|</span>
	      <span class="n">MII_TG3_MISC_SHDW_SCR5_SEL</span> <span class="o">|</span>
	      <span class="n">MII_TG3_MISC_SHDW_SCR5_LPED</span> <span class="o">|</span>
	      <span class="n">MII_TG3_MISC_SHDW_SCR5_DLPTLM</span> <span class="o">|</span>
	      <span class="n">MII_TG3_MISC_SHDW_SCR5_SDTL</span> <span class="o">|</span>
	      <span class="n">MII_TG3_MISC_SHDW_SCR5_C125OE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">!=</span> <span class="n">ASIC_REV_5784</span> <span class="o">||</span> <span class="o">!</span><span class="n">enable</span><span class="p">)</span>
		<span class="n">reg</span> <span class="o">|=</span> <span class="n">MII_TG3_MISC_SHDW_SCR5_DLLAPD</span><span class="p">;</span>

	<span class="n">tg3_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">MII_TG3_MISC_SHDW</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>


	<span class="n">reg</span> <span class="o">=</span> <span class="n">MII_TG3_MISC_SHDW_WREN</span> <span class="o">|</span>
	      <span class="n">MII_TG3_MISC_SHDW_APD_SEL</span> <span class="o">|</span>
	      <span class="n">MII_TG3_MISC_SHDW_APD_WKTM_84MS</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">enable</span><span class="p">)</span>
		<span class="n">reg</span> <span class="o">|=</span> <span class="n">MII_TG3_MISC_SHDW_APD_ENABLE</span><span class="p">;</span>

	<span class="n">tg3_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">MII_TG3_MISC_SHDW</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tg3_phy_toggle_automdix</span><span class="p">(</span><span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">phy</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">5705</span><span class="n">_PLUS</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">phy_flags</span> <span class="o">&amp;</span> <span class="n">TG3_PHYFLG_ANY_SERDES</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">phy_flags</span> <span class="o">&amp;</span> <span class="n">TG3_PHYFLG_IS_FET</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">ephy</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tg3_readphy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">MII_TG3_FET_TEST</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ephy</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">u32</span> <span class="n">reg</span> <span class="o">=</span> <span class="n">MII_TG3_FET_SHDW_MISCCTRL</span><span class="p">;</span>

			<span class="n">tg3_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">MII_TG3_FET_TEST</span><span class="p">,</span>
				     <span class="n">ephy</span> <span class="o">|</span> <span class="n">MII_TG3_FET_SHADOW_EN</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tg3_readphy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">phy</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">enable</span><span class="p">)</span>
					<span class="n">phy</span> <span class="o">|=</span> <span class="n">MII_TG3_FET_SHDW_MISCCTRL_MDIX</span><span class="p">;</span>
				<span class="k">else</span>
					<span class="n">phy</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MII_TG3_FET_SHDW_MISCCTRL_MDIX</span><span class="p">;</span>
				<span class="n">tg3_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">phy</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">tg3_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">MII_TG3_FET_TEST</span><span class="p">,</span> <span class="n">ephy</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">tg3_phy_auxctl_read</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span>
					  <span class="n">MII_TG3_AUXCTL_SHDWSEL_MISC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">phy</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">enable</span><span class="p">)</span>
				<span class="n">phy</span> <span class="o">|=</span> <span class="n">MII_TG3_AUXCTL_MISC_FORCE_AMDIX</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">phy</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MII_TG3_AUXCTL_MISC_FORCE_AMDIX</span><span class="p">;</span>
			<span class="n">tg3_phy_auxctl_write</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span>
					     <span class="n">MII_TG3_AUXCTL_SHDWSEL_MISC</span><span class="p">,</span> <span class="n">phy</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tg3_phy_set_wirespeed</span><span class="p">(</span><span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">phy_flags</span> <span class="o">&amp;</span> <span class="n">TG3_PHYFLG_NO_ETH_WIRE_SPEED</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">tg3_phy_auxctl_read</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">MII_TG3_AUXCTL_SHDWSEL_MISC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">tg3_phy_auxctl_write</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">MII_TG3_AUXCTL_SHDWSEL_MISC</span><span class="p">,</span>
				     <span class="n">val</span> <span class="o">|</span> <span class="n">MII_TG3_AUXCTL_MISC_WIRESPD_EN</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tg3_phy_apply_otp</span><span class="p">(</span><span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">otp</span><span class="p">,</span> <span class="n">phy</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">phy_otp</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">otp</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">phy_otp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">TG3_PHY_AUXCTL_SMDSP_ENABLE</span><span class="p">(</span><span class="n">tp</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">phy</span> <span class="o">=</span> <span class="p">((</span><span class="n">otp</span> <span class="o">&amp;</span> <span class="n">TG3_OTP_AGCTGT_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">TG3_OTP_AGCTGT_SHIFT</span><span class="p">);</span>
	<span class="n">phy</span> <span class="o">|=</span> <span class="n">MII_TG3_DSP_TAP1_AGCTGT_DFLT</span><span class="p">;</span>
	<span class="n">tg3_phydsp_write</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">MII_TG3_DSP_TAP1</span><span class="p">,</span> <span class="n">phy</span><span class="p">);</span>

	<span class="n">phy</span> <span class="o">=</span> <span class="p">((</span><span class="n">otp</span> <span class="o">&amp;</span> <span class="n">TG3_OTP_HPFFLTR_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">TG3_OTP_HPFFLTR_SHIFT</span><span class="p">)</span> <span class="o">|</span>
	      <span class="p">((</span><span class="n">otp</span> <span class="o">&amp;</span> <span class="n">TG3_OTP_HPFOVER_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">TG3_OTP_HPFOVER_SHIFT</span><span class="p">);</span>
	<span class="n">tg3_phydsp_write</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">MII_TG3_DSP_AADJ1CH0</span><span class="p">,</span> <span class="n">phy</span><span class="p">);</span>

	<span class="n">phy</span> <span class="o">=</span> <span class="p">((</span><span class="n">otp</span> <span class="o">&amp;</span> <span class="n">TG3_OTP_LPFDIS_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">TG3_OTP_LPFDIS_SHIFT</span><span class="p">);</span>
	<span class="n">phy</span> <span class="o">|=</span> <span class="n">MII_TG3_DSP_AADJ1CH3_ADCCKADJ</span><span class="p">;</span>
	<span class="n">tg3_phydsp_write</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">MII_TG3_DSP_AADJ1CH3</span><span class="p">,</span> <span class="n">phy</span><span class="p">);</span>

	<span class="n">phy</span> <span class="o">=</span> <span class="p">((</span><span class="n">otp</span> <span class="o">&amp;</span> <span class="n">TG3_OTP_VDAC_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">TG3_OTP_VDAC_SHIFT</span><span class="p">);</span>
	<span class="n">tg3_phydsp_write</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">MII_TG3_DSP_EXP75</span><span class="p">,</span> <span class="n">phy</span><span class="p">);</span>

	<span class="n">phy</span> <span class="o">=</span> <span class="p">((</span><span class="n">otp</span> <span class="o">&amp;</span> <span class="n">TG3_OTP_10BTAMP_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">TG3_OTP_10BTAMP_SHIFT</span><span class="p">);</span>
	<span class="n">tg3_phydsp_write</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">MII_TG3_DSP_EXP96</span><span class="p">,</span> <span class="n">phy</span><span class="p">);</span>

	<span class="n">phy</span> <span class="o">=</span> <span class="p">((</span><span class="n">otp</span> <span class="o">&amp;</span> <span class="n">TG3_OTP_ROFF_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">TG3_OTP_ROFF_SHIFT</span><span class="p">)</span> <span class="o">|</span>
	      <span class="p">((</span><span class="n">otp</span> <span class="o">&amp;</span> <span class="n">TG3_OTP_RCOFF_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">TG3_OTP_RCOFF_SHIFT</span><span class="p">);</span>
	<span class="n">tg3_phydsp_write</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">MII_TG3_DSP_EXP97</span><span class="p">,</span> <span class="n">phy</span><span class="p">);</span>

	<span class="n">TG3_PHY_AUXCTL_SMDSP_DISABLE</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tg3_phy_eee_adjust</span><span class="p">(</span><span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span><span class="p">,</span> <span class="n">u32</span> <span class="n">current_link_up</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">phy_flags</span> <span class="o">&amp;</span> <span class="n">TG3_PHYFLG_EEE_CAP</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">setlpicnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">link_config</span><span class="p">.</span><span class="n">autoneg</span> <span class="o">==</span> <span class="n">AUTONEG_ENABLE</span> <span class="o">&amp;&amp;</span>
	    <span class="n">current_link_up</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span>
	    <span class="n">tp</span><span class="o">-&gt;</span><span class="n">link_config</span><span class="p">.</span><span class="n">active_duplex</span> <span class="o">==</span> <span class="n">DUPLEX_FULL</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">link_config</span><span class="p">.</span><span class="n">active_speed</span> <span class="o">==</span> <span class="n">SPEED_100</span> <span class="o">||</span>
	     <span class="n">tp</span><span class="o">-&gt;</span><span class="n">link_config</span><span class="p">.</span><span class="n">active_speed</span> <span class="o">==</span> <span class="n">SPEED_1000</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">eeectl</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">link_config</span><span class="p">.</span><span class="n">active_speed</span> <span class="o">==</span> <span class="n">SPEED_1000</span><span class="p">)</span>
			<span class="n">eeectl</span> <span class="o">=</span> <span class="n">TG3_CPMU_EEE_CTRL_EXIT_16_5_US</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">eeectl</span> <span class="o">=</span> <span class="n">TG3_CPMU_EEE_CTRL_EXIT_36_US</span><span class="p">;</span>

		<span class="n">tw32</span><span class="p">(</span><span class="n">TG3_CPMU_EEE_CTRL</span><span class="p">,</span> <span class="n">eeectl</span><span class="p">);</span>

		<span class="n">tg3_phy_cl45_read</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">MDIO_MMD_AN</span><span class="p">,</span>
				  <span class="n">TG3_CL45_D7_EEERES_STAT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">==</span> <span class="n">TG3_CL45_D7_EEERES_STAT_LP_1000T</span> <span class="o">||</span>
		    <span class="n">val</span> <span class="o">==</span> <span class="n">TG3_CL45_D7_EEERES_STAT_LP_100TX</span><span class="p">)</span>
			<span class="n">tp</span><span class="o">-&gt;</span><span class="n">setlpicnt</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">setlpicnt</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">current_link_up</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span>
		   <span class="o">!</span><span class="n">TG3_PHY_AUXCTL_SMDSP_ENABLE</span><span class="p">(</span><span class="n">tp</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">tg3_phydsp_write</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">MII_TG3_DSP_TAP26</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
			<span class="n">TG3_PHY_AUXCTL_SMDSP_DISABLE</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">val</span> <span class="o">=</span> <span class="n">tr32</span><span class="p">(</span><span class="n">TG3_CPMU_EEE_MODE</span><span class="p">);</span>
		<span class="n">tw32</span><span class="p">(</span><span class="n">TG3_CPMU_EEE_MODE</span><span class="p">,</span> <span class="n">val</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">TG3_CPMU_EEEMD_LPI_ENABLE</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tg3_phy_eee_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">link_config</span><span class="p">.</span><span class="n">active_speed</span> <span class="o">==</span> <span class="n">SPEED_1000</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">ASIC_REV_5717</span> <span class="o">||</span>
	     <span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">ASIC_REV_5719</span> <span class="o">||</span>
	     <span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">57765</span><span class="n">_CLASS</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">TG3_PHY_AUXCTL_SMDSP_ENABLE</span><span class="p">(</span><span class="n">tp</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">MII_TG3_DSP_TAP26_ALNOKO</span> <span class="o">|</span>
		      <span class="n">MII_TG3_DSP_TAP26_RMRXSTO</span><span class="p">;</span>
		<span class="n">tg3_phydsp_write</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">MII_TG3_DSP_TAP26</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
		<span class="n">TG3_PHY_AUXCTL_SMDSP_DISABLE</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">tr32</span><span class="p">(</span><span class="n">TG3_CPMU_EEE_MODE</span><span class="p">);</span>
	<span class="n">tw32</span><span class="p">(</span><span class="n">TG3_CPMU_EEE_MODE</span><span class="p">,</span> <span class="n">val</span> <span class="o">|</span> <span class="n">TG3_CPMU_EEEMD_LPI_ENABLE</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tg3_wait_macro_done</span><span class="p">(</span><span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">limit</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">limit</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">tmp32</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tg3_readphy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">MII_TG3_DSP_CONTROL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp32</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">tmp32</span> <span class="o">&amp;</span> <span class="mh">0x1000</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">limit</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tg3_phy_write_and_check_testpat</span><span class="p">(</span><span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">resetp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="n">u32</span> <span class="n">test_pat</span><span class="p">[</span><span class="mi">4</span><span class="p">][</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="mh">0x00005555</span><span class="p">,</span> <span class="mh">0x00000005</span><span class="p">,</span> <span class="mh">0x00002aaa</span><span class="p">,</span> <span class="mh">0x0000000a</span><span class="p">,</span> <span class="mh">0x00003456</span><span class="p">,</span> <span class="mh">0x00000003</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x00002aaa</span><span class="p">,</span> <span class="mh">0x0000000a</span><span class="p">,</span> <span class="mh">0x00003333</span><span class="p">,</span> <span class="mh">0x00000003</span><span class="p">,</span> <span class="mh">0x0000789a</span><span class="p">,</span> <span class="mh">0x00000005</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x00005a5a</span><span class="p">,</span> <span class="mh">0x00000005</span><span class="p">,</span> <span class="mh">0x00002a6a</span><span class="p">,</span> <span class="mh">0x0000000a</span><span class="p">,</span> <span class="mh">0x00001bcd</span><span class="p">,</span> <span class="mh">0x00000003</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x00002a5a</span><span class="p">,</span> <span class="mh">0x0000000a</span><span class="p">,</span> <span class="mh">0x000033c3</span><span class="p">,</span> <span class="mh">0x00000003</span><span class="p">,</span> <span class="mh">0x00002ef1</span><span class="p">,</span> <span class="mh">0x00000005</span> <span class="p">}</span>
	<span class="p">};</span>
	<span class="kt">int</span> <span class="n">chan</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">chan</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">chan</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">chan</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

		<span class="n">tg3_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">MII_TG3_DSP_ADDRESS</span><span class="p">,</span>
			     <span class="p">(</span><span class="n">chan</span> <span class="o">*</span> <span class="mh">0x2000</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x0200</span><span class="p">);</span>
		<span class="n">tg3_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">MII_TG3_DSP_CONTROL</span><span class="p">,</span> <span class="mh">0x0002</span><span class="p">);</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">tg3_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">MII_TG3_DSP_RW_PORT</span><span class="p">,</span>
				     <span class="n">test_pat</span><span class="p">[</span><span class="n">chan</span><span class="p">][</span><span class="n">i</span><span class="p">]);</span>

		<span class="n">tg3_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">MII_TG3_DSP_CONTROL</span><span class="p">,</span> <span class="mh">0x0202</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tg3_wait_macro_done</span><span class="p">(</span><span class="n">tp</span><span class="p">))</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">resetp</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">tg3_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">MII_TG3_DSP_ADDRESS</span><span class="p">,</span>
			     <span class="p">(</span><span class="n">chan</span> <span class="o">*</span> <span class="mh">0x2000</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x0200</span><span class="p">);</span>
		<span class="n">tg3_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">MII_TG3_DSP_CONTROL</span><span class="p">,</span> <span class="mh">0x0082</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tg3_wait_macro_done</span><span class="p">(</span><span class="n">tp</span><span class="p">))</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">resetp</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">tg3_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">MII_TG3_DSP_CONTROL</span><span class="p">,</span> <span class="mh">0x0802</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tg3_wait_macro_done</span><span class="p">(</span><span class="n">tp</span><span class="p">))</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">resetp</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u32</span> <span class="n">low</span><span class="p">,</span> <span class="n">high</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">tg3_readphy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">MII_TG3_DSP_RW_PORT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">low</span><span class="p">)</span> <span class="o">||</span>
			    <span class="n">tg3_readphy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">MII_TG3_DSP_RW_PORT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">high</span><span class="p">)</span> <span class="o">||</span>
			    <span class="n">tg3_wait_macro_done</span><span class="p">(</span><span class="n">tp</span><span class="p">))</span> <span class="p">{</span>
				<span class="o">*</span><span class="n">resetp</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">low</span> <span class="o">&amp;=</span> <span class="mh">0x7fff</span><span class="p">;</span>
			<span class="n">high</span> <span class="o">&amp;=</span> <span class="mh">0x000f</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">low</span> <span class="o">!=</span> <span class="n">test_pat</span><span class="p">[</span><span class="n">chan</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">||</span>
			    <span class="n">high</span> <span class="o">!=</span> <span class="n">test_pat</span><span class="p">[</span><span class="n">chan</span><span class="p">][</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span> <span class="p">{</span>
				<span class="n">tg3_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">MII_TG3_DSP_ADDRESS</span><span class="p">,</span> <span class="mh">0x000b</span><span class="p">);</span>
				<span class="n">tg3_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">MII_TG3_DSP_RW_PORT</span><span class="p">,</span> <span class="mh">0x4001</span><span class="p">);</span>
				<span class="n">tg3_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">MII_TG3_DSP_RW_PORT</span><span class="p">,</span> <span class="mh">0x4005</span><span class="p">);</span>

				<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tg3_phy_reset_chanpat</span><span class="p">(</span><span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">chan</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">chan</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">chan</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">chan</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

		<span class="n">tg3_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">MII_TG3_DSP_ADDRESS</span><span class="p">,</span>
			     <span class="p">(</span><span class="n">chan</span> <span class="o">*</span> <span class="mh">0x2000</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x0200</span><span class="p">);</span>
		<span class="n">tg3_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">MII_TG3_DSP_CONTROL</span><span class="p">,</span> <span class="mh">0x0002</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">tg3_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">MII_TG3_DSP_RW_PORT</span><span class="p">,</span> <span class="mh">0x000</span><span class="p">);</span>
		<span class="n">tg3_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">MII_TG3_DSP_CONTROL</span><span class="p">,</span> <span class="mh">0x0202</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tg3_wait_macro_done</span><span class="p">(</span><span class="n">tp</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tg3_phy_reset_5703_4_5</span><span class="p">(</span><span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">reg32</span><span class="p">,</span> <span class="n">phy9_orig</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retries</span><span class="p">,</span> <span class="n">do_phy_reset</span><span class="p">,</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">retries</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
	<span class="n">do_phy_reset</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">do_phy_reset</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">tg3_bmcr_reset</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
			<span class="n">do_phy_reset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Disable transmitter and interrupt.  */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tg3_readphy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">MII_TG3_EXT_CTRL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg32</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">reg32</span> <span class="o">|=</span> <span class="mh">0x3000</span><span class="p">;</span>
		<span class="n">tg3_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">MII_TG3_EXT_CTRL</span><span class="p">,</span> <span class="n">reg32</span><span class="p">);</span>

		<span class="cm">/* Set full-duplex, 1000 mbps.  */</span>
		<span class="n">tg3_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">MII_BMCR</span><span class="p">,</span>
			     <span class="n">BMCR_FULLDPLX</span> <span class="o">|</span> <span class="n">BMCR_SPEED1000</span><span class="p">);</span>

		<span class="cm">/* Set to master mode.  */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tg3_readphy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">MII_CTRL1000</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">phy9_orig</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">tg3_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">MII_CTRL1000</span><span class="p">,</span>
			     <span class="n">CTL1000_AS_MASTER</span> <span class="o">|</span> <span class="n">CTL1000_ENABLE_MASTER</span><span class="p">);</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">TG3_PHY_AUXCTL_SMDSP_ENABLE</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

		<span class="cm">/* Block the PHY control access.  */</span>
		<span class="n">tg3_phydsp_write</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mh">0x8005</span><span class="p">,</span> <span class="mh">0x0800</span><span class="p">);</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">tg3_phy_write_and_check_testpat</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">do_phy_reset</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">retries</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">tg3_phy_reset_chanpat</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">tg3_phydsp_write</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mh">0x8005</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>

	<span class="n">tg3_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">MII_TG3_DSP_ADDRESS</span><span class="p">,</span> <span class="mh">0x8200</span><span class="p">);</span>
	<span class="n">tg3_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">MII_TG3_DSP_CONTROL</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>

	<span class="n">TG3_PHY_AUXCTL_SMDSP_DISABLE</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>

	<span class="n">tg3_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">MII_CTRL1000</span><span class="p">,</span> <span class="n">phy9_orig</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tg3_readphy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">MII_TG3_EXT_CTRL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg32</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">reg32</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x3000</span><span class="p">;</span>
		<span class="n">tg3_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">MII_TG3_EXT_CTRL</span><span class="p">,</span> <span class="n">reg32</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* This will reset the tigon3 PHY if there is no valid</span>
<span class="cm"> * link unless the FORCE argument is non-zero.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">tg3_phy_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">,</span> <span class="n">cpmuctrl</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">ASIC_REV_5906</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">tr32</span><span class="p">(</span><span class="n">GRC_MISC_CFG</span><span class="p">);</span>
		<span class="n">tw32_f</span><span class="p">(</span><span class="n">GRC_MISC_CFG</span><span class="p">,</span> <span class="n">val</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">GRC_MISC_CFG_EPHY_IDDQ</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">40</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">err</span>  <span class="o">=</span> <span class="n">tg3_readphy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">MII_BMSR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">|=</span> <span class="n">tg3_readphy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">MII_BMSR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">netif_running</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">netif_carrier_ok</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">netif_carrier_off</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">tg3_link_report</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">ASIC_REV_5703</span> <span class="o">||</span>
	    <span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">ASIC_REV_5704</span> <span class="o">||</span>
	    <span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">ASIC_REV_5705</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">tg3_phy_reset_5703_4_5</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cpmuctrl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">ASIC_REV_5784</span> <span class="o">&amp;&amp;</span>
	    <span class="n">GET_CHIP_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">!=</span> <span class="n">CHIPREV_5784_AX</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cpmuctrl</span> <span class="o">=</span> <span class="n">tr32</span><span class="p">(</span><span class="n">TG3_CPMU_CTRL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cpmuctrl</span> <span class="o">&amp;</span> <span class="n">CPMU_CTRL_GPHY_10MB_RXONLY</span><span class="p">)</span>
			<span class="n">tw32</span><span class="p">(</span><span class="n">TG3_CPMU_CTRL</span><span class="p">,</span>
			     <span class="n">cpmuctrl</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">CPMU_CTRL_GPHY_10MB_RXONLY</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">tg3_bmcr_reset</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cpmuctrl</span> <span class="o">&amp;</span> <span class="n">CPMU_CTRL_GPHY_10MB_RXONLY</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">MII_TG3_DSP_EXP8_AEDW</span> <span class="o">|</span> <span class="n">MII_TG3_DSP_EXP8_REJ2MHz</span><span class="p">;</span>
		<span class="n">tg3_phydsp_write</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">MII_TG3_DSP_EXP8</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

		<span class="n">tw32</span><span class="p">(</span><span class="n">TG3_CPMU_CTRL</span><span class="p">,</span> <span class="n">cpmuctrl</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">GET_CHIP_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">CHIPREV_5784_AX</span> <span class="o">||</span>
	    <span class="n">GET_CHIP_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">CHIPREV_5761_AX</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">tr32</span><span class="p">(</span><span class="n">TG3_CPMU_LSPD_1000MB_CLK</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">CPMU_LSPD_1000MB_MACCLK_MASK</span><span class="p">)</span> <span class="o">==</span>
		    <span class="n">CPMU_LSPD_1000MB_MACCLK_12_5</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">CPMU_LSPD_1000MB_MACCLK_MASK</span><span class="p">;</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">40</span><span class="p">);</span>
			<span class="n">tw32_f</span><span class="p">(</span><span class="n">TG3_CPMU_LSPD_1000MB_CLK</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">5717</span><span class="n">_PLUS</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">phy_flags</span> <span class="o">&amp;</span> <span class="n">TG3_PHYFLG_MII_SERDES</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">tg3_phy_apply_otp</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">phy_flags</span> <span class="o">&amp;</span> <span class="n">TG3_PHYFLG_ENABLE_APD</span><span class="p">)</span>
		<span class="n">tg3_phy_toggle_apd</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">tg3_phy_toggle_apd</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">phy_flags</span> <span class="o">&amp;</span> <span class="n">TG3_PHYFLG_ADC_BUG</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">TG3_PHY_AUXCTL_SMDSP_ENABLE</span><span class="p">(</span><span class="n">tp</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">tg3_phydsp_write</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mh">0x201f</span><span class="p">,</span> <span class="mh">0x2aaa</span><span class="p">);</span>
		<span class="n">tg3_phydsp_write</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mh">0x000a</span><span class="p">,</span> <span class="mh">0x0323</span><span class="p">);</span>
		<span class="n">TG3_PHY_AUXCTL_SMDSP_DISABLE</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">phy_flags</span> <span class="o">&amp;</span> <span class="n">TG3_PHYFLG_5704_A0_BUG</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tg3_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">MII_TG3_MISC_SHDW</span><span class="p">,</span> <span class="mh">0x8d68</span><span class="p">);</span>
		<span class="n">tg3_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">MII_TG3_MISC_SHDW</span><span class="p">,</span> <span class="mh">0x8d68</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">phy_flags</span> <span class="o">&amp;</span> <span class="n">TG3_PHYFLG_BER_BUG</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">TG3_PHY_AUXCTL_SMDSP_ENABLE</span><span class="p">(</span><span class="n">tp</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">tg3_phydsp_write</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mh">0x000a</span><span class="p">,</span> <span class="mh">0x310b</span><span class="p">);</span>
			<span class="n">tg3_phydsp_write</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mh">0x201f</span><span class="p">,</span> <span class="mh">0x9506</span><span class="p">);</span>
			<span class="n">tg3_phydsp_write</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mh">0x401f</span><span class="p">,</span> <span class="mh">0x14e2</span><span class="p">);</span>
			<span class="n">TG3_PHY_AUXCTL_SMDSP_DISABLE</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">phy_flags</span> <span class="o">&amp;</span> <span class="n">TG3_PHYFLG_JITTER_BUG</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">TG3_PHY_AUXCTL_SMDSP_ENABLE</span><span class="p">(</span><span class="n">tp</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">tg3_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">MII_TG3_DSP_ADDRESS</span><span class="p">,</span> <span class="mh">0x000a</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">phy_flags</span> <span class="o">&amp;</span> <span class="n">TG3_PHYFLG_ADJUST_TRIM</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">tg3_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">MII_TG3_DSP_RW_PORT</span><span class="p">,</span> <span class="mh">0x110b</span><span class="p">);</span>
				<span class="n">tg3_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">MII_TG3_TEST1</span><span class="p">,</span>
					     <span class="n">MII_TG3_TEST1_TRIM_EN</span> <span class="o">|</span> <span class="mh">0x4</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="n">tg3_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">MII_TG3_DSP_RW_PORT</span><span class="p">,</span> <span class="mh">0x010b</span><span class="p">);</span>

			<span class="n">TG3_PHY_AUXCTL_SMDSP_DISABLE</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Set Extended packet length bit (bit 14) on all chips that */</span>
	<span class="cm">/* support jumbo frames */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">phy_id</span> <span class="o">&amp;</span> <span class="n">TG3_PHY_ID_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">TG3_PHY_ID_BCM5401</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Cannot do read-modify-write on 5401 */</span>
		<span class="n">tg3_phy_auxctl_write</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">MII_TG3_AUXCTL_SHDWSEL_AUXCTL</span><span class="p">,</span> <span class="mh">0x4c20</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">JUMBO_CAPABLE</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Set bit 14 with read-modify-write to preserve other bits */</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">tg3_phy_auxctl_read</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span>
					  <span class="n">MII_TG3_AUXCTL_SHDWSEL_AUXCTL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span>
			<span class="n">tg3_phy_auxctl_write</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">MII_TG3_AUXCTL_SHDWSEL_AUXCTL</span><span class="p">,</span>
					   <span class="n">val</span> <span class="o">|</span> <span class="n">MII_TG3_AUXCTL_ACTL_EXTPKTLEN</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Set phy register 0x10 bit 0 to high fifo elasticity to support</span>
<span class="cm">	 * jumbo frames transmission.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">JUMBO_CAPABLE</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tg3_readphy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">MII_TG3_EXT_CTRL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">))</span>
			<span class="n">tg3_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">MII_TG3_EXT_CTRL</span><span class="p">,</span>
				     <span class="n">val</span> <span class="o">|</span> <span class="n">MII_TG3_EXT_CTRL_FIFO_ELASTIC</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">ASIC_REV_5906</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* adjust output voltage */</span>
		<span class="n">tg3_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">MII_TG3_FET_PTEST</span><span class="p">,</span> <span class="mh">0x12</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">tg3_phy_toggle_automdix</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">tg3_phy_set_wirespeed</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define TG3_GPIO_MSG_DRVR_PRES		 0x00000001</span>
<span class="cp">#define TG3_GPIO_MSG_NEED_VAUX		 0x00000002</span>
<span class="cp">#define TG3_GPIO_MSG_MASK		 (TG3_GPIO_MSG_DRVR_PRES | \</span>
<span class="cp">					  TG3_GPIO_MSG_NEED_VAUX)</span>
<span class="cp">#define TG3_GPIO_MSG_ALL_DRVR_PRES_MASK \</span>
<span class="cp">	((TG3_GPIO_MSG_DRVR_PRES &lt;&lt; 0) | \</span>
<span class="cp">	 (TG3_GPIO_MSG_DRVR_PRES &lt;&lt; 4) | \</span>
<span class="cp">	 (TG3_GPIO_MSG_DRVR_PRES &lt;&lt; 8) | \</span>
<span class="cp">	 (TG3_GPIO_MSG_DRVR_PRES &lt;&lt; 12))</span>

<span class="cp">#define TG3_GPIO_MSG_ALL_NEED_VAUX_MASK \</span>
<span class="cp">	((TG3_GPIO_MSG_NEED_VAUX &lt;&lt; 0) | \</span>
<span class="cp">	 (TG3_GPIO_MSG_NEED_VAUX &lt;&lt; 4) | \</span>
<span class="cp">	 (TG3_GPIO_MSG_NEED_VAUX &lt;&lt; 8) | \</span>
<span class="cp">	 (TG3_GPIO_MSG_NEED_VAUX &lt;&lt; 12))</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u32</span> <span class="nf">tg3_set_function_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span><span class="p">,</span> <span class="n">u32</span> <span class="n">newstat</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">status</span><span class="p">,</span> <span class="n">shift</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">ASIC_REV_5717</span> <span class="o">||</span>
	    <span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">ASIC_REV_5719</span><span class="p">)</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">tg3_ape_read32</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">TG3_APE_GPIO_MSG</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">tr32</span><span class="p">(</span><span class="n">TG3_CPMU_DRV_STATUS</span><span class="p">);</span>

	<span class="n">shift</span> <span class="o">=</span> <span class="n">TG3_APE_GPIO_MSG_SHIFT</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_fn</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">TG3_GPIO_MSG_MASK</span> <span class="o">&lt;&lt;</span> <span class="n">shift</span><span class="p">);</span>
	<span class="n">status</span> <span class="o">|=</span> <span class="p">(</span><span class="n">newstat</span> <span class="o">&lt;&lt;</span> <span class="n">shift</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">ASIC_REV_5717</span> <span class="o">||</span>
	    <span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">ASIC_REV_5719</span><span class="p">)</span>
		<span class="n">tg3_ape_write32</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">TG3_APE_GPIO_MSG</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">tw32</span><span class="p">(</span><span class="n">TG3_CPMU_DRV_STATUS</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">status</span> <span class="o">&gt;&gt;</span> <span class="n">TG3_APE_GPIO_MSG_SHIFT</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">tg3_pwrsrc_switch_to_vmain</span><span class="p">(</span><span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">IS_NIC</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">ASIC_REV_5717</span> <span class="o">||</span>
	    <span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">ASIC_REV_5719</span> <span class="o">||</span>
	    <span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">ASIC_REV_5720</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tg3_ape_lock</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">TG3_APE_LOCK_GPIO</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

		<span class="n">tg3_set_function_status</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">TG3_GPIO_MSG_DRVR_PRES</span><span class="p">);</span>

		<span class="n">tw32_wait_f</span><span class="p">(</span><span class="n">GRC_LOCAL_CTRL</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">grc_local_ctrl</span><span class="p">,</span>
			    <span class="n">TG3_GRC_LCLCTL_PWRSW_DELAY</span><span class="p">);</span>

		<span class="n">tg3_ape_unlock</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">TG3_APE_LOCK_GPIO</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">tw32_wait_f</span><span class="p">(</span><span class="n">GRC_LOCAL_CTRL</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">grc_local_ctrl</span><span class="p">,</span>
			    <span class="n">TG3_GRC_LCLCTL_PWRSW_DELAY</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tg3_pwrsrc_die_with_vmain</span><span class="p">(</span><span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">grc_local_ctrl</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">IS_NIC</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">ASIC_REV_5700</span> <span class="o">||</span>
	    <span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">ASIC_REV_5701</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">grc_local_ctrl</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">grc_local_ctrl</span> <span class="o">|</span> <span class="n">GRC_LCLCTRL_GPIO_OE1</span><span class="p">;</span>

	<span class="n">tw32_wait_f</span><span class="p">(</span><span class="n">GRC_LOCAL_CTRL</span><span class="p">,</span>
		    <span class="n">grc_local_ctrl</span> <span class="o">|</span> <span class="n">GRC_LCLCTRL_GPIO_OUTPUT1</span><span class="p">,</span>
		    <span class="n">TG3_GRC_LCLCTL_PWRSW_DELAY</span><span class="p">);</span>

	<span class="n">tw32_wait_f</span><span class="p">(</span><span class="n">GRC_LOCAL_CTRL</span><span class="p">,</span>
		    <span class="n">grc_local_ctrl</span><span class="p">,</span>
		    <span class="n">TG3_GRC_LCLCTL_PWRSW_DELAY</span><span class="p">);</span>

	<span class="n">tw32_wait_f</span><span class="p">(</span><span class="n">GRC_LOCAL_CTRL</span><span class="p">,</span>
		    <span class="n">grc_local_ctrl</span> <span class="o">|</span> <span class="n">GRC_LCLCTRL_GPIO_OUTPUT1</span><span class="p">,</span>
		    <span class="n">TG3_GRC_LCLCTL_PWRSW_DELAY</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tg3_pwrsrc_switch_to_vaux</span><span class="p">(</span><span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">IS_NIC</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">ASIC_REV_5700</span> <span class="o">||</span>
	    <span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">ASIC_REV_5701</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tw32_wait_f</span><span class="p">(</span><span class="n">GRC_LOCAL_CTRL</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">grc_local_ctrl</span> <span class="o">|</span>
			    <span class="p">(</span><span class="n">GRC_LCLCTRL_GPIO_OE0</span> <span class="o">|</span>
			     <span class="n">GRC_LCLCTRL_GPIO_OE1</span> <span class="o">|</span>
			     <span class="n">GRC_LCLCTRL_GPIO_OE2</span> <span class="o">|</span>
			     <span class="n">GRC_LCLCTRL_GPIO_OUTPUT0</span> <span class="o">|</span>
			     <span class="n">GRC_LCLCTRL_GPIO_OUTPUT1</span><span class="p">),</span>
			    <span class="n">TG3_GRC_LCLCTL_PWRSW_DELAY</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="n">PCI_DEVICE_ID_TIGON3_5761</span> <span class="o">||</span>
		   <span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="n">TG3PCI_DEVICE_TIGON3_5761S</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* The 5761 non-e device swaps GPIO 0 and GPIO 2. */</span>
		<span class="n">u32</span> <span class="n">grc_local_ctrl</span> <span class="o">=</span> <span class="n">GRC_LCLCTRL_GPIO_OE0</span> <span class="o">|</span>
				     <span class="n">GRC_LCLCTRL_GPIO_OE1</span> <span class="o">|</span>
				     <span class="n">GRC_LCLCTRL_GPIO_OE2</span> <span class="o">|</span>
				     <span class="n">GRC_LCLCTRL_GPIO_OUTPUT0</span> <span class="o">|</span>
				     <span class="n">GRC_LCLCTRL_GPIO_OUTPUT1</span> <span class="o">|</span>
				     <span class="n">tp</span><span class="o">-&gt;</span><span class="n">grc_local_ctrl</span><span class="p">;</span>
		<span class="n">tw32_wait_f</span><span class="p">(</span><span class="n">GRC_LOCAL_CTRL</span><span class="p">,</span> <span class="n">grc_local_ctrl</span><span class="p">,</span>
			    <span class="n">TG3_GRC_LCLCTL_PWRSW_DELAY</span><span class="p">);</span>

		<span class="n">grc_local_ctrl</span> <span class="o">|=</span> <span class="n">GRC_LCLCTRL_GPIO_OUTPUT2</span><span class="p">;</span>
		<span class="n">tw32_wait_f</span><span class="p">(</span><span class="n">GRC_LOCAL_CTRL</span><span class="p">,</span> <span class="n">grc_local_ctrl</span><span class="p">,</span>
			    <span class="n">TG3_GRC_LCLCTL_PWRSW_DELAY</span><span class="p">);</span>

		<span class="n">grc_local_ctrl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">GRC_LCLCTRL_GPIO_OUTPUT0</span><span class="p">;</span>
		<span class="n">tw32_wait_f</span><span class="p">(</span><span class="n">GRC_LOCAL_CTRL</span><span class="p">,</span> <span class="n">grc_local_ctrl</span><span class="p">,</span>
			    <span class="n">TG3_GRC_LCLCTL_PWRSW_DELAY</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">no_gpio2</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">grc_local_ctrl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="cm">/* Workaround to prevent overdrawing Amps. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">ASIC_REV_5714</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">grc_local_ctrl</span> <span class="o">|=</span> <span class="n">GRC_LCLCTRL_GPIO_OE3</span><span class="p">;</span>
			<span class="n">tw32_wait_f</span><span class="p">(</span><span class="n">GRC_LOCAL_CTRL</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">grc_local_ctrl</span> <span class="o">|</span>
				    <span class="n">grc_local_ctrl</span><span class="p">,</span>
				    <span class="n">TG3_GRC_LCLCTL_PWRSW_DELAY</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* On 5753 and variants, GPIO2 cannot be used. */</span>
		<span class="n">no_gpio2</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">nic_sram_data_cfg</span> <span class="o">&amp;</span>
			   <span class="n">NIC_SRAM_DATA_CFG_NO_GPIO2</span><span class="p">;</span>

		<span class="n">grc_local_ctrl</span> <span class="o">|=</span> <span class="n">GRC_LCLCTRL_GPIO_OE0</span> <span class="o">|</span>
				  <span class="n">GRC_LCLCTRL_GPIO_OE1</span> <span class="o">|</span>
				  <span class="n">GRC_LCLCTRL_GPIO_OE2</span> <span class="o">|</span>
				  <span class="n">GRC_LCLCTRL_GPIO_OUTPUT1</span> <span class="o">|</span>
				  <span class="n">GRC_LCLCTRL_GPIO_OUTPUT2</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">no_gpio2</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">grc_local_ctrl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">GRC_LCLCTRL_GPIO_OE2</span> <span class="o">|</span>
					    <span class="n">GRC_LCLCTRL_GPIO_OUTPUT2</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">tw32_wait_f</span><span class="p">(</span><span class="n">GRC_LOCAL_CTRL</span><span class="p">,</span>
			    <span class="n">tp</span><span class="o">-&gt;</span><span class="n">grc_local_ctrl</span> <span class="o">|</span> <span class="n">grc_local_ctrl</span><span class="p">,</span>
			    <span class="n">TG3_GRC_LCLCTL_PWRSW_DELAY</span><span class="p">);</span>

		<span class="n">grc_local_ctrl</span> <span class="o">|=</span> <span class="n">GRC_LCLCTRL_GPIO_OUTPUT0</span><span class="p">;</span>

		<span class="n">tw32_wait_f</span><span class="p">(</span><span class="n">GRC_LOCAL_CTRL</span><span class="p">,</span>
			    <span class="n">tp</span><span class="o">-&gt;</span><span class="n">grc_local_ctrl</span> <span class="o">|</span> <span class="n">grc_local_ctrl</span><span class="p">,</span>
			    <span class="n">TG3_GRC_LCLCTL_PWRSW_DELAY</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">no_gpio2</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">grc_local_ctrl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">GRC_LCLCTRL_GPIO_OUTPUT2</span><span class="p">;</span>
			<span class="n">tw32_wait_f</span><span class="p">(</span><span class="n">GRC_LOCAL_CTRL</span><span class="p">,</span>
				    <span class="n">tp</span><span class="o">-&gt;</span><span class="n">grc_local_ctrl</span> <span class="o">|</span> <span class="n">grc_local_ctrl</span><span class="p">,</span>
				    <span class="n">TG3_GRC_LCLCTL_PWRSW_DELAY</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tg3_frob_aux_power_5717</span><span class="p">(</span><span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span><span class="p">,</span> <span class="n">bool</span> <span class="n">wol_enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">msg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Serialize power state transitions */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tg3_ape_lock</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">TG3_APE_LOCK_GPIO</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">ENABLE_ASF</span><span class="p">)</span> <span class="o">||</span> <span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">ENABLE_APE</span><span class="p">)</span> <span class="o">||</span> <span class="n">wol_enable</span><span class="p">)</span>
		<span class="n">msg</span> <span class="o">=</span> <span class="n">TG3_GPIO_MSG_NEED_VAUX</span><span class="p">;</span>

	<span class="n">msg</span> <span class="o">=</span> <span class="n">tg3_set_function_status</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">msg</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">msg</span> <span class="o">&amp;</span> <span class="n">TG3_GPIO_MSG_ALL_DRVR_PRES_MASK</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">msg</span> <span class="o">&amp;</span> <span class="n">TG3_GPIO_MSG_ALL_NEED_VAUX_MASK</span><span class="p">)</span>
		<span class="n">tg3_pwrsrc_switch_to_vaux</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">tg3_pwrsrc_die_with_vmain</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>

<span class="nl">done:</span>
	<span class="n">tg3_ape_unlock</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">TG3_APE_LOCK_GPIO</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tg3_frob_aux_power</span><span class="p">(</span><span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span><span class="p">,</span> <span class="n">bool</span> <span class="n">include_wol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bool</span> <span class="n">need_vaux</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="cm">/* The GPIOs do something completely different on 57765. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">IS_NIC</span><span class="p">)</span> <span class="o">||</span> <span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">57765</span><span class="n">_CLASS</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">ASIC_REV_5717</span> <span class="o">||</span>
	    <span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">ASIC_REV_5719</span> <span class="o">||</span>
	    <span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">ASIC_REV_5720</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tg3_frob_aux_power_5717</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">include_wol</span> <span class="o">?</span>
					<span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">WOL_ENABLE</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev_peer</span> <span class="o">&amp;&amp;</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev_peer</span> <span class="o">!=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev_peer</span><span class="p">;</span>

		<span class="n">dev_peer</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev_peer</span><span class="p">);</span>

		<span class="cm">/* remove_one() may have been run on the peer. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev_peer</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp_peer</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev_peer</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp_peer</span><span class="p">,</span> <span class="n">INIT_COMPLETE</span><span class="p">))</span>
				<span class="k">return</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">((</span><span class="n">include_wol</span> <span class="o">&amp;&amp;</span> <span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp_peer</span><span class="p">,</span> <span class="n">WOL_ENABLE</span><span class="p">))</span> <span class="o">||</span>
			    <span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp_peer</span><span class="p">,</span> <span class="n">ENABLE_ASF</span><span class="p">))</span>
				<span class="n">need_vaux</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">include_wol</span> <span class="o">&amp;&amp;</span> <span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">WOL_ENABLE</span><span class="p">))</span> <span class="o">||</span>
	    <span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">ENABLE_ASF</span><span class="p">))</span>
		<span class="n">need_vaux</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">need_vaux</span><span class="p">)</span>
		<span class="n">tg3_pwrsrc_switch_to_vaux</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">tg3_pwrsrc_die_with_vmain</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tg3_5700_link_polarity</span><span class="p">(</span><span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span><span class="p">,</span> <span class="n">u32</span> <span class="n">speed</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">led_ctrl</span> <span class="o">==</span> <span class="n">LED_CTRL_MODE_PHY_2</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">phy_id</span> <span class="o">&amp;</span> <span class="n">TG3_PHY_ID_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">TG3_PHY_ID_BCM5411</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">speed</span> <span class="o">!=</span> <span class="n">SPEED_10</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">speed</span> <span class="o">==</span> <span class="n">SPEED_10</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tg3_power_down_phy</span><span class="p">(</span><span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span><span class="p">,</span> <span class="n">bool</span> <span class="n">do_low_power</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">phy_flags</span> <span class="o">&amp;</span> <span class="n">TG3_PHYFLG_PHY_SERDES</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">ASIC_REV_5704</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u32</span> <span class="n">sg_dig_ctrl</span> <span class="o">=</span> <span class="n">tr32</span><span class="p">(</span><span class="n">SG_DIG_CTRL</span><span class="p">);</span>
			<span class="n">u32</span> <span class="n">serdes_cfg</span> <span class="o">=</span> <span class="n">tr32</span><span class="p">(</span><span class="n">MAC_SERDES_CFG</span><span class="p">);</span>

			<span class="n">sg_dig_ctrl</span> <span class="o">|=</span>
				<span class="n">SG_DIG_USING_HW_AUTONEG</span> <span class="o">|</span> <span class="n">SG_DIG_SOFT_RESET</span><span class="p">;</span>
			<span class="n">tw32</span><span class="p">(</span><span class="n">SG_DIG_CTRL</span><span class="p">,</span> <span class="n">sg_dig_ctrl</span><span class="p">);</span>
			<span class="n">tw32</span><span class="p">(</span><span class="n">MAC_SERDES_CFG</span><span class="p">,</span> <span class="n">serdes_cfg</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">15</span><span class="p">));</span>
		<span class="p">}</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">ASIC_REV_5906</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tg3_bmcr_reset</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">tr32</span><span class="p">(</span><span class="n">GRC_MISC_CFG</span><span class="p">);</span>
		<span class="n">tw32_f</span><span class="p">(</span><span class="n">GRC_MISC_CFG</span><span class="p">,</span> <span class="n">val</span> <span class="o">|</span> <span class="n">GRC_MISC_CFG_EPHY_IDDQ</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">40</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">phy_flags</span> <span class="o">&amp;</span> <span class="n">TG3_PHYFLG_IS_FET</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">phytest</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tg3_readphy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">MII_TG3_FET_TEST</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">phytest</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">u32</span> <span class="n">phy</span><span class="p">;</span>

			<span class="n">tg3_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">MII_ADVERTISE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">tg3_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">MII_BMCR</span><span class="p">,</span>
				     <span class="n">BMCR_ANENABLE</span> <span class="o">|</span> <span class="n">BMCR_ANRESTART</span><span class="p">);</span>

			<span class="n">tg3_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">MII_TG3_FET_TEST</span><span class="p">,</span>
				     <span class="n">phytest</span> <span class="o">|</span> <span class="n">MII_TG3_FET_SHADOW_EN</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tg3_readphy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">MII_TG3_FET_SHDW_AUXMODE4</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">phy</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">phy</span> <span class="o">|=</span> <span class="n">MII_TG3_FET_SHDW_AUXMODE4_SBPD</span><span class="p">;</span>
				<span class="n">tg3_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span>
					     <span class="n">MII_TG3_FET_SHDW_AUXMODE4</span><span class="p">,</span>
					     <span class="n">phy</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">tg3_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">MII_TG3_FET_TEST</span><span class="p">,</span> <span class="n">phytest</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">do_low_power</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tg3_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">MII_TG3_EXT_CTRL</span><span class="p">,</span>
			     <span class="n">MII_TG3_EXT_CTRL_FORCE_LED_OFF</span><span class="p">);</span>

		<span class="n">val</span> <span class="o">=</span> <span class="n">MII_TG3_AUXCTL_PCTL_100TX_LPWR</span> <span class="o">|</span>
		      <span class="n">MII_TG3_AUXCTL_PCTL_SPR_ISOLATE</span> <span class="o">|</span>
		      <span class="n">MII_TG3_AUXCTL_PCTL_VREG_11V</span><span class="p">;</span>
		<span class="n">tg3_phy_auxctl_write</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">MII_TG3_AUXCTL_SHDWSEL_PWRCTL</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* The PHY should not be powered down on some chips because</span>
<span class="cm">	 * of bugs.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">ASIC_REV_5700</span> <span class="o">||</span>
	    <span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">ASIC_REV_5704</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">ASIC_REV_5780</span> <span class="o">&amp;&amp;</span>
	     <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">phy_flags</span> <span class="o">&amp;</span> <span class="n">TG3_PHYFLG_MII_SERDES</span><span class="p">))</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">ASIC_REV_5717</span> <span class="o">&amp;&amp;</span>
	     <span class="o">!</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_fn</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">GET_CHIP_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">CHIPREV_5784_AX</span> <span class="o">||</span>
	    <span class="n">GET_CHIP_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">CHIPREV_5761_AX</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">tr32</span><span class="p">(</span><span class="n">TG3_CPMU_LSPD_1000MB_CLK</span><span class="p">);</span>
		<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">CPMU_LSPD_1000MB_MACCLK_MASK</span><span class="p">;</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">CPMU_LSPD_1000MB_MACCLK_12_5</span><span class="p">;</span>
		<span class="n">tw32_f</span><span class="p">(</span><span class="n">TG3_CPMU_LSPD_1000MB_CLK</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">tg3_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">MII_BMCR</span><span class="p">,</span> <span class="n">BMCR_PDOWN</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* tp-&gt;lock is held. */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">tg3_nvram_lock</span><span class="p">(</span><span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">NVRAM</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">nvram_lock_cnt</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">tw32</span><span class="p">(</span><span class="n">NVRAM_SWARB</span><span class="p">,</span> <span class="n">SWARB_REQ_SET1</span><span class="p">);</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8000</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">tr32</span><span class="p">(</span><span class="n">NVRAM_SWARB</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">SWARB_GNT1</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="n">udelay</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">8000</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">tw32</span><span class="p">(</span><span class="n">NVRAM_SWARB</span><span class="p">,</span> <span class="n">SWARB_REQ_CLR1</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">nvram_lock_cnt</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* tp-&gt;lock is held. */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">tg3_nvram_unlock</span><span class="p">(</span><span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">NVRAM</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">nvram_lock_cnt</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">tp</span><span class="o">-&gt;</span><span class="n">nvram_lock_cnt</span><span class="o">--</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">nvram_lock_cnt</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">tw32_f</span><span class="p">(</span><span class="n">NVRAM_SWARB</span><span class="p">,</span> <span class="n">SWARB_REQ_CLR1</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* tp-&gt;lock is held. */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">tg3_enable_nvram_access</span><span class="p">(</span><span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">5750</span><span class="n">_PLUS</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">PROTECTED_NVRAM</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">nvaccess</span> <span class="o">=</span> <span class="n">tr32</span><span class="p">(</span><span class="n">NVRAM_ACCESS</span><span class="p">);</span>

		<span class="n">tw32</span><span class="p">(</span><span class="n">NVRAM_ACCESS</span><span class="p">,</span> <span class="n">nvaccess</span> <span class="o">|</span> <span class="n">ACCESS_ENABLE</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* tp-&gt;lock is held. */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">tg3_disable_nvram_access</span><span class="p">(</span><span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">5750</span><span class="n">_PLUS</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">PROTECTED_NVRAM</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">nvaccess</span> <span class="o">=</span> <span class="n">tr32</span><span class="p">(</span><span class="n">NVRAM_ACCESS</span><span class="p">);</span>

		<span class="n">tw32</span><span class="p">(</span><span class="n">NVRAM_ACCESS</span><span class="p">,</span> <span class="n">nvaccess</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">ACCESS_ENABLE</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tg3_nvram_read_using_eeprom</span><span class="p">(</span><span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span><span class="p">,</span>
					<span class="n">u32</span> <span class="n">offset</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">offset</span> <span class="o">&gt;</span> <span class="n">EEPROM_ADDR_ADDR_MASK</span> <span class="o">||</span> <span class="p">(</span><span class="n">offset</span> <span class="o">%</span> <span class="mi">4</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">tr32</span><span class="p">(</span><span class="n">GRC_EEPROM_ADDR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">EEPROM_ADDR_ADDR_MASK</span> <span class="o">|</span>
					<span class="n">EEPROM_ADDR_DEVID_MASK</span> <span class="o">|</span>
					<span class="n">EEPROM_ADDR_READ</span><span class="p">);</span>
	<span class="n">tw32</span><span class="p">(</span><span class="n">GRC_EEPROM_ADDR</span><span class="p">,</span>
	     <span class="n">tmp</span> <span class="o">|</span>
	     <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="n">EEPROM_ADDR_DEVID_SHIFT</span><span class="p">)</span> <span class="o">|</span>
	     <span class="p">((</span><span class="n">offset</span> <span class="o">&lt;&lt;</span> <span class="n">EEPROM_ADDR_ADDR_SHIFT</span><span class="p">)</span> <span class="o">&amp;</span>
	      <span class="n">EEPROM_ADDR_ADDR_MASK</span><span class="p">)</span> <span class="o">|</span>
	     <span class="n">EEPROM_ADDR_READ</span> <span class="o">|</span> <span class="n">EEPROM_ADDR_START</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">1000</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">tr32</span><span class="p">(</span><span class="n">GRC_EEPROM_ADDR</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">EEPROM_ADDR_COMPLETE</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">EEPROM_ADDR_COMPLETE</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">tr32</span><span class="p">(</span><span class="n">GRC_EEPROM_DATA</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * The data will always be opposite the native endian</span>
<span class="cm">	 * format.  Perform a blind byteswap to compensate.</span>
<span class="cm">	 */</span>
	<span class="o">*</span><span class="n">val</span> <span class="o">=</span> <span class="n">swab32</span><span class="p">(</span><span class="n">tmp</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define NVRAM_CMD_TIMEOUT 10000</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tg3_nvram_exec_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span><span class="p">,</span> <span class="n">u32</span> <span class="n">nvram_cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">tw32</span><span class="p">(</span><span class="n">NVRAM_CMD</span><span class="p">,</span> <span class="n">nvram_cmd</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NVRAM_CMD_TIMEOUT</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tr32</span><span class="p">(</span><span class="n">NVRAM_CMD</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">NVRAM_CMD_DONE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">NVRAM_CMD_TIMEOUT</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">tg3_nvram_phys_addr</span><span class="p">(</span><span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span><span class="p">,</span> <span class="n">u32</span> <span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">NVRAM</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">NVRAM_BUFFERED</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">FLASH</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">NO_NVRAM_ADDR_TRANS</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">nvram_jedecnum</span> <span class="o">==</span> <span class="n">JEDEC_ATMEL</span><span class="p">))</span>

		<span class="n">addr</span> <span class="o">=</span> <span class="p">((</span><span class="n">addr</span> <span class="o">/</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">nvram_pagesize</span><span class="p">)</span> <span class="o">&lt;&lt;</span>
			<span class="n">ATMEL_AT45DB0X1B_PAGE_POS</span><span class="p">)</span> <span class="o">+</span>
		       <span class="p">(</span><span class="n">addr</span> <span class="o">%</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">nvram_pagesize</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">addr</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">tg3_nvram_logical_addr</span><span class="p">(</span><span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span><span class="p">,</span> <span class="n">u32</span> <span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">NVRAM</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">NVRAM_BUFFERED</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">FLASH</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">NO_NVRAM_ADDR_TRANS</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">nvram_jedecnum</span> <span class="o">==</span> <span class="n">JEDEC_ATMEL</span><span class="p">))</span>

		<span class="n">addr</span> <span class="o">=</span> <span class="p">((</span><span class="n">addr</span> <span class="o">&gt;&gt;</span> <span class="n">ATMEL_AT45DB0X1B_PAGE_POS</span><span class="p">)</span> <span class="o">*</span>
			<span class="n">tp</span><span class="o">-&gt;</span><span class="n">nvram_pagesize</span><span class="p">)</span> <span class="o">+</span>
		       <span class="p">(</span><span class="n">addr</span> <span class="o">&amp;</span> <span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">ATMEL_AT45DB0X1B_PAGE_POS</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">));</span>

	<span class="k">return</span> <span class="n">addr</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* NOTE: Data read in from NVRAM is byteswapped according to</span>
<span class="cm"> * the byteswapping settings for all other register accesses.</span>
<span class="cm"> * tg3 devices are BE devices, so on a BE machine, the data</span>
<span class="cm"> * returned will be exactly as it is seen in NVRAM.  On a LE</span>
<span class="cm"> * machine, the 32-bit value will be byteswapped.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">tg3_nvram_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span><span class="p">,</span> <span class="n">u32</span> <span class="n">offset</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">NVRAM</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">tg3_nvram_read_using_eeprom</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

	<span class="n">offset</span> <span class="o">=</span> <span class="n">tg3_nvram_phys_addr</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">offset</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">offset</span> <span class="o">&gt;</span> <span class="n">NVRAM_ADDR_MSK</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">tg3_nvram_lock</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">tg3_enable_nvram_access</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>

	<span class="n">tw32</span><span class="p">(</span><span class="n">NVRAM_ADDR</span><span class="p">,</span> <span class="n">offset</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">tg3_nvram_exec_cmd</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">NVRAM_CMD_RD</span> <span class="o">|</span> <span class="n">NVRAM_CMD_GO</span> <span class="o">|</span>
		<span class="n">NVRAM_CMD_FIRST</span> <span class="o">|</span> <span class="n">NVRAM_CMD_LAST</span> <span class="o">|</span> <span class="n">NVRAM_CMD_DONE</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="o">*</span><span class="n">val</span> <span class="o">=</span> <span class="n">tr32</span><span class="p">(</span><span class="n">NVRAM_RDDATA</span><span class="p">);</span>

	<span class="n">tg3_disable_nvram_access</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>

	<span class="n">tg3_nvram_unlock</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Ensures NVRAM data is in bytestream format. */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">tg3_nvram_read_be32</span><span class="p">(</span><span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span><span class="p">,</span> <span class="n">u32</span> <span class="n">offset</span><span class="p">,</span> <span class="n">__be32</span> <span class="o">*</span><span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">v</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">res</span> <span class="o">=</span> <span class="n">tg3_nvram_read</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">v</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">res</span><span class="p">)</span>
		<span class="o">*</span><span class="n">val</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">v</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tg3_nvram_write_block_using_eeprom</span><span class="p">(</span><span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span><span class="p">,</span>
				    <span class="n">u32</span> <span class="n">offset</span><span class="p">,</span> <span class="n">u32</span> <span class="n">len</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">addr</span><span class="p">;</span>
		<span class="n">__be32</span> <span class="n">data</span><span class="p">;</span>

		<span class="n">addr</span> <span class="o">=</span> <span class="n">offset</span> <span class="o">+</span> <span class="n">i</span><span class="p">;</span>

		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="p">,</span> <span class="n">buf</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * The SEEPROM interface expects the data to always be opposite</span>
<span class="cm">		 * the native endian format.  We accomplish this by reversing</span>
<span class="cm">		 * all the operations that would have been performed on the</span>
<span class="cm">		 * data from a call to tg3_nvram_read_be32().</span>
<span class="cm">		 */</span>
		<span class="n">tw32</span><span class="p">(</span><span class="n">GRC_EEPROM_DATA</span><span class="p">,</span> <span class="n">swab32</span><span class="p">(</span><span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">data</span><span class="p">)));</span>

		<span class="n">val</span> <span class="o">=</span> <span class="n">tr32</span><span class="p">(</span><span class="n">GRC_EEPROM_ADDR</span><span class="p">);</span>
		<span class="n">tw32</span><span class="p">(</span><span class="n">GRC_EEPROM_ADDR</span><span class="p">,</span> <span class="n">val</span> <span class="o">|</span> <span class="n">EEPROM_ADDR_COMPLETE</span><span class="p">);</span>

		<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">EEPROM_ADDR_ADDR_MASK</span> <span class="o">|</span> <span class="n">EEPROM_ADDR_DEVID_MASK</span> <span class="o">|</span>
			<span class="n">EEPROM_ADDR_READ</span><span class="p">);</span>
		<span class="n">tw32</span><span class="p">(</span><span class="n">GRC_EEPROM_ADDR</span><span class="p">,</span> <span class="n">val</span> <span class="o">|</span>
			<span class="p">(</span><span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="n">EEPROM_ADDR_DEVID_SHIFT</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">(</span><span class="n">addr</span> <span class="o">&amp;</span> <span class="n">EEPROM_ADDR_ADDR_MASK</span><span class="p">)</span> <span class="o">|</span>
			<span class="n">EEPROM_ADDR_START</span> <span class="o">|</span>
			<span class="n">EEPROM_ADDR_WRITE</span><span class="p">);</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">1000</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">val</span> <span class="o">=</span> <span class="n">tr32</span><span class="p">(</span><span class="n">GRC_EEPROM_ADDR</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">EEPROM_ADDR_COMPLETE</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">msleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">EEPROM_ADDR_COMPLETE</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* offset and length are dword aligned */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">tg3_nvram_write_block_unbuffered</span><span class="p">(</span><span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span><span class="p">,</span> <span class="n">u32</span> <span class="n">offset</span><span class="p">,</span> <span class="n">u32</span> <span class="n">len</span><span class="p">,</span>
		<span class="n">u8</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">pagesize</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">nvram_pagesize</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">pagemask</span> <span class="o">=</span> <span class="n">pagesize</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">nvram_cmd</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">pagesize</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">len</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">j</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">phy_addr</span><span class="p">,</span> <span class="n">page_off</span><span class="p">,</span> <span class="n">size</span><span class="p">;</span>

		<span class="n">phy_addr</span> <span class="o">=</span> <span class="n">offset</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">pagemask</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">pagesize</span><span class="p">;</span> <span class="n">j</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">tg3_nvram_read_be32</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">phy_addr</span> <span class="o">+</span> <span class="n">j</span><span class="p">,</span>
						  <span class="p">(</span><span class="n">__be32</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">+</span> <span class="n">j</span><span class="p">));</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">page_off</span> <span class="o">=</span> <span class="n">offset</span> <span class="o">&amp;</span> <span class="n">pagemask</span><span class="p">;</span>
		<span class="n">size</span> <span class="o">=</span> <span class="n">pagesize</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="n">size</span><span class="p">)</span>
			<span class="n">size</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>

		<span class="n">len</span> <span class="o">-=</span> <span class="n">size</span><span class="p">;</span>

		<span class="n">memcpy</span><span class="p">(</span><span class="n">tmp</span> <span class="o">+</span> <span class="n">page_off</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>

		<span class="n">offset</span> <span class="o">=</span> <span class="n">offset</span> <span class="o">+</span> <span class="p">(</span><span class="n">pagesize</span> <span class="o">-</span> <span class="n">page_off</span><span class="p">);</span>

		<span class="n">tg3_enable_nvram_access</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * Before we can erase the flash page, we need</span>
<span class="cm">		 * to issue a special &quot;write enable&quot; command.</span>
<span class="cm">		 */</span>
		<span class="n">nvram_cmd</span> <span class="o">=</span> <span class="n">NVRAM_CMD_WREN</span> <span class="o">|</span> <span class="n">NVRAM_CMD_GO</span> <span class="o">|</span> <span class="n">NVRAM_CMD_DONE</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">tg3_nvram_exec_cmd</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">nvram_cmd</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="cm">/* Erase the target page */</span>
		<span class="n">tw32</span><span class="p">(</span><span class="n">NVRAM_ADDR</span><span class="p">,</span> <span class="n">phy_addr</span><span class="p">);</span>

		<span class="n">nvram_cmd</span> <span class="o">=</span> <span class="n">NVRAM_CMD_GO</span> <span class="o">|</span> <span class="n">NVRAM_CMD_DONE</span> <span class="o">|</span> <span class="n">NVRAM_CMD_WR</span> <span class="o">|</span>
			<span class="n">NVRAM_CMD_FIRST</span> <span class="o">|</span> <span class="n">NVRAM_CMD_LAST</span> <span class="o">|</span> <span class="n">NVRAM_CMD_ERASE</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">tg3_nvram_exec_cmd</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">nvram_cmd</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="cm">/* Issue another write enable to start the write. */</span>
		<span class="n">nvram_cmd</span> <span class="o">=</span> <span class="n">NVRAM_CMD_WREN</span> <span class="o">|</span> <span class="n">NVRAM_CMD_GO</span> <span class="o">|</span> <span class="n">NVRAM_CMD_DONE</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">tg3_nvram_exec_cmd</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">nvram_cmd</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">pagesize</span><span class="p">;</span> <span class="n">j</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">__be32</span> <span class="n">data</span><span class="p">;</span>

			<span class="n">data</span> <span class="o">=</span> <span class="o">*</span><span class="p">((</span><span class="n">__be32</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">+</span> <span class="n">j</span><span class="p">));</span>

			<span class="n">tw32</span><span class="p">(</span><span class="n">NVRAM_WRDATA</span><span class="p">,</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">data</span><span class="p">));</span>

			<span class="n">tw32</span><span class="p">(</span><span class="n">NVRAM_ADDR</span><span class="p">,</span> <span class="n">phy_addr</span> <span class="o">+</span> <span class="n">j</span><span class="p">);</span>

			<span class="n">nvram_cmd</span> <span class="o">=</span> <span class="n">NVRAM_CMD_GO</span> <span class="o">|</span> <span class="n">NVRAM_CMD_DONE</span> <span class="o">|</span>
				<span class="n">NVRAM_CMD_WR</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">j</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">nvram_cmd</span> <span class="o">|=</span> <span class="n">NVRAM_CMD_FIRST</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">j</span> <span class="o">==</span> <span class="p">(</span><span class="n">pagesize</span> <span class="o">-</span> <span class="mi">4</span><span class="p">))</span>
				<span class="n">nvram_cmd</span> <span class="o">|=</span> <span class="n">NVRAM_CMD_LAST</span><span class="p">;</span>

			<span class="n">ret</span> <span class="o">=</span> <span class="n">tg3_nvram_exec_cmd</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">nvram_cmd</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">nvram_cmd</span> <span class="o">=</span> <span class="n">NVRAM_CMD_WRDI</span> <span class="o">|</span> <span class="n">NVRAM_CMD_GO</span> <span class="o">|</span> <span class="n">NVRAM_CMD_DONE</span><span class="p">;</span>
	<span class="n">tg3_nvram_exec_cmd</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">nvram_cmd</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">tmp</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* offset and length are dword aligned */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">tg3_nvram_write_block_buffered</span><span class="p">(</span><span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span><span class="p">,</span> <span class="n">u32</span> <span class="n">offset</span><span class="p">,</span> <span class="n">u32</span> <span class="n">len</span><span class="p">,</span>
		<span class="n">u8</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">,</span> <span class="n">offset</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">page_off</span><span class="p">,</span> <span class="n">phy_addr</span><span class="p">,</span> <span class="n">nvram_cmd</span><span class="p">;</span>
		<span class="n">__be32</span> <span class="n">data</span><span class="p">;</span>

		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="p">,</span> <span class="n">buf</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
		<span class="n">tw32</span><span class="p">(</span><span class="n">NVRAM_WRDATA</span><span class="p">,</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">data</span><span class="p">));</span>

		<span class="n">page_off</span> <span class="o">=</span> <span class="n">offset</span> <span class="o">%</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">nvram_pagesize</span><span class="p">;</span>

		<span class="n">phy_addr</span> <span class="o">=</span> <span class="n">tg3_nvram_phys_addr</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">offset</span><span class="p">);</span>

		<span class="n">nvram_cmd</span> <span class="o">=</span> <span class="n">NVRAM_CMD_GO</span> <span class="o">|</span> <span class="n">NVRAM_CMD_DONE</span> <span class="o">|</span> <span class="n">NVRAM_CMD_WR</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">page_off</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">nvram_cmd</span> <span class="o">|=</span> <span class="n">NVRAM_CMD_FIRST</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">page_off</span> <span class="o">==</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">nvram_pagesize</span> <span class="o">-</span> <span class="mi">4</span><span class="p">))</span>
			<span class="n">nvram_cmd</span> <span class="o">|=</span> <span class="n">NVRAM_CMD_LAST</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="p">(</span><span class="n">len</span> <span class="o">-</span> <span class="mi">4</span><span class="p">))</span>
			<span class="n">nvram_cmd</span> <span class="o">|=</span> <span class="n">NVRAM_CMD_LAST</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">nvram_cmd</span> <span class="o">&amp;</span> <span class="n">NVRAM_CMD_FIRST</span><span class="p">)</span> <span class="o">||</span>
		    <span class="o">!</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">FLASH</span><span class="p">)</span> <span class="o">||</span>
		    <span class="o">!</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">57765</span><span class="n">_PLUS</span><span class="p">))</span>
			<span class="n">tw32</span><span class="p">(</span><span class="n">NVRAM_ADDR</span><span class="p">,</span> <span class="n">phy_addr</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">!=</span> <span class="n">ASIC_REV_5752</span> <span class="o">&amp;&amp;</span>
		    <span class="o">!</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">5755</span><span class="n">_PLUS</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">nvram_jedecnum</span> <span class="o">==</span> <span class="n">JEDEC_ST</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">nvram_cmd</span> <span class="o">&amp;</span> <span class="n">NVRAM_CMD_FIRST</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">u32</span> <span class="n">cmd</span><span class="p">;</span>

			<span class="n">cmd</span> <span class="o">=</span> <span class="n">NVRAM_CMD_WREN</span> <span class="o">|</span> <span class="n">NVRAM_CMD_GO</span> <span class="o">|</span> <span class="n">NVRAM_CMD_DONE</span><span class="p">;</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">tg3_nvram_exec_cmd</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">FLASH</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* We always do complete word writes to eeprom. */</span>
			<span class="n">nvram_cmd</span> <span class="o">|=</span> <span class="p">(</span><span class="n">NVRAM_CMD_FIRST</span> <span class="o">|</span> <span class="n">NVRAM_CMD_LAST</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">tg3_nvram_exec_cmd</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">nvram_cmd</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* offset and length are dword aligned */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">tg3_nvram_write_block</span><span class="p">(</span><span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span><span class="p">,</span> <span class="n">u32</span> <span class="n">offset</span><span class="p">,</span> <span class="n">u32</span> <span class="n">len</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">EEPROM_WRITE_PROT</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">tw32_f</span><span class="p">(</span><span class="n">GRC_LOCAL_CTRL</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">grc_local_ctrl</span> <span class="o">&amp;</span>
		       <span class="o">~</span><span class="n">GRC_LCLCTRL_GPIO_OUTPUT1</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">40</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">NVRAM</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">tg3_nvram_write_block_using_eeprom</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">grc_mode</span><span class="p">;</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">tg3_nvram_lock</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

		<span class="n">tg3_enable_nvram_access</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">5750</span><span class="n">_PLUS</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">PROTECTED_NVRAM</span><span class="p">))</span>
			<span class="n">tw32</span><span class="p">(</span><span class="n">NVRAM_WRITE1</span><span class="p">,</span> <span class="mh">0x406</span><span class="p">);</span>

		<span class="n">grc_mode</span> <span class="o">=</span> <span class="n">tr32</span><span class="p">(</span><span class="n">GRC_MODE</span><span class="p">);</span>
		<span class="n">tw32</span><span class="p">(</span><span class="n">GRC_MODE</span><span class="p">,</span> <span class="n">grc_mode</span> <span class="o">|</span> <span class="n">GRC_MODE_NVRAM_WR_ENABLE</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">NVRAM_BUFFERED</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">FLASH</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">tg3_nvram_write_block_buffered</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span>
				<span class="n">buf</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">tg3_nvram_write_block_unbuffered</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span>
				<span class="n">buf</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">grc_mode</span> <span class="o">=</span> <span class="n">tr32</span><span class="p">(</span><span class="n">GRC_MODE</span><span class="p">);</span>
		<span class="n">tw32</span><span class="p">(</span><span class="n">GRC_MODE</span><span class="p">,</span> <span class="n">grc_mode</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">GRC_MODE_NVRAM_WR_ENABLE</span><span class="p">);</span>

		<span class="n">tg3_disable_nvram_access</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
		<span class="n">tg3_nvram_unlock</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">EEPROM_WRITE_PROT</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">tw32_f</span><span class="p">(</span><span class="n">GRC_LOCAL_CTRL</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">grc_local_ctrl</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">40</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define RX_CPU_SCRATCH_BASE	0x30000</span>
<span class="cp">#define RX_CPU_SCRATCH_SIZE	0x04000</span>
<span class="cp">#define TX_CPU_SCRATCH_BASE	0x34000</span>
<span class="cp">#define TX_CPU_SCRATCH_SIZE	0x04000</span>

<span class="cm">/* tp-&gt;lock is held. */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">tg3_halt_cpu</span><span class="p">(</span><span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span><span class="p">,</span> <span class="n">u32</span> <span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">offset</span> <span class="o">==</span> <span class="n">TX_CPU_BASE</span> <span class="o">&amp;&amp;</span> <span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">5705</span><span class="n">_PLUS</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">ASIC_REV_5906</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">val</span> <span class="o">=</span> <span class="n">tr32</span><span class="p">(</span><span class="n">GRC_VCPU_EXT_CTRL</span><span class="p">);</span>

		<span class="n">tw32</span><span class="p">(</span><span class="n">GRC_VCPU_EXT_CTRL</span><span class="p">,</span> <span class="n">val</span> <span class="o">|</span> <span class="n">GRC_VCPU_EXT_CTRL_HALT_CPU</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">offset</span> <span class="o">==</span> <span class="n">RX_CPU_BASE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10000</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">tw32</span><span class="p">(</span><span class="n">offset</span> <span class="o">+</span> <span class="n">CPU_STATE</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">);</span>
			<span class="n">tw32</span><span class="p">(</span><span class="n">offset</span> <span class="o">+</span> <span class="n">CPU_MODE</span><span class="p">,</span>  <span class="n">CPU_MODE_HALT</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tr32</span><span class="p">(</span><span class="n">offset</span> <span class="o">+</span> <span class="n">CPU_MODE</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">CPU_MODE_HALT</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">tw32</span><span class="p">(</span><span class="n">offset</span> <span class="o">+</span> <span class="n">CPU_STATE</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">);</span>
		<span class="n">tw32_f</span><span class="p">(</span><span class="n">offset</span> <span class="o">+</span> <span class="n">CPU_MODE</span><span class="p">,</span>  <span class="n">CPU_MODE_HALT</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10000</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">tw32</span><span class="p">(</span><span class="n">offset</span> <span class="o">+</span> <span class="n">CPU_STATE</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">);</span>
			<span class="n">tw32</span><span class="p">(</span><span class="n">offset</span> <span class="o">+</span> <span class="n">CPU_MODE</span><span class="p">,</span>  <span class="n">CPU_MODE_HALT</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tr32</span><span class="p">(</span><span class="n">offset</span> <span class="o">+</span> <span class="n">CPU_MODE</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">CPU_MODE_HALT</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">10000</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netdev_err</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s timed out, %s CPU</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">__func__</span><span class="p">,</span> <span class="n">offset</span> <span class="o">==</span> <span class="n">RX_CPU_BASE</span> <span class="o">?</span> <span class="s">&quot;RX&quot;</span> <span class="o">:</span> <span class="s">&quot;TX&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Clear firmware&#39;s nvram arbitration. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">NVRAM</span><span class="p">))</span>
		<span class="n">tw32</span><span class="p">(</span><span class="n">NVRAM_SWARB</span><span class="p">,</span> <span class="n">SWARB_REQ_CLR0</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">fw_info</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">fw_base</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">fw_len</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">__be32</span> <span class="o">*</span><span class="n">fw_data</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/* tp-&gt;lock is held. */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">tg3_load_firmware_cpu</span><span class="p">(</span><span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span><span class="p">,</span> <span class="n">u32</span> <span class="n">cpu_base</span><span class="p">,</span>
				 <span class="n">u32</span> <span class="n">cpu_scratch_base</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cpu_scratch_size</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">fw_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">,</span> <span class="n">lock_err</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">write_op</span><span class="p">)(</span><span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="p">,</span> <span class="n">u32</span><span class="p">,</span> <span class="n">u32</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cpu_base</span> <span class="o">==</span> <span class="n">TX_CPU_BASE</span> <span class="o">&amp;&amp;</span> <span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">5705</span><span class="n">_PLUS</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">netdev_err</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			   <span class="s">&quot;%s: Trying to load TX cpu firmware which is 5705</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">5705</span><span class="n">_PLUS</span><span class="p">))</span>
		<span class="n">write_op</span> <span class="o">=</span> <span class="n">tg3_write_mem</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">write_op</span> <span class="o">=</span> <span class="n">tg3_write_indirect_reg32</span><span class="p">;</span>

	<span class="cm">/* It is possible that bootcode is still loading at this point.</span>
<span class="cm">	 * Get the nvram lock first before halting the cpu.</span>
<span class="cm">	 */</span>
	<span class="n">lock_err</span> <span class="o">=</span> <span class="n">tg3_nvram_lock</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">tg3_halt_cpu</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">cpu_base</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lock_err</span><span class="p">)</span>
		<span class="n">tg3_nvram_unlock</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">cpu_scratch_size</span><span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">))</span>
		<span class="n">write_op</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">cpu_scratch_base</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">tw32</span><span class="p">(</span><span class="n">cpu_base</span> <span class="o">+</span> <span class="n">CPU_STATE</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">);</span>
	<span class="n">tw32</span><span class="p">(</span><span class="n">cpu_base</span> <span class="o">+</span> <span class="n">CPU_MODE</span><span class="p">,</span> <span class="n">tr32</span><span class="p">(</span><span class="n">cpu_base</span><span class="o">+</span><span class="n">CPU_MODE</span><span class="p">)</span><span class="o">|</span><span class="n">CPU_MODE_HALT</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">fw_len</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">));</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">write_op</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="p">(</span><span class="n">cpu_scratch_base</span> <span class="o">+</span>
			      <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">fw_base</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">)</span> <span class="o">+</span>
			      <span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">))),</span>
			      <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">fw_data</span><span class="p">[</span><span class="n">i</span><span class="p">]));</span>

	<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* tp-&gt;lock is held. */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">tg3_load_5701_a0_firmware_fix</span><span class="p">(</span><span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fw_info</span> <span class="n">info</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">__be32</span> <span class="o">*</span><span class="n">fw_data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">fw_data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">fw</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

	<span class="cm">/* Firmware blob starts with version numbers, followed by</span>
<span class="cm">	   start address and length. We are setting complete length.</span>
<span class="cm">	   length = end_address_of_bss - start_address_of_text.</span>
<span class="cm">	   Remainder is the blob to be loaded contiguously</span>
<span class="cm">	   from start address. */</span>

	<span class="n">info</span><span class="p">.</span><span class="n">fw_base</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">fw_data</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
	<span class="n">info</span><span class="p">.</span><span class="n">fw_len</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">fw</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">-</span> <span class="mi">12</span><span class="p">;</span>
	<span class="n">info</span><span class="p">.</span><span class="n">fw_data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fw_data</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">tg3_load_firmware_cpu</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">RX_CPU_BASE</span><span class="p">,</span>
				    <span class="n">RX_CPU_SCRATCH_BASE</span><span class="p">,</span> <span class="n">RX_CPU_SCRATCH_SIZE</span><span class="p">,</span>
				    <span class="o">&amp;</span><span class="n">info</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">tg3_load_firmware_cpu</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">TX_CPU_BASE</span><span class="p">,</span>
				    <span class="n">TX_CPU_SCRATCH_BASE</span><span class="p">,</span> <span class="n">TX_CPU_SCRATCH_SIZE</span><span class="p">,</span>
				    <span class="o">&amp;</span><span class="n">info</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="cm">/* Now startup only the RX cpu. */</span>
	<span class="n">tw32</span><span class="p">(</span><span class="n">RX_CPU_BASE</span> <span class="o">+</span> <span class="n">CPU_STATE</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">);</span>
	<span class="n">tw32_f</span><span class="p">(</span><span class="n">RX_CPU_BASE</span> <span class="o">+</span> <span class="n">CPU_PC</span><span class="p">,</span> <span class="n">info</span><span class="p">.</span><span class="n">fw_base</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tr32</span><span class="p">(</span><span class="n">RX_CPU_BASE</span> <span class="o">+</span> <span class="n">CPU_PC</span><span class="p">)</span> <span class="o">==</span> <span class="n">info</span><span class="p">.</span><span class="n">fw_base</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">tw32</span><span class="p">(</span><span class="n">RX_CPU_BASE</span> <span class="o">+</span> <span class="n">CPU_STATE</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">);</span>
		<span class="n">tw32</span><span class="p">(</span><span class="n">RX_CPU_BASE</span> <span class="o">+</span> <span class="n">CPU_MODE</span><span class="p">,</span>  <span class="n">CPU_MODE_HALT</span><span class="p">);</span>
		<span class="n">tw32_f</span><span class="p">(</span><span class="n">RX_CPU_BASE</span> <span class="o">+</span> <span class="n">CPU_PC</span><span class="p">,</span> <span class="n">info</span><span class="p">.</span><span class="n">fw_base</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">5</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netdev_err</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s fails to set RX CPU PC, is %08x &quot;</span>
			   <span class="s">&quot;should be %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
			   <span class="n">tr32</span><span class="p">(</span><span class="n">RX_CPU_BASE</span> <span class="o">+</span> <span class="n">CPU_PC</span><span class="p">),</span> <span class="n">info</span><span class="p">.</span><span class="n">fw_base</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">tw32</span><span class="p">(</span><span class="n">RX_CPU_BASE</span> <span class="o">+</span> <span class="n">CPU_STATE</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">);</span>
	<span class="n">tw32_f</span><span class="p">(</span><span class="n">RX_CPU_BASE</span> <span class="o">+</span> <span class="n">CPU_MODE</span><span class="p">,</span>  <span class="mh">0x00000000</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* tp-&gt;lock is held. */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">tg3_load_tso_firmware</span><span class="p">(</span><span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fw_info</span> <span class="n">info</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">__be32</span> <span class="o">*</span><span class="n">fw_data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">cpu_base</span><span class="p">,</span> <span class="n">cpu_scratch_base</span><span class="p">,</span> <span class="n">cpu_scratch_size</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">HW_TSO_1</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">HW_TSO_2</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">HW_TSO_3</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">fw_data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">fw</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

	<span class="cm">/* Firmware blob starts with version numbers, followed by</span>
<span class="cm">	   start address and length. We are setting complete length.</span>
<span class="cm">	   length = end_address_of_bss - start_address_of_text.</span>
<span class="cm">	   Remainder is the blob to be loaded contiguously</span>
<span class="cm">	   from start address. */</span>

	<span class="n">info</span><span class="p">.</span><span class="n">fw_base</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">fw_data</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
	<span class="n">cpu_scratch_size</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">fw_len</span><span class="p">;</span>
	<span class="n">info</span><span class="p">.</span><span class="n">fw_len</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">fw</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">-</span> <span class="mi">12</span><span class="p">;</span>
	<span class="n">info</span><span class="p">.</span><span class="n">fw_data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fw_data</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">ASIC_REV_5705</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cpu_base</span> <span class="o">=</span> <span class="n">RX_CPU_BASE</span><span class="p">;</span>
		<span class="n">cpu_scratch_base</span> <span class="o">=</span> <span class="n">NIC_SRAM_MBUF_POOL_BASE5705</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">cpu_base</span> <span class="o">=</span> <span class="n">TX_CPU_BASE</span><span class="p">;</span>
		<span class="n">cpu_scratch_base</span> <span class="o">=</span> <span class="n">TX_CPU_SCRATCH_BASE</span><span class="p">;</span>
		<span class="n">cpu_scratch_size</span> <span class="o">=</span> <span class="n">TX_CPU_SCRATCH_SIZE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">tg3_load_firmware_cpu</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">cpu_base</span><span class="p">,</span>
				    <span class="n">cpu_scratch_base</span><span class="p">,</span> <span class="n">cpu_scratch_size</span><span class="p">,</span>
				    <span class="o">&amp;</span><span class="n">info</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="cm">/* Now startup the cpu. */</span>
	<span class="n">tw32</span><span class="p">(</span><span class="n">cpu_base</span> <span class="o">+</span> <span class="n">CPU_STATE</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">);</span>
	<span class="n">tw32_f</span><span class="p">(</span><span class="n">cpu_base</span> <span class="o">+</span> <span class="n">CPU_PC</span><span class="p">,</span> <span class="n">info</span><span class="p">.</span><span class="n">fw_base</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tr32</span><span class="p">(</span><span class="n">cpu_base</span> <span class="o">+</span> <span class="n">CPU_PC</span><span class="p">)</span> <span class="o">==</span> <span class="n">info</span><span class="p">.</span><span class="n">fw_base</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">tw32</span><span class="p">(</span><span class="n">cpu_base</span> <span class="o">+</span> <span class="n">CPU_STATE</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">);</span>
		<span class="n">tw32</span><span class="p">(</span><span class="n">cpu_base</span> <span class="o">+</span> <span class="n">CPU_MODE</span><span class="p">,</span>  <span class="n">CPU_MODE_HALT</span><span class="p">);</span>
		<span class="n">tw32_f</span><span class="p">(</span><span class="n">cpu_base</span> <span class="o">+</span> <span class="n">CPU_PC</span><span class="p">,</span> <span class="n">info</span><span class="p">.</span><span class="n">fw_base</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">5</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netdev_err</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			   <span class="s">&quot;%s fails to set CPU PC, is %08x should be %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">__func__</span><span class="p">,</span> <span class="n">tr32</span><span class="p">(</span><span class="n">cpu_base</span> <span class="o">+</span> <span class="n">CPU_PC</span><span class="p">),</span> <span class="n">info</span><span class="p">.</span><span class="n">fw_base</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">tw32</span><span class="p">(</span><span class="n">cpu_base</span> <span class="o">+</span> <span class="n">CPU_STATE</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">);</span>
	<span class="n">tw32_f</span><span class="p">(</span><span class="n">cpu_base</span> <span class="o">+</span> <span class="n">CPU_MODE</span><span class="p">,</span>  <span class="mh">0x00000000</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* tp-&gt;lock is held. */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">__tg3_set_mac_addr</span><span class="p">(</span><span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">skip_mac_1</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">addr_high</span><span class="p">,</span> <span class="n">addr_low</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">addr_high</span> <span class="o">=</span> <span class="p">((</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span>
		     <span class="n">tp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
	<span class="n">addr_low</span> <span class="o">=</span> <span class="p">((</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">|</span>
		    <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span>
		    <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&lt;&lt;</span>  <span class="mi">8</span><span class="p">)</span> <span class="o">|</span>
		    <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">&lt;&lt;</span>  <span class="mi">0</span><span class="p">));</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">skip_mac_1</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">tw32</span><span class="p">(</span><span class="n">MAC_ADDR_0_HIGH</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="mi">8</span><span class="p">),</span> <span class="n">addr_high</span><span class="p">);</span>
		<span class="n">tw32</span><span class="p">(</span><span class="n">MAC_ADDR_0_LOW</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="mi">8</span><span class="p">),</span> <span class="n">addr_low</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">ASIC_REV_5703</span> <span class="o">||</span>
	    <span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">ASIC_REV_5704</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">12</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">tw32</span><span class="p">(</span><span class="n">MAC_EXTADDR_0_HIGH</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="mi">8</span><span class="p">),</span> <span class="n">addr_high</span><span class="p">);</span>
			<span class="n">tw32</span><span class="p">(</span><span class="n">MAC_EXTADDR_0_LOW</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="mi">8</span><span class="p">),</span> <span class="n">addr_low</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">addr_high</span> <span class="o">=</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span>
		     <span class="n">tp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span>
		     <span class="n">tp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span>
		     <span class="n">tp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span>
		     <span class="n">tp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">+</span>
		     <span class="n">tp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span> <span class="o">&amp;</span>
		<span class="n">TX_BACKOFF_SEED_MASK</span><span class="p">;</span>
	<span class="n">tw32</span><span class="p">(</span><span class="n">MAC_TX_BACKOFF_SEED</span><span class="p">,</span> <span class="n">addr_high</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tg3_enable_register_access</span><span class="p">(</span><span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * Make sure register accesses (indirect or otherwise) will function</span>
<span class="cm">	 * correctly.</span>
<span class="cm">	 */</span>
	<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span>
			       <span class="n">TG3PCI_MISC_HOST_CTRL</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">misc_host_ctrl</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tg3_power_up</span><span class="p">(</span><span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">tg3_enable_register_access</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">pci_set_power_state</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_D0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Switch out of Vaux if it is a NIC */</span>
		<span class="n">tg3_pwrsrc_switch_to_vmain</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">netdev_err</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Transition to D0 failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">tg3_setup_phy</span><span class="p">(</span><span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tg3_power_down_prepare</span><span class="p">(</span><span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">misc_host_ctrl</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">device_should_wake</span><span class="p">,</span> <span class="n">do_low_power</span><span class="p">;</span>

	<span class="n">tg3_enable_register_access</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>

	<span class="cm">/* Restore the CLKREQ setting. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">CLKREQ_BUG</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">u16</span> <span class="n">lnkctl</span><span class="p">;</span>

		<span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span>
				     <span class="n">pci_pcie_cap</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">)</span> <span class="o">+</span> <span class="n">PCI_EXP_LNKCTL</span><span class="p">,</span>
				     <span class="o">&amp;</span><span class="n">lnkctl</span><span class="p">);</span>
		<span class="n">lnkctl</span> <span class="o">|=</span> <span class="n">PCI_EXP_LNKCTL_CLKREQ_EN</span><span class="p">;</span>
		<span class="n">pci_write_config_word</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span>
				      <span class="n">pci_pcie_cap</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">)</span> <span class="o">+</span> <span class="n">PCI_EXP_LNKCTL</span><span class="p">,</span>
				      <span class="n">lnkctl</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">misc_host_ctrl</span> <span class="o">=</span> <span class="n">tr32</span><span class="p">(</span><span class="n">TG3PCI_MISC_HOST_CTRL</span><span class="p">);</span>
	<span class="n">tw32</span><span class="p">(</span><span class="n">TG3PCI_MISC_HOST_CTRL</span><span class="p">,</span>
	     <span class="n">misc_host_ctrl</span> <span class="o">|</span> <span class="n">MISC_HOST_CTRL_MASK_PCI_INT</span><span class="p">);</span>

	<span class="n">device_should_wake</span> <span class="o">=</span> <span class="n">device_may_wakeup</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			     <span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">WOL_ENABLE</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">USE_PHYLIB</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">do_low_power</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">phy_flags</span> <span class="o">&amp;</span> <span class="n">TG3_PHYFLG_IS_CONNECTED</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="o">!</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">phy_flags</span> <span class="o">&amp;</span> <span class="n">TG3_PHYFLG_IS_LOW_POWER</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">phy_device</span> <span class="o">*</span><span class="n">phydev</span><span class="p">;</span>
			<span class="n">u32</span> <span class="n">phyid</span><span class="p">,</span> <span class="n">advertising</span><span class="p">;</span>

			<span class="n">phydev</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">mdio_bus</span><span class="o">-&gt;</span><span class="n">phy_map</span><span class="p">[</span><span class="n">TG3_PHY_MII_ADDR</span><span class="p">];</span>

			<span class="n">tp</span><span class="o">-&gt;</span><span class="n">phy_flags</span> <span class="o">|=</span> <span class="n">TG3_PHYFLG_IS_LOW_POWER</span><span class="p">;</span>

			<span class="n">tp</span><span class="o">-&gt;</span><span class="n">link_config</span><span class="p">.</span><span class="n">speed</span> <span class="o">=</span> <span class="n">phydev</span><span class="o">-&gt;</span><span class="n">speed</span><span class="p">;</span>
			<span class="n">tp</span><span class="o">-&gt;</span><span class="n">link_config</span><span class="p">.</span><span class="n">duplex</span> <span class="o">=</span> <span class="n">phydev</span><span class="o">-&gt;</span><span class="n">duplex</span><span class="p">;</span>
			<span class="n">tp</span><span class="o">-&gt;</span><span class="n">link_config</span><span class="p">.</span><span class="n">autoneg</span> <span class="o">=</span> <span class="n">phydev</span><span class="o">-&gt;</span><span class="n">autoneg</span><span class="p">;</span>
			<span class="n">tp</span><span class="o">-&gt;</span><span class="n">link_config</span><span class="p">.</span><span class="n">advertising</span> <span class="o">=</span> <span class="n">phydev</span><span class="o">-&gt;</span><span class="n">advertising</span><span class="p">;</span>

			<span class="n">advertising</span> <span class="o">=</span> <span class="n">ADVERTISED_TP</span> <span class="o">|</span>
				      <span class="n">ADVERTISED_Pause</span> <span class="o">|</span>
				      <span class="n">ADVERTISED_Autoneg</span> <span class="o">|</span>
				      <span class="n">ADVERTISED_10baseT_Half</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">ENABLE_ASF</span><span class="p">)</span> <span class="o">||</span> <span class="n">device_should_wake</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">WOL_SPEED_100MB</span><span class="p">))</span>
					<span class="n">advertising</span> <span class="o">|=</span>
						<span class="n">ADVERTISED_100baseT_Half</span> <span class="o">|</span>
						<span class="n">ADVERTISED_100baseT_Full</span> <span class="o">|</span>
						<span class="n">ADVERTISED_10baseT_Full</span><span class="p">;</span>
				<span class="k">else</span>
					<span class="n">advertising</span> <span class="o">|=</span> <span class="n">ADVERTISED_10baseT_Full</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">phydev</span><span class="o">-&gt;</span><span class="n">advertising</span> <span class="o">=</span> <span class="n">advertising</span><span class="p">;</span>

			<span class="n">phy_start_aneg</span><span class="p">(</span><span class="n">phydev</span><span class="p">);</span>

			<span class="n">phyid</span> <span class="o">=</span> <span class="n">phydev</span><span class="o">-&gt;</span><span class="n">drv</span><span class="o">-&gt;</span><span class="n">phy_id</span> <span class="o">&amp;</span> <span class="n">phydev</span><span class="o">-&gt;</span><span class="n">drv</span><span class="o">-&gt;</span><span class="n">phy_id_mask</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">phyid</span> <span class="o">!=</span> <span class="n">PHY_ID_BCMAC131</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">phyid</span> <span class="o">&amp;=</span> <span class="n">PHY_BCM_OUI_MASK</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">phyid</span> <span class="o">==</span> <span class="n">PHY_BCM_OUI_1</span> <span class="o">||</span>
				    <span class="n">phyid</span> <span class="o">==</span> <span class="n">PHY_BCM_OUI_2</span> <span class="o">||</span>
				    <span class="n">phyid</span> <span class="o">==</span> <span class="n">PHY_BCM_OUI_3</span><span class="p">)</span>
					<span class="n">do_low_power</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">do_low_power</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">phy_flags</span> <span class="o">&amp;</span> <span class="n">TG3_PHYFLG_IS_LOW_POWER</span><span class="p">))</span>
			<span class="n">tp</span><span class="o">-&gt;</span><span class="n">phy_flags</span> <span class="o">|=</span> <span class="n">TG3_PHYFLG_IS_LOW_POWER</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">phy_flags</span> <span class="o">&amp;</span> <span class="n">TG3_PHYFLG_ANY_SERDES</span><span class="p">))</span>
			<span class="n">tg3_setup_phy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">ASIC_REV_5906</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>

		<span class="n">val</span> <span class="o">=</span> <span class="n">tr32</span><span class="p">(</span><span class="n">GRC_VCPU_EXT_CTRL</span><span class="p">);</span>
		<span class="n">tw32</span><span class="p">(</span><span class="n">GRC_VCPU_EXT_CTRL</span><span class="p">,</span> <span class="n">val</span> <span class="o">|</span> <span class="n">GRC_VCPU_EXT_CTRL_DISABLE_WOL</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">ENABLE_ASF</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">200</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">tg3_read_mem</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">NIC_SRAM_FW_ASF_STATUS_MBOX</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">==</span> <span class="o">~</span><span class="n">NIC_SRAM_FIRMWARE_MBOX_MAGIC1</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">msleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">WOL_CAP</span><span class="p">))</span>
		<span class="n">tg3_write_mem</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">NIC_SRAM_WOL_MBOX</span><span class="p">,</span> <span class="n">WOL_SIGNATURE</span> <span class="o">|</span>
						     <span class="n">WOL_DRV_STATE_SHUTDOWN</span> <span class="o">|</span>
						     <span class="n">WOL_DRV_WOL</span> <span class="o">|</span>
						     <span class="n">WOL_SET_MAGIC_PKT</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">device_should_wake</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">mac_mode</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">phy_flags</span> <span class="o">&amp;</span> <span class="n">TG3_PHYFLG_PHY_SERDES</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">do_low_power</span> <span class="o">&amp;&amp;</span>
			    <span class="o">!</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">phy_flags</span> <span class="o">&amp;</span> <span class="n">TG3_PHYFLG_IS_FET</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">tg3_phy_auxctl_write</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span>
					       <span class="n">MII_TG3_AUXCTL_SHDWSEL_PWRCTL</span><span class="p">,</span>
					       <span class="n">MII_TG3_AUXCTL_PCTL_WOL_EN</span> <span class="o">|</span>
					       <span class="n">MII_TG3_AUXCTL_PCTL_100TX_LPWR</span> <span class="o">|</span>
					       <span class="n">MII_TG3_AUXCTL_PCTL_CL_AB_TXDAC</span><span class="p">);</span>
				<span class="n">udelay</span><span class="p">(</span><span class="mi">40</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">phy_flags</span> <span class="o">&amp;</span> <span class="n">TG3_PHYFLG_MII_SERDES</span><span class="p">)</span>
				<span class="n">mac_mode</span> <span class="o">=</span> <span class="n">MAC_MODE_PORT_MODE_GMII</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">mac_mode</span> <span class="o">=</span> <span class="n">MAC_MODE_PORT_MODE_MII</span><span class="p">;</span>

			<span class="n">mac_mode</span> <span class="o">|=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">mac_mode</span> <span class="o">&amp;</span> <span class="n">MAC_MODE_LINK_POLARITY</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span>
			    <span class="n">ASIC_REV_5700</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">u32</span> <span class="n">speed</span> <span class="o">=</span> <span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">WOL_SPEED_100MB</span><span class="p">)</span> <span class="o">?</span>
					     <span class="n">SPEED_100</span> <span class="o">:</span> <span class="n">SPEED_10</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">tg3_5700_link_polarity</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">speed</span><span class="p">))</span>
					<span class="n">mac_mode</span> <span class="o">|=</span> <span class="n">MAC_MODE_LINK_POLARITY</span><span class="p">;</span>
				<span class="k">else</span>
					<span class="n">mac_mode</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MAC_MODE_LINK_POLARITY</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">mac_mode</span> <span class="o">=</span> <span class="n">MAC_MODE_PORT_MODE_TBI</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">5750</span><span class="n">_PLUS</span><span class="p">))</span>
			<span class="n">tw32</span><span class="p">(</span><span class="n">MAC_LED_CTRL</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">led_ctrl</span><span class="p">);</span>

		<span class="n">mac_mode</span> <span class="o">|=</span> <span class="n">MAC_MODE_MAGIC_PKT_ENABLE</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">5705</span><span class="n">_PLUS</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">5780</span><span class="n">_CLASS</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">ENABLE_ASF</span><span class="p">)</span> <span class="o">||</span> <span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">ENABLE_APE</span><span class="p">)))</span>
			<span class="n">mac_mode</span> <span class="o">|=</span> <span class="n">MAC_MODE_KEEP_FRAME_IN_WOL</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">ENABLE_APE</span><span class="p">))</span>
			<span class="n">mac_mode</span> <span class="o">|=</span> <span class="n">MAC_MODE_APE_TX_EN</span> <span class="o">|</span>
				    <span class="n">MAC_MODE_APE_RX_EN</span> <span class="o">|</span>
				    <span class="n">MAC_MODE_TDE_ENABLE</span><span class="p">;</span>

		<span class="n">tw32_f</span><span class="p">(</span><span class="n">MAC_MODE</span><span class="p">,</span> <span class="n">mac_mode</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>

		<span class="n">tw32_f</span><span class="p">(</span><span class="n">MAC_RX_MODE</span><span class="p">,</span> <span class="n">RX_MODE_ENABLE</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">WOL_SPEED_100MB</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">ASIC_REV_5700</span> <span class="o">||</span>
	     <span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">ASIC_REV_5701</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">base_val</span><span class="p">;</span>

		<span class="n">base_val</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_clock_ctrl</span><span class="p">;</span>
		<span class="n">base_val</span> <span class="o">|=</span> <span class="p">(</span><span class="n">CLOCK_CTRL_RXCLK_DISABLE</span> <span class="o">|</span>
			     <span class="n">CLOCK_CTRL_TXCLK_DISABLE</span><span class="p">);</span>

		<span class="n">tw32_wait_f</span><span class="p">(</span><span class="n">TG3PCI_CLOCK_CTRL</span><span class="p">,</span> <span class="n">base_val</span> <span class="o">|</span> <span class="n">CLOCK_CTRL_ALTCLK</span> <span class="o">|</span>
			    <span class="n">CLOCK_CTRL_PWRDOWN_PLL133</span><span class="p">,</span> <span class="mi">40</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">5780</span><span class="n">_CLASS</span><span class="p">)</span> <span class="o">||</span>
		   <span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">CPMU_PRESENT</span><span class="p">)</span> <span class="o">||</span>
		   <span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">ASIC_REV_5906</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* do nothing */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">5750</span><span class="n">_PLUS</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">ENABLE_ASF</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">newbits1</span><span class="p">,</span> <span class="n">newbits2</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">ASIC_REV_5700</span> <span class="o">||</span>
		    <span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">ASIC_REV_5701</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">newbits1</span> <span class="o">=</span> <span class="p">(</span><span class="n">CLOCK_CTRL_RXCLK_DISABLE</span> <span class="o">|</span>
				    <span class="n">CLOCK_CTRL_TXCLK_DISABLE</span> <span class="o">|</span>
				    <span class="n">CLOCK_CTRL_ALTCLK</span><span class="p">);</span>
			<span class="n">newbits2</span> <span class="o">=</span> <span class="n">newbits1</span> <span class="o">|</span> <span class="n">CLOCK_CTRL_44MHZ_CORE</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">5705</span><span class="n">_PLUS</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">newbits1</span> <span class="o">=</span> <span class="n">CLOCK_CTRL_625_CORE</span><span class="p">;</span>
			<span class="n">newbits2</span> <span class="o">=</span> <span class="n">newbits1</span> <span class="o">|</span> <span class="n">CLOCK_CTRL_ALTCLK</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">newbits1</span> <span class="o">=</span> <span class="n">CLOCK_CTRL_ALTCLK</span><span class="p">;</span>
			<span class="n">newbits2</span> <span class="o">=</span> <span class="n">newbits1</span> <span class="o">|</span> <span class="n">CLOCK_CTRL_44MHZ_CORE</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">tw32_wait_f</span><span class="p">(</span><span class="n">TG3PCI_CLOCK_CTRL</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_clock_ctrl</span> <span class="o">|</span> <span class="n">newbits1</span><span class="p">,</span>
			    <span class="mi">40</span><span class="p">);</span>

		<span class="n">tw32_wait_f</span><span class="p">(</span><span class="n">TG3PCI_CLOCK_CTRL</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_clock_ctrl</span> <span class="o">|</span> <span class="n">newbits2</span><span class="p">,</span>
			    <span class="mi">40</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">5705</span><span class="n">_PLUS</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">u32</span> <span class="n">newbits3</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">ASIC_REV_5700</span> <span class="o">||</span>
			    <span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">ASIC_REV_5701</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">newbits3</span> <span class="o">=</span> <span class="p">(</span><span class="n">CLOCK_CTRL_RXCLK_DISABLE</span> <span class="o">|</span>
					    <span class="n">CLOCK_CTRL_TXCLK_DISABLE</span> <span class="o">|</span>
					    <span class="n">CLOCK_CTRL_44MHZ_CORE</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">newbits3</span> <span class="o">=</span> <span class="n">CLOCK_CTRL_44MHZ_CORE</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">tw32_wait_f</span><span class="p">(</span><span class="n">TG3PCI_CLOCK_CTRL</span><span class="p">,</span>
				    <span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_clock_ctrl</span> <span class="o">|</span> <span class="n">newbits3</span><span class="p">,</span> <span class="mi">40</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">device_should_wake</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">ENABLE_ASF</span><span class="p">))</span>
		<span class="n">tg3_power_down_phy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">do_low_power</span><span class="p">);</span>

	<span class="n">tg3_frob_aux_power</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>

	<span class="cm">/* Workaround for unstable PLL clock */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">GET_CHIP_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">CHIPREV_5750_AX</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">GET_CHIP_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">CHIPREV_5750_BX</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">val</span> <span class="o">=</span> <span class="n">tr32</span><span class="p">(</span><span class="mh">0x7d00</span><span class="p">);</span>

		<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">tw32</span><span class="p">(</span><span class="mh">0x7d00</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">ENABLE_ASF</span><span class="p">))</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

			<span class="n">err</span> <span class="o">=</span> <span class="n">tg3_nvram_lock</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
			<span class="n">tg3_halt_cpu</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">RX_CPU_BASE</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span>
				<span class="n">tg3_nvram_unlock</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">tg3_write_sig_post_reset</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">RESET_KIND_SHUTDOWN</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tg3_power_down</span><span class="p">(</span><span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">tg3_power_down_prepare</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>

	<span class="n">pci_wake_from_d3</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">WOL_ENABLE</span><span class="p">));</span>
	<span class="n">pci_set_power_state</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_D3hot</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tg3_aux_stat_to_speed_duplex</span><span class="p">(</span><span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span><span class="p">,</span> <span class="n">u32</span> <span class="n">val</span><span class="p">,</span> <span class="n">u16</span> <span class="o">*</span><span class="n">speed</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">duplex</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">MII_TG3_AUX_STAT_SPDMASK</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">MII_TG3_AUX_STAT_10HALF</span>:
		<span class="o">*</span><span class="n">speed</span> <span class="o">=</span> <span class="n">SPEED_10</span><span class="p">;</span>
		<span class="o">*</span><span class="n">duplex</span> <span class="o">=</span> <span class="n">DUPLEX_HALF</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">MII_TG3_AUX_STAT_10FULL</span>:
		<span class="o">*</span><span class="n">speed</span> <span class="o">=</span> <span class="n">SPEED_10</span><span class="p">;</span>
		<span class="o">*</span><span class="n">duplex</span> <span class="o">=</span> <span class="n">DUPLEX_FULL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">MII_TG3_AUX_STAT_100HALF</span>:
		<span class="o">*</span><span class="n">speed</span> <span class="o">=</span> <span class="n">SPEED_100</span><span class="p">;</span>
		<span class="o">*</span><span class="n">duplex</span> <span class="o">=</span> <span class="n">DUPLEX_HALF</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">MII_TG3_AUX_STAT_100FULL</span>:
		<span class="o">*</span><span class="n">speed</span> <span class="o">=</span> <span class="n">SPEED_100</span><span class="p">;</span>
		<span class="o">*</span><span class="n">duplex</span> <span class="o">=</span> <span class="n">DUPLEX_FULL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">MII_TG3_AUX_STAT_1000HALF</span>:
		<span class="o">*</span><span class="n">speed</span> <span class="o">=</span> <span class="n">SPEED_1000</span><span class="p">;</span>
		<span class="o">*</span><span class="n">duplex</span> <span class="o">=</span> <span class="n">DUPLEX_HALF</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">MII_TG3_AUX_STAT_1000FULL</span>:
		<span class="o">*</span><span class="n">speed</span> <span class="o">=</span> <span class="n">SPEED_1000</span><span class="p">;</span>
		<span class="o">*</span><span class="n">duplex</span> <span class="o">=</span> <span class="n">DUPLEX_FULL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">phy_flags</span> <span class="o">&amp;</span> <span class="n">TG3_PHYFLG_IS_FET</span><span class="p">)</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">speed</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">MII_TG3_AUX_STAT_100</span><span class="p">)</span> <span class="o">?</span> <span class="n">SPEED_100</span> <span class="o">:</span>
				 <span class="n">SPEED_10</span><span class="p">;</span>
			<span class="o">*</span><span class="n">duplex</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">MII_TG3_AUX_STAT_FULL</span><span class="p">)</span> <span class="o">?</span> <span class="n">DUPLEX_FULL</span> <span class="o">:</span>
				  <span class="n">DUPLEX_HALF</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="o">*</span><span class="n">speed</span> <span class="o">=</span> <span class="n">SPEED_UNKNOWN</span><span class="p">;</span>
		<span class="o">*</span><span class="n">duplex</span> <span class="o">=</span> <span class="n">DUPLEX_UNKNOWN</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tg3_phy_autoneg_cfg</span><span class="p">(</span><span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span><span class="p">,</span> <span class="n">u32</span> <span class="n">advertise</span><span class="p">,</span> <span class="n">u32</span> <span class="n">flowctrl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">,</span> <span class="n">new_adv</span><span class="p">;</span>

	<span class="n">new_adv</span> <span class="o">=</span> <span class="n">ADVERTISE_CSMA</span><span class="p">;</span>
	<span class="n">new_adv</span> <span class="o">|=</span> <span class="n">ethtool_adv_to_mii_adv_t</span><span class="p">(</span><span class="n">advertise</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ADVERTISE_ALL</span><span class="p">;</span>
	<span class="n">new_adv</span> <span class="o">|=</span> <span class="n">mii_advertise_flowctrl</span><span class="p">(</span><span class="n">flowctrl</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">tg3_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">MII_ADVERTISE</span><span class="p">,</span> <span class="n">new_adv</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">phy_flags</span> <span class="o">&amp;</span> <span class="n">TG3_PHYFLG_10_100_ONLY</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">new_adv</span> <span class="o">=</span> <span class="n">ethtool_adv_to_mii_ctrl1000_t</span><span class="p">(</span><span class="n">advertise</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span> <span class="o">==</span> <span class="n">CHIPREV_ID_5701_A0</span> <span class="o">||</span>
		    <span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span> <span class="o">==</span> <span class="n">CHIPREV_ID_5701_B0</span><span class="p">)</span>
			<span class="n">new_adv</span> <span class="o">|=</span> <span class="n">CTL1000_AS_MASTER</span> <span class="o">|</span> <span class="n">CTL1000_ENABLE_MASTER</span><span class="p">;</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">tg3_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">MII_CTRL1000</span><span class="p">,</span> <span class="n">new_adv</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">phy_flags</span> <span class="o">&amp;</span> <span class="n">TG3_PHYFLG_EEE_CAP</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

	<span class="n">tw32</span><span class="p">(</span><span class="n">TG3_CPMU_EEE_MODE</span><span class="p">,</span>
	     <span class="n">tr32</span><span class="p">(</span><span class="n">TG3_CPMU_EEE_MODE</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">TG3_CPMU_EEEMD_LPI_ENABLE</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">TG3_PHY_AUXCTL_SMDSP_ENABLE</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">err2</span><span class="p">;</span>

		<span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="cm">/* Advertise 100-BaseTX EEE ability */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">advertise</span> <span class="o">&amp;</span> <span class="n">ADVERTISED_100baseT_Full</span><span class="p">)</span>
			<span class="n">val</span> <span class="o">|=</span> <span class="n">MDIO_AN_EEE_ADV_100TX</span><span class="p">;</span>
		<span class="cm">/* Advertise 1000-BaseT EEE ability */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">advertise</span> <span class="o">&amp;</span> <span class="n">ADVERTISED_1000baseT_Full</span><span class="p">)</span>
			<span class="n">val</span> <span class="o">|=</span> <span class="n">MDIO_AN_EEE_ADV_1000T</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">tg3_phy_cl45_write</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">MDIO_MMD_AN</span><span class="p">,</span> <span class="n">MDIO_AN_EEE_ADV</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">ASIC_REV_5717</span>:
		<span class="k">case</span> <span class="n">ASIC_REV_57765</span>:
		<span class="k">case</span> <span class="n">ASIC_REV_57766</span>:
		<span class="k">case</span> <span class="n">ASIC_REV_5719</span>:
			<span class="cm">/* If we advertised any eee advertisements above... */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">val</span><span class="p">)</span>
				<span class="n">val</span> <span class="o">=</span> <span class="n">MII_TG3_DSP_TAP26_ALNOKO</span> <span class="o">|</span>
				      <span class="n">MII_TG3_DSP_TAP26_RMRXSTO</span> <span class="o">|</span>
				      <span class="n">MII_TG3_DSP_TAP26_OPCSINPT</span><span class="p">;</span>
			<span class="n">tg3_phydsp_write</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">MII_TG3_DSP_TAP26</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
			<span class="cm">/* Fall through */</span>
		<span class="k">case</span> <span class="n">ASIC_REV_5720</span>:
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tg3_phydsp_read</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">MII_TG3_DSP_CH34TP2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">))</span>
				<span class="n">tg3_phydsp_write</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">MII_TG3_DSP_CH34TP2</span><span class="p">,</span> <span class="n">val</span> <span class="o">|</span>
						 <span class="n">MII_TG3_DSP_CH34TP2_HIBW01</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">err2</span> <span class="o">=</span> <span class="n">TG3_PHY_AUXCTL_SMDSP_DISABLE</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">err2</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">done:</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tg3_phy_copper_begin</span><span class="p">(</span><span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">link_config</span><span class="p">.</span><span class="n">autoneg</span> <span class="o">==</span> <span class="n">AUTONEG_ENABLE</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">phy_flags</span> <span class="o">&amp;</span> <span class="n">TG3_PHYFLG_IS_LOW_POWER</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">adv</span><span class="p">,</span> <span class="n">fc</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">phy_flags</span> <span class="o">&amp;</span> <span class="n">TG3_PHYFLG_IS_LOW_POWER</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">adv</span> <span class="o">=</span> <span class="n">ADVERTISED_10baseT_Half</span> <span class="o">|</span>
			      <span class="n">ADVERTISED_10baseT_Full</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">WOL_SPEED_100MB</span><span class="p">))</span>
				<span class="n">adv</span> <span class="o">|=</span> <span class="n">ADVERTISED_100baseT_Half</span> <span class="o">|</span>
				       <span class="n">ADVERTISED_100baseT_Full</span><span class="p">;</span>

			<span class="n">fc</span> <span class="o">=</span> <span class="n">FLOW_CTRL_TX</span> <span class="o">|</span> <span class="n">FLOW_CTRL_RX</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">adv</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">link_config</span><span class="p">.</span><span class="n">advertising</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">phy_flags</span> <span class="o">&amp;</span> <span class="n">TG3_PHYFLG_10_100_ONLY</span><span class="p">)</span>
				<span class="n">adv</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">ADVERTISED_1000baseT_Half</span> <span class="o">|</span>
					 <span class="n">ADVERTISED_1000baseT_Full</span><span class="p">);</span>

			<span class="n">fc</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">link_config</span><span class="p">.</span><span class="n">flowctrl</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">tg3_phy_autoneg_cfg</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">adv</span><span class="p">,</span> <span class="n">fc</span><span class="p">);</span>

		<span class="n">tg3_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">MII_BMCR</span><span class="p">,</span>
			     <span class="n">BMCR_ANENABLE</span> <span class="o">|</span> <span class="n">BMCR_ANRESTART</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">bmcr</span><span class="p">,</span> <span class="n">orig_bmcr</span><span class="p">;</span>

		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">link_config</span><span class="p">.</span><span class="n">active_speed</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">link_config</span><span class="p">.</span><span class="n">speed</span><span class="p">;</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">link_config</span><span class="p">.</span><span class="n">active_duplex</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">link_config</span><span class="p">.</span><span class="n">duplex</span><span class="p">;</span>

		<span class="n">bmcr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">link_config</span><span class="p">.</span><span class="n">speed</span><span class="p">)</span> <span class="p">{</span>
		<span class="nl">default:</span>
		<span class="k">case</span> <span class="n">SPEED_10</span>:
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">SPEED_100</span>:
			<span class="n">bmcr</span> <span class="o">|=</span> <span class="n">BMCR_SPEED100</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">SPEED_1000</span>:
			<span class="n">bmcr</span> <span class="o">|=</span> <span class="n">BMCR_SPEED1000</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">link_config</span><span class="p">.</span><span class="n">duplex</span> <span class="o">==</span> <span class="n">DUPLEX_FULL</span><span class="p">)</span>
			<span class="n">bmcr</span> <span class="o">|=</span> <span class="n">BMCR_FULLDPLX</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tg3_readphy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">MII_BMCR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">orig_bmcr</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">bmcr</span> <span class="o">!=</span> <span class="n">orig_bmcr</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">tg3_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">MII_BMCR</span><span class="p">,</span> <span class="n">BMCR_LOOPBACK</span><span class="p">);</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">1500</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">u32</span> <span class="n">tmp</span><span class="p">;</span>

				<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">tg3_readphy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">MII_BMSR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp</span><span class="p">)</span> <span class="o">||</span>
				    <span class="n">tg3_readphy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">MII_BMSR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp</span><span class="p">))</span>
					<span class="k">continue</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">BMSR_LSTATUS</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">udelay</span><span class="p">(</span><span class="mi">40</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="n">tg3_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">MII_BMCR</span><span class="p">,</span> <span class="n">bmcr</span><span class="p">);</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">40</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tg3_init_5401phy_dsp</span><span class="p">(</span><span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="cm">/* Turn off tap power management. */</span>
	<span class="cm">/* Set Extended packet length bit */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">tg3_phy_auxctl_write</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">MII_TG3_AUXCTL_SHDWSEL_AUXCTL</span><span class="p">,</span> <span class="mh">0x4c20</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">|=</span> <span class="n">tg3_phydsp_write</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mh">0x0012</span><span class="p">,</span> <span class="mh">0x1804</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">|=</span> <span class="n">tg3_phydsp_write</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mh">0x0013</span><span class="p">,</span> <span class="mh">0x1204</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">|=</span> <span class="n">tg3_phydsp_write</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mh">0x8006</span><span class="p">,</span> <span class="mh">0x0132</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">|=</span> <span class="n">tg3_phydsp_write</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mh">0x8006</span><span class="p">,</span> <span class="mh">0x0232</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">|=</span> <span class="n">tg3_phydsp_write</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mh">0x201f</span><span class="p">,</span> <span class="mh">0x0a20</span><span class="p">);</span>

	<span class="n">udelay</span><span class="p">(</span><span class="mi">40</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">tg3_phy_copper_an_config_ok</span><span class="p">(</span><span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">lcladv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">advmsk</span><span class="p">,</span> <span class="n">tgtadv</span><span class="p">,</span> <span class="n">advertising</span><span class="p">;</span>

	<span class="n">advertising</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">link_config</span><span class="p">.</span><span class="n">advertising</span><span class="p">;</span>
	<span class="n">tgtadv</span> <span class="o">=</span> <span class="n">ethtool_adv_to_mii_adv_t</span><span class="p">(</span><span class="n">advertising</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ADVERTISE_ALL</span><span class="p">;</span>

	<span class="n">advmsk</span> <span class="o">=</span> <span class="n">ADVERTISE_ALL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">link_config</span><span class="p">.</span><span class="n">active_duplex</span> <span class="o">==</span> <span class="n">DUPLEX_FULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tgtadv</span> <span class="o">|=</span> <span class="n">mii_advertise_flowctrl</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">link_config</span><span class="p">.</span><span class="n">flowctrl</span><span class="p">);</span>
		<span class="n">advmsk</span> <span class="o">|=</span> <span class="n">ADVERTISE_PAUSE_CAP</span> <span class="o">|</span> <span class="n">ADVERTISE_PAUSE_ASYM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tg3_readphy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">MII_ADVERTISE</span><span class="p">,</span> <span class="n">lcladv</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="o">*</span><span class="n">lcladv</span> <span class="o">&amp;</span> <span class="n">advmsk</span><span class="p">)</span> <span class="o">!=</span> <span class="n">tgtadv</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">phy_flags</span> <span class="o">&amp;</span> <span class="n">TG3_PHYFLG_10_100_ONLY</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">tg3_ctrl</span><span class="p">;</span>

		<span class="n">tgtadv</span> <span class="o">=</span> <span class="n">ethtool_adv_to_mii_ctrl1000_t</span><span class="p">(</span><span class="n">advertising</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">tg3_readphy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">MII_CTRL1000</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tg3_ctrl</span><span class="p">))</span>
			<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">tgtadv</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span> <span class="o">==</span> <span class="n">CHIPREV_ID_5701_A0</span> <span class="o">||</span>
		     <span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span> <span class="o">==</span> <span class="n">CHIPREV_ID_5701_B0</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">tgtadv</span> <span class="o">|=</span> <span class="n">CTL1000_AS_MASTER</span> <span class="o">|</span> <span class="n">CTL1000_ENABLE_MASTER</span><span class="p">;</span>
			<span class="n">tg3_ctrl</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="n">ADVERTISE_1000HALF</span> <span class="o">|</span> <span class="n">ADVERTISE_1000FULL</span> <span class="o">|</span>
				     <span class="n">CTL1000_AS_MASTER</span> <span class="o">|</span> <span class="n">CTL1000_ENABLE_MASTER</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">tg3_ctrl</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="n">ADVERTISE_1000HALF</span> <span class="o">|</span> <span class="n">ADVERTISE_1000FULL</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">tg3_ctrl</span> <span class="o">!=</span> <span class="n">tgtadv</span><span class="p">)</span>
			<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">tg3_phy_copper_fetch_rmtadv</span><span class="p">(</span><span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">rmtadv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">lpeth</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">phy_flags</span> <span class="o">&amp;</span> <span class="n">TG3_PHYFLG_10_100_ONLY</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">tg3_readphy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">MII_STAT1000</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">))</span>
			<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

		<span class="n">lpeth</span> <span class="o">=</span> <span class="n">mii_stat1000_to_ethtool_lpa_t</span><span class="p">(</span><span class="n">val</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tg3_readphy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">MII_LPA</span><span class="p">,</span> <span class="n">rmtadv</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">lpeth</span> <span class="o">|=</span> <span class="n">mii_lpa_to_ethtool_lpa_t</span><span class="p">(</span><span class="o">*</span><span class="n">rmtadv</span><span class="p">);</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">link_config</span><span class="p">.</span><span class="n">rmt_adv</span> <span class="o">=</span> <span class="n">lpeth</span><span class="p">;</span>

	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tg3_setup_copper_phy</span><span class="p">(</span><span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">force_reset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">current_link_up</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">bmsr</span><span class="p">,</span> <span class="n">val</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">lcl_adv</span><span class="p">,</span> <span class="n">rmt_adv</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">current_speed</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">current_duplex</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">tw32</span><span class="p">(</span><span class="n">MAC_EVENT</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">tw32_f</span><span class="p">(</span><span class="n">MAC_STATUS</span><span class="p">,</span>
	     <span class="p">(</span><span class="n">MAC_STATUS_SYNC_CHANGED</span> <span class="o">|</span>
	      <span class="n">MAC_STATUS_CFG_CHANGED</span> <span class="o">|</span>
	      <span class="n">MAC_STATUS_MI_COMPLETION</span> <span class="o">|</span>
	      <span class="n">MAC_STATUS_LNKSTATE_CHANGED</span><span class="p">));</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">40</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">mi_mode</span> <span class="o">&amp;</span> <span class="n">MAC_MI_MODE_AUTO_POLL</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tw32_f</span><span class="p">(</span><span class="n">MAC_MI_MODE</span><span class="p">,</span>
		     <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">mi_mode</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">MAC_MI_MODE_AUTO_POLL</span><span class="p">));</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">80</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">tg3_phy_auxctl_write</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">MII_TG3_AUXCTL_SHDWSEL_PWRCTL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* Some third-party PHYs need to be reset on link going</span>
<span class="cm">	 * down.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">ASIC_REV_5703</span> <span class="o">||</span>
	     <span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">ASIC_REV_5704</span> <span class="o">||</span>
	     <span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">ASIC_REV_5705</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">netif_carrier_ok</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">tg3_readphy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">MII_BMSR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bmsr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tg3_readphy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">MII_BMSR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bmsr</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="o">!</span><span class="p">(</span><span class="n">bmsr</span> <span class="o">&amp;</span> <span class="n">BMSR_LSTATUS</span><span class="p">))</span>
			<span class="n">force_reset</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">force_reset</span><span class="p">)</span>
		<span class="n">tg3_phy_reset</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">phy_id</span> <span class="o">&amp;</span> <span class="n">TG3_PHY_ID_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">TG3_PHY_ID_BCM5401</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tg3_readphy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">MII_BMSR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bmsr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tg3_readphy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">MII_BMSR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bmsr</span><span class="p">)</span> <span class="o">||</span>
		    <span class="o">!</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">INIT_COMPLETE</span><span class="p">))</span>
			<span class="n">bmsr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">bmsr</span> <span class="o">&amp;</span> <span class="n">BMSR_LSTATUS</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">tg3_init_5401phy_dsp</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

			<span class="n">tg3_readphy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">MII_BMSR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bmsr</span><span class="p">);</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">1000</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tg3_readphy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">MII_BMSR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bmsr</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
				    <span class="p">(</span><span class="n">bmsr</span> <span class="o">&amp;</span> <span class="n">BMSR_LSTATUS</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">udelay</span><span class="p">(</span><span class="mi">40</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">((</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">phy_id</span> <span class="o">&amp;</span> <span class="n">TG3_PHY_ID_REV_MASK</span><span class="p">)</span> <span class="o">==</span>
			    <span class="n">TG3_PHY_REV_BCM5401_B0</span> <span class="o">&amp;&amp;</span>
			    <span class="o">!</span><span class="p">(</span><span class="n">bmsr</span> <span class="o">&amp;</span> <span class="n">BMSR_LSTATUS</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="n">tp</span><span class="o">-&gt;</span><span class="n">link_config</span><span class="p">.</span><span class="n">active_speed</span> <span class="o">==</span> <span class="n">SPEED_1000</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">err</span> <span class="o">=</span> <span class="n">tg3_phy_reset</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span>
					<span class="n">err</span> <span class="o">=</span> <span class="n">tg3_init_5401phy_dsp</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
					<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span> <span class="o">==</span> <span class="n">CHIPREV_ID_5701_A0</span> <span class="o">||</span>
		   <span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span> <span class="o">==</span> <span class="n">CHIPREV_ID_5701_B0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* 5701 {A0,B0} CRC bug workaround */</span>
		<span class="n">tg3_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mh">0x15</span><span class="p">,</span> <span class="mh">0x0a75</span><span class="p">);</span>
		<span class="n">tg3_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">MII_TG3_MISC_SHDW</span><span class="p">,</span> <span class="mh">0x8c68</span><span class="p">);</span>
		<span class="n">tg3_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">MII_TG3_MISC_SHDW</span><span class="p">,</span> <span class="mh">0x8d68</span><span class="p">);</span>
		<span class="n">tg3_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">MII_TG3_MISC_SHDW</span><span class="p">,</span> <span class="mh">0x8c68</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Clear pending interrupts... */</span>
	<span class="n">tg3_readphy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">MII_TG3_ISTAT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
	<span class="n">tg3_readphy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">MII_TG3_ISTAT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">phy_flags</span> <span class="o">&amp;</span> <span class="n">TG3_PHYFLG_USE_MI_INTERRUPT</span><span class="p">)</span>
		<span class="n">tg3_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">MII_TG3_IMASK</span><span class="p">,</span> <span class="o">~</span><span class="n">MII_TG3_INT_LINKCHG</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">phy_flags</span> <span class="o">&amp;</span> <span class="n">TG3_PHYFLG_IS_FET</span><span class="p">))</span>
		<span class="n">tg3_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">MII_TG3_IMASK</span><span class="p">,</span> <span class="o">~</span><span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">ASIC_REV_5700</span> <span class="o">||</span>
	    <span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">ASIC_REV_5701</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">led_ctrl</span> <span class="o">==</span> <span class="n">LED_CTRL_MODE_PHY_1</span><span class="p">)</span>
			<span class="n">tg3_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">MII_TG3_EXT_CTRL</span><span class="p">,</span>
				     <span class="n">MII_TG3_EXT_CTRL_LNK3_LED_MODE</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">tg3_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">MII_TG3_EXT_CTRL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">current_link_up</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">current_speed</span> <span class="o">=</span> <span class="n">SPEED_UNKNOWN</span><span class="p">;</span>
	<span class="n">current_duplex</span> <span class="o">=</span> <span class="n">DUPLEX_UNKNOWN</span><span class="p">;</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">phy_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">TG3_PHYFLG_MDIX_STATE</span><span class="p">;</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">link_config</span><span class="p">.</span><span class="n">rmt_adv</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">phy_flags</span> <span class="o">&amp;</span> <span class="n">TG3_PHYFLG_CAPACITIVE_COUPLING</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">tg3_phy_auxctl_read</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span>
					  <span class="n">MII_TG3_AUXCTL_SHDWSEL_MISCTEST</span><span class="p">,</span>
					  <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">tg3_phy_auxctl_write</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span>
					     <span class="n">MII_TG3_AUXCTL_SHDWSEL_MISCTEST</span><span class="p">,</span>
					     <span class="n">val</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">));</span>
			<span class="k">goto</span> <span class="n">relink</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">bmsr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tg3_readphy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">MII_BMSR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bmsr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tg3_readphy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">MII_BMSR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bmsr</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">bmsr</span> <span class="o">&amp;</span> <span class="n">BMSR_LSTATUS</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">40</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bmsr</span> <span class="o">&amp;</span> <span class="n">BMSR_LSTATUS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">aux_stat</span><span class="p">,</span> <span class="n">bmcr</span><span class="p">;</span>

		<span class="n">tg3_readphy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">MII_TG3_AUX_STAT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">aux_stat</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">2000</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tg3_readphy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">MII_TG3_AUX_STAT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">aux_stat</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="n">aux_stat</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">tg3_aux_stat_to_speed_duplex</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">aux_stat</span><span class="p">,</span>
					     <span class="o">&amp;</span><span class="n">current_speed</span><span class="p">,</span>
					     <span class="o">&amp;</span><span class="n">current_duplex</span><span class="p">);</span>

		<span class="n">bmcr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">200</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">tg3_readphy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">MII_BMCR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bmcr</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tg3_readphy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">MII_BMCR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bmcr</span><span class="p">))</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">bmcr</span> <span class="o">&amp;&amp;</span> <span class="n">bmcr</span> <span class="o">!=</span> <span class="mh">0x7fff</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">lcl_adv</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">rmt_adv</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">link_config</span><span class="p">.</span><span class="n">active_speed</span> <span class="o">=</span> <span class="n">current_speed</span><span class="p">;</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">link_config</span><span class="p">.</span><span class="n">active_duplex</span> <span class="o">=</span> <span class="n">current_duplex</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">link_config</span><span class="p">.</span><span class="n">autoneg</span> <span class="o">==</span> <span class="n">AUTONEG_ENABLE</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">bmcr</span> <span class="o">&amp;</span> <span class="n">BMCR_ANENABLE</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="n">tg3_phy_copper_an_config_ok</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lcl_adv</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="n">tg3_phy_copper_fetch_rmtadv</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rmt_adv</span><span class="p">))</span>
				<span class="n">current_link_up</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">bmcr</span> <span class="o">&amp;</span> <span class="n">BMCR_ANENABLE</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="n">tp</span><span class="o">-&gt;</span><span class="n">link_config</span><span class="p">.</span><span class="n">speed</span> <span class="o">==</span> <span class="n">current_speed</span> <span class="o">&amp;&amp;</span>
			    <span class="n">tp</span><span class="o">-&gt;</span><span class="n">link_config</span><span class="p">.</span><span class="n">duplex</span> <span class="o">==</span> <span class="n">current_duplex</span> <span class="o">&amp;&amp;</span>
			    <span class="n">tp</span><span class="o">-&gt;</span><span class="n">link_config</span><span class="p">.</span><span class="n">flowctrl</span> <span class="o">==</span>
			    <span class="n">tp</span><span class="o">-&gt;</span><span class="n">link_config</span><span class="p">.</span><span class="n">active_flowctrl</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">current_link_up</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">current_link_up</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span>
		    <span class="n">tp</span><span class="o">-&gt;</span><span class="n">link_config</span><span class="p">.</span><span class="n">active_duplex</span> <span class="o">==</span> <span class="n">DUPLEX_FULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u32</span> <span class="n">reg</span><span class="p">,</span> <span class="n">bit</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">phy_flags</span> <span class="o">&amp;</span> <span class="n">TG3_PHYFLG_IS_FET</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">reg</span> <span class="o">=</span> <span class="n">MII_TG3_FET_GEN_STAT</span><span class="p">;</span>
				<span class="n">bit</span> <span class="o">=</span> <span class="n">MII_TG3_FET_GEN_STAT_MDIXSTAT</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">reg</span> <span class="o">=</span> <span class="n">MII_TG3_EXT_STAT</span><span class="p">;</span>
				<span class="n">bit</span> <span class="o">=</span> <span class="n">MII_TG3_EXT_STAT_MDIX</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tg3_readphy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">bit</span><span class="p">))</span>
				<span class="n">tp</span><span class="o">-&gt;</span><span class="n">phy_flags</span> <span class="o">|=</span> <span class="n">TG3_PHYFLG_MDIX_STATE</span><span class="p">;</span>

			<span class="n">tg3_setup_flow_control</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">lcl_adv</span><span class="p">,</span> <span class="n">rmt_adv</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

<span class="nl">relink:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">current_link_up</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">phy_flags</span> <span class="o">&amp;</span> <span class="n">TG3_PHYFLG_IS_LOW_POWER</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">tg3_phy_copper_begin</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>

		<span class="n">tg3_readphy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">MII_BMSR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bmsr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="n">tg3_readphy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">MII_BMSR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bmsr</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">bmsr</span> <span class="o">&amp;</span> <span class="n">BMSR_LSTATUS</span><span class="p">))</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">mac_mode</span> <span class="o">&amp;</span> <span class="n">MAC_MODE_PORT_INT_LPBACK</span><span class="p">))</span>
			<span class="n">current_link_up</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">mac_mode</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MAC_MODE_PORT_MODE_MASK</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">current_link_up</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">link_config</span><span class="p">.</span><span class="n">active_speed</span> <span class="o">==</span> <span class="n">SPEED_100</span> <span class="o">||</span>
		    <span class="n">tp</span><span class="o">-&gt;</span><span class="n">link_config</span><span class="p">.</span><span class="n">active_speed</span> <span class="o">==</span> <span class="n">SPEED_10</span><span class="p">)</span>
			<span class="n">tp</span><span class="o">-&gt;</span><span class="n">mac_mode</span> <span class="o">|=</span> <span class="n">MAC_MODE_PORT_MODE_MII</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">tp</span><span class="o">-&gt;</span><span class="n">mac_mode</span> <span class="o">|=</span> <span class="n">MAC_MODE_PORT_MODE_GMII</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">phy_flags</span> <span class="o">&amp;</span> <span class="n">TG3_PHYFLG_IS_FET</span><span class="p">)</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">mac_mode</span> <span class="o">|=</span> <span class="n">MAC_MODE_PORT_MODE_MII</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">mac_mode</span> <span class="o">|=</span> <span class="n">MAC_MODE_PORT_MODE_GMII</span><span class="p">;</span>

	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">mac_mode</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MAC_MODE_HALF_DUPLEX</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">link_config</span><span class="p">.</span><span class="n">active_duplex</span> <span class="o">==</span> <span class="n">DUPLEX_HALF</span><span class="p">)</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">mac_mode</span> <span class="o">|=</span> <span class="n">MAC_MODE_HALF_DUPLEX</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">ASIC_REV_5700</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">current_link_up</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span>
		    <span class="n">tg3_5700_link_polarity</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">link_config</span><span class="p">.</span><span class="n">active_speed</span><span class="p">))</span>
			<span class="n">tp</span><span class="o">-&gt;</span><span class="n">mac_mode</span> <span class="o">|=</span> <span class="n">MAC_MODE_LINK_POLARITY</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">tp</span><span class="o">-&gt;</span><span class="n">mac_mode</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MAC_MODE_LINK_POLARITY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* ??? Without this setting Netgear GA302T PHY does not</span>
<span class="cm">	 * ??? send/receive packets...</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">phy_id</span> <span class="o">&amp;</span> <span class="n">TG3_PHY_ID_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">TG3_PHY_ID_BCM5411</span> <span class="o">&amp;&amp;</span>
	    <span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span> <span class="o">==</span> <span class="n">CHIPREV_ID_5700_ALTIMA</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">mi_mode</span> <span class="o">|=</span> <span class="n">MAC_MI_MODE_AUTO_POLL</span><span class="p">;</span>
		<span class="n">tw32_f</span><span class="p">(</span><span class="n">MAC_MI_MODE</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">mi_mode</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">80</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">tw32_f</span><span class="p">(</span><span class="n">MAC_MODE</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">mac_mode</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">40</span><span class="p">);</span>

	<span class="n">tg3_phy_eee_adjust</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">current_link_up</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">USE_LINKCHG_REG</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Polled via timer. */</span>
		<span class="n">tw32_f</span><span class="p">(</span><span class="n">MAC_EVENT</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">tw32_f</span><span class="p">(</span><span class="n">MAC_EVENT</span><span class="p">,</span> <span class="n">MAC_EVENT_LNKSTATE_CHANGED</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">40</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">ASIC_REV_5700</span> <span class="o">&amp;&amp;</span>
	    <span class="n">current_link_up</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span>
	    <span class="n">tp</span><span class="o">-&gt;</span><span class="n">link_config</span><span class="p">.</span><span class="n">active_speed</span> <span class="o">==</span> <span class="n">SPEED_1000</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">PCIX_MODE</span><span class="p">)</span> <span class="o">||</span> <span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">PCI_HIGH_SPEED</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">120</span><span class="p">);</span>
		<span class="n">tw32_f</span><span class="p">(</span><span class="n">MAC_STATUS</span><span class="p">,</span>
		     <span class="p">(</span><span class="n">MAC_STATUS_SYNC_CHANGED</span> <span class="o">|</span>
		      <span class="n">MAC_STATUS_CFG_CHANGED</span><span class="p">));</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">40</span><span class="p">);</span>
		<span class="n">tg3_write_mem</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span>
			      <span class="n">NIC_SRAM_FIRMWARE_MBOX</span><span class="p">,</span>
			      <span class="n">NIC_SRAM_FIRMWARE_MBOX_MAGIC2</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Prevent send BD corruption. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">CLKREQ_BUG</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">u16</span> <span class="n">oldlnkctl</span><span class="p">,</span> <span class="n">newlnkctl</span><span class="p">;</span>

		<span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span>
				     <span class="n">pci_pcie_cap</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">)</span> <span class="o">+</span> <span class="n">PCI_EXP_LNKCTL</span><span class="p">,</span>
				     <span class="o">&amp;</span><span class="n">oldlnkctl</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">link_config</span><span class="p">.</span><span class="n">active_speed</span> <span class="o">==</span> <span class="n">SPEED_100</span> <span class="o">||</span>
		    <span class="n">tp</span><span class="o">-&gt;</span><span class="n">link_config</span><span class="p">.</span><span class="n">active_speed</span> <span class="o">==</span> <span class="n">SPEED_10</span><span class="p">)</span>
			<span class="n">newlnkctl</span> <span class="o">=</span> <span class="n">oldlnkctl</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">PCI_EXP_LNKCTL_CLKREQ_EN</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">newlnkctl</span> <span class="o">=</span> <span class="n">oldlnkctl</span> <span class="o">|</span> <span class="n">PCI_EXP_LNKCTL_CLKREQ_EN</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">newlnkctl</span> <span class="o">!=</span> <span class="n">oldlnkctl</span><span class="p">)</span>
			<span class="n">pci_write_config_word</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span>
					      <span class="n">pci_pcie_cap</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">)</span> <span class="o">+</span>
					      <span class="n">PCI_EXP_LNKCTL</span><span class="p">,</span> <span class="n">newlnkctl</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">current_link_up</span> <span class="o">!=</span> <span class="n">netif_carrier_ok</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">current_link_up</span><span class="p">)</span>
			<span class="n">netif_carrier_on</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">netif_carrier_off</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">tg3_link_report</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">tg3_fiber_aneginfo</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="n">state</span><span class="p">;</span>
<span class="cp">#define ANEG_STATE_UNKNOWN		0</span>
<span class="cp">#define ANEG_STATE_AN_ENABLE		1</span>
<span class="cp">#define ANEG_STATE_RESTART_INIT		2</span>
<span class="cp">#define ANEG_STATE_RESTART		3</span>
<span class="cp">#define ANEG_STATE_DISABLE_LINK_OK	4</span>
<span class="cp">#define ANEG_STATE_ABILITY_DETECT_INIT	5</span>
<span class="cp">#define ANEG_STATE_ABILITY_DETECT	6</span>
<span class="cp">#define ANEG_STATE_ACK_DETECT_INIT	7</span>
<span class="cp">#define ANEG_STATE_ACK_DETECT		8</span>
<span class="cp">#define ANEG_STATE_COMPLETE_ACK_INIT	9</span>
<span class="cp">#define ANEG_STATE_COMPLETE_ACK		10</span>
<span class="cp">#define ANEG_STATE_IDLE_DETECT_INIT	11</span>
<span class="cp">#define ANEG_STATE_IDLE_DETECT		12</span>
<span class="cp">#define ANEG_STATE_LINK_OK		13</span>
<span class="cp">#define ANEG_STATE_NEXT_PAGE_WAIT_INIT	14</span>
<span class="cp">#define ANEG_STATE_NEXT_PAGE_WAIT	15</span>

	<span class="n">u32</span> <span class="n">flags</span><span class="p">;</span>
<span class="cp">#define MR_AN_ENABLE		0x00000001</span>
<span class="cp">#define MR_RESTART_AN		0x00000002</span>
<span class="cp">#define MR_AN_COMPLETE		0x00000004</span>
<span class="cp">#define MR_PAGE_RX		0x00000008</span>
<span class="cp">#define MR_NP_LOADED		0x00000010</span>
<span class="cp">#define MR_TOGGLE_TX		0x00000020</span>
<span class="cp">#define MR_LP_ADV_FULL_DUPLEX	0x00000040</span>
<span class="cp">#define MR_LP_ADV_HALF_DUPLEX	0x00000080</span>
<span class="cp">#define MR_LP_ADV_SYM_PAUSE	0x00000100</span>
<span class="cp">#define MR_LP_ADV_ASYM_PAUSE	0x00000200</span>
<span class="cp">#define MR_LP_ADV_REMOTE_FAULT1	0x00000400</span>
<span class="cp">#define MR_LP_ADV_REMOTE_FAULT2	0x00000800</span>
<span class="cp">#define MR_LP_ADV_NEXT_PAGE	0x00001000</span>
<span class="cp">#define MR_TOGGLE_RX		0x00002000</span>
<span class="cp">#define MR_NP_RX		0x00004000</span>

<span class="cp">#define MR_LINK_OK		0x80000000</span>

	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">link_time</span><span class="p">,</span> <span class="n">cur_time</span><span class="p">;</span>

	<span class="n">u32</span> <span class="n">ability_match_cfg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ability_match_count</span><span class="p">;</span>

	<span class="kt">char</span> <span class="n">ability_match</span><span class="p">,</span> <span class="n">idle_match</span><span class="p">,</span> <span class="n">ack_match</span><span class="p">;</span>

	<span class="n">u32</span> <span class="n">txconfig</span><span class="p">,</span> <span class="n">rxconfig</span><span class="p">;</span>
<span class="cp">#define ANEG_CFG_NP		0x00000080</span>
<span class="cp">#define ANEG_CFG_ACK		0x00000040</span>
<span class="cp">#define ANEG_CFG_RF2		0x00000020</span>
<span class="cp">#define ANEG_CFG_RF1		0x00000010</span>
<span class="cp">#define ANEG_CFG_PS2		0x00000001</span>
<span class="cp">#define ANEG_CFG_PS1		0x00008000</span>
<span class="cp">#define ANEG_CFG_HD		0x00004000</span>
<span class="cp">#define ANEG_CFG_FD		0x00002000</span>
<span class="cp">#define ANEG_CFG_INVAL		0x00001f06</span>

<span class="p">};</span>
<span class="cp">#define ANEG_OK		0</span>
<span class="cp">#define ANEG_DONE	1</span>
<span class="cp">#define ANEG_TIMER_ENAB	2</span>
<span class="cp">#define ANEG_FAILED	-1</span>

<span class="cp">#define ANEG_STATE_SETTLE_TIME	10000</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tg3_fiber_aneg_smachine</span><span class="p">(</span><span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">tg3_fiber_aneginfo</span> <span class="o">*</span><span class="n">ap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">flowctrl</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">delta</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">rx_cfg_reg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">ANEG_STATE_UNKNOWN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ap</span><span class="o">-&gt;</span><span class="n">rxconfig</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ap</span><span class="o">-&gt;</span><span class="n">link_time</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ap</span><span class="o">-&gt;</span><span class="n">cur_time</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ap</span><span class="o">-&gt;</span><span class="n">ability_match_cfg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ap</span><span class="o">-&gt;</span><span class="n">ability_match_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ap</span><span class="o">-&gt;</span><span class="n">ability_match</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ap</span><span class="o">-&gt;</span><span class="n">idle_match</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ap</span><span class="o">-&gt;</span><span class="n">ack_match</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ap</span><span class="o">-&gt;</span><span class="n">cur_time</span><span class="o">++</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tr32</span><span class="p">(</span><span class="n">MAC_STATUS</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">MAC_STATUS_RCVD_CFG</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rx_cfg_reg</span> <span class="o">=</span> <span class="n">tr32</span><span class="p">(</span><span class="n">MAC_RX_AUTO_NEG</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">rx_cfg_reg</span> <span class="o">!=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">ability_match_cfg</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ap</span><span class="o">-&gt;</span><span class="n">ability_match_cfg</span> <span class="o">=</span> <span class="n">rx_cfg_reg</span><span class="p">;</span>
			<span class="n">ap</span><span class="o">-&gt;</span><span class="n">ability_match</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">ap</span><span class="o">-&gt;</span><span class="n">ability_match_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">ability_match_count</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ap</span><span class="o">-&gt;</span><span class="n">ability_match</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">ap</span><span class="o">-&gt;</span><span class="n">ability_match_cfg</span> <span class="o">=</span> <span class="n">rx_cfg_reg</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rx_cfg_reg</span> <span class="o">&amp;</span> <span class="n">ANEG_CFG_ACK</span><span class="p">)</span>
			<span class="n">ap</span><span class="o">-&gt;</span><span class="n">ack_match</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">ap</span><span class="o">-&gt;</span><span class="n">ack_match</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">ap</span><span class="o">-&gt;</span><span class="n">idle_match</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ap</span><span class="o">-&gt;</span><span class="n">idle_match</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">ap</span><span class="o">-&gt;</span><span class="n">ability_match_cfg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ap</span><span class="o">-&gt;</span><span class="n">ability_match_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ap</span><span class="o">-&gt;</span><span class="n">ability_match</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ap</span><span class="o">-&gt;</span><span class="n">ack_match</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">rx_cfg_reg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ap</span><span class="o">-&gt;</span><span class="n">rxconfig</span> <span class="o">=</span> <span class="n">rx_cfg_reg</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">ANEG_OK</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ANEG_STATE_UNKNOWN</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">MR_AN_ENABLE</span> <span class="o">|</span> <span class="n">MR_RESTART_AN</span><span class="p">))</span>
			<span class="n">ap</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">ANEG_STATE_AN_ENABLE</span><span class="p">;</span>

		<span class="cm">/* fallthru */</span>
	<span class="k">case</span> <span class="n">ANEG_STATE_AN_ENABLE</span>:
		<span class="n">ap</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">MR_AN_COMPLETE</span> <span class="o">|</span> <span class="n">MR_PAGE_RX</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MR_AN_ENABLE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ap</span><span class="o">-&gt;</span><span class="n">link_time</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">ap</span><span class="o">-&gt;</span><span class="n">cur_time</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">ap</span><span class="o">-&gt;</span><span class="n">ability_match_cfg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">ap</span><span class="o">-&gt;</span><span class="n">ability_match_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">ap</span><span class="o">-&gt;</span><span class="n">ability_match</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">ap</span><span class="o">-&gt;</span><span class="n">idle_match</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">ap</span><span class="o">-&gt;</span><span class="n">ack_match</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

			<span class="n">ap</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">ANEG_STATE_RESTART_INIT</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">ap</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">ANEG_STATE_DISABLE_LINK_OK</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">ANEG_STATE_RESTART_INIT</span>:
		<span class="n">ap</span><span class="o">-&gt;</span><span class="n">link_time</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">cur_time</span><span class="p">;</span>
		<span class="n">ap</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">MR_NP_LOADED</span><span class="p">);</span>
		<span class="n">ap</span><span class="o">-&gt;</span><span class="n">txconfig</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">tw32</span><span class="p">(</span><span class="n">MAC_TX_AUTO_NEG</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">mac_mode</span> <span class="o">|=</span> <span class="n">MAC_MODE_SEND_CONFIGS</span><span class="p">;</span>
		<span class="n">tw32_f</span><span class="p">(</span><span class="n">MAC_MODE</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">mac_mode</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">40</span><span class="p">);</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">ANEG_TIMER_ENAB</span><span class="p">;</span>
		<span class="n">ap</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">ANEG_STATE_RESTART</span><span class="p">;</span>

		<span class="cm">/* fallthru */</span>
	<span class="k">case</span> <span class="n">ANEG_STATE_RESTART</span>:
		<span class="n">delta</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">cur_time</span> <span class="o">-</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">link_time</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">delta</span> <span class="o">&gt;</span> <span class="n">ANEG_STATE_SETTLE_TIME</span><span class="p">)</span>
			<span class="n">ap</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">ANEG_STATE_ABILITY_DETECT_INIT</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">ANEG_TIMER_ENAB</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">ANEG_STATE_DISABLE_LINK_OK</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">ANEG_DONE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">ANEG_STATE_ABILITY_DETECT_INIT</span>:
		<span class="n">ap</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">MR_TOGGLE_TX</span><span class="p">);</span>
		<span class="n">ap</span><span class="o">-&gt;</span><span class="n">txconfig</span> <span class="o">=</span> <span class="n">ANEG_CFG_FD</span><span class="p">;</span>
		<span class="n">flowctrl</span> <span class="o">=</span> <span class="n">tg3_advert_flowctrl_1000X</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">link_config</span><span class="p">.</span><span class="n">flowctrl</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">flowctrl</span> <span class="o">&amp;</span> <span class="n">ADVERTISE_1000XPAUSE</span><span class="p">)</span>
			<span class="n">ap</span><span class="o">-&gt;</span><span class="n">txconfig</span> <span class="o">|=</span> <span class="n">ANEG_CFG_PS1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">flowctrl</span> <span class="o">&amp;</span> <span class="n">ADVERTISE_1000XPSE_ASYM</span><span class="p">)</span>
			<span class="n">ap</span><span class="o">-&gt;</span><span class="n">txconfig</span> <span class="o">|=</span> <span class="n">ANEG_CFG_PS2</span><span class="p">;</span>
		<span class="n">tw32</span><span class="p">(</span><span class="n">MAC_TX_AUTO_NEG</span><span class="p">,</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">txconfig</span><span class="p">);</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">mac_mode</span> <span class="o">|=</span> <span class="n">MAC_MODE_SEND_CONFIGS</span><span class="p">;</span>
		<span class="n">tw32_f</span><span class="p">(</span><span class="n">MAC_MODE</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">mac_mode</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">40</span><span class="p">);</span>

		<span class="n">ap</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">ANEG_STATE_ABILITY_DETECT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">ANEG_STATE_ABILITY_DETECT</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">ability_match</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">rxconfig</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">ap</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">ANEG_STATE_ACK_DETECT_INIT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">ANEG_STATE_ACK_DETECT_INIT</span>:
		<span class="n">ap</span><span class="o">-&gt;</span><span class="n">txconfig</span> <span class="o">|=</span> <span class="n">ANEG_CFG_ACK</span><span class="p">;</span>
		<span class="n">tw32</span><span class="p">(</span><span class="n">MAC_TX_AUTO_NEG</span><span class="p">,</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">txconfig</span><span class="p">);</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">mac_mode</span> <span class="o">|=</span> <span class="n">MAC_MODE_SEND_CONFIGS</span><span class="p">;</span>
		<span class="n">tw32_f</span><span class="p">(</span><span class="n">MAC_MODE</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">mac_mode</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">40</span><span class="p">);</span>

		<span class="n">ap</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">ANEG_STATE_ACK_DETECT</span><span class="p">;</span>

		<span class="cm">/* fallthru */</span>
	<span class="k">case</span> <span class="n">ANEG_STATE_ACK_DETECT</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">ack_match</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">rxconfig</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">ANEG_CFG_ACK</span><span class="p">)</span> <span class="o">==</span>
			    <span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">ability_match_cfg</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">ANEG_CFG_ACK</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">ap</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">ANEG_STATE_COMPLETE_ACK_INIT</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">ap</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">ANEG_STATE_AN_ENABLE</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">ability_match</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
			   <span class="n">ap</span><span class="o">-&gt;</span><span class="n">rxconfig</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ap</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">ANEG_STATE_AN_ENABLE</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">ANEG_STATE_COMPLETE_ACK_INIT</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">rxconfig</span> <span class="o">&amp;</span> <span class="n">ANEG_CFG_INVAL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">ANEG_FAILED</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ap</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">MR_LP_ADV_FULL_DUPLEX</span> <span class="o">|</span>
			       <span class="n">MR_LP_ADV_HALF_DUPLEX</span> <span class="o">|</span>
			       <span class="n">MR_LP_ADV_SYM_PAUSE</span> <span class="o">|</span>
			       <span class="n">MR_LP_ADV_ASYM_PAUSE</span> <span class="o">|</span>
			       <span class="n">MR_LP_ADV_REMOTE_FAULT1</span> <span class="o">|</span>
			       <span class="n">MR_LP_ADV_REMOTE_FAULT2</span> <span class="o">|</span>
			       <span class="n">MR_LP_ADV_NEXT_PAGE</span> <span class="o">|</span>
			       <span class="n">MR_TOGGLE_RX</span> <span class="o">|</span>
			       <span class="n">MR_NP_RX</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">rxconfig</span> <span class="o">&amp;</span> <span class="n">ANEG_CFG_FD</span><span class="p">)</span>
			<span class="n">ap</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">MR_LP_ADV_FULL_DUPLEX</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">rxconfig</span> <span class="o">&amp;</span> <span class="n">ANEG_CFG_HD</span><span class="p">)</span>
			<span class="n">ap</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">MR_LP_ADV_HALF_DUPLEX</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">rxconfig</span> <span class="o">&amp;</span> <span class="n">ANEG_CFG_PS1</span><span class="p">)</span>
			<span class="n">ap</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">MR_LP_ADV_SYM_PAUSE</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">rxconfig</span> <span class="o">&amp;</span> <span class="n">ANEG_CFG_PS2</span><span class="p">)</span>
			<span class="n">ap</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">MR_LP_ADV_ASYM_PAUSE</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">rxconfig</span> <span class="o">&amp;</span> <span class="n">ANEG_CFG_RF1</span><span class="p">)</span>
			<span class="n">ap</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">MR_LP_ADV_REMOTE_FAULT1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">rxconfig</span> <span class="o">&amp;</span> <span class="n">ANEG_CFG_RF2</span><span class="p">)</span>
			<span class="n">ap</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">MR_LP_ADV_REMOTE_FAULT2</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">rxconfig</span> <span class="o">&amp;</span> <span class="n">ANEG_CFG_NP</span><span class="p">)</span>
			<span class="n">ap</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">MR_LP_ADV_NEXT_PAGE</span><span class="p">;</span>

		<span class="n">ap</span><span class="o">-&gt;</span><span class="n">link_time</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">cur_time</span><span class="p">;</span>

		<span class="n">ap</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">^=</span> <span class="p">(</span><span class="n">MR_TOGGLE_TX</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">rxconfig</span> <span class="o">&amp;</span> <span class="mh">0x0008</span><span class="p">)</span>
			<span class="n">ap</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">MR_TOGGLE_RX</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">rxconfig</span> <span class="o">&amp;</span> <span class="n">ANEG_CFG_NP</span><span class="p">)</span>
			<span class="n">ap</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">MR_NP_RX</span><span class="p">;</span>
		<span class="n">ap</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">MR_PAGE_RX</span><span class="p">;</span>

		<span class="n">ap</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">ANEG_STATE_COMPLETE_ACK</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">ANEG_TIMER_ENAB</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">ANEG_STATE_COMPLETE_ACK</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">ability_match</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
		    <span class="n">ap</span><span class="o">-&gt;</span><span class="n">rxconfig</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ap</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">ANEG_STATE_AN_ENABLE</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">delta</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">cur_time</span> <span class="o">-</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">link_time</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">delta</span> <span class="o">&gt;</span> <span class="n">ANEG_STATE_SETTLE_TIME</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">MR_LP_ADV_NEXT_PAGE</span><span class="p">)))</span> <span class="p">{</span>
				<span class="n">ap</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">ANEG_STATE_IDLE_DETECT_INIT</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">txconfig</span> <span class="o">&amp;</span> <span class="n">ANEG_CFG_NP</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
				    <span class="o">!</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MR_NP_RX</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">ap</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">ANEG_STATE_IDLE_DETECT_INIT</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">ret</span> <span class="o">=</span> <span class="n">ANEG_FAILED</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">ANEG_STATE_IDLE_DETECT_INIT</span>:
		<span class="n">ap</span><span class="o">-&gt;</span><span class="n">link_time</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">cur_time</span><span class="p">;</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">mac_mode</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MAC_MODE_SEND_CONFIGS</span><span class="p">;</span>
		<span class="n">tw32_f</span><span class="p">(</span><span class="n">MAC_MODE</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">mac_mode</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">40</span><span class="p">);</span>

		<span class="n">ap</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">ANEG_STATE_IDLE_DETECT</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">ANEG_TIMER_ENAB</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">ANEG_STATE_IDLE_DETECT</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">ability_match</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
		    <span class="n">ap</span><span class="o">-&gt;</span><span class="n">rxconfig</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ap</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">ANEG_STATE_AN_ENABLE</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">delta</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">cur_time</span> <span class="o">-</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">link_time</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">delta</span> <span class="o">&gt;</span> <span class="n">ANEG_STATE_SETTLE_TIME</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* XXX another gem from the Broadcom driver :( */</span>
			<span class="n">ap</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">ANEG_STATE_LINK_OK</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">ANEG_STATE_LINK_OK</span>:
		<span class="n">ap</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="p">(</span><span class="n">MR_AN_COMPLETE</span> <span class="o">|</span> <span class="n">MR_LINK_OK</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">ANEG_DONE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">ANEG_STATE_NEXT_PAGE_WAIT_INIT</span>:
		<span class="cm">/* ??? unimplemented */</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">ANEG_STATE_NEXT_PAGE_WAIT</span>:
		<span class="cm">/* ??? unimplemented */</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">ANEG_FAILED</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">fiber_autoneg</span><span class="p">(</span><span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">txflags</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">rxflags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">res</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tg3_fiber_aneginfo</span> <span class="n">aninfo</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="n">ANEG_FAILED</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tick</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="n">tw32_f</span><span class="p">(</span><span class="n">MAC_TX_AUTO_NEG</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">mac_mode</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">MAC_MODE_PORT_MODE_MASK</span><span class="p">;</span>
	<span class="n">tw32_f</span><span class="p">(</span><span class="n">MAC_MODE</span><span class="p">,</span> <span class="n">tmp</span> <span class="o">|</span> <span class="n">MAC_MODE_PORT_MODE_GMII</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">40</span><span class="p">);</span>

	<span class="n">tw32_f</span><span class="p">(</span><span class="n">MAC_MODE</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">mac_mode</span> <span class="o">|</span> <span class="n">MAC_MODE_SEND_CONFIGS</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">40</span><span class="p">);</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">aninfo</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">aninfo</span><span class="p">));</span>
	<span class="n">aninfo</span><span class="p">.</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">MR_AN_ENABLE</span><span class="p">;</span>
	<span class="n">aninfo</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">ANEG_STATE_UNKNOWN</span><span class="p">;</span>
	<span class="n">aninfo</span><span class="p">.</span><span class="n">cur_time</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">tick</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">++</span><span class="n">tick</span> <span class="o">&lt;</span> <span class="mi">195000</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">tg3_fiber_aneg_smachine</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">aninfo</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="n">ANEG_DONE</span> <span class="o">||</span> <span class="n">status</span> <span class="o">==</span> <span class="n">ANEG_FAILED</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">mac_mode</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MAC_MODE_SEND_CONFIGS</span><span class="p">;</span>
	<span class="n">tw32_f</span><span class="p">(</span><span class="n">MAC_MODE</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">mac_mode</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">40</span><span class="p">);</span>

	<span class="o">*</span><span class="n">txflags</span> <span class="o">=</span> <span class="n">aninfo</span><span class="p">.</span><span class="n">txconfig</span><span class="p">;</span>
	<span class="o">*</span><span class="n">rxflags</span> <span class="o">=</span> <span class="n">aninfo</span><span class="p">.</span><span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="n">ANEG_DONE</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">aninfo</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">MR_AN_COMPLETE</span> <span class="o">|</span> <span class="n">MR_LINK_OK</span> <span class="o">|</span>
			     <span class="n">MR_LP_ADV_FULL_DUPLEX</span><span class="p">)))</span>
		<span class="n">res</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tg3_init_bcm8002</span><span class="p">(</span><span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">mac_status</span> <span class="o">=</span> <span class="n">tr32</span><span class="p">(</span><span class="n">MAC_STATUS</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* Reset when initting first time or we have a link. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">INIT_COMPLETE</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="p">(</span><span class="n">mac_status</span> <span class="o">&amp;</span> <span class="n">MAC_STATUS_PCS_SYNCED</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* Set PLL lock range. */</span>
	<span class="n">tg3_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">,</span> <span class="mh">0x8007</span><span class="p">);</span>

	<span class="cm">/* SW reset */</span>
	<span class="n">tg3_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">MII_BMCR</span><span class="p">,</span> <span class="n">BMCR_RESET</span><span class="p">);</span>

	<span class="cm">/* Wait for reset to complete. */</span>
	<span class="cm">/* XXX schedule_timeout() ... */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">500</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>

	<span class="cm">/* Config mode; select PMA/Ch 1 regs. */</span>
	<span class="n">tg3_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x8411</span><span class="p">);</span>

	<span class="cm">/* Enable auto-lock and comdet, select txclk for tx. */</span>
	<span class="n">tg3_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="mh">0x0a10</span><span class="p">);</span>

	<span class="n">tg3_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">,</span> <span class="mh">0x00a0</span><span class="p">);</span>
	<span class="n">tg3_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">,</span> <span class="mh">0x41ff</span><span class="p">);</span>

	<span class="cm">/* Assert and deassert POR. */</span>
	<span class="n">tg3_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mh">0x13</span><span class="p">,</span> <span class="mh">0x0400</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">40</span><span class="p">);</span>
	<span class="n">tg3_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mh">0x13</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>

	<span class="n">tg3_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="mh">0x0a50</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">40</span><span class="p">);</span>
	<span class="n">tg3_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="mh">0x0a10</span><span class="p">);</span>

	<span class="cm">/* Wait for signal to stabilize */</span>
	<span class="cm">/* XXX schedule_timeout() ... */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">15000</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>

	<span class="cm">/* Deselect the channel register so we can read the PHYID</span>
<span class="cm">	 * later.</span>
<span class="cm">	 */</span>
	<span class="n">tg3_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x8011</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tg3_setup_fiber_hw_autoneg</span><span class="p">(</span><span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span><span class="p">,</span> <span class="n">u32</span> <span class="n">mac_status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">flowctrl</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">sg_dig_ctrl</span><span class="p">,</span> <span class="n">sg_dig_status</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">serdes_cfg</span><span class="p">,</span> <span class="n">expected_sg_dig_ctrl</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">workaround</span><span class="p">,</span> <span class="n">port_a</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">current_link_up</span><span class="p">;</span>

	<span class="n">serdes_cfg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">expected_sg_dig_ctrl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">workaround</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">port_a</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">current_link_up</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span> <span class="o">!=</span> <span class="n">CHIPREV_ID_5704_A0</span> <span class="o">&amp;&amp;</span>
	    <span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span> <span class="o">!=</span> <span class="n">CHIPREV_ID_5704_A1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">workaround</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tr32</span><span class="p">(</span><span class="n">TG3PCI_DUAL_MAC_CTRL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">DUAL_MAC_CTRL_ID</span><span class="p">)</span>
			<span class="n">port_a</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="cm">/* preserve bits 0-11,13,14 for signal pre-emphasis */</span>
		<span class="cm">/* preserve bits 20-23 for voltage regulator */</span>
		<span class="n">serdes_cfg</span> <span class="o">=</span> <span class="n">tr32</span><span class="p">(</span><span class="n">MAC_SERDES_CFG</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x00f06fff</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">sg_dig_ctrl</span> <span class="o">=</span> <span class="n">tr32</span><span class="p">(</span><span class="n">SG_DIG_CTRL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">link_config</span><span class="p">.</span><span class="n">autoneg</span> <span class="o">!=</span> <span class="n">AUTONEG_ENABLE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sg_dig_ctrl</span> <span class="o">&amp;</span> <span class="n">SG_DIG_USING_HW_AUTONEG</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">workaround</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">u32</span> <span class="n">val</span> <span class="o">=</span> <span class="n">serdes_cfg</span><span class="p">;</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">port_a</span><span class="p">)</span>
					<span class="n">val</span> <span class="o">|=</span> <span class="mh">0xc010000</span><span class="p">;</span>
				<span class="k">else</span>
					<span class="n">val</span> <span class="o">|=</span> <span class="mh">0x4010000</span><span class="p">;</span>
				<span class="n">tw32_f</span><span class="p">(</span><span class="n">MAC_SERDES_CFG</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="n">tw32_f</span><span class="p">(</span><span class="n">SG_DIG_CTRL</span><span class="p">,</span> <span class="n">SG_DIG_COMMON_SETUP</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mac_status</span> <span class="o">&amp;</span> <span class="n">MAC_STATUS_PCS_SYNCED</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">tg3_setup_flow_control</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">current_link_up</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Want auto-negotiation.  */</span>
	<span class="n">expected_sg_dig_ctrl</span> <span class="o">=</span> <span class="n">SG_DIG_USING_HW_AUTONEG</span> <span class="o">|</span> <span class="n">SG_DIG_COMMON_SETUP</span><span class="p">;</span>

	<span class="n">flowctrl</span> <span class="o">=</span> <span class="n">tg3_advert_flowctrl_1000X</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">link_config</span><span class="p">.</span><span class="n">flowctrl</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">flowctrl</span> <span class="o">&amp;</span> <span class="n">ADVERTISE_1000XPAUSE</span><span class="p">)</span>
		<span class="n">expected_sg_dig_ctrl</span> <span class="o">|=</span> <span class="n">SG_DIG_PAUSE_CAP</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">flowctrl</span> <span class="o">&amp;</span> <span class="n">ADVERTISE_1000XPSE_ASYM</span><span class="p">)</span>
		<span class="n">expected_sg_dig_ctrl</span> <span class="o">|=</span> <span class="n">SG_DIG_ASYM_PAUSE</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sg_dig_ctrl</span> <span class="o">!=</span> <span class="n">expected_sg_dig_ctrl</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">phy_flags</span> <span class="o">&amp;</span> <span class="n">TG3_PHYFLG_PARALLEL_DETECT</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="n">tp</span><span class="o">-&gt;</span><span class="n">serdes_counter</span> <span class="o">&amp;&amp;</span>
		    <span class="p">((</span><span class="n">mac_status</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">MAC_STATUS_PCS_SYNCED</span> <span class="o">|</span>
				    <span class="n">MAC_STATUS_RCVD_CFG</span><span class="p">))</span> <span class="o">==</span>
		     <span class="n">MAC_STATUS_PCS_SYNCED</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">tp</span><span class="o">-&gt;</span><span class="n">serdes_counter</span><span class="o">--</span><span class="p">;</span>
			<span class="n">current_link_up</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
<span class="nl">restart_autoneg:</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">workaround</span><span class="p">)</span>
			<span class="n">tw32_f</span><span class="p">(</span><span class="n">MAC_SERDES_CFG</span><span class="p">,</span> <span class="n">serdes_cfg</span> <span class="o">|</span> <span class="mh">0xc011000</span><span class="p">);</span>
		<span class="n">tw32_f</span><span class="p">(</span><span class="n">SG_DIG_CTRL</span><span class="p">,</span> <span class="n">expected_sg_dig_ctrl</span> <span class="o">|</span> <span class="n">SG_DIG_SOFT_RESET</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
		<span class="n">tw32_f</span><span class="p">(</span><span class="n">SG_DIG_CTRL</span><span class="p">,</span> <span class="n">expected_sg_dig_ctrl</span><span class="p">);</span>

		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">serdes_counter</span> <span class="o">=</span> <span class="n">SERDES_AN_TIMEOUT_5704S</span><span class="p">;</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">phy_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">TG3_PHYFLG_PARALLEL_DETECT</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">mac_status</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">MAC_STATUS_PCS_SYNCED</span> <span class="o">|</span>
				 <span class="n">MAC_STATUS_SIGNAL_DET</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">sg_dig_status</span> <span class="o">=</span> <span class="n">tr32</span><span class="p">(</span><span class="n">SG_DIG_STATUS</span><span class="p">);</span>
		<span class="n">mac_status</span> <span class="o">=</span> <span class="n">tr32</span><span class="p">(</span><span class="n">MAC_STATUS</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">sg_dig_status</span> <span class="o">&amp;</span> <span class="n">SG_DIG_AUTONEG_COMPLETE</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">mac_status</span> <span class="o">&amp;</span> <span class="n">MAC_STATUS_PCS_SYNCED</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">u32</span> <span class="n">local_adv</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">remote_adv</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">sg_dig_ctrl</span> <span class="o">&amp;</span> <span class="n">SG_DIG_PAUSE_CAP</span><span class="p">)</span>
				<span class="n">local_adv</span> <span class="o">|=</span> <span class="n">ADVERTISE_1000XPAUSE</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">sg_dig_ctrl</span> <span class="o">&amp;</span> <span class="n">SG_DIG_ASYM_PAUSE</span><span class="p">)</span>
				<span class="n">local_adv</span> <span class="o">|=</span> <span class="n">ADVERTISE_1000XPSE_ASYM</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">sg_dig_status</span> <span class="o">&amp;</span> <span class="n">SG_DIG_PARTNER_PAUSE_CAPABLE</span><span class="p">)</span>
				<span class="n">remote_adv</span> <span class="o">|=</span> <span class="n">LPA_1000XPAUSE</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">sg_dig_status</span> <span class="o">&amp;</span> <span class="n">SG_DIG_PARTNER_ASYM_PAUSE</span><span class="p">)</span>
				<span class="n">remote_adv</span> <span class="o">|=</span> <span class="n">LPA_1000XPAUSE_ASYM</span><span class="p">;</span>

			<span class="n">tp</span><span class="o">-&gt;</span><span class="n">link_config</span><span class="p">.</span><span class="n">rmt_adv</span> <span class="o">=</span>
					   <span class="n">mii_adv_to_ethtool_adv_x</span><span class="p">(</span><span class="n">remote_adv</span><span class="p">);</span>

			<span class="n">tg3_setup_flow_control</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">local_adv</span><span class="p">,</span> <span class="n">remote_adv</span><span class="p">);</span>
			<span class="n">current_link_up</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">tp</span><span class="o">-&gt;</span><span class="n">serdes_counter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">tp</span><span class="o">-&gt;</span><span class="n">phy_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">TG3_PHYFLG_PARALLEL_DETECT</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">sg_dig_status</span> <span class="o">&amp;</span> <span class="n">SG_DIG_AUTONEG_COMPLETE</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">serdes_counter</span><span class="p">)</span>
				<span class="n">tp</span><span class="o">-&gt;</span><span class="n">serdes_counter</span><span class="o">--</span><span class="p">;</span>
			<span class="k">else</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">workaround</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">u32</span> <span class="n">val</span> <span class="o">=</span> <span class="n">serdes_cfg</span><span class="p">;</span>

					<span class="k">if</span> <span class="p">(</span><span class="n">port_a</span><span class="p">)</span>
						<span class="n">val</span> <span class="o">|=</span> <span class="mh">0xc010000</span><span class="p">;</span>
					<span class="k">else</span>
						<span class="n">val</span> <span class="o">|=</span> <span class="mh">0x4010000</span><span class="p">;</span>

					<span class="n">tw32_f</span><span class="p">(</span><span class="n">MAC_SERDES_CFG</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
				<span class="p">}</span>

				<span class="n">tw32_f</span><span class="p">(</span><span class="n">SG_DIG_CTRL</span><span class="p">,</span> <span class="n">SG_DIG_COMMON_SETUP</span><span class="p">);</span>
				<span class="n">udelay</span><span class="p">(</span><span class="mi">40</span><span class="p">);</span>

				<span class="cm">/* Link parallel detection - link is up */</span>
				<span class="cm">/* only if we have PCS_SYNC and not */</span>
				<span class="cm">/* receiving config code words */</span>
				<span class="n">mac_status</span> <span class="o">=</span> <span class="n">tr32</span><span class="p">(</span><span class="n">MAC_STATUS</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">mac_status</span> <span class="o">&amp;</span> <span class="n">MAC_STATUS_PCS_SYNCED</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
				    <span class="o">!</span><span class="p">(</span><span class="n">mac_status</span> <span class="o">&amp;</span> <span class="n">MAC_STATUS_RCVD_CFG</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">tg3_setup_flow_control</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
					<span class="n">current_link_up</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
					<span class="n">tp</span><span class="o">-&gt;</span><span class="n">phy_flags</span> <span class="o">|=</span>
						<span class="n">TG3_PHYFLG_PARALLEL_DETECT</span><span class="p">;</span>
					<span class="n">tp</span><span class="o">-&gt;</span><span class="n">serdes_counter</span> <span class="o">=</span>
						<span class="n">SERDES_PARALLEL_DET_TIMEOUT</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span>
					<span class="k">goto</span> <span class="n">restart_autoneg</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">serdes_counter</span> <span class="o">=</span> <span class="n">SERDES_AN_TIMEOUT_5704S</span><span class="p">;</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">phy_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">TG3_PHYFLG_PARALLEL_DETECT</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">current_link_up</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tg3_setup_fiber_by_hand</span><span class="p">(</span><span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span><span class="p">,</span> <span class="n">u32</span> <span class="n">mac_status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">current_link_up</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">mac_status</span> <span class="o">&amp;</span> <span class="n">MAC_STATUS_PCS_SYNCED</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">link_config</span><span class="p">.</span><span class="n">autoneg</span> <span class="o">==</span> <span class="n">AUTONEG_ENABLE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">txflags</span><span class="p">,</span> <span class="n">rxflags</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">fiber_autoneg</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">txflags</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rxflags</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">u32</span> <span class="n">local_adv</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">remote_adv</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">txflags</span> <span class="o">&amp;</span> <span class="n">ANEG_CFG_PS1</span><span class="p">)</span>
				<span class="n">local_adv</span> <span class="o">|=</span> <span class="n">ADVERTISE_1000XPAUSE</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">txflags</span> <span class="o">&amp;</span> <span class="n">ANEG_CFG_PS2</span><span class="p">)</span>
				<span class="n">local_adv</span> <span class="o">|=</span> <span class="n">ADVERTISE_1000XPSE_ASYM</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">rxflags</span> <span class="o">&amp;</span> <span class="n">MR_LP_ADV_SYM_PAUSE</span><span class="p">)</span>
				<span class="n">remote_adv</span> <span class="o">|=</span> <span class="n">LPA_1000XPAUSE</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rxflags</span> <span class="o">&amp;</span> <span class="n">MR_LP_ADV_ASYM_PAUSE</span><span class="p">)</span>
				<span class="n">remote_adv</span> <span class="o">|=</span> <span class="n">LPA_1000XPAUSE_ASYM</span><span class="p">;</span>

			<span class="n">tp</span><span class="o">-&gt;</span><span class="n">link_config</span><span class="p">.</span><span class="n">rmt_adv</span> <span class="o">=</span>
					   <span class="n">mii_adv_to_ethtool_adv_x</span><span class="p">(</span><span class="n">remote_adv</span><span class="p">);</span>

			<span class="n">tg3_setup_flow_control</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">local_adv</span><span class="p">,</span> <span class="n">remote_adv</span><span class="p">);</span>

			<span class="n">current_link_up</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">30</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>
			<span class="n">tw32_f</span><span class="p">(</span><span class="n">MAC_STATUS</span><span class="p">,</span>
			       <span class="p">(</span><span class="n">MAC_STATUS_SYNC_CHANGED</span> <span class="o">|</span>
				<span class="n">MAC_STATUS_CFG_CHANGED</span><span class="p">));</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">40</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">tr32</span><span class="p">(</span><span class="n">MAC_STATUS</span><span class="p">)</span> <span class="o">&amp;</span>
			     <span class="p">(</span><span class="n">MAC_STATUS_SYNC_CHANGED</span> <span class="o">|</span>
			      <span class="n">MAC_STATUS_CFG_CHANGED</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">mac_status</span> <span class="o">=</span> <span class="n">tr32</span><span class="p">(</span><span class="n">MAC_STATUS</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">current_link_up</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">mac_status</span> <span class="o">&amp;</span> <span class="n">MAC_STATUS_PCS_SYNCED</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="o">!</span><span class="p">(</span><span class="n">mac_status</span> <span class="o">&amp;</span> <span class="n">MAC_STATUS_RCVD_CFG</span><span class="p">))</span>
			<span class="n">current_link_up</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">tg3_setup_flow_control</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="cm">/* Forcing 1000FD link up. */</span>
		<span class="n">current_link_up</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="n">tw32_f</span><span class="p">(</span><span class="n">MAC_MODE</span><span class="p">,</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">mac_mode</span> <span class="o">|</span> <span class="n">MAC_MODE_SEND_CONFIGS</span><span class="p">));</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">40</span><span class="p">);</span>

		<span class="n">tw32_f</span><span class="p">(</span><span class="n">MAC_MODE</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">mac_mode</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">40</span><span class="p">);</span>
	<span class="p">}</span>

<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">current_link_up</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tg3_setup_fiber_phy</span><span class="p">(</span><span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">force_reset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">orig_pause_cfg</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">orig_active_speed</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">orig_active_duplex</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">mac_status</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">current_link_up</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">orig_pause_cfg</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">link_config</span><span class="p">.</span><span class="n">active_flowctrl</span><span class="p">;</span>
	<span class="n">orig_active_speed</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">link_config</span><span class="p">.</span><span class="n">active_speed</span><span class="p">;</span>
	<span class="n">orig_active_duplex</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">link_config</span><span class="p">.</span><span class="n">active_duplex</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">HW_AUTONEG</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">netif_carrier_ok</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">INIT_COMPLETE</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">mac_status</span> <span class="o">=</span> <span class="n">tr32</span><span class="p">(</span><span class="n">MAC_STATUS</span><span class="p">);</span>
		<span class="n">mac_status</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="n">MAC_STATUS_PCS_SYNCED</span> <span class="o">|</span>
			       <span class="n">MAC_STATUS_SIGNAL_DET</span> <span class="o">|</span>
			       <span class="n">MAC_STATUS_CFG_CHANGED</span> <span class="o">|</span>
			       <span class="n">MAC_STATUS_RCVD_CFG</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mac_status</span> <span class="o">==</span> <span class="p">(</span><span class="n">MAC_STATUS_PCS_SYNCED</span> <span class="o">|</span>
				   <span class="n">MAC_STATUS_SIGNAL_DET</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">tw32_f</span><span class="p">(</span><span class="n">MAC_STATUS</span><span class="p">,</span> <span class="p">(</span><span class="n">MAC_STATUS_SYNC_CHANGED</span> <span class="o">|</span>
					    <span class="n">MAC_STATUS_CFG_CHANGED</span><span class="p">));</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">tw32_f</span><span class="p">(</span><span class="n">MAC_TX_AUTO_NEG</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">mac_mode</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">MAC_MODE_PORT_MODE_MASK</span> <span class="o">|</span> <span class="n">MAC_MODE_HALF_DUPLEX</span><span class="p">);</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">mac_mode</span> <span class="o">|=</span> <span class="n">MAC_MODE_PORT_MODE_TBI</span><span class="p">;</span>
	<span class="n">tw32_f</span><span class="p">(</span><span class="n">MAC_MODE</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">mac_mode</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">40</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">phy_id</span> <span class="o">==</span> <span class="n">TG3_PHY_ID_BCM8002</span><span class="p">)</span>
		<span class="n">tg3_init_bcm8002</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>

	<span class="cm">/* Enable link change event even when serdes polling.  */</span>
	<span class="n">tw32_f</span><span class="p">(</span><span class="n">MAC_EVENT</span><span class="p">,</span> <span class="n">MAC_EVENT_LNKSTATE_CHANGED</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">40</span><span class="p">);</span>

	<span class="n">current_link_up</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">link_config</span><span class="p">.</span><span class="n">rmt_adv</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mac_status</span> <span class="o">=</span> <span class="n">tr32</span><span class="p">(</span><span class="n">MAC_STATUS</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">HW_AUTONEG</span><span class="p">))</span>
		<span class="n">current_link_up</span> <span class="o">=</span> <span class="n">tg3_setup_fiber_hw_autoneg</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">mac_status</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">current_link_up</span> <span class="o">=</span> <span class="n">tg3_setup_fiber_by_hand</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">mac_status</span><span class="p">);</span>

	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">hw_status</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span>
		<span class="p">(</span><span class="n">SD_STATUS_UPDATED</span> <span class="o">|</span>
		 <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">hw_status</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">SD_STATUS_LINK_CHG</span><span class="p">));</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tw32_f</span><span class="p">(</span><span class="n">MAC_STATUS</span><span class="p">,</span> <span class="p">(</span><span class="n">MAC_STATUS_SYNC_CHANGED</span> <span class="o">|</span>
				    <span class="n">MAC_STATUS_CFG_CHANGED</span><span class="p">));</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">tr32</span><span class="p">(</span><span class="n">MAC_STATUS</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">MAC_STATUS_SYNC_CHANGED</span> <span class="o">|</span>
					 <span class="n">MAC_STATUS_CFG_CHANGED</span> <span class="o">|</span>
					 <span class="n">MAC_STATUS_LNKSTATE_CHANGED</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mac_status</span> <span class="o">=</span> <span class="n">tr32</span><span class="p">(</span><span class="n">MAC_STATUS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">mac_status</span> <span class="o">&amp;</span> <span class="n">MAC_STATUS_PCS_SYNCED</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">current_link_up</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">link_config</span><span class="p">.</span><span class="n">autoneg</span> <span class="o">==</span> <span class="n">AUTONEG_ENABLE</span> <span class="o">&amp;&amp;</span>
		    <span class="n">tp</span><span class="o">-&gt;</span><span class="n">serdes_counter</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">tw32_f</span><span class="p">(</span><span class="n">MAC_MODE</span><span class="p">,</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">mac_mode</span> <span class="o">|</span>
					  <span class="n">MAC_MODE_SEND_CONFIGS</span><span class="p">));</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
			<span class="n">tw32_f</span><span class="p">(</span><span class="n">MAC_MODE</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">mac_mode</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">current_link_up</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">link_config</span><span class="p">.</span><span class="n">active_speed</span> <span class="o">=</span> <span class="n">SPEED_1000</span><span class="p">;</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">link_config</span><span class="p">.</span><span class="n">active_duplex</span> <span class="o">=</span> <span class="n">DUPLEX_FULL</span><span class="p">;</span>
		<span class="n">tw32</span><span class="p">(</span><span class="n">MAC_LED_CTRL</span><span class="p">,</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">led_ctrl</span> <span class="o">|</span>
				    <span class="n">LED_CTRL_LNKLED_OVERRIDE</span> <span class="o">|</span>
				    <span class="n">LED_CTRL_1000MBPS_ON</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">link_config</span><span class="p">.</span><span class="n">active_speed</span> <span class="o">=</span> <span class="n">SPEED_UNKNOWN</span><span class="p">;</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">link_config</span><span class="p">.</span><span class="n">active_duplex</span> <span class="o">=</span> <span class="n">DUPLEX_UNKNOWN</span><span class="p">;</span>
		<span class="n">tw32</span><span class="p">(</span><span class="n">MAC_LED_CTRL</span><span class="p">,</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">led_ctrl</span> <span class="o">|</span>
				    <span class="n">LED_CTRL_LNKLED_OVERRIDE</span> <span class="o">|</span>
				    <span class="n">LED_CTRL_TRAFFIC_OVERRIDE</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">current_link_up</span> <span class="o">!=</span> <span class="n">netif_carrier_ok</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">current_link_up</span><span class="p">)</span>
			<span class="n">netif_carrier_on</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">netif_carrier_off</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">tg3_link_report</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">now_pause_cfg</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">link_config</span><span class="p">.</span><span class="n">active_flowctrl</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">orig_pause_cfg</span> <span class="o">!=</span> <span class="n">now_pause_cfg</span> <span class="o">||</span>
		    <span class="n">orig_active_speed</span> <span class="o">!=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">link_config</span><span class="p">.</span><span class="n">active_speed</span> <span class="o">||</span>
		    <span class="n">orig_active_duplex</span> <span class="o">!=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">link_config</span><span class="p">.</span><span class="n">active_duplex</span><span class="p">)</span>
			<span class="n">tg3_link_report</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tg3_setup_fiber_mii_phy</span><span class="p">(</span><span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">force_reset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">current_link_up</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">bmsr</span><span class="p">,</span> <span class="n">bmcr</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">current_speed</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">current_duplex</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">local_adv</span><span class="p">,</span> <span class="n">remote_adv</span><span class="p">;</span>

	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">mac_mode</span> <span class="o">|=</span> <span class="n">MAC_MODE_PORT_MODE_GMII</span><span class="p">;</span>
	<span class="n">tw32_f</span><span class="p">(</span><span class="n">MAC_MODE</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">mac_mode</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">40</span><span class="p">);</span>

	<span class="n">tw32</span><span class="p">(</span><span class="n">MAC_EVENT</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">tw32_f</span><span class="p">(</span><span class="n">MAC_STATUS</span><span class="p">,</span>
	     <span class="p">(</span><span class="n">MAC_STATUS_SYNC_CHANGED</span> <span class="o">|</span>
	      <span class="n">MAC_STATUS_CFG_CHANGED</span> <span class="o">|</span>
	      <span class="n">MAC_STATUS_MI_COMPLETION</span> <span class="o">|</span>
	      <span class="n">MAC_STATUS_LNKSTATE_CHANGED</span><span class="p">));</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">40</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">force_reset</span><span class="p">)</span>
		<span class="n">tg3_phy_reset</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>

	<span class="n">current_link_up</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">current_speed</span> <span class="o">=</span> <span class="n">SPEED_UNKNOWN</span><span class="p">;</span>
	<span class="n">current_duplex</span> <span class="o">=</span> <span class="n">DUPLEX_UNKNOWN</span><span class="p">;</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">link_config</span><span class="p">.</span><span class="n">rmt_adv</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">|=</span> <span class="n">tg3_readphy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">MII_BMSR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bmsr</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">|=</span> <span class="n">tg3_readphy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">MII_BMSR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bmsr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">ASIC_REV_5714</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tr32</span><span class="p">(</span><span class="n">MAC_TX_STATUS</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">TX_STATUS_LINK_UP</span><span class="p">)</span>
			<span class="n">bmsr</span> <span class="o">|=</span> <span class="n">BMSR_LSTATUS</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">bmsr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">BMSR_LSTATUS</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">|=</span> <span class="n">tg3_readphy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">MII_BMCR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bmcr</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">link_config</span><span class="p">.</span><span class="n">autoneg</span> <span class="o">==</span> <span class="n">AUTONEG_ENABLE</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">force_reset</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">phy_flags</span> <span class="o">&amp;</span> <span class="n">TG3_PHYFLG_PARALLEL_DETECT</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* do nothing, just check for link up at the end */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">link_config</span><span class="p">.</span><span class="n">autoneg</span> <span class="o">==</span> <span class="n">AUTONEG_ENABLE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">adv</span><span class="p">,</span> <span class="n">newadv</span><span class="p">;</span>

		<span class="n">err</span> <span class="o">|=</span> <span class="n">tg3_readphy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">MII_ADVERTISE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adv</span><span class="p">);</span>
		<span class="n">newadv</span> <span class="o">=</span> <span class="n">adv</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">ADVERTISE_1000XFULL</span> <span class="o">|</span> <span class="n">ADVERTISE_1000XHALF</span> <span class="o">|</span>
				 <span class="n">ADVERTISE_1000XPAUSE</span> <span class="o">|</span>
				 <span class="n">ADVERTISE_1000XPSE_ASYM</span> <span class="o">|</span>
				 <span class="n">ADVERTISE_SLCT</span><span class="p">);</span>

		<span class="n">newadv</span> <span class="o">|=</span> <span class="n">tg3_advert_flowctrl_1000X</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">link_config</span><span class="p">.</span><span class="n">flowctrl</span><span class="p">);</span>
		<span class="n">newadv</span> <span class="o">|=</span> <span class="n">ethtool_adv_to_mii_adv_x</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">link_config</span><span class="p">.</span><span class="n">advertising</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">newadv</span> <span class="o">!=</span> <span class="n">adv</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="p">(</span><span class="n">bmcr</span> <span class="o">&amp;</span> <span class="n">BMCR_ANENABLE</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">tg3_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">MII_ADVERTISE</span><span class="p">,</span> <span class="n">newadv</span><span class="p">);</span>
			<span class="n">bmcr</span> <span class="o">|=</span> <span class="n">BMCR_ANENABLE</span> <span class="o">|</span> <span class="n">BMCR_ANRESTART</span><span class="p">;</span>
			<span class="n">tg3_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">MII_BMCR</span><span class="p">,</span> <span class="n">bmcr</span><span class="p">);</span>

			<span class="n">tw32_f</span><span class="p">(</span><span class="n">MAC_EVENT</span><span class="p">,</span> <span class="n">MAC_EVENT_LNKSTATE_CHANGED</span><span class="p">);</span>
			<span class="n">tp</span><span class="o">-&gt;</span><span class="n">serdes_counter</span> <span class="o">=</span> <span class="n">SERDES_AN_TIMEOUT_5714S</span><span class="p">;</span>
			<span class="n">tp</span><span class="o">-&gt;</span><span class="n">phy_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">TG3_PHYFLG_PARALLEL_DETECT</span><span class="p">;</span>

			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">new_bmcr</span><span class="p">;</span>

		<span class="n">bmcr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">BMCR_SPEED1000</span><span class="p">;</span>
		<span class="n">new_bmcr</span> <span class="o">=</span> <span class="n">bmcr</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">BMCR_ANENABLE</span> <span class="o">|</span> <span class="n">BMCR_FULLDPLX</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">link_config</span><span class="p">.</span><span class="n">duplex</span> <span class="o">==</span> <span class="n">DUPLEX_FULL</span><span class="p">)</span>
			<span class="n">new_bmcr</span> <span class="o">|=</span> <span class="n">BMCR_FULLDPLX</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">new_bmcr</span> <span class="o">!=</span> <span class="n">bmcr</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* BMCR_SPEED1000 is a reserved bit that needs</span>
<span class="cm">			 * to be set on write.</span>
<span class="cm">			 */</span>
			<span class="n">new_bmcr</span> <span class="o">|=</span> <span class="n">BMCR_SPEED1000</span><span class="p">;</span>

			<span class="cm">/* Force a linkdown */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">netif_carrier_ok</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">u32</span> <span class="n">adv</span><span class="p">;</span>

				<span class="n">err</span> <span class="o">|=</span> <span class="n">tg3_readphy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">MII_ADVERTISE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adv</span><span class="p">);</span>
				<span class="n">adv</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">ADVERTISE_1000XFULL</span> <span class="o">|</span>
					 <span class="n">ADVERTISE_1000XHALF</span> <span class="o">|</span>
					 <span class="n">ADVERTISE_SLCT</span><span class="p">);</span>
				<span class="n">tg3_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">MII_ADVERTISE</span><span class="p">,</span> <span class="n">adv</span><span class="p">);</span>
				<span class="n">tg3_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">MII_BMCR</span><span class="p">,</span> <span class="n">bmcr</span> <span class="o">|</span>
							   <span class="n">BMCR_ANRESTART</span> <span class="o">|</span>
							   <span class="n">BMCR_ANENABLE</span><span class="p">);</span>
				<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
				<span class="n">netif_carrier_off</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">tg3_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">MII_BMCR</span><span class="p">,</span> <span class="n">new_bmcr</span><span class="p">);</span>
			<span class="n">bmcr</span> <span class="o">=</span> <span class="n">new_bmcr</span><span class="p">;</span>
			<span class="n">err</span> <span class="o">|=</span> <span class="n">tg3_readphy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">MII_BMSR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bmsr</span><span class="p">);</span>
			<span class="n">err</span> <span class="o">|=</span> <span class="n">tg3_readphy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">MII_BMSR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bmsr</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span>
			    <span class="n">ASIC_REV_5714</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">tr32</span><span class="p">(</span><span class="n">MAC_TX_STATUS</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">TX_STATUS_LINK_UP</span><span class="p">)</span>
					<span class="n">bmsr</span> <span class="o">|=</span> <span class="n">BMSR_LSTATUS</span><span class="p">;</span>
				<span class="k">else</span>
					<span class="n">bmsr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">BMSR_LSTATUS</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">tp</span><span class="o">-&gt;</span><span class="n">phy_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">TG3_PHYFLG_PARALLEL_DETECT</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bmsr</span> <span class="o">&amp;</span> <span class="n">BMSR_LSTATUS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">current_speed</span> <span class="o">=</span> <span class="n">SPEED_1000</span><span class="p">;</span>
		<span class="n">current_link_up</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bmcr</span> <span class="o">&amp;</span> <span class="n">BMCR_FULLDPLX</span><span class="p">)</span>
			<span class="n">current_duplex</span> <span class="o">=</span> <span class="n">DUPLEX_FULL</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">current_duplex</span> <span class="o">=</span> <span class="n">DUPLEX_HALF</span><span class="p">;</span>

		<span class="n">local_adv</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">remote_adv</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">bmcr</span> <span class="o">&amp;</span> <span class="n">BMCR_ANENABLE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u32</span> <span class="n">common</span><span class="p">;</span>

			<span class="n">err</span> <span class="o">|=</span> <span class="n">tg3_readphy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">MII_ADVERTISE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">local_adv</span><span class="p">);</span>
			<span class="n">err</span> <span class="o">|=</span> <span class="n">tg3_readphy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">MII_LPA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">remote_adv</span><span class="p">);</span>
			<span class="n">common</span> <span class="o">=</span> <span class="n">local_adv</span> <span class="o">&amp;</span> <span class="n">remote_adv</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">common</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ADVERTISE_1000XHALF</span> <span class="o">|</span>
				      <span class="n">ADVERTISE_1000XFULL</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">common</span> <span class="o">&amp;</span> <span class="n">ADVERTISE_1000XFULL</span><span class="p">)</span>
					<span class="n">current_duplex</span> <span class="o">=</span> <span class="n">DUPLEX_FULL</span><span class="p">;</span>
				<span class="k">else</span>
					<span class="n">current_duplex</span> <span class="o">=</span> <span class="n">DUPLEX_HALF</span><span class="p">;</span>

				<span class="n">tp</span><span class="o">-&gt;</span><span class="n">link_config</span><span class="p">.</span><span class="n">rmt_adv</span> <span class="o">=</span>
					   <span class="n">mii_adv_to_ethtool_adv_x</span><span class="p">(</span><span class="n">remote_adv</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">5780</span><span class="n">_CLASS</span><span class="p">))</span> <span class="p">{</span>
				<span class="cm">/* Link is up via parallel detect */</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">current_link_up</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">current_link_up</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">current_duplex</span> <span class="o">==</span> <span class="n">DUPLEX_FULL</span><span class="p">)</span>
		<span class="n">tg3_setup_flow_control</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">local_adv</span><span class="p">,</span> <span class="n">remote_adv</span><span class="p">);</span>

	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">mac_mode</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MAC_MODE_HALF_DUPLEX</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">link_config</span><span class="p">.</span><span class="n">active_duplex</span> <span class="o">==</span> <span class="n">DUPLEX_HALF</span><span class="p">)</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">mac_mode</span> <span class="o">|=</span> <span class="n">MAC_MODE_HALF_DUPLEX</span><span class="p">;</span>

	<span class="n">tw32_f</span><span class="p">(</span><span class="n">MAC_MODE</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">mac_mode</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">40</span><span class="p">);</span>

	<span class="n">tw32_f</span><span class="p">(</span><span class="n">MAC_EVENT</span><span class="p">,</span> <span class="n">MAC_EVENT_LNKSTATE_CHANGED</span><span class="p">);</span>

	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">link_config</span><span class="p">.</span><span class="n">active_speed</span> <span class="o">=</span> <span class="n">current_speed</span><span class="p">;</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">link_config</span><span class="p">.</span><span class="n">active_duplex</span> <span class="o">=</span> <span class="n">current_duplex</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">current_link_up</span> <span class="o">!=</span> <span class="n">netif_carrier_ok</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">current_link_up</span><span class="p">)</span>
			<span class="n">netif_carrier_on</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">netif_carrier_off</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
			<span class="n">tp</span><span class="o">-&gt;</span><span class="n">phy_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">TG3_PHYFLG_PARALLEL_DETECT</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">tg3_link_report</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tg3_serdes_parallel_detect</span><span class="p">(</span><span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">serdes_counter</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Give autoneg time to complete. */</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">serdes_counter</span><span class="o">--</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">netif_carrier_ok</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">link_config</span><span class="p">.</span><span class="n">autoneg</span> <span class="o">==</span> <span class="n">AUTONEG_ENABLE</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">bmcr</span><span class="p">;</span>

		<span class="n">tg3_readphy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">MII_BMCR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bmcr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bmcr</span> <span class="o">&amp;</span> <span class="n">BMCR_ANENABLE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u32</span> <span class="n">phy1</span><span class="p">,</span> <span class="n">phy2</span><span class="p">;</span>

			<span class="cm">/* Select shadow register 0x1f */</span>
			<span class="n">tg3_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">MII_TG3_MISC_SHDW</span><span class="p">,</span> <span class="mh">0x7c00</span><span class="p">);</span>
			<span class="n">tg3_readphy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">MII_TG3_MISC_SHDW</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">phy1</span><span class="p">);</span>

			<span class="cm">/* Select expansion interrupt status register */</span>
			<span class="n">tg3_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">MII_TG3_DSP_ADDRESS</span><span class="p">,</span>
					 <span class="n">MII_TG3_DSP_EXP1_INT_STAT</span><span class="p">);</span>
			<span class="n">tg3_readphy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">MII_TG3_DSP_RW_PORT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">phy2</span><span class="p">);</span>
			<span class="n">tg3_readphy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">MII_TG3_DSP_RW_PORT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">phy2</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">((</span><span class="n">phy1</span> <span class="o">&amp;</span> <span class="mh">0x10</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">phy2</span> <span class="o">&amp;</span> <span class="mh">0x20</span><span class="p">))</span> <span class="p">{</span>
				<span class="cm">/* We have signal detect and not receiving</span>
<span class="cm">				 * config code words, link is up by parallel</span>
<span class="cm">				 * detection.</span>
<span class="cm">				 */</span>

				<span class="n">bmcr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">BMCR_ANENABLE</span><span class="p">;</span>
				<span class="n">bmcr</span> <span class="o">|=</span> <span class="n">BMCR_SPEED1000</span> <span class="o">|</span> <span class="n">BMCR_FULLDPLX</span><span class="p">;</span>
				<span class="n">tg3_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">MII_BMCR</span><span class="p">,</span> <span class="n">bmcr</span><span class="p">);</span>
				<span class="n">tp</span><span class="o">-&gt;</span><span class="n">phy_flags</span> <span class="o">|=</span> <span class="n">TG3_PHYFLG_PARALLEL_DETECT</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">netif_carrier_ok</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		   <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">link_config</span><span class="p">.</span><span class="n">autoneg</span> <span class="o">==</span> <span class="n">AUTONEG_ENABLE</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		   <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">phy_flags</span> <span class="o">&amp;</span> <span class="n">TG3_PHYFLG_PARALLEL_DETECT</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">phy2</span><span class="p">;</span>

		<span class="cm">/* Select expansion interrupt status register */</span>
		<span class="n">tg3_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">MII_TG3_DSP_ADDRESS</span><span class="p">,</span>
				 <span class="n">MII_TG3_DSP_EXP1_INT_STAT</span><span class="p">);</span>
		<span class="n">tg3_readphy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">MII_TG3_DSP_RW_PORT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">phy2</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">phy2</span> <span class="o">&amp;</span> <span class="mh">0x20</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u32</span> <span class="n">bmcr</span><span class="p">;</span>

			<span class="cm">/* Config code words received, turn on autoneg. */</span>
			<span class="n">tg3_readphy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">MII_BMCR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bmcr</span><span class="p">);</span>
			<span class="n">tg3_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">MII_BMCR</span><span class="p">,</span> <span class="n">bmcr</span> <span class="o">|</span> <span class="n">BMCR_ANENABLE</span><span class="p">);</span>

			<span class="n">tp</span><span class="o">-&gt;</span><span class="n">phy_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">TG3_PHYFLG_PARALLEL_DETECT</span><span class="p">;</span>

		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tg3_setup_phy</span><span class="p">(</span><span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">force_reset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">phy_flags</span> <span class="o">&amp;</span> <span class="n">TG3_PHYFLG_PHY_SERDES</span><span class="p">)</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">tg3_setup_fiber_phy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">force_reset</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">phy_flags</span> <span class="o">&amp;</span> <span class="n">TG3_PHYFLG_MII_SERDES</span><span class="p">)</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">tg3_setup_fiber_mii_phy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">force_reset</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">tg3_setup_copper_phy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">force_reset</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">GET_CHIP_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">CHIPREV_5784_AX</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">scale</span><span class="p">;</span>

		<span class="n">val</span> <span class="o">=</span> <span class="n">tr32</span><span class="p">(</span><span class="n">TG3_CPMU_CLCK_STAT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">CPMU_CLCK_STAT_MAC_CLCK_MASK</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">==</span> <span class="n">CPMU_CLCK_STAT_MAC_CLCK_62_5</span><span class="p">)</span>
			<span class="n">scale</span> <span class="o">=</span> <span class="mi">65</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">==</span> <span class="n">CPMU_CLCK_STAT_MAC_CLCK_6_25</span><span class="p">)</span>
			<span class="n">scale</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">scale</span> <span class="o">=</span> <span class="mi">12</span><span class="p">;</span>

		<span class="n">val</span> <span class="o">=</span> <span class="n">tr32</span><span class="p">(</span><span class="n">GRC_MISC_CFG</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">GRC_MISC_CFG_PRESCALAR_MASK</span><span class="p">;</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="p">(</span><span class="n">scale</span> <span class="o">&lt;&lt;</span> <span class="n">GRC_MISC_CFG_PRESCALAR_SHIFT</span><span class="p">);</span>
		<span class="n">tw32</span><span class="p">(</span><span class="n">GRC_MISC_CFG</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span> <span class="o">&lt;&lt;</span> <span class="n">TX_LENGTHS_IPG_CRS_SHIFT</span><span class="p">)</span> <span class="o">|</span>
	      <span class="p">(</span><span class="mi">6</span> <span class="o">&lt;&lt;</span> <span class="n">TX_LENGTHS_IPG_SHIFT</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">ASIC_REV_5720</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">tr32</span><span class="p">(</span><span class="n">MAC_TX_LENGTHS</span><span class="p">)</span> <span class="o">&amp;</span>
		       <span class="p">(</span><span class="n">TX_LENGTHS_JMB_FRM_LEN_MSK</span> <span class="o">|</span>
			<span class="n">TX_LENGTHS_CNT_DWN_VAL_MSK</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">link_config</span><span class="p">.</span><span class="n">active_speed</span> <span class="o">==</span> <span class="n">SPEED_1000</span> <span class="o">&amp;&amp;</span>
	    <span class="n">tp</span><span class="o">-&gt;</span><span class="n">link_config</span><span class="p">.</span><span class="n">active_duplex</span> <span class="o">==</span> <span class="n">DUPLEX_HALF</span><span class="p">)</span>
		<span class="n">tw32</span><span class="p">(</span><span class="n">MAC_TX_LENGTHS</span><span class="p">,</span> <span class="n">val</span> <span class="o">|</span>
		     <span class="p">(</span><span class="mh">0xff</span> <span class="o">&lt;&lt;</span> <span class="n">TX_LENGTHS_SLOT_TIME_SHIFT</span><span class="p">));</span>
	<span class="k">else</span>
		<span class="n">tw32</span><span class="p">(</span><span class="n">MAC_TX_LENGTHS</span><span class="p">,</span> <span class="n">val</span> <span class="o">|</span>
		     <span class="p">(</span><span class="mi">32</span> <span class="o">&lt;&lt;</span> <span class="n">TX_LENGTHS_SLOT_TIME_SHIFT</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">5705</span><span class="n">_PLUS</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">netif_carrier_ok</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">tw32</span><span class="p">(</span><span class="n">HOSTCC_STAT_COAL_TICKS</span><span class="p">,</span>
			     <span class="n">tp</span><span class="o">-&gt;</span><span class="n">coal</span><span class="p">.</span><span class="n">stats_block_coalesce_usecs</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">tw32</span><span class="p">(</span><span class="n">HOSTCC_STAT_COAL_TICKS</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">ASPM_WORKAROUND</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">tr32</span><span class="p">(</span><span class="n">PCIE_PWR_MGMT_THRESH</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">netif_carrier_ok</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">))</span>
			<span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">PCIE_PWR_MGMT_L1_THRESH_MSK</span><span class="p">)</span> <span class="o">|</span>
			      <span class="n">tp</span><span class="o">-&gt;</span><span class="n">pwrmgmt_thresh</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">val</span> <span class="o">|=</span> <span class="n">PCIE_PWR_MGMT_L1_THRESH_MSK</span><span class="p">;</span>
		<span class="n">tw32</span><span class="p">(</span><span class="n">PCIE_PWR_MGMT_THRESH</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">tg3_irq_sync</span><span class="p">(</span><span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">irq_sync</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">tg3_rd32_loop</span><span class="p">(</span><span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">dst</span><span class="p">,</span> <span class="n">u32</span> <span class="n">off</span><span class="p">,</span> <span class="n">u32</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">dst</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">dst</span> <span class="o">+</span> <span class="n">off</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">))</span>
		<span class="o">*</span><span class="n">dst</span><span class="o">++</span> <span class="o">=</span> <span class="n">tr32</span><span class="p">(</span><span class="n">off</span> <span class="o">+</span> <span class="n">i</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tg3_dump_legacy_regs</span><span class="p">(</span><span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">regs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">tg3_rd32_loop</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">regs</span><span class="p">,</span> <span class="n">TG3PCI_VENDOR</span><span class="p">,</span> <span class="mh">0xb0</span><span class="p">);</span>
	<span class="n">tg3_rd32_loop</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">regs</span><span class="p">,</span> <span class="n">MAILBOX_INTERRUPT_0</span><span class="p">,</span> <span class="mh">0x200</span><span class="p">);</span>
	<span class="n">tg3_rd32_loop</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">regs</span><span class="p">,</span> <span class="n">MAC_MODE</span><span class="p">,</span> <span class="mh">0x4f0</span><span class="p">);</span>
	<span class="n">tg3_rd32_loop</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">regs</span><span class="p">,</span> <span class="n">SNDDATAI_MODE</span><span class="p">,</span> <span class="mh">0xe0</span><span class="p">);</span>
	<span class="n">tg3_rd32_loop</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">regs</span><span class="p">,</span> <span class="n">SNDDATAC_MODE</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">);</span>
	<span class="n">tg3_rd32_loop</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">regs</span><span class="p">,</span> <span class="n">SNDBDS_MODE</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">);</span>
	<span class="n">tg3_rd32_loop</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">regs</span><span class="p">,</span> <span class="n">SNDBDI_MODE</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">);</span>
	<span class="n">tg3_rd32_loop</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">regs</span><span class="p">,</span> <span class="n">SNDBDC_MODE</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">);</span>
	<span class="n">tg3_rd32_loop</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">regs</span><span class="p">,</span> <span class="n">RCVLPC_MODE</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">);</span>
	<span class="n">tg3_rd32_loop</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">regs</span><span class="p">,</span> <span class="n">RCVLPC_SELLST_BASE</span><span class="p">,</span> <span class="mh">0x15c</span><span class="p">);</span>
	<span class="n">tg3_rd32_loop</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">regs</span><span class="p">,</span> <span class="n">RCVDBDI_MODE</span><span class="p">,</span> <span class="mh">0x0c</span><span class="p">);</span>
	<span class="n">tg3_rd32_loop</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">regs</span><span class="p">,</span> <span class="n">RCVDBDI_JUMBO_BD</span><span class="p">,</span> <span class="mh">0x3c</span><span class="p">);</span>
	<span class="n">tg3_rd32_loop</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">regs</span><span class="p">,</span> <span class="n">RCVDBDI_BD_PROD_IDX_0</span><span class="p">,</span> <span class="mh">0x44</span><span class="p">);</span>
	<span class="n">tg3_rd32_loop</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">regs</span><span class="p">,</span> <span class="n">RCVDCC_MODE</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">);</span>
	<span class="n">tg3_rd32_loop</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">regs</span><span class="p">,</span> <span class="n">RCVBDI_MODE</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">);</span>
	<span class="n">tg3_rd32_loop</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">regs</span><span class="p">,</span> <span class="n">RCVCC_MODE</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">);</span>
	<span class="n">tg3_rd32_loop</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">regs</span><span class="p">,</span> <span class="n">RCVLSC_MODE</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">);</span>
	<span class="n">tg3_rd32_loop</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">regs</span><span class="p">,</span> <span class="n">MBFREE_MODE</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">);</span>
	<span class="n">tg3_rd32_loop</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">regs</span><span class="p">,</span> <span class="n">HOSTCC_MODE</span><span class="p">,</span> <span class="mh">0x100</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">SUPPORT_MSIX</span><span class="p">))</span>
		<span class="n">tg3_rd32_loop</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">regs</span><span class="p">,</span> <span class="n">HOSTCC_RXCOL_TICKS_VEC1</span><span class="p">,</span> <span class="mh">0x180</span><span class="p">);</span>

	<span class="n">tg3_rd32_loop</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">regs</span><span class="p">,</span> <span class="n">MEMARB_MODE</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">);</span>
	<span class="n">tg3_rd32_loop</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">regs</span><span class="p">,</span> <span class="n">BUFMGR_MODE</span><span class="p">,</span> <span class="mh">0x58</span><span class="p">);</span>
	<span class="n">tg3_rd32_loop</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">regs</span><span class="p">,</span> <span class="n">RDMAC_MODE</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">);</span>
	<span class="n">tg3_rd32_loop</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">regs</span><span class="p">,</span> <span class="n">WDMAC_MODE</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">);</span>
	<span class="n">tg3_rd32_loop</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">regs</span><span class="p">,</span> <span class="n">RX_CPU_MODE</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">);</span>
	<span class="n">tg3_rd32_loop</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">regs</span><span class="p">,</span> <span class="n">RX_CPU_STATE</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">);</span>
	<span class="n">tg3_rd32_loop</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">regs</span><span class="p">,</span> <span class="n">RX_CPU_PGMCTR</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">);</span>
	<span class="n">tg3_rd32_loop</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">regs</span><span class="p">,</span> <span class="n">RX_CPU_HWBKPT</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">5705</span><span class="n">_PLUS</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">tg3_rd32_loop</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">regs</span><span class="p">,</span> <span class="n">TX_CPU_MODE</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">);</span>
		<span class="n">tg3_rd32_loop</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">regs</span><span class="p">,</span> <span class="n">TX_CPU_STATE</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">);</span>
		<span class="n">tg3_rd32_loop</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">regs</span><span class="p">,</span> <span class="n">TX_CPU_PGMCTR</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">tg3_rd32_loop</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">regs</span><span class="p">,</span> <span class="n">GRCMBOX_INTERRUPT_0</span><span class="p">,</span> <span class="mh">0x110</span><span class="p">);</span>
	<span class="n">tg3_rd32_loop</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">regs</span><span class="p">,</span> <span class="n">FTQ_RESET</span><span class="p">,</span> <span class="mh">0x120</span><span class="p">);</span>
	<span class="n">tg3_rd32_loop</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">regs</span><span class="p">,</span> <span class="n">MSGINT_MODE</span><span class="p">,</span> <span class="mh">0x0c</span><span class="p">);</span>
	<span class="n">tg3_rd32_loop</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">regs</span><span class="p">,</span> <span class="n">DMAC_MODE</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">);</span>
	<span class="n">tg3_rd32_loop</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">regs</span><span class="p">,</span> <span class="n">GRC_MODE</span><span class="p">,</span> <span class="mh">0x4c</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">NVRAM</span><span class="p">))</span>
		<span class="n">tg3_rd32_loop</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">regs</span><span class="p">,</span> <span class="n">NVRAM_CMD</span><span class="p">,</span> <span class="mh">0x24</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tg3_dump_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">regs</span><span class="p">;</span>

	<span class="n">regs</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">TG3_REG_BLK_SIZE</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">regs</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netdev_err</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Failed allocating register dump buffer</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">PCI_EXPRESS</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Read up to but not including private PCI registers */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">TG3_PCIE_TLDLPL_PORT</span><span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">))</span>
			<span class="n">regs</span><span class="p">[</span><span class="n">i</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">)]</span> <span class="o">=</span> <span class="n">tr32</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">tg3_dump_legacy_regs</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">regs</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">TG3_REG_BLK_SIZE</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">);</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">regs</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">0</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">regs</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&amp;&amp;</span>
		    <span class="o">!</span><span class="n">regs</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">regs</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">3</span><span class="p">])</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">netdev_err</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;0x%08x: 0x%08x, 0x%08x, 0x%08x, 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">i</span> <span class="o">*</span> <span class="mi">4</span><span class="p">,</span>
			   <span class="n">regs</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">0</span><span class="p">],</span> <span class="n">regs</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span> <span class="n">regs</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">],</span> <span class="n">regs</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">3</span><span class="p">]);</span>
	<span class="p">}</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">regs</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">irq_cnt</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">tg3_napi</span> <span class="o">*</span><span class="n">tnapi</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="cm">/* SW status block */</span>
		<span class="n">netdev_err</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			 <span class="s">&quot;%d: Host status block [%08x:%08x:(%04x:%04x:%04x):(%04x:%04x)]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">i</span><span class="p">,</span>
			   <span class="n">tnapi</span><span class="o">-&gt;</span><span class="n">hw_status</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">,</span>
			   <span class="n">tnapi</span><span class="o">-&gt;</span><span class="n">hw_status</span><span class="o">-&gt;</span><span class="n">status_tag</span><span class="p">,</span>
			   <span class="n">tnapi</span><span class="o">-&gt;</span><span class="n">hw_status</span><span class="o">-&gt;</span><span class="n">rx_jumbo_consumer</span><span class="p">,</span>
			   <span class="n">tnapi</span><span class="o">-&gt;</span><span class="n">hw_status</span><span class="o">-&gt;</span><span class="n">rx_consumer</span><span class="p">,</span>
			   <span class="n">tnapi</span><span class="o">-&gt;</span><span class="n">hw_status</span><span class="o">-&gt;</span><span class="n">rx_mini_consumer</span><span class="p">,</span>
			   <span class="n">tnapi</span><span class="o">-&gt;</span><span class="n">hw_status</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">rx_producer</span><span class="p">,</span>
			   <span class="n">tnapi</span><span class="o">-&gt;</span><span class="n">hw_status</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">tx_consumer</span><span class="p">);</span>

		<span class="n">netdev_err</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
		<span class="s">&quot;%d: NAPI info [%08x:%08x:(%04x:%04x:%04x):%04x:(%04x:%04x:%04x:%04x)]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">i</span><span class="p">,</span>
			   <span class="n">tnapi</span><span class="o">-&gt;</span><span class="n">last_tag</span><span class="p">,</span> <span class="n">tnapi</span><span class="o">-&gt;</span><span class="n">last_irq_tag</span><span class="p">,</span>
			   <span class="n">tnapi</span><span class="o">-&gt;</span><span class="n">tx_prod</span><span class="p">,</span> <span class="n">tnapi</span><span class="o">-&gt;</span><span class="n">tx_cons</span><span class="p">,</span> <span class="n">tnapi</span><span class="o">-&gt;</span><span class="n">tx_pending</span><span class="p">,</span>
			   <span class="n">tnapi</span><span class="o">-&gt;</span><span class="n">rx_rcb_ptr</span><span class="p">,</span>
			   <span class="n">tnapi</span><span class="o">-&gt;</span><span class="n">prodring</span><span class="p">.</span><span class="n">rx_std_prod_idx</span><span class="p">,</span>
			   <span class="n">tnapi</span><span class="o">-&gt;</span><span class="n">prodring</span><span class="p">.</span><span class="n">rx_std_cons_idx</span><span class="p">,</span>
			   <span class="n">tnapi</span><span class="o">-&gt;</span><span class="n">prodring</span><span class="p">.</span><span class="n">rx_jmb_prod_idx</span><span class="p">,</span>
			   <span class="n">tnapi</span><span class="o">-&gt;</span><span class="n">prodring</span><span class="p">.</span><span class="n">rx_jmb_cons_idx</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* This is called whenever we suspect that the system chipset is re-</span>
<span class="cm"> * ordering the sequence of MMIO to the tx send mailbox. The symptom</span>
<span class="cm"> * is bogus tx completions. We try to recover by setting the</span>
<span class="cm"> * TG3_FLAG_MBOX_WRITE_REORDER flag and resetting the chip later</span>
<span class="cm"> * in the workqueue.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">tg3_tx_recover</span><span class="p">(</span><span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">MBOX_WRITE_REORDER</span><span class="p">)</span> <span class="o">||</span>
	       <span class="n">tp</span><span class="o">-&gt;</span><span class="n">write32_tx_mbox</span> <span class="o">==</span> <span class="n">tg3_write_indirect_mbox</span><span class="p">);</span>

	<span class="n">netdev_warn</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
		    <span class="s">&quot;The system may be re-ordering memory-mapped I/O &quot;</span>
		    <span class="s">&quot;cycles to the network device, attempting to recover. &quot;</span>
		    <span class="s">&quot;Please report the problem to the driver maintainer &quot;</span>
		    <span class="s">&quot;and include system chipset information.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">tg3_flag_set</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">TX_RECOVERY_PENDING</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u32</span> <span class="nf">tg3_tx_avail</span><span class="p">(</span><span class="k">struct</span> <span class="n">tg3_napi</span> <span class="o">*</span><span class="n">tnapi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Tell compiler to fetch tx indices from memory. */</span>
	<span class="n">barrier</span><span class="p">();</span>
	<span class="k">return</span> <span class="n">tnapi</span><span class="o">-&gt;</span><span class="n">tx_pending</span> <span class="o">-</span>
	       <span class="p">((</span><span class="n">tnapi</span><span class="o">-&gt;</span><span class="n">tx_prod</span> <span class="o">-</span> <span class="n">tnapi</span><span class="o">-&gt;</span><span class="n">tx_cons</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">TG3_TX_RING_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/* Tigon3 never reports partial packet sends.  So we do not</span>
<span class="cm"> * need special logic to handle SKBs that have not had all</span>
<span class="cm"> * of their frags sent yet, like SunGEM does.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">tg3_tx</span><span class="p">(</span><span class="k">struct</span> <span class="n">tg3_napi</span> <span class="o">*</span><span class="n">tnapi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="n">tnapi</span><span class="o">-&gt;</span><span class="n">tp</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">hw_idx</span> <span class="o">=</span> <span class="n">tnapi</span><span class="o">-&gt;</span><span class="n">hw_status</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">tx_consumer</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">sw_idx</span> <span class="o">=</span> <span class="n">tnapi</span><span class="o">-&gt;</span><span class="n">tx_cons</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">netdev_queue</span> <span class="o">*</span><span class="n">txq</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="n">tnapi</span> <span class="o">-</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pkts_compl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">bytes_compl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">ENABLE_TSS</span><span class="p">))</span>
		<span class="n">index</span><span class="o">--</span><span class="p">;</span>

	<span class="n">txq</span> <span class="o">=</span> <span class="n">netdev_get_tx_queue</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">index</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">sw_idx</span> <span class="o">!=</span> <span class="n">hw_idx</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">tg3_tx_ring_info</span> <span class="o">*</span><span class="n">ri</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tnapi</span><span class="o">-&gt;</span><span class="n">tx_buffers</span><span class="p">[</span><span class="n">sw_idx</span><span class="p">];</span>
		<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="n">ri</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">tx_bug</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">skb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">tg3_tx_recover</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">pci_unmap_single</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span>
				 <span class="n">dma_unmap_addr</span><span class="p">(</span><span class="n">ri</span><span class="p">,</span> <span class="n">mapping</span><span class="p">),</span>
				 <span class="n">skb_headlen</span><span class="p">(</span><span class="n">skb</span><span class="p">),</span>
				 <span class="n">PCI_DMA_TODEVICE</span><span class="p">);</span>

		<span class="n">ri</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

		<span class="k">while</span> <span class="p">(</span><span class="n">ri</span><span class="o">-&gt;</span><span class="n">fragmented</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ri</span><span class="o">-&gt;</span><span class="n">fragmented</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
			<span class="n">sw_idx</span> <span class="o">=</span> <span class="n">NEXT_TX</span><span class="p">(</span><span class="n">sw_idx</span><span class="p">);</span>
			<span class="n">ri</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tnapi</span><span class="o">-&gt;</span><span class="n">tx_buffers</span><span class="p">[</span><span class="n">sw_idx</span><span class="p">];</span>
		<span class="p">}</span>

		<span class="n">sw_idx</span> <span class="o">=</span> <span class="n">NEXT_TX</span><span class="p">(</span><span class="n">sw_idx</span><span class="p">);</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">nr_frags</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ri</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tnapi</span><span class="o">-&gt;</span><span class="n">tx_buffers</span><span class="p">[</span><span class="n">sw_idx</span><span class="p">];</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">ri</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">!=</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">sw_idx</span> <span class="o">==</span> <span class="n">hw_idx</span><span class="p">))</span>
				<span class="n">tx_bug</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

			<span class="n">pci_unmap_page</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span>
				       <span class="n">dma_unmap_addr</span><span class="p">(</span><span class="n">ri</span><span class="p">,</span> <span class="n">mapping</span><span class="p">),</span>
				       <span class="n">skb_frag_size</span><span class="p">(</span><span class="o">&amp;</span><span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">frags</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span>
				       <span class="n">PCI_DMA_TODEVICE</span><span class="p">);</span>

			<span class="k">while</span> <span class="p">(</span><span class="n">ri</span><span class="o">-&gt;</span><span class="n">fragmented</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ri</span><span class="o">-&gt;</span><span class="n">fragmented</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
				<span class="n">sw_idx</span> <span class="o">=</span> <span class="n">NEXT_TX</span><span class="p">(</span><span class="n">sw_idx</span><span class="p">);</span>
				<span class="n">ri</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tnapi</span><span class="o">-&gt;</span><span class="n">tx_buffers</span><span class="p">[</span><span class="n">sw_idx</span><span class="p">];</span>
			<span class="p">}</span>

			<span class="n">sw_idx</span> <span class="o">=</span> <span class="n">NEXT_TX</span><span class="p">(</span><span class="n">sw_idx</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">pkts_compl</span><span class="o">++</span><span class="p">;</span>
		<span class="n">bytes_compl</span> <span class="o">+=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>

		<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">tx_bug</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">tg3_tx_recover</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">netdev_tx_completed_queue</span><span class="p">(</span><span class="n">txq</span><span class="p">,</span> <span class="n">pkts_compl</span><span class="p">,</span> <span class="n">bytes_compl</span><span class="p">);</span>

	<span class="n">tnapi</span><span class="o">-&gt;</span><span class="n">tx_cons</span> <span class="o">=</span> <span class="n">sw_idx</span><span class="p">;</span>

	<span class="cm">/* Need to make the tx_cons update visible to tg3_start_xmit()</span>
<span class="cm">	 * before checking for netif_queue_stopped().  Without the</span>
<span class="cm">	 * memory barrier, there is a small possibility that tg3_start_xmit()</span>
<span class="cm">	 * will miss it and cause the queue to be stopped forever.</span>
<span class="cm">	 */</span>
	<span class="n">smp_mb</span><span class="p">();</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">netif_tx_queue_stopped</span><span class="p">(</span><span class="n">txq</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		     <span class="p">(</span><span class="n">tg3_tx_avail</span><span class="p">(</span><span class="n">tnapi</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">TG3_TX_WAKEUP_THRESH</span><span class="p">(</span><span class="n">tnapi</span><span class="p">))))</span> <span class="p">{</span>
		<span class="n">__netif_tx_lock</span><span class="p">(</span><span class="n">txq</span><span class="p">,</span> <span class="n">smp_processor_id</span><span class="p">());</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">netif_tx_queue_stopped</span><span class="p">(</span><span class="n">txq</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">tg3_tx_avail</span><span class="p">(</span><span class="n">tnapi</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">TG3_TX_WAKEUP_THRESH</span><span class="p">(</span><span class="n">tnapi</span><span class="p">)))</span>
			<span class="n">netif_tx_wake_queue</span><span class="p">(</span><span class="n">txq</span><span class="p">);</span>
		<span class="n">__netif_tx_unlock</span><span class="p">(</span><span class="n">txq</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tg3_frag_free</span><span class="p">(</span><span class="n">bool</span> <span class="n">is_frag</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is_frag</span><span class="p">)</span>
		<span class="n">put_page</span><span class="p">(</span><span class="n">virt_to_head_page</span><span class="p">(</span><span class="n">data</span><span class="p">));</span>
	<span class="k">else</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tg3_rx_data_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ring_info</span> <span class="o">*</span><span class="n">ri</span><span class="p">,</span> <span class="n">u32</span> <span class="n">map_sz</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">skb_size</span> <span class="o">=</span> <span class="n">SKB_DATA_ALIGN</span><span class="p">(</span><span class="n">map_sz</span> <span class="o">+</span> <span class="n">TG3_RX_OFFSET</span><span class="p">(</span><span class="n">tp</span><span class="p">))</span> <span class="o">+</span>
		   <span class="n">SKB_DATA_ALIGN</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">skb_shared_info</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ri</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">pci_unmap_single</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">dma_unmap_addr</span><span class="p">(</span><span class="n">ri</span><span class="p">,</span> <span class="n">mapping</span><span class="p">),</span>
			 <span class="n">map_sz</span><span class="p">,</span> <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>
	<span class="n">tg3_frag_free</span><span class="p">(</span><span class="n">skb_size</span> <span class="o">&lt;=</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="n">ri</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
	<span class="n">ri</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* Returns size of skb allocated or &lt; 0 on error.</span>
<span class="cm"> *</span>
<span class="cm"> * We only need to fill in the address because the other members</span>
<span class="cm"> * of the RX descriptor are invariant, see tg3_init_rings.</span>
<span class="cm"> *</span>
<span class="cm"> * Note the purposeful assymetry of cpu vs. chip accesses.  For</span>
<span class="cm"> * posting buffers we only dirty the first cache line of the RX</span>
<span class="cm"> * descriptor (containing the address).  Whereas for the RX status</span>
<span class="cm"> * buffers the cpu only reads the last cacheline of the RX descriptor</span>
<span class="cm"> * (to fetch the error flags, vlan tag, checksum, and opaque cookie).</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">tg3_alloc_rx_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">tg3_rx_prodring_set</span> <span class="o">*</span><span class="n">tpr</span><span class="p">,</span>
			     <span class="n">u32</span> <span class="n">opaque_key</span><span class="p">,</span> <span class="n">u32</span> <span class="n">dest_idx_unmasked</span><span class="p">,</span>
			     <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">frag_size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tg3_rx_buffer_desc</span> <span class="o">*</span><span class="n">desc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ring_info</span> <span class="o">*</span><span class="n">map</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">mapping</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">skb_size</span><span class="p">,</span> <span class="n">data_size</span><span class="p">,</span> <span class="n">dest_idx</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">opaque_key</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">RXD_OPAQUE_RING_STD</span>:
		<span class="n">dest_idx</span> <span class="o">=</span> <span class="n">dest_idx_unmasked</span> <span class="o">&amp;</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">rx_std_ring_mask</span><span class="p">;</span>
		<span class="n">desc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tpr</span><span class="o">-&gt;</span><span class="n">rx_std</span><span class="p">[</span><span class="n">dest_idx</span><span class="p">];</span>
		<span class="n">map</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tpr</span><span class="o">-&gt;</span><span class="n">rx_std_buffers</span><span class="p">[</span><span class="n">dest_idx</span><span class="p">];</span>
		<span class="n">data_size</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">rx_pkt_map_sz</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">RXD_OPAQUE_RING_JUMBO</span>:
		<span class="n">dest_idx</span> <span class="o">=</span> <span class="n">dest_idx_unmasked</span> <span class="o">&amp;</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">rx_jmb_ring_mask</span><span class="p">;</span>
		<span class="n">desc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tpr</span><span class="o">-&gt;</span><span class="n">rx_jmb</span><span class="p">[</span><span class="n">dest_idx</span><span class="p">].</span><span class="n">std</span><span class="p">;</span>
		<span class="n">map</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tpr</span><span class="o">-&gt;</span><span class="n">rx_jmb_buffers</span><span class="p">[</span><span class="n">dest_idx</span><span class="p">];</span>
		<span class="n">data_size</span> <span class="o">=</span> <span class="n">TG3_RX_JMB_MAP_SZ</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Do not overwrite any of the map or rp information</span>
<span class="cm">	 * until we are sure we can commit to a new buffer.</span>
<span class="cm">	 *</span>
<span class="cm">	 * Callers depend upon this behavior and assume that</span>
<span class="cm">	 * we leave everything unchanged if we fail.</span>
<span class="cm">	 */</span>
	<span class="n">skb_size</span> <span class="o">=</span> <span class="n">SKB_DATA_ALIGN</span><span class="p">(</span><span class="n">data_size</span> <span class="o">+</span> <span class="n">TG3_RX_OFFSET</span><span class="p">(</span><span class="n">tp</span><span class="p">))</span> <span class="o">+</span>
		   <span class="n">SKB_DATA_ALIGN</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">skb_shared_info</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">skb_size</span> <span class="o">&lt;=</span> <span class="n">PAGE_SIZE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">data</span> <span class="o">=</span> <span class="n">netdev_alloc_frag</span><span class="p">(</span><span class="n">skb_size</span><span class="p">);</span>
		<span class="o">*</span><span class="n">frag_size</span> <span class="o">=</span> <span class="n">skb_size</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">data</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">skb_size</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
		<span class="o">*</span><span class="n">frag_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">data</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">mapping</span> <span class="o">=</span> <span class="n">pci_map_single</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span>
				 <span class="n">data</span> <span class="o">+</span> <span class="n">TG3_RX_OFFSET</span><span class="p">(</span><span class="n">tp</span><span class="p">),</span>
				 <span class="n">data_size</span><span class="p">,</span>
				 <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">pci_dma_mapping_error</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">mapping</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">tg3_frag_free</span><span class="p">(</span><span class="n">skb_size</span> <span class="o">&lt;=</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">map</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="n">dma_unmap_addr_set</span><span class="p">(</span><span class="n">map</span><span class="p">,</span> <span class="n">mapping</span><span class="p">,</span> <span class="n">mapping</span><span class="p">);</span>

	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">addr_hi</span> <span class="o">=</span> <span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="n">mapping</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">);</span>
	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">addr_lo</span> <span class="o">=</span> <span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="n">mapping</span> <span class="o">&amp;</span> <span class="mh">0xffffffff</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">data_size</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* We only need to move over in the address because the other</span>
<span class="cm"> * members of the RX descriptor are invariant.  See notes above</span>
<span class="cm"> * tg3_alloc_rx_data for full details.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">tg3_recycle_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">tg3_napi</span> <span class="o">*</span><span class="n">tnapi</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">tg3_rx_prodring_set</span> <span class="o">*</span><span class="n">dpr</span><span class="p">,</span>
			   <span class="n">u32</span> <span class="n">opaque_key</span><span class="p">,</span> <span class="kt">int</span> <span class="n">src_idx</span><span class="p">,</span>
			   <span class="n">u32</span> <span class="n">dest_idx_unmasked</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="n">tnapi</span><span class="o">-&gt;</span><span class="n">tp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tg3_rx_buffer_desc</span> <span class="o">*</span><span class="n">src_desc</span><span class="p">,</span> <span class="o">*</span><span class="n">dest_desc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ring_info</span> <span class="o">*</span><span class="n">src_map</span><span class="p">,</span> <span class="o">*</span><span class="n">dest_map</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tg3_rx_prodring_set</span> <span class="o">*</span><span class="n">spr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">prodring</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">dest_idx</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">opaque_key</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">RXD_OPAQUE_RING_STD</span>:
		<span class="n">dest_idx</span> <span class="o">=</span> <span class="n">dest_idx_unmasked</span> <span class="o">&amp;</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">rx_std_ring_mask</span><span class="p">;</span>
		<span class="n">dest_desc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dpr</span><span class="o">-&gt;</span><span class="n">rx_std</span><span class="p">[</span><span class="n">dest_idx</span><span class="p">];</span>
		<span class="n">dest_map</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dpr</span><span class="o">-&gt;</span><span class="n">rx_std_buffers</span><span class="p">[</span><span class="n">dest_idx</span><span class="p">];</span>
		<span class="n">src_desc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">spr</span><span class="o">-&gt;</span><span class="n">rx_std</span><span class="p">[</span><span class="n">src_idx</span><span class="p">];</span>
		<span class="n">src_map</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">spr</span><span class="o">-&gt;</span><span class="n">rx_std_buffers</span><span class="p">[</span><span class="n">src_idx</span><span class="p">];</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">RXD_OPAQUE_RING_JUMBO</span>:
		<span class="n">dest_idx</span> <span class="o">=</span> <span class="n">dest_idx_unmasked</span> <span class="o">&amp;</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">rx_jmb_ring_mask</span><span class="p">;</span>
		<span class="n">dest_desc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dpr</span><span class="o">-&gt;</span><span class="n">rx_jmb</span><span class="p">[</span><span class="n">dest_idx</span><span class="p">].</span><span class="n">std</span><span class="p">;</span>
		<span class="n">dest_map</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dpr</span><span class="o">-&gt;</span><span class="n">rx_jmb_buffers</span><span class="p">[</span><span class="n">dest_idx</span><span class="p">];</span>
		<span class="n">src_desc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">spr</span><span class="o">-&gt;</span><span class="n">rx_jmb</span><span class="p">[</span><span class="n">src_idx</span><span class="p">].</span><span class="n">std</span><span class="p">;</span>
		<span class="n">src_map</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">spr</span><span class="o">-&gt;</span><span class="n">rx_jmb_buffers</span><span class="p">[</span><span class="n">src_idx</span><span class="p">];</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dest_map</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">=</span> <span class="n">src_map</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">dma_unmap_addr_set</span><span class="p">(</span><span class="n">dest_map</span><span class="p">,</span> <span class="n">mapping</span><span class="p">,</span>
			   <span class="n">dma_unmap_addr</span><span class="p">(</span><span class="n">src_map</span><span class="p">,</span> <span class="n">mapping</span><span class="p">));</span>
	<span class="n">dest_desc</span><span class="o">-&gt;</span><span class="n">addr_hi</span> <span class="o">=</span> <span class="n">src_desc</span><span class="o">-&gt;</span><span class="n">addr_hi</span><span class="p">;</span>
	<span class="n">dest_desc</span><span class="o">-&gt;</span><span class="n">addr_lo</span> <span class="o">=</span> <span class="n">src_desc</span><span class="o">-&gt;</span><span class="n">addr_lo</span><span class="p">;</span>

	<span class="cm">/* Ensure that the update to the skb happens after the physical</span>
<span class="cm">	 * addresses have been transferred to the new BD location.</span>
<span class="cm">	 */</span>
	<span class="n">smp_wmb</span><span class="p">();</span>

	<span class="n">src_map</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* The RX ring scheme is composed of multiple rings which post fresh</span>
<span class="cm"> * buffers to the chip, and one special ring the chip uses to report</span>
<span class="cm"> * status back to the host.</span>
<span class="cm"> *</span>
<span class="cm"> * The special ring reports the status of received packets to the</span>
<span class="cm"> * host.  The chip does not write into the original descriptor the</span>
<span class="cm"> * RX buffer was obtained from.  The chip simply takes the original</span>
<span class="cm"> * descriptor as provided by the host, updates the status and length</span>
<span class="cm"> * field, then writes this into the next status ring entry.</span>
<span class="cm"> *</span>
<span class="cm"> * Each ring the host uses to post buffers to the chip is described</span>
<span class="cm"> * by a TG3_BDINFO entry in the chips SRAM area.  When a packet arrives,</span>
<span class="cm"> * it is first placed into the on-chip ram.  When the packet&#39;s length</span>
<span class="cm"> * is known, it walks down the TG3_BDINFO entries to select the ring.</span>
<span class="cm"> * Each TG3_BDINFO specifies a MAXLEN field and the first TG3_BDINFO</span>
<span class="cm"> * which is within the range of the new packet&#39;s length is chosen.</span>
<span class="cm"> *</span>
<span class="cm"> * The &quot;separate ring for rx status&quot; scheme may sound queer, but it makes</span>
<span class="cm"> * sense from a cache coherency perspective.  If only the host writes</span>
<span class="cm"> * to the buffer post rings, and only the chip writes to the rx status</span>
<span class="cm"> * rings, then cache lines never move beyond shared-modified state.</span>
<span class="cm"> * If both the host and chip were to write into the same ring, cache line</span>
<span class="cm"> * eviction could occur since both entities want it in an exclusive state.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">tg3_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">tg3_napi</span> <span class="o">*</span><span class="n">tnapi</span><span class="p">,</span> <span class="kt">int</span> <span class="n">budget</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="n">tnapi</span><span class="o">-&gt;</span><span class="n">tp</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">work_mask</span><span class="p">,</span> <span class="n">rx_std_posted</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">std_prod_idx</span><span class="p">,</span> <span class="n">jmb_prod_idx</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">sw_idx</span> <span class="o">=</span> <span class="n">tnapi</span><span class="o">-&gt;</span><span class="n">rx_rcb_ptr</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">hw_idx</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">received</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tg3_rx_prodring_set</span> <span class="o">*</span><span class="n">tpr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tnapi</span><span class="o">-&gt;</span><span class="n">prodring</span><span class="p">;</span>

	<span class="n">hw_idx</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">tnapi</span><span class="o">-&gt;</span><span class="n">rx_rcb_prod_idx</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * We need to order the read of hw_idx and the read of</span>
<span class="cm">	 * the opaque cookie.</span>
<span class="cm">	 */</span>
	<span class="n">rmb</span><span class="p">();</span>
	<span class="n">work_mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">received</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">std_prod_idx</span> <span class="o">=</span> <span class="n">tpr</span><span class="o">-&gt;</span><span class="n">rx_std_prod_idx</span><span class="p">;</span>
	<span class="n">jmb_prod_idx</span> <span class="o">=</span> <span class="n">tpr</span><span class="o">-&gt;</span><span class="n">rx_jmb_prod_idx</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">sw_idx</span> <span class="o">!=</span> <span class="n">hw_idx</span> <span class="o">&amp;&amp;</span> <span class="n">budget</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ring_info</span> <span class="o">*</span><span class="n">ri</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">tg3_rx_buffer_desc</span> <span class="o">*</span><span class="n">desc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tnapi</span><span class="o">-&gt;</span><span class="n">rx_rcb</span><span class="p">[</span><span class="n">sw_idx</span><span class="p">];</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">len</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
		<span class="n">dma_addr_t</span> <span class="n">dma_addr</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">opaque_key</span><span class="p">,</span> <span class="n">desc_idx</span><span class="p">,</span> <span class="o">*</span><span class="n">post_ptr</span><span class="p">;</span>
		<span class="n">u8</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>

		<span class="n">desc_idx</span> <span class="o">=</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">opaque</span> <span class="o">&amp;</span> <span class="n">RXD_OPAQUE_INDEX_MASK</span><span class="p">;</span>
		<span class="n">opaque_key</span> <span class="o">=</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">opaque</span> <span class="o">&amp;</span> <span class="n">RXD_OPAQUE_RING_MASK</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">opaque_key</span> <span class="o">==</span> <span class="n">RXD_OPAQUE_RING_STD</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ri</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">prodring</span><span class="p">.</span><span class="n">rx_std_buffers</span><span class="p">[</span><span class="n">desc_idx</span><span class="p">];</span>
			<span class="n">dma_addr</span> <span class="o">=</span> <span class="n">dma_unmap_addr</span><span class="p">(</span><span class="n">ri</span><span class="p">,</span> <span class="n">mapping</span><span class="p">);</span>
			<span class="n">data</span> <span class="o">=</span> <span class="n">ri</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
			<span class="n">post_ptr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">std_prod_idx</span><span class="p">;</span>
			<span class="n">rx_std_posted</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">opaque_key</span> <span class="o">==</span> <span class="n">RXD_OPAQUE_RING_JUMBO</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ri</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">prodring</span><span class="p">.</span><span class="n">rx_jmb_buffers</span><span class="p">[</span><span class="n">desc_idx</span><span class="p">];</span>
			<span class="n">dma_addr</span> <span class="o">=</span> <span class="n">dma_unmap_addr</span><span class="p">(</span><span class="n">ri</span><span class="p">,</span> <span class="n">mapping</span><span class="p">);</span>
			<span class="n">data</span> <span class="o">=</span> <span class="n">ri</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
			<span class="n">post_ptr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">jmb_prod_idx</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="k">goto</span> <span class="n">next_pkt_nopost</span><span class="p">;</span>

		<span class="n">work_mask</span> <span class="o">|=</span> <span class="n">opaque_key</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">err_vlan</span> <span class="o">&amp;</span> <span class="n">RXD_ERR_MASK</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">err_vlan</span> <span class="o">!=</span> <span class="n">RXD_ERR_ODD_NIBBLE_RCVD_MII</span><span class="p">))</span> <span class="p">{</span>
		<span class="nl">drop_it:</span>
			<span class="n">tg3_recycle_rx</span><span class="p">(</span><span class="n">tnapi</span><span class="p">,</span> <span class="n">tpr</span><span class="p">,</span> <span class="n">opaque_key</span><span class="p">,</span>
				       <span class="n">desc_idx</span><span class="p">,</span> <span class="o">*</span><span class="n">post_ptr</span><span class="p">);</span>
		<span class="nl">drop_it_no_recycle:</span>
			<span class="cm">/* Other statistics kept track of by card. */</span>
			<span class="n">tp</span><span class="o">-&gt;</span><span class="n">rx_dropped</span><span class="o">++</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">next_pkt</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">prefetch</span><span class="p">(</span><span class="n">data</span> <span class="o">+</span> <span class="n">TG3_RX_OFFSET</span><span class="p">(</span><span class="n">tp</span><span class="p">));</span>
		<span class="n">len</span> <span class="o">=</span> <span class="p">((</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">idx_len</span> <span class="o">&amp;</span> <span class="n">RXD_LEN_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">RXD_LEN_SHIFT</span><span class="p">)</span> <span class="o">-</span>
		      <span class="n">ETH_FCS_LEN</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">TG3_RX_COPY_THRESH</span><span class="p">(</span><span class="n">tp</span><span class="p">))</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">skb_size</span><span class="p">;</span>
			<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">frag_size</span><span class="p">;</span>

			<span class="n">skb_size</span> <span class="o">=</span> <span class="n">tg3_alloc_rx_data</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">tpr</span><span class="p">,</span> <span class="n">opaque_key</span><span class="p">,</span>
						    <span class="o">*</span><span class="n">post_ptr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">frag_size</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">skb_size</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">drop_it</span><span class="p">;</span>

			<span class="n">pci_unmap_single</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">dma_addr</span><span class="p">,</span> <span class="n">skb_size</span><span class="p">,</span>
					 <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>

			<span class="n">skb</span> <span class="o">=</span> <span class="n">build_skb</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">frag_size</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">tg3_frag_free</span><span class="p">(</span><span class="n">frag_size</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">drop_it_no_recycle</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">skb_reserve</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">TG3_RX_OFFSET</span><span class="p">(</span><span class="n">tp</span><span class="p">));</span>
			<span class="cm">/* Ensure that the update to the data happens</span>
<span class="cm">			 * after the usage of the old DMA mapping.</span>
<span class="cm">			 */</span>
			<span class="n">smp_wmb</span><span class="p">();</span>

			<span class="n">ri</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">tg3_recycle_rx</span><span class="p">(</span><span class="n">tnapi</span><span class="p">,</span> <span class="n">tpr</span><span class="p">,</span> <span class="n">opaque_key</span><span class="p">,</span>
				       <span class="n">desc_idx</span><span class="p">,</span> <span class="o">*</span><span class="n">post_ptr</span><span class="p">);</span>

			<span class="n">skb</span> <span class="o">=</span> <span class="n">netdev_alloc_skb</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					       <span class="n">len</span> <span class="o">+</span> <span class="n">TG3_RAW_IP_ALIGN</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">skb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">drop_it_no_recycle</span><span class="p">;</span>

			<span class="n">skb_reserve</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">TG3_RAW_IP_ALIGN</span><span class="p">);</span>
			<span class="n">pci_dma_sync_single_for_cpu</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">dma_addr</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span>
			       <span class="n">data</span> <span class="o">+</span> <span class="n">TG3_RX_OFFSET</span><span class="p">(</span><span class="n">tp</span><span class="p">),</span>
			       <span class="n">len</span><span class="p">);</span>
			<span class="n">pci_dma_sync_single_for_device</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">dma_addr</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">NETIF_F_RXCSUM</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">type_flags</span> <span class="o">&amp;</span> <span class="n">RXD_FLAG_TCPUDP_CSUM</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(((</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">ip_tcp_csum</span> <span class="o">&amp;</span> <span class="n">RXD_TCPCSUM_MASK</span><span class="p">)</span>
		      <span class="o">&gt;&gt;</span> <span class="n">RXD_TCPCSUM_SHIFT</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0xffff</span><span class="p">))</span>
			<span class="n">skb</span><span class="o">-&gt;</span><span class="n">ip_summed</span> <span class="o">=</span> <span class="n">CHECKSUM_UNNECESSARY</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">skb_checksum_none_assert</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

		<span class="n">skb</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">eth_type_trans</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mtu</span> <span class="o">+</span> <span class="n">ETH_HLEN</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="n">skb</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">!=</span> <span class="n">htons</span><span class="p">(</span><span class="n">ETH_P_8021Q</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">drop_it_no_recycle</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">type_flags</span> <span class="o">&amp;</span> <span class="n">RXD_FLAG_VLAN</span> <span class="o">&amp;&amp;</span>
		    <span class="o">!</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">rx_mode</span> <span class="o">&amp;</span> <span class="n">RX_MODE_KEEP_VLAN_TAG</span><span class="p">))</span>
			<span class="n">__vlan_hwaccel_put_tag</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span>
					       <span class="n">desc</span><span class="o">-&gt;</span><span class="n">err_vlan</span> <span class="o">&amp;</span> <span class="n">RXD_VLAN_MASK</span><span class="p">);</span>

		<span class="n">napi_gro_receive</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tnapi</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>

		<span class="n">received</span><span class="o">++</span><span class="p">;</span>
		<span class="n">budget</span><span class="o">--</span><span class="p">;</span>

<span class="nl">next_pkt:</span>
		<span class="p">(</span><span class="o">*</span><span class="n">post_ptr</span><span class="p">)</span><span class="o">++</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">rx_std_posted</span> <span class="o">&gt;=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">rx_std_max_post</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">tpr</span><span class="o">-&gt;</span><span class="n">rx_std_prod_idx</span> <span class="o">=</span> <span class="n">std_prod_idx</span> <span class="o">&amp;</span>
					       <span class="n">tp</span><span class="o">-&gt;</span><span class="n">rx_std_ring_mask</span><span class="p">;</span>
			<span class="n">tw32_rx_mbox</span><span class="p">(</span><span class="n">TG3_RX_STD_PROD_IDX_REG</span><span class="p">,</span>
				     <span class="n">tpr</span><span class="o">-&gt;</span><span class="n">rx_std_prod_idx</span><span class="p">);</span>
			<span class="n">work_mask</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">RXD_OPAQUE_RING_STD</span><span class="p">;</span>
			<span class="n">rx_std_posted</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
<span class="nl">next_pkt_nopost:</span>
		<span class="n">sw_idx</span><span class="o">++</span><span class="p">;</span>
		<span class="n">sw_idx</span> <span class="o">&amp;=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">rx_ret_ring_mask</span><span class="p">;</span>

		<span class="cm">/* Refresh hw_idx to see if there is new work */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sw_idx</span> <span class="o">==</span> <span class="n">hw_idx</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">hw_idx</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">tnapi</span><span class="o">-&gt;</span><span class="n">rx_rcb_prod_idx</span><span class="p">);</span>
			<span class="n">rmb</span><span class="p">();</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* ACK the status ring. */</span>
	<span class="n">tnapi</span><span class="o">-&gt;</span><span class="n">rx_rcb_ptr</span> <span class="o">=</span> <span class="n">sw_idx</span><span class="p">;</span>
	<span class="n">tw32_rx_mbox</span><span class="p">(</span><span class="n">tnapi</span><span class="o">-&gt;</span><span class="n">consmbox</span><span class="p">,</span> <span class="n">sw_idx</span><span class="p">);</span>

	<span class="cm">/* Refill RX ring(s). */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">ENABLE_RSS</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Sync BD data before updating mailbox */</span>
		<span class="n">wmb</span><span class="p">();</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">work_mask</span> <span class="o">&amp;</span> <span class="n">RXD_OPAQUE_RING_STD</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">tpr</span><span class="o">-&gt;</span><span class="n">rx_std_prod_idx</span> <span class="o">=</span> <span class="n">std_prod_idx</span> <span class="o">&amp;</span>
					       <span class="n">tp</span><span class="o">-&gt;</span><span class="n">rx_std_ring_mask</span><span class="p">;</span>
			<span class="n">tw32_rx_mbox</span><span class="p">(</span><span class="n">TG3_RX_STD_PROD_IDX_REG</span><span class="p">,</span>
				     <span class="n">tpr</span><span class="o">-&gt;</span><span class="n">rx_std_prod_idx</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">work_mask</span> <span class="o">&amp;</span> <span class="n">RXD_OPAQUE_RING_JUMBO</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">tpr</span><span class="o">-&gt;</span><span class="n">rx_jmb_prod_idx</span> <span class="o">=</span> <span class="n">jmb_prod_idx</span> <span class="o">&amp;</span>
					       <span class="n">tp</span><span class="o">-&gt;</span><span class="n">rx_jmb_ring_mask</span><span class="p">;</span>
			<span class="n">tw32_rx_mbox</span><span class="p">(</span><span class="n">TG3_RX_JMB_PROD_IDX_REG</span><span class="p">,</span>
				     <span class="n">tpr</span><span class="o">-&gt;</span><span class="n">rx_jmb_prod_idx</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">mmiowb</span><span class="p">();</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">work_mask</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* rx_std_buffers[] and rx_jmb_buffers[] entries must be</span>
<span class="cm">		 * updated before the producer indices can be updated.</span>
<span class="cm">		 */</span>
		<span class="n">smp_wmb</span><span class="p">();</span>

		<span class="n">tpr</span><span class="o">-&gt;</span><span class="n">rx_std_prod_idx</span> <span class="o">=</span> <span class="n">std_prod_idx</span> <span class="o">&amp;</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">rx_std_ring_mask</span><span class="p">;</span>
		<span class="n">tpr</span><span class="o">-&gt;</span><span class="n">rx_jmb_prod_idx</span> <span class="o">=</span> <span class="n">jmb_prod_idx</span> <span class="o">&amp;</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">rx_jmb_ring_mask</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">tnapi</span> <span class="o">!=</span> <span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">tp</span><span class="o">-&gt;</span><span class="n">rx_refill</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="n">napi_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">napi</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">received</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tg3_poll_link</span><span class="p">(</span><span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* handle link change and other phy events */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">USE_LINKCHG_REG</span><span class="p">)</span> <span class="o">||</span> <span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">POLL_SERDES</span><span class="p">)))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">tg3_hw_status</span> <span class="o">*</span><span class="n">sblk</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">hw_status</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">sblk</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">SD_STATUS_LINK_CHG</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sblk</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">SD_STATUS_UPDATED</span> <span class="o">|</span>
				       <span class="p">(</span><span class="n">sblk</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">SD_STATUS_LINK_CHG</span><span class="p">);</span>
			<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">USE_PHYLIB</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">tw32_f</span><span class="p">(</span><span class="n">MAC_STATUS</span><span class="p">,</span>
				     <span class="p">(</span><span class="n">MAC_STATUS_SYNC_CHANGED</span> <span class="o">|</span>
				      <span class="n">MAC_STATUS_CFG_CHANGED</span> <span class="o">|</span>
				      <span class="n">MAC_STATUS_MI_COMPLETION</span> <span class="o">|</span>
				      <span class="n">MAC_STATUS_LNKSTATE_CHANGED</span><span class="p">));</span>
				<span class="n">udelay</span><span class="p">(</span><span class="mi">40</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="n">tg3_setup_phy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tg3_rx_prodring_xfer</span><span class="p">(</span><span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">tg3_rx_prodring_set</span> <span class="o">*</span><span class="n">dpr</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">tg3_rx_prodring_set</span> <span class="o">*</span><span class="n">spr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">si</span><span class="p">,</span> <span class="n">di</span><span class="p">,</span> <span class="n">cpycnt</span><span class="p">,</span> <span class="n">src_prod_idx</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">src_prod_idx</span> <span class="o">=</span> <span class="n">spr</span><span class="o">-&gt;</span><span class="n">rx_std_prod_idx</span><span class="p">;</span>

		<span class="cm">/* Make sure updates to the rx_std_buffers[] entries and the</span>
<span class="cm">		 * standard producer index are seen in the correct order.</span>
<span class="cm">		 */</span>
		<span class="n">smp_rmb</span><span class="p">();</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">spr</span><span class="o">-&gt;</span><span class="n">rx_std_cons_idx</span> <span class="o">==</span> <span class="n">src_prod_idx</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">spr</span><span class="o">-&gt;</span><span class="n">rx_std_cons_idx</span> <span class="o">&lt;</span> <span class="n">src_prod_idx</span><span class="p">)</span>
			<span class="n">cpycnt</span> <span class="o">=</span> <span class="n">src_prod_idx</span> <span class="o">-</span> <span class="n">spr</span><span class="o">-&gt;</span><span class="n">rx_std_cons_idx</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">cpycnt</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">rx_std_ring_mask</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">-</span>
				 <span class="n">spr</span><span class="o">-&gt;</span><span class="n">rx_std_cons_idx</span><span class="p">;</span>

		<span class="n">cpycnt</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">cpycnt</span><span class="p">,</span>
			     <span class="n">tp</span><span class="o">-&gt;</span><span class="n">rx_std_ring_mask</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">dpr</span><span class="o">-&gt;</span><span class="n">rx_std_prod_idx</span><span class="p">);</span>

		<span class="n">si</span> <span class="o">=</span> <span class="n">spr</span><span class="o">-&gt;</span><span class="n">rx_std_cons_idx</span><span class="p">;</span>
		<span class="n">di</span> <span class="o">=</span> <span class="n">dpr</span><span class="o">-&gt;</span><span class="n">rx_std_prod_idx</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">di</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">di</span> <span class="o">+</span> <span class="n">cpycnt</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dpr</span><span class="o">-&gt;</span><span class="n">rx_std_buffers</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">data</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">cpycnt</span> <span class="o">=</span> <span class="n">i</span> <span class="o">-</span> <span class="n">di</span><span class="p">;</span>
				<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOSPC</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cpycnt</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="cm">/* Ensure that updates to the rx_std_buffers ring and the</span>
<span class="cm">		 * shadowed hardware producer ring from tg3_recycle_skb() are</span>
<span class="cm">		 * ordered correctly WRT the skb check above.</span>
<span class="cm">		 */</span>
		<span class="n">smp_rmb</span><span class="p">();</span>

		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dpr</span><span class="o">-&gt;</span><span class="n">rx_std_buffers</span><span class="p">[</span><span class="n">di</span><span class="p">],</span>
		       <span class="o">&amp;</span><span class="n">spr</span><span class="o">-&gt;</span><span class="n">rx_std_buffers</span><span class="p">[</span><span class="n">si</span><span class="p">],</span>
		       <span class="n">cpycnt</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ring_info</span><span class="p">));</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">cpycnt</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">di</span><span class="o">++</span><span class="p">,</span> <span class="n">si</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">tg3_rx_buffer_desc</span> <span class="o">*</span><span class="n">sbd</span><span class="p">,</span> <span class="o">*</span><span class="n">dbd</span><span class="p">;</span>
			<span class="n">sbd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">spr</span><span class="o">-&gt;</span><span class="n">rx_std</span><span class="p">[</span><span class="n">si</span><span class="p">];</span>
			<span class="n">dbd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dpr</span><span class="o">-&gt;</span><span class="n">rx_std</span><span class="p">[</span><span class="n">di</span><span class="p">];</span>
			<span class="n">dbd</span><span class="o">-&gt;</span><span class="n">addr_hi</span> <span class="o">=</span> <span class="n">sbd</span><span class="o">-&gt;</span><span class="n">addr_hi</span><span class="p">;</span>
			<span class="n">dbd</span><span class="o">-&gt;</span><span class="n">addr_lo</span> <span class="o">=</span> <span class="n">sbd</span><span class="o">-&gt;</span><span class="n">addr_lo</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">spr</span><span class="o">-&gt;</span><span class="n">rx_std_cons_idx</span> <span class="o">=</span> <span class="p">(</span><span class="n">spr</span><span class="o">-&gt;</span><span class="n">rx_std_cons_idx</span> <span class="o">+</span> <span class="n">cpycnt</span><span class="p">)</span> <span class="o">&amp;</span>
				       <span class="n">tp</span><span class="o">-&gt;</span><span class="n">rx_std_ring_mask</span><span class="p">;</span>
		<span class="n">dpr</span><span class="o">-&gt;</span><span class="n">rx_std_prod_idx</span> <span class="o">=</span> <span class="p">(</span><span class="n">dpr</span><span class="o">-&gt;</span><span class="n">rx_std_prod_idx</span> <span class="o">+</span> <span class="n">cpycnt</span><span class="p">)</span> <span class="o">&amp;</span>
				       <span class="n">tp</span><span class="o">-&gt;</span><span class="n">rx_std_ring_mask</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">src_prod_idx</span> <span class="o">=</span> <span class="n">spr</span><span class="o">-&gt;</span><span class="n">rx_jmb_prod_idx</span><span class="p">;</span>

		<span class="cm">/* Make sure updates to the rx_jmb_buffers[] entries and</span>
<span class="cm">		 * the jumbo producer index are seen in the correct order.</span>
<span class="cm">		 */</span>
		<span class="n">smp_rmb</span><span class="p">();</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">spr</span><span class="o">-&gt;</span><span class="n">rx_jmb_cons_idx</span> <span class="o">==</span> <span class="n">src_prod_idx</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">spr</span><span class="o">-&gt;</span><span class="n">rx_jmb_cons_idx</span> <span class="o">&lt;</span> <span class="n">src_prod_idx</span><span class="p">)</span>
			<span class="n">cpycnt</span> <span class="o">=</span> <span class="n">src_prod_idx</span> <span class="o">-</span> <span class="n">spr</span><span class="o">-&gt;</span><span class="n">rx_jmb_cons_idx</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">cpycnt</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">rx_jmb_ring_mask</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">-</span>
				 <span class="n">spr</span><span class="o">-&gt;</span><span class="n">rx_jmb_cons_idx</span><span class="p">;</span>

		<span class="n">cpycnt</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">cpycnt</span><span class="p">,</span>
			     <span class="n">tp</span><span class="o">-&gt;</span><span class="n">rx_jmb_ring_mask</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">dpr</span><span class="o">-&gt;</span><span class="n">rx_jmb_prod_idx</span><span class="p">);</span>

		<span class="n">si</span> <span class="o">=</span> <span class="n">spr</span><span class="o">-&gt;</span><span class="n">rx_jmb_cons_idx</span><span class="p">;</span>
		<span class="n">di</span> <span class="o">=</span> <span class="n">dpr</span><span class="o">-&gt;</span><span class="n">rx_jmb_prod_idx</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">di</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">di</span> <span class="o">+</span> <span class="n">cpycnt</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dpr</span><span class="o">-&gt;</span><span class="n">rx_jmb_buffers</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">data</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">cpycnt</span> <span class="o">=</span> <span class="n">i</span> <span class="o">-</span> <span class="n">di</span><span class="p">;</span>
				<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOSPC</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cpycnt</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="cm">/* Ensure that updates to the rx_jmb_buffers ring and the</span>
<span class="cm">		 * shadowed hardware producer ring from tg3_recycle_skb() are</span>
<span class="cm">		 * ordered correctly WRT the skb check above.</span>
<span class="cm">		 */</span>
		<span class="n">smp_rmb</span><span class="p">();</span>

		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dpr</span><span class="o">-&gt;</span><span class="n">rx_jmb_buffers</span><span class="p">[</span><span class="n">di</span><span class="p">],</span>
		       <span class="o">&amp;</span><span class="n">spr</span><span class="o">-&gt;</span><span class="n">rx_jmb_buffers</span><span class="p">[</span><span class="n">si</span><span class="p">],</span>
		       <span class="n">cpycnt</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ring_info</span><span class="p">));</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">cpycnt</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">di</span><span class="o">++</span><span class="p">,</span> <span class="n">si</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">tg3_rx_buffer_desc</span> <span class="o">*</span><span class="n">sbd</span><span class="p">,</span> <span class="o">*</span><span class="n">dbd</span><span class="p">;</span>
			<span class="n">sbd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">spr</span><span class="o">-&gt;</span><span class="n">rx_jmb</span><span class="p">[</span><span class="n">si</span><span class="p">].</span><span class="n">std</span><span class="p">;</span>
			<span class="n">dbd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dpr</span><span class="o">-&gt;</span><span class="n">rx_jmb</span><span class="p">[</span><span class="n">di</span><span class="p">].</span><span class="n">std</span><span class="p">;</span>
			<span class="n">dbd</span><span class="o">-&gt;</span><span class="n">addr_hi</span> <span class="o">=</span> <span class="n">sbd</span><span class="o">-&gt;</span><span class="n">addr_hi</span><span class="p">;</span>
			<span class="n">dbd</span><span class="o">-&gt;</span><span class="n">addr_lo</span> <span class="o">=</span> <span class="n">sbd</span><span class="o">-&gt;</span><span class="n">addr_lo</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">spr</span><span class="o">-&gt;</span><span class="n">rx_jmb_cons_idx</span> <span class="o">=</span> <span class="p">(</span><span class="n">spr</span><span class="o">-&gt;</span><span class="n">rx_jmb_cons_idx</span> <span class="o">+</span> <span class="n">cpycnt</span><span class="p">)</span> <span class="o">&amp;</span>
				       <span class="n">tp</span><span class="o">-&gt;</span><span class="n">rx_jmb_ring_mask</span><span class="p">;</span>
		<span class="n">dpr</span><span class="o">-&gt;</span><span class="n">rx_jmb_prod_idx</span> <span class="o">=</span> <span class="p">(</span><span class="n">dpr</span><span class="o">-&gt;</span><span class="n">rx_jmb_prod_idx</span> <span class="o">+</span> <span class="n">cpycnt</span><span class="p">)</span> <span class="o">&amp;</span>
				       <span class="n">tp</span><span class="o">-&gt;</span><span class="n">rx_jmb_ring_mask</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tg3_poll_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">tg3_napi</span> <span class="o">*</span><span class="n">tnapi</span><span class="p">,</span> <span class="kt">int</span> <span class="n">work_done</span><span class="p">,</span> <span class="kt">int</span> <span class="n">budget</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="n">tnapi</span><span class="o">-&gt;</span><span class="n">tp</span><span class="p">;</span>

	<span class="cm">/* run TX completion thread */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tnapi</span><span class="o">-&gt;</span><span class="n">hw_status</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">tx_consumer</span> <span class="o">!=</span> <span class="n">tnapi</span><span class="o">-&gt;</span><span class="n">tx_cons</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tg3_tx</span><span class="p">(</span><span class="n">tnapi</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">TX_RECOVERY_PENDING</span><span class="p">)))</span>
			<span class="k">return</span> <span class="n">work_done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tnapi</span><span class="o">-&gt;</span><span class="n">rx_rcb_prod_idx</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">work_done</span><span class="p">;</span>

	<span class="cm">/* run RX thread, within the bounds set by NAPI.</span>
<span class="cm">	 * All RX &quot;locking&quot; is done by ensuring outside</span>
<span class="cm">	 * code synchronizes with tg3-&gt;napi.poll()</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">tnapi</span><span class="o">-&gt;</span><span class="n">rx_rcb_prod_idx</span><span class="p">)</span> <span class="o">!=</span> <span class="n">tnapi</span><span class="o">-&gt;</span><span class="n">rx_rcb_ptr</span><span class="p">)</span>
		<span class="n">work_done</span> <span class="o">+=</span> <span class="n">tg3_rx</span><span class="p">(</span><span class="n">tnapi</span><span class="p">,</span> <span class="n">budget</span> <span class="o">-</span> <span class="n">work_done</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">ENABLE_RSS</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">tnapi</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">tg3_rx_prodring_set</span> <span class="o">*</span><span class="n">dpr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">prodring</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">std_prod_idx</span> <span class="o">=</span> <span class="n">dpr</span><span class="o">-&gt;</span><span class="n">rx_std_prod_idx</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">jmb_prod_idx</span> <span class="o">=</span> <span class="n">dpr</span><span class="o">-&gt;</span><span class="n">rx_jmb_prod_idx</span><span class="p">;</span>

		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">rx_refill</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">irq_cnt</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">err</span> <span class="o">|=</span> <span class="n">tg3_rx_prodring_xfer</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">dpr</span><span class="p">,</span>
						    <span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">prodring</span><span class="p">);</span>

		<span class="n">wmb</span><span class="p">();</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">std_prod_idx</span> <span class="o">!=</span> <span class="n">dpr</span><span class="o">-&gt;</span><span class="n">rx_std_prod_idx</span><span class="p">)</span>
			<span class="n">tw32_rx_mbox</span><span class="p">(</span><span class="n">TG3_RX_STD_PROD_IDX_REG</span><span class="p">,</span>
				     <span class="n">dpr</span><span class="o">-&gt;</span><span class="n">rx_std_prod_idx</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">jmb_prod_idx</span> <span class="o">!=</span> <span class="n">dpr</span><span class="o">-&gt;</span><span class="n">rx_jmb_prod_idx</span><span class="p">)</span>
			<span class="n">tw32_rx_mbox</span><span class="p">(</span><span class="n">TG3_RX_JMB_PROD_IDX_REG</span><span class="p">,</span>
				     <span class="n">dpr</span><span class="o">-&gt;</span><span class="n">rx_jmb_prod_idx</span><span class="p">);</span>

		<span class="n">mmiowb</span><span class="p">();</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="n">tw32_f</span><span class="p">(</span><span class="n">HOSTCC_MODE</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">coal_now</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">work_done</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">tg3_reset_task_schedule</span><span class="p">(</span><span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">TG3_FLAG_RESET_TASK_PENDING</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">tg3_flags</span><span class="p">))</span>
		<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">reset_task</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">tg3_reset_task_cancel</span><span class="p">(</span><span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">cancel_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">reset_task</span><span class="p">);</span>
	<span class="n">tg3_flag_clear</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">RESET_TASK_PENDING</span><span class="p">);</span>
	<span class="n">tg3_flag_clear</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">TX_RECOVERY_PENDING</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tg3_poll_msix</span><span class="p">(</span><span class="k">struct</span> <span class="n">napi_struct</span> <span class="o">*</span><span class="n">napi</span><span class="p">,</span> <span class="kt">int</span> <span class="n">budget</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tg3_napi</span> <span class="o">*</span><span class="n">tnapi</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">napi</span><span class="p">,</span> <span class="k">struct</span> <span class="n">tg3_napi</span><span class="p">,</span> <span class="n">napi</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="n">tnapi</span><span class="o">-&gt;</span><span class="n">tp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">work_done</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tg3_hw_status</span> <span class="o">*</span><span class="n">sblk</span> <span class="o">=</span> <span class="n">tnapi</span><span class="o">-&gt;</span><span class="n">hw_status</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">work_done</span> <span class="o">=</span> <span class="n">tg3_poll_work</span><span class="p">(</span><span class="n">tnapi</span><span class="p">,</span> <span class="n">work_done</span><span class="p">,</span> <span class="n">budget</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">TX_RECOVERY_PENDING</span><span class="p">)))</span>
			<span class="k">goto</span> <span class="n">tx_recovery</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">work_done</span> <span class="o">&gt;=</span> <span class="n">budget</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="cm">/* tp-&gt;last_tag is used in tg3_int_reenable() below</span>
<span class="cm">		 * to tell the hw how much work has been processed,</span>
<span class="cm">		 * so we must read it before checking for more work.</span>
<span class="cm">		 */</span>
		<span class="n">tnapi</span><span class="o">-&gt;</span><span class="n">last_tag</span> <span class="o">=</span> <span class="n">sblk</span><span class="o">-&gt;</span><span class="n">status_tag</span><span class="p">;</span>
		<span class="n">tnapi</span><span class="o">-&gt;</span><span class="n">last_irq_tag</span> <span class="o">=</span> <span class="n">tnapi</span><span class="o">-&gt;</span><span class="n">last_tag</span><span class="p">;</span>
		<span class="n">rmb</span><span class="p">();</span>

		<span class="cm">/* check for RX/TX work to do */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">sblk</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">tx_consumer</span> <span class="o">==</span> <span class="n">tnapi</span><span class="o">-&gt;</span><span class="n">tx_cons</span> <span class="o">&amp;&amp;</span>
			   <span class="o">*</span><span class="p">(</span><span class="n">tnapi</span><span class="o">-&gt;</span><span class="n">rx_rcb_prod_idx</span><span class="p">)</span> <span class="o">==</span> <span class="n">tnapi</span><span class="o">-&gt;</span><span class="n">rx_rcb_ptr</span><span class="p">))</span> <span class="p">{</span>

			<span class="cm">/* This test here is not race free, but will reduce</span>
<span class="cm">			 * the number of interrupts by looping again.</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tnapi</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">rx_refill</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>

			<span class="n">napi_complete</span><span class="p">(</span><span class="n">napi</span><span class="p">);</span>
			<span class="cm">/* Reenable interrupts. */</span>
			<span class="n">tw32_mailbox</span><span class="p">(</span><span class="n">tnapi</span><span class="o">-&gt;</span><span class="n">int_mbox</span><span class="p">,</span> <span class="n">tnapi</span><span class="o">-&gt;</span><span class="n">last_tag</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">);</span>

			<span class="cm">/* This test here is synchronized by napi_schedule()</span>
<span class="cm">			 * and napi_complete() to close the race condition.</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">tnapi</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">rx_refill</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">tw32</span><span class="p">(</span><span class="n">HOSTCC_MODE</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">coalesce_mode</span> <span class="o">|</span>
						  <span class="n">HOSTCC_MODE_ENABLE</span> <span class="o">|</span>
						  <span class="n">tnapi</span><span class="o">-&gt;</span><span class="n">coal_now</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">mmiowb</span><span class="p">();</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">work_done</span><span class="p">;</span>

<span class="nl">tx_recovery:</span>
	<span class="cm">/* work_done is guaranteed to be less than budget. */</span>
	<span class="n">napi_complete</span><span class="p">(</span><span class="n">napi</span><span class="p">);</span>
	<span class="n">tg3_reset_task_schedule</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">work_done</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tg3_process_error</span><span class="p">(</span><span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">real_error</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">ERROR_PROCESSED</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* Check Flow Attention register */</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">tr32</span><span class="p">(</span><span class="n">HOSTCC_FLOW_ATTN</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">HOSTCC_FLOW_ATTN_MBUF_LWM</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netdev_err</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;FLOW Attention error.  Resetting chip.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">real_error</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tr32</span><span class="p">(</span><span class="n">MSGINT_STATUS</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">MSGINT_STATUS_MSI_REQ</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netdev_err</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;MSI Status error.  Resetting chip.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">real_error</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tr32</span><span class="p">(</span><span class="n">RDMAC_STATUS</span><span class="p">)</span> <span class="o">||</span> <span class="n">tr32</span><span class="p">(</span><span class="n">WDMAC_STATUS</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">netdev_err</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;DMA Status error.  Resetting chip.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">real_error</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">real_error</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">tg3_dump_state</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>

	<span class="n">tg3_flag_set</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">ERROR_PROCESSED</span><span class="p">);</span>
	<span class="n">tg3_reset_task_schedule</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tg3_poll</span><span class="p">(</span><span class="k">struct</span> <span class="n">napi_struct</span> <span class="o">*</span><span class="n">napi</span><span class="p">,</span> <span class="kt">int</span> <span class="n">budget</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tg3_napi</span> <span class="o">*</span><span class="n">tnapi</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">napi</span><span class="p">,</span> <span class="k">struct</span> <span class="n">tg3_napi</span><span class="p">,</span> <span class="n">napi</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="n">tnapi</span><span class="o">-&gt;</span><span class="n">tp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">work_done</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tg3_hw_status</span> <span class="o">*</span><span class="n">sblk</span> <span class="o">=</span> <span class="n">tnapi</span><span class="o">-&gt;</span><span class="n">hw_status</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sblk</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">SD_STATUS_ERROR</span><span class="p">)</span>
			<span class="n">tg3_process_error</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>

		<span class="n">tg3_poll_link</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>

		<span class="n">work_done</span> <span class="o">=</span> <span class="n">tg3_poll_work</span><span class="p">(</span><span class="n">tnapi</span><span class="p">,</span> <span class="n">work_done</span><span class="p">,</span> <span class="n">budget</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">TX_RECOVERY_PENDING</span><span class="p">)))</span>
			<span class="k">goto</span> <span class="n">tx_recovery</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">work_done</span> <span class="o">&gt;=</span> <span class="n">budget</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">TAGGED_STATUS</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* tp-&gt;last_tag is used in tg3_int_reenable() below</span>
<span class="cm">			 * to tell the hw how much work has been processed,</span>
<span class="cm">			 * so we must read it before checking for more work.</span>
<span class="cm">			 */</span>
			<span class="n">tnapi</span><span class="o">-&gt;</span><span class="n">last_tag</span> <span class="o">=</span> <span class="n">sblk</span><span class="o">-&gt;</span><span class="n">status_tag</span><span class="p">;</span>
			<span class="n">tnapi</span><span class="o">-&gt;</span><span class="n">last_irq_tag</span> <span class="o">=</span> <span class="n">tnapi</span><span class="o">-&gt;</span><span class="n">last_tag</span><span class="p">;</span>
			<span class="n">rmb</span><span class="p">();</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">sblk</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SD_STATUS_UPDATED</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="o">!</span><span class="n">tg3_has_work</span><span class="p">(</span><span class="n">tnapi</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">napi_complete</span><span class="p">(</span><span class="n">napi</span><span class="p">);</span>
			<span class="n">tg3_int_reenable</span><span class="p">(</span><span class="n">tnapi</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">work_done</span><span class="p">;</span>

<span class="nl">tx_recovery:</span>
	<span class="cm">/* work_done is guaranteed to be less than budget. */</span>
	<span class="n">napi_complete</span><span class="p">(</span><span class="n">napi</span><span class="p">);</span>
	<span class="n">tg3_reset_task_schedule</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">work_done</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tg3_napi_disable</span><span class="p">(</span><span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">irq_cnt</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span>
		<span class="n">napi_disable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">napi</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tg3_napi_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">irq_cnt</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">napi_enable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">napi</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tg3_napi_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">netif_napi_add</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">napi</span><span class="p">,</span> <span class="n">tg3_poll</span><span class="p">,</span> <span class="mi">64</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">irq_cnt</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">netif_napi_add</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">napi</span><span class="p">,</span> <span class="n">tg3_poll_msix</span><span class="p">,</span> <span class="mi">64</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tg3_napi_fini</span><span class="p">(</span><span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">irq_cnt</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">netif_napi_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">napi</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">tg3_netif_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">trans_start</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>	<span class="cm">/* prevent tx timeout */</span>
	<span class="n">tg3_napi_disable</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
	<span class="n">netif_tx_disable</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">tg3_netif_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* NOTE: unconditional netif_tx_wake_all_queues is only</span>
<span class="cm">	 * appropriate so long as all callers are assured to</span>
<span class="cm">	 * have free tx slots (such as after tg3_init_hw)</span>
<span class="cm">	 */</span>
	<span class="n">netif_tx_wake_all_queues</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">tg3_napi_enable</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">hw_status</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">|=</span> <span class="n">SD_STATUS_UPDATED</span><span class="p">;</span>
	<span class="n">tg3_enable_ints</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tg3_irq_quiesce</span><span class="p">(</span><span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">irq_sync</span><span class="p">);</span>

	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">irq_sync</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">smp_mb</span><span class="p">();</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">irq_cnt</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">synchronize_irq</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">irq_vec</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Fully shutdown all tg3 driver activity elsewhere in the system.</span>
<span class="cm"> * If irq_sync is non-zero, then the IRQ handler must be synchronized</span>
<span class="cm"> * with as well.  Most of the time, this is not necessary except when</span>
<span class="cm"> * shutting down the device.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">tg3_full_lock</span><span class="p">(</span><span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">irq_sync</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">irq_sync</span><span class="p">)</span>
		<span class="n">tg3_irq_quiesce</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">tg3_full_unlock</span><span class="p">(</span><span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* One-shot MSI handler - Chip automatically disables interrupt</span>
<span class="cm"> * after sending MSI so driver doesn&#39;t have to do it.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">tg3_msi_1shot</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tg3_napi</span> <span class="o">*</span><span class="n">tnapi</span> <span class="o">=</span> <span class="n">dev_id</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="n">tnapi</span><span class="o">-&gt;</span><span class="n">tp</span><span class="p">;</span>

	<span class="n">prefetch</span><span class="p">(</span><span class="n">tnapi</span><span class="o">-&gt;</span><span class="n">hw_status</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tnapi</span><span class="o">-&gt;</span><span class="n">rx_rcb</span><span class="p">)</span>
		<span class="n">prefetch</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tnapi</span><span class="o">-&gt;</span><span class="n">rx_rcb</span><span class="p">[</span><span class="n">tnapi</span><span class="o">-&gt;</span><span class="n">rx_rcb_ptr</span><span class="p">]);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="o">!</span><span class="n">tg3_irq_sync</span><span class="p">(</span><span class="n">tp</span><span class="p">)))</span>
		<span class="n">napi_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tnapi</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* MSI ISR - No need to check for interrupt sharing and no need to</span>
<span class="cm"> * flush status block and interrupt mailbox. PCI ordering rules</span>
<span class="cm"> * guarantee that MSI will arrive after the status block.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">tg3_msi</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tg3_napi</span> <span class="o">*</span><span class="n">tnapi</span> <span class="o">=</span> <span class="n">dev_id</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="n">tnapi</span><span class="o">-&gt;</span><span class="n">tp</span><span class="p">;</span>

	<span class="n">prefetch</span><span class="p">(</span><span class="n">tnapi</span><span class="o">-&gt;</span><span class="n">hw_status</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tnapi</span><span class="o">-&gt;</span><span class="n">rx_rcb</span><span class="p">)</span>
		<span class="n">prefetch</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tnapi</span><span class="o">-&gt;</span><span class="n">rx_rcb</span><span class="p">[</span><span class="n">tnapi</span><span class="o">-&gt;</span><span class="n">rx_rcb_ptr</span><span class="p">]);</span>
	<span class="cm">/*</span>
<span class="cm">	 * Writing any value to intr-mbox-0 clears PCI INTA# and</span>
<span class="cm">	 * chip-internal interrupt pending events.</span>
<span class="cm">	 * Writing non-zero to intr-mbox-0 additional tells the</span>
<span class="cm">	 * NIC to stop sending us irqs, engaging &quot;in-intr-handler&quot;</span>
<span class="cm">	 * event coalescing.</span>
<span class="cm">	 */</span>
	<span class="n">tw32_mailbox</span><span class="p">(</span><span class="n">tnapi</span><span class="o">-&gt;</span><span class="n">int_mbox</span><span class="p">,</span> <span class="mh">0x00000001</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="o">!</span><span class="n">tg3_irq_sync</span><span class="p">(</span><span class="n">tp</span><span class="p">)))</span>
		<span class="n">napi_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tnapi</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">IRQ_RETVAL</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">tg3_interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tg3_napi</span> <span class="o">*</span><span class="n">tnapi</span> <span class="o">=</span> <span class="n">dev_id</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="n">tnapi</span><span class="o">-&gt;</span><span class="n">tp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tg3_hw_status</span> <span class="o">*</span><span class="n">sblk</span> <span class="o">=</span> <span class="n">tnapi</span><span class="o">-&gt;</span><span class="n">hw_status</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">handled</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* In INTx mode, it is possible for the interrupt to arrive at</span>
<span class="cm">	 * the CPU before the status block posted prior to the interrupt.</span>
<span class="cm">	 * Reading the PCI State register will confirm whether the</span>
<span class="cm">	 * interrupt is ours and will flush the status block.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">sblk</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">SD_STATUS_UPDATED</span><span class="p">)))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">CHIP_RESETTING</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">tr32</span><span class="p">(</span><span class="n">TG3PCI_PCISTATE</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">PCISTATE_INT_NOT_ACTIVE</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">handled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Writing any value to intr-mbox-0 clears PCI INTA# and</span>
<span class="cm">	 * chip-internal interrupt pending events.</span>
<span class="cm">	 * Writing non-zero to intr-mbox-0 additional tells the</span>
<span class="cm">	 * NIC to stop sending us irqs, engaging &quot;in-intr-handler&quot;</span>
<span class="cm">	 * event coalescing.</span>
<span class="cm">	 *</span>
<span class="cm">	 * Flush the mailbox to de-assert the IRQ immediately to prevent</span>
<span class="cm">	 * spurious interrupts.  The flush impacts performance but</span>
<span class="cm">	 * excessive spurious interrupts can be worse in some cases.</span>
<span class="cm">	 */</span>
	<span class="n">tw32_mailbox_f</span><span class="p">(</span><span class="n">MAILBOX_INTERRUPT_0</span> <span class="o">+</span> <span class="n">TG3_64BIT_REG_LOW</span><span class="p">,</span> <span class="mh">0x00000001</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tg3_irq_sync</span><span class="p">(</span><span class="n">tp</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="n">sblk</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SD_STATUS_UPDATED</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">tg3_has_work</span><span class="p">(</span><span class="n">tnapi</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">prefetch</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tnapi</span><span class="o">-&gt;</span><span class="n">rx_rcb</span><span class="p">[</span><span class="n">tnapi</span><span class="o">-&gt;</span><span class="n">rx_rcb_ptr</span><span class="p">]);</span>
		<span class="n">napi_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tnapi</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* No work, shared interrupt perhaps?  re-enable</span>
<span class="cm">		 * interrupts, and flush that PCI write</span>
<span class="cm">		 */</span>
		<span class="n">tw32_mailbox_f</span><span class="p">(</span><span class="n">MAILBOX_INTERRUPT_0</span> <span class="o">+</span> <span class="n">TG3_64BIT_REG_LOW</span><span class="p">,</span>
			       <span class="mh">0x00000000</span><span class="p">);</span>
	<span class="p">}</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">IRQ_RETVAL</span><span class="p">(</span><span class="n">handled</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">tg3_interrupt_tagged</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tg3_napi</span> <span class="o">*</span><span class="n">tnapi</span> <span class="o">=</span> <span class="n">dev_id</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="n">tnapi</span><span class="o">-&gt;</span><span class="n">tp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tg3_hw_status</span> <span class="o">*</span><span class="n">sblk</span> <span class="o">=</span> <span class="n">tnapi</span><span class="o">-&gt;</span><span class="n">hw_status</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">handled</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* In INTx mode, it is possible for the interrupt to arrive at</span>
<span class="cm">	 * the CPU before the status block posted prior to the interrupt.</span>
<span class="cm">	 * Reading the PCI State register will confirm whether the</span>
<span class="cm">	 * interrupt is ours and will flush the status block.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">sblk</span><span class="o">-&gt;</span><span class="n">status_tag</span> <span class="o">==</span> <span class="n">tnapi</span><span class="o">-&gt;</span><span class="n">last_irq_tag</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">CHIP_RESETTING</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">tr32</span><span class="p">(</span><span class="n">TG3PCI_PCISTATE</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">PCISTATE_INT_NOT_ACTIVE</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">handled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * writing any value to intr-mbox-0 clears PCI INTA# and</span>
<span class="cm">	 * chip-internal interrupt pending events.</span>
<span class="cm">	 * writing non-zero to intr-mbox-0 additional tells the</span>
<span class="cm">	 * NIC to stop sending us irqs, engaging &quot;in-intr-handler&quot;</span>
<span class="cm">	 * event coalescing.</span>
<span class="cm">	 *</span>
<span class="cm">	 * Flush the mailbox to de-assert the IRQ immediately to prevent</span>
<span class="cm">	 * spurious interrupts.  The flush impacts performance but</span>
<span class="cm">	 * excessive spurious interrupts can be worse in some cases.</span>
<span class="cm">	 */</span>
	<span class="n">tw32_mailbox_f</span><span class="p">(</span><span class="n">MAILBOX_INTERRUPT_0</span> <span class="o">+</span> <span class="n">TG3_64BIT_REG_LOW</span><span class="p">,</span> <span class="mh">0x00000001</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * In a shared interrupt configuration, sometimes other devices&#39;</span>
<span class="cm">	 * interrupts will scream.  We record the current status tag here</span>
<span class="cm">	 * so that the above check can report that the screaming interrupts</span>
<span class="cm">	 * are unhandled.  Eventually they will be silenced.</span>
<span class="cm">	 */</span>
	<span class="n">tnapi</span><span class="o">-&gt;</span><span class="n">last_irq_tag</span> <span class="o">=</span> <span class="n">sblk</span><span class="o">-&gt;</span><span class="n">status_tag</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tg3_irq_sync</span><span class="p">(</span><span class="n">tp</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">prefetch</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tnapi</span><span class="o">-&gt;</span><span class="n">rx_rcb</span><span class="p">[</span><span class="n">tnapi</span><span class="o">-&gt;</span><span class="n">rx_rcb_ptr</span><span class="p">]);</span>

	<span class="n">napi_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tnapi</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">IRQ_RETVAL</span><span class="p">(</span><span class="n">handled</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* ISR for interrupt test */</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">tg3_test_isr</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tg3_napi</span> <span class="o">*</span><span class="n">tnapi</span> <span class="o">=</span> <span class="n">dev_id</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="n">tnapi</span><span class="o">-&gt;</span><span class="n">tp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tg3_hw_status</span> <span class="o">*</span><span class="n">sblk</span> <span class="o">=</span> <span class="n">tnapi</span><span class="o">-&gt;</span><span class="n">hw_status</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">sblk</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">SD_STATUS_UPDATED</span><span class="p">)</span> <span class="o">||</span>
	    <span class="o">!</span><span class="p">(</span><span class="n">tr32</span><span class="p">(</span><span class="n">TG3PCI_PCISTATE</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">PCISTATE_INT_NOT_ACTIVE</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">tg3_disable_ints</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">IRQ_RETVAL</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">IRQ_RETVAL</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_NET_POLL_CONTROLLER</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">tg3_poll_controller</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">irq_cnt</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">tg3_interrupt</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">irq_vec</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tg3_tx_timeout</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">netif_msg_tx_err</span><span class="p">(</span><span class="n">tp</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">netdev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;transmit timed out, resetting</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">tg3_dump_state</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">tg3_reset_task_schedule</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Test for DMA buffers crossing any 4GB boundaries: 4G, 8G, etc */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">tg3_4g_overflow_test</span><span class="p">(</span><span class="n">dma_addr_t</span> <span class="n">mapping</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">base</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">mapping</span> <span class="o">&amp;</span> <span class="mh">0xffffffff</span><span class="p">;</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">base</span> <span class="o">&gt;</span> <span class="mh">0xffffdcc0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">len</span> <span class="o">+</span> <span class="mi">8</span> <span class="o">&lt;</span> <span class="n">base</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Test for DMA addresses &gt; 40-bit */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">tg3_40bit_overflow_test</span><span class="p">(</span><span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span><span class="p">,</span> <span class="n">dma_addr_t</span> <span class="n">mapping</span><span class="p">,</span>
					  <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#if defined(CONFIG_HIGHMEM) &amp;&amp; (BITS_PER_LONG == 64)</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">40</span><span class="n">BIT_DMA_BUG</span><span class="p">))</span>
		<span class="k">return</span> <span class="p">((</span><span class="n">u64</span><span class="p">)</span> <span class="n">mapping</span> <span class="o">+</span> <span class="n">len</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">40</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#else</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">tg3_tx_set_bd</span><span class="p">(</span><span class="k">struct</span> <span class="n">tg3_tx_buffer_desc</span> <span class="o">*</span><span class="n">txbd</span><span class="p">,</span>
				 <span class="n">dma_addr_t</span> <span class="n">mapping</span><span class="p">,</span> <span class="n">u32</span> <span class="n">len</span><span class="p">,</span> <span class="n">u32</span> <span class="n">flags</span><span class="p">,</span>
				 <span class="n">u32</span> <span class="n">mss</span><span class="p">,</span> <span class="n">u32</span> <span class="n">vlan</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">txbd</span><span class="o">-&gt;</span><span class="n">addr_hi</span> <span class="o">=</span> <span class="p">((</span><span class="n">u64</span><span class="p">)</span> <span class="n">mapping</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">);</span>
	<span class="n">txbd</span><span class="o">-&gt;</span><span class="n">addr_lo</span> <span class="o">=</span> <span class="p">((</span><span class="n">u64</span><span class="p">)</span> <span class="n">mapping</span> <span class="o">&amp;</span> <span class="mh">0xffffffff</span><span class="p">);</span>
	<span class="n">txbd</span><span class="o">-&gt;</span><span class="n">len_flags</span> <span class="o">=</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;&lt;</span> <span class="n">TXD_LEN_SHIFT</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="mh">0x0000ffff</span><span class="p">);</span>
	<span class="n">txbd</span><span class="o">-&gt;</span><span class="n">vlan_tag</span> <span class="o">=</span> <span class="p">(</span><span class="n">mss</span> <span class="o">&lt;&lt;</span> <span class="n">TXD_MSS_SHIFT</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">vlan</span> <span class="o">&lt;&lt;</span> <span class="n">TXD_VLAN_TAG_SHIFT</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">tg3_tx_frag_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">tg3_napi</span> <span class="o">*</span><span class="n">tnapi</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">entry</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">budget</span><span class="p">,</span>
			    <span class="n">dma_addr_t</span> <span class="n">map</span><span class="p">,</span> <span class="n">u32</span> <span class="n">len</span><span class="p">,</span> <span class="n">u32</span> <span class="n">flags</span><span class="p">,</span>
			    <span class="n">u32</span> <span class="n">mss</span><span class="p">,</span> <span class="n">u32</span> <span class="n">vlan</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="n">tnapi</span><span class="o">-&gt;</span><span class="n">tp</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">hwbug</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">SHORT_DMA_BUG</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">len</span> <span class="o">&lt;=</span> <span class="mi">8</span><span class="p">)</span>
		<span class="n">hwbug</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tg3_4g_overflow_test</span><span class="p">(</span><span class="n">map</span><span class="p">,</span> <span class="n">len</span><span class="p">))</span>
		<span class="n">hwbug</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tg3_40bit_overflow_test</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">map</span><span class="p">,</span> <span class="n">len</span><span class="p">))</span>
		<span class="n">hwbug</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">dma_limit</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">prvidx</span> <span class="o">=</span> <span class="o">*</span><span class="n">entry</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">tmp_flag</span> <span class="o">=</span> <span class="n">flags</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">TXD_FLAG_END</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">dma_limit</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">budget</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u32</span> <span class="n">frag_len</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">dma_limit</span><span class="p">;</span>
			<span class="n">len</span> <span class="o">-=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">dma_limit</span><span class="p">;</span>

			<span class="cm">/* Avoid the 8byte DMA problem */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;=</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">len</span> <span class="o">+=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">dma_limit</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
				<span class="n">frag_len</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">dma_limit</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">tnapi</span><span class="o">-&gt;</span><span class="n">tx_buffers</span><span class="p">[</span><span class="o">*</span><span class="n">entry</span><span class="p">].</span><span class="n">fragmented</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

			<span class="n">tg3_tx_set_bd</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tnapi</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">[</span><span class="o">*</span><span class="n">entry</span><span class="p">],</span> <span class="n">map</span><span class="p">,</span>
				      <span class="n">frag_len</span><span class="p">,</span> <span class="n">tmp_flag</span><span class="p">,</span> <span class="n">mss</span><span class="p">,</span> <span class="n">vlan</span><span class="p">);</span>
			<span class="o">*</span><span class="n">budget</span> <span class="o">-=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">prvidx</span> <span class="o">=</span> <span class="o">*</span><span class="n">entry</span><span class="p">;</span>
			<span class="o">*</span><span class="n">entry</span> <span class="o">=</span> <span class="n">NEXT_TX</span><span class="p">(</span><span class="o">*</span><span class="n">entry</span><span class="p">);</span>

			<span class="n">map</span> <span class="o">+=</span> <span class="n">frag_len</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">len</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">budget</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">tg3_tx_set_bd</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tnapi</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">[</span><span class="o">*</span><span class="n">entry</span><span class="p">],</span> <span class="n">map</span><span class="p">,</span>
					      <span class="n">len</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="n">mss</span><span class="p">,</span> <span class="n">vlan</span><span class="p">);</span>
				<span class="o">*</span><span class="n">budget</span> <span class="o">-=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="o">*</span><span class="n">entry</span> <span class="o">=</span> <span class="n">NEXT_TX</span><span class="p">(</span><span class="o">*</span><span class="n">entry</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">hwbug</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
				<span class="n">tnapi</span><span class="o">-&gt;</span><span class="n">tx_buffers</span><span class="p">[</span><span class="n">prvidx</span><span class="p">].</span><span class="n">fragmented</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">tg3_tx_set_bd</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tnapi</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">[</span><span class="o">*</span><span class="n">entry</span><span class="p">],</span> <span class="n">map</span><span class="p">,</span>
			      <span class="n">len</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="n">mss</span><span class="p">,</span> <span class="n">vlan</span><span class="p">);</span>
		<span class="o">*</span><span class="n">entry</span> <span class="o">=</span> <span class="n">NEXT_TX</span><span class="p">(</span><span class="o">*</span><span class="n">entry</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">hwbug</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tg3_tx_skb_unmap</span><span class="p">(</span><span class="k">struct</span> <span class="n">tg3_napi</span> <span class="o">*</span><span class="n">tnapi</span><span class="p">,</span> <span class="n">u32</span> <span class="n">entry</span><span class="p">,</span> <span class="kt">int</span> <span class="n">last</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tg3_tx_ring_info</span> <span class="o">*</span><span class="n">txb</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tnapi</span><span class="o">-&gt;</span><span class="n">tx_buffers</span><span class="p">[</span><span class="n">entry</span><span class="p">];</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">txb</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">;</span>
	<span class="n">txb</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">pci_unmap_single</span><span class="p">(</span><span class="n">tnapi</span><span class="o">-&gt;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span>
			 <span class="n">dma_unmap_addr</span><span class="p">(</span><span class="n">txb</span><span class="p">,</span> <span class="n">mapping</span><span class="p">),</span>
			 <span class="n">skb_headlen</span><span class="p">(</span><span class="n">skb</span><span class="p">),</span>
			 <span class="n">PCI_DMA_TODEVICE</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">txb</span><span class="o">-&gt;</span><span class="n">fragmented</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">txb</span><span class="o">-&gt;</span><span class="n">fragmented</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">entry</span> <span class="o">=</span> <span class="n">NEXT_TX</span><span class="p">(</span><span class="n">entry</span><span class="p">);</span>
		<span class="n">txb</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tnapi</span><span class="o">-&gt;</span><span class="n">tx_buffers</span><span class="p">[</span><span class="n">entry</span><span class="p">];</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">last</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">const</span> <span class="n">skb_frag_t</span> <span class="o">*</span><span class="n">frag</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">frags</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="n">entry</span> <span class="o">=</span> <span class="n">NEXT_TX</span><span class="p">(</span><span class="n">entry</span><span class="p">);</span>
		<span class="n">txb</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tnapi</span><span class="o">-&gt;</span><span class="n">tx_buffers</span><span class="p">[</span><span class="n">entry</span><span class="p">];</span>

		<span class="n">pci_unmap_page</span><span class="p">(</span><span class="n">tnapi</span><span class="o">-&gt;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span>
			       <span class="n">dma_unmap_addr</span><span class="p">(</span><span class="n">txb</span><span class="p">,</span> <span class="n">mapping</span><span class="p">),</span>
			       <span class="n">skb_frag_size</span><span class="p">(</span><span class="n">frag</span><span class="p">),</span> <span class="n">PCI_DMA_TODEVICE</span><span class="p">);</span>

		<span class="k">while</span> <span class="p">(</span><span class="n">txb</span><span class="o">-&gt;</span><span class="n">fragmented</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">txb</span><span class="o">-&gt;</span><span class="n">fragmented</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
			<span class="n">entry</span> <span class="o">=</span> <span class="n">NEXT_TX</span><span class="p">(</span><span class="n">entry</span><span class="p">);</span>
			<span class="n">txb</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tnapi</span><span class="o">-&gt;</span><span class="n">tx_buffers</span><span class="p">[</span><span class="n">entry</span><span class="p">];</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* Workaround 4GB and 40-bit hardware DMA bugs. */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">tigon3_dma_hwbug_workaround</span><span class="p">(</span><span class="k">struct</span> <span class="n">tg3_napi</span> <span class="o">*</span><span class="n">tnapi</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">**</span><span class="n">pskb</span><span class="p">,</span>
				       <span class="n">u32</span> <span class="o">*</span><span class="n">entry</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">budget</span><span class="p">,</span>
				       <span class="n">u32</span> <span class="n">base_flags</span><span class="p">,</span> <span class="n">u32</span> <span class="n">mss</span><span class="p">,</span> <span class="n">u32</span> <span class="n">vlan</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="n">tnapi</span><span class="o">-&gt;</span><span class="n">tp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">new_skb</span><span class="p">,</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="o">*</span><span class="n">pskb</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">new_addr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">!=</span> <span class="n">ASIC_REV_5701</span><span class="p">)</span>
		<span class="n">new_skb</span> <span class="o">=</span> <span class="n">skb_copy</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">more_headroom</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">-</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">);</span>

		<span class="n">new_skb</span> <span class="o">=</span> <span class="n">skb_copy_expand</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span>
					  <span class="n">skb_headroom</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="o">+</span> <span class="n">more_headroom</span><span class="p">,</span>
					  <span class="n">skb_tailroom</span><span class="p">(</span><span class="n">skb</span><span class="p">),</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">new_skb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* New SKB is guaranteed to be linear. */</span>
		<span class="n">new_addr</span> <span class="o">=</span> <span class="n">pci_map_single</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">new_skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">new_skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span>
					  <span class="n">PCI_DMA_TODEVICE</span><span class="p">);</span>
		<span class="cm">/* Make sure the mapping succeeded */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pci_dma_mapping_error</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">new_addr</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">new_skb</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">u32</span> <span class="n">save_entry</span> <span class="o">=</span> <span class="o">*</span><span class="n">entry</span><span class="p">;</span>

			<span class="n">base_flags</span> <span class="o">|=</span> <span class="n">TXD_FLAG_END</span><span class="p">;</span>

			<span class="n">tnapi</span><span class="o">-&gt;</span><span class="n">tx_buffers</span><span class="p">[</span><span class="o">*</span><span class="n">entry</span><span class="p">].</span><span class="n">skb</span> <span class="o">=</span> <span class="n">new_skb</span><span class="p">;</span>
			<span class="n">dma_unmap_addr_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tnapi</span><span class="o">-&gt;</span><span class="n">tx_buffers</span><span class="p">[</span><span class="o">*</span><span class="n">entry</span><span class="p">],</span>
					   <span class="n">mapping</span><span class="p">,</span> <span class="n">new_addr</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">tg3_tx_frag_set</span><span class="p">(</span><span class="n">tnapi</span><span class="p">,</span> <span class="n">entry</span><span class="p">,</span> <span class="n">budget</span><span class="p">,</span> <span class="n">new_addr</span><span class="p">,</span>
					    <span class="n">new_skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">base_flags</span><span class="p">,</span>
					    <span class="n">mss</span><span class="p">,</span> <span class="n">vlan</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">tg3_tx_skb_unmap</span><span class="p">(</span><span class="n">tnapi</span><span class="p">,</span> <span class="n">save_entry</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
				<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">new_skb</span><span class="p">);</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="o">*</span><span class="n">pskb</span> <span class="o">=</span> <span class="n">new_skb</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">netdev_tx_t</span> <span class="n">tg3_start_xmit</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="p">);</span>

<span class="cm">/* Use GSO to workaround a rare TSO bug that may be triggered when the</span>
<span class="cm"> * TSO header is greater than 80 bytes.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">tg3_tso_bug</span><span class="p">(</span><span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">segs</span><span class="p">,</span> <span class="o">*</span><span class="n">nskb</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">frag_cnt_est</span> <span class="o">=</span> <span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">gso_segs</span> <span class="o">*</span> <span class="mi">3</span><span class="p">;</span>

	<span class="cm">/* Estimate the number of fragments in the worst case */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">tg3_tx_avail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&lt;=</span> <span class="n">frag_cnt_est</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

		<span class="cm">/* netif_tx_stop_queue() must be done before checking</span>
<span class="cm">		 * checking tx index in tg3_tx_avail() below, because in</span>
<span class="cm">		 * tg3_tx(), we update tx index before checking for</span>
<span class="cm">		 * netif_tx_queue_stopped().</span>
<span class="cm">		 */</span>
		<span class="n">smp_mb</span><span class="p">();</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tg3_tx_avail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&lt;=</span> <span class="n">frag_cnt_est</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">NETDEV_TX_BUSY</span><span class="p">;</span>

		<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">segs</span> <span class="o">=</span> <span class="n">skb_gso_segment</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">NETIF_F_TSO</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">segs</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">tg3_tso_bug_end</span><span class="p">;</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">nskb</span> <span class="o">=</span> <span class="n">segs</span><span class="p">;</span>
		<span class="n">segs</span> <span class="o">=</span> <span class="n">segs</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
		<span class="n">nskb</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">tg3_start_xmit</span><span class="p">(</span><span class="n">nskb</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">segs</span><span class="p">);</span>

<span class="nl">tg3_tso_bug_end:</span>
	<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">NETDEV_TX_OK</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* hard_start_xmit for devices that have the 4G bug and/or 40-bit bug and</span>
<span class="cm"> * support TG3_FLAG_HW_TSO_1 or firmware TSO only.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">netdev_tx_t</span> <span class="nf">tg3_start_xmit</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">len</span><span class="p">,</span> <span class="n">entry</span><span class="p">,</span> <span class="n">base_flags</span><span class="p">,</span> <span class="n">mss</span><span class="p">,</span> <span class="n">vlan</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">budget</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">would_hit_hwbug</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">mapping</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tg3_napi</span> <span class="o">*</span><span class="n">tnapi</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">netdev_queue</span> <span class="o">*</span><span class="n">txq</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">last</span><span class="p">;</span>

	<span class="n">txq</span> <span class="o">=</span> <span class="n">netdev_get_tx_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">skb_get_queue_mapping</span><span class="p">(</span><span class="n">skb</span><span class="p">));</span>
	<span class="n">tnapi</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">[</span><span class="n">skb_get_queue_mapping</span><span class="p">(</span><span class="n">skb</span><span class="p">)];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">ENABLE_TSS</span><span class="p">))</span>
		<span class="n">tnapi</span><span class="o">++</span><span class="p">;</span>

	<span class="n">budget</span> <span class="o">=</span> <span class="n">tg3_tx_avail</span><span class="p">(</span><span class="n">tnapi</span><span class="p">);</span>

	<span class="cm">/* We are running in BH disabled context with netif_tx_lock</span>
<span class="cm">	 * and TX reclaim runs via tp-&gt;napi.poll inside of a software</span>
<span class="cm">	 * interrupt.  Furthermore, IRQ processing runs lockless so we have</span>
<span class="cm">	 * no IRQ context deadlocks to worry about either.  Rejoice!</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">budget</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">nr_frags</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">netif_tx_queue_stopped</span><span class="p">(</span><span class="n">txq</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">netif_tx_stop_queue</span><span class="p">(</span><span class="n">txq</span><span class="p">);</span>

			<span class="cm">/* This is a hard error, log it. */</span>
			<span class="n">netdev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
				   <span class="s">&quot;BUG! Tx Ring full when queue awake!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="n">NETDEV_TX_BUSY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">entry</span> <span class="o">=</span> <span class="n">tnapi</span><span class="o">-&gt;</span><span class="n">tx_prod</span><span class="p">;</span>
	<span class="n">base_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">ip_summed</span> <span class="o">==</span> <span class="n">CHECKSUM_PARTIAL</span><span class="p">)</span>
		<span class="n">base_flags</span> <span class="o">|=</span> <span class="n">TXD_FLAG_TCPUDP_CSUM</span><span class="p">;</span>

	<span class="n">mss</span> <span class="o">=</span> <span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">gso_size</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mss</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">iphdr</span> <span class="o">*</span><span class="n">iph</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">tcp_opt_len</span><span class="p">,</span> <span class="n">hdr_len</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">skb_header_cloned</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="n">pskb_expand_head</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">drop</span><span class="p">;</span>

		<span class="n">iph</span> <span class="o">=</span> <span class="n">ip_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="n">tcp_opt_len</span> <span class="o">=</span> <span class="n">tcp_optlen</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

		<span class="n">hdr_len</span> <span class="o">=</span> <span class="n">skb_transport_offset</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="o">+</span> <span class="n">tcp_hdrlen</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="o">-</span> <span class="n">ETH_HLEN</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb_is_gso_v6</span><span class="p">(</span><span class="n">skb</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">iph</span><span class="o">-&gt;</span><span class="n">check</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">iph</span><span class="o">-&gt;</span><span class="n">tot_len</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">mss</span> <span class="o">+</span> <span class="n">hdr_len</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">((</span><span class="n">ETH_HLEN</span> <span class="o">+</span> <span class="n">hdr_len</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">80</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">TSO_BUG</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">tg3_tso_bug</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>

		<span class="n">base_flags</span> <span class="o">|=</span> <span class="p">(</span><span class="n">TXD_FLAG_CPU_PRE_DMA</span> <span class="o">|</span>
			       <span class="n">TXD_FLAG_CPU_POST_DMA</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">HW_TSO_1</span><span class="p">)</span> <span class="o">||</span>
		    <span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">HW_TSO_2</span><span class="p">)</span> <span class="o">||</span>
		    <span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">HW_TSO_3</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">tcp_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">check</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">base_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">TXD_FLAG_TCPUDP_CSUM</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">tcp_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">check</span> <span class="o">=</span> <span class="o">~</span><span class="n">csum_tcpudp_magic</span><span class="p">(</span><span class="n">iph</span><span class="o">-&gt;</span><span class="n">saddr</span><span class="p">,</span>
								 <span class="n">iph</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
								 <span class="n">IPPROTO_TCP</span><span class="p">,</span>
								 <span class="mi">0</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">HW_TSO_3</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">mss</span> <span class="o">|=</span> <span class="p">(</span><span class="n">hdr_len</span> <span class="o">&amp;</span> <span class="mh">0xc</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">hdr_len</span> <span class="o">&amp;</span> <span class="mh">0x10</span><span class="p">)</span>
				<span class="n">base_flags</span> <span class="o">|=</span> <span class="mh">0x00000010</span><span class="p">;</span>
			<span class="n">base_flags</span> <span class="o">|=</span> <span class="p">(</span><span class="n">hdr_len</span> <span class="o">&amp;</span> <span class="mh">0x3e0</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">HW_TSO_2</span><span class="p">))</span>
			<span class="n">mss</span> <span class="o">|=</span> <span class="n">hdr_len</span> <span class="o">&lt;&lt;</span> <span class="mi">9</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">HW_TSO_1</span><span class="p">)</span> <span class="o">||</span>
			 <span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">ASIC_REV_5705</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tcp_opt_len</span> <span class="o">||</span> <span class="n">iph</span><span class="o">-&gt;</span><span class="n">ihl</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">)</span> <span class="p">{</span>
				<span class="kt">int</span> <span class="n">tsflags</span><span class="p">;</span>

				<span class="n">tsflags</span> <span class="o">=</span> <span class="p">(</span><span class="n">iph</span><span class="o">-&gt;</span><span class="n">ihl</span> <span class="o">-</span> <span class="mi">5</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">tcp_opt_len</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">);</span>
				<span class="n">mss</span> <span class="o">|=</span> <span class="p">(</span><span class="n">tsflags</span> <span class="o">&lt;&lt;</span> <span class="mi">11</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tcp_opt_len</span> <span class="o">||</span> <span class="n">iph</span><span class="o">-&gt;</span><span class="n">ihl</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">)</span> <span class="p">{</span>
				<span class="kt">int</span> <span class="n">tsflags</span><span class="p">;</span>

				<span class="n">tsflags</span> <span class="o">=</span> <span class="p">(</span><span class="n">iph</span><span class="o">-&gt;</span><span class="n">ihl</span> <span class="o">-</span> <span class="mi">5</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">tcp_opt_len</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">);</span>
				<span class="n">base_flags</span> <span class="o">|=</span> <span class="n">tsflags</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">USE_JUMBO_BDFLAG</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">mss</span> <span class="o">&amp;&amp;</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">VLAN_ETH_FRAME_LEN</span><span class="p">)</span>
		<span class="n">base_flags</span> <span class="o">|=</span> <span class="n">TXD_FLAG_JMB_PKT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vlan_tx_tag_present</span><span class="p">(</span><span class="n">skb</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">base_flags</span> <span class="o">|=</span> <span class="n">TXD_FLAG_VLAN</span><span class="p">;</span>
		<span class="n">vlan</span> <span class="o">=</span> <span class="n">vlan_tx_tag_get</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">len</span> <span class="o">=</span> <span class="n">skb_headlen</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

	<span class="n">mapping</span> <span class="o">=</span> <span class="n">pci_map_single</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">PCI_DMA_TODEVICE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pci_dma_mapping_error</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">mapping</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">drop</span><span class="p">;</span>


	<span class="n">tnapi</span><span class="o">-&gt;</span><span class="n">tx_buffers</span><span class="p">[</span><span class="n">entry</span><span class="p">].</span><span class="n">skb</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>
	<span class="n">dma_unmap_addr_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tnapi</span><span class="o">-&gt;</span><span class="n">tx_buffers</span><span class="p">[</span><span class="n">entry</span><span class="p">],</span> <span class="n">mapping</span><span class="p">,</span> <span class="n">mapping</span><span class="p">);</span>

	<span class="n">would_hit_hwbug</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">5701</span><span class="n">_DMA_BUG</span><span class="p">))</span>
		<span class="n">would_hit_hwbug</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tg3_tx_frag_set</span><span class="p">(</span><span class="n">tnapi</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">entry</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">budget</span><span class="p">,</span> <span class="n">mapping</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">base_flags</span> <span class="o">|</span>
			  <span class="p">((</span><span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">nr_frags</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="n">TXD_FLAG_END</span> <span class="o">:</span> <span class="mi">0</span><span class="p">),</span>
			    <span class="n">mss</span><span class="p">,</span> <span class="n">vlan</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">would_hit_hwbug</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">nr_frags</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">tmp_mss</span> <span class="o">=</span> <span class="n">mss</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">HW_TSO_1</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="o">!</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">HW_TSO_2</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="o">!</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">HW_TSO_3</span><span class="p">))</span>
			<span class="n">tmp_mss</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="cm">/* Now loop through additional data</span>
<span class="cm">		 * fragments, and queue them.</span>
<span class="cm">		 */</span>
		<span class="n">last</span> <span class="o">=</span> <span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">nr_frags</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">last</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">skb_frag_t</span> <span class="o">*</span><span class="n">frag</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">frags</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

			<span class="n">len</span> <span class="o">=</span> <span class="n">skb_frag_size</span><span class="p">(</span><span class="n">frag</span><span class="p">);</span>
			<span class="n">mapping</span> <span class="o">=</span> <span class="n">skb_frag_dma_map</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">frag</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
						   <span class="n">len</span><span class="p">,</span> <span class="n">DMA_TO_DEVICE</span><span class="p">);</span>

			<span class="n">tnapi</span><span class="o">-&gt;</span><span class="n">tx_buffers</span><span class="p">[</span><span class="n">entry</span><span class="p">].</span><span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">dma_unmap_addr_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tnapi</span><span class="o">-&gt;</span><span class="n">tx_buffers</span><span class="p">[</span><span class="n">entry</span><span class="p">],</span> <span class="n">mapping</span><span class="p">,</span>
					   <span class="n">mapping</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dma_mapping_error</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">mapping</span><span class="p">))</span>
				<span class="k">goto</span> <span class="n">dma_error</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">budget</span> <span class="o">||</span>
			    <span class="n">tg3_tx_frag_set</span><span class="p">(</span><span class="n">tnapi</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">entry</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">budget</span><span class="p">,</span> <span class="n">mapping</span><span class="p">,</span>
					    <span class="n">len</span><span class="p">,</span> <span class="n">base_flags</span> <span class="o">|</span>
					    <span class="p">((</span><span class="n">i</span> <span class="o">==</span> <span class="n">last</span><span class="p">)</span> <span class="o">?</span> <span class="n">TXD_FLAG_END</span> <span class="o">:</span> <span class="mi">0</span><span class="p">),</span>
					    <span class="n">tmp_mss</span><span class="p">,</span> <span class="n">vlan</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">would_hit_hwbug</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">would_hit_hwbug</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tg3_tx_skb_unmap</span><span class="p">(</span><span class="n">tnapi</span><span class="p">,</span> <span class="n">tnapi</span><span class="o">-&gt;</span><span class="n">tx_prod</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>

		<span class="cm">/* If the workaround fails due to memory/mapping</span>
<span class="cm">		 * failure, silently drop this packet.</span>
<span class="cm">		 */</span>
		<span class="n">entry</span> <span class="o">=</span> <span class="n">tnapi</span><span class="o">-&gt;</span><span class="n">tx_prod</span><span class="p">;</span>
		<span class="n">budget</span> <span class="o">=</span> <span class="n">tg3_tx_avail</span><span class="p">(</span><span class="n">tnapi</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tigon3_dma_hwbug_workaround</span><span class="p">(</span><span class="n">tnapi</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">skb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">entry</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">budget</span><span class="p">,</span>
						<span class="n">base_flags</span><span class="p">,</span> <span class="n">mss</span><span class="p">,</span> <span class="n">vlan</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">drop_nofree</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">skb_tx_timestamp</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">netdev_tx_sent_queue</span><span class="p">(</span><span class="n">txq</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>

	<span class="cm">/* Sync BD data before updating mailbox */</span>
	<span class="n">wmb</span><span class="p">();</span>

	<span class="cm">/* Packets are ready, update Tx producer idx local and on card. */</span>
	<span class="n">tw32_tx_mbox</span><span class="p">(</span><span class="n">tnapi</span><span class="o">-&gt;</span><span class="n">prodmbox</span><span class="p">,</span> <span class="n">entry</span><span class="p">);</span>

	<span class="n">tnapi</span><span class="o">-&gt;</span><span class="n">tx_prod</span> <span class="o">=</span> <span class="n">entry</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">tg3_tx_avail</span><span class="p">(</span><span class="n">tnapi</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="n">MAX_SKB_FRAGS</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">netif_tx_stop_queue</span><span class="p">(</span><span class="n">txq</span><span class="p">);</span>

		<span class="cm">/* netif_tx_stop_queue() must be done before checking</span>
<span class="cm">		 * checking tx index in tg3_tx_avail() below, because in</span>
<span class="cm">		 * tg3_tx(), we update tx index before checking for</span>
<span class="cm">		 * netif_tx_queue_stopped().</span>
<span class="cm">		 */</span>
		<span class="n">smp_mb</span><span class="p">();</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tg3_tx_avail</span><span class="p">(</span><span class="n">tnapi</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">TG3_TX_WAKEUP_THRESH</span><span class="p">(</span><span class="n">tnapi</span><span class="p">))</span>
			<span class="n">netif_tx_wake_queue</span><span class="p">(</span><span class="n">txq</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">mmiowb</span><span class="p">();</span>
	<span class="k">return</span> <span class="n">NETDEV_TX_OK</span><span class="p">;</span>

<span class="nl">dma_error:</span>
	<span class="n">tg3_tx_skb_unmap</span><span class="p">(</span><span class="n">tnapi</span><span class="p">,</span> <span class="n">tnapi</span><span class="o">-&gt;</span><span class="n">tx_prod</span><span class="p">,</span> <span class="o">--</span><span class="n">i</span><span class="p">);</span>
	<span class="n">tnapi</span><span class="o">-&gt;</span><span class="n">tx_buffers</span><span class="p">[</span><span class="n">tnapi</span><span class="o">-&gt;</span><span class="n">tx_prod</span><span class="p">].</span><span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="nl">drop:</span>
	<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
<span class="nl">drop_nofree:</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">tx_dropped</span><span class="o">++</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">NETDEV_TX_OK</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tg3_mac_loopback</span><span class="p">(</span><span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span><span class="p">,</span> <span class="n">bool</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">enable</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">mac_mode</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">MAC_MODE_HALF_DUPLEX</span> <span class="o">|</span>
				  <span class="n">MAC_MODE_PORT_MODE_MASK</span><span class="p">);</span>

		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">mac_mode</span> <span class="o">|=</span> <span class="n">MAC_MODE_PORT_INT_LPBACK</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">5705</span><span class="n">_PLUS</span><span class="p">))</span>
			<span class="n">tp</span><span class="o">-&gt;</span><span class="n">mac_mode</span> <span class="o">|=</span> <span class="n">MAC_MODE_LINK_POLARITY</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">phy_flags</span> <span class="o">&amp;</span> <span class="n">TG3_PHYFLG_10_100_ONLY</span><span class="p">)</span>
			<span class="n">tp</span><span class="o">-&gt;</span><span class="n">mac_mode</span> <span class="o">|=</span> <span class="n">MAC_MODE_PORT_MODE_MII</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">tp</span><span class="o">-&gt;</span><span class="n">mac_mode</span> <span class="o">|=</span> <span class="n">MAC_MODE_PORT_MODE_GMII</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">mac_mode</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MAC_MODE_PORT_INT_LPBACK</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">5705</span><span class="n">_PLUS</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">phy_flags</span> <span class="o">&amp;</span> <span class="n">TG3_PHYFLG_PHY_SERDES</span><span class="p">)</span> <span class="o">||</span>
		    <span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">ASIC_REV_5700</span><span class="p">)</span>
			<span class="n">tp</span><span class="o">-&gt;</span><span class="n">mac_mode</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MAC_MODE_LINK_POLARITY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">tw32</span><span class="p">(</span><span class="n">MAC_MODE</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">mac_mode</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">40</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tg3_phy_lpbk_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span><span class="p">,</span> <span class="n">u32</span> <span class="n">speed</span><span class="p">,</span> <span class="n">bool</span> <span class="n">extlpbk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">,</span> <span class="n">bmcr</span><span class="p">,</span> <span class="n">mac_mode</span><span class="p">,</span> <span class="n">ptest</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">tg3_phy_toggle_apd</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
	<span class="n">tg3_phy_toggle_automdix</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">extlpbk</span> <span class="o">&amp;&amp;</span> <span class="n">tg3_phy_set_extloopbk</span><span class="p">(</span><span class="n">tp</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="n">bmcr</span> <span class="o">=</span> <span class="n">BMCR_FULLDPLX</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">speed</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SPEED_10</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SPEED_100</span>:
		<span class="n">bmcr</span> <span class="o">|=</span> <span class="n">BMCR_SPEED100</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SPEED_1000</span>:
	<span class="nl">default:</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">phy_flags</span> <span class="o">&amp;</span> <span class="n">TG3_PHYFLG_IS_FET</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">speed</span> <span class="o">=</span> <span class="n">SPEED_100</span><span class="p">;</span>
			<span class="n">bmcr</span> <span class="o">|=</span> <span class="n">BMCR_SPEED100</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">speed</span> <span class="o">=</span> <span class="n">SPEED_1000</span><span class="p">;</span>
			<span class="n">bmcr</span> <span class="o">|=</span> <span class="n">BMCR_SPEED1000</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">extlpbk</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">phy_flags</span> <span class="o">&amp;</span> <span class="n">TG3_PHYFLG_IS_FET</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">tg3_readphy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">MII_CTRL1000</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
			<span class="n">val</span> <span class="o">|=</span> <span class="n">CTL1000_AS_MASTER</span> <span class="o">|</span>
			       <span class="n">CTL1000_ENABLE_MASTER</span><span class="p">;</span>
			<span class="n">tg3_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">MII_CTRL1000</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">ptest</span> <span class="o">=</span> <span class="n">MII_TG3_FET_PTEST_TRIM_SEL</span> <span class="o">|</span>
				<span class="n">MII_TG3_FET_PTEST_TRIM_2</span><span class="p">;</span>
			<span class="n">tg3_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">MII_TG3_FET_PTEST</span><span class="p">,</span> <span class="n">ptest</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">bmcr</span> <span class="o">|=</span> <span class="n">BMCR_LOOPBACK</span><span class="p">;</span>

	<span class="n">tg3_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">MII_BMCR</span><span class="p">,</span> <span class="n">bmcr</span><span class="p">);</span>

	<span class="cm">/* The write needs to be flushed for the FETs */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">phy_flags</span> <span class="o">&amp;</span> <span class="n">TG3_PHYFLG_IS_FET</span><span class="p">)</span>
		<span class="n">tg3_readphy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">MII_BMCR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bmcr</span><span class="p">);</span>

	<span class="n">udelay</span><span class="p">(</span><span class="mi">40</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">phy_flags</span> <span class="o">&amp;</span> <span class="n">TG3_PHYFLG_IS_FET</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">ASIC_REV_5785</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tg3_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">MII_TG3_FET_PTEST</span><span class="p">,</span> <span class="n">ptest</span> <span class="o">|</span>
			     <span class="n">MII_TG3_FET_PTEST_FRC_TX_LINK</span> <span class="o">|</span>
			     <span class="n">MII_TG3_FET_PTEST_FRC_TX_LOCK</span><span class="p">);</span>

		<span class="cm">/* The write needs to be flushed for the AC131 */</span>
		<span class="n">tg3_readphy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">MII_TG3_FET_PTEST</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Reset to prevent losing 1st rx packet intermittently */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">phy_flags</span> <span class="o">&amp;</span> <span class="n">TG3_PHYFLG_MII_SERDES</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">5780</span><span class="n">_CLASS</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">tw32_f</span><span class="p">(</span><span class="n">MAC_RX_MODE</span><span class="p">,</span> <span class="n">RX_MODE_RESET</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
		<span class="n">tw32_f</span><span class="p">(</span><span class="n">MAC_RX_MODE</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">rx_mode</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">mac_mode</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">mac_mode</span> <span class="o">&amp;</span>
		   <span class="o">~</span><span class="p">(</span><span class="n">MAC_MODE_PORT_MODE_MASK</span> <span class="o">|</span> <span class="n">MAC_MODE_HALF_DUPLEX</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">speed</span> <span class="o">==</span> <span class="n">SPEED_1000</span><span class="p">)</span>
		<span class="n">mac_mode</span> <span class="o">|=</span> <span class="n">MAC_MODE_PORT_MODE_GMII</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">mac_mode</span> <span class="o">|=</span> <span class="n">MAC_MODE_PORT_MODE_MII</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">ASIC_REV_5700</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">masked_phy_id</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">phy_id</span> <span class="o">&amp;</span> <span class="n">TG3_PHY_ID_MASK</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">masked_phy_id</span> <span class="o">==</span> <span class="n">TG3_PHY_ID_BCM5401</span><span class="p">)</span>
			<span class="n">mac_mode</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MAC_MODE_LINK_POLARITY</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">masked_phy_id</span> <span class="o">==</span> <span class="n">TG3_PHY_ID_BCM5411</span><span class="p">)</span>
			<span class="n">mac_mode</span> <span class="o">|=</span> <span class="n">MAC_MODE_LINK_POLARITY</span><span class="p">;</span>

		<span class="n">tg3_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">MII_TG3_EXT_CTRL</span><span class="p">,</span>
			     <span class="n">MII_TG3_EXT_CTRL_LNK3_LED_MODE</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">tw32</span><span class="p">(</span><span class="n">MAC_MODE</span><span class="p">,</span> <span class="n">mac_mode</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">40</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tg3_set_loopback</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">netdev_features_t</span> <span class="n">features</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">NETIF_F_LOOPBACK</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">mac_mode</span> <span class="o">&amp;</span> <span class="n">MAC_MODE_PORT_INT_LPBACK</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span>

		<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="n">tg3_mac_loopback</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
		<span class="n">netif_carrier_on</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="n">netdev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Internal MAC loopback mode enabled.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">mac_mode</span> <span class="o">&amp;</span> <span class="n">MAC_MODE_PORT_INT_LPBACK</span><span class="p">))</span>
			<span class="k">return</span><span class="p">;</span>

		<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="n">tg3_mac_loopback</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
		<span class="cm">/* Force link status check */</span>
		<span class="n">tg3_setup_phy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="n">netdev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Internal MAC loopback mode disabled.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">netdev_features_t</span> <span class="nf">tg3_fix_features</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
	<span class="n">netdev_features_t</span> <span class="n">features</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mtu</span> <span class="o">&gt;</span> <span class="n">ETH_DATA_LEN</span> <span class="o">&amp;&amp;</span> <span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">5780</span><span class="n">_CLASS</span><span class="p">))</span>
		<span class="n">features</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">NETIF_F_ALL_TSO</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">features</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tg3_set_features</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">netdev_features_t</span> <span class="n">features</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">netdev_features_t</span> <span class="n">changed</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">^</span> <span class="n">features</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">changed</span> <span class="o">&amp;</span> <span class="n">NETIF_F_LOOPBACK</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">netif_running</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="n">tg3_set_loopback</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">features</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tg3_rx_prodring_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">tg3_rx_prodring_set</span> <span class="o">*</span><span class="n">tpr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tpr</span> <span class="o">!=</span> <span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">prodring</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">tpr</span><span class="o">-&gt;</span><span class="n">rx_std_cons_idx</span><span class="p">;</span> <span class="n">i</span> <span class="o">!=</span> <span class="n">tpr</span><span class="o">-&gt;</span><span class="n">rx_std_prod_idx</span><span class="p">;</span>
		     <span class="n">i</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">rx_std_ring_mask</span><span class="p">)</span>
			<span class="n">tg3_rx_data_free</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tpr</span><span class="o">-&gt;</span><span class="n">rx_std_buffers</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
					<span class="n">tp</span><span class="o">-&gt;</span><span class="n">rx_pkt_map_sz</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">JUMBO_CAPABLE</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">tpr</span><span class="o">-&gt;</span><span class="n">rx_jmb_cons_idx</span><span class="p">;</span>
			     <span class="n">i</span> <span class="o">!=</span> <span class="n">tpr</span><span class="o">-&gt;</span><span class="n">rx_jmb_prod_idx</span><span class="p">;</span>
			     <span class="n">i</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">rx_jmb_ring_mask</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">tg3_rx_data_free</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tpr</span><span class="o">-&gt;</span><span class="n">rx_jmb_buffers</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
						<span class="n">TG3_RX_JMB_MAP_SZ</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">rx_std_ring_mask</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">tg3_rx_data_free</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tpr</span><span class="o">-&gt;</span><span class="n">rx_std_buffers</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
				<span class="n">tp</span><span class="o">-&gt;</span><span class="n">rx_pkt_map_sz</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">JUMBO_CAPABLE</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">5780</span><span class="n">_CLASS</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">rx_jmb_ring_mask</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">tg3_rx_data_free</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tpr</span><span class="o">-&gt;</span><span class="n">rx_jmb_buffers</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
					<span class="n">TG3_RX_JMB_MAP_SZ</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* Initialize rx rings for packet processing.</span>
<span class="cm"> *</span>
<span class="cm"> * The chip has been shut down and the driver detached from</span>
<span class="cm"> * the networking, so no interrupts or new tx packets will</span>
<span class="cm"> * end up in the driver.  tp-&gt;{tx,}lock are held and thus</span>
<span class="cm"> * we may not sleep.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">tg3_rx_prodring_alloc</span><span class="p">(</span><span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">tg3_rx_prodring_set</span> <span class="o">*</span><span class="n">tpr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">i</span><span class="p">,</span> <span class="n">rx_pkt_dma_sz</span><span class="p">;</span>

	<span class="n">tpr</span><span class="o">-&gt;</span><span class="n">rx_std_cons_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">tpr</span><span class="o">-&gt;</span><span class="n">rx_std_prod_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">tpr</span><span class="o">-&gt;</span><span class="n">rx_jmb_cons_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">tpr</span><span class="o">-&gt;</span><span class="n">rx_jmb_prod_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tpr</span> <span class="o">!=</span> <span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">prodring</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tpr</span><span class="o">-&gt;</span><span class="n">rx_std_buffers</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span>
		       <span class="n">TG3_RX_STD_BUFF_RING_SIZE</span><span class="p">(</span><span class="n">tp</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tpr</span><span class="o">-&gt;</span><span class="n">rx_jmb_buffers</span><span class="p">)</span>
			<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tpr</span><span class="o">-&gt;</span><span class="n">rx_jmb_buffers</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span>
			       <span class="n">TG3_RX_JMB_BUFF_RING_SIZE</span><span class="p">(</span><span class="n">tp</span><span class="p">));</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Zero out all descriptors. */</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">tpr</span><span class="o">-&gt;</span><span class="n">rx_std</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">TG3_RX_STD_RING_BYTES</span><span class="p">(</span><span class="n">tp</span><span class="p">));</span>

	<span class="n">rx_pkt_dma_sz</span> <span class="o">=</span> <span class="n">TG3_RX_STD_DMA_SZ</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">5780</span><span class="n">_CLASS</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">tp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mtu</span> <span class="o">&gt;</span> <span class="n">ETH_DATA_LEN</span><span class="p">)</span>
		<span class="n">rx_pkt_dma_sz</span> <span class="o">=</span> <span class="n">TG3_RX_JMB_DMA_SZ</span><span class="p">;</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">rx_pkt_map_sz</span> <span class="o">=</span> <span class="n">TG3_RX_DMA_TO_MAP_SZ</span><span class="p">(</span><span class="n">rx_pkt_dma_sz</span><span class="p">);</span>

	<span class="cm">/* Initialize invariants of the rings, we only set this</span>
<span class="cm">	 * stuff once.  This works because the card does not</span>
<span class="cm">	 * write into the rx buffer posting rings.</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">rx_std_ring_mask</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">tg3_rx_buffer_desc</span> <span class="o">*</span><span class="n">rxd</span><span class="p">;</span>

		<span class="n">rxd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tpr</span><span class="o">-&gt;</span><span class="n">rx_std</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">rxd</span><span class="o">-&gt;</span><span class="n">idx_len</span> <span class="o">=</span> <span class="n">rx_pkt_dma_sz</span> <span class="o">&lt;&lt;</span> <span class="n">RXD_LEN_SHIFT</span><span class="p">;</span>
		<span class="n">rxd</span><span class="o">-&gt;</span><span class="n">type_flags</span> <span class="o">=</span> <span class="p">(</span><span class="n">RXD_FLAG_END</span> <span class="o">&lt;&lt;</span> <span class="n">RXD_FLAGS_SHIFT</span><span class="p">);</span>
		<span class="n">rxd</span><span class="o">-&gt;</span><span class="n">opaque</span> <span class="o">=</span> <span class="p">(</span><span class="n">RXD_OPAQUE_RING_STD</span> <span class="o">|</span>
			       <span class="p">(</span><span class="n">i</span> <span class="o">&lt;&lt;</span> <span class="n">RXD_OPAQUE_INDEX_SHIFT</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="cm">/* Now allocate fresh SKBs for each rx ring. */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">rx_pending</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">frag_size</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">tg3_alloc_rx_data</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">tpr</span><span class="p">,</span> <span class="n">RXD_OPAQUE_RING_STD</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span>
				      <span class="o">&amp;</span><span class="n">frag_size</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">netdev_warn</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				    <span class="s">&quot;Using a smaller RX standard ring. Only &quot;</span>
				    <span class="s">&quot;%d out of %d buffers were allocated &quot;</span>
				    <span class="s">&quot;successfully</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">rx_pending</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">initfail</span><span class="p">;</span>
			<span class="n">tp</span><span class="o">-&gt;</span><span class="n">rx_pending</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">JUMBO_CAPABLE</span><span class="p">)</span> <span class="o">||</span> <span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">5780</span><span class="n">_CLASS</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">tpr</span><span class="o">-&gt;</span><span class="n">rx_jmb</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">TG3_RX_JMB_RING_BYTES</span><span class="p">(</span><span class="n">tp</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">JUMBO_RING_ENABLE</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">rx_jmb_ring_mask</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">tg3_rx_buffer_desc</span> <span class="o">*</span><span class="n">rxd</span><span class="p">;</span>

		<span class="n">rxd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tpr</span><span class="o">-&gt;</span><span class="n">rx_jmb</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">std</span><span class="p">;</span>
		<span class="n">rxd</span><span class="o">-&gt;</span><span class="n">idx_len</span> <span class="o">=</span> <span class="n">TG3_RX_JMB_DMA_SZ</span> <span class="o">&lt;&lt;</span> <span class="n">RXD_LEN_SHIFT</span><span class="p">;</span>
		<span class="n">rxd</span><span class="o">-&gt;</span><span class="n">type_flags</span> <span class="o">=</span> <span class="p">(</span><span class="n">RXD_FLAG_END</span> <span class="o">&lt;&lt;</span> <span class="n">RXD_FLAGS_SHIFT</span><span class="p">)</span> <span class="o">|</span>
				  <span class="n">RXD_FLAG_JUMBO</span><span class="p">;</span>
		<span class="n">rxd</span><span class="o">-&gt;</span><span class="n">opaque</span> <span class="o">=</span> <span class="p">(</span><span class="n">RXD_OPAQUE_RING_JUMBO</span> <span class="o">|</span>
		       <span class="p">(</span><span class="n">i</span> <span class="o">&lt;&lt;</span> <span class="n">RXD_OPAQUE_INDEX_SHIFT</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">rx_jumbo_pending</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">frag_size</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">tg3_alloc_rx_data</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">tpr</span><span class="p">,</span> <span class="n">RXD_OPAQUE_RING_JUMBO</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span>
				      <span class="o">&amp;</span><span class="n">frag_size</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">netdev_warn</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				    <span class="s">&quot;Using a smaller RX jumbo ring. Only %d &quot;</span>
				    <span class="s">&quot;out of %d buffers were allocated &quot;</span>
				    <span class="s">&quot;successfully</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">rx_jumbo_pending</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">initfail</span><span class="p">;</span>
			<span class="n">tp</span><span class="o">-&gt;</span><span class="n">rx_jumbo_pending</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

<span class="nl">done:</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">initfail:</span>
	<span class="n">tg3_rx_prodring_free</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">tpr</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tg3_rx_prodring_fini</span><span class="p">(</span><span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">tg3_rx_prodring_set</span> <span class="o">*</span><span class="n">tpr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">tpr</span><span class="o">-&gt;</span><span class="n">rx_std_buffers</span><span class="p">);</span>
	<span class="n">tpr</span><span class="o">-&gt;</span><span class="n">rx_std_buffers</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">tpr</span><span class="o">-&gt;</span><span class="n">rx_jmb_buffers</span><span class="p">);</span>
	<span class="n">tpr</span><span class="o">-&gt;</span><span class="n">rx_jmb_buffers</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tpr</span><span class="o">-&gt;</span><span class="n">rx_std</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dma_free_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">TG3_RX_STD_RING_BYTES</span><span class="p">(</span><span class="n">tp</span><span class="p">),</span>
				  <span class="n">tpr</span><span class="o">-&gt;</span><span class="n">rx_std</span><span class="p">,</span> <span class="n">tpr</span><span class="o">-&gt;</span><span class="n">rx_std_mapping</span><span class="p">);</span>
		<span class="n">tpr</span><span class="o">-&gt;</span><span class="n">rx_std</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tpr</span><span class="o">-&gt;</span><span class="n">rx_jmb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dma_free_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">TG3_RX_JMB_RING_BYTES</span><span class="p">(</span><span class="n">tp</span><span class="p">),</span>
				  <span class="n">tpr</span><span class="o">-&gt;</span><span class="n">rx_jmb</span><span class="p">,</span> <span class="n">tpr</span><span class="o">-&gt;</span><span class="n">rx_jmb_mapping</span><span class="p">);</span>
		<span class="n">tpr</span><span class="o">-&gt;</span><span class="n">rx_jmb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tg3_rx_prodring_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">tg3_rx_prodring_set</span> <span class="o">*</span><span class="n">tpr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">tpr</span><span class="o">-&gt;</span><span class="n">rx_std_buffers</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">TG3_RX_STD_BUFF_RING_SIZE</span><span class="p">(</span><span class="n">tp</span><span class="p">),</span>
				      <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tpr</span><span class="o">-&gt;</span><span class="n">rx_std_buffers</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">tpr</span><span class="o">-&gt;</span><span class="n">rx_std</span> <span class="o">=</span> <span class="n">dma_alloc_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					 <span class="n">TG3_RX_STD_RING_BYTES</span><span class="p">(</span><span class="n">tp</span><span class="p">),</span>
					 <span class="o">&amp;</span><span class="n">tpr</span><span class="o">-&gt;</span><span class="n">rx_std_mapping</span><span class="p">,</span>
					 <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tpr</span><span class="o">-&gt;</span><span class="n">rx_std</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">JUMBO_CAPABLE</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">5780</span><span class="n">_CLASS</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">tpr</span><span class="o">-&gt;</span><span class="n">rx_jmb_buffers</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">TG3_RX_JMB_BUFF_RING_SIZE</span><span class="p">(</span><span class="n">tp</span><span class="p">),</span>
					      <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tpr</span><span class="o">-&gt;</span><span class="n">rx_jmb_buffers</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>

		<span class="n">tpr</span><span class="o">-&gt;</span><span class="n">rx_jmb</span> <span class="o">=</span> <span class="n">dma_alloc_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
						 <span class="n">TG3_RX_JMB_RING_BYTES</span><span class="p">(</span><span class="n">tp</span><span class="p">),</span>
						 <span class="o">&amp;</span><span class="n">tpr</span><span class="o">-&gt;</span><span class="n">rx_jmb_mapping</span><span class="p">,</span>
						 <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tpr</span><span class="o">-&gt;</span><span class="n">rx_jmb</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_out:</span>
	<span class="n">tg3_rx_prodring_fini</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">tpr</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Free up pending packets in all rx/tx rings.</span>
<span class="cm"> *</span>
<span class="cm"> * The chip has been shut down and the driver detached from</span>
<span class="cm"> * the networking, so no interrupts or new tx packets will</span>
<span class="cm"> * end up in the driver.  tp-&gt;{tx,}lock is not held and we are not</span>
<span class="cm"> * in an interrupt context and thus may sleep.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">tg3_free_rings</span><span class="p">(</span><span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">irq_cnt</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">tg3_napi</span> <span class="o">*</span><span class="n">tnapi</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>

		<span class="n">tg3_rx_prodring_free</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tnapi</span><span class="o">-&gt;</span><span class="n">prodring</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tnapi</span><span class="o">-&gt;</span><span class="n">tx_buffers</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">TG3_TX_RING_SIZE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="n">tnapi</span><span class="o">-&gt;</span><span class="n">tx_buffers</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">skb</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>

			<span class="n">tg3_tx_skb_unmap</span><span class="p">(</span><span class="n">tnapi</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span>
					 <span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">nr_frags</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>

			<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">netdev_tx_reset_queue</span><span class="p">(</span><span class="n">netdev_get_tx_queue</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">j</span><span class="p">));</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* Initialize tx/rx rings for packet processing.</span>
<span class="cm"> *</span>
<span class="cm"> * The chip has been shut down and the driver detached from</span>
<span class="cm"> * the networking, so no interrupts or new tx packets will</span>
<span class="cm"> * end up in the driver.  tp-&gt;{tx,}lock are held and thus</span>
<span class="cm"> * we may not sleep.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">tg3_init_rings</span><span class="p">(</span><span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* Free up all the SKBs. */</span>
	<span class="n">tg3_free_rings</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">irq_cnt</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">tg3_napi</span> <span class="o">*</span><span class="n">tnapi</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="n">tnapi</span><span class="o">-&gt;</span><span class="n">last_tag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">tnapi</span><span class="o">-&gt;</span><span class="n">last_irq_tag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">tnapi</span><span class="o">-&gt;</span><span class="n">hw_status</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">tnapi</span><span class="o">-&gt;</span><span class="n">hw_status</span><span class="o">-&gt;</span><span class="n">status_tag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">tnapi</span><span class="o">-&gt;</span><span class="n">hw_status</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">TG3_HW_STATUS_SIZE</span><span class="p">);</span>

		<span class="n">tnapi</span><span class="o">-&gt;</span><span class="n">tx_prod</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">tnapi</span><span class="o">-&gt;</span><span class="n">tx_cons</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tnapi</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">)</span>
			<span class="n">memset</span><span class="p">(</span><span class="n">tnapi</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">TG3_TX_RING_BYTES</span><span class="p">);</span>

		<span class="n">tnapi</span><span class="o">-&gt;</span><span class="n">rx_rcb_ptr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tnapi</span><span class="o">-&gt;</span><span class="n">rx_rcb</span><span class="p">)</span>
			<span class="n">memset</span><span class="p">(</span><span class="n">tnapi</span><span class="o">-&gt;</span><span class="n">rx_rcb</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">TG3_RX_RCB_RING_BYTES</span><span class="p">(</span><span class="n">tp</span><span class="p">));</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">tg3_rx_prodring_alloc</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tnapi</span><span class="o">-&gt;</span><span class="n">prodring</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">tg3_free_rings</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Must not be invoked with interrupt sources disabled and</span>
<span class="cm"> * the hardware shutdown down.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">tg3_free_consistent</span><span class="p">(</span><span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">irq_cnt</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">tg3_napi</span> <span class="o">*</span><span class="n">tnapi</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">tnapi</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dma_free_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">TG3_TX_RING_BYTES</span><span class="p">,</span>
				<span class="n">tnapi</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">,</span> <span class="n">tnapi</span><span class="o">-&gt;</span><span class="n">tx_desc_mapping</span><span class="p">);</span>
			<span class="n">tnapi</span><span class="o">-&gt;</span><span class="n">tx_ring</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">kfree</span><span class="p">(</span><span class="n">tnapi</span><span class="o">-&gt;</span><span class="n">tx_buffers</span><span class="p">);</span>
		<span class="n">tnapi</span><span class="o">-&gt;</span><span class="n">tx_buffers</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">tnapi</span><span class="o">-&gt;</span><span class="n">rx_rcb</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dma_free_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					  <span class="n">TG3_RX_RCB_RING_BYTES</span><span class="p">(</span><span class="n">tp</span><span class="p">),</span>
					  <span class="n">tnapi</span><span class="o">-&gt;</span><span class="n">rx_rcb</span><span class="p">,</span>
					  <span class="n">tnapi</span><span class="o">-&gt;</span><span class="n">rx_rcb_mapping</span><span class="p">);</span>
			<span class="n">tnapi</span><span class="o">-&gt;</span><span class="n">rx_rcb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">tg3_rx_prodring_fini</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tnapi</span><span class="o">-&gt;</span><span class="n">prodring</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">tnapi</span><span class="o">-&gt;</span><span class="n">hw_status</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dma_free_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">TG3_HW_STATUS_SIZE</span><span class="p">,</span>
					  <span class="n">tnapi</span><span class="o">-&gt;</span><span class="n">hw_status</span><span class="p">,</span>
					  <span class="n">tnapi</span><span class="o">-&gt;</span><span class="n">status_mapping</span><span class="p">);</span>
			<span class="n">tnapi</span><span class="o">-&gt;</span><span class="n">hw_status</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">hw_stats</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dma_free_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">tg3_hw_stats</span><span class="p">),</span>
				  <span class="n">tp</span><span class="o">-&gt;</span><span class="n">hw_stats</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">stats_mapping</span><span class="p">);</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">hw_stats</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Must not be invoked with interrupt sources disabled and</span>
<span class="cm"> * the hardware shutdown down.  Can sleep.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">tg3_alloc_consistent</span><span class="p">(</span><span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">hw_stats</span> <span class="o">=</span> <span class="n">dma_alloc_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					  <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">tg3_hw_stats</span><span class="p">),</span>
					  <span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">stats_mapping</span><span class="p">,</span>
					  <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">hw_stats</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">hw_stats</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">tg3_hw_stats</span><span class="p">));</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">irq_cnt</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">tg3_napi</span> <span class="o">*</span><span class="n">tnapi</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">struct</span> <span class="n">tg3_hw_status</span> <span class="o">*</span><span class="n">sblk</span><span class="p">;</span>

		<span class="n">tnapi</span><span class="o">-&gt;</span><span class="n">hw_status</span> <span class="o">=</span> <span class="n">dma_alloc_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
						      <span class="n">TG3_HW_STATUS_SIZE</span><span class="p">,</span>
						      <span class="o">&amp;</span><span class="n">tnapi</span><span class="o">-&gt;</span><span class="n">status_mapping</span><span class="p">,</span>
						      <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tnapi</span><span class="o">-&gt;</span><span class="n">hw_status</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>

		<span class="n">memset</span><span class="p">(</span><span class="n">tnapi</span><span class="o">-&gt;</span><span class="n">hw_status</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">TG3_HW_STATUS_SIZE</span><span class="p">);</span>
		<span class="n">sblk</span> <span class="o">=</span> <span class="n">tnapi</span><span class="o">-&gt;</span><span class="n">hw_status</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">tg3_rx_prodring_init</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tnapi</span><span class="o">-&gt;</span><span class="n">prodring</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>

		<span class="cm">/* If multivector TSS is enabled, vector 0 does not handle</span>
<span class="cm">		 * tx interrupts.  Don&#39;t allocate any resources for it.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="n">i</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">ENABLE_TSS</span><span class="p">))</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">i</span> <span class="o">&amp;&amp;</span> <span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">ENABLE_TSS</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">tnapi</span><span class="o">-&gt;</span><span class="n">tx_buffers</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span>
					       <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">tg3_tx_ring_info</span><span class="p">)</span> <span class="o">*</span>
					       <span class="n">TG3_TX_RING_SIZE</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tnapi</span><span class="o">-&gt;</span><span class="n">tx_buffers</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>

			<span class="n">tnapi</span><span class="o">-&gt;</span><span class="n">tx_ring</span> <span class="o">=</span> <span class="n">dma_alloc_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
							    <span class="n">TG3_TX_RING_BYTES</span><span class="p">,</span>
							<span class="o">&amp;</span><span class="n">tnapi</span><span class="o">-&gt;</span><span class="n">tx_desc_mapping</span><span class="p">,</span>
							    <span class="n">GFP_KERNEL</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tnapi</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/*</span>
<span class="cm">		 * When RSS is enabled, the status block format changes</span>
<span class="cm">		 * slightly.  The &quot;rx_jumbo_consumer&quot;, &quot;reserved&quot;,</span>
<span class="cm">		 * and &quot;rx_mini_consumer&quot; members get mapped to the</span>
<span class="cm">		 * other three rx return ring producer indexes.</span>
<span class="cm">		 */</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="nl">default:</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">ENABLE_RSS</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">tnapi</span><span class="o">-&gt;</span><span class="n">rx_rcb_prod_idx</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="cm">/* Fall through */</span>
		<span class="k">case</span> <span class="mi">1</span>:
			<span class="n">tnapi</span><span class="o">-&gt;</span><span class="n">rx_rcb_prod_idx</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sblk</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">rx_producer</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">2</span>:
			<span class="n">tnapi</span><span class="o">-&gt;</span><span class="n">rx_rcb_prod_idx</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sblk</span><span class="o">-&gt;</span><span class="n">rx_jumbo_consumer</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">3</span>:
			<span class="n">tnapi</span><span class="o">-&gt;</span><span class="n">rx_rcb_prod_idx</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sblk</span><span class="o">-&gt;</span><span class="n">reserved</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">4</span>:
			<span class="n">tnapi</span><span class="o">-&gt;</span><span class="n">rx_rcb_prod_idx</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sblk</span><span class="o">-&gt;</span><span class="n">rx_mini_consumer</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/*</span>
<span class="cm">		 * If multivector RSS is enabled, vector 0 does not handle</span>
<span class="cm">		 * rx or tx interrupts.  Don&#39;t allocate any resources for it.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">i</span> <span class="o">&amp;&amp;</span> <span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">ENABLE_RSS</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">tnapi</span><span class="o">-&gt;</span><span class="n">rx_rcb</span> <span class="o">=</span> <span class="n">dma_alloc_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
						   <span class="n">TG3_RX_RCB_RING_BYTES</span><span class="p">(</span><span class="n">tp</span><span class="p">),</span>
						   <span class="o">&amp;</span><span class="n">tnapi</span><span class="o">-&gt;</span><span class="n">rx_rcb_mapping</span><span class="p">,</span>
						   <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tnapi</span><span class="o">-&gt;</span><span class="n">rx_rcb</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>

		<span class="n">memset</span><span class="p">(</span><span class="n">tnapi</span><span class="o">-&gt;</span><span class="n">rx_rcb</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">TG3_RX_RCB_RING_BYTES</span><span class="p">(</span><span class="n">tp</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_out:</span>
	<span class="n">tg3_free_consistent</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define MAX_WAIT_CNT 1000</span>

<span class="cm">/* To stop a block, clear the enable bit and poll till it</span>
<span class="cm"> * clears.  tp-&gt;lock is held.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">tg3_stop_block</span><span class="p">(</span><span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ofs</span><span class="p">,</span> <span class="n">u32</span> <span class="n">enable_bit</span><span class="p">,</span> <span class="kt">int</span> <span class="n">silent</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">5705</span><span class="n">_PLUS</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">ofs</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">RCVLSC_MODE</span>:
		<span class="k">case</span> <span class="n">DMAC_MODE</span>:
		<span class="k">case</span> <span class="n">MBFREE_MODE</span>:
		<span class="k">case</span> <span class="n">BUFMGR_MODE</span>:
		<span class="k">case</span> <span class="n">MEMARB_MODE</span>:
			<span class="cm">/* We can&#39;t enable/disable these bits of the</span>
<span class="cm">			 * 5705/5750, just say success.</span>
<span class="cm">			 */</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

		<span class="nl">default:</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">tr32</span><span class="p">(</span><span class="n">ofs</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">enable_bit</span><span class="p">;</span>
	<span class="n">tw32_f</span><span class="p">(</span><span class="n">ofs</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_WAIT_CNT</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">tr32</span><span class="p">(</span><span class="n">ofs</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">enable_bit</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">MAX_WAIT_CNT</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">silent</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;tg3_stop_block timed out, ofs=%lx enable_bit=%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ofs</span><span class="p">,</span> <span class="n">enable_bit</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* tp-&gt;lock is held. */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">tg3_abort_hw</span><span class="p">(</span><span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">silent</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">tg3_disable_ints</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>

	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">rx_mode</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">RX_MODE_ENABLE</span><span class="p">;</span>
	<span class="n">tw32_f</span><span class="p">(</span><span class="n">MAC_RX_MODE</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">rx_mode</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>

	<span class="n">err</span>  <span class="o">=</span> <span class="n">tg3_stop_block</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">RCVBDI_MODE</span><span class="p">,</span> <span class="n">RCVBDI_MODE_ENABLE</span><span class="p">,</span> <span class="n">silent</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">|=</span> <span class="n">tg3_stop_block</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">RCVLPC_MODE</span><span class="p">,</span> <span class="n">RCVLPC_MODE_ENABLE</span><span class="p">,</span> <span class="n">silent</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">|=</span> <span class="n">tg3_stop_block</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">RCVLSC_MODE</span><span class="p">,</span> <span class="n">RCVLSC_MODE_ENABLE</span><span class="p">,</span> <span class="n">silent</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">|=</span> <span class="n">tg3_stop_block</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">RCVDBDI_MODE</span><span class="p">,</span> <span class="n">RCVDBDI_MODE_ENABLE</span><span class="p">,</span> <span class="n">silent</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">|=</span> <span class="n">tg3_stop_block</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">RCVDCC_MODE</span><span class="p">,</span> <span class="n">RCVDCC_MODE_ENABLE</span><span class="p">,</span> <span class="n">silent</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">|=</span> <span class="n">tg3_stop_block</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">RCVCC_MODE</span><span class="p">,</span> <span class="n">RCVCC_MODE_ENABLE</span><span class="p">,</span> <span class="n">silent</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">|=</span> <span class="n">tg3_stop_block</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">SNDBDS_MODE</span><span class="p">,</span> <span class="n">SNDBDS_MODE_ENABLE</span><span class="p">,</span> <span class="n">silent</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">|=</span> <span class="n">tg3_stop_block</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">SNDBDI_MODE</span><span class="p">,</span> <span class="n">SNDBDI_MODE_ENABLE</span><span class="p">,</span> <span class="n">silent</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">|=</span> <span class="n">tg3_stop_block</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">SNDDATAI_MODE</span><span class="p">,</span> <span class="n">SNDDATAI_MODE_ENABLE</span><span class="p">,</span> <span class="n">silent</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">|=</span> <span class="n">tg3_stop_block</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">RDMAC_MODE</span><span class="p">,</span> <span class="n">RDMAC_MODE_ENABLE</span><span class="p">,</span> <span class="n">silent</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">|=</span> <span class="n">tg3_stop_block</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">SNDDATAC_MODE</span><span class="p">,</span> <span class="n">SNDDATAC_MODE_ENABLE</span><span class="p">,</span> <span class="n">silent</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">|=</span> <span class="n">tg3_stop_block</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">DMAC_MODE</span><span class="p">,</span> <span class="n">DMAC_MODE_ENABLE</span><span class="p">,</span> <span class="n">silent</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">|=</span> <span class="n">tg3_stop_block</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">SNDBDC_MODE</span><span class="p">,</span> <span class="n">SNDBDC_MODE_ENABLE</span><span class="p">,</span> <span class="n">silent</span><span class="p">);</span>

	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">mac_mode</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MAC_MODE_TDE_ENABLE</span><span class="p">;</span>
	<span class="n">tw32_f</span><span class="p">(</span><span class="n">MAC_MODE</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">mac_mode</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">40</span><span class="p">);</span>

	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">tx_mode</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">TX_MODE_ENABLE</span><span class="p">;</span>
	<span class="n">tw32_f</span><span class="p">(</span><span class="n">MAC_TX_MODE</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">tx_mode</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_WAIT_CNT</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">tr32</span><span class="p">(</span><span class="n">MAC_TX_MODE</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">TX_MODE_ENABLE</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="n">MAX_WAIT_CNT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;%s timed out, TX_MODE_ENABLE will not clear &quot;</span>
			<span class="s">&quot;MAC_TX_MODE=%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">tr32</span><span class="p">(</span><span class="n">MAC_TX_MODE</span><span class="p">));</span>
		<span class="n">err</span> <span class="o">|=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">|=</span> <span class="n">tg3_stop_block</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">HOSTCC_MODE</span><span class="p">,</span> <span class="n">HOSTCC_MODE_ENABLE</span><span class="p">,</span> <span class="n">silent</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">|=</span> <span class="n">tg3_stop_block</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">WDMAC_MODE</span><span class="p">,</span> <span class="n">WDMAC_MODE_ENABLE</span><span class="p">,</span> <span class="n">silent</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">|=</span> <span class="n">tg3_stop_block</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">MBFREE_MODE</span><span class="p">,</span> <span class="n">MBFREE_MODE_ENABLE</span><span class="p">,</span> <span class="n">silent</span><span class="p">);</span>

	<span class="n">tw32</span><span class="p">(</span><span class="n">FTQ_RESET</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">);</span>
	<span class="n">tw32</span><span class="p">(</span><span class="n">FTQ_RESET</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">|=</span> <span class="n">tg3_stop_block</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">BUFMGR_MODE</span><span class="p">,</span> <span class="n">BUFMGR_MODE_ENABLE</span><span class="p">,</span> <span class="n">silent</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">|=</span> <span class="n">tg3_stop_block</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">MEMARB_MODE</span><span class="p">,</span> <span class="n">MEMARB_MODE_ENABLE</span><span class="p">,</span> <span class="n">silent</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">irq_cnt</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">tg3_napi</span> <span class="o">*</span><span class="n">tnapi</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tnapi</span><span class="o">-&gt;</span><span class="n">hw_status</span><span class="p">)</span>
			<span class="n">memset</span><span class="p">(</span><span class="n">tnapi</span><span class="o">-&gt;</span><span class="n">hw_status</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">TG3_HW_STATUS_SIZE</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Save PCI command register before chip reset */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">tg3_save_pci_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_COMMAND</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_cmd</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Restore PCI state after chip reset */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">tg3_restore_pci_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>

	<span class="cm">/* Re-enable indirect register accesses. */</span>
	<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">TG3PCI_MISC_HOST_CTRL</span><span class="p">,</span>
			       <span class="n">tp</span><span class="o">-&gt;</span><span class="n">misc_host_ctrl</span><span class="p">);</span>

	<span class="cm">/* Set MAX PCI retry to zero. */</span>
	<span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">PCISTATE_ROM_ENABLE</span> <span class="o">|</span> <span class="n">PCISTATE_ROM_RETRY_ENABLE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span> <span class="o">==</span> <span class="n">CHIPREV_ID_5704_A0</span> <span class="o">&amp;&amp;</span>
	    <span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">PCIX_MODE</span><span class="p">))</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">PCISTATE_RETRY_SAME_DMA</span><span class="p">;</span>
	<span class="cm">/* Allow reads and writes to the APE register and memory space. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">ENABLE_APE</span><span class="p">))</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">PCISTATE_ALLOW_APE_CTLSPC_WR</span> <span class="o">|</span>
		       <span class="n">PCISTATE_ALLOW_APE_SHMEM_WR</span> <span class="o">|</span>
		       <span class="n">PCISTATE_ALLOW_APE_PSPACE_WR</span><span class="p">;</span>
	<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">TG3PCI_PCISTATE</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

	<span class="n">pci_write_config_word</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_COMMAND</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_cmd</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">PCI_EXPRESS</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pci_write_config_byte</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_CACHE_LINE_SIZE</span><span class="p">,</span>
				      <span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_cacheline_sz</span><span class="p">);</span>
		<span class="n">pci_write_config_byte</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_LATENCY_TIMER</span><span class="p">,</span>
				      <span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_lat_timer</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Make sure PCI-X relaxed ordering bit is clear. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">PCIX_MODE</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">u16</span> <span class="n">pcix_cmd</span><span class="p">;</span>

		<span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">pcix_cap</span> <span class="o">+</span> <span class="n">PCI_X_CMD</span><span class="p">,</span>
				     <span class="o">&amp;</span><span class="n">pcix_cmd</span><span class="p">);</span>
		<span class="n">pcix_cmd</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PCI_X_CMD_ERO</span><span class="p">;</span>
		<span class="n">pci_write_config_word</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">pcix_cap</span> <span class="o">+</span> <span class="n">PCI_X_CMD</span><span class="p">,</span>
				      <span class="n">pcix_cmd</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">5780</span><span class="n">_CLASS</span><span class="p">))</span> <span class="p">{</span>

		<span class="cm">/* Chip reset on 5780 will reset MSI enable bit,</span>
<span class="cm">		 * so need to restore it.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">USING_MSI</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">u16</span> <span class="n">ctrl</span><span class="p">;</span>

			<span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span>
					     <span class="n">tp</span><span class="o">-&gt;</span><span class="n">msi_cap</span> <span class="o">+</span> <span class="n">PCI_MSI_FLAGS</span><span class="p">,</span>
					     <span class="o">&amp;</span><span class="n">ctrl</span><span class="p">);</span>
			<span class="n">pci_write_config_word</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span>
					      <span class="n">tp</span><span class="o">-&gt;</span><span class="n">msi_cap</span> <span class="o">+</span> <span class="n">PCI_MSI_FLAGS</span><span class="p">,</span>
					      <span class="n">ctrl</span> <span class="o">|</span> <span class="n">PCI_MSI_FLAGS_ENABLE</span><span class="p">);</span>
			<span class="n">val</span> <span class="o">=</span> <span class="n">tr32</span><span class="p">(</span><span class="n">MSGINT_MODE</span><span class="p">);</span>
			<span class="n">tw32</span><span class="p">(</span><span class="n">MSGINT_MODE</span><span class="p">,</span> <span class="n">val</span> <span class="o">|</span> <span class="n">MSGINT_MODE_ENABLE</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* tp-&gt;lock is held. */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">tg3_chip_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">write_op</span><span class="p">)(</span><span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="p">,</span> <span class="n">u32</span><span class="p">,</span> <span class="n">u32</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">tg3_nvram_lock</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>

	<span class="n">tg3_ape_lock</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">TG3_APE_LOCK_GRC</span><span class="p">);</span>

	<span class="cm">/* No matching tg3_nvram_unlock() after this because</span>
<span class="cm">	 * chip reset below will undo the nvram lock.</span>
<span class="cm">	 */</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">nvram_lock_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* GRC_MISC_CFG core clock reset will clear the memory</span>
<span class="cm">	 * enable bit in PCI register 4 and the MSI enable bit</span>
<span class="cm">	 * on some chips, so we save relevant registers here.</span>
<span class="cm">	 */</span>
	<span class="n">tg3_save_pci_state</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">ASIC_REV_5752</span> <span class="o">||</span>
	    <span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">5755</span><span class="n">_PLUS</span><span class="p">))</span>
		<span class="n">tw32</span><span class="p">(</span><span class="n">GRC_FASTBOOT_PC</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * We must avoid the readl() that normally takes place.</span>
<span class="cm">	 * It locks machines, causes machine checks, and other</span>
<span class="cm">	 * fun things.  So, temporarily disable the 5701</span>
<span class="cm">	 * hardware workaround, while we do the reset.</span>
<span class="cm">	 */</span>
	<span class="n">write_op</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">write32</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">write_op</span> <span class="o">==</span> <span class="n">tg3_write_flush_reg32</span><span class="p">)</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">write32</span> <span class="o">=</span> <span class="n">tg3_write32</span><span class="p">;</span>

	<span class="cm">/* Prevent the irq handler from reading or writing PCI registers</span>
<span class="cm">	 * during chip reset when the memory enable bit in the PCI command</span>
<span class="cm">	 * register may be cleared.  The chip does not generate interrupt</span>
<span class="cm">	 * at this time, but the irq handler may still be called due to irq</span>
<span class="cm">	 * sharing or irqpoll.</span>
<span class="cm">	 */</span>
	<span class="n">tg3_flag_set</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">CHIP_RESETTING</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">irq_cnt</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">tg3_napi</span> <span class="o">*</span><span class="n">tnapi</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tnapi</span><span class="o">-&gt;</span><span class="n">hw_status</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">tnapi</span><span class="o">-&gt;</span><span class="n">hw_status</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">tnapi</span><span class="o">-&gt;</span><span class="n">hw_status</span><span class="o">-&gt;</span><span class="n">status_tag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">tnapi</span><span class="o">-&gt;</span><span class="n">last_tag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">tnapi</span><span class="o">-&gt;</span><span class="n">last_irq_tag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">smp_mb</span><span class="p">();</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">irq_cnt</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">synchronize_irq</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">irq_vec</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">ASIC_REV_57780</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">tr32</span><span class="p">(</span><span class="n">TG3_PCIE_LNKCTL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">TG3_PCIE_LNKCTL_L1_PLL_PD_EN</span><span class="p">;</span>
		<span class="n">tw32</span><span class="p">(</span><span class="n">TG3_PCIE_LNKCTL</span><span class="p">,</span> <span class="n">val</span> <span class="o">|</span> <span class="n">TG3_PCIE_LNKCTL_L1_PLL_PD_DIS</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* do the reset */</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">GRC_MISC_CFG_CORECLK_RESET</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">PCI_EXPRESS</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Force PCIe 1.0a mode */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">!=</span> <span class="n">ASIC_REV_5785</span> <span class="o">&amp;&amp;</span>
		    <span class="o">!</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">57765</span><span class="n">_PLUS</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="n">tr32</span><span class="p">(</span><span class="n">TG3_PCIE_PHY_TSTCTL</span><span class="p">)</span> <span class="o">==</span>
		    <span class="p">(</span><span class="n">TG3_PCIE_PHY_TSTCTL_PCIE10</span> <span class="o">|</span> <span class="n">TG3_PCIE_PHY_TSTCTL_PSCRAM</span><span class="p">))</span>
			<span class="n">tw32</span><span class="p">(</span><span class="n">TG3_PCIE_PHY_TSTCTL</span><span class="p">,</span> <span class="n">TG3_PCIE_PHY_TSTCTL_PSCRAM</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span> <span class="o">!=</span> <span class="n">CHIPREV_ID_5750_A0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">tw32</span><span class="p">(</span><span class="n">GRC_MISC_CFG</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">29</span><span class="p">));</span>
			<span class="n">val</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">29</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">ASIC_REV_5906</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tw32</span><span class="p">(</span><span class="n">VCPU_STATUS</span><span class="p">,</span> <span class="n">tr32</span><span class="p">(</span><span class="n">VCPU_STATUS</span><span class="p">)</span> <span class="o">|</span> <span class="n">VCPU_STATUS_DRV_RESET</span><span class="p">);</span>
		<span class="n">tw32</span><span class="p">(</span><span class="n">GRC_VCPU_EXT_CTRL</span><span class="p">,</span>
		     <span class="n">tr32</span><span class="p">(</span><span class="n">GRC_VCPU_EXT_CTRL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">GRC_VCPU_EXT_CTRL_HALT_CPU</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Manage gphy power for all CPMU absent PCIe devices. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">5705</span><span class="n">_PLUS</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">CPMU_PRESENT</span><span class="p">))</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">GRC_MISC_CFG_KEEP_GPHY_POWER</span><span class="p">;</span>

	<span class="n">tw32</span><span class="p">(</span><span class="n">GRC_MISC_CFG</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

	<span class="cm">/* restore 5701 hardware bug workaround write method */</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">write32</span> <span class="o">=</span> <span class="n">write_op</span><span class="p">;</span>

	<span class="cm">/* Unfortunately, we have to delay before the PCI read back.</span>
<span class="cm">	 * Some 575X chips even will not respond to a PCI cfg access</span>
<span class="cm">	 * when the reset command is given to the chip.</span>
<span class="cm">	 *</span>
<span class="cm">	 * How do these hardware designers expect things to work</span>
<span class="cm">	 * properly if the PCI write is posted for a long period</span>
<span class="cm">	 * of time?  It is always necessary to have some method by</span>
<span class="cm">	 * which a register read back can occur to push the write</span>
<span class="cm">	 * out which does the reset.</span>
<span class="cm">	 *</span>
<span class="cm">	 * For most tg3 variants the trick below was working.</span>
<span class="cm">	 * Ho hum...</span>
<span class="cm">	 */</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">120</span><span class="p">);</span>

	<span class="cm">/* Flush PCI posted writes.  The normal MMIO registers</span>
<span class="cm">	 * are inaccessible at this time so this is the only</span>
<span class="cm">	 * way to make this reliably (actually, this is no longer</span>
<span class="cm">	 * the case, see above).  I tried to use indirect</span>
<span class="cm">	 * register read/write but this upset some 5701 variants.</span>
<span class="cm">	 */</span>
	<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_COMMAND</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>

	<span class="n">udelay</span><span class="p">(</span><span class="mi">120</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">PCI_EXPRESS</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">pci_pcie_cap</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">u16</span> <span class="n">val16</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span> <span class="o">==</span> <span class="n">CHIPREV_ID_5750_A0</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
			<span class="n">u32</span> <span class="n">cfg_val</span><span class="p">;</span>

			<span class="cm">/* Wait for link training to complete.  */</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">5000</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
				<span class="n">udelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>

			<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="mh">0xc4</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cfg_val</span><span class="p">);</span>
			<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="mh">0xc4</span><span class="p">,</span>
					       <span class="n">cfg_val</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">15</span><span class="p">));</span>
		<span class="p">}</span>

		<span class="cm">/* Clear the &quot;no snoop&quot; and &quot;relaxed ordering&quot; bits. */</span>
		<span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span>
				     <span class="n">pci_pcie_cap</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">)</span> <span class="o">+</span> <span class="n">PCI_EXP_DEVCTL</span><span class="p">,</span>
				     <span class="o">&amp;</span><span class="n">val16</span><span class="p">);</span>
		<span class="n">val16</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">PCI_EXP_DEVCTL_RELAX_EN</span> <span class="o">|</span>
			   <span class="n">PCI_EXP_DEVCTL_NOSNOOP_EN</span><span class="p">);</span>
		<span class="cm">/*</span>
<span class="cm">		 * Older PCIe devices only support the 128 byte</span>
<span class="cm">		 * MPS setting.  Enforce the restriction.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">CPMU_PRESENT</span><span class="p">))</span>
			<span class="n">val16</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PCI_EXP_DEVCTL_PAYLOAD</span><span class="p">;</span>
		<span class="n">pci_write_config_word</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span>
				      <span class="n">pci_pcie_cap</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">)</span> <span class="o">+</span> <span class="n">PCI_EXP_DEVCTL</span><span class="p">,</span>
				      <span class="n">val16</span><span class="p">);</span>

		<span class="cm">/* Clear error status */</span>
		<span class="n">pci_write_config_word</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span>
				      <span class="n">pci_pcie_cap</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">)</span> <span class="o">+</span> <span class="n">PCI_EXP_DEVSTA</span><span class="p">,</span>
				      <span class="n">PCI_EXP_DEVSTA_CED</span> <span class="o">|</span>
				      <span class="n">PCI_EXP_DEVSTA_NFED</span> <span class="o">|</span>
				      <span class="n">PCI_EXP_DEVSTA_FED</span> <span class="o">|</span>
				      <span class="n">PCI_EXP_DEVSTA_URD</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">tg3_restore_pci_state</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>

	<span class="n">tg3_flag_clear</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">CHIP_RESETTING</span><span class="p">);</span>
	<span class="n">tg3_flag_clear</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">ERROR_PROCESSED</span><span class="p">);</span>

	<span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">5780</span><span class="n">_CLASS</span><span class="p">))</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">tr32</span><span class="p">(</span><span class="n">MEMARB_MODE</span><span class="p">);</span>
	<span class="n">tw32</span><span class="p">(</span><span class="n">MEMARB_MODE</span><span class="p">,</span> <span class="n">val</span> <span class="o">|</span> <span class="n">MEMARB_MODE_ENABLE</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span> <span class="o">==</span> <span class="n">CHIPREV_ID_5750_A3</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tg3_stop_fw</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
		<span class="n">tw32</span><span class="p">(</span><span class="mh">0x5000</span><span class="p">,</span> <span class="mh">0x400</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">tw32</span><span class="p">(</span><span class="n">GRC_MODE</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">grc_mode</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span> <span class="o">==</span> <span class="n">CHIPREV_ID_5705_A0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">tr32</span><span class="p">(</span><span class="mh">0xc4</span><span class="p">);</span>

		<span class="n">tw32</span><span class="p">(</span><span class="mh">0xc4</span><span class="p">,</span> <span class="n">val</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">15</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">nic_sram_data_cfg</span> <span class="o">&amp;</span> <span class="n">NIC_SRAM_DATA_CFG_MINI_PCI</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
	    <span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">ASIC_REV_5705</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_clock_ctrl</span> <span class="o">|=</span> <span class="n">CLOCK_CTRL_CLKRUN_OENABLE</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span> <span class="o">==</span> <span class="n">CHIPREV_ID_5705_A0</span><span class="p">)</span>
			<span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_clock_ctrl</span> <span class="o">|=</span> <span class="n">CLOCK_CTRL_FORCE_CLKRUN</span><span class="p">;</span>
		<span class="n">tw32</span><span class="p">(</span><span class="n">TG3PCI_CLOCK_CTRL</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_clock_ctrl</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">phy_flags</span> <span class="o">&amp;</span> <span class="n">TG3_PHYFLG_PHY_SERDES</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">mac_mode</span> <span class="o">=</span> <span class="n">MAC_MODE_PORT_MODE_TBI</span><span class="p">;</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">mac_mode</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">phy_flags</span> <span class="o">&amp;</span> <span class="n">TG3_PHYFLG_MII_SERDES</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">mac_mode</span> <span class="o">=</span> <span class="n">MAC_MODE_PORT_MODE_GMII</span><span class="p">;</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">mac_mode</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">tw32_f</span><span class="p">(</span><span class="n">MAC_MODE</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">40</span><span class="p">);</span>

	<span class="n">tg3_ape_unlock</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">TG3_APE_LOCK_GRC</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">tg3_poll_fw</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">tg3_mdio_start</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">PCI_EXPRESS</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span> <span class="o">!=</span> <span class="n">CHIPREV_ID_5750_A0</span> <span class="o">&amp;&amp;</span>
	    <span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">!=</span> <span class="n">ASIC_REV_5785</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">57765</span><span class="n">_PLUS</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">tr32</span><span class="p">(</span><span class="mh">0x7c00</span><span class="p">);</span>

		<span class="n">tw32</span><span class="p">(</span><span class="mh">0x7c00</span><span class="p">,</span> <span class="n">val</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">25</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">ASIC_REV_5720</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">tr32</span><span class="p">(</span><span class="n">TG3_CPMU_CLCK_ORIDE</span><span class="p">);</span>
		<span class="n">tw32</span><span class="p">(</span><span class="n">TG3_CPMU_CLCK_ORIDE</span><span class="p">,</span> <span class="n">val</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">CPMU_CLCK_ORIDE_MAC_ORIDE_EN</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Reprobe ASF enable state.  */</span>
	<span class="n">tg3_flag_clear</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">ENABLE_ASF</span><span class="p">);</span>
	<span class="n">tg3_flag_clear</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">ASF_NEW_HANDSHAKE</span><span class="p">);</span>
	<span class="n">tg3_read_mem</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">NIC_SRAM_DATA_SIG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">==</span> <span class="n">NIC_SRAM_DATA_SIG_MAGIC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">nic_cfg</span><span class="p">;</span>

		<span class="n">tg3_read_mem</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">NIC_SRAM_DATA_CFG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nic_cfg</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">nic_cfg</span> <span class="o">&amp;</span> <span class="n">NIC_SRAM_DATA_CFG_ASF_ENABLE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">tg3_flag_set</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">ENABLE_ASF</span><span class="p">);</span>
			<span class="n">tp</span><span class="o">-&gt;</span><span class="n">last_event_jiffies</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">5750</span><span class="n">_PLUS</span><span class="p">))</span>
				<span class="n">tg3_flag_set</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">ASF_NEW_HANDSHAKE</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">tg3_get_nstats</span><span class="p">(</span><span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rtnl_link_stats64</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">tg3_get_estats</span><span class="p">(</span><span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">tg3_ethtool_stats</span> <span class="o">*</span><span class="p">);</span>

<span class="cm">/* tp-&gt;lock is held. */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">tg3_halt</span><span class="p">(</span><span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">kind</span><span class="p">,</span> <span class="kt">int</span> <span class="n">silent</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">tg3_stop_fw</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>

	<span class="n">tg3_write_sig_pre_reset</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">kind</span><span class="p">);</span>

	<span class="n">tg3_abort_hw</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">silent</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">tg3_chip_reset</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>

	<span class="n">__tg3_set_mac_addr</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">tg3_write_sig_legacy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">kind</span><span class="p">);</span>
	<span class="n">tg3_write_sig_post_reset</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">kind</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">hw_stats</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Save the stats across chip resets... */</span>
		<span class="n">tg3_get_nstats</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">net_stats_prev</span><span class="p">);</span>
		<span class="n">tg3_get_estats</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">estats_prev</span><span class="p">);</span>

		<span class="cm">/* And make sure the next sample is new data */</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">hw_stats</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">tg3_hw_stats</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tg3_set_mac_addr</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="n">addr</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">skip_mac_1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_valid_ether_addr</span><span class="p">(</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">sa_data</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EADDRNOTAVAIL</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">addr</span><span class="o">-&gt;</span><span class="n">sa_data</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">addr_len</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">netif_running</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">ENABLE_ASF</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">addr0_high</span><span class="p">,</span> <span class="n">addr0_low</span><span class="p">,</span> <span class="n">addr1_high</span><span class="p">,</span> <span class="n">addr1_low</span><span class="p">;</span>

		<span class="n">addr0_high</span> <span class="o">=</span> <span class="n">tr32</span><span class="p">(</span><span class="n">MAC_ADDR_0_HIGH</span><span class="p">);</span>
		<span class="n">addr0_low</span> <span class="o">=</span> <span class="n">tr32</span><span class="p">(</span><span class="n">MAC_ADDR_0_LOW</span><span class="p">);</span>
		<span class="n">addr1_high</span> <span class="o">=</span> <span class="n">tr32</span><span class="p">(</span><span class="n">MAC_ADDR_1_HIGH</span><span class="p">);</span>
		<span class="n">addr1_low</span> <span class="o">=</span> <span class="n">tr32</span><span class="p">(</span><span class="n">MAC_ADDR_1_LOW</span><span class="p">);</span>

		<span class="cm">/* Skip MAC addr 1 if ASF is using it. */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">addr0_high</span> <span class="o">!=</span> <span class="n">addr1_high</span> <span class="o">||</span> <span class="n">addr0_low</span> <span class="o">!=</span> <span class="n">addr1_low</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="o">!</span><span class="p">(</span><span class="n">addr1_high</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">addr1_low</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span>
			<span class="n">skip_mac_1</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">__tg3_set_mac_addr</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">skip_mac_1</span><span class="p">);</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* tp-&gt;lock is held. */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">tg3_set_bdinfo</span><span class="p">(</span><span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span><span class="p">,</span> <span class="n">u32</span> <span class="n">bdinfo_addr</span><span class="p">,</span>
			   <span class="n">dma_addr_t</span> <span class="n">mapping</span><span class="p">,</span> <span class="n">u32</span> <span class="n">maxlen_flags</span><span class="p">,</span>
			   <span class="n">u32</span> <span class="n">nic_addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">tg3_write_mem</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span>
		      <span class="p">(</span><span class="n">bdinfo_addr</span> <span class="o">+</span> <span class="n">TG3_BDINFO_HOST_ADDR</span> <span class="o">+</span> <span class="n">TG3_64BIT_REG_HIGH</span><span class="p">),</span>
		      <span class="p">((</span><span class="n">u64</span><span class="p">)</span> <span class="n">mapping</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">));</span>
	<span class="n">tg3_write_mem</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span>
		      <span class="p">(</span><span class="n">bdinfo_addr</span> <span class="o">+</span> <span class="n">TG3_BDINFO_HOST_ADDR</span> <span class="o">+</span> <span class="n">TG3_64BIT_REG_LOW</span><span class="p">),</span>
		      <span class="p">((</span><span class="n">u64</span><span class="p">)</span> <span class="n">mapping</span> <span class="o">&amp;</span> <span class="mh">0xffffffff</span><span class="p">));</span>
	<span class="n">tg3_write_mem</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span>
		      <span class="p">(</span><span class="n">bdinfo_addr</span> <span class="o">+</span> <span class="n">TG3_BDINFO_MAXLEN_FLAGS</span><span class="p">),</span>
		       <span class="n">maxlen_flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">5705</span><span class="n">_PLUS</span><span class="p">))</span>
		<span class="n">tg3_write_mem</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span>
			      <span class="p">(</span><span class="n">bdinfo_addr</span> <span class="o">+</span> <span class="n">TG3_BDINFO_NIC_ADDR</span><span class="p">),</span>
			      <span class="n">nic_addr</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">__tg3_set_coalesce</span><span class="p">(</span><span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ethtool_coalesce</span> <span class="o">*</span><span class="n">ec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">ENABLE_TSS</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">tw32</span><span class="p">(</span><span class="n">HOSTCC_TXCOL_TICKS</span><span class="p">,</span> <span class="n">ec</span><span class="o">-&gt;</span><span class="n">tx_coalesce_usecs</span><span class="p">);</span>
		<span class="n">tw32</span><span class="p">(</span><span class="n">HOSTCC_TXMAX_FRAMES</span><span class="p">,</span> <span class="n">ec</span><span class="o">-&gt;</span><span class="n">tx_max_coalesced_frames</span><span class="p">);</span>
		<span class="n">tw32</span><span class="p">(</span><span class="n">HOSTCC_TXCOAL_MAXF_INT</span><span class="p">,</span> <span class="n">ec</span><span class="o">-&gt;</span><span class="n">tx_max_coalesced_frames_irq</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">tw32</span><span class="p">(</span><span class="n">HOSTCC_TXCOL_TICKS</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">tw32</span><span class="p">(</span><span class="n">HOSTCC_TXMAX_FRAMES</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">tw32</span><span class="p">(</span><span class="n">HOSTCC_TXCOAL_MAXF_INT</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">ENABLE_RSS</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">tw32</span><span class="p">(</span><span class="n">HOSTCC_RXCOL_TICKS</span><span class="p">,</span> <span class="n">ec</span><span class="o">-&gt;</span><span class="n">rx_coalesce_usecs</span><span class="p">);</span>
		<span class="n">tw32</span><span class="p">(</span><span class="n">HOSTCC_RXMAX_FRAMES</span><span class="p">,</span> <span class="n">ec</span><span class="o">-&gt;</span><span class="n">rx_max_coalesced_frames</span><span class="p">);</span>
		<span class="n">tw32</span><span class="p">(</span><span class="n">HOSTCC_RXCOAL_MAXF_INT</span><span class="p">,</span> <span class="n">ec</span><span class="o">-&gt;</span><span class="n">rx_max_coalesced_frames_irq</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">tw32</span><span class="p">(</span><span class="n">HOSTCC_RXCOL_TICKS</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">tw32</span><span class="p">(</span><span class="n">HOSTCC_RXMAX_FRAMES</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">tw32</span><span class="p">(</span><span class="n">HOSTCC_RXCOAL_MAXF_INT</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">5705</span><span class="n">_PLUS</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">val</span> <span class="o">=</span> <span class="n">ec</span><span class="o">-&gt;</span><span class="n">stats_block_coalesce_usecs</span><span class="p">;</span>

		<span class="n">tw32</span><span class="p">(</span><span class="n">HOSTCC_RXCOAL_TICK_INT</span><span class="p">,</span> <span class="n">ec</span><span class="o">-&gt;</span><span class="n">rx_coalesce_usecs_irq</span><span class="p">);</span>
		<span class="n">tw32</span><span class="p">(</span><span class="n">HOSTCC_TXCOAL_TICK_INT</span><span class="p">,</span> <span class="n">ec</span><span class="o">-&gt;</span><span class="n">tx_coalesce_usecs_irq</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">netif_carrier_ok</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">))</span>
			<span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">tw32</span><span class="p">(</span><span class="n">HOSTCC_STAT_COAL_TICKS</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">irq_cnt</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">reg</span><span class="p">;</span>

		<span class="n">reg</span> <span class="o">=</span> <span class="n">HOSTCC_RXCOL_TICKS_VEC1</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="mh">0x18</span><span class="p">;</span>
		<span class="n">tw32</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">ec</span><span class="o">-&gt;</span><span class="n">rx_coalesce_usecs</span><span class="p">);</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="n">HOSTCC_RXMAX_FRAMES_VEC1</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="mh">0x18</span><span class="p">;</span>
		<span class="n">tw32</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">ec</span><span class="o">-&gt;</span><span class="n">rx_max_coalesced_frames</span><span class="p">);</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="n">HOSTCC_RXCOAL_MAXF_INT_VEC1</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="mh">0x18</span><span class="p">;</span>
		<span class="n">tw32</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">ec</span><span class="o">-&gt;</span><span class="n">rx_max_coalesced_frames_irq</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">ENABLE_TSS</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">reg</span> <span class="o">=</span> <span class="n">HOSTCC_TXCOL_TICKS_VEC1</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="mh">0x18</span><span class="p">;</span>
			<span class="n">tw32</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">ec</span><span class="o">-&gt;</span><span class="n">tx_coalesce_usecs</span><span class="p">);</span>
			<span class="n">reg</span> <span class="o">=</span> <span class="n">HOSTCC_TXMAX_FRAMES_VEC1</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="mh">0x18</span><span class="p">;</span>
			<span class="n">tw32</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">ec</span><span class="o">-&gt;</span><span class="n">tx_max_coalesced_frames</span><span class="p">);</span>
			<span class="n">reg</span> <span class="o">=</span> <span class="n">HOSTCC_TXCOAL_MAXF_INT_VEC1</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="mh">0x18</span><span class="p">;</span>
			<span class="n">tw32</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">ec</span><span class="o">-&gt;</span><span class="n">tx_max_coalesced_frames_irq</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">irq_max</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tw32</span><span class="p">(</span><span class="n">HOSTCC_RXCOL_TICKS_VEC1</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="mh">0x18</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">tw32</span><span class="p">(</span><span class="n">HOSTCC_RXMAX_FRAMES_VEC1</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="mh">0x18</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">tw32</span><span class="p">(</span><span class="n">HOSTCC_RXCOAL_MAXF_INT_VEC1</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="mh">0x18</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">ENABLE_TSS</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">tw32</span><span class="p">(</span><span class="n">HOSTCC_TXCOL_TICKS_VEC1</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="mh">0x18</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">tw32</span><span class="p">(</span><span class="n">HOSTCC_TXMAX_FRAMES_VEC1</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="mh">0x18</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">tw32</span><span class="p">(</span><span class="n">HOSTCC_TXCOAL_MAXF_INT_VEC1</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="mh">0x18</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* tp-&gt;lock is held. */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">tg3_rings_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">stblk</span><span class="p">,</span> <span class="n">txrcb</span><span class="p">,</span> <span class="n">rxrcb</span><span class="p">,</span> <span class="n">limit</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tg3_napi</span> <span class="o">*</span><span class="n">tnapi</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

	<span class="cm">/* Disable all transmit rings but the first. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">5705</span><span class="n">_PLUS</span><span class="p">))</span>
		<span class="n">limit</span> <span class="o">=</span> <span class="n">NIC_SRAM_SEND_RCB</span> <span class="o">+</span> <span class="n">TG3_BDINFO_SIZE</span> <span class="o">*</span> <span class="mi">16</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">5717</span><span class="n">_PLUS</span><span class="p">))</span>
		<span class="n">limit</span> <span class="o">=</span> <span class="n">NIC_SRAM_SEND_RCB</span> <span class="o">+</span> <span class="n">TG3_BDINFO_SIZE</span> <span class="o">*</span> <span class="mi">4</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">57765</span><span class="n">_CLASS</span><span class="p">))</span>
		<span class="n">limit</span> <span class="o">=</span> <span class="n">NIC_SRAM_SEND_RCB</span> <span class="o">+</span> <span class="n">TG3_BDINFO_SIZE</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">limit</span> <span class="o">=</span> <span class="n">NIC_SRAM_SEND_RCB</span> <span class="o">+</span> <span class="n">TG3_BDINFO_SIZE</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">txrcb</span> <span class="o">=</span> <span class="n">NIC_SRAM_SEND_RCB</span> <span class="o">+</span> <span class="n">TG3_BDINFO_SIZE</span><span class="p">;</span>
	     <span class="n">txrcb</span> <span class="o">&lt;</span> <span class="n">limit</span><span class="p">;</span> <span class="n">txrcb</span> <span class="o">+=</span> <span class="n">TG3_BDINFO_SIZE</span><span class="p">)</span>
		<span class="n">tg3_write_mem</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">txrcb</span> <span class="o">+</span> <span class="n">TG3_BDINFO_MAXLEN_FLAGS</span><span class="p">,</span>
			      <span class="n">BDINFO_FLAGS_DISABLED</span><span class="p">);</span>


	<span class="cm">/* Disable all receive return rings but the first. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">5717</span><span class="n">_PLUS</span><span class="p">))</span>
		<span class="n">limit</span> <span class="o">=</span> <span class="n">NIC_SRAM_RCV_RET_RCB</span> <span class="o">+</span> <span class="n">TG3_BDINFO_SIZE</span> <span class="o">*</span> <span class="mi">17</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">5705</span><span class="n">_PLUS</span><span class="p">))</span>
		<span class="n">limit</span> <span class="o">=</span> <span class="n">NIC_SRAM_RCV_RET_RCB</span> <span class="o">+</span> <span class="n">TG3_BDINFO_SIZE</span> <span class="o">*</span> <span class="mi">16</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">ASIC_REV_5755</span> <span class="o">||</span>
		 <span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">57765</span><span class="n">_CLASS</span><span class="p">))</span>
		<span class="n">limit</span> <span class="o">=</span> <span class="n">NIC_SRAM_RCV_RET_RCB</span> <span class="o">+</span> <span class="n">TG3_BDINFO_SIZE</span> <span class="o">*</span> <span class="mi">4</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">limit</span> <span class="o">=</span> <span class="n">NIC_SRAM_RCV_RET_RCB</span> <span class="o">+</span> <span class="n">TG3_BDINFO_SIZE</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">rxrcb</span> <span class="o">=</span> <span class="n">NIC_SRAM_RCV_RET_RCB</span> <span class="o">+</span> <span class="n">TG3_BDINFO_SIZE</span><span class="p">;</span>
	     <span class="n">rxrcb</span> <span class="o">&lt;</span> <span class="n">limit</span><span class="p">;</span> <span class="n">rxrcb</span> <span class="o">+=</span> <span class="n">TG3_BDINFO_SIZE</span><span class="p">)</span>
		<span class="n">tg3_write_mem</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">rxrcb</span> <span class="o">+</span> <span class="n">TG3_BDINFO_MAXLEN_FLAGS</span><span class="p">,</span>
			      <span class="n">BDINFO_FLAGS_DISABLED</span><span class="p">);</span>

	<span class="cm">/* Disable interrupts */</span>
	<span class="n">tw32_mailbox_f</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">int_mbox</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">chk_msi_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">last_rx_cons</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">last_tx_cons</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Zero mailbox registers. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">SUPPORT_MSIX</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">irq_max</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">tp</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">tx_prod</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">tp</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">tx_cons</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">ENABLE_TSS</span><span class="p">))</span>
				<span class="n">tw32_mailbox</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">prodmbox</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">tw32_rx_mbox</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">consmbox</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">tw32_mailbox_f</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">int_mbox</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">tp</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">chk_msi_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">tp</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">last_rx_cons</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">tp</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">last_tx_cons</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">ENABLE_TSS</span><span class="p">))</span>
			<span class="n">tw32_mailbox</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">prodmbox</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">tx_prod</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">tx_cons</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">tw32_mailbox</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">prodmbox</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">tw32_rx_mbox</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">consmbox</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Make sure the NIC-based send BD rings are disabled. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">5705</span><span class="n">_PLUS</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">mbox</span> <span class="o">=</span> <span class="n">MAILBOX_SNDNIC_PROD_IDX_0</span> <span class="o">+</span> <span class="n">TG3_64BIT_REG_LOW</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">tw32_tx_mbox</span><span class="p">(</span><span class="n">mbox</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">txrcb</span> <span class="o">=</span> <span class="n">NIC_SRAM_SEND_RCB</span><span class="p">;</span>
	<span class="n">rxrcb</span> <span class="o">=</span> <span class="n">NIC_SRAM_RCV_RET_RCB</span><span class="p">;</span>

	<span class="cm">/* Clear status block in ram. */</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">tnapi</span><span class="o">-&gt;</span><span class="n">hw_status</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">TG3_HW_STATUS_SIZE</span><span class="p">);</span>

	<span class="cm">/* Set status block DMA address */</span>
	<span class="n">tw32</span><span class="p">(</span><span class="n">HOSTCC_STATUS_BLK_HOST_ADDR</span> <span class="o">+</span> <span class="n">TG3_64BIT_REG_HIGH</span><span class="p">,</span>
	     <span class="p">((</span><span class="n">u64</span><span class="p">)</span> <span class="n">tnapi</span><span class="o">-&gt;</span><span class="n">status_mapping</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">));</span>
	<span class="n">tw32</span><span class="p">(</span><span class="n">HOSTCC_STATUS_BLK_HOST_ADDR</span> <span class="o">+</span> <span class="n">TG3_64BIT_REG_LOW</span><span class="p">,</span>
	     <span class="p">((</span><span class="n">u64</span><span class="p">)</span> <span class="n">tnapi</span><span class="o">-&gt;</span><span class="n">status_mapping</span> <span class="o">&amp;</span> <span class="mh">0xffffffff</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tnapi</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tg3_set_bdinfo</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">txrcb</span><span class="p">,</span> <span class="n">tnapi</span><span class="o">-&gt;</span><span class="n">tx_desc_mapping</span><span class="p">,</span>
			       <span class="p">(</span><span class="n">TG3_TX_RING_SIZE</span> <span class="o">&lt;&lt;</span>
				<span class="n">BDINFO_FLAGS_MAXLEN_SHIFT</span><span class="p">),</span>
			       <span class="n">NIC_SRAM_TX_BUFFER_DESC</span><span class="p">);</span>
		<span class="n">txrcb</span> <span class="o">+=</span> <span class="n">TG3_BDINFO_SIZE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tnapi</span><span class="o">-&gt;</span><span class="n">rx_rcb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tg3_set_bdinfo</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">rxrcb</span><span class="p">,</span> <span class="n">tnapi</span><span class="o">-&gt;</span><span class="n">rx_rcb_mapping</span><span class="p">,</span>
			       <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">rx_ret_ring_mask</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span>
				<span class="n">BDINFO_FLAGS_MAXLEN_SHIFT</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">rxrcb</span> <span class="o">+=</span> <span class="n">TG3_BDINFO_SIZE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">stblk</span> <span class="o">=</span> <span class="n">HOSTCC_STATBLCK_RING1</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">tnapi</span><span class="o">++</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">irq_cnt</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">tnapi</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u64</span> <span class="n">mapping</span> <span class="o">=</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">tnapi</span><span class="o">-&gt;</span><span class="n">status_mapping</span><span class="p">;</span>
		<span class="n">tw32</span><span class="p">(</span><span class="n">stblk</span> <span class="o">+</span> <span class="n">TG3_64BIT_REG_HIGH</span><span class="p">,</span> <span class="n">mapping</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">);</span>
		<span class="n">tw32</span><span class="p">(</span><span class="n">stblk</span> <span class="o">+</span> <span class="n">TG3_64BIT_REG_LOW</span><span class="p">,</span> <span class="n">mapping</span> <span class="o">&amp;</span> <span class="mh">0xffffffff</span><span class="p">);</span>

		<span class="cm">/* Clear status block in ram. */</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">tnapi</span><span class="o">-&gt;</span><span class="n">hw_status</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">TG3_HW_STATUS_SIZE</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">tnapi</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">tg3_set_bdinfo</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">txrcb</span><span class="p">,</span> <span class="n">tnapi</span><span class="o">-&gt;</span><span class="n">tx_desc_mapping</span><span class="p">,</span>
				       <span class="p">(</span><span class="n">TG3_TX_RING_SIZE</span> <span class="o">&lt;&lt;</span>
					<span class="n">BDINFO_FLAGS_MAXLEN_SHIFT</span><span class="p">),</span>
				       <span class="n">NIC_SRAM_TX_BUFFER_DESC</span><span class="p">);</span>
			<span class="n">txrcb</span> <span class="o">+=</span> <span class="n">TG3_BDINFO_SIZE</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">tg3_set_bdinfo</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">rxrcb</span><span class="p">,</span> <span class="n">tnapi</span><span class="o">-&gt;</span><span class="n">rx_rcb_mapping</span><span class="p">,</span>
			       <span class="p">((</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">rx_ret_ring_mask</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span>
				<span class="n">BDINFO_FLAGS_MAXLEN_SHIFT</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>

		<span class="n">stblk</span> <span class="o">+=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">rxrcb</span> <span class="o">+=</span> <span class="n">TG3_BDINFO_SIZE</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tg3_setup_rxbd_thresholds</span><span class="p">(</span><span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">,</span> <span class="n">bdcache_maxcnt</span><span class="p">,</span> <span class="n">host_rep_thresh</span><span class="p">,</span> <span class="n">nic_rep_thresh</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">5750</span><span class="n">_PLUS</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">5780</span><span class="n">_CLASS</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">ASIC_REV_5750</span> <span class="o">||</span>
	    <span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">ASIC_REV_5752</span> <span class="o">||</span>
	    <span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">57765</span><span class="n">_PLUS</span><span class="p">))</span>
		<span class="n">bdcache_maxcnt</span> <span class="o">=</span> <span class="n">TG3_SRAM_RX_STD_BDCACHE_SIZE_5700</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">ASIC_REV_5755</span> <span class="o">||</span>
		 <span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">ASIC_REV_5787</span><span class="p">)</span>
		<span class="n">bdcache_maxcnt</span> <span class="o">=</span> <span class="n">TG3_SRAM_RX_STD_BDCACHE_SIZE_5755</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">bdcache_maxcnt</span> <span class="o">=</span> <span class="n">TG3_SRAM_RX_STD_BDCACHE_SIZE_5906</span><span class="p">;</span>

	<span class="n">nic_rep_thresh</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">bdcache_maxcnt</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">rx_std_max_post</span><span class="p">);</span>
	<span class="n">host_rep_thresh</span> <span class="o">=</span> <span class="n">max_t</span><span class="p">(</span><span class="n">u32</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">rx_pending</span> <span class="o">/</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">nic_rep_thresh</span><span class="p">,</span> <span class="n">host_rep_thresh</span><span class="p">);</span>
	<span class="n">tw32</span><span class="p">(</span><span class="n">RCVBDI_STD_THRESH</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">57765</span><span class="n">_PLUS</span><span class="p">))</span>
		<span class="n">tw32</span><span class="p">(</span><span class="n">STD_REPLENISH_LWM</span><span class="p">,</span> <span class="n">bdcache_maxcnt</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">JUMBO_CAPABLE</span><span class="p">)</span> <span class="o">||</span> <span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">5780</span><span class="n">_CLASS</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">bdcache_maxcnt</span> <span class="o">=</span> <span class="n">TG3_SRAM_RX_JMB_BDCACHE_SIZE_5700</span><span class="p">;</span>

	<span class="n">host_rep_thresh</span> <span class="o">=</span> <span class="n">max_t</span><span class="p">(</span><span class="n">u32</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">rx_jumbo_pending</span> <span class="o">/</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">bdcache_maxcnt</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">host_rep_thresh</span><span class="p">);</span>
	<span class="n">tw32</span><span class="p">(</span><span class="n">RCVBDI_JUMBO_THRESH</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">57765</span><span class="n">_PLUS</span><span class="p">))</span>
		<span class="n">tw32</span><span class="p">(</span><span class="n">JMB_REPLENISH_LWM</span><span class="p">,</span> <span class="n">bdcache_maxcnt</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u32</span> <span class="nf">calc_crc</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">reg</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">;</span>

	<span class="n">reg</span> <span class="o">=</span> <span class="mh">0xffffffff</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">reg</span> <span class="o">^=</span> <span class="n">buf</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">k</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">tmp</span> <span class="o">=</span> <span class="n">reg</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">;</span>

			<span class="n">reg</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span><span class="p">)</span>
				<span class="n">reg</span> <span class="o">^=</span> <span class="mh">0xedb88320</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="o">~</span><span class="n">reg</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tg3_set_multi</span><span class="p">(</span><span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">accept_all</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* accept or reject all multicast frames */</span>
	<span class="n">tw32</span><span class="p">(</span><span class="n">MAC_HASH_REG_0</span><span class="p">,</span> <span class="n">accept_all</span> <span class="o">?</span> <span class="mh">0xffffffff</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">tw32</span><span class="p">(</span><span class="n">MAC_HASH_REG_1</span><span class="p">,</span> <span class="n">accept_all</span> <span class="o">?</span> <span class="mh">0xffffffff</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">tw32</span><span class="p">(</span><span class="n">MAC_HASH_REG_2</span><span class="p">,</span> <span class="n">accept_all</span> <span class="o">?</span> <span class="mh">0xffffffff</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">tw32</span><span class="p">(</span><span class="n">MAC_HASH_REG_3</span><span class="p">,</span> <span class="n">accept_all</span> <span class="o">?</span> <span class="mh">0xffffffff</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">__tg3_set_rx_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">rx_mode</span><span class="p">;</span>

	<span class="n">rx_mode</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">rx_mode</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">RX_MODE_PROMISC</span> <span class="o">|</span>
				  <span class="n">RX_MODE_KEEP_VLAN_TAG</span><span class="p">);</span>

<span class="cp">#if !defined(CONFIG_VLAN_8021Q) &amp;&amp; !defined(CONFIG_VLAN_8021Q_MODULE)</span>
	<span class="cm">/* When ASF is in use, we always keep the RX_MODE_KEEP_VLAN_TAG</span>
<span class="cm">	 * flag clear.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">ENABLE_ASF</span><span class="p">))</span>
		<span class="n">rx_mode</span> <span class="o">|=</span> <span class="n">RX_MODE_KEEP_VLAN_TAG</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_PROMISC</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Promiscuous mode. */</span>
		<span class="n">rx_mode</span> <span class="o">|=</span> <span class="n">RX_MODE_PROMISC</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_ALLMULTI</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Accept all multicast. */</span>
		<span class="n">tg3_set_multi</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">netdev_mc_empty</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Reject all multicast. */</span>
		<span class="n">tg3_set_multi</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Accept one or more multicast(s). */</span>
		<span class="k">struct</span> <span class="n">netdev_hw_addr</span> <span class="o">*</span><span class="n">ha</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">mc_filter</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="p">};</span>
		<span class="n">u32</span> <span class="n">regidx</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">bit</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">crc</span><span class="p">;</span>

		<span class="n">netdev_for_each_mc_addr</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">crc</span> <span class="o">=</span> <span class="n">calc_crc</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
			<span class="n">bit</span> <span class="o">=</span> <span class="o">~</span><span class="n">crc</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">;</span>
			<span class="n">regidx</span> <span class="o">=</span> <span class="p">(</span><span class="n">bit</span> <span class="o">&amp;</span> <span class="mh">0x60</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span><span class="p">;</span>
			<span class="n">bit</span> <span class="o">&amp;=</span> <span class="mh">0x1f</span><span class="p">;</span>
			<span class="n">mc_filter</span><span class="p">[</span><span class="n">regidx</span><span class="p">]</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">bit</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">tw32</span><span class="p">(</span><span class="n">MAC_HASH_REG_0</span><span class="p">,</span> <span class="n">mc_filter</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="n">tw32</span><span class="p">(</span><span class="n">MAC_HASH_REG_1</span><span class="p">,</span> <span class="n">mc_filter</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
		<span class="n">tw32</span><span class="p">(</span><span class="n">MAC_HASH_REG_2</span><span class="p">,</span> <span class="n">mc_filter</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
		<span class="n">tw32</span><span class="p">(</span><span class="n">MAC_HASH_REG_3</span><span class="p">,</span> <span class="n">mc_filter</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rx_mode</span> <span class="o">!=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">rx_mode</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">rx_mode</span> <span class="o">=</span> <span class="n">rx_mode</span><span class="p">;</span>
		<span class="n">tw32_f</span><span class="p">(</span><span class="n">MAC_RX_MODE</span><span class="p">,</span> <span class="n">rx_mode</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tg3_rss_init_dflt_indir_tbl</span><span class="p">(</span><span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">TG3_RSS_INDIR_TBL_SIZE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">rss_ind_tbl</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span>
			<span class="n">ethtool_rxfh_indir_default</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">irq_cnt</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tg3_rss_check_indir_tbl</span><span class="p">(</span><span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">SUPPORT_MSIX</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">irq_cnt</span> <span class="o">&lt;=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">rss_ind_tbl</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">rss_ind_tbl</span><span class="p">));</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Validate table against current IRQ count */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">TG3_RSS_INDIR_TBL_SIZE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">rss_ind_tbl</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">irq_cnt</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">!=</span> <span class="n">TG3_RSS_INDIR_TBL_SIZE</span><span class="p">)</span>
		<span class="n">tg3_rss_init_dflt_indir_tbl</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tg3_rss_write_indir_tbl</span><span class="p">(</span><span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">reg</span> <span class="o">=</span> <span class="n">MAC_RSS_INDIR_TBL_0</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">TG3_RSS_INDIR_TBL_SIZE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">val</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">rss_ind_tbl</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">i</span><span class="o">++</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(;</span> <span class="n">i</span> <span class="o">%</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">val</span> <span class="o">&lt;&lt;=</span> <span class="mi">4</span><span class="p">;</span>
			<span class="n">val</span> <span class="o">|=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">rss_ind_tbl</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="p">}</span>
		<span class="n">tw32</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
		<span class="n">reg</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* tp-&gt;lock is held. */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">tg3_reset_hw</span><span class="p">(</span><span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reset_phy</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">,</span> <span class="n">rdmac_mode</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">err</span><span class="p">,</span> <span class="n">limit</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tg3_rx_prodring_set</span> <span class="o">*</span><span class="n">tpr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">prodring</span><span class="p">;</span>

	<span class="n">tg3_disable_ints</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>

	<span class="n">tg3_stop_fw</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>

	<span class="n">tg3_write_sig_pre_reset</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">RESET_KIND_INIT</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">INIT_COMPLETE</span><span class="p">))</span>
		<span class="n">tg3_abort_hw</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* Enable MAC control of LPI */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">phy_flags</span> <span class="o">&amp;</span> <span class="n">TG3_PHYFLG_EEE_CAP</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tw32_f</span><span class="p">(</span><span class="n">TG3_CPMU_EEE_LNKIDL_CTRL</span><span class="p">,</span>
		       <span class="n">TG3_CPMU_EEE_LNKIDL_PCIE_NL0</span> <span class="o">|</span>
		       <span class="n">TG3_CPMU_EEE_LNKIDL_UART_IDL</span><span class="p">);</span>

		<span class="n">tw32_f</span><span class="p">(</span><span class="n">TG3_CPMU_EEE_CTRL</span><span class="p">,</span>
		       <span class="n">TG3_CPMU_EEE_CTRL_EXIT_20_1_US</span><span class="p">);</span>

		<span class="n">val</span> <span class="o">=</span> <span class="n">TG3_CPMU_EEEMD_ERLY_L1_XIT_DET</span> <span class="o">|</span>
		      <span class="n">TG3_CPMU_EEEMD_LPI_IN_TX</span> <span class="o">|</span>
		      <span class="n">TG3_CPMU_EEEMD_LPI_IN_RX</span> <span class="o">|</span>
		      <span class="n">TG3_CPMU_EEEMD_EEE_ENABLE</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">!=</span> <span class="n">ASIC_REV_5717</span><span class="p">)</span>
			<span class="n">val</span> <span class="o">|=</span> <span class="n">TG3_CPMU_EEEMD_SND_IDX_DET_EN</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">ENABLE_APE</span><span class="p">))</span>
			<span class="n">val</span> <span class="o">|=</span> <span class="n">TG3_CPMU_EEEMD_APE_TX_DET_EN</span><span class="p">;</span>

		<span class="n">tw32_f</span><span class="p">(</span><span class="n">TG3_CPMU_EEE_MODE</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

		<span class="n">tw32_f</span><span class="p">(</span><span class="n">TG3_CPMU_EEE_DBTMR1</span><span class="p">,</span>
		       <span class="n">TG3_CPMU_DBTMR1_PCIEXIT_2047US</span> <span class="o">|</span>
		       <span class="n">TG3_CPMU_DBTMR1_LNKIDLE_2047US</span><span class="p">);</span>

		<span class="n">tw32_f</span><span class="p">(</span><span class="n">TG3_CPMU_EEE_DBTMR2</span><span class="p">,</span>
		       <span class="n">TG3_CPMU_DBTMR2_APE_TX_2047US</span> <span class="o">|</span>
		       <span class="n">TG3_CPMU_DBTMR2_TXIDXEQ_2047US</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">reset_phy</span><span class="p">)</span>
		<span class="n">tg3_phy_reset</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">tg3_chip_reset</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">tg3_write_sig_legacy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">RESET_KIND_INIT</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">GET_CHIP_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">CHIPREV_5784_AX</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">tr32</span><span class="p">(</span><span class="n">TG3_CPMU_CTRL</span><span class="p">);</span>
		<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">CPMU_CTRL_LINK_AWARE_MODE</span> <span class="o">|</span> <span class="n">CPMU_CTRL_LINK_IDLE_MODE</span><span class="p">);</span>
		<span class="n">tw32</span><span class="p">(</span><span class="n">TG3_CPMU_CTRL</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

		<span class="n">val</span> <span class="o">=</span> <span class="n">tr32</span><span class="p">(</span><span class="n">TG3_CPMU_LSPD_10MB_CLK</span><span class="p">);</span>
		<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">CPMU_LSPD_10MB_MACCLK_MASK</span><span class="p">;</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">CPMU_LSPD_10MB_MACCLK_6_25</span><span class="p">;</span>
		<span class="n">tw32</span><span class="p">(</span><span class="n">TG3_CPMU_LSPD_10MB_CLK</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

		<span class="n">val</span> <span class="o">=</span> <span class="n">tr32</span><span class="p">(</span><span class="n">TG3_CPMU_LNK_AWARE_PWRMD</span><span class="p">);</span>
		<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">CPMU_LNK_AWARE_MACCLK_MASK</span><span class="p">;</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">CPMU_LNK_AWARE_MACCLK_6_25</span><span class="p">;</span>
		<span class="n">tw32</span><span class="p">(</span><span class="n">TG3_CPMU_LNK_AWARE_PWRMD</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

		<span class="n">val</span> <span class="o">=</span> <span class="n">tr32</span><span class="p">(</span><span class="n">TG3_CPMU_HST_ACC</span><span class="p">);</span>
		<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">CPMU_HST_ACC_MACCLK_MASK</span><span class="p">;</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">CPMU_HST_ACC_MACCLK_6_25</span><span class="p">;</span>
		<span class="n">tw32</span><span class="p">(</span><span class="n">TG3_CPMU_HST_ACC</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">ASIC_REV_57780</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">tr32</span><span class="p">(</span><span class="n">PCIE_PWR_MGMT_THRESH</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">PCIE_PWR_MGMT_L1_THRESH_MSK</span><span class="p">;</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">PCIE_PWR_MGMT_EXT_ASPM_TMR_EN</span> <span class="o">|</span>
		       <span class="n">PCIE_PWR_MGMT_L1_THRESH_4MS</span><span class="p">;</span>
		<span class="n">tw32</span><span class="p">(</span><span class="n">PCIE_PWR_MGMT_THRESH</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

		<span class="n">val</span> <span class="o">=</span> <span class="n">tr32</span><span class="p">(</span><span class="n">TG3_PCIE_EIDLE_DELAY</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">TG3_PCIE_EIDLE_DELAY_MASK</span><span class="p">;</span>
		<span class="n">tw32</span><span class="p">(</span><span class="n">TG3_PCIE_EIDLE_DELAY</span><span class="p">,</span> <span class="n">val</span> <span class="o">|</span> <span class="n">TG3_PCIE_EIDLE_DELAY_13_CLKS</span><span class="p">);</span>

		<span class="n">tw32</span><span class="p">(</span><span class="n">TG3_CORR_ERR_STAT</span><span class="p">,</span> <span class="n">TG3_CORR_ERR_STAT_CLEAR</span><span class="p">);</span>

		<span class="n">val</span> <span class="o">=</span> <span class="n">tr32</span><span class="p">(</span><span class="n">TG3_PCIE_LNKCTL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">TG3_PCIE_LNKCTL_L1_PLL_PD_EN</span><span class="p">;</span>
		<span class="n">tw32</span><span class="p">(</span><span class="n">TG3_PCIE_LNKCTL</span><span class="p">,</span> <span class="n">val</span> <span class="o">|</span> <span class="n">TG3_PCIE_LNKCTL_L1_PLL_PD_DIS</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">L1PLLPD_EN</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">grc_mode</span> <span class="o">=</span> <span class="n">tr32</span><span class="p">(</span><span class="n">GRC_MODE</span><span class="p">);</span>

		<span class="cm">/* Access the lower 1K of PL PCIE block registers. */</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">grc_mode</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">GRC_MODE_PCIE_PORT_MASK</span><span class="p">;</span>
		<span class="n">tw32</span><span class="p">(</span><span class="n">GRC_MODE</span><span class="p">,</span> <span class="n">val</span> <span class="o">|</span> <span class="n">GRC_MODE_PCIE_PL_SEL</span><span class="p">);</span>

		<span class="n">val</span> <span class="o">=</span> <span class="n">tr32</span><span class="p">(</span><span class="n">TG3_PCIE_TLDLPL_PORT</span> <span class="o">+</span> <span class="n">TG3_PCIE_PL_LO_PHYCTL1</span><span class="p">);</span>
		<span class="n">tw32</span><span class="p">(</span><span class="n">TG3_PCIE_TLDLPL_PORT</span> <span class="o">+</span> <span class="n">TG3_PCIE_PL_LO_PHYCTL1</span><span class="p">,</span>
		     <span class="n">val</span> <span class="o">|</span> <span class="n">TG3_PCIE_PL_LO_PHYCTL1_L1PLLPD_EN</span><span class="p">);</span>

		<span class="n">tw32</span><span class="p">(</span><span class="n">GRC_MODE</span><span class="p">,</span> <span class="n">grc_mode</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">57765</span><span class="n">_CLASS</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span> <span class="o">==</span> <span class="n">CHIPREV_ID_57765_A0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u32</span> <span class="n">grc_mode</span> <span class="o">=</span> <span class="n">tr32</span><span class="p">(</span><span class="n">GRC_MODE</span><span class="p">);</span>

			<span class="cm">/* Access the lower 1K of PL PCIE block registers. */</span>
			<span class="n">val</span> <span class="o">=</span> <span class="n">grc_mode</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">GRC_MODE_PCIE_PORT_MASK</span><span class="p">;</span>
			<span class="n">tw32</span><span class="p">(</span><span class="n">GRC_MODE</span><span class="p">,</span> <span class="n">val</span> <span class="o">|</span> <span class="n">GRC_MODE_PCIE_PL_SEL</span><span class="p">);</span>

			<span class="n">val</span> <span class="o">=</span> <span class="n">tr32</span><span class="p">(</span><span class="n">TG3_PCIE_TLDLPL_PORT</span> <span class="o">+</span>
				   <span class="n">TG3_PCIE_PL_LO_PHYCTL5</span><span class="p">);</span>
			<span class="n">tw32</span><span class="p">(</span><span class="n">TG3_PCIE_TLDLPL_PORT</span> <span class="o">+</span> <span class="n">TG3_PCIE_PL_LO_PHYCTL5</span><span class="p">,</span>
			     <span class="n">val</span> <span class="o">|</span> <span class="n">TG3_PCIE_PL_LO_PHYCTL5_DIS_L2CLKREQ</span><span class="p">);</span>

			<span class="n">tw32</span><span class="p">(</span><span class="n">GRC_MODE</span><span class="p">,</span> <span class="n">grc_mode</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">GET_CHIP_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">!=</span> <span class="n">CHIPREV_57765_AX</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u32</span> <span class="n">grc_mode</span> <span class="o">=</span> <span class="n">tr32</span><span class="p">(</span><span class="n">GRC_MODE</span><span class="p">);</span>

			<span class="cm">/* Access the lower 1K of DL PCIE block registers. */</span>
			<span class="n">val</span> <span class="o">=</span> <span class="n">grc_mode</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">GRC_MODE_PCIE_PORT_MASK</span><span class="p">;</span>
			<span class="n">tw32</span><span class="p">(</span><span class="n">GRC_MODE</span><span class="p">,</span> <span class="n">val</span> <span class="o">|</span> <span class="n">GRC_MODE_PCIE_DL_SEL</span><span class="p">);</span>

			<span class="n">val</span> <span class="o">=</span> <span class="n">tr32</span><span class="p">(</span><span class="n">TG3_PCIE_TLDLPL_PORT</span> <span class="o">+</span>
				   <span class="n">TG3_PCIE_DL_LO_FTSMAX</span><span class="p">);</span>
			<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">TG3_PCIE_DL_LO_FTSMAX_MSK</span><span class="p">;</span>
			<span class="n">tw32</span><span class="p">(</span><span class="n">TG3_PCIE_TLDLPL_PORT</span> <span class="o">+</span> <span class="n">TG3_PCIE_DL_LO_FTSMAX</span><span class="p">,</span>
			     <span class="n">val</span> <span class="o">|</span> <span class="n">TG3_PCIE_DL_LO_FTSMAX_VAL</span><span class="p">);</span>

			<span class="n">tw32</span><span class="p">(</span><span class="n">GRC_MODE</span><span class="p">,</span> <span class="n">grc_mode</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">val</span> <span class="o">=</span> <span class="n">tr32</span><span class="p">(</span><span class="n">TG3_CPMU_LSPD_10MB_CLK</span><span class="p">);</span>
		<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">CPMU_LSPD_10MB_MACCLK_MASK</span><span class="p">;</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">CPMU_LSPD_10MB_MACCLK_6_25</span><span class="p">;</span>
		<span class="n">tw32</span><span class="p">(</span><span class="n">TG3_CPMU_LSPD_10MB_CLK</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* This works around an issue with Athlon chipsets on</span>
<span class="cm">	 * B3 tigon3 silicon.  This bit has no effect on any</span>
<span class="cm">	 * other revision.  But do not set this on PCI Express</span>
<span class="cm">	 * chips and don&#39;t even touch the clocks if the CPMU is present.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">CPMU_PRESENT</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">PCI_EXPRESS</span><span class="p">))</span>
			<span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_clock_ctrl</span> <span class="o">|=</span> <span class="n">CLOCK_CTRL_DELAY_PCI_GRANT</span><span class="p">;</span>
		<span class="n">tw32_f</span><span class="p">(</span><span class="n">TG3PCI_CLOCK_CTRL</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_clock_ctrl</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span> <span class="o">==</span> <span class="n">CHIPREV_ID_5704_A0</span> <span class="o">&amp;&amp;</span>
	    <span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">PCIX_MODE</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">tr32</span><span class="p">(</span><span class="n">TG3PCI_PCISTATE</span><span class="p">);</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">PCISTATE_RETRY_SAME_DMA</span><span class="p">;</span>
		<span class="n">tw32</span><span class="p">(</span><span class="n">TG3PCI_PCISTATE</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">ENABLE_APE</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Allow reads and writes to the</span>
<span class="cm">		 * APE register and memory space.</span>
<span class="cm">		 */</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">tr32</span><span class="p">(</span><span class="n">TG3PCI_PCISTATE</span><span class="p">);</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">PCISTATE_ALLOW_APE_CTLSPC_WR</span> <span class="o">|</span>
		       <span class="n">PCISTATE_ALLOW_APE_SHMEM_WR</span> <span class="o">|</span>
		       <span class="n">PCISTATE_ALLOW_APE_PSPACE_WR</span><span class="p">;</span>
		<span class="n">tw32</span><span class="p">(</span><span class="n">TG3PCI_PCISTATE</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">GET_CHIP_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">CHIPREV_5704_BX</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Enable some hw fixes.  */</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">tr32</span><span class="p">(</span><span class="n">TG3PCI_MSI_DATA</span><span class="p">);</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">26</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">28</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">29</span><span class="p">);</span>
		<span class="n">tw32</span><span class="p">(</span><span class="n">TG3PCI_MSI_DATA</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Descriptor ring init may make accesses to the</span>
<span class="cm">	 * NIC SRAM area to setup the TX descriptors, so we</span>
<span class="cm">	 * can only do this after the hardware has been</span>
<span class="cm">	 * successfully reset.</span>
<span class="cm">	 */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">tg3_init_rings</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">57765</span><span class="n">_PLUS</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">tr32</span><span class="p">(</span><span class="n">TG3PCI_DMA_RW_CTRL</span><span class="p">)</span> <span class="o">&amp;</span>
		      <span class="o">~</span><span class="n">DMA_RWCTRL_DIS_CACHE_ALIGNMENT</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span> <span class="o">==</span> <span class="n">CHIPREV_ID_57765_A0</span><span class="p">)</span>
			<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">DMA_RWCTRL_CRDRDR_RDMA_MRRS_MSK</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">57765</span><span class="n">_CLASS</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">!=</span> <span class="n">ASIC_REV_5717</span><span class="p">)</span>
			<span class="n">val</span> <span class="o">|=</span> <span class="n">DMA_RWCTRL_TAGGED_STAT_WA</span><span class="p">;</span>
		<span class="n">tw32</span><span class="p">(</span><span class="n">TG3PCI_DMA_RW_CTRL</span><span class="p">,</span> <span class="n">val</span> <span class="o">|</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">dma_rwctrl</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">!=</span> <span class="n">ASIC_REV_5784</span> <span class="o">&amp;&amp;</span>
		   <span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">!=</span> <span class="n">ASIC_REV_5761</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* This value is determined during the probe time DMA</span>
<span class="cm">		 * engine test, tg3_test_dma.</span>
<span class="cm">		 */</span>
		<span class="n">tw32</span><span class="p">(</span><span class="n">TG3PCI_DMA_RW_CTRL</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">dma_rwctrl</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">grc_mode</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">GRC_MODE_HOST_SENDBDS</span> <span class="o">|</span>
			  <span class="n">GRC_MODE_4X_NIC_SEND_RINGS</span> <span class="o">|</span>
			  <span class="n">GRC_MODE_NO_TX_PHDR_CSUM</span> <span class="o">|</span>
			  <span class="n">GRC_MODE_NO_RX_PHDR_CSUM</span><span class="p">);</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">grc_mode</span> <span class="o">|=</span> <span class="n">GRC_MODE_HOST_SENDBDS</span><span class="p">;</span>

	<span class="cm">/* Pseudo-header checksum is done by hardware logic and not</span>
<span class="cm">	 * the offload processers, so make the chip do the pseudo-</span>
<span class="cm">	 * header checksums on receive.  For transmit it is more</span>
<span class="cm">	 * convenient to do the pseudo-header checksum in software</span>
<span class="cm">	 * as Linux does that on transmit for us in all cases.</span>
<span class="cm">	 */</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">grc_mode</span> <span class="o">|=</span> <span class="n">GRC_MODE_NO_TX_PHDR_CSUM</span><span class="p">;</span>

	<span class="n">tw32</span><span class="p">(</span><span class="n">GRC_MODE</span><span class="p">,</span>
	     <span class="n">tp</span><span class="o">-&gt;</span><span class="n">grc_mode</span> <span class="o">|</span>
	     <span class="p">(</span><span class="n">GRC_MODE_IRQ_ON_MAC_ATTN</span> <span class="o">|</span> <span class="n">GRC_MODE_HOST_STACKUP</span><span class="p">));</span>

	<span class="cm">/* Setup the timer prescalar register.  Clock is always 66Mhz. */</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">tr32</span><span class="p">(</span><span class="n">GRC_MISC_CFG</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0xff</span><span class="p">;</span>
	<span class="n">val</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">65</span> <span class="o">&lt;&lt;</span> <span class="n">GRC_MISC_CFG_PRESCALAR_SHIFT</span><span class="p">);</span>
	<span class="n">tw32</span><span class="p">(</span><span class="n">GRC_MISC_CFG</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

	<span class="cm">/* Initialize MBUF/DESC pool. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">5750</span><span class="n">_PLUS</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Do nothing.  */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">!=</span> <span class="n">ASIC_REV_5705</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tw32</span><span class="p">(</span><span class="n">BUFMGR_MB_POOL_ADDR</span><span class="p">,</span> <span class="n">NIC_SRAM_MBUF_POOL_BASE</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">ASIC_REV_5704</span><span class="p">)</span>
			<span class="n">tw32</span><span class="p">(</span><span class="n">BUFMGR_MB_POOL_SIZE</span><span class="p">,</span> <span class="n">NIC_SRAM_MBUF_POOL_SIZE64</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">tw32</span><span class="p">(</span><span class="n">BUFMGR_MB_POOL_SIZE</span><span class="p">,</span> <span class="n">NIC_SRAM_MBUF_POOL_SIZE96</span><span class="p">);</span>
		<span class="n">tw32</span><span class="p">(</span><span class="n">BUFMGR_DMA_DESC_POOL_ADDR</span><span class="p">,</span> <span class="n">NIC_SRAM_DMA_DESC_POOL_BASE</span><span class="p">);</span>
		<span class="n">tw32</span><span class="p">(</span><span class="n">BUFMGR_DMA_DESC_POOL_SIZE</span><span class="p">,</span> <span class="n">NIC_SRAM_DMA_DESC_POOL_SIZE</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">TSO_CAPABLE</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">fw_len</span><span class="p">;</span>

		<span class="n">fw_len</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">fw_len</span><span class="p">;</span>
		<span class="n">fw_len</span> <span class="o">=</span> <span class="p">(</span><span class="n">fw_len</span> <span class="o">+</span> <span class="p">(</span><span class="mh">0x80</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="mh">0x80</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">tw32</span><span class="p">(</span><span class="n">BUFMGR_MB_POOL_ADDR</span><span class="p">,</span>
		     <span class="n">NIC_SRAM_MBUF_POOL_BASE5705</span> <span class="o">+</span> <span class="n">fw_len</span><span class="p">);</span>
		<span class="n">tw32</span><span class="p">(</span><span class="n">BUFMGR_MB_POOL_SIZE</span><span class="p">,</span>
		     <span class="n">NIC_SRAM_MBUF_POOL_SIZE5705</span> <span class="o">-</span> <span class="n">fw_len</span> <span class="o">-</span> <span class="mh">0xa00</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mtu</span> <span class="o">&lt;=</span> <span class="n">ETH_DATA_LEN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tw32</span><span class="p">(</span><span class="n">BUFMGR_MB_RDMA_LOW_WATER</span><span class="p">,</span>
		     <span class="n">tp</span><span class="o">-&gt;</span><span class="n">bufmgr_config</span><span class="p">.</span><span class="n">mbuf_read_dma_low_water</span><span class="p">);</span>
		<span class="n">tw32</span><span class="p">(</span><span class="n">BUFMGR_MB_MACRX_LOW_WATER</span><span class="p">,</span>
		     <span class="n">tp</span><span class="o">-&gt;</span><span class="n">bufmgr_config</span><span class="p">.</span><span class="n">mbuf_mac_rx_low_water</span><span class="p">);</span>
		<span class="n">tw32</span><span class="p">(</span><span class="n">BUFMGR_MB_HIGH_WATER</span><span class="p">,</span>
		     <span class="n">tp</span><span class="o">-&gt;</span><span class="n">bufmgr_config</span><span class="p">.</span><span class="n">mbuf_high_water</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">tw32</span><span class="p">(</span><span class="n">BUFMGR_MB_RDMA_LOW_WATER</span><span class="p">,</span>
		     <span class="n">tp</span><span class="o">-&gt;</span><span class="n">bufmgr_config</span><span class="p">.</span><span class="n">mbuf_read_dma_low_water_jumbo</span><span class="p">);</span>
		<span class="n">tw32</span><span class="p">(</span><span class="n">BUFMGR_MB_MACRX_LOW_WATER</span><span class="p">,</span>
		     <span class="n">tp</span><span class="o">-&gt;</span><span class="n">bufmgr_config</span><span class="p">.</span><span class="n">mbuf_mac_rx_low_water_jumbo</span><span class="p">);</span>
		<span class="n">tw32</span><span class="p">(</span><span class="n">BUFMGR_MB_HIGH_WATER</span><span class="p">,</span>
		     <span class="n">tp</span><span class="o">-&gt;</span><span class="n">bufmgr_config</span><span class="p">.</span><span class="n">mbuf_high_water_jumbo</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">tw32</span><span class="p">(</span><span class="n">BUFMGR_DMA_LOW_WATER</span><span class="p">,</span>
	     <span class="n">tp</span><span class="o">-&gt;</span><span class="n">bufmgr_config</span><span class="p">.</span><span class="n">dma_low_water</span><span class="p">);</span>
	<span class="n">tw32</span><span class="p">(</span><span class="n">BUFMGR_DMA_HIGH_WATER</span><span class="p">,</span>
	     <span class="n">tp</span><span class="o">-&gt;</span><span class="n">bufmgr_config</span><span class="p">.</span><span class="n">dma_high_water</span><span class="p">);</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">BUFMGR_MODE_ENABLE</span> <span class="o">|</span> <span class="n">BUFMGR_MODE_ATTN_ENABLE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">ASIC_REV_5719</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">BUFMGR_MODE_NO_TX_UNDERRUN</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">ASIC_REV_5717</span> <span class="o">||</span>
	    <span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span> <span class="o">==</span> <span class="n">CHIPREV_ID_5719_A0</span> <span class="o">||</span>
	    <span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span> <span class="o">==</span> <span class="n">CHIPREV_ID_5720_A0</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">BUFMGR_MODE_MBLOW_ATTN_ENAB</span><span class="p">;</span>
	<span class="n">tw32</span><span class="p">(</span><span class="n">BUFMGR_MODE</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">2000</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tr32</span><span class="p">(</span><span class="n">BUFMGR_MODE</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">BUFMGR_MODE_ENABLE</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">2000</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netdev_err</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s cannot enable BUFMGR</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span> <span class="o">==</span> <span class="n">CHIPREV_ID_5906_A1</span><span class="p">)</span>
		<span class="n">tw32</span><span class="p">(</span><span class="n">ISO_PKT_TX</span><span class="p">,</span> <span class="p">(</span><span class="n">tr32</span><span class="p">(</span><span class="n">ISO_PKT_TX</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x3</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x2</span><span class="p">);</span>

	<span class="n">tg3_setup_rxbd_thresholds</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>

	<span class="cm">/* Initialize TG3_BDINFO&#39;s at:</span>
<span class="cm">	 *  RCVDBDI_STD_BD:	standard eth size rx ring</span>
<span class="cm">	 *  RCVDBDI_JUMBO_BD:	jumbo frame rx ring</span>
<span class="cm">	 *  RCVDBDI_MINI_BD:	small frame rx ring (??? does not work)</span>
<span class="cm">	 *</span>
<span class="cm">	 * like so:</span>
<span class="cm">	 *  TG3_BDINFO_HOST_ADDR:	high/low parts of DMA address of ring</span>
<span class="cm">	 *  TG3_BDINFO_MAXLEN_FLAGS:	(rx max buffer size &lt;&lt; 16) |</span>
<span class="cm">	 *                              ring attribute flags</span>
<span class="cm">	 *  TG3_BDINFO_NIC_ADDR:	location of descriptors in nic SRAM</span>
<span class="cm">	 *</span>
<span class="cm">	 * Standard receive ring @ NIC_SRAM_RX_BUFFER_DESC, 512 entries.</span>
<span class="cm">	 * Jumbo receive ring @ NIC_SRAM_RX_JUMBO_BUFFER_DESC, 256 entries.</span>
<span class="cm">	 *</span>
<span class="cm">	 * The size of each ring is fixed in the firmware, but the location is</span>
<span class="cm">	 * configurable.</span>
<span class="cm">	 */</span>
	<span class="n">tw32</span><span class="p">(</span><span class="n">RCVDBDI_STD_BD</span> <span class="o">+</span> <span class="n">TG3_BDINFO_HOST_ADDR</span> <span class="o">+</span> <span class="n">TG3_64BIT_REG_HIGH</span><span class="p">,</span>
	     <span class="p">((</span><span class="n">u64</span><span class="p">)</span> <span class="n">tpr</span><span class="o">-&gt;</span><span class="n">rx_std_mapping</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">));</span>
	<span class="n">tw32</span><span class="p">(</span><span class="n">RCVDBDI_STD_BD</span> <span class="o">+</span> <span class="n">TG3_BDINFO_HOST_ADDR</span> <span class="o">+</span> <span class="n">TG3_64BIT_REG_LOW</span><span class="p">,</span>
	     <span class="p">((</span><span class="n">u64</span><span class="p">)</span> <span class="n">tpr</span><span class="o">-&gt;</span><span class="n">rx_std_mapping</span> <span class="o">&amp;</span> <span class="mh">0xffffffff</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">5717</span><span class="n">_PLUS</span><span class="p">))</span>
		<span class="n">tw32</span><span class="p">(</span><span class="n">RCVDBDI_STD_BD</span> <span class="o">+</span> <span class="n">TG3_BDINFO_NIC_ADDR</span><span class="p">,</span>
		     <span class="n">NIC_SRAM_RX_BUFFER_DESC</span><span class="p">);</span>

	<span class="cm">/* Disable the mini ring */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">5705</span><span class="n">_PLUS</span><span class="p">))</span>
		<span class="n">tw32</span><span class="p">(</span><span class="n">RCVDBDI_MINI_BD</span> <span class="o">+</span> <span class="n">TG3_BDINFO_MAXLEN_FLAGS</span><span class="p">,</span>
		     <span class="n">BDINFO_FLAGS_DISABLED</span><span class="p">);</span>

	<span class="cm">/* Program the jumbo buffer descriptor ring control</span>
<span class="cm">	 * blocks on those devices that have them.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span> <span class="o">==</span> <span class="n">CHIPREV_ID_5719_A0</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">JUMBO_CAPABLE</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">5780</span><span class="n">_CLASS</span><span class="p">)))</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">JUMBO_RING_ENABLE</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">tw32</span><span class="p">(</span><span class="n">RCVDBDI_JUMBO_BD</span> <span class="o">+</span> <span class="n">TG3_BDINFO_HOST_ADDR</span> <span class="o">+</span> <span class="n">TG3_64BIT_REG_HIGH</span><span class="p">,</span>
			     <span class="p">((</span><span class="n">u64</span><span class="p">)</span> <span class="n">tpr</span><span class="o">-&gt;</span><span class="n">rx_jmb_mapping</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">));</span>
			<span class="n">tw32</span><span class="p">(</span><span class="n">RCVDBDI_JUMBO_BD</span> <span class="o">+</span> <span class="n">TG3_BDINFO_HOST_ADDR</span> <span class="o">+</span> <span class="n">TG3_64BIT_REG_LOW</span><span class="p">,</span>
			     <span class="p">((</span><span class="n">u64</span><span class="p">)</span> <span class="n">tpr</span><span class="o">-&gt;</span><span class="n">rx_jmb_mapping</span> <span class="o">&amp;</span> <span class="mh">0xffffffff</span><span class="p">));</span>
			<span class="n">val</span> <span class="o">=</span> <span class="n">TG3_RX_JMB_RING_SIZE</span><span class="p">(</span><span class="n">tp</span><span class="p">)</span> <span class="o">&lt;&lt;</span>
			      <span class="n">BDINFO_FLAGS_MAXLEN_SHIFT</span><span class="p">;</span>
			<span class="n">tw32</span><span class="p">(</span><span class="n">RCVDBDI_JUMBO_BD</span> <span class="o">+</span> <span class="n">TG3_BDINFO_MAXLEN_FLAGS</span><span class="p">,</span>
			     <span class="n">val</span> <span class="o">|</span> <span class="n">BDINFO_FLAGS_USE_EXT_RECV</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">USE_JUMBO_BDFLAG</span><span class="p">)</span> <span class="o">||</span>
			    <span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">57765</span><span class="n">_CLASS</span><span class="p">))</span>
				<span class="n">tw32</span><span class="p">(</span><span class="n">RCVDBDI_JUMBO_BD</span> <span class="o">+</span> <span class="n">TG3_BDINFO_NIC_ADDR</span><span class="p">,</span>
				     <span class="n">NIC_SRAM_RX_JUMBO_BUFFER_DESC</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">tw32</span><span class="p">(</span><span class="n">RCVDBDI_JUMBO_BD</span> <span class="o">+</span> <span class="n">TG3_BDINFO_MAXLEN_FLAGS</span><span class="p">,</span>
			     <span class="n">BDINFO_FLAGS_DISABLED</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">57765</span><span class="n">_PLUS</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">val</span> <span class="o">=</span> <span class="n">TG3_RX_STD_RING_SIZE</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
			<span class="n">val</span> <span class="o">&lt;&lt;=</span> <span class="n">BDINFO_FLAGS_MAXLEN_SHIFT</span><span class="p">;</span>
			<span class="n">val</span> <span class="o">|=</span> <span class="p">(</span><span class="n">TG3_RX_STD_DMA_SZ</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">val</span> <span class="o">=</span> <span class="n">TG3_RX_STD_DMA_SZ</span> <span class="o">&lt;&lt;</span> <span class="n">BDINFO_FLAGS_MAXLEN_SHIFT</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">TG3_RX_STD_MAX_SIZE_5700</span> <span class="o">&lt;&lt;</span> <span class="n">BDINFO_FLAGS_MAXLEN_SHIFT</span><span class="p">;</span>

	<span class="n">tw32</span><span class="p">(</span><span class="n">RCVDBDI_STD_BD</span> <span class="o">+</span> <span class="n">TG3_BDINFO_MAXLEN_FLAGS</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

	<span class="n">tpr</span><span class="o">-&gt;</span><span class="n">rx_std_prod_idx</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">rx_pending</span><span class="p">;</span>
	<span class="n">tw32_rx_mbox</span><span class="p">(</span><span class="n">TG3_RX_STD_PROD_IDX_REG</span><span class="p">,</span> <span class="n">tpr</span><span class="o">-&gt;</span><span class="n">rx_std_prod_idx</span><span class="p">);</span>

	<span class="n">tpr</span><span class="o">-&gt;</span><span class="n">rx_jmb_prod_idx</span> <span class="o">=</span>
		<span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">JUMBO_RING_ENABLE</span><span class="p">)</span> <span class="o">?</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">rx_jumbo_pending</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">tw32_rx_mbox</span><span class="p">(</span><span class="n">TG3_RX_JMB_PROD_IDX_REG</span><span class="p">,</span> <span class="n">tpr</span><span class="o">-&gt;</span><span class="n">rx_jmb_prod_idx</span><span class="p">);</span>

	<span class="n">tg3_rings_reset</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>

	<span class="cm">/* Initialize MAC address and backoff seed. */</span>
	<span class="n">__tg3_set_mac_addr</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* MTU + ethernet header + FCS + optional VLAN tag */</span>
	<span class="n">tw32</span><span class="p">(</span><span class="n">MAC_RX_MTU_SIZE</span><span class="p">,</span>
	     <span class="n">tp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mtu</span> <span class="o">+</span> <span class="n">ETH_HLEN</span> <span class="o">+</span> <span class="n">ETH_FCS_LEN</span> <span class="o">+</span> <span class="n">VLAN_HLEN</span><span class="p">);</span>

	<span class="cm">/* The slot time is changed by tg3_setup_phy if we</span>
<span class="cm">	 * run at gigabit with half duplex.</span>
<span class="cm">	 */</span>
	<span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span> <span class="o">&lt;&lt;</span> <span class="n">TX_LENGTHS_IPG_CRS_SHIFT</span><span class="p">)</span> <span class="o">|</span>
	      <span class="p">(</span><span class="mi">6</span> <span class="o">&lt;&lt;</span> <span class="n">TX_LENGTHS_IPG_SHIFT</span><span class="p">)</span> <span class="o">|</span>
	      <span class="p">(</span><span class="mi">32</span> <span class="o">&lt;&lt;</span> <span class="n">TX_LENGTHS_SLOT_TIME_SHIFT</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">ASIC_REV_5720</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">tr32</span><span class="p">(</span><span class="n">MAC_TX_LENGTHS</span><span class="p">)</span> <span class="o">&amp;</span>
		       <span class="p">(</span><span class="n">TX_LENGTHS_JMB_FRM_LEN_MSK</span> <span class="o">|</span>
			<span class="n">TX_LENGTHS_CNT_DWN_VAL_MSK</span><span class="p">);</span>

	<span class="n">tw32</span><span class="p">(</span><span class="n">MAC_TX_LENGTHS</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

	<span class="cm">/* Receive rules. */</span>
	<span class="n">tw32</span><span class="p">(</span><span class="n">MAC_RCV_RULE_CFG</span><span class="p">,</span> <span class="n">RCV_RULE_CFG_DEFAULT_CLASS</span><span class="p">);</span>
	<span class="n">tw32</span><span class="p">(</span><span class="n">RCVLPC_CONFIG</span><span class="p">,</span> <span class="mh">0x0181</span><span class="p">);</span>

	<span class="cm">/* Calculate RDMAC_MODE setting early, we need it to determine</span>
<span class="cm">	 * the RCVLPC_STATE_ENABLE mask.</span>
<span class="cm">	 */</span>
	<span class="n">rdmac_mode</span> <span class="o">=</span> <span class="p">(</span><span class="n">RDMAC_MODE_ENABLE</span> <span class="o">|</span> <span class="n">RDMAC_MODE_TGTABORT_ENAB</span> <span class="o">|</span>
		      <span class="n">RDMAC_MODE_MSTABORT_ENAB</span> <span class="o">|</span> <span class="n">RDMAC_MODE_PARITYERR_ENAB</span> <span class="o">|</span>
		      <span class="n">RDMAC_MODE_ADDROFLOW_ENAB</span> <span class="o">|</span> <span class="n">RDMAC_MODE_FIFOOFLOW_ENAB</span> <span class="o">|</span>
		      <span class="n">RDMAC_MODE_FIFOURUN_ENAB</span> <span class="o">|</span> <span class="n">RDMAC_MODE_FIFOOREAD_ENAB</span> <span class="o">|</span>
		      <span class="n">RDMAC_MODE_LNGREAD_ENAB</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">ASIC_REV_5717</span><span class="p">)</span>
		<span class="n">rdmac_mode</span> <span class="o">|=</span> <span class="n">RDMAC_MODE_MULT_DMA_RD_DIS</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">ASIC_REV_5784</span> <span class="o">||</span>
	    <span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">ASIC_REV_5785</span> <span class="o">||</span>
	    <span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">ASIC_REV_57780</span><span class="p">)</span>
		<span class="n">rdmac_mode</span> <span class="o">|=</span> <span class="n">RDMAC_MODE_BD_SBD_CRPT_ENAB</span> <span class="o">|</span>
			      <span class="n">RDMAC_MODE_MBUF_RBD_CRPT_ENAB</span> <span class="o">|</span>
			      <span class="n">RDMAC_MODE_MBUF_SBD_CRPT_ENAB</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">ASIC_REV_5705</span> <span class="o">&amp;&amp;</span>
	    <span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span> <span class="o">!=</span> <span class="n">CHIPREV_ID_5705_A0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">TSO_CAPABLE</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">ASIC_REV_5705</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rdmac_mode</span> <span class="o">|=</span> <span class="n">RDMAC_MODE_FIFO_SIZE_128</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">tr32</span><span class="p">(</span><span class="n">TG3PCI_PCISTATE</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">PCISTATE_BUS_SPEED_HIGH</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			   <span class="o">!</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">IS_5788</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">rdmac_mode</span> <span class="o">|=</span> <span class="n">RDMAC_MODE_FIFO_LONG_BURST</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">PCI_EXPRESS</span><span class="p">))</span>
		<span class="n">rdmac_mode</span> <span class="o">|=</span> <span class="n">RDMAC_MODE_FIFO_LONG_BURST</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">HW_TSO_1</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">HW_TSO_2</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">HW_TSO_3</span><span class="p">))</span>
		<span class="n">rdmac_mode</span> <span class="o">|=</span> <span class="n">RDMAC_MODE_IPV4_LSO_EN</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">57765</span><span class="n">_PLUS</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">ASIC_REV_5785</span> <span class="o">||</span>
	    <span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">ASIC_REV_57780</span><span class="p">)</span>
		<span class="n">rdmac_mode</span> <span class="o">|=</span> <span class="n">RDMAC_MODE_IPV6_LSO_EN</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">ASIC_REV_5720</span><span class="p">)</span>
		<span class="n">rdmac_mode</span> <span class="o">|=</span> <span class="n">tr32</span><span class="p">(</span><span class="n">RDMAC_MODE</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">RDMAC_MODE_H2BNC_VLAN_DET</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">ASIC_REV_5761</span> <span class="o">||</span>
	    <span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">ASIC_REV_5784</span> <span class="o">||</span>
	    <span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">ASIC_REV_5785</span> <span class="o">||</span>
	    <span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">ASIC_REV_57780</span> <span class="o">||</span>
	    <span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">57765</span><span class="n">_PLUS</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">tr32</span><span class="p">(</span><span class="n">TG3_RDMA_RSRVCTRL_REG</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">ASIC_REV_5719</span> <span class="o">||</span>
		    <span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">ASIC_REV_5720</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">TG3_RDMA_RSRVCTRL_TXMRGN_MASK</span> <span class="o">|</span>
				 <span class="n">TG3_RDMA_RSRVCTRL_FIFO_LWM_MASK</span> <span class="o">|</span>
				 <span class="n">TG3_RDMA_RSRVCTRL_FIFO_HWM_MASK</span><span class="p">);</span>
			<span class="n">val</span> <span class="o">|=</span> <span class="n">TG3_RDMA_RSRVCTRL_TXMRGN_320B</span> <span class="o">|</span>
			       <span class="n">TG3_RDMA_RSRVCTRL_FIFO_LWM_1_5K</span> <span class="o">|</span>
			       <span class="n">TG3_RDMA_RSRVCTRL_FIFO_HWM_1_5K</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">tw32</span><span class="p">(</span><span class="n">TG3_RDMA_RSRVCTRL_REG</span><span class="p">,</span>
		     <span class="n">val</span> <span class="o">|</span> <span class="n">TG3_RDMA_RSRVCTRL_FIFO_OFLW_FIX</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">ASIC_REV_5719</span> <span class="o">||</span>
	    <span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">ASIC_REV_5720</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">tr32</span><span class="p">(</span><span class="n">TG3_LSO_RD_DMA_CRPTEN_CTRL</span><span class="p">);</span>
		<span class="n">tw32</span><span class="p">(</span><span class="n">TG3_LSO_RD_DMA_CRPTEN_CTRL</span><span class="p">,</span> <span class="n">val</span> <span class="o">|</span>
		     <span class="n">TG3_LSO_RD_DMA_CRPTEN_CTRL_BLEN_BD_4K</span> <span class="o">|</span>
		     <span class="n">TG3_LSO_RD_DMA_CRPTEN_CTRL_BLEN_LSO_4K</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Receive/send statistics. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">5750</span><span class="n">_PLUS</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">tr32</span><span class="p">(</span><span class="n">RCVLPC_STATS_ENABLE</span><span class="p">);</span>
		<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">RCVLPC_STATSENAB_DACK_FIX</span><span class="p">;</span>
		<span class="n">tw32</span><span class="p">(</span><span class="n">RCVLPC_STATS_ENABLE</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">rdmac_mode</span> <span class="o">&amp;</span> <span class="n">RDMAC_MODE_FIFO_SIZE_128</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		   <span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">TSO_CAPABLE</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">tr32</span><span class="p">(</span><span class="n">RCVLPC_STATS_ENABLE</span><span class="p">);</span>
		<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">RCVLPC_STATSENAB_LNGBRST_RFIX</span><span class="p">;</span>
		<span class="n">tw32</span><span class="p">(</span><span class="n">RCVLPC_STATS_ENABLE</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">tw32</span><span class="p">(</span><span class="n">RCVLPC_STATS_ENABLE</span><span class="p">,</span> <span class="mh">0xffffff</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">tw32</span><span class="p">(</span><span class="n">RCVLPC_STATSCTRL</span><span class="p">,</span> <span class="n">RCVLPC_STATSCTRL_ENABLE</span><span class="p">);</span>
	<span class="n">tw32</span><span class="p">(</span><span class="n">SNDDATAI_STATSENAB</span><span class="p">,</span> <span class="mh">0xffffff</span><span class="p">);</span>
	<span class="n">tw32</span><span class="p">(</span><span class="n">SNDDATAI_STATSCTRL</span><span class="p">,</span>
	     <span class="p">(</span><span class="n">SNDDATAI_SCTRL_ENABLE</span> <span class="o">|</span>
	      <span class="n">SNDDATAI_SCTRL_FASTUPD</span><span class="p">));</span>

	<span class="cm">/* Setup host coalescing engine. */</span>
	<span class="n">tw32</span><span class="p">(</span><span class="n">HOSTCC_MODE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">2000</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">tr32</span><span class="p">(</span><span class="n">HOSTCC_MODE</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">HOSTCC_MODE_ENABLE</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">__tg3_set_coalesce</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">coal</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">5705</span><span class="n">_PLUS</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Status/statistics block address.  See tg3_timer,</span>
<span class="cm">		 * the tg3_periodic_fetch_stats call there, and</span>
<span class="cm">		 * tg3_get_stats to see how this works for 5705/5750 chips.</span>
<span class="cm">		 */</span>
		<span class="n">tw32</span><span class="p">(</span><span class="n">HOSTCC_STATS_BLK_HOST_ADDR</span> <span class="o">+</span> <span class="n">TG3_64BIT_REG_HIGH</span><span class="p">,</span>
		     <span class="p">((</span><span class="n">u64</span><span class="p">)</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">stats_mapping</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">));</span>
		<span class="n">tw32</span><span class="p">(</span><span class="n">HOSTCC_STATS_BLK_HOST_ADDR</span> <span class="o">+</span> <span class="n">TG3_64BIT_REG_LOW</span><span class="p">,</span>
		     <span class="p">((</span><span class="n">u64</span><span class="p">)</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">stats_mapping</span> <span class="o">&amp;</span> <span class="mh">0xffffffff</span><span class="p">));</span>
		<span class="n">tw32</span><span class="p">(</span><span class="n">HOSTCC_STATS_BLK_NIC_ADDR</span><span class="p">,</span> <span class="n">NIC_SRAM_STATS_BLK</span><span class="p">);</span>

		<span class="n">tw32</span><span class="p">(</span><span class="n">HOSTCC_STATUS_BLK_NIC_ADDR</span><span class="p">,</span> <span class="n">NIC_SRAM_STATUS_BLK</span><span class="p">);</span>

		<span class="cm">/* Clear statistics and status block memory areas */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">NIC_SRAM_STATS_BLK</span><span class="p">;</span>
		     <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NIC_SRAM_STATUS_BLK</span> <span class="o">+</span> <span class="n">TG3_HW_STATUS_SIZE</span><span class="p">;</span>
		     <span class="n">i</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">tg3_write_mem</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">40</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">tw32</span><span class="p">(</span><span class="n">HOSTCC_MODE</span><span class="p">,</span> <span class="n">HOSTCC_MODE_ENABLE</span> <span class="o">|</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">coalesce_mode</span><span class="p">);</span>

	<span class="n">tw32</span><span class="p">(</span><span class="n">RCVCC_MODE</span><span class="p">,</span> <span class="n">RCVCC_MODE_ENABLE</span> <span class="o">|</span> <span class="n">RCVCC_MODE_ATTN_ENABLE</span><span class="p">);</span>
	<span class="n">tw32</span><span class="p">(</span><span class="n">RCVLPC_MODE</span><span class="p">,</span> <span class="n">RCVLPC_MODE_ENABLE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">5705</span><span class="n">_PLUS</span><span class="p">))</span>
		<span class="n">tw32</span><span class="p">(</span><span class="n">RCVLSC_MODE</span><span class="p">,</span> <span class="n">RCVLSC_MODE_ENABLE</span> <span class="o">|</span> <span class="n">RCVLSC_MODE_ATTN_ENABLE</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">phy_flags</span> <span class="o">&amp;</span> <span class="n">TG3_PHYFLG_MII_SERDES</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">phy_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">TG3_PHYFLG_PARALLEL_DETECT</span><span class="p">;</span>
		<span class="cm">/* reset to prevent losing 1st rx packet intermittently */</span>
		<span class="n">tw32_f</span><span class="p">(</span><span class="n">MAC_RX_MODE</span><span class="p">,</span> <span class="n">RX_MODE_RESET</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">mac_mode</span> <span class="o">|=</span> <span class="n">MAC_MODE_TXSTAT_ENABLE</span> <span class="o">|</span> <span class="n">MAC_MODE_RXSTAT_ENABLE</span> <span class="o">|</span>
			<span class="n">MAC_MODE_TDE_ENABLE</span> <span class="o">|</span> <span class="n">MAC_MODE_RDE_ENABLE</span> <span class="o">|</span>
			<span class="n">MAC_MODE_FHDE_ENABLE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">ENABLE_APE</span><span class="p">))</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">mac_mode</span> <span class="o">|=</span> <span class="n">MAC_MODE_APE_TX_EN</span> <span class="o">|</span> <span class="n">MAC_MODE_APE_RX_EN</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">5705</span><span class="n">_PLUS</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">phy_flags</span> <span class="o">&amp;</span> <span class="n">TG3_PHYFLG_PHY_SERDES</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">!=</span> <span class="n">ASIC_REV_5700</span><span class="p">)</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">mac_mode</span> <span class="o">|=</span> <span class="n">MAC_MODE_LINK_POLARITY</span><span class="p">;</span>
	<span class="n">tw32_f</span><span class="p">(</span><span class="n">MAC_MODE</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">mac_mode</span> <span class="o">|</span> <span class="n">MAC_MODE_RXSTAT_CLEAR</span> <span class="o">|</span> <span class="n">MAC_MODE_TXSTAT_CLEAR</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">40</span><span class="p">);</span>

	<span class="cm">/* tp-&gt;grc_local_ctrl is partially set up during tg3_get_invariants().</span>
<span class="cm">	 * If TG3_FLAG_IS_NIC is zero, we should read the</span>
<span class="cm">	 * register to preserve the GPIO settings for LOMs. The GPIOs,</span>
<span class="cm">	 * whether used as inputs or outputs, are set by boot code after</span>
<span class="cm">	 * reset.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">IS_NIC</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">gpio_mask</span><span class="p">;</span>

		<span class="n">gpio_mask</span> <span class="o">=</span> <span class="n">GRC_LCLCTRL_GPIO_OE0</span> <span class="o">|</span> <span class="n">GRC_LCLCTRL_GPIO_OE1</span> <span class="o">|</span>
			    <span class="n">GRC_LCLCTRL_GPIO_OE2</span> <span class="o">|</span> <span class="n">GRC_LCLCTRL_GPIO_OUTPUT0</span> <span class="o">|</span>
			    <span class="n">GRC_LCLCTRL_GPIO_OUTPUT1</span> <span class="o">|</span> <span class="n">GRC_LCLCTRL_GPIO_OUTPUT2</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">ASIC_REV_5752</span><span class="p">)</span>
			<span class="n">gpio_mask</span> <span class="o">|=</span> <span class="n">GRC_LCLCTRL_GPIO_OE3</span> <span class="o">|</span>
				     <span class="n">GRC_LCLCTRL_GPIO_OUTPUT3</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">ASIC_REV_5755</span><span class="p">)</span>
			<span class="n">gpio_mask</span> <span class="o">|=</span> <span class="n">GRC_LCLCTRL_GPIO_UART_SEL</span><span class="p">;</span>

		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">grc_local_ctrl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">gpio_mask</span><span class="p">;</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">grc_local_ctrl</span> <span class="o">|=</span> <span class="n">tr32</span><span class="p">(</span><span class="n">GRC_LOCAL_CTRL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">gpio_mask</span><span class="p">;</span>

		<span class="cm">/* GPIO1 must be driven high for eeprom write protect */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">EEPROM_WRITE_PROT</span><span class="p">))</span>
			<span class="n">tp</span><span class="o">-&gt;</span><span class="n">grc_local_ctrl</span> <span class="o">|=</span> <span class="p">(</span><span class="n">GRC_LCLCTRL_GPIO_OE1</span> <span class="o">|</span>
					       <span class="n">GRC_LCLCTRL_GPIO_OUTPUT1</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">tw32_f</span><span class="p">(</span><span class="n">GRC_LOCAL_CTRL</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">grc_local_ctrl</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">USING_MSIX</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">tr32</span><span class="p">(</span><span class="n">MSGINT_MODE</span><span class="p">);</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">MSGINT_MODE_ENABLE</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">irq_cnt</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">val</span> <span class="o">|=</span> <span class="n">MSGINT_MODE_MULTIVEC_EN</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">1</span><span class="n">SHOT_MSI</span><span class="p">))</span>
			<span class="n">val</span> <span class="o">|=</span> <span class="n">MSGINT_MODE_ONE_SHOT_DISABLE</span><span class="p">;</span>
		<span class="n">tw32</span><span class="p">(</span><span class="n">MSGINT_MODE</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">5705</span><span class="n">_PLUS</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">tw32_f</span><span class="p">(</span><span class="n">DMAC_MODE</span><span class="p">,</span> <span class="n">DMAC_MODE_ENABLE</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">40</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">WDMAC_MODE_ENABLE</span> <span class="o">|</span> <span class="n">WDMAC_MODE_TGTABORT_ENAB</span> <span class="o">|</span>
	       <span class="n">WDMAC_MODE_MSTABORT_ENAB</span> <span class="o">|</span> <span class="n">WDMAC_MODE_PARITYERR_ENAB</span> <span class="o">|</span>
	       <span class="n">WDMAC_MODE_ADDROFLOW_ENAB</span> <span class="o">|</span> <span class="n">WDMAC_MODE_FIFOOFLOW_ENAB</span> <span class="o">|</span>
	       <span class="n">WDMAC_MODE_FIFOURUN_ENAB</span> <span class="o">|</span> <span class="n">WDMAC_MODE_FIFOOREAD_ENAB</span> <span class="o">|</span>
	       <span class="n">WDMAC_MODE_LNGREAD_ENAB</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">ASIC_REV_5705</span> <span class="o">&amp;&amp;</span>
	    <span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span> <span class="o">!=</span> <span class="n">CHIPREV_ID_5705_A0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">TSO_CAPABLE</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span> <span class="o">==</span> <span class="n">CHIPREV_ID_5705_A1</span> <span class="o">||</span>
		     <span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span> <span class="o">==</span> <span class="n">CHIPREV_ID_5705_A2</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* nothing */</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">tr32</span><span class="p">(</span><span class="n">TG3PCI_PCISTATE</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">PCISTATE_BUS_SPEED_HIGH</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			   <span class="o">!</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">IS_5788</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">val</span> <span class="o">|=</span> <span class="n">WDMAC_MODE_RX_ACCEL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Enable host coalescing bug fix */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">5755</span><span class="n">_PLUS</span><span class="p">))</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">WDMAC_MODE_STATUS_TAG_FIX</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">ASIC_REV_5785</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">WDMAC_MODE_BURST_ALL_DATA</span><span class="p">;</span>

	<span class="n">tw32_f</span><span class="p">(</span><span class="n">WDMAC_MODE</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">40</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">PCIX_MODE</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">u16</span> <span class="n">pcix_cmd</span><span class="p">;</span>

		<span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">pcix_cap</span> <span class="o">+</span> <span class="n">PCI_X_CMD</span><span class="p">,</span>
				     <span class="o">&amp;</span><span class="n">pcix_cmd</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">ASIC_REV_5703</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pcix_cmd</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PCI_X_CMD_MAX_READ</span><span class="p">;</span>
			<span class="n">pcix_cmd</span> <span class="o">|=</span> <span class="n">PCI_X_CMD_READ_2K</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">ASIC_REV_5704</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pcix_cmd</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">PCI_X_CMD_MAX_SPLIT</span> <span class="o">|</span> <span class="n">PCI_X_CMD_MAX_READ</span><span class="p">);</span>
			<span class="n">pcix_cmd</span> <span class="o">|=</span> <span class="n">PCI_X_CMD_READ_2K</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">pci_write_config_word</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">pcix_cap</span> <span class="o">+</span> <span class="n">PCI_X_CMD</span><span class="p">,</span>
				      <span class="n">pcix_cmd</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">tw32_f</span><span class="p">(</span><span class="n">RDMAC_MODE</span><span class="p">,</span> <span class="n">rdmac_mode</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">40</span><span class="p">);</span>

	<span class="n">tw32</span><span class="p">(</span><span class="n">RCVDCC_MODE</span><span class="p">,</span> <span class="n">RCVDCC_MODE_ENABLE</span> <span class="o">|</span> <span class="n">RCVDCC_MODE_ATTN_ENABLE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">5705</span><span class="n">_PLUS</span><span class="p">))</span>
		<span class="n">tw32</span><span class="p">(</span><span class="n">MBFREE_MODE</span><span class="p">,</span> <span class="n">MBFREE_MODE_ENABLE</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">ASIC_REV_5761</span><span class="p">)</span>
		<span class="n">tw32</span><span class="p">(</span><span class="n">SNDDATAC_MODE</span><span class="p">,</span>
		     <span class="n">SNDDATAC_MODE_ENABLE</span> <span class="o">|</span> <span class="n">SNDDATAC_MODE_CDELAY</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">tw32</span><span class="p">(</span><span class="n">SNDDATAC_MODE</span><span class="p">,</span> <span class="n">SNDDATAC_MODE_ENABLE</span><span class="p">);</span>

	<span class="n">tw32</span><span class="p">(</span><span class="n">SNDBDC_MODE</span><span class="p">,</span> <span class="n">SNDBDC_MODE_ENABLE</span> <span class="o">|</span> <span class="n">SNDBDC_MODE_ATTN_ENABLE</span><span class="p">);</span>
	<span class="n">tw32</span><span class="p">(</span><span class="n">RCVBDI_MODE</span><span class="p">,</span> <span class="n">RCVBDI_MODE_ENABLE</span> <span class="o">|</span> <span class="n">RCVBDI_MODE_RCB_ATTN_ENAB</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">RCVDBDI_MODE_ENABLE</span> <span class="o">|</span> <span class="n">RCVDBDI_MODE_INV_RING_SZ</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">LRG_PROD_RING_CAP</span><span class="p">))</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">RCVDBDI_MODE_LRG_RING_SZ</span><span class="p">;</span>
	<span class="n">tw32</span><span class="p">(</span><span class="n">RCVDBDI_MODE</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="n">tw32</span><span class="p">(</span><span class="n">SNDDATAI_MODE</span><span class="p">,</span> <span class="n">SNDDATAI_MODE_ENABLE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">HW_TSO_1</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">HW_TSO_2</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">HW_TSO_3</span><span class="p">))</span>
		<span class="n">tw32</span><span class="p">(</span><span class="n">SNDDATAI_MODE</span><span class="p">,</span> <span class="n">SNDDATAI_MODE_ENABLE</span> <span class="o">|</span> <span class="mh">0x8</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">SNDBDI_MODE_ENABLE</span> <span class="o">|</span> <span class="n">SNDBDI_MODE_ATTN_ENABLE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">ENABLE_TSS</span><span class="p">))</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">SNDBDI_MODE_MULTI_TXQ_EN</span><span class="p">;</span>
	<span class="n">tw32</span><span class="p">(</span><span class="n">SNDBDI_MODE</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="n">tw32</span><span class="p">(</span><span class="n">SNDBDS_MODE</span><span class="p">,</span> <span class="n">SNDBDS_MODE_ENABLE</span> <span class="o">|</span> <span class="n">SNDBDS_MODE_ATTN_ENABLE</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span> <span class="o">==</span> <span class="n">CHIPREV_ID_5701_A0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">tg3_load_5701_a0_firmware_fix</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">TSO_CAPABLE</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">tg3_load_tso_firmware</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">tx_mode</span> <span class="o">=</span> <span class="n">TX_MODE_ENABLE</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">5755</span><span class="n">_PLUS</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">ASIC_REV_5906</span><span class="p">)</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">tx_mode</span> <span class="o">|=</span> <span class="n">TX_MODE_MBUF_LOCKUP_FIX</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">ASIC_REV_5720</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">TX_MODE_JMB_FRM_LEN</span> <span class="o">|</span> <span class="n">TX_MODE_CNT_DN_MODE</span><span class="p">;</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">tx_mode</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">val</span><span class="p">;</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">tx_mode</span> <span class="o">|=</span> <span class="n">tr32</span><span class="p">(</span><span class="n">MAC_TX_MODE</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">val</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">tw32_f</span><span class="p">(</span><span class="n">MAC_TX_MODE</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">tx_mode</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">ENABLE_RSS</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">tg3_rss_write_indir_tbl</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>

		<span class="cm">/* Setup the &quot;secret&quot; hash key. */</span>
		<span class="n">tw32</span><span class="p">(</span><span class="n">MAC_RSS_HASH_KEY_0</span><span class="p">,</span> <span class="mh">0x5f865437</span><span class="p">);</span>
		<span class="n">tw32</span><span class="p">(</span><span class="n">MAC_RSS_HASH_KEY_1</span><span class="p">,</span> <span class="mh">0xe4ac62cc</span><span class="p">);</span>
		<span class="n">tw32</span><span class="p">(</span><span class="n">MAC_RSS_HASH_KEY_2</span><span class="p">,</span> <span class="mh">0x50103a45</span><span class="p">);</span>
		<span class="n">tw32</span><span class="p">(</span><span class="n">MAC_RSS_HASH_KEY_3</span><span class="p">,</span> <span class="mh">0x36621985</span><span class="p">);</span>
		<span class="n">tw32</span><span class="p">(</span><span class="n">MAC_RSS_HASH_KEY_4</span><span class="p">,</span> <span class="mh">0xbf14c0e8</span><span class="p">);</span>
		<span class="n">tw32</span><span class="p">(</span><span class="n">MAC_RSS_HASH_KEY_5</span><span class="p">,</span> <span class="mh">0x1bc27a1e</span><span class="p">);</span>
		<span class="n">tw32</span><span class="p">(</span><span class="n">MAC_RSS_HASH_KEY_6</span><span class="p">,</span> <span class="mh">0x84f4b556</span><span class="p">);</span>
		<span class="n">tw32</span><span class="p">(</span><span class="n">MAC_RSS_HASH_KEY_7</span><span class="p">,</span> <span class="mh">0x094ea6fe</span><span class="p">);</span>
		<span class="n">tw32</span><span class="p">(</span><span class="n">MAC_RSS_HASH_KEY_8</span><span class="p">,</span> <span class="mh">0x7dda01e7</span><span class="p">);</span>
		<span class="n">tw32</span><span class="p">(</span><span class="n">MAC_RSS_HASH_KEY_9</span><span class="p">,</span> <span class="mh">0xc04d7481</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">rx_mode</span> <span class="o">=</span> <span class="n">RX_MODE_ENABLE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">5755</span><span class="n">_PLUS</span><span class="p">))</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">rx_mode</span> <span class="o">|=</span> <span class="n">RX_MODE_IPV6_CSUM_ENABLE</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">ENABLE_RSS</span><span class="p">))</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">rx_mode</span> <span class="o">|=</span> <span class="n">RX_MODE_RSS_ENABLE</span> <span class="o">|</span>
			       <span class="n">RX_MODE_RSS_ITBL_HASH_BITS_7</span> <span class="o">|</span>
			       <span class="n">RX_MODE_RSS_IPV6_HASH_EN</span> <span class="o">|</span>
			       <span class="n">RX_MODE_RSS_TCP_IPV6_HASH_EN</span> <span class="o">|</span>
			       <span class="n">RX_MODE_RSS_IPV4_HASH_EN</span> <span class="o">|</span>
			       <span class="n">RX_MODE_RSS_TCP_IPV4_HASH_EN</span><span class="p">;</span>

	<span class="n">tw32_f</span><span class="p">(</span><span class="n">MAC_RX_MODE</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">rx_mode</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>

	<span class="n">tw32</span><span class="p">(</span><span class="n">MAC_LED_CTRL</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">led_ctrl</span><span class="p">);</span>

	<span class="n">tw32</span><span class="p">(</span><span class="n">MAC_MI_STAT</span><span class="p">,</span> <span class="n">MAC_MI_STAT_LNKSTAT_ATTN_ENAB</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">phy_flags</span> <span class="o">&amp;</span> <span class="n">TG3_PHYFLG_PHY_SERDES</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tw32_f</span><span class="p">(</span><span class="n">MAC_RX_MODE</span><span class="p">,</span> <span class="n">RX_MODE_RESET</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">tw32_f</span><span class="p">(</span><span class="n">MAC_RX_MODE</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">rx_mode</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">phy_flags</span> <span class="o">&amp;</span> <span class="n">TG3_PHYFLG_PHY_SERDES</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">ASIC_REV_5704</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			<span class="o">!</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">phy_flags</span> <span class="o">&amp;</span> <span class="n">TG3_PHYFLG_SERDES_PREEMPHASIS</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* Set drive transmission level to 1.2V  */</span>
			<span class="cm">/* only if the signal pre-emphasis bit is not set  */</span>
			<span class="n">val</span> <span class="o">=</span> <span class="n">tr32</span><span class="p">(</span><span class="n">MAC_SERDES_CFG</span><span class="p">);</span>
			<span class="n">val</span> <span class="o">&amp;=</span> <span class="mh">0xfffff000</span><span class="p">;</span>
			<span class="n">val</span> <span class="o">|=</span> <span class="mh">0x880</span><span class="p">;</span>
			<span class="n">tw32</span><span class="p">(</span><span class="n">MAC_SERDES_CFG</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span> <span class="o">==</span> <span class="n">CHIPREV_ID_5703_A1</span><span class="p">)</span>
			<span class="n">tw32</span><span class="p">(</span><span class="n">MAC_SERDES_CFG</span><span class="p">,</span> <span class="mh">0x616000</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Prevent chip from dropping frames when flow control</span>
<span class="cm">	 * is enabled.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">57765</span><span class="n">_CLASS</span><span class="p">))</span>
		<span class="n">val</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">val</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">tw32_f</span><span class="p">(</span><span class="n">MAC_LOW_WMARK_MAX_RX_FRAME</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">ASIC_REV_5704</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">phy_flags</span> <span class="o">&amp;</span> <span class="n">TG3_PHYFLG_PHY_SERDES</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Use hardware link auto-negotiation */</span>
		<span class="n">tg3_flag_set</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">HW_AUTONEG</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">phy_flags</span> <span class="o">&amp;</span> <span class="n">TG3_PHYFLG_MII_SERDES</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">ASIC_REV_5714</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">tmp</span><span class="p">;</span>

		<span class="n">tmp</span> <span class="o">=</span> <span class="n">tr32</span><span class="p">(</span><span class="n">SERDES_RX_CTRL</span><span class="p">);</span>
		<span class="n">tw32</span><span class="p">(</span><span class="n">SERDES_RX_CTRL</span><span class="p">,</span> <span class="n">tmp</span> <span class="o">|</span> <span class="n">SERDES_RX_SIG_DETECT</span><span class="p">);</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">grc_local_ctrl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">GRC_LCLCTRL_USE_EXT_SIG_DETECT</span><span class="p">;</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">grc_local_ctrl</span> <span class="o">|=</span> <span class="n">GRC_LCLCTRL_USE_SIG_DETECT</span><span class="p">;</span>
		<span class="n">tw32</span><span class="p">(</span><span class="n">GRC_LOCAL_CTRL</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">grc_local_ctrl</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">USE_PHYLIB</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">phy_flags</span> <span class="o">&amp;</span> <span class="n">TG3_PHYFLG_IS_LOW_POWER</span><span class="p">)</span>
			<span class="n">tp</span><span class="o">-&gt;</span><span class="n">phy_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">TG3_PHYFLG_IS_LOW_POWER</span><span class="p">;</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">tg3_setup_phy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">phy_flags</span> <span class="o">&amp;</span> <span class="n">TG3_PHYFLG_PHY_SERDES</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="o">!</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">phy_flags</span> <span class="o">&amp;</span> <span class="n">TG3_PHYFLG_IS_FET</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">u32</span> <span class="n">tmp</span><span class="p">;</span>

			<span class="cm">/* Clear CRC stats. */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tg3_readphy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">MII_TG3_TEST1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">tg3_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">MII_TG3_TEST1</span><span class="p">,</span>
					     <span class="n">tmp</span> <span class="o">|</span> <span class="n">MII_TG3_TEST1_CRC_EN</span><span class="p">);</span>
				<span class="n">tg3_readphy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">MII_TG3_RXR_COUNTERS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">__tg3_set_rx_mode</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* Initialize receive rules. */</span>
	<span class="n">tw32</span><span class="p">(</span><span class="n">MAC_RCV_RULE_0</span><span class="p">,</span>  <span class="mh">0xc2000000</span> <span class="o">&amp;</span> <span class="n">RCV_RULE_DISABLE_MASK</span><span class="p">);</span>
	<span class="n">tw32</span><span class="p">(</span><span class="n">MAC_RCV_VALUE_0</span><span class="p">,</span> <span class="mh">0xffffffff</span> <span class="o">&amp;</span> <span class="n">RCV_RULE_DISABLE_MASK</span><span class="p">);</span>
	<span class="n">tw32</span><span class="p">(</span><span class="n">MAC_RCV_RULE_1</span><span class="p">,</span>  <span class="mh">0x86000004</span> <span class="o">&amp;</span> <span class="n">RCV_RULE_DISABLE_MASK</span><span class="p">);</span>
	<span class="n">tw32</span><span class="p">(</span><span class="n">MAC_RCV_VALUE_1</span><span class="p">,</span> <span class="mh">0xffffffff</span> <span class="o">&amp;</span> <span class="n">RCV_RULE_DISABLE_MASK</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">5705</span><span class="n">_PLUS</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">5780</span><span class="n">_CLASS</span><span class="p">))</span>
		<span class="n">limit</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">limit</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">ENABLE_ASF</span><span class="p">))</span>
		<span class="n">limit</span> <span class="o">-=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">limit</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">16</span>:
		<span class="n">tw32</span><span class="p">(</span><span class="n">MAC_RCV_RULE_15</span><span class="p">,</span>  <span class="mi">0</span><span class="p">);</span> <span class="n">tw32</span><span class="p">(</span><span class="n">MAC_RCV_VALUE_15</span><span class="p">,</span>  <span class="mi">0</span><span class="p">);</span>
	<span class="k">case</span> <span class="mi">15</span>:
		<span class="n">tw32</span><span class="p">(</span><span class="n">MAC_RCV_RULE_14</span><span class="p">,</span>  <span class="mi">0</span><span class="p">);</span> <span class="n">tw32</span><span class="p">(</span><span class="n">MAC_RCV_VALUE_14</span><span class="p">,</span>  <span class="mi">0</span><span class="p">);</span>
	<span class="k">case</span> <span class="mi">14</span>:
		<span class="n">tw32</span><span class="p">(</span><span class="n">MAC_RCV_RULE_13</span><span class="p">,</span>  <span class="mi">0</span><span class="p">);</span> <span class="n">tw32</span><span class="p">(</span><span class="n">MAC_RCV_VALUE_13</span><span class="p">,</span>  <span class="mi">0</span><span class="p">);</span>
	<span class="k">case</span> <span class="mi">13</span>:
		<span class="n">tw32</span><span class="p">(</span><span class="n">MAC_RCV_RULE_12</span><span class="p">,</span>  <span class="mi">0</span><span class="p">);</span> <span class="n">tw32</span><span class="p">(</span><span class="n">MAC_RCV_VALUE_12</span><span class="p">,</span>  <span class="mi">0</span><span class="p">);</span>
	<span class="k">case</span> <span class="mi">12</span>:
		<span class="n">tw32</span><span class="p">(</span><span class="n">MAC_RCV_RULE_11</span><span class="p">,</span>  <span class="mi">0</span><span class="p">);</span> <span class="n">tw32</span><span class="p">(</span><span class="n">MAC_RCV_VALUE_11</span><span class="p">,</span>  <span class="mi">0</span><span class="p">);</span>
	<span class="k">case</span> <span class="mi">11</span>:
		<span class="n">tw32</span><span class="p">(</span><span class="n">MAC_RCV_RULE_10</span><span class="p">,</span>  <span class="mi">0</span><span class="p">);</span> <span class="n">tw32</span><span class="p">(</span><span class="n">MAC_RCV_VALUE_10</span><span class="p">,</span>  <span class="mi">0</span><span class="p">);</span>
	<span class="k">case</span> <span class="mi">10</span>:
		<span class="n">tw32</span><span class="p">(</span><span class="n">MAC_RCV_RULE_9</span><span class="p">,</span>  <span class="mi">0</span><span class="p">);</span> <span class="n">tw32</span><span class="p">(</span><span class="n">MAC_RCV_VALUE_9</span><span class="p">,</span>  <span class="mi">0</span><span class="p">);</span>
	<span class="k">case</span> <span class="mi">9</span>:
		<span class="n">tw32</span><span class="p">(</span><span class="n">MAC_RCV_RULE_8</span><span class="p">,</span>  <span class="mi">0</span><span class="p">);</span> <span class="n">tw32</span><span class="p">(</span><span class="n">MAC_RCV_VALUE_8</span><span class="p">,</span>  <span class="mi">0</span><span class="p">);</span>
	<span class="k">case</span> <span class="mi">8</span>:
		<span class="n">tw32</span><span class="p">(</span><span class="n">MAC_RCV_RULE_7</span><span class="p">,</span>  <span class="mi">0</span><span class="p">);</span> <span class="n">tw32</span><span class="p">(</span><span class="n">MAC_RCV_VALUE_7</span><span class="p">,</span>  <span class="mi">0</span><span class="p">);</span>
	<span class="k">case</span> <span class="mi">7</span>:
		<span class="n">tw32</span><span class="p">(</span><span class="n">MAC_RCV_RULE_6</span><span class="p">,</span>  <span class="mi">0</span><span class="p">);</span> <span class="n">tw32</span><span class="p">(</span><span class="n">MAC_RCV_VALUE_6</span><span class="p">,</span>  <span class="mi">0</span><span class="p">);</span>
	<span class="k">case</span> <span class="mi">6</span>:
		<span class="n">tw32</span><span class="p">(</span><span class="n">MAC_RCV_RULE_5</span><span class="p">,</span>  <span class="mi">0</span><span class="p">);</span> <span class="n">tw32</span><span class="p">(</span><span class="n">MAC_RCV_VALUE_5</span><span class="p">,</span>  <span class="mi">0</span><span class="p">);</span>
	<span class="k">case</span> <span class="mi">5</span>:
		<span class="n">tw32</span><span class="p">(</span><span class="n">MAC_RCV_RULE_4</span><span class="p">,</span>  <span class="mi">0</span><span class="p">);</span> <span class="n">tw32</span><span class="p">(</span><span class="n">MAC_RCV_VALUE_4</span><span class="p">,</span>  <span class="mi">0</span><span class="p">);</span>
	<span class="k">case</span> <span class="mi">4</span>:
		<span class="cm">/* tw32(MAC_RCV_RULE_3,  0); tw32(MAC_RCV_VALUE_3,  0); */</span>
	<span class="k">case</span> <span class="mi">3</span>:
		<span class="cm">/* tw32(MAC_RCV_RULE_2,  0); tw32(MAC_RCV_VALUE_2,  0); */</span>
	<span class="k">case</span> <span class="mi">2</span>:
	<span class="k">case</span> <span class="mi">1</span>:

	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">ENABLE_APE</span><span class="p">))</span>
		<span class="cm">/* Write our heartbeat update interval to APE. */</span>
		<span class="n">tg3_ape_write32</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">TG3_APE_HOST_HEARTBEAT_INT_MS</span><span class="p">,</span>
				<span class="n">APE_HOST_HEARTBEAT_INT_DISABLE</span><span class="p">);</span>

	<span class="n">tg3_write_sig_post_reset</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">RESET_KIND_INIT</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Called at device open time to get the chip ready for</span>
<span class="cm"> * packet processing.  Invoked with tp-&gt;lock held.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">tg3_init_hw</span><span class="p">(</span><span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reset_phy</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">tg3_switch_clocks</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>

	<span class="n">tw32</span><span class="p">(</span><span class="n">TG3PCI_MEM_WIN_BASE_ADDR</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">tg3_reset_hw</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">reset_phy</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#define TG3_STAT_ADD32(PSTAT, REG) \</span>
<span class="cp">do {	u32 __val = tr32(REG); \</span>
<span class="cp">	(PSTAT)-&gt;low += __val; \</span>
<span class="cp">	if ((PSTAT)-&gt;low &lt; __val) \</span>
<span class="cp">		(PSTAT)-&gt;high += 1; \</span>
<span class="cp">} while (0)</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tg3_periodic_fetch_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tg3_hw_stats</span> <span class="o">*</span><span class="n">sp</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">hw_stats</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">netif_carrier_ok</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">TG3_STAT_ADD32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">tx_octets</span><span class="p">,</span> <span class="n">MAC_TX_STATS_OCTETS</span><span class="p">);</span>
	<span class="n">TG3_STAT_ADD32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">tx_collisions</span><span class="p">,</span> <span class="n">MAC_TX_STATS_COLLISIONS</span><span class="p">);</span>
	<span class="n">TG3_STAT_ADD32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">tx_xon_sent</span><span class="p">,</span> <span class="n">MAC_TX_STATS_XON_SENT</span><span class="p">);</span>
	<span class="n">TG3_STAT_ADD32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">tx_xoff_sent</span><span class="p">,</span> <span class="n">MAC_TX_STATS_XOFF_SENT</span><span class="p">);</span>
	<span class="n">TG3_STAT_ADD32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">tx_mac_errors</span><span class="p">,</span> <span class="n">MAC_TX_STATS_MAC_ERRORS</span><span class="p">);</span>
	<span class="n">TG3_STAT_ADD32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">tx_single_collisions</span><span class="p">,</span> <span class="n">MAC_TX_STATS_SINGLE_COLLISIONS</span><span class="p">);</span>
	<span class="n">TG3_STAT_ADD32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">tx_mult_collisions</span><span class="p">,</span> <span class="n">MAC_TX_STATS_MULT_COLLISIONS</span><span class="p">);</span>
	<span class="n">TG3_STAT_ADD32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">tx_deferred</span><span class="p">,</span> <span class="n">MAC_TX_STATS_DEFERRED</span><span class="p">);</span>
	<span class="n">TG3_STAT_ADD32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">tx_excessive_collisions</span><span class="p">,</span> <span class="n">MAC_TX_STATS_EXCESSIVE_COL</span><span class="p">);</span>
	<span class="n">TG3_STAT_ADD32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">tx_late_collisions</span><span class="p">,</span> <span class="n">MAC_TX_STATS_LATE_COL</span><span class="p">);</span>
	<span class="n">TG3_STAT_ADD32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">tx_ucast_packets</span><span class="p">,</span> <span class="n">MAC_TX_STATS_UCAST</span><span class="p">);</span>
	<span class="n">TG3_STAT_ADD32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">tx_mcast_packets</span><span class="p">,</span> <span class="n">MAC_TX_STATS_MCAST</span><span class="p">);</span>
	<span class="n">TG3_STAT_ADD32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">tx_bcast_packets</span><span class="p">,</span> <span class="n">MAC_TX_STATS_BCAST</span><span class="p">);</span>

	<span class="n">TG3_STAT_ADD32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">rx_octets</span><span class="p">,</span> <span class="n">MAC_RX_STATS_OCTETS</span><span class="p">);</span>
	<span class="n">TG3_STAT_ADD32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">rx_fragments</span><span class="p">,</span> <span class="n">MAC_RX_STATS_FRAGMENTS</span><span class="p">);</span>
	<span class="n">TG3_STAT_ADD32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">rx_ucast_packets</span><span class="p">,</span> <span class="n">MAC_RX_STATS_UCAST</span><span class="p">);</span>
	<span class="n">TG3_STAT_ADD32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">rx_mcast_packets</span><span class="p">,</span> <span class="n">MAC_RX_STATS_MCAST</span><span class="p">);</span>
	<span class="n">TG3_STAT_ADD32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">rx_bcast_packets</span><span class="p">,</span> <span class="n">MAC_RX_STATS_BCAST</span><span class="p">);</span>
	<span class="n">TG3_STAT_ADD32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">rx_fcs_errors</span><span class="p">,</span> <span class="n">MAC_RX_STATS_FCS_ERRORS</span><span class="p">);</span>
	<span class="n">TG3_STAT_ADD32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">rx_align_errors</span><span class="p">,</span> <span class="n">MAC_RX_STATS_ALIGN_ERRORS</span><span class="p">);</span>
	<span class="n">TG3_STAT_ADD32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">rx_xon_pause_rcvd</span><span class="p">,</span> <span class="n">MAC_RX_STATS_XON_PAUSE_RECVD</span><span class="p">);</span>
	<span class="n">TG3_STAT_ADD32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">rx_xoff_pause_rcvd</span><span class="p">,</span> <span class="n">MAC_RX_STATS_XOFF_PAUSE_RECVD</span><span class="p">);</span>
	<span class="n">TG3_STAT_ADD32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">rx_mac_ctrl_rcvd</span><span class="p">,</span> <span class="n">MAC_RX_STATS_MAC_CTRL_RECVD</span><span class="p">);</span>
	<span class="n">TG3_STAT_ADD32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">rx_xoff_entered</span><span class="p">,</span> <span class="n">MAC_RX_STATS_XOFF_ENTERED</span><span class="p">);</span>
	<span class="n">TG3_STAT_ADD32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">rx_frame_too_long_errors</span><span class="p">,</span> <span class="n">MAC_RX_STATS_FRAME_TOO_LONG</span><span class="p">);</span>
	<span class="n">TG3_STAT_ADD32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">rx_jabbers</span><span class="p">,</span> <span class="n">MAC_RX_STATS_JABBERS</span><span class="p">);</span>
	<span class="n">TG3_STAT_ADD32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">rx_undersize_packets</span><span class="p">,</span> <span class="n">MAC_RX_STATS_UNDERSIZE</span><span class="p">);</span>

	<span class="n">TG3_STAT_ADD32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">rxbds_empty</span><span class="p">,</span> <span class="n">RCVLPC_NO_RCV_BD_CNT</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">!=</span> <span class="n">ASIC_REV_5717</span> <span class="o">&amp;&amp;</span>
	    <span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span> <span class="o">!=</span> <span class="n">CHIPREV_ID_5719_A0</span> <span class="o">&amp;&amp;</span>
	    <span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span> <span class="o">!=</span> <span class="n">CHIPREV_ID_5720_A0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TG3_STAT_ADD32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">rx_discards</span><span class="p">,</span> <span class="n">RCVLPC_IN_DISCARDS_CNT</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">val</span> <span class="o">=</span> <span class="n">tr32</span><span class="p">(</span><span class="n">HOSTCC_FLOW_ATTN</span><span class="p">);</span>
		<span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">HOSTCC_FLOW_ATTN_MBUF_LWM</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">tw32</span><span class="p">(</span><span class="n">HOSTCC_FLOW_ATTN</span><span class="p">,</span> <span class="n">HOSTCC_FLOW_ATTN_MBUF_LWM</span><span class="p">);</span>
			<span class="n">sp</span><span class="o">-&gt;</span><span class="n">rx_discards</span><span class="p">.</span><span class="n">low</span> <span class="o">+=</span> <span class="n">val</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">rx_discards</span><span class="p">.</span><span class="n">low</span> <span class="o">&lt;</span> <span class="n">val</span><span class="p">)</span>
				<span class="n">sp</span><span class="o">-&gt;</span><span class="n">rx_discards</span><span class="p">.</span><span class="n">high</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">sp</span><span class="o">-&gt;</span><span class="n">mbuf_lwm_thresh_hit</span> <span class="o">=</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">rx_discards</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">TG3_STAT_ADD32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">rx_errors</span><span class="p">,</span> <span class="n">RCVLPC_IN_ERRORS_CNT</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tg3_chk_missed_msi</span><span class="p">(</span><span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">irq_cnt</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">tg3_napi</span> <span class="o">*</span><span class="n">tnapi</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">tg3_has_work</span><span class="p">(</span><span class="n">tnapi</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tnapi</span><span class="o">-&gt;</span><span class="n">last_rx_cons</span> <span class="o">==</span> <span class="n">tnapi</span><span class="o">-&gt;</span><span class="n">rx_rcb_ptr</span> <span class="o">&amp;&amp;</span>
			    <span class="n">tnapi</span><span class="o">-&gt;</span><span class="n">last_tx_cons</span> <span class="o">==</span> <span class="n">tnapi</span><span class="o">-&gt;</span><span class="n">tx_cons</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">tnapi</span><span class="o">-&gt;</span><span class="n">chk_msi_cnt</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">tnapi</span><span class="o">-&gt;</span><span class="n">chk_msi_cnt</span><span class="o">++</span><span class="p">;</span>
					<span class="k">return</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">tg3_msi</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">tnapi</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">tnapi</span><span class="o">-&gt;</span><span class="n">chk_msi_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">tnapi</span><span class="o">-&gt;</span><span class="n">last_rx_cons</span> <span class="o">=</span> <span class="n">tnapi</span><span class="o">-&gt;</span><span class="n">rx_rcb_ptr</span><span class="p">;</span>
		<span class="n">tnapi</span><span class="o">-&gt;</span><span class="n">last_tx_cons</span> <span class="o">=</span> <span class="n">tnapi</span><span class="o">-&gt;</span><span class="n">tx_cons</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tg3_timer</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">__opaque</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="p">)</span> <span class="n">__opaque</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">irq_sync</span> <span class="o">||</span> <span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">RESET_TASK_PENDING</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">restart_timer</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">ASIC_REV_5717</span> <span class="o">||</span>
	    <span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">57765</span><span class="n">_CLASS</span><span class="p">))</span>
		<span class="n">tg3_chk_missed_msi</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">TAGGED_STATUS</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* All of this garbage is because when using non-tagged</span>
<span class="cm">		 * IRQ status the mailbox/status_block protocol the chip</span>
<span class="cm">		 * uses with the cpu is race prone.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">hw_status</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">SD_STATUS_UPDATED</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">tw32</span><span class="p">(</span><span class="n">GRC_LOCAL_CTRL</span><span class="p">,</span>
			     <span class="n">tp</span><span class="o">-&gt;</span><span class="n">grc_local_ctrl</span> <span class="o">|</span> <span class="n">GRC_LCLCTRL_SETINT</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">tw32</span><span class="p">(</span><span class="n">HOSTCC_MODE</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">coalesce_mode</span> <span class="o">|</span>
			     <span class="n">HOSTCC_MODE_ENABLE</span> <span class="o">|</span> <span class="n">HOSTCC_MODE_NOW</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">tr32</span><span class="p">(</span><span class="n">WDMAC_MODE</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">WDMAC_MODE_ENABLE</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
			<span class="n">tg3_reset_task_schedule</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">restart_timer</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* This part only runs once per second. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!--</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">timer_counter</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">5705</span><span class="n">_PLUS</span><span class="p">))</span>
			<span class="n">tg3_periodic_fetch_stats</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">setlpicnt</span> <span class="o">&amp;&amp;</span> <span class="o">!--</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">setlpicnt</span><span class="p">)</span>
			<span class="n">tg3_phy_eee_enable</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">USE_LINKCHG_REG</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">u32</span> <span class="n">mac_stat</span><span class="p">;</span>
			<span class="kt">int</span> <span class="n">phy_event</span><span class="p">;</span>

			<span class="n">mac_stat</span> <span class="o">=</span> <span class="n">tr32</span><span class="p">(</span><span class="n">MAC_STATUS</span><span class="p">);</span>

			<span class="n">phy_event</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">phy_flags</span> <span class="o">&amp;</span> <span class="n">TG3_PHYFLG_USE_MI_INTERRUPT</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">mac_stat</span> <span class="o">&amp;</span> <span class="n">MAC_STATUS_MI_INTERRUPT</span><span class="p">)</span>
					<span class="n">phy_event</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">mac_stat</span> <span class="o">&amp;</span> <span class="n">MAC_STATUS_LNKSTATE_CHANGED</span><span class="p">)</span>
				<span class="n">phy_event</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">phy_event</span><span class="p">)</span>
				<span class="n">tg3_setup_phy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">POLL_SERDES</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">u32</span> <span class="n">mac_stat</span> <span class="o">=</span> <span class="n">tr32</span><span class="p">(</span><span class="n">MAC_STATUS</span><span class="p">);</span>
			<span class="kt">int</span> <span class="n">need_setup</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">netif_carrier_ok</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="p">(</span><span class="n">mac_stat</span> <span class="o">&amp;</span> <span class="n">MAC_STATUS_LNKSTATE_CHANGED</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">need_setup</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">netif_carrier_ok</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="p">(</span><span class="n">mac_stat</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">MAC_STATUS_PCS_SYNCED</span> <span class="o">|</span>
					 <span class="n">MAC_STATUS_SIGNAL_DET</span><span class="p">)))</span> <span class="p">{</span>
				<span class="n">need_setup</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">need_setup</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">serdes_counter</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">tw32_f</span><span class="p">(</span><span class="n">MAC_MODE</span><span class="p">,</span>
					     <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">mac_mode</span> <span class="o">&amp;</span>
					      <span class="o">~</span><span class="n">MAC_MODE_PORT_MODE_MASK</span><span class="p">));</span>
					<span class="n">udelay</span><span class="p">(</span><span class="mi">40</span><span class="p">);</span>
					<span class="n">tw32_f</span><span class="p">(</span><span class="n">MAC_MODE</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">mac_mode</span><span class="p">);</span>
					<span class="n">udelay</span><span class="p">(</span><span class="mi">40</span><span class="p">);</span>
				<span class="p">}</span>
				<span class="n">tg3_setup_phy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">phy_flags</span> <span class="o">&amp;</span> <span class="n">TG3_PHYFLG_MII_SERDES</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			   <span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">5780</span><span class="n">_CLASS</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">tg3_serdes_parallel_detect</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">timer_counter</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">timer_multiplier</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Heartbeat is only sent once every 2 seconds.</span>
<span class="cm">	 *</span>
<span class="cm">	 * The heartbeat is to tell the ASF firmware that the host</span>
<span class="cm">	 * driver is still alive.  In the event that the OS crashes,</span>
<span class="cm">	 * ASF needs to reset the hardware to free up the FIFO space</span>
<span class="cm">	 * that may be filled with rx packets destined for the host.</span>
<span class="cm">	 * If the FIFO is full, ASF will no longer function properly.</span>
<span class="cm">	 *</span>
<span class="cm">	 * Unintended resets have been reported on real time kernels</span>
<span class="cm">	 * where the timer doesn&#39;t run on time.  Netpoll will also have</span>
<span class="cm">	 * same problem.</span>
<span class="cm">	 *</span>
<span class="cm">	 * The new FWCMD_NICDRV_ALIVE3 command tells the ASF firmware</span>
<span class="cm">	 * to check the ring condition when the heartbeat is expiring</span>
<span class="cm">	 * before doing the reset.  This will prevent most unintended</span>
<span class="cm">	 * resets.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!--</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">asf_counter</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">ENABLE_ASF</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">ENABLE_APE</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">tg3_wait_for_event_ack</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>

			<span class="n">tg3_write_mem</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">NIC_SRAM_FW_CMD_MBOX</span><span class="p">,</span>
				      <span class="n">FWCMD_NICDRV_ALIVE3</span><span class="p">);</span>
			<span class="n">tg3_write_mem</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">NIC_SRAM_FW_CMD_LEN_MBOX</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
			<span class="n">tg3_write_mem</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">NIC_SRAM_FW_CMD_DATA_MBOX</span><span class="p">,</span>
				      <span class="n">TG3_FW_UPDATE_TIMEOUT_SEC</span><span class="p">);</span>

			<span class="n">tg3_generate_fw_event</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">asf_counter</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">asf_multiplier</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

<span class="nl">restart_timer:</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">timer_offset</span><span class="p">;</span>
	<span class="n">add_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span> <span class="nf">tg3_timer_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">TAGGED_STATUS</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">!=</span> <span class="n">ASIC_REV_5717</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">57765</span><span class="n">_CLASS</span><span class="p">))</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">timer_offset</span> <span class="o">=</span> <span class="n">HZ</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">timer_offset</span> <span class="o">=</span> <span class="n">HZ</span> <span class="o">/</span> <span class="mi">10</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">timer_offset</span> <span class="o">&gt;</span> <span class="n">HZ</span><span class="p">);</span>

	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">timer_multiplier</span> <span class="o">=</span> <span class="p">(</span><span class="n">HZ</span> <span class="o">/</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">timer_offset</span><span class="p">);</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">asf_multiplier</span> <span class="o">=</span> <span class="p">(</span><span class="n">HZ</span> <span class="o">/</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">timer_offset</span><span class="p">)</span> <span class="o">*</span>
			     <span class="n">TG3_FW_UPDATE_FREQ_SEC</span><span class="p">;</span>

	<span class="n">init_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">tp</span><span class="p">;</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="n">tg3_timer</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tg3_timer_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">asf_counter</span>   <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">asf_multiplier</span><span class="p">;</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">timer_counter</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">timer_multiplier</span><span class="p">;</span>

	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">timer_offset</span><span class="p">;</span>
	<span class="n">add_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tg3_timer_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Restart hardware after configuration changes, self-test, etc.</span>
<span class="cm"> * Invoked with tp-&gt;lock held.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">tg3_restart_hw</span><span class="p">(</span><span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reset_phy</span><span class="p">)</span>
	<span class="n">__releases</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">)</span>
	<span class="n">__acquires</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">tg3_init_hw</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">reset_phy</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netdev_err</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			   <span class="s">&quot;Failed to re-initialize device, aborting</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">tg3_halt</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">RESET_KIND_SHUTDOWN</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">tg3_full_unlock</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
		<span class="n">tg3_timer_stop</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">irq_sync</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">tg3_napi_enable</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
		<span class="n">dev_close</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">tg3_full_lock</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tg3_reset_task</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">tg3</span><span class="p">,</span> <span class="n">reset_task</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">tg3_full_lock</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">netif_running</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">tg3_flag_clear</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">RESET_TASK_PENDING</span><span class="p">);</span>
		<span class="n">tg3_full_unlock</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">tg3_full_unlock</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>

	<span class="n">tg3_phy_stop</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>

	<span class="n">tg3_netif_stop</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>

	<span class="n">tg3_full_lock</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">TX_RECOVERY_PENDING</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">write32_tx_mbox</span> <span class="o">=</span> <span class="n">tg3_write32_tx_mbox</span><span class="p">;</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">write32_rx_mbox</span> <span class="o">=</span> <span class="n">tg3_write_flush_reg32</span><span class="p">;</span>
		<span class="n">tg3_flag_set</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">MBOX_WRITE_REORDER</span><span class="p">);</span>
		<span class="n">tg3_flag_clear</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">TX_RECOVERY_PENDING</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">tg3_halt</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">RESET_KIND_SHUTDOWN</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">tg3_init_hw</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">tg3_netif_start</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="n">tg3_full_unlock</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span>
		<span class="n">tg3_phy_start</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>

	<span class="n">tg3_flag_clear</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">RESET_TASK_PENDING</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tg3_request_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">irq_num</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">irq_handler_t</span> <span class="n">fn</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tg3_napi</span> <span class="o">*</span><span class="n">tnapi</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">[</span><span class="n">irq_num</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">irq_cnt</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">name</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">name</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tnapi</span><span class="o">-&gt;</span><span class="n">irq_lbl</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="n">snprintf</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">IFNAMSIZ</span><span class="p">,</span> <span class="s">&quot;%s-%d&quot;</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">irq_num</span><span class="p">);</span>
		<span class="n">name</span><span class="p">[</span><span class="n">IFNAMSIZ</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">USING_MSI</span><span class="p">)</span> <span class="o">||</span> <span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">USING_MSIX</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">fn</span> <span class="o">=</span> <span class="n">tg3_msi</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">1</span><span class="n">SHOT_MSI</span><span class="p">))</span>
			<span class="n">fn</span> <span class="o">=</span> <span class="n">tg3_msi_1shot</span><span class="p">;</span>
		<span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">fn</span> <span class="o">=</span> <span class="n">tg3_interrupt</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">TAGGED_STATUS</span><span class="p">))</span>
			<span class="n">fn</span> <span class="o">=</span> <span class="n">tg3_interrupt_tagged</span><span class="p">;</span>
		<span class="n">flags</span> <span class="o">=</span> <span class="n">IRQF_SHARED</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">tnapi</span><span class="o">-&gt;</span><span class="n">irq_vec</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">tnapi</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tg3_test_interrupt</span><span class="p">(</span><span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tg3_napi</span> <span class="o">*</span><span class="n">tnapi</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">intr_ok</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">netif_running</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">tg3_disable_ints</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>

	<span class="n">free_irq</span><span class="p">(</span><span class="n">tnapi</span><span class="o">-&gt;</span><span class="n">irq_vec</span><span class="p">,</span> <span class="n">tnapi</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Turn off MSI one shot mode.  Otherwise this test has no</span>
<span class="cm">	 * observable way to know whether the interrupt was delivered.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">57765</span><span class="n">_PLUS</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">tr32</span><span class="p">(</span><span class="n">MSGINT_MODE</span><span class="p">)</span> <span class="o">|</span> <span class="n">MSGINT_MODE_ONE_SHOT_DISABLE</span><span class="p">;</span>
		<span class="n">tw32</span><span class="p">(</span><span class="n">MSGINT_MODE</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">tnapi</span><span class="o">-&gt;</span><span class="n">irq_vec</span><span class="p">,</span> <span class="n">tg3_test_isr</span><span class="p">,</span>
			  <span class="n">IRQF_SHARED</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">tnapi</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">tnapi</span><span class="o">-&gt;</span><span class="n">hw_status</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SD_STATUS_UPDATED</span><span class="p">;</span>
	<span class="n">tg3_enable_ints</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>

	<span class="n">tw32_f</span><span class="p">(</span><span class="n">HOSTCC_MODE</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">coalesce_mode</span> <span class="o">|</span> <span class="n">HOSTCC_MODE_ENABLE</span> <span class="o">|</span>
	       <span class="n">tnapi</span><span class="o">-&gt;</span><span class="n">coal_now</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">int_mbox</span><span class="p">,</span> <span class="n">misc_host_ctrl</span><span class="p">;</span>

		<span class="n">int_mbox</span> <span class="o">=</span> <span class="n">tr32_mailbox</span><span class="p">(</span><span class="n">tnapi</span><span class="o">-&gt;</span><span class="n">int_mbox</span><span class="p">);</span>
		<span class="n">misc_host_ctrl</span> <span class="o">=</span> <span class="n">tr32</span><span class="p">(</span><span class="n">TG3PCI_MISC_HOST_CTRL</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">int_mbox</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">misc_host_ctrl</span> <span class="o">&amp;</span> <span class="n">MISC_HOST_CTRL_MASK_PCI_INT</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">intr_ok</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">57765</span><span class="n">_PLUS</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="n">tnapi</span><span class="o">-&gt;</span><span class="n">hw_status</span><span class="o">-&gt;</span><span class="n">status_tag</span> <span class="o">!=</span> <span class="n">tnapi</span><span class="o">-&gt;</span><span class="n">last_tag</span><span class="p">)</span>
			<span class="n">tw32_mailbox_f</span><span class="p">(</span><span class="n">tnapi</span><span class="o">-&gt;</span><span class="n">int_mbox</span><span class="p">,</span> <span class="n">tnapi</span><span class="o">-&gt;</span><span class="n">last_tag</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">);</span>

		<span class="n">msleep</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">tg3_disable_ints</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>

	<span class="n">free_irq</span><span class="p">(</span><span class="n">tnapi</span><span class="o">-&gt;</span><span class="n">irq_vec</span><span class="p">,</span> <span class="n">tnapi</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">tg3_request_irq</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">intr_ok</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Reenable MSI one shot mode. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">57765</span><span class="n">_PLUS</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">1</span><span class="n">SHOT_MSI</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">val</span> <span class="o">=</span> <span class="n">tr32</span><span class="p">(</span><span class="n">MSGINT_MODE</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">MSGINT_MODE_ONE_SHOT_DISABLE</span><span class="p">;</span>
			<span class="n">tw32</span><span class="p">(</span><span class="n">MSGINT_MODE</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Returns 0 if MSI test succeeds or MSI test fails and INTx mode is</span>
<span class="cm"> * successfully restored</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">tg3_test_msi</span><span class="p">(</span><span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">pci_cmd</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">USING_MSI</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Turn off SERR reporting in case MSI terminates with Master</span>
<span class="cm">	 * Abort.</span>
<span class="cm">	 */</span>
	<span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_COMMAND</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pci_cmd</span><span class="p">);</span>
	<span class="n">pci_write_config_word</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_COMMAND</span><span class="p">,</span>
			      <span class="n">pci_cmd</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">PCI_COMMAND_SERR</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">tg3_test_interrupt</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>

	<span class="n">pci_write_config_word</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_COMMAND</span><span class="p">,</span> <span class="n">pci_cmd</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* other failures */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">!=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="cm">/* MSI test failed, go back to INTx mode */</span>
	<span class="n">netdev_warn</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;No interrupt was generated using MSI. Switching &quot;</span>
		    <span class="s">&quot;to INTx mode. Please report this failure to the PCI &quot;</span>
		    <span class="s">&quot;maintainer and include system chipset information</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">free_irq</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">irq_vec</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>

	<span class="n">pci_disable_msi</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">);</span>

	<span class="n">tg3_flag_clear</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">USING_MSI</span><span class="p">);</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">irq_vec</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">tg3_request_irq</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="cm">/* Need to reset the chip because the MSI cycle may have terminated</span>
<span class="cm">	 * with Master Abort.</span>
<span class="cm">	 */</span>
	<span class="n">tg3_full_lock</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">tg3_halt</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">RESET_KIND_SHUTDOWN</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">tg3_init_hw</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">tg3_full_unlock</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="n">free_irq</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">irq_vec</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tg3_request_firmware</span><span class="p">(</span><span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="n">__be32</span> <span class="o">*</span><span class="n">fw_data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">request_firmware</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">fw</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">fw_needed</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">netdev_err</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Failed to load firmware </span><span class="se">\&quot;</span><span class="s">%s</span><span class="se">\&quot;\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">tp</span><span class="o">-&gt;</span><span class="n">fw_needed</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">fw_data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">fw</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

	<span class="cm">/* Firmware blob starts with version numbers, followed by</span>
<span class="cm">	 * start address and _full_ length including BSS sections</span>
<span class="cm">	 * (which must be longer than the actual data, of course</span>
<span class="cm">	 */</span>

	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">fw_len</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">fw_data</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>	<span class="cm">/* includes bss */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">fw_len</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">fw</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">-</span> <span class="mi">12</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">netdev_err</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;bogus length %d in </span><span class="se">\&quot;</span><span class="s">%s</span><span class="se">\&quot;\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">tp</span><span class="o">-&gt;</span><span class="n">fw_len</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">fw_needed</span><span class="p">);</span>
		<span class="n">release_firmware</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">fw</span><span class="p">);</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">fw</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* We no longer need firmware; we have it. */</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">fw_needed</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">tg3_enable_msix</span><span class="p">(</span><span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">rc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">msix_entry</span> <span class="n">msix_ent</span><span class="p">[</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">irq_max</span><span class="p">];</span>

	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">irq_cnt</span> <span class="o">=</span> <span class="n">num_online_cpus</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">irq_cnt</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* We want as many rx rings enabled as there are cpus.</span>
<span class="cm">		 * In multiqueue MSI-X mode, the first MSI-X vector</span>
<span class="cm">		 * only deals with link interrupts, etc, so we add</span>
<span class="cm">		 * one to the number of vectors we are requesting.</span>
<span class="cm">		 */</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">irq_cnt</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">unsigned</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">irq_cnt</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">irq_max</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">irq_max</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">msix_ent</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">entry</span>  <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">msix_ent</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">vector</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">pci_enable_msix</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">msix_ent</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">irq_cnt</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pci_enable_msix</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">msix_ent</span><span class="p">,</span> <span class="n">rc</span><span class="p">))</span>
			<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">netdev_notice</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Requested %d MSI-X vectors, received %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			      <span class="n">tp</span><span class="o">-&gt;</span><span class="n">irq_cnt</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">irq_cnt</span> <span class="o">=</span> <span class="n">rc</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">irq_max</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">irq_vec</span> <span class="o">=</span> <span class="n">msix_ent</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">vector</span><span class="p">;</span>

	<span class="n">netif_set_real_num_tx_queues</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">irq_cnt</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="o">?</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">irq_cnt</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">netif_set_real_num_rx_queues</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">rc</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pci_disable_msix</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">irq_cnt</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tg3_flag_set</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">ENABLE_RSS</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">ASIC_REV_5719</span> <span class="o">||</span>
		    <span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">ASIC_REV_5720</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">tg3_flag_set</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">ENABLE_TSS</span><span class="p">);</span>
			<span class="n">netif_set_real_num_tx_queues</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">irq_cnt</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tg3_ints_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">SUPPORT_MSI</span><span class="p">)</span> <span class="o">||</span> <span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">SUPPORT_MSIX</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">TAGGED_STATUS</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* All MSI supporting chips should support tagged</span>
<span class="cm">		 * status.  Assert that this is the case.</span>
<span class="cm">		 */</span>
		<span class="n">netdev_warn</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			    <span class="s">&quot;MSI without TAGGED_STATUS? Not using MSI</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">defcfg</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">SUPPORT_MSIX</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">tg3_enable_msix</span><span class="p">(</span><span class="n">tp</span><span class="p">))</span>
		<span class="n">tg3_flag_set</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">USING_MSIX</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">SUPPORT_MSI</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">pci_enable_msi</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">tg3_flag_set</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">USING_MSI</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">USING_MSI</span><span class="p">)</span> <span class="o">||</span> <span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">USING_MSIX</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">msi_mode</span> <span class="o">=</span> <span class="n">tr32</span><span class="p">(</span><span class="n">MSGINT_MODE</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">USING_MSIX</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">irq_cnt</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">msi_mode</span> <span class="o">|=</span> <span class="n">MSGINT_MODE_MULTIVEC_EN</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">1</span><span class="n">SHOT_MSI</span><span class="p">))</span>
			<span class="n">msi_mode</span> <span class="o">|=</span> <span class="n">MSGINT_MODE_ONE_SHOT_DISABLE</span><span class="p">;</span>
		<span class="n">tw32</span><span class="p">(</span><span class="n">MSGINT_MODE</span><span class="p">,</span> <span class="n">msi_mode</span> <span class="o">|</span> <span class="n">MSGINT_MODE_ENABLE</span><span class="p">);</span>
	<span class="p">}</span>
<span class="nl">defcfg:</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">USING_MSIX</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">irq_cnt</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">irq_vec</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>
		<span class="n">netif_set_real_num_tx_queues</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">netif_set_real_num_rx_queues</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tg3_ints_fini</span><span class="p">(</span><span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">USING_MSIX</span><span class="p">))</span>
		<span class="n">pci_disable_msix</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">USING_MSI</span><span class="p">))</span>
		<span class="n">pci_disable_msi</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">tg3_flag_clear</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">USING_MSI</span><span class="p">);</span>
	<span class="n">tg3_flag_clear</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">USING_MSIX</span><span class="p">);</span>
	<span class="n">tg3_flag_clear</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">ENABLE_RSS</span><span class="p">);</span>
	<span class="n">tg3_flag_clear</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">ENABLE_TSS</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tg3_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">fw_needed</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">tg3_request_firmware</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span> <span class="o">==</span> <span class="n">CHIPREV_ID_5701_A0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">netdev_warn</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;TSO capability disabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">tg3_flag_clear</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">TSO_CAPABLE</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">TSO_CAPABLE</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">netdev_notice</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;TSO capability restored</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">tg3_flag_set</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">TSO_CAPABLE</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">netif_carrier_off</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">tg3_power_up</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">tg3_full_lock</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">tg3_disable_ints</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
	<span class="n">tg3_flag_clear</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">INIT_COMPLETE</span><span class="p">);</span>

	<span class="n">tg3_full_unlock</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Setup interrupts first so we know how</span>
<span class="cm">	 * many NAPI resources to allocate</span>
<span class="cm">	 */</span>
	<span class="n">tg3_ints_init</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>

	<span class="n">tg3_rss_check_indir_tbl</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>

	<span class="cm">/* The placement of this call is tied</span>
<span class="cm">	 * to the setup and use of Host TX descriptors.</span>
<span class="cm">	 */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">tg3_alloc_consistent</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_out1</span><span class="p">;</span>

	<span class="n">tg3_napi_init</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>

	<span class="n">tg3_napi_enable</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">irq_cnt</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">tg3_napi</span> <span class="o">*</span><span class="n">tnapi</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">tg3_request_irq</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">--</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">tnapi</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
				<span class="n">free_irq</span><span class="p">(</span><span class="n">tnapi</span><span class="o">-&gt;</span><span class="n">irq_vec</span><span class="p">,</span> <span class="n">tnapi</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">goto</span> <span class="n">err_out2</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">tg3_full_lock</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">tg3_init_hw</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tg3_halt</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">RESET_KIND_SHUTDOWN</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">tg3_free_rings</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">tg3_full_unlock</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_out3</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">USING_MSI</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">tg3_test_msi</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">tg3_full_lock</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">tg3_halt</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">RESET_KIND_SHUTDOWN</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">tg3_free_rings</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
			<span class="n">tg3_full_unlock</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>

			<span class="k">goto</span> <span class="n">err_out2</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">57765</span><span class="n">_PLUS</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">USING_MSI</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">u32</span> <span class="n">val</span> <span class="o">=</span> <span class="n">tr32</span><span class="p">(</span><span class="n">PCIE_TRANSACTION_CFG</span><span class="p">);</span>

			<span class="n">tw32</span><span class="p">(</span><span class="n">PCIE_TRANSACTION_CFG</span><span class="p">,</span>
			     <span class="n">val</span> <span class="o">|</span> <span class="n">PCIE_TRANS_CFG_1SHOT_MSI</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">tg3_phy_start</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>

	<span class="n">tg3_full_lock</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">tg3_timer_start</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
	<span class="n">tg3_flag_set</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">INIT_COMPLETE</span><span class="p">);</span>
	<span class="n">tg3_enable_ints</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>

	<span class="n">tg3_full_unlock</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>

	<span class="n">netif_tx_start_all_queues</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Reset loopback feature if it was turned on while the device was down</span>
<span class="cm">	 * make sure that it&#39;s installed properly now.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">NETIF_F_LOOPBACK</span><span class="p">)</span>
		<span class="n">tg3_set_loopback</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">features</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_out3:</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">irq_cnt</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">tg3_napi</span> <span class="o">*</span><span class="n">tnapi</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">free_irq</span><span class="p">(</span><span class="n">tnapi</span><span class="o">-&gt;</span><span class="n">irq_vec</span><span class="p">,</span> <span class="n">tnapi</span><span class="p">);</span>
	<span class="p">}</span>

<span class="nl">err_out2:</span>
	<span class="n">tg3_napi_disable</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
	<span class="n">tg3_napi_fini</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
	<span class="n">tg3_free_consistent</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>

<span class="nl">err_out1:</span>
	<span class="n">tg3_ints_fini</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
	<span class="n">tg3_frob_aux_power</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
	<span class="n">pci_set_power_state</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_D3hot</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tg3_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">tg3_napi_disable</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
	<span class="n">tg3_reset_task_cancel</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>

	<span class="n">netif_tx_stop_all_queues</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">tg3_timer_stop</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>

	<span class="n">tg3_phy_stop</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>

	<span class="n">tg3_full_lock</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">tg3_disable_ints</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>

	<span class="n">tg3_halt</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">RESET_KIND_SHUTDOWN</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">tg3_free_rings</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
	<span class="n">tg3_flag_clear</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">INIT_COMPLETE</span><span class="p">);</span>

	<span class="n">tg3_full_unlock</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">irq_cnt</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">tg3_napi</span> <span class="o">*</span><span class="n">tnapi</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">free_irq</span><span class="p">(</span><span class="n">tnapi</span><span class="o">-&gt;</span><span class="n">irq_vec</span><span class="p">,</span> <span class="n">tnapi</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">tg3_ints_fini</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>

	<span class="cm">/* Clear stats across close / open calls */</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">net_stats_prev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">net_stats_prev</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">estats_prev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">estats_prev</span><span class="p">));</span>

	<span class="n">tg3_napi_fini</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>

	<span class="n">tg3_free_consistent</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>

	<span class="n">tg3_power_down</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>

	<span class="n">netif_carrier_off</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u64</span> <span class="nf">get_stat64</span><span class="p">(</span><span class="n">tg3_stat64_t</span> <span class="o">*</span><span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
       <span class="k">return</span> <span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="n">val</span><span class="o">-&gt;</span><span class="n">high</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="n">val</span><span class="o">-&gt;</span><span class="n">low</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u64</span> <span class="nf">tg3_calc_crc_errors</span><span class="p">(</span><span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tg3_hw_stats</span> <span class="o">*</span><span class="n">hw_stats</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">hw_stats</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">phy_flags</span> <span class="o">&amp;</span> <span class="n">TG3_PHYFLG_PHY_SERDES</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">ASIC_REV_5700</span> <span class="o">||</span>
	     <span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">ASIC_REV_5701</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tg3_readphy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">MII_TG3_TEST1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">tg3_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">MII_TG3_TEST1</span><span class="p">,</span>
				     <span class="n">val</span> <span class="o">|</span> <span class="n">MII_TG3_TEST1_CRC_EN</span><span class="p">);</span>
			<span class="n">tg3_readphy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">MII_TG3_RXR_COUNTERS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">phy_crc_errors</span> <span class="o">+=</span> <span class="n">val</span><span class="p">;</span>

		<span class="k">return</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">phy_crc_errors</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">get_stat64</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw_stats</span><span class="o">-&gt;</span><span class="n">rx_fcs_errors</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#define ESTAT_ADD(member) \</span>
<span class="cp">	estats-&gt;member =	old_estats-&gt;member + \</span>
<span class="cp">				get_stat64(&amp;hw_stats-&gt;member)</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tg3_get_estats</span><span class="p">(</span><span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">tg3_ethtool_stats</span> <span class="o">*</span><span class="n">estats</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tg3_ethtool_stats</span> <span class="o">*</span><span class="n">old_estats</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">estats_prev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tg3_hw_stats</span> <span class="o">*</span><span class="n">hw_stats</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">hw_stats</span><span class="p">;</span>

	<span class="n">ESTAT_ADD</span><span class="p">(</span><span class="n">rx_octets</span><span class="p">);</span>
	<span class="n">ESTAT_ADD</span><span class="p">(</span><span class="n">rx_fragments</span><span class="p">);</span>
	<span class="n">ESTAT_ADD</span><span class="p">(</span><span class="n">rx_ucast_packets</span><span class="p">);</span>
	<span class="n">ESTAT_ADD</span><span class="p">(</span><span class="n">rx_mcast_packets</span><span class="p">);</span>
	<span class="n">ESTAT_ADD</span><span class="p">(</span><span class="n">rx_bcast_packets</span><span class="p">);</span>
	<span class="n">ESTAT_ADD</span><span class="p">(</span><span class="n">rx_fcs_errors</span><span class="p">);</span>
	<span class="n">ESTAT_ADD</span><span class="p">(</span><span class="n">rx_align_errors</span><span class="p">);</span>
	<span class="n">ESTAT_ADD</span><span class="p">(</span><span class="n">rx_xon_pause_rcvd</span><span class="p">);</span>
	<span class="n">ESTAT_ADD</span><span class="p">(</span><span class="n">rx_xoff_pause_rcvd</span><span class="p">);</span>
	<span class="n">ESTAT_ADD</span><span class="p">(</span><span class="n">rx_mac_ctrl_rcvd</span><span class="p">);</span>
	<span class="n">ESTAT_ADD</span><span class="p">(</span><span class="n">rx_xoff_entered</span><span class="p">);</span>
	<span class="n">ESTAT_ADD</span><span class="p">(</span><span class="n">rx_frame_too_long_errors</span><span class="p">);</span>
	<span class="n">ESTAT_ADD</span><span class="p">(</span><span class="n">rx_jabbers</span><span class="p">);</span>
	<span class="n">ESTAT_ADD</span><span class="p">(</span><span class="n">rx_undersize_packets</span><span class="p">);</span>
	<span class="n">ESTAT_ADD</span><span class="p">(</span><span class="n">rx_in_length_errors</span><span class="p">);</span>
	<span class="n">ESTAT_ADD</span><span class="p">(</span><span class="n">rx_out_length_errors</span><span class="p">);</span>
	<span class="n">ESTAT_ADD</span><span class="p">(</span><span class="n">rx_64_or_less_octet_packets</span><span class="p">);</span>
	<span class="n">ESTAT_ADD</span><span class="p">(</span><span class="n">rx_65_to_127_octet_packets</span><span class="p">);</span>
	<span class="n">ESTAT_ADD</span><span class="p">(</span><span class="n">rx_128_to_255_octet_packets</span><span class="p">);</span>
	<span class="n">ESTAT_ADD</span><span class="p">(</span><span class="n">rx_256_to_511_octet_packets</span><span class="p">);</span>
	<span class="n">ESTAT_ADD</span><span class="p">(</span><span class="n">rx_512_to_1023_octet_packets</span><span class="p">);</span>
	<span class="n">ESTAT_ADD</span><span class="p">(</span><span class="n">rx_1024_to_1522_octet_packets</span><span class="p">);</span>
	<span class="n">ESTAT_ADD</span><span class="p">(</span><span class="n">rx_1523_to_2047_octet_packets</span><span class="p">);</span>
	<span class="n">ESTAT_ADD</span><span class="p">(</span><span class="n">rx_2048_to_4095_octet_packets</span><span class="p">);</span>
	<span class="n">ESTAT_ADD</span><span class="p">(</span><span class="n">rx_4096_to_8191_octet_packets</span><span class="p">);</span>
	<span class="n">ESTAT_ADD</span><span class="p">(</span><span class="n">rx_8192_to_9022_octet_packets</span><span class="p">);</span>

	<span class="n">ESTAT_ADD</span><span class="p">(</span><span class="n">tx_octets</span><span class="p">);</span>
	<span class="n">ESTAT_ADD</span><span class="p">(</span><span class="n">tx_collisions</span><span class="p">);</span>
	<span class="n">ESTAT_ADD</span><span class="p">(</span><span class="n">tx_xon_sent</span><span class="p">);</span>
	<span class="n">ESTAT_ADD</span><span class="p">(</span><span class="n">tx_xoff_sent</span><span class="p">);</span>
	<span class="n">ESTAT_ADD</span><span class="p">(</span><span class="n">tx_flow_control</span><span class="p">);</span>
	<span class="n">ESTAT_ADD</span><span class="p">(</span><span class="n">tx_mac_errors</span><span class="p">);</span>
	<span class="n">ESTAT_ADD</span><span class="p">(</span><span class="n">tx_single_collisions</span><span class="p">);</span>
	<span class="n">ESTAT_ADD</span><span class="p">(</span><span class="n">tx_mult_collisions</span><span class="p">);</span>
	<span class="n">ESTAT_ADD</span><span class="p">(</span><span class="n">tx_deferred</span><span class="p">);</span>
	<span class="n">ESTAT_ADD</span><span class="p">(</span><span class="n">tx_excessive_collisions</span><span class="p">);</span>
	<span class="n">ESTAT_ADD</span><span class="p">(</span><span class="n">tx_late_collisions</span><span class="p">);</span>
	<span class="n">ESTAT_ADD</span><span class="p">(</span><span class="n">tx_collide_2times</span><span class="p">);</span>
	<span class="n">ESTAT_ADD</span><span class="p">(</span><span class="n">tx_collide_3times</span><span class="p">);</span>
	<span class="n">ESTAT_ADD</span><span class="p">(</span><span class="n">tx_collide_4times</span><span class="p">);</span>
	<span class="n">ESTAT_ADD</span><span class="p">(</span><span class="n">tx_collide_5times</span><span class="p">);</span>
	<span class="n">ESTAT_ADD</span><span class="p">(</span><span class="n">tx_collide_6times</span><span class="p">);</span>
	<span class="n">ESTAT_ADD</span><span class="p">(</span><span class="n">tx_collide_7times</span><span class="p">);</span>
	<span class="n">ESTAT_ADD</span><span class="p">(</span><span class="n">tx_collide_8times</span><span class="p">);</span>
	<span class="n">ESTAT_ADD</span><span class="p">(</span><span class="n">tx_collide_9times</span><span class="p">);</span>
	<span class="n">ESTAT_ADD</span><span class="p">(</span><span class="n">tx_collide_10times</span><span class="p">);</span>
	<span class="n">ESTAT_ADD</span><span class="p">(</span><span class="n">tx_collide_11times</span><span class="p">);</span>
	<span class="n">ESTAT_ADD</span><span class="p">(</span><span class="n">tx_collide_12times</span><span class="p">);</span>
	<span class="n">ESTAT_ADD</span><span class="p">(</span><span class="n">tx_collide_13times</span><span class="p">);</span>
	<span class="n">ESTAT_ADD</span><span class="p">(</span><span class="n">tx_collide_14times</span><span class="p">);</span>
	<span class="n">ESTAT_ADD</span><span class="p">(</span><span class="n">tx_collide_15times</span><span class="p">);</span>
	<span class="n">ESTAT_ADD</span><span class="p">(</span><span class="n">tx_ucast_packets</span><span class="p">);</span>
	<span class="n">ESTAT_ADD</span><span class="p">(</span><span class="n">tx_mcast_packets</span><span class="p">);</span>
	<span class="n">ESTAT_ADD</span><span class="p">(</span><span class="n">tx_bcast_packets</span><span class="p">);</span>
	<span class="n">ESTAT_ADD</span><span class="p">(</span><span class="n">tx_carrier_sense_errors</span><span class="p">);</span>
	<span class="n">ESTAT_ADD</span><span class="p">(</span><span class="n">tx_discards</span><span class="p">);</span>
	<span class="n">ESTAT_ADD</span><span class="p">(</span><span class="n">tx_errors</span><span class="p">);</span>

	<span class="n">ESTAT_ADD</span><span class="p">(</span><span class="n">dma_writeq_full</span><span class="p">);</span>
	<span class="n">ESTAT_ADD</span><span class="p">(</span><span class="n">dma_write_prioq_full</span><span class="p">);</span>
	<span class="n">ESTAT_ADD</span><span class="p">(</span><span class="n">rxbds_empty</span><span class="p">);</span>
	<span class="n">ESTAT_ADD</span><span class="p">(</span><span class="n">rx_discards</span><span class="p">);</span>
	<span class="n">ESTAT_ADD</span><span class="p">(</span><span class="n">rx_errors</span><span class="p">);</span>
	<span class="n">ESTAT_ADD</span><span class="p">(</span><span class="n">rx_threshold_hit</span><span class="p">);</span>

	<span class="n">ESTAT_ADD</span><span class="p">(</span><span class="n">dma_readq_full</span><span class="p">);</span>
	<span class="n">ESTAT_ADD</span><span class="p">(</span><span class="n">dma_read_prioq_full</span><span class="p">);</span>
	<span class="n">ESTAT_ADD</span><span class="p">(</span><span class="n">tx_comp_queue_full</span><span class="p">);</span>

	<span class="n">ESTAT_ADD</span><span class="p">(</span><span class="n">ring_set_send_prod_index</span><span class="p">);</span>
	<span class="n">ESTAT_ADD</span><span class="p">(</span><span class="n">ring_status_update</span><span class="p">);</span>
	<span class="n">ESTAT_ADD</span><span class="p">(</span><span class="n">nic_irqs</span><span class="p">);</span>
	<span class="n">ESTAT_ADD</span><span class="p">(</span><span class="n">nic_avoided_irqs</span><span class="p">);</span>
	<span class="n">ESTAT_ADD</span><span class="p">(</span><span class="n">nic_tx_threshold_hit</span><span class="p">);</span>

	<span class="n">ESTAT_ADD</span><span class="p">(</span><span class="n">mbuf_lwm_thresh_hit</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tg3_get_nstats</span><span class="p">(</span><span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rtnl_link_stats64</span> <span class="o">*</span><span class="n">stats</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtnl_link_stats64</span> <span class="o">*</span><span class="n">old_stats</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">net_stats_prev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tg3_hw_stats</span> <span class="o">*</span><span class="n">hw_stats</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">hw_stats</span><span class="p">;</span>

	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">rx_packets</span> <span class="o">=</span> <span class="n">old_stats</span><span class="o">-&gt;</span><span class="n">rx_packets</span> <span class="o">+</span>
		<span class="n">get_stat64</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw_stats</span><span class="o">-&gt;</span><span class="n">rx_ucast_packets</span><span class="p">)</span> <span class="o">+</span>
		<span class="n">get_stat64</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw_stats</span><span class="o">-&gt;</span><span class="n">rx_mcast_packets</span><span class="p">)</span> <span class="o">+</span>
		<span class="n">get_stat64</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw_stats</span><span class="o">-&gt;</span><span class="n">rx_bcast_packets</span><span class="p">);</span>

	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">tx_packets</span> <span class="o">=</span> <span class="n">old_stats</span><span class="o">-&gt;</span><span class="n">tx_packets</span> <span class="o">+</span>
		<span class="n">get_stat64</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw_stats</span><span class="o">-&gt;</span><span class="n">tx_ucast_packets</span><span class="p">)</span> <span class="o">+</span>
		<span class="n">get_stat64</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw_stats</span><span class="o">-&gt;</span><span class="n">tx_mcast_packets</span><span class="p">)</span> <span class="o">+</span>
		<span class="n">get_stat64</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw_stats</span><span class="o">-&gt;</span><span class="n">tx_bcast_packets</span><span class="p">);</span>

	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">rx_bytes</span> <span class="o">=</span> <span class="n">old_stats</span><span class="o">-&gt;</span><span class="n">rx_bytes</span> <span class="o">+</span>
		<span class="n">get_stat64</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw_stats</span><span class="o">-&gt;</span><span class="n">rx_octets</span><span class="p">);</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">tx_bytes</span> <span class="o">=</span> <span class="n">old_stats</span><span class="o">-&gt;</span><span class="n">tx_bytes</span> <span class="o">+</span>
		<span class="n">get_stat64</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw_stats</span><span class="o">-&gt;</span><span class="n">tx_octets</span><span class="p">);</span>

	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">rx_errors</span> <span class="o">=</span> <span class="n">old_stats</span><span class="o">-&gt;</span><span class="n">rx_errors</span> <span class="o">+</span>
		<span class="n">get_stat64</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw_stats</span><span class="o">-&gt;</span><span class="n">rx_errors</span><span class="p">);</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">tx_errors</span> <span class="o">=</span> <span class="n">old_stats</span><span class="o">-&gt;</span><span class="n">tx_errors</span> <span class="o">+</span>
		<span class="n">get_stat64</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw_stats</span><span class="o">-&gt;</span><span class="n">tx_errors</span><span class="p">)</span> <span class="o">+</span>
		<span class="n">get_stat64</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw_stats</span><span class="o">-&gt;</span><span class="n">tx_mac_errors</span><span class="p">)</span> <span class="o">+</span>
		<span class="n">get_stat64</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw_stats</span><span class="o">-&gt;</span><span class="n">tx_carrier_sense_errors</span><span class="p">)</span> <span class="o">+</span>
		<span class="n">get_stat64</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw_stats</span><span class="o">-&gt;</span><span class="n">tx_discards</span><span class="p">);</span>

	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">multicast</span> <span class="o">=</span> <span class="n">old_stats</span><span class="o">-&gt;</span><span class="n">multicast</span> <span class="o">+</span>
		<span class="n">get_stat64</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw_stats</span><span class="o">-&gt;</span><span class="n">rx_mcast_packets</span><span class="p">);</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">collisions</span> <span class="o">=</span> <span class="n">old_stats</span><span class="o">-&gt;</span><span class="n">collisions</span> <span class="o">+</span>
		<span class="n">get_stat64</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw_stats</span><span class="o">-&gt;</span><span class="n">tx_collisions</span><span class="p">);</span>

	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">rx_length_errors</span> <span class="o">=</span> <span class="n">old_stats</span><span class="o">-&gt;</span><span class="n">rx_length_errors</span> <span class="o">+</span>
		<span class="n">get_stat64</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw_stats</span><span class="o">-&gt;</span><span class="n">rx_frame_too_long_errors</span><span class="p">)</span> <span class="o">+</span>
		<span class="n">get_stat64</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw_stats</span><span class="o">-&gt;</span><span class="n">rx_undersize_packets</span><span class="p">);</span>

	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">rx_over_errors</span> <span class="o">=</span> <span class="n">old_stats</span><span class="o">-&gt;</span><span class="n">rx_over_errors</span> <span class="o">+</span>
		<span class="n">get_stat64</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw_stats</span><span class="o">-&gt;</span><span class="n">rxbds_empty</span><span class="p">);</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">rx_frame_errors</span> <span class="o">=</span> <span class="n">old_stats</span><span class="o">-&gt;</span><span class="n">rx_frame_errors</span> <span class="o">+</span>
		<span class="n">get_stat64</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw_stats</span><span class="o">-&gt;</span><span class="n">rx_align_errors</span><span class="p">);</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">tx_aborted_errors</span> <span class="o">=</span> <span class="n">old_stats</span><span class="o">-&gt;</span><span class="n">tx_aborted_errors</span> <span class="o">+</span>
		<span class="n">get_stat64</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw_stats</span><span class="o">-&gt;</span><span class="n">tx_discards</span><span class="p">);</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">tx_carrier_errors</span> <span class="o">=</span> <span class="n">old_stats</span><span class="o">-&gt;</span><span class="n">tx_carrier_errors</span> <span class="o">+</span>
		<span class="n">get_stat64</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw_stats</span><span class="o">-&gt;</span><span class="n">tx_carrier_sense_errors</span><span class="p">);</span>

	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">rx_crc_errors</span> <span class="o">=</span> <span class="n">old_stats</span><span class="o">-&gt;</span><span class="n">rx_crc_errors</span> <span class="o">+</span>
		<span class="n">tg3_calc_crc_errors</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>

	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">rx_missed_errors</span> <span class="o">=</span> <span class="n">old_stats</span><span class="o">-&gt;</span><span class="n">rx_missed_errors</span> <span class="o">+</span>
		<span class="n">get_stat64</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw_stats</span><span class="o">-&gt;</span><span class="n">rx_discards</span><span class="p">);</span>

	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">rx_dropped</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">rx_dropped</span><span class="p">;</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">tx_dropped</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">tx_dropped</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tg3_get_regs_len</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">TG3_REG_BLK_SIZE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tg3_get_regs</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">ethtool_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">_p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">regs</span><span class="o">-&gt;</span><span class="n">version</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">_p</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">TG3_REG_BLK_SIZE</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">phy_flags</span> <span class="o">&amp;</span> <span class="n">TG3_PHYFLG_IS_LOW_POWER</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">tg3_full_lock</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">tg3_dump_legacy_regs</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="n">_p</span><span class="p">);</span>

	<span class="n">tg3_full_unlock</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tg3_get_eeprom_len</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">nvram_size</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tg3_get_eeprom</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ethtool_eeprom</span> <span class="o">*</span><span class="n">eeprom</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">u8</span>  <span class="o">*</span><span class="n">pd</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">i</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">b_offset</span><span class="p">,</span> <span class="n">b_count</span><span class="p">;</span>
	<span class="n">__be32</span> <span class="n">val</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">NO_NVRAM</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">phy_flags</span> <span class="o">&amp;</span> <span class="n">TG3_PHYFLG_IS_LOW_POWER</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>

	<span class="n">offset</span> <span class="o">=</span> <span class="n">eeprom</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">;</span>
	<span class="n">len</span> <span class="o">=</span> <span class="n">eeprom</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
	<span class="n">eeprom</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">eeprom</span><span class="o">-&gt;</span><span class="n">magic</span> <span class="o">=</span> <span class="n">TG3_EEPROM_MAGIC</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">offset</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* adjustments to start on required 4 byte boundary */</span>
		<span class="n">b_offset</span> <span class="o">=</span> <span class="n">offset</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">;</span>
		<span class="n">b_count</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">-</span> <span class="n">b_offset</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">b_count</span> <span class="o">&gt;</span> <span class="n">len</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* i.e. offset=1 len=2 */</span>
			<span class="n">b_count</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">tg3_nvram_read_be32</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">offset</span><span class="o">-</span><span class="n">b_offset</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">val</span><span class="p">)</span> <span class="o">+</span> <span class="n">b_offset</span><span class="p">,</span> <span class="n">b_count</span><span class="p">);</span>
		<span class="n">len</span> <span class="o">-=</span> <span class="n">b_count</span><span class="p">;</span>
		<span class="n">offset</span> <span class="o">+=</span> <span class="n">b_count</span><span class="p">;</span>
		<span class="n">eeprom</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">+=</span> <span class="n">b_count</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* read bytes up to the last 4 byte boundary */</span>
	<span class="n">pd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">[</span><span class="n">eeprom</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">];</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">len</span> <span class="o">-</span> <span class="p">(</span><span class="n">len</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">));</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">tg3_nvram_read_be32</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">offset</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">eeprom</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">+=</span> <span class="n">i</span><span class="p">;</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">pd</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">eeprom</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">+=</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* read last bytes not ending on 4 byte boundary */</span>
		<span class="n">pd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">[</span><span class="n">eeprom</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">];</span>
		<span class="n">b_count</span> <span class="o">=</span> <span class="n">len</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">;</span>
		<span class="n">b_offset</span> <span class="o">=</span> <span class="n">offset</span> <span class="o">+</span> <span class="n">len</span> <span class="o">-</span> <span class="n">b_count</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">tg3_nvram_read_be32</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">b_offset</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">pd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">,</span> <span class="n">b_count</span><span class="p">);</span>
		<span class="n">eeprom</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">+=</span> <span class="n">b_count</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tg3_set_eeprom</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ethtool_eeprom</span> <span class="o">*</span><span class="n">eeprom</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">offset</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">b_offset</span><span class="p">,</span> <span class="n">odd_len</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>
	<span class="n">__be32</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">phy_flags</span> <span class="o">&amp;</span> <span class="n">TG3_PHYFLG_IS_LOW_POWER</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">NO_NVRAM</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">eeprom</span><span class="o">-&gt;</span><span class="n">magic</span> <span class="o">!=</span> <span class="n">TG3_EEPROM_MAGIC</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">offset</span> <span class="o">=</span> <span class="n">eeprom</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">;</span>
	<span class="n">len</span> <span class="o">=</span> <span class="n">eeprom</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">b_offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">offset</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">)))</span> <span class="p">{</span>
		<span class="cm">/* adjustments to start on required 4 byte boundary */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">tg3_nvram_read_be32</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">offset</span><span class="o">-</span><span class="n">b_offset</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">start</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="n">len</span> <span class="o">+=</span> <span class="n">b_offset</span><span class="p">;</span>
		<span class="n">offset</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mi">3</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">)</span>
			<span class="n">len</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">odd_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* adjustments to end on required 4 byte boundary */</span>
		<span class="n">odd_len</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">len</span> <span class="o">=</span> <span class="p">(</span><span class="n">len</span> <span class="o">+</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">3</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">tg3_nvram_read_be32</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">offset</span><span class="o">+</span><span class="n">len</span><span class="o">-</span><span class="mi">4</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">end</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">buf</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">b_offset</span> <span class="o">||</span> <span class="n">odd_len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">buf</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">len</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buf</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">b_offset</span><span class="p">)</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">start</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">odd_len</span><span class="p">)</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">buf</span><span class="o">+</span><span class="n">len</span><span class="o">-</span><span class="mi">4</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">end</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">b_offset</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">eeprom</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">tg3_nvram_write_block</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">buf</span> <span class="o">!=</span> <span class="n">data</span><span class="p">)</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tg3_get_settings</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ethtool_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">USE_PHYLIB</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">phy_device</span> <span class="o">*</span><span class="n">phydev</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">phy_flags</span> <span class="o">&amp;</span> <span class="n">TG3_PHYFLG_IS_CONNECTED</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
		<span class="n">phydev</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">mdio_bus</span><span class="o">-&gt;</span><span class="n">phy_map</span><span class="p">[</span><span class="n">TG3_PHY_MII_ADDR</span><span class="p">];</span>
		<span class="k">return</span> <span class="n">phy_ethtool_gset</span><span class="p">(</span><span class="n">phydev</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">supported</span> <span class="o">=</span> <span class="p">(</span><span class="n">SUPPORTED_Autoneg</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">phy_flags</span> <span class="o">&amp;</span> <span class="n">TG3_PHYFLG_10_100_ONLY</span><span class="p">))</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">supported</span> <span class="o">|=</span> <span class="p">(</span><span class="n">SUPPORTED_1000baseT_Half</span> <span class="o">|</span>
				   <span class="n">SUPPORTED_1000baseT_Full</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">phy_flags</span> <span class="o">&amp;</span> <span class="n">TG3_PHYFLG_ANY_SERDES</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">supported</span> <span class="o">|=</span> <span class="p">(</span><span class="n">SUPPORTED_100baseT_Half</span> <span class="o">|</span>
				  <span class="n">SUPPORTED_100baseT_Full</span> <span class="o">|</span>
				  <span class="n">SUPPORTED_10baseT_Half</span> <span class="o">|</span>
				  <span class="n">SUPPORTED_10baseT_Full</span> <span class="o">|</span>
				  <span class="n">SUPPORTED_TP</span><span class="p">);</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">=</span> <span class="n">PORT_TP</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">supported</span> <span class="o">|=</span> <span class="n">SUPPORTED_FIBRE</span><span class="p">;</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">=</span> <span class="n">PORT_FIBRE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">advertising</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">link_config</span><span class="p">.</span><span class="n">advertising</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">PAUSE_AUTONEG</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">link_config</span><span class="p">.</span><span class="n">flowctrl</span> <span class="o">&amp;</span> <span class="n">FLOW_CTRL_RX</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">link_config</span><span class="p">.</span><span class="n">flowctrl</span> <span class="o">&amp;</span> <span class="n">FLOW_CTRL_TX</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">advertising</span> <span class="o">|=</span> <span class="n">ADVERTISED_Pause</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">advertising</span> <span class="o">|=</span> <span class="n">ADVERTISED_Pause</span> <span class="o">|</span>
						    <span class="n">ADVERTISED_Asym_Pause</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">link_config</span><span class="p">.</span><span class="n">flowctrl</span> <span class="o">&amp;</span> <span class="n">FLOW_CTRL_TX</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">advertising</span> <span class="o">|=</span> <span class="n">ADVERTISED_Asym_Pause</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">netif_running</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">netif_carrier_ok</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ethtool_cmd_speed_set</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">link_config</span><span class="p">.</span><span class="n">active_speed</span><span class="p">);</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">duplex</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">link_config</span><span class="p">.</span><span class="n">active_duplex</span><span class="p">;</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">lp_advertising</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">link_config</span><span class="p">.</span><span class="n">rmt_adv</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">phy_flags</span> <span class="o">&amp;</span> <span class="n">TG3_PHYFLG_ANY_SERDES</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">phy_flags</span> <span class="o">&amp;</span> <span class="n">TG3_PHYFLG_MDIX_STATE</span><span class="p">)</span>
				<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">eth_tp_mdix</span> <span class="o">=</span> <span class="n">ETH_TP_MDI_X</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">eth_tp_mdix</span> <span class="o">=</span> <span class="n">ETH_TP_MDI</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ethtool_cmd_speed_set</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">SPEED_UNKNOWN</span><span class="p">);</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">duplex</span> <span class="o">=</span> <span class="n">DUPLEX_UNKNOWN</span><span class="p">;</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">eth_tp_mdix</span> <span class="o">=</span> <span class="n">ETH_TP_MDI_INVALID</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">phy_address</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">phy_addr</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">transceiver</span> <span class="o">=</span> <span class="n">XCVR_INTERNAL</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">autoneg</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">link_config</span><span class="p">.</span><span class="n">autoneg</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">maxtxpkt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">maxrxpkt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tg3_set_settings</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ethtool_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">speed</span> <span class="o">=</span> <span class="n">ethtool_cmd_speed</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">USE_PHYLIB</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">phy_device</span> <span class="o">*</span><span class="n">phydev</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">phy_flags</span> <span class="o">&amp;</span> <span class="n">TG3_PHYFLG_IS_CONNECTED</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
		<span class="n">phydev</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">mdio_bus</span><span class="o">-&gt;</span><span class="n">phy_map</span><span class="p">[</span><span class="n">TG3_PHY_MII_ADDR</span><span class="p">];</span>
		<span class="k">return</span> <span class="n">phy_ethtool_sset</span><span class="p">(</span><span class="n">phydev</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">autoneg</span> <span class="o">!=</span> <span class="n">AUTONEG_ENABLE</span> <span class="o">&amp;&amp;</span>
	    <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">autoneg</span> <span class="o">!=</span> <span class="n">AUTONEG_DISABLE</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">autoneg</span> <span class="o">==</span> <span class="n">AUTONEG_DISABLE</span> <span class="o">&amp;&amp;</span>
	    <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">duplex</span> <span class="o">!=</span> <span class="n">DUPLEX_FULL</span> <span class="o">&amp;&amp;</span>
	    <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">duplex</span> <span class="o">!=</span> <span class="n">DUPLEX_HALF</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">autoneg</span> <span class="o">==</span> <span class="n">AUTONEG_ENABLE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">mask</span> <span class="o">=</span> <span class="n">ADVERTISED_Autoneg</span> <span class="o">|</span>
			   <span class="n">ADVERTISED_Pause</span> <span class="o">|</span>
			   <span class="n">ADVERTISED_Asym_Pause</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">phy_flags</span> <span class="o">&amp;</span> <span class="n">TG3_PHYFLG_10_100_ONLY</span><span class="p">))</span>
			<span class="n">mask</span> <span class="o">|=</span> <span class="n">ADVERTISED_1000baseT_Half</span> <span class="o">|</span>
				<span class="n">ADVERTISED_1000baseT_Full</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">phy_flags</span> <span class="o">&amp;</span> <span class="n">TG3_PHYFLG_ANY_SERDES</span><span class="p">))</span>
			<span class="n">mask</span> <span class="o">|=</span> <span class="n">ADVERTISED_100baseT_Half</span> <span class="o">|</span>
				<span class="n">ADVERTISED_100baseT_Full</span> <span class="o">|</span>
				<span class="n">ADVERTISED_10baseT_Half</span> <span class="o">|</span>
				<span class="n">ADVERTISED_10baseT_Full</span> <span class="o">|</span>
				<span class="n">ADVERTISED_TP</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">mask</span> <span class="o">|=</span> <span class="n">ADVERTISED_FIBRE</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">advertising</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">mask</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

		<span class="n">mask</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="n">ADVERTISED_1000baseT_Half</span> <span class="o">|</span>
			 <span class="n">ADVERTISED_1000baseT_Full</span> <span class="o">|</span>
			 <span class="n">ADVERTISED_100baseT_Half</span> <span class="o">|</span>
			 <span class="n">ADVERTISED_100baseT_Full</span> <span class="o">|</span>
			 <span class="n">ADVERTISED_10baseT_Half</span> <span class="o">|</span>
			 <span class="n">ADVERTISED_10baseT_Full</span><span class="p">);</span>

		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">advertising</span> <span class="o">&amp;=</span> <span class="n">mask</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">phy_flags</span> <span class="o">&amp;</span> <span class="n">TG3_PHYFLG_ANY_SERDES</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">speed</span> <span class="o">!=</span> <span class="n">SPEED_1000</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">duplex</span> <span class="o">!=</span> <span class="n">DUPLEX_FULL</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">speed</span> <span class="o">!=</span> <span class="n">SPEED_100</span> <span class="o">&amp;&amp;</span>
			    <span class="n">speed</span> <span class="o">!=</span> <span class="n">SPEED_10</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">tg3_full_lock</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">link_config</span><span class="p">.</span><span class="n">autoneg</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">autoneg</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">autoneg</span> <span class="o">==</span> <span class="n">AUTONEG_ENABLE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">link_config</span><span class="p">.</span><span class="n">advertising</span> <span class="o">=</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">advertising</span> <span class="o">|</span>
					      <span class="n">ADVERTISED_Autoneg</span><span class="p">);</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">link_config</span><span class="p">.</span><span class="n">speed</span> <span class="o">=</span> <span class="n">SPEED_UNKNOWN</span><span class="p">;</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">link_config</span><span class="p">.</span><span class="n">duplex</span> <span class="o">=</span> <span class="n">DUPLEX_UNKNOWN</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">link_config</span><span class="p">.</span><span class="n">advertising</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">link_config</span><span class="p">.</span><span class="n">speed</span> <span class="o">=</span> <span class="n">speed</span><span class="p">;</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">link_config</span><span class="p">.</span><span class="n">duplex</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">duplex</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">netif_running</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="n">tg3_setup_phy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">tg3_full_unlock</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tg3_get_drvinfo</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ethtool_drvinfo</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">strlcpy</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">,</span> <span class="n">DRV_MODULE_NAME</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">));</span>
	<span class="n">strlcpy</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">,</span> <span class="n">DRV_MODULE_VERSION</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">));</span>
	<span class="n">strlcpy</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">fw_version</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">fw_ver</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">fw_version</span><span class="p">));</span>
	<span class="n">strlcpy</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">bus_info</span><span class="p">,</span> <span class="n">pci_name</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">),</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">bus_info</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tg3_get_wol</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ethtool_wolinfo</span> <span class="o">*</span><span class="n">wol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">WOL_CAP</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">device_can_wakeup</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">))</span>
		<span class="n">wol</span><span class="o">-&gt;</span><span class="n">supported</span> <span class="o">=</span> <span class="n">WAKE_MAGIC</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">wol</span><span class="o">-&gt;</span><span class="n">supported</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">wol</span><span class="o">-&gt;</span><span class="n">wolopts</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">WOL_ENABLE</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">device_can_wakeup</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">))</span>
		<span class="n">wol</span><span class="o">-&gt;</span><span class="n">wolopts</span> <span class="o">=</span> <span class="n">WAKE_MAGIC</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wol</span><span class="o">-&gt;</span><span class="n">sopass</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">wol</span><span class="o">-&gt;</span><span class="n">sopass</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tg3_set_wol</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ethtool_wolinfo</span> <span class="o">*</span><span class="n">wol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wol</span><span class="o">-&gt;</span><span class="n">wolopts</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">WAKE_MAGIC</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">wol</span><span class="o">-&gt;</span><span class="n">wolopts</span> <span class="o">&amp;</span> <span class="n">WAKE_MAGIC</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">WOL_CAP</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">device_can_wakeup</span><span class="p">(</span><span class="n">dp</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">device_set_wakeup_enable</span><span class="p">(</span><span class="n">dp</span><span class="p">,</span> <span class="n">wol</span><span class="o">-&gt;</span><span class="n">wolopts</span> <span class="o">&amp;</span> <span class="n">WAKE_MAGIC</span><span class="p">);</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">device_may_wakeup</span><span class="p">(</span><span class="n">dp</span><span class="p">))</span>
		<span class="n">tg3_flag_set</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">WOL_ENABLE</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">tg3_flag_clear</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">WOL_ENABLE</span><span class="p">);</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">tg3_get_msglevel</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">msg_enable</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tg3_set_msglevel</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">msg_enable</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tg3_nway_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">netif_running</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">phy_flags</span> <span class="o">&amp;</span> <span class="n">TG3_PHYFLG_PHY_SERDES</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">USE_PHYLIB</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">phy_flags</span> <span class="o">&amp;</span> <span class="n">TG3_PHYFLG_IS_CONNECTED</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">phy_start_aneg</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">mdio_bus</span><span class="o">-&gt;</span><span class="n">phy_map</span><span class="p">[</span><span class="n">TG3_PHY_MII_ADDR</span><span class="p">]);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">bmcr</span><span class="p">;</span>

		<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="n">tg3_readphy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">MII_BMCR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bmcr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tg3_readphy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">MII_BMCR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bmcr</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">((</span><span class="n">bmcr</span> <span class="o">&amp;</span> <span class="n">BMCR_ANENABLE</span><span class="p">)</span> <span class="o">||</span>
		     <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">phy_flags</span> <span class="o">&amp;</span> <span class="n">TG3_PHYFLG_PARALLEL_DETECT</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">tg3_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">MII_BMCR</span><span class="p">,</span> <span class="n">bmcr</span> <span class="o">|</span> <span class="n">BMCR_ANRESTART</span> <span class="o">|</span>
						   <span class="n">BMCR_ANENABLE</span><span class="p">);</span>
			<span class="n">r</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tg3_get_ringparam</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ethtool_ringparam</span> <span class="o">*</span><span class="n">ering</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">ering</span><span class="o">-&gt;</span><span class="n">rx_max_pending</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">rx_std_ring_mask</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">JUMBO_RING_ENABLE</span><span class="p">))</span>
		<span class="n">ering</span><span class="o">-&gt;</span><span class="n">rx_jumbo_max_pending</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">rx_jmb_ring_mask</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">ering</span><span class="o">-&gt;</span><span class="n">rx_jumbo_max_pending</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ering</span><span class="o">-&gt;</span><span class="n">tx_max_pending</span> <span class="o">=</span> <span class="n">TG3_TX_RING_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">ering</span><span class="o">-&gt;</span><span class="n">rx_pending</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">rx_pending</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">JUMBO_RING_ENABLE</span><span class="p">))</span>
		<span class="n">ering</span><span class="o">-&gt;</span><span class="n">rx_jumbo_pending</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">rx_jumbo_pending</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">ering</span><span class="o">-&gt;</span><span class="n">rx_jumbo_pending</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ering</span><span class="o">-&gt;</span><span class="n">tx_pending</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">tx_pending</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tg3_set_ringparam</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ethtool_ringparam</span> <span class="o">*</span><span class="n">ering</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">irq_sync</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ering</span><span class="o">-&gt;</span><span class="n">rx_pending</span> <span class="o">&gt;</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">rx_std_ring_mask</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">ering</span><span class="o">-&gt;</span><span class="n">rx_jumbo_pending</span> <span class="o">&gt;</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">rx_jmb_ring_mask</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">ering</span><span class="o">-&gt;</span><span class="n">tx_pending</span> <span class="o">&gt;</span> <span class="n">TG3_TX_RING_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">ering</span><span class="o">-&gt;</span><span class="n">tx_pending</span> <span class="o">&lt;=</span> <span class="n">MAX_SKB_FRAGS</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">TSO_BUG</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	     <span class="p">(</span><span class="n">ering</span><span class="o">-&gt;</span><span class="n">tx_pending</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="n">MAX_SKB_FRAGS</span> <span class="o">*</span> <span class="mi">3</span><span class="p">))))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">netif_running</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">tg3_phy_stop</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
		<span class="n">tg3_netif_stop</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
		<span class="n">irq_sync</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">tg3_full_lock</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">irq_sync</span><span class="p">);</span>

	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">rx_pending</span> <span class="o">=</span> <span class="n">ering</span><span class="o">-&gt;</span><span class="n">rx_pending</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">MAX_RXPEND_64</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">tp</span><span class="o">-&gt;</span><span class="n">rx_pending</span> <span class="o">&gt;</span> <span class="mi">63</span><span class="p">)</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">rx_pending</span> <span class="o">=</span> <span class="mi">63</span><span class="p">;</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">rx_jumbo_pending</span> <span class="o">=</span> <span class="n">ering</span><span class="o">-&gt;</span><span class="n">rx_jumbo_pending</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">irq_max</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">tx_pending</span> <span class="o">=</span> <span class="n">ering</span><span class="o">-&gt;</span><span class="n">tx_pending</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">netif_running</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">tg3_halt</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">RESET_KIND_SHUTDOWN</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">tg3_restart_hw</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span>
			<span class="n">tg3_netif_start</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">tg3_full_unlock</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">irq_sync</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">err</span><span class="p">)</span>
		<span class="n">tg3_phy_start</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tg3_get_pauseparam</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ethtool_pauseparam</span> <span class="o">*</span><span class="n">epause</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">epause</span><span class="o">-&gt;</span><span class="n">autoneg</span> <span class="o">=</span> <span class="o">!!</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">PAUSE_AUTONEG</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">link_config</span><span class="p">.</span><span class="n">flowctrl</span> <span class="o">&amp;</span> <span class="n">FLOW_CTRL_RX</span><span class="p">)</span>
		<span class="n">epause</span><span class="o">-&gt;</span><span class="n">rx_pause</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">epause</span><span class="o">-&gt;</span><span class="n">rx_pause</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">link_config</span><span class="p">.</span><span class="n">flowctrl</span> <span class="o">&amp;</span> <span class="n">FLOW_CTRL_TX</span><span class="p">)</span>
		<span class="n">epause</span><span class="o">-&gt;</span><span class="n">tx_pause</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">epause</span><span class="o">-&gt;</span><span class="n">tx_pause</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tg3_set_pauseparam</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ethtool_pauseparam</span> <span class="o">*</span><span class="n">epause</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">USE_PHYLIB</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">newadv</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">phy_device</span> <span class="o">*</span><span class="n">phydev</span><span class="p">;</span>

		<span class="n">phydev</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">mdio_bus</span><span class="o">-&gt;</span><span class="n">phy_map</span><span class="p">[</span><span class="n">TG3_PHY_MII_ADDR</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">phydev</span><span class="o">-&gt;</span><span class="n">supported</span> <span class="o">&amp;</span> <span class="n">SUPPORTED_Pause</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">phydev</span><span class="o">-&gt;</span><span class="n">supported</span> <span class="o">&amp;</span> <span class="n">SUPPORTED_Asym_Pause</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		     <span class="p">(</span><span class="n">epause</span><span class="o">-&gt;</span><span class="n">rx_pause</span> <span class="o">!=</span> <span class="n">epause</span><span class="o">-&gt;</span><span class="n">tx_pause</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">link_config</span><span class="p">.</span><span class="n">flowctrl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">epause</span><span class="o">-&gt;</span><span class="n">rx_pause</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">tp</span><span class="o">-&gt;</span><span class="n">link_config</span><span class="p">.</span><span class="n">flowctrl</span> <span class="o">|=</span> <span class="n">FLOW_CTRL_RX</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">epause</span><span class="o">-&gt;</span><span class="n">tx_pause</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">tp</span><span class="o">-&gt;</span><span class="n">link_config</span><span class="p">.</span><span class="n">flowctrl</span> <span class="o">|=</span> <span class="n">FLOW_CTRL_TX</span><span class="p">;</span>
				<span class="n">newadv</span> <span class="o">=</span> <span class="n">ADVERTISED_Pause</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="n">newadv</span> <span class="o">=</span> <span class="n">ADVERTISED_Pause</span> <span class="o">|</span>
					 <span class="n">ADVERTISED_Asym_Pause</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">epause</span><span class="o">-&gt;</span><span class="n">tx_pause</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">tp</span><span class="o">-&gt;</span><span class="n">link_config</span><span class="p">.</span><span class="n">flowctrl</span> <span class="o">|=</span> <span class="n">FLOW_CTRL_TX</span><span class="p">;</span>
			<span class="n">newadv</span> <span class="o">=</span> <span class="n">ADVERTISED_Asym_Pause</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">newadv</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">epause</span><span class="o">-&gt;</span><span class="n">autoneg</span><span class="p">)</span>
			<span class="n">tg3_flag_set</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">PAUSE_AUTONEG</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">tg3_flag_clear</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">PAUSE_AUTONEG</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">phy_flags</span> <span class="o">&amp;</span> <span class="n">TG3_PHYFLG_IS_CONNECTED</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u32</span> <span class="n">oldadv</span> <span class="o">=</span> <span class="n">phydev</span><span class="o">-&gt;</span><span class="n">advertising</span> <span class="o">&amp;</span>
				     <span class="p">(</span><span class="n">ADVERTISED_Pause</span> <span class="o">|</span> <span class="n">ADVERTISED_Asym_Pause</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">oldadv</span> <span class="o">!=</span> <span class="n">newadv</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">phydev</span><span class="o">-&gt;</span><span class="n">advertising</span> <span class="o">&amp;=</span>
					<span class="o">~</span><span class="p">(</span><span class="n">ADVERTISED_Pause</span> <span class="o">|</span>
					  <span class="n">ADVERTISED_Asym_Pause</span><span class="p">);</span>
				<span class="n">phydev</span><span class="o">-&gt;</span><span class="n">advertising</span> <span class="o">|=</span> <span class="n">newadv</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">phydev</span><span class="o">-&gt;</span><span class="n">autoneg</span><span class="p">)</span> <span class="p">{</span>
					<span class="cm">/*</span>
<span class="cm">					 * Always renegotiate the link to</span>
<span class="cm">					 * inform our link partner of our</span>
<span class="cm">					 * flow control settings, even if the</span>
<span class="cm">					 * flow control is forced.  Let</span>
<span class="cm">					 * tg3_adjust_link() do the final</span>
<span class="cm">					 * flow control setup.</span>
<span class="cm">					 */</span>
					<span class="k">return</span> <span class="n">phy_start_aneg</span><span class="p">(</span><span class="n">phydev</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">epause</span><span class="o">-&gt;</span><span class="n">autoneg</span><span class="p">)</span>
				<span class="n">tg3_setup_flow_control</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">tp</span><span class="o">-&gt;</span><span class="n">link_config</span><span class="p">.</span><span class="n">advertising</span> <span class="o">&amp;=</span>
					<span class="o">~</span><span class="p">(</span><span class="n">ADVERTISED_Pause</span> <span class="o">|</span>
					  <span class="n">ADVERTISED_Asym_Pause</span><span class="p">);</span>
			<span class="n">tp</span><span class="o">-&gt;</span><span class="n">link_config</span><span class="p">.</span><span class="n">advertising</span> <span class="o">|=</span> <span class="n">newadv</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">irq_sync</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">netif_running</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">tg3_netif_stop</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
			<span class="n">irq_sync</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">tg3_full_lock</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">irq_sync</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">epause</span><span class="o">-&gt;</span><span class="n">autoneg</span><span class="p">)</span>
			<span class="n">tg3_flag_set</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">PAUSE_AUTONEG</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">tg3_flag_clear</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">PAUSE_AUTONEG</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">epause</span><span class="o">-&gt;</span><span class="n">rx_pause</span><span class="p">)</span>
			<span class="n">tp</span><span class="o">-&gt;</span><span class="n">link_config</span><span class="p">.</span><span class="n">flowctrl</span> <span class="o">|=</span> <span class="n">FLOW_CTRL_RX</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">tp</span><span class="o">-&gt;</span><span class="n">link_config</span><span class="p">.</span><span class="n">flowctrl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">FLOW_CTRL_RX</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">epause</span><span class="o">-&gt;</span><span class="n">tx_pause</span><span class="p">)</span>
			<span class="n">tp</span><span class="o">-&gt;</span><span class="n">link_config</span><span class="p">.</span><span class="n">flowctrl</span> <span class="o">|=</span> <span class="n">FLOW_CTRL_TX</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">tp</span><span class="o">-&gt;</span><span class="n">link_config</span><span class="p">.</span><span class="n">flowctrl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">FLOW_CTRL_TX</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">netif_running</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">tg3_halt</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">RESET_KIND_SHUTDOWN</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">tg3_restart_hw</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span>
				<span class="n">tg3_netif_start</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">tg3_full_unlock</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tg3_get_sset_count</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">sset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">sset</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ETH_SS_TEST</span>:
		<span class="k">return</span> <span class="n">TG3_NUM_TEST</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ETH_SS_STATS</span>:
		<span class="k">return</span> <span class="n">TG3_NUM_STATS</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tg3_get_rxnfc</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ethtool_rxnfc</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			 <span class="n">u32</span> <span class="o">*</span><span class="n">rules</span> <span class="n">__always_unused</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">SUPPORT_MSIX</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ETHTOOL_GRXRINGS</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">netif_running</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">))</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">irq_cnt</span><span class="p">;</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">=</span> <span class="n">num_online_cpus</span><span class="p">();</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">&gt;</span> <span class="n">TG3_IRQ_MAX_VECS_RSS</span><span class="p">)</span>
				<span class="n">info</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">=</span> <span class="n">TG3_IRQ_MAX_VECS_RSS</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* The first interrupt vector only</span>
<span class="cm">		 * handles link interrupts.</span>
<span class="cm">		 */</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">-=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">tg3_get_rxfh_indir_size</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">SUPPORT_MSIX</span><span class="p">))</span>
		<span class="n">size</span> <span class="o">=</span> <span class="n">TG3_RSS_INDIR_TBL_SIZE</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">size</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tg3_get_rxfh_indir</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">indir</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">TG3_RSS_INDIR_TBL_SIZE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">indir</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">rss_ind_tbl</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tg3_set_rxfh_indir</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">const</span> <span class="n">u32</span> <span class="o">*</span><span class="n">indir</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">size_t</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">TG3_RSS_INDIR_TBL_SIZE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">rss_ind_tbl</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">indir</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">netif_running</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">ENABLE_RSS</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* It is legal to write the indirection</span>
<span class="cm">	 * table while the device is running.</span>
<span class="cm">	 */</span>
	<span class="n">tg3_full_lock</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">tg3_rss_write_indir_tbl</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
	<span class="n">tg3_full_unlock</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tg3_get_strings</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">stringset</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">stringset</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ETH_SS_STATS</span>:
		<span class="n">memcpy</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ethtool_stats_keys</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ethtool_stats_keys</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ETH_SS_TEST</span>:
		<span class="n">memcpy</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ethtool_test_keys</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ethtool_test_keys</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">WARN_ON</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>	<span class="cm">/* we need a WARN() */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tg3_set_phys_id</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			    <span class="k">enum</span> <span class="n">ethtool_phys_id_state</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">netif_running</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ETHTOOL_ID_ACTIVE</span>:
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* cycle on/off once per second */</span>

	<span class="k">case</span> <span class="n">ETHTOOL_ID_ON</span>:
		<span class="n">tw32</span><span class="p">(</span><span class="n">MAC_LED_CTRL</span><span class="p">,</span> <span class="n">LED_CTRL_LNKLED_OVERRIDE</span> <span class="o">|</span>
		     <span class="n">LED_CTRL_1000MBPS_ON</span> <span class="o">|</span>
		     <span class="n">LED_CTRL_100MBPS_ON</span> <span class="o">|</span>
		     <span class="n">LED_CTRL_10MBPS_ON</span> <span class="o">|</span>
		     <span class="n">LED_CTRL_TRAFFIC_OVERRIDE</span> <span class="o">|</span>
		     <span class="n">LED_CTRL_TRAFFIC_BLINK</span> <span class="o">|</span>
		     <span class="n">LED_CTRL_TRAFFIC_LED</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">ETHTOOL_ID_OFF</span>:
		<span class="n">tw32</span><span class="p">(</span><span class="n">MAC_LED_CTRL</span><span class="p">,</span> <span class="n">LED_CTRL_LNKLED_OVERRIDE</span> <span class="o">|</span>
		     <span class="n">LED_CTRL_TRAFFIC_OVERRIDE</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">ETHTOOL_ID_INACTIVE</span>:
		<span class="n">tw32</span><span class="p">(</span><span class="n">MAC_LED_CTRL</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">led_ctrl</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tg3_get_ethtool_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">ethtool_stats</span> <span class="o">*</span><span class="n">estats</span><span class="p">,</span> <span class="n">u64</span> <span class="o">*</span><span class="n">tmp_stats</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">hw_stats</span><span class="p">)</span>
		<span class="n">tg3_get_estats</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">tg3_ethtool_stats</span> <span class="o">*</span><span class="p">)</span><span class="n">tmp_stats</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">tmp_stats</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">tg3_ethtool_stats</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__be32</span> <span class="o">*</span><span class="nf">tg3_vpd_readblock</span><span class="p">(</span><span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">vpdlen</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">__be32</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">magic</span><span class="p">,</span> <span class="n">val</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">NO_NVRAM</span><span class="p">)</span> <span class="o">||</span> <span class="n">tg3_nvram_read</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">magic</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">magic</span> <span class="o">==</span> <span class="n">TG3_EEPROM_MAGIC</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">offset</span> <span class="o">=</span> <span class="n">TG3_NVM_DIR_START</span><span class="p">;</span>
		     <span class="n">offset</span> <span class="o">&lt;</span> <span class="n">TG3_NVM_DIR_END</span><span class="p">;</span>
		     <span class="n">offset</span> <span class="o">+=</span> <span class="n">TG3_NVM_DIRENT_SIZE</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tg3_nvram_read</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">))</span>
				<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">((</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="n">TG3_NVM_DIRTYPE_SHIFT</span><span class="p">)</span> <span class="o">==</span>
			    <span class="n">TG3_NVM_DIRTYPE_EXTVPD</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">offset</span> <span class="o">!=</span> <span class="n">TG3_NVM_DIR_END</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">len</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">TG3_NVM_DIRTYPE_LENMSK</span><span class="p">)</span> <span class="o">*</span> <span class="mi">4</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tg3_nvram_read</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">offset</span> <span class="o">+</span> <span class="mi">4</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">offset</span><span class="p">))</span>
				<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

			<span class="n">offset</span> <span class="o">=</span> <span class="n">tg3_nvram_logical_addr</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">offset</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">offset</span> <span class="o">||</span> <span class="o">!</span><span class="n">len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">offset</span> <span class="o">=</span> <span class="n">TG3_NVM_VPD_OFF</span><span class="p">;</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">TG3_NVM_VPD_LEN</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">buf</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">len</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">buf</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">magic</span> <span class="o">==</span> <span class="n">TG3_EEPROM_MAGIC</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* The data is in little-endian format in NVRAM.</span>
<span class="cm">			 * Use the big-endian read routines to preserve</span>
<span class="cm">			 * the byte order as it exists in NVRAM.</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tg3_nvram_read_be32</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">offset</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="o">/</span><span class="mi">4</span><span class="p">]))</span>
				<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="o">*</span><span class="n">ptr</span><span class="p">;</span>
		<span class="kt">ssize_t</span> <span class="n">cnt</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">ptr</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">pos</span> <span class="o">&lt;</span> <span class="n">len</span> <span class="o">&amp;&amp;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">pos</span> <span class="o">+=</span> <span class="n">cnt</span><span class="p">,</span> <span class="n">ptr</span> <span class="o">+=</span> <span class="n">cnt</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cnt</span> <span class="o">=</span> <span class="n">pci_read_vpd</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span>
					   <span class="n">len</span> <span class="o">-</span> <span class="n">pos</span><span class="p">,</span> <span class="n">ptr</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">==</span> <span class="o">-</span><span class="n">ETIMEDOUT</span> <span class="o">||</span> <span class="n">cnt</span> <span class="o">==</span> <span class="o">-</span><span class="n">EINTR</span><span class="p">)</span>
				<span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pos</span> <span class="o">!=</span> <span class="n">len</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="o">*</span><span class="n">vpdlen</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">buf</span><span class="p">;</span>

<span class="nl">error:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define NVRAM_TEST_SIZE 0x100</span>
<span class="cp">#define NVRAM_SELFBOOT_FORMAT1_0_SIZE	0x14</span>
<span class="cp">#define NVRAM_SELFBOOT_FORMAT1_2_SIZE	0x18</span>
<span class="cp">#define NVRAM_SELFBOOT_FORMAT1_3_SIZE	0x1c</span>
<span class="cp">#define NVRAM_SELFBOOT_FORMAT1_4_SIZE	0x20</span>
<span class="cp">#define NVRAM_SELFBOOT_FORMAT1_5_SIZE	0x24</span>
<span class="cp">#define NVRAM_SELFBOOT_FORMAT1_6_SIZE	0x50</span>
<span class="cp">#define NVRAM_SELFBOOT_HW_SIZE 0x20</span>
<span class="cp">#define NVRAM_SELFBOOT_DATA_SIZE 0x1c</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tg3_test_nvram</span><span class="p">(</span><span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">csum</span><span class="p">,</span> <span class="n">magic</span><span class="p">,</span> <span class="n">len</span><span class="p">;</span>
	<span class="n">__be32</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">size</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">NO_NVRAM</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tg3_nvram_read</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">magic</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">magic</span> <span class="o">==</span> <span class="n">TG3_EEPROM_MAGIC</span><span class="p">)</span>
		<span class="n">size</span> <span class="o">=</span> <span class="n">NVRAM_TEST_SIZE</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">magic</span> <span class="o">&amp;</span> <span class="n">TG3_EEPROM_MAGIC_FW_MSK</span><span class="p">)</span> <span class="o">==</span> <span class="n">TG3_EEPROM_MAGIC_FW</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">magic</span> <span class="o">&amp;</span> <span class="n">TG3_EEPROM_SB_FORMAT_MASK</span><span class="p">)</span> <span class="o">==</span>
		    <span class="n">TG3_EEPROM_SB_FORMAT_1</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">magic</span> <span class="o">&amp;</span> <span class="n">TG3_EEPROM_SB_REVISION_MASK</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">TG3_EEPROM_SB_REVISION_0</span>:
				<span class="n">size</span> <span class="o">=</span> <span class="n">NVRAM_SELFBOOT_FORMAT1_0_SIZE</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">TG3_EEPROM_SB_REVISION_2</span>:
				<span class="n">size</span> <span class="o">=</span> <span class="n">NVRAM_SELFBOOT_FORMAT1_2_SIZE</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">TG3_EEPROM_SB_REVISION_3</span>:
				<span class="n">size</span> <span class="o">=</span> <span class="n">NVRAM_SELFBOOT_FORMAT1_3_SIZE</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">TG3_EEPROM_SB_REVISION_4</span>:
				<span class="n">size</span> <span class="o">=</span> <span class="n">NVRAM_SELFBOOT_FORMAT1_4_SIZE</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">TG3_EEPROM_SB_REVISION_5</span>:
				<span class="n">size</span> <span class="o">=</span> <span class="n">NVRAM_SELFBOOT_FORMAT1_5_SIZE</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">TG3_EEPROM_SB_REVISION_6</span>:
				<span class="n">size</span> <span class="o">=</span> <span class="n">NVRAM_SELFBOOT_FORMAT1_6_SIZE</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">magic</span> <span class="o">&amp;</span> <span class="n">TG3_EEPROM_MAGIC_HW_MSK</span><span class="p">)</span> <span class="o">==</span> <span class="n">TG3_EEPROM_MAGIC_HW</span><span class="p">)</span>
		<span class="n">size</span> <span class="o">=</span> <span class="n">NVRAM_SELFBOOT_HW_SIZE</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="n">buf</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">buf</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">size</span><span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">,</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">tg3_nvram_read_be32</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buf</span><span class="p">[</span><span class="n">j</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">size</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="cm">/* Selfboot format */</span>
	<span class="n">magic</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">magic</span> <span class="o">&amp;</span> <span class="n">TG3_EEPROM_MAGIC_FW_MSK</span><span class="p">)</span> <span class="o">==</span>
	    <span class="n">TG3_EEPROM_MAGIC_FW</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="o">*</span><span class="n">buf8</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">buf</span><span class="p">,</span> <span class="n">csum8</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">magic</span> <span class="o">&amp;</span> <span class="n">TG3_EEPROM_SB_REVISION_MASK</span><span class="p">)</span> <span class="o">==</span>
		    <span class="n">TG3_EEPROM_SB_REVISION_2</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* For rev 2, the csum doesn&#39;t include the MBA. */</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">TG3_EEPROM_SB_F1R2_MBA_OFF</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
				<span class="n">csum8</span> <span class="o">+=</span> <span class="n">buf8</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">TG3_EEPROM_SB_F1R2_MBA_OFF</span> <span class="o">+</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">size</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
				<span class="n">csum8</span> <span class="o">+=</span> <span class="n">buf8</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">size</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
				<span class="n">csum8</span> <span class="o">+=</span> <span class="n">buf8</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">csum8</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">magic</span> <span class="o">&amp;</span> <span class="n">TG3_EEPROM_MAGIC_HW_MSK</span><span class="p">)</span> <span class="o">==</span>
	    <span class="n">TG3_EEPROM_MAGIC_HW</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="n">data</span><span class="p">[</span><span class="n">NVRAM_SELFBOOT_DATA_SIZE</span><span class="p">];</span>
		<span class="n">u8</span> <span class="n">parity</span><span class="p">[</span><span class="n">NVRAM_SELFBOOT_DATA_SIZE</span><span class="p">];</span>
		<span class="n">u8</span> <span class="o">*</span><span class="n">buf8</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">buf</span><span class="p">;</span>

		<span class="cm">/* Separate the parity bits and the data bytes.  */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NVRAM_SELFBOOT_HW_SIZE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">8</span><span class="p">))</span> <span class="p">{</span>
				<span class="kt">int</span> <span class="n">l</span><span class="p">;</span>
				<span class="n">u8</span> <span class="n">msk</span><span class="p">;</span>

				<span class="k">for</span> <span class="p">(</span><span class="n">l</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">msk</span> <span class="o">=</span> <span class="mh">0x80</span><span class="p">;</span> <span class="n">l</span> <span class="o">&lt;</span> <span class="mi">7</span><span class="p">;</span> <span class="n">l</span><span class="o">++</span><span class="p">,</span> <span class="n">msk</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">)</span>
					<span class="n">parity</span><span class="p">[</span><span class="n">k</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">buf8</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">msk</span><span class="p">;</span>
				<span class="n">i</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">16</span><span class="p">)</span> <span class="p">{</span>
				<span class="kt">int</span> <span class="n">l</span><span class="p">;</span>
				<span class="n">u8</span> <span class="n">msk</span><span class="p">;</span>

				<span class="k">for</span> <span class="p">(</span><span class="n">l</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">msk</span> <span class="o">=</span> <span class="mh">0x20</span><span class="p">;</span> <span class="n">l</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">;</span> <span class="n">l</span><span class="o">++</span><span class="p">,</span> <span class="n">msk</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">)</span>
					<span class="n">parity</span><span class="p">[</span><span class="n">k</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">buf8</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">msk</span><span class="p">;</span>
				<span class="n">i</span><span class="o">++</span><span class="p">;</span>

				<span class="k">for</span> <span class="p">(</span><span class="n">l</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">msk</span> <span class="o">=</span> <span class="mh">0x80</span><span class="p">;</span> <span class="n">l</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">l</span><span class="o">++</span><span class="p">,</span> <span class="n">msk</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">)</span>
					<span class="n">parity</span><span class="p">[</span><span class="n">k</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">buf8</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">msk</span><span class="p">;</span>
				<span class="n">i</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">data</span><span class="p">[</span><span class="n">j</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">buf8</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="p">}</span>

		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NVRAM_SELFBOOT_DATA_SIZE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u8</span> <span class="n">hw8</span> <span class="o">=</span> <span class="n">hweight8</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

			<span class="k">if</span> <span class="p">((</span><span class="n">hw8</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">parity</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">hw8</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">parity</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="cm">/* Bootstrap checksum at offset 0x10 */</span>
	<span class="n">csum</span> <span class="o">=</span> <span class="n">calc_crc</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">buf</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">csum</span> <span class="o">!=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mh">0x10</span><span class="o">/</span><span class="mi">4</span><span class="p">]))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="cm">/* Manufacturing block starts at offset 0x74, checksum at 0xfc */</span>
	<span class="n">csum</span> <span class="o">=</span> <span class="n">calc_crc</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">buf</span><span class="p">[</span><span class="mh">0x74</span><span class="o">/</span><span class="mi">4</span><span class="p">],</span> <span class="mh">0x88</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">csum</span> <span class="o">!=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mh">0xfc</span><span class="o">/</span><span class="mi">4</span><span class="p">]))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>

	<span class="n">buf</span> <span class="o">=</span> <span class="n">tg3_vpd_readblock</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buf</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">i</span> <span class="o">=</span> <span class="n">pci_vpd_find_tag</span><span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">buf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">PCI_VPD_LRDT_RO_DATA</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">j</span> <span class="o">=</span> <span class="n">pci_vpd_lrdt_size</span><span class="p">(</span><span class="o">&amp;</span><span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">buf</span><span class="p">)[</span><span class="n">i</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">j</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="n">PCI_VPD_LRDT_TAG_SIZE</span> <span class="o">+</span> <span class="n">j</span> <span class="o">&gt;</span> <span class="n">len</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

		<span class="n">i</span> <span class="o">+=</span> <span class="n">PCI_VPD_LRDT_TAG_SIZE</span><span class="p">;</span>
		<span class="n">j</span> <span class="o">=</span> <span class="n">pci_vpd_find_info_keyword</span><span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">buf</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span>
					      <span class="n">PCI_VPD_RO_KEYWORD_CHKSUM</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">j</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u8</span> <span class="n">csum8</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

			<span class="n">j</span> <span class="o">+=</span> <span class="n">PCI_VPD_INFO_FLD_HDR_SIZE</span><span class="p">;</span>

			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">j</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
				<span class="n">csum8</span> <span class="o">+=</span> <span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">buf</span><span class="p">)[</span><span class="n">i</span><span class="p">];</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">csum8</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">out:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define TG3_SERDES_TIMEOUT_SEC	2</span>
<span class="cp">#define TG3_COPPER_TIMEOUT_SEC	6</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tg3_test_link</span><span class="p">(</span><span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">max</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">netif_running</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">phy_flags</span> <span class="o">&amp;</span> <span class="n">TG3_PHYFLG_ANY_SERDES</span><span class="p">)</span>
		<span class="n">max</span> <span class="o">=</span> <span class="n">TG3_SERDES_TIMEOUT_SEC</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">max</span> <span class="o">=</span> <span class="n">TG3_COPPER_TIMEOUT_SEC</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">max</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">netif_carrier_ok</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">))</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">msleep_interruptible</span><span class="p">(</span><span class="mi">1000</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Only test the commonly used registers */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">tg3_test_registers</span><span class="p">(</span><span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">is_5705</span><span class="p">,</span> <span class="n">is_5750</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">offset</span><span class="p">,</span> <span class="n">read_mask</span><span class="p">,</span> <span class="n">write_mask</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">save_val</span><span class="p">,</span> <span class="n">read_val</span><span class="p">;</span>
	<span class="k">static</span> <span class="k">struct</span> <span class="p">{</span>
		<span class="n">u16</span> <span class="n">offset</span><span class="p">;</span>
		<span class="n">u16</span> <span class="n">flags</span><span class="p">;</span>
<span class="cp">#define TG3_FL_5705	0x1</span>
<span class="cp">#define TG3_FL_NOT_5705	0x2</span>
<span class="cp">#define TG3_FL_NOT_5788	0x4</span>
<span class="cp">#define TG3_FL_NOT_5750	0x8</span>
		<span class="n">u32</span> <span class="n">read_mask</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">write_mask</span><span class="p">;</span>
	<span class="p">}</span> <span class="n">reg_tbl</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="cm">/* MAC Control Registers */</span>
		<span class="p">{</span> <span class="n">MAC_MODE</span><span class="p">,</span> <span class="n">TG3_FL_NOT_5705</span><span class="p">,</span>
			<span class="mh">0x00000000</span><span class="p">,</span> <span class="mh">0x00ef6f8c</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">MAC_MODE</span><span class="p">,</span> <span class="n">TG3_FL_5705</span><span class="p">,</span>
			<span class="mh">0x00000000</span><span class="p">,</span> <span class="mh">0x01ef6b8c</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">MAC_STATUS</span><span class="p">,</span> <span class="n">TG3_FL_NOT_5705</span><span class="p">,</span>
			<span class="mh">0x03800107</span><span class="p">,</span> <span class="mh">0x00000000</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">MAC_STATUS</span><span class="p">,</span> <span class="n">TG3_FL_5705</span><span class="p">,</span>
			<span class="mh">0x03800100</span><span class="p">,</span> <span class="mh">0x00000000</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">MAC_ADDR_0_HIGH</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span>
			<span class="mh">0x00000000</span><span class="p">,</span> <span class="mh">0x0000ffff</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">MAC_ADDR_0_LOW</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span>
			<span class="mh">0x00000000</span><span class="p">,</span> <span class="mh">0xffffffff</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">MAC_RX_MTU_SIZE</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span>
			<span class="mh">0x00000000</span><span class="p">,</span> <span class="mh">0x0000ffff</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">MAC_TX_MODE</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span>
			<span class="mh">0x00000000</span><span class="p">,</span> <span class="mh">0x00000070</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">MAC_TX_LENGTHS</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span>
			<span class="mh">0x00000000</span><span class="p">,</span> <span class="mh">0x00003fff</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">MAC_RX_MODE</span><span class="p">,</span> <span class="n">TG3_FL_NOT_5705</span><span class="p">,</span>
			<span class="mh">0x00000000</span><span class="p">,</span> <span class="mh">0x000007fc</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">MAC_RX_MODE</span><span class="p">,</span> <span class="n">TG3_FL_5705</span><span class="p">,</span>
			<span class="mh">0x00000000</span><span class="p">,</span> <span class="mh">0x000007dc</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">MAC_HASH_REG_0</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span>
			<span class="mh">0x00000000</span><span class="p">,</span> <span class="mh">0xffffffff</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">MAC_HASH_REG_1</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span>
			<span class="mh">0x00000000</span><span class="p">,</span> <span class="mh">0xffffffff</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">MAC_HASH_REG_2</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span>
			<span class="mh">0x00000000</span><span class="p">,</span> <span class="mh">0xffffffff</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">MAC_HASH_REG_3</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span>
			<span class="mh">0x00000000</span><span class="p">,</span> <span class="mh">0xffffffff</span> <span class="p">},</span>

		<span class="cm">/* Receive Data and Receive BD Initiator Control Registers. */</span>
		<span class="p">{</span> <span class="n">RCVDBDI_JUMBO_BD</span><span class="o">+</span><span class="mi">0</span><span class="p">,</span> <span class="n">TG3_FL_NOT_5705</span><span class="p">,</span>
			<span class="mh">0x00000000</span><span class="p">,</span> <span class="mh">0xffffffff</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">RCVDBDI_JUMBO_BD</span><span class="o">+</span><span class="mi">4</span><span class="p">,</span> <span class="n">TG3_FL_NOT_5705</span><span class="p">,</span>
			<span class="mh">0x00000000</span><span class="p">,</span> <span class="mh">0xffffffff</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">RCVDBDI_JUMBO_BD</span><span class="o">+</span><span class="mi">8</span><span class="p">,</span> <span class="n">TG3_FL_NOT_5705</span><span class="p">,</span>
			<span class="mh">0x00000000</span><span class="p">,</span> <span class="mh">0x00000003</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">RCVDBDI_JUMBO_BD</span><span class="o">+</span><span class="mh">0xc</span><span class="p">,</span> <span class="n">TG3_FL_NOT_5705</span><span class="p">,</span>
			<span class="mh">0x00000000</span><span class="p">,</span> <span class="mh">0xffffffff</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">RCVDBDI_STD_BD</span><span class="o">+</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span>
			<span class="mh">0x00000000</span><span class="p">,</span> <span class="mh">0xffffffff</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">RCVDBDI_STD_BD</span><span class="o">+</span><span class="mi">4</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span>
			<span class="mh">0x00000000</span><span class="p">,</span> <span class="mh">0xffffffff</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">RCVDBDI_STD_BD</span><span class="o">+</span><span class="mi">8</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span>
			<span class="mh">0x00000000</span><span class="p">,</span> <span class="mh">0xffff0002</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">RCVDBDI_STD_BD</span><span class="o">+</span><span class="mh">0xc</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span>
			<span class="mh">0x00000000</span><span class="p">,</span> <span class="mh">0xffffffff</span> <span class="p">},</span>

		<span class="cm">/* Receive BD Initiator Control Registers. */</span>
		<span class="p">{</span> <span class="n">RCVBDI_STD_THRESH</span><span class="p">,</span> <span class="n">TG3_FL_NOT_5705</span><span class="p">,</span>
			<span class="mh">0x00000000</span><span class="p">,</span> <span class="mh">0xffffffff</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">RCVBDI_STD_THRESH</span><span class="p">,</span> <span class="n">TG3_FL_5705</span><span class="p">,</span>
			<span class="mh">0x00000000</span><span class="p">,</span> <span class="mh">0x000003ff</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">RCVBDI_JUMBO_THRESH</span><span class="p">,</span> <span class="n">TG3_FL_NOT_5705</span><span class="p">,</span>
			<span class="mh">0x00000000</span><span class="p">,</span> <span class="mh">0xffffffff</span> <span class="p">},</span>

		<span class="cm">/* Host Coalescing Control Registers. */</span>
		<span class="p">{</span> <span class="n">HOSTCC_MODE</span><span class="p">,</span> <span class="n">TG3_FL_NOT_5705</span><span class="p">,</span>
			<span class="mh">0x00000000</span><span class="p">,</span> <span class="mh">0x00000004</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">HOSTCC_MODE</span><span class="p">,</span> <span class="n">TG3_FL_5705</span><span class="p">,</span>
			<span class="mh">0x00000000</span><span class="p">,</span> <span class="mh">0x000000f6</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">HOSTCC_RXCOL_TICKS</span><span class="p">,</span> <span class="n">TG3_FL_NOT_5705</span><span class="p">,</span>
			<span class="mh">0x00000000</span><span class="p">,</span> <span class="mh">0xffffffff</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">HOSTCC_RXCOL_TICKS</span><span class="p">,</span> <span class="n">TG3_FL_5705</span><span class="p">,</span>
			<span class="mh">0x00000000</span><span class="p">,</span> <span class="mh">0x000003ff</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">HOSTCC_TXCOL_TICKS</span><span class="p">,</span> <span class="n">TG3_FL_NOT_5705</span><span class="p">,</span>
			<span class="mh">0x00000000</span><span class="p">,</span> <span class="mh">0xffffffff</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">HOSTCC_TXCOL_TICKS</span><span class="p">,</span> <span class="n">TG3_FL_5705</span><span class="p">,</span>
			<span class="mh">0x00000000</span><span class="p">,</span> <span class="mh">0x000003ff</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">HOSTCC_RXMAX_FRAMES</span><span class="p">,</span> <span class="n">TG3_FL_NOT_5705</span><span class="p">,</span>
			<span class="mh">0x00000000</span><span class="p">,</span> <span class="mh">0xffffffff</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">HOSTCC_RXMAX_FRAMES</span><span class="p">,</span> <span class="n">TG3_FL_5705</span> <span class="o">|</span> <span class="n">TG3_FL_NOT_5788</span><span class="p">,</span>
			<span class="mh">0x00000000</span><span class="p">,</span> <span class="mh">0x000000ff</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">HOSTCC_TXMAX_FRAMES</span><span class="p">,</span> <span class="n">TG3_FL_NOT_5705</span><span class="p">,</span>
			<span class="mh">0x00000000</span><span class="p">,</span> <span class="mh">0xffffffff</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">HOSTCC_TXMAX_FRAMES</span><span class="p">,</span> <span class="n">TG3_FL_5705</span> <span class="o">|</span> <span class="n">TG3_FL_NOT_5788</span><span class="p">,</span>
			<span class="mh">0x00000000</span><span class="p">,</span> <span class="mh">0x000000ff</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">HOSTCC_RXCOAL_TICK_INT</span><span class="p">,</span> <span class="n">TG3_FL_NOT_5705</span><span class="p">,</span>
			<span class="mh">0x00000000</span><span class="p">,</span> <span class="mh">0xffffffff</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">HOSTCC_TXCOAL_TICK_INT</span><span class="p">,</span> <span class="n">TG3_FL_NOT_5705</span><span class="p">,</span>
			<span class="mh">0x00000000</span><span class="p">,</span> <span class="mh">0xffffffff</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">HOSTCC_RXCOAL_MAXF_INT</span><span class="p">,</span> <span class="n">TG3_FL_NOT_5705</span><span class="p">,</span>
			<span class="mh">0x00000000</span><span class="p">,</span> <span class="mh">0xffffffff</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">HOSTCC_RXCOAL_MAXF_INT</span><span class="p">,</span> <span class="n">TG3_FL_5705</span> <span class="o">|</span> <span class="n">TG3_FL_NOT_5788</span><span class="p">,</span>
			<span class="mh">0x00000000</span><span class="p">,</span> <span class="mh">0x000000ff</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">HOSTCC_TXCOAL_MAXF_INT</span><span class="p">,</span> <span class="n">TG3_FL_NOT_5705</span><span class="p">,</span>
			<span class="mh">0x00000000</span><span class="p">,</span> <span class="mh">0xffffffff</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">HOSTCC_TXCOAL_MAXF_INT</span><span class="p">,</span> <span class="n">TG3_FL_5705</span> <span class="o">|</span> <span class="n">TG3_FL_NOT_5788</span><span class="p">,</span>
			<span class="mh">0x00000000</span><span class="p">,</span> <span class="mh">0x000000ff</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">HOSTCC_STAT_COAL_TICKS</span><span class="p">,</span> <span class="n">TG3_FL_NOT_5705</span><span class="p">,</span>
			<span class="mh">0x00000000</span><span class="p">,</span> <span class="mh">0xffffffff</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">HOSTCC_STATS_BLK_HOST_ADDR</span><span class="p">,</span> <span class="n">TG3_FL_NOT_5705</span><span class="p">,</span>
			<span class="mh">0x00000000</span><span class="p">,</span> <span class="mh">0xffffffff</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">HOSTCC_STATS_BLK_HOST_ADDR</span><span class="o">+</span><span class="mi">4</span><span class="p">,</span> <span class="n">TG3_FL_NOT_5705</span><span class="p">,</span>
			<span class="mh">0x00000000</span><span class="p">,</span> <span class="mh">0xffffffff</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">HOSTCC_STATUS_BLK_HOST_ADDR</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span>
			<span class="mh">0x00000000</span><span class="p">,</span> <span class="mh">0xffffffff</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">HOSTCC_STATUS_BLK_HOST_ADDR</span><span class="o">+</span><span class="mi">4</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span>
			<span class="mh">0x00000000</span><span class="p">,</span> <span class="mh">0xffffffff</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">HOSTCC_STATS_BLK_NIC_ADDR</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span>
			<span class="mh">0xffffffff</span><span class="p">,</span> <span class="mh">0x00000000</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">HOSTCC_STATUS_BLK_NIC_ADDR</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span>
			<span class="mh">0xffffffff</span><span class="p">,</span> <span class="mh">0x00000000</span> <span class="p">},</span>

		<span class="cm">/* Buffer Manager Control Registers. */</span>
		<span class="p">{</span> <span class="n">BUFMGR_MB_POOL_ADDR</span><span class="p">,</span> <span class="n">TG3_FL_NOT_5750</span><span class="p">,</span>
			<span class="mh">0x00000000</span><span class="p">,</span> <span class="mh">0x007fff80</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">BUFMGR_MB_POOL_SIZE</span><span class="p">,</span> <span class="n">TG3_FL_NOT_5750</span><span class="p">,</span>
			<span class="mh">0x00000000</span><span class="p">,</span> <span class="mh">0x007fffff</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">BUFMGR_MB_RDMA_LOW_WATER</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span>
			<span class="mh">0x00000000</span><span class="p">,</span> <span class="mh">0x0000003f</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">BUFMGR_MB_MACRX_LOW_WATER</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span>
			<span class="mh">0x00000000</span><span class="p">,</span> <span class="mh">0x000001ff</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">BUFMGR_MB_HIGH_WATER</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span>
			<span class="mh">0x00000000</span><span class="p">,</span> <span class="mh">0x000001ff</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">BUFMGR_DMA_DESC_POOL_ADDR</span><span class="p">,</span> <span class="n">TG3_FL_NOT_5705</span><span class="p">,</span>
			<span class="mh">0xffffffff</span><span class="p">,</span> <span class="mh">0x00000000</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">BUFMGR_DMA_DESC_POOL_SIZE</span><span class="p">,</span> <span class="n">TG3_FL_NOT_5705</span><span class="p">,</span>
			<span class="mh">0xffffffff</span><span class="p">,</span> <span class="mh">0x00000000</span> <span class="p">},</span>

		<span class="cm">/* Mailbox Registers */</span>
		<span class="p">{</span> <span class="n">GRCMBOX_RCVSTD_PROD_IDX</span><span class="o">+</span><span class="mi">4</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span>
			<span class="mh">0x00000000</span><span class="p">,</span> <span class="mh">0x000001ff</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">GRCMBOX_RCVJUMBO_PROD_IDX</span><span class="o">+</span><span class="mi">4</span><span class="p">,</span> <span class="n">TG3_FL_NOT_5705</span><span class="p">,</span>
			<span class="mh">0x00000000</span><span class="p">,</span> <span class="mh">0x000001ff</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">GRCMBOX_RCVRET_CON_IDX_0</span><span class="o">+</span><span class="mi">4</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span>
			<span class="mh">0x00000000</span><span class="p">,</span> <span class="mh">0x000007ff</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">GRCMBOX_SNDHOST_PROD_IDX_0</span><span class="o">+</span><span class="mi">4</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span>
			<span class="mh">0x00000000</span><span class="p">,</span> <span class="mh">0x000001ff</span> <span class="p">},</span>

		<span class="p">{</span> <span class="mh">0xffff</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">,</span> <span class="mh">0x00000000</span> <span class="p">},</span>
	<span class="p">};</span>

	<span class="n">is_5705</span> <span class="o">=</span> <span class="n">is_5750</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">5705</span><span class="n">_PLUS</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">is_5705</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">5750</span><span class="n">_PLUS</span><span class="p">))</span>
			<span class="n">is_5750</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">reg_tbl</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">offset</span> <span class="o">!=</span> <span class="mh">0xffff</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">is_5705</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">reg_tbl</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">TG3_FL_NOT_5705</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_5705</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">reg_tbl</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">TG3_FL_5705</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">IS_5788</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">reg_tbl</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">TG3_FL_NOT_5788</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">is_5750</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">reg_tbl</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">TG3_FL_NOT_5750</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">reg_tbl</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">offset</span><span class="p">;</span>
		<span class="n">read_mask</span> <span class="o">=</span> <span class="n">reg_tbl</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">read_mask</span><span class="p">;</span>
		<span class="n">write_mask</span> <span class="o">=</span> <span class="n">reg_tbl</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">write_mask</span><span class="p">;</span>

		<span class="cm">/* Save the original register content */</span>
		<span class="n">save_val</span> <span class="o">=</span> <span class="n">tr32</span><span class="p">(</span><span class="n">offset</span><span class="p">);</span>

		<span class="cm">/* Determine the read-only value. */</span>
		<span class="n">read_val</span> <span class="o">=</span> <span class="n">save_val</span> <span class="o">&amp;</span> <span class="n">read_mask</span><span class="p">;</span>

		<span class="cm">/* Write zero to the register, then make sure the read-only bits</span>
<span class="cm">		 * are not changed and the read/write bits are all zeros.</span>
<span class="cm">		 */</span>
		<span class="n">tw32</span><span class="p">(</span><span class="n">offset</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="n">val</span> <span class="o">=</span> <span class="n">tr32</span><span class="p">(</span><span class="n">offset</span><span class="p">);</span>

		<span class="cm">/* Test the read-only and read/write bits. */</span>
		<span class="k">if</span> <span class="p">(((</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">read_mask</span><span class="p">)</span> <span class="o">!=</span> <span class="n">read_val</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">write_mask</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

		<span class="cm">/* Write ones to all the bits defined by RdMask and WrMask, then</span>
<span class="cm">		 * make sure the read-only bits are not changed and the</span>
<span class="cm">		 * read/write bits are all ones.</span>
<span class="cm">		 */</span>
		<span class="n">tw32</span><span class="p">(</span><span class="n">offset</span><span class="p">,</span> <span class="n">read_mask</span> <span class="o">|</span> <span class="n">write_mask</span><span class="p">);</span>

		<span class="n">val</span> <span class="o">=</span> <span class="n">tr32</span><span class="p">(</span><span class="n">offset</span><span class="p">);</span>

		<span class="cm">/* Test the read-only bits. */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">read_mask</span><span class="p">)</span> <span class="o">!=</span> <span class="n">read_val</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

		<span class="cm">/* Test the read/write bits. */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">write_mask</span><span class="p">)</span> <span class="o">!=</span> <span class="n">write_mask</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

		<span class="n">tw32</span><span class="p">(</span><span class="n">offset</span><span class="p">,</span> <span class="n">save_val</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">out:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">netif_msg_hw</span><span class="p">(</span><span class="n">tp</span><span class="p">))</span>
		<span class="n">netdev_err</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			   <span class="s">&quot;Register test failed at offset %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">offset</span><span class="p">);</span>
	<span class="n">tw32</span><span class="p">(</span><span class="n">offset</span><span class="p">,</span> <span class="n">save_val</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tg3_do_mem_test</span><span class="p">(</span><span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span><span class="p">,</span> <span class="n">u32</span> <span class="n">offset</span><span class="p">,</span> <span class="n">u32</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="n">u32</span> <span class="n">test_pattern</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x00000000</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">,</span> <span class="mh">0xaa55a55a</span> <span class="p">};</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">j</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">test_pattern</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="n">j</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>

			<span class="n">tg3_write_mem</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">offset</span> <span class="o">+</span> <span class="n">j</span><span class="p">,</span> <span class="n">test_pattern</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
			<span class="n">tg3_read_mem</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">offset</span> <span class="o">+</span> <span class="n">j</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">!=</span> <span class="n">test_pattern</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tg3_test_memory</span><span class="p">(</span><span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">struct</span> <span class="n">mem_entry</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">offset</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">len</span><span class="p">;</span>
	<span class="p">}</span> <span class="n">mem_tbl_570x</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span> <span class="mh">0x00000000</span><span class="p">,</span> <span class="mh">0x00b50</span><span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x00002000</span><span class="p">,</span> <span class="mh">0x1c000</span><span class="p">},</span>
		<span class="p">{</span> <span class="mh">0xffffffff</span><span class="p">,</span> <span class="mh">0x00000</span><span class="p">}</span>
	<span class="p">},</span> <span class="n">mem_tbl_5705</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span> <span class="mh">0x00000100</span><span class="p">,</span> <span class="mh">0x0000c</span><span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x00000200</span><span class="p">,</span> <span class="mh">0x00008</span><span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x00004000</span><span class="p">,</span> <span class="mh">0x00800</span><span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x00006000</span><span class="p">,</span> <span class="mh">0x01000</span><span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x00008000</span><span class="p">,</span> <span class="mh">0x02000</span><span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x00010000</span><span class="p">,</span> <span class="mh">0x0e000</span><span class="p">},</span>
		<span class="p">{</span> <span class="mh">0xffffffff</span><span class="p">,</span> <span class="mh">0x00000</span><span class="p">}</span>
	<span class="p">},</span> <span class="n">mem_tbl_5755</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span> <span class="mh">0x00000200</span><span class="p">,</span> <span class="mh">0x00008</span><span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x00004000</span><span class="p">,</span> <span class="mh">0x00800</span><span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x00006000</span><span class="p">,</span> <span class="mh">0x00800</span><span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x00008000</span><span class="p">,</span> <span class="mh">0x02000</span><span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x00010000</span><span class="p">,</span> <span class="mh">0x0c000</span><span class="p">},</span>
		<span class="p">{</span> <span class="mh">0xffffffff</span><span class="p">,</span> <span class="mh">0x00000</span><span class="p">}</span>
	<span class="p">},</span> <span class="n">mem_tbl_5906</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span> <span class="mh">0x00000200</span><span class="p">,</span> <span class="mh">0x00008</span><span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x00004000</span><span class="p">,</span> <span class="mh">0x00400</span><span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x00006000</span><span class="p">,</span> <span class="mh">0x00400</span><span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x00008000</span><span class="p">,</span> <span class="mh">0x01000</span><span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x00010000</span><span class="p">,</span> <span class="mh">0x01000</span><span class="p">},</span>
		<span class="p">{</span> <span class="mh">0xffffffff</span><span class="p">,</span> <span class="mh">0x00000</span><span class="p">}</span>
	<span class="p">},</span> <span class="n">mem_tbl_5717</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span> <span class="mh">0x00000200</span><span class="p">,</span> <span class="mh">0x00008</span><span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x00010000</span><span class="p">,</span> <span class="mh">0x0a000</span><span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x00020000</span><span class="p">,</span> <span class="mh">0x13c00</span><span class="p">},</span>
		<span class="p">{</span> <span class="mh">0xffffffff</span><span class="p">,</span> <span class="mh">0x00000</span><span class="p">}</span>
	<span class="p">},</span> <span class="n">mem_tbl_57765</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span> <span class="mh">0x00000200</span><span class="p">,</span> <span class="mh">0x00008</span><span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x00004000</span><span class="p">,</span> <span class="mh">0x00800</span><span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x00006000</span><span class="p">,</span> <span class="mh">0x09800</span><span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x00010000</span><span class="p">,</span> <span class="mh">0x0a000</span><span class="p">},</span>
		<span class="p">{</span> <span class="mh">0xffffffff</span><span class="p">,</span> <span class="mh">0x00000</span><span class="p">}</span>
	<span class="p">};</span>
	<span class="k">struct</span> <span class="n">mem_entry</span> <span class="o">*</span><span class="n">mem_tbl</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">5717</span><span class="n">_PLUS</span><span class="p">))</span>
		<span class="n">mem_tbl</span> <span class="o">=</span> <span class="n">mem_tbl_5717</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">57765</span><span class="n">_CLASS</span><span class="p">))</span>
		<span class="n">mem_tbl</span> <span class="o">=</span> <span class="n">mem_tbl_57765</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">5755</span><span class="n">_PLUS</span><span class="p">))</span>
		<span class="n">mem_tbl</span> <span class="o">=</span> <span class="n">mem_tbl_5755</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">ASIC_REV_5906</span><span class="p">)</span>
		<span class="n">mem_tbl</span> <span class="o">=</span> <span class="n">mem_tbl_5906</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">5705</span><span class="n">_PLUS</span><span class="p">))</span>
		<span class="n">mem_tbl</span> <span class="o">=</span> <span class="n">mem_tbl_5705</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">mem_tbl</span> <span class="o">=</span> <span class="n">mem_tbl_570x</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">mem_tbl</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">offset</span> <span class="o">!=</span> <span class="mh">0xffffffff</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">tg3_do_mem_test</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">mem_tbl</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">offset</span><span class="p">,</span> <span class="n">mem_tbl</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">len</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define TG3_TSO_MSS		500</span>

<span class="cp">#define TG3_TSO_IP_HDR_LEN	20</span>
<span class="cp">#define TG3_TSO_TCP_HDR_LEN	20</span>
<span class="cp">#define TG3_TSO_TCP_OPT_LEN	12</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">tg3_tso_header</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
<span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
<span class="mh">0x45</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
<span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
<span class="mh">0x40</span><span class="p">,</span> <span class="mh">0x06</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
<span class="mh">0x0a</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span>
<span class="mh">0x0a</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span>
<span class="mh">0x0d</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0xe0</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
<span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
<span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
<span class="mh">0x80</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
<span class="mh">0x14</span><span class="p">,</span> <span class="mh">0x09</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
<span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x0a</span><span class="p">,</span>
<span class="mh">0x11</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span>
<span class="mh">0x11</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tg3_run_loopback</span><span class="p">(</span><span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span><span class="p">,</span> <span class="n">u32</span> <span class="n">pktsz</span><span class="p">,</span> <span class="n">bool</span> <span class="n">tso_loopback</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">rx_start_idx</span><span class="p">,</span> <span class="n">rx_idx</span><span class="p">,</span> <span class="n">tx_idx</span><span class="p">,</span> <span class="n">opaque_key</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">base_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">mss</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">desc_idx</span><span class="p">,</span> <span class="n">coal_now</span><span class="p">,</span> <span class="n">data_off</span><span class="p">,</span> <span class="n">val</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">budget</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">tx_data</span><span class="p">,</span> <span class="o">*</span><span class="n">rx_data</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">map</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">num_pkts</span><span class="p">,</span> <span class="n">tx_len</span><span class="p">,</span> <span class="n">rx_len</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tg3_rx_buffer_desc</span> <span class="o">*</span><span class="n">desc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tg3_napi</span> <span class="o">*</span><span class="n">tnapi</span><span class="p">,</span> <span class="o">*</span><span class="n">rnapi</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tg3_rx_prodring_set</span> <span class="o">*</span><span class="n">tpr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">prodring</span><span class="p">;</span>

	<span class="n">tnapi</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">rnapi</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">irq_cnt</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">ENABLE_RSS</span><span class="p">))</span>
			<span class="n">rnapi</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">ENABLE_TSS</span><span class="p">))</span>
			<span class="n">tnapi</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="p">}</span>
	<span class="n">coal_now</span> <span class="o">=</span> <span class="n">tnapi</span><span class="o">-&gt;</span><span class="n">coal_now</span> <span class="o">|</span> <span class="n">rnapi</span><span class="o">-&gt;</span><span class="n">coal_now</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="n">tx_len</span> <span class="o">=</span> <span class="n">pktsz</span><span class="p">;</span>
	<span class="n">skb</span> <span class="o">=</span> <span class="n">netdev_alloc_skb</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">tx_len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">tx_data</span> <span class="o">=</span> <span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">tx_len</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">tx_data</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">tx_data</span> <span class="o">+</span> <span class="mi">6</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>

	<span class="n">tw32</span><span class="p">(</span><span class="n">MAC_RX_MTU_SIZE</span><span class="p">,</span> <span class="n">tx_len</span> <span class="o">+</span> <span class="n">ETH_FCS_LEN</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tso_loopback</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">iphdr</span> <span class="o">*</span><span class="n">iph</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">iphdr</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">tx_data</span><span class="p">[</span><span class="n">ETH_HLEN</span><span class="p">];</span>

		<span class="n">u32</span> <span class="n">hdr_len</span> <span class="o">=</span> <span class="n">TG3_TSO_IP_HDR_LEN</span> <span class="o">+</span> <span class="n">TG3_TSO_TCP_HDR_LEN</span> <span class="o">+</span>
			      <span class="n">TG3_TSO_TCP_OPT_LEN</span><span class="p">;</span>

		<span class="n">memcpy</span><span class="p">(</span><span class="n">tx_data</span> <span class="o">+</span> <span class="n">ETH_ALEN</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span> <span class="n">tg3_tso_header</span><span class="p">,</span>
		       <span class="k">sizeof</span><span class="p">(</span><span class="n">tg3_tso_header</span><span class="p">));</span>
		<span class="n">mss</span> <span class="o">=</span> <span class="n">TG3_TSO_MSS</span><span class="p">;</span>

		<span class="n">val</span> <span class="o">=</span> <span class="n">tx_len</span> <span class="o">-</span> <span class="n">ETH_ALEN</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">tg3_tso_header</span><span class="p">);</span>
		<span class="n">num_pkts</span> <span class="o">=</span> <span class="n">DIV_ROUND_UP</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">TG3_TSO_MSS</span><span class="p">);</span>

		<span class="cm">/* Set the total length field in the IP header */</span>
		<span class="n">iph</span><span class="o">-&gt;</span><span class="n">tot_len</span> <span class="o">=</span> <span class="n">htons</span><span class="p">((</span><span class="n">u16</span><span class="p">)(</span><span class="n">mss</span> <span class="o">+</span> <span class="n">hdr_len</span><span class="p">));</span>

		<span class="n">base_flags</span> <span class="o">=</span> <span class="p">(</span><span class="n">TXD_FLAG_CPU_PRE_DMA</span> <span class="o">|</span>
			      <span class="n">TXD_FLAG_CPU_POST_DMA</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">HW_TSO_1</span><span class="p">)</span> <span class="o">||</span>
		    <span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">HW_TSO_2</span><span class="p">)</span> <span class="o">||</span>
		    <span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">HW_TSO_3</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">tcphdr</span> <span class="o">*</span><span class="n">th</span><span class="p">;</span>
			<span class="n">val</span> <span class="o">=</span> <span class="n">ETH_HLEN</span> <span class="o">+</span> <span class="n">TG3_TSO_IP_HDR_LEN</span><span class="p">;</span>
			<span class="n">th</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">tcphdr</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">tx_data</span><span class="p">[</span><span class="n">val</span><span class="p">];</span>
			<span class="n">th</span><span class="o">-&gt;</span><span class="n">check</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">base_flags</span> <span class="o">|=</span> <span class="n">TXD_FLAG_TCPUDP_CSUM</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">HW_TSO_3</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">mss</span> <span class="o">|=</span> <span class="p">(</span><span class="n">hdr_len</span> <span class="o">&amp;</span> <span class="mh">0xc</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">hdr_len</span> <span class="o">&amp;</span> <span class="mh">0x10</span><span class="p">)</span>
				<span class="n">base_flags</span> <span class="o">|=</span> <span class="mh">0x00000010</span><span class="p">;</span>
			<span class="n">base_flags</span> <span class="o">|=</span> <span class="p">(</span><span class="n">hdr_len</span> <span class="o">&amp;</span> <span class="mh">0x3e0</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">HW_TSO_2</span><span class="p">))</span>
			<span class="n">mss</span> <span class="o">|=</span> <span class="n">hdr_len</span> <span class="o">&lt;&lt;</span> <span class="mi">9</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">HW_TSO_1</span><span class="p">)</span> <span class="o">||</span>
			 <span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">ASIC_REV_5705</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mss</span> <span class="o">|=</span> <span class="p">(</span><span class="n">TG3_TSO_TCP_OPT_LEN</span> <span class="o">&lt;&lt;</span> <span class="mi">9</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">base_flags</span> <span class="o">|=</span> <span class="p">(</span><span class="n">TG3_TSO_TCP_OPT_LEN</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">data_off</span> <span class="o">=</span> <span class="n">ETH_ALEN</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">tg3_tso_header</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">num_pkts</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">data_off</span> <span class="o">=</span> <span class="n">ETH_HLEN</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">USE_JUMBO_BDFLAG</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="n">tx_len</span> <span class="o">&gt;</span> <span class="n">VLAN_ETH_FRAME_LEN</span><span class="p">)</span>
			<span class="n">base_flags</span> <span class="o">|=</span> <span class="n">TXD_FLAG_JMB_PKT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">data_off</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">tx_len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">tx_data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="p">(</span><span class="n">i</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>

	<span class="n">map</span> <span class="o">=</span> <span class="n">pci_map_single</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">tx_len</span><span class="p">,</span> <span class="n">PCI_DMA_TODEVICE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pci_dma_mapping_error</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">map</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">tnapi</span><span class="o">-&gt;</span><span class="n">tx_prod</span><span class="p">;</span>
	<span class="n">tnapi</span><span class="o">-&gt;</span><span class="n">tx_buffers</span><span class="p">[</span><span class="n">val</span><span class="p">].</span><span class="n">skb</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>
	<span class="n">dma_unmap_addr_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tnapi</span><span class="o">-&gt;</span><span class="n">tx_buffers</span><span class="p">[</span><span class="n">val</span><span class="p">],</span> <span class="n">mapping</span><span class="p">,</span> <span class="n">map</span><span class="p">);</span>

	<span class="n">tw32_f</span><span class="p">(</span><span class="n">HOSTCC_MODE</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">coalesce_mode</span> <span class="o">|</span> <span class="n">HOSTCC_MODE_ENABLE</span> <span class="o">|</span>
	       <span class="n">rnapi</span><span class="o">-&gt;</span><span class="n">coal_now</span><span class="p">);</span>

	<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>

	<span class="n">rx_start_idx</span> <span class="o">=</span> <span class="n">rnapi</span><span class="o">-&gt;</span><span class="n">hw_status</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">rx_producer</span><span class="p">;</span>

	<span class="n">budget</span> <span class="o">=</span> <span class="n">tg3_tx_avail</span><span class="p">(</span><span class="n">tnapi</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tg3_tx_frag_set</span><span class="p">(</span><span class="n">tnapi</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">budget</span><span class="p">,</span> <span class="n">map</span><span class="p">,</span> <span class="n">tx_len</span><span class="p">,</span>
			    <span class="n">base_flags</span> <span class="o">|</span> <span class="n">TXD_FLAG_END</span><span class="p">,</span> <span class="n">mss</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">tnapi</span><span class="o">-&gt;</span><span class="n">tx_buffers</span><span class="p">[</span><span class="n">val</span><span class="p">].</span><span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">tnapi</span><span class="o">-&gt;</span><span class="n">tx_prod</span><span class="o">++</span><span class="p">;</span>

	<span class="cm">/* Sync BD data before updating mailbox */</span>
	<span class="n">wmb</span><span class="p">();</span>

	<span class="n">tw32_tx_mbox</span><span class="p">(</span><span class="n">tnapi</span><span class="o">-&gt;</span><span class="n">prodmbox</span><span class="p">,</span> <span class="n">tnapi</span><span class="o">-&gt;</span><span class="n">tx_prod</span><span class="p">);</span>
	<span class="n">tr32_mailbox</span><span class="p">(</span><span class="n">tnapi</span><span class="o">-&gt;</span><span class="n">prodmbox</span><span class="p">);</span>

	<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>

	<span class="cm">/* 350 usec to allow enough time on some 10/100 Mbps devices.  */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">35</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tw32_f</span><span class="p">(</span><span class="n">HOSTCC_MODE</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">coalesce_mode</span> <span class="o">|</span> <span class="n">HOSTCC_MODE_ENABLE</span> <span class="o">|</span>
		       <span class="n">coal_now</span><span class="p">);</span>

		<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>

		<span class="n">tx_idx</span> <span class="o">=</span> <span class="n">tnapi</span><span class="o">-&gt;</span><span class="n">hw_status</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">tx_consumer</span><span class="p">;</span>
		<span class="n">rx_idx</span> <span class="o">=</span> <span class="n">rnapi</span><span class="o">-&gt;</span><span class="n">hw_status</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">rx_producer</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">tx_idx</span> <span class="o">==</span> <span class="n">tnapi</span><span class="o">-&gt;</span><span class="n">tx_prod</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">rx_idx</span> <span class="o">==</span> <span class="p">(</span><span class="n">rx_start_idx</span> <span class="o">+</span> <span class="n">num_pkts</span><span class="p">)))</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">tg3_tx_skb_unmap</span><span class="p">(</span><span class="n">tnapi</span><span class="p">,</span> <span class="n">tnapi</span><span class="o">-&gt;</span><span class="n">tx_prod</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tx_idx</span> <span class="o">!=</span> <span class="n">tnapi</span><span class="o">-&gt;</span><span class="n">tx_prod</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rx_idx</span> <span class="o">!=</span> <span class="n">rx_start_idx</span> <span class="o">+</span> <span class="n">num_pkts</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">data_off</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">rx_idx</span> <span class="o">!=</span> <span class="n">rx_start_idx</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">desc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rnapi</span><span class="o">-&gt;</span><span class="n">rx_rcb</span><span class="p">[</span><span class="n">rx_start_idx</span><span class="o">++</span><span class="p">];</span>
		<span class="n">desc_idx</span> <span class="o">=</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">opaque</span> <span class="o">&amp;</span> <span class="n">RXD_OPAQUE_INDEX_MASK</span><span class="p">;</span>
		<span class="n">opaque_key</span> <span class="o">=</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">opaque</span> <span class="o">&amp;</span> <span class="n">RXD_OPAQUE_RING_MASK</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">err_vlan</span> <span class="o">&amp;</span> <span class="n">RXD_ERR_MASK</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">err_vlan</span> <span class="o">!=</span> <span class="n">RXD_ERR_ODD_NIBBLE_RCVD_MII</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

		<span class="n">rx_len</span> <span class="o">=</span> <span class="p">((</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">idx_len</span> <span class="o">&amp;</span> <span class="n">RXD_LEN_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">RXD_LEN_SHIFT</span><span class="p">)</span>
			 <span class="o">-</span> <span class="n">ETH_FCS_LEN</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tso_loopback</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rx_len</span> <span class="o">!=</span> <span class="n">tx_len</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">pktsz</span> <span class="o">&lt;=</span> <span class="n">TG3_RX_STD_DMA_SZ</span> <span class="o">-</span> <span class="n">ETH_FCS_LEN</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">opaque_key</span> <span class="o">!=</span> <span class="n">RXD_OPAQUE_RING_STD</span><span class="p">)</span>
					<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">opaque_key</span> <span class="o">!=</span> <span class="n">RXD_OPAQUE_RING_JUMBO</span><span class="p">)</span>
					<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">type_flags</span> <span class="o">&amp;</span> <span class="n">RXD_FLAG_TCPUDP_CSUM</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			   <span class="p">(</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">ip_tcp_csum</span> <span class="o">&amp;</span> <span class="n">RXD_TCPCSUM_MASK</span><span class="p">)</span>
			    <span class="o">&gt;&gt;</span> <span class="n">RXD_TCPCSUM_SHIFT</span> <span class="o">!=</span> <span class="mh">0xffff</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">opaque_key</span> <span class="o">==</span> <span class="n">RXD_OPAQUE_RING_STD</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rx_data</span> <span class="o">=</span> <span class="n">tpr</span><span class="o">-&gt;</span><span class="n">rx_std_buffers</span><span class="p">[</span><span class="n">desc_idx</span><span class="p">].</span><span class="n">data</span><span class="p">;</span>
			<span class="n">map</span> <span class="o">=</span> <span class="n">dma_unmap_addr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tpr</span><span class="o">-&gt;</span><span class="n">rx_std_buffers</span><span class="p">[</span><span class="n">desc_idx</span><span class="p">],</span>
					     <span class="n">mapping</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">opaque_key</span> <span class="o">==</span> <span class="n">RXD_OPAQUE_RING_JUMBO</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rx_data</span> <span class="o">=</span> <span class="n">tpr</span><span class="o">-&gt;</span><span class="n">rx_jmb_buffers</span><span class="p">[</span><span class="n">desc_idx</span><span class="p">].</span><span class="n">data</span><span class="p">;</span>
			<span class="n">map</span> <span class="o">=</span> <span class="n">dma_unmap_addr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tpr</span><span class="o">-&gt;</span><span class="n">rx_jmb_buffers</span><span class="p">[</span><span class="n">desc_idx</span><span class="p">],</span>
					     <span class="n">mapping</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

		<span class="n">pci_dma_sync_single_for_cpu</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">map</span><span class="p">,</span> <span class="n">rx_len</span><span class="p">,</span>
					    <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>

		<span class="n">rx_data</span> <span class="o">+=</span> <span class="n">TG3_RX_OFFSET</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">data_off</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">rx_len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">val</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">rx_data</span> <span class="o">+</span> <span class="n">i</span><span class="p">)</span> <span class="o">!=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">))</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* tg3_free_rings will unmap and free the rx_data */</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define TG3_STD_LOOPBACK_FAILED		1</span>
<span class="cp">#define TG3_JMB_LOOPBACK_FAILED		2</span>
<span class="cp">#define TG3_TSO_LOOPBACK_FAILED		4</span>
<span class="cp">#define TG3_LOOPBACK_FAILED \</span>
<span class="cp">	(TG3_STD_LOOPBACK_FAILED | \</span>
<span class="cp">	 TG3_JMB_LOOPBACK_FAILED | \</span>
<span class="cp">	 TG3_TSO_LOOPBACK_FAILED)</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tg3_test_loopback</span><span class="p">(</span><span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span><span class="p">,</span> <span class="n">u64</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="n">bool</span> <span class="n">do_extlpbk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">eee_cap</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">jmb_pkt_sz</span> <span class="o">=</span> <span class="mi">9000</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">dma_limit</span><span class="p">)</span>
		<span class="n">jmb_pkt_sz</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">dma_limit</span> <span class="o">-</span> <span class="n">ETH_HLEN</span><span class="p">;</span>

	<span class="n">eee_cap</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">phy_flags</span> <span class="o">&amp;</span> <span class="n">TG3_PHYFLG_EEE_CAP</span><span class="p">;</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">phy_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">TG3_PHYFLG_EEE_CAP</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">netif_running</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">TG3_LOOPBACK_FAILED</span><span class="p">;</span>
		<span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">TG3_LOOPBACK_FAILED</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">do_extlpbk</span><span class="p">)</span>
			<span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">TG3_LOOPBACK_FAILED</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">tg3_reset_hw</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">TG3_LOOPBACK_FAILED</span><span class="p">;</span>
		<span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">TG3_LOOPBACK_FAILED</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">do_extlpbk</span><span class="p">)</span>
			<span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">TG3_LOOPBACK_FAILED</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">ENABLE_RSS</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

		<span class="cm">/* Reroute all rx packets to the 1st queue */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">MAC_RSS_INDIR_TBL_0</span><span class="p">;</span>
		     <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAC_RSS_INDIR_TBL_0</span> <span class="o">+</span> <span class="n">TG3_RSS_INDIR_TBL_SIZE</span><span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">)</span>
			<span class="n">tw32</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* HW errata - mac loopback fails in some cases on 5780.</span>
<span class="cm">	 * Normal traffic and PHY loopback are not affected by</span>
<span class="cm">	 * errata.  Also, the MAC loopback test is deprecated for</span>
<span class="cm">	 * all newer ASIC revisions.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">!=</span> <span class="n">ASIC_REV_5780</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">CPMU_PRESENT</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">tg3_mac_loopback</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">tg3_run_loopback</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">ETH_FRAME_LEN</span><span class="p">,</span> <span class="nb">false</span><span class="p">))</span>
			<span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|=</span> <span class="n">TG3_STD_LOOPBACK_FAILED</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">JUMBO_RING_ENABLE</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="n">tg3_run_loopback</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">jmb_pkt_sz</span> <span class="o">+</span> <span class="n">ETH_HLEN</span><span class="p">,</span> <span class="nb">false</span><span class="p">))</span>
			<span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|=</span> <span class="n">TG3_JMB_LOOPBACK_FAILED</span><span class="p">;</span>

		<span class="n">tg3_mac_loopback</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">phy_flags</span> <span class="o">&amp;</span> <span class="n">TG3_PHYFLG_PHY_SERDES</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">USE_PHYLIB</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

		<span class="n">tg3_phy_lpbk_set</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>

		<span class="cm">/* Wait for link */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tr32</span><span class="p">(</span><span class="n">MAC_TX_STATUS</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">TX_STATUS_LINK_UP</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">tg3_run_loopback</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">ETH_FRAME_LEN</span><span class="p">,</span> <span class="nb">false</span><span class="p">))</span>
			<span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">|=</span> <span class="n">TG3_STD_LOOPBACK_FAILED</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">TSO_CAPABLE</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="n">tg3_run_loopback</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">ETH_FRAME_LEN</span><span class="p">,</span> <span class="nb">true</span><span class="p">))</span>
			<span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">|=</span> <span class="n">TG3_TSO_LOOPBACK_FAILED</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">JUMBO_RING_ENABLE</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="n">tg3_run_loopback</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">jmb_pkt_sz</span> <span class="o">+</span> <span class="n">ETH_HLEN</span><span class="p">,</span> <span class="nb">false</span><span class="p">))</span>
			<span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">|=</span> <span class="n">TG3_JMB_LOOPBACK_FAILED</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">do_extlpbk</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">tg3_phy_lpbk_set</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>

			<span class="cm">/* All link indications report up, but the hardware</span>
<span class="cm">			 * isn&#39;t really ready for about 20 msec.  Double it</span>
<span class="cm">			 * to be sure.</span>
<span class="cm">			 */</span>
			<span class="n">mdelay</span><span class="p">(</span><span class="mi">40</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">tg3_run_loopback</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">ETH_FRAME_LEN</span><span class="p">,</span> <span class="nb">false</span><span class="p">))</span>
				<span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">|=</span> <span class="n">TG3_STD_LOOPBACK_FAILED</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">TSO_CAPABLE</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="n">tg3_run_loopback</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">ETH_FRAME_LEN</span><span class="p">,</span> <span class="nb">true</span><span class="p">))</span>
				<span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">|=</span> <span class="n">TG3_TSO_LOOPBACK_FAILED</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">JUMBO_RING_ENABLE</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="n">tg3_run_loopback</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">jmb_pkt_sz</span> <span class="o">+</span> <span class="n">ETH_HLEN</span><span class="p">,</span> <span class="nb">false</span><span class="p">))</span>
				<span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">|=</span> <span class="n">TG3_JMB_LOOPBACK_FAILED</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Re-enable gphy autopowerdown. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">phy_flags</span> <span class="o">&amp;</span> <span class="n">TG3_PHYFLG_ENABLE_APD</span><span class="p">)</span>
			<span class="n">tg3_phy_toggle_apd</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">|</span> <span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">?</span> <span class="o">-</span><span class="n">EIO</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">done:</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">phy_flags</span> <span class="o">|=</span> <span class="n">eee_cap</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tg3_self_test</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ethtool_test</span> <span class="o">*</span><span class="n">etest</span><span class="p">,</span>
			  <span class="n">u64</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">bool</span> <span class="n">doextlpbk</span> <span class="o">=</span> <span class="n">etest</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ETH_TEST_FL_EXTERNAL_LB</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">phy_flags</span> <span class="o">&amp;</span> <span class="n">TG3_PHYFLG_IS_LOW_POWER</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">tg3_power_up</span><span class="p">(</span><span class="n">tp</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">etest</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">ETH_TEST_FL_FAILED</span><span class="p">;</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u64</span><span class="p">)</span> <span class="o">*</span> <span class="n">TG3_NUM_TEST</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u64</span><span class="p">)</span> <span class="o">*</span> <span class="n">TG3_NUM_TEST</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tg3_test_nvram</span><span class="p">(</span><span class="n">tp</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">etest</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">ETH_TEST_FL_FAILED</span><span class="p">;</span>
		<span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">doextlpbk</span> <span class="o">&amp;&amp;</span> <span class="n">tg3_test_link</span><span class="p">(</span><span class="n">tp</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">etest</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">ETH_TEST_FL_FAILED</span><span class="p">;</span>
		<span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">etest</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ETH_TEST_FL_OFFLINE</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">err</span><span class="p">,</span> <span class="n">err2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">irq_sync</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">netif_running</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">tg3_phy_stop</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
			<span class="n">tg3_netif_stop</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
			<span class="n">irq_sync</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">tg3_full_lock</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">irq_sync</span><span class="p">);</span>

		<span class="n">tg3_halt</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">RESET_KIND_SUSPEND</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">tg3_nvram_lock</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
		<span class="n">tg3_halt_cpu</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">RX_CPU_BASE</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">5705</span><span class="n">_PLUS</span><span class="p">))</span>
			<span class="n">tg3_halt_cpu</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">TX_CPU_BASE</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span>
			<span class="n">tg3_nvram_unlock</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">phy_flags</span> <span class="o">&amp;</span> <span class="n">TG3_PHYFLG_MII_SERDES</span><span class="p">)</span>
			<span class="n">tg3_phy_reset</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">tg3_test_registers</span><span class="p">(</span><span class="n">tp</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">etest</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">ETH_TEST_FL_FAILED</span><span class="p">;</span>
			<span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">tg3_test_memory</span><span class="p">(</span><span class="n">tp</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">etest</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">ETH_TEST_FL_FAILED</span><span class="p">;</span>
			<span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">doextlpbk</span><span class="p">)</span>
			<span class="n">etest</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">ETH_TEST_FL_EXTERNAL_LB_DONE</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">tg3_test_loopback</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">doextlpbk</span><span class="p">))</span>
			<span class="n">etest</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">ETH_TEST_FL_FAILED</span><span class="p">;</span>

		<span class="n">tg3_full_unlock</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">tg3_test_interrupt</span><span class="p">(</span><span class="n">tp</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">etest</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">ETH_TEST_FL_FAILED</span><span class="p">;</span>
			<span class="n">data</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">tg3_full_lock</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="n">tg3_halt</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">RESET_KIND_SHUTDOWN</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">netif_running</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">tg3_flag_set</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">INIT_COMPLETE</span><span class="p">);</span>
			<span class="n">err2</span> <span class="o">=</span> <span class="n">tg3_restart_hw</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err2</span><span class="p">)</span>
				<span class="n">tg3_netif_start</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">tg3_full_unlock</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">irq_sync</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">err2</span><span class="p">)</span>
			<span class="n">tg3_phy_start</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">phy_flags</span> <span class="o">&amp;</span> <span class="n">TG3_PHYFLG_IS_LOW_POWER</span><span class="p">)</span>
		<span class="n">tg3_power_down</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tg3_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ifreq</span> <span class="o">*</span><span class="n">ifr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mii_ioctl_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">if_mii</span><span class="p">(</span><span class="n">ifr</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">USE_PHYLIB</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">phy_device</span> <span class="o">*</span><span class="n">phydev</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">phy_flags</span> <span class="o">&amp;</span> <span class="n">TG3_PHYFLG_IS_CONNECTED</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
		<span class="n">phydev</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">mdio_bus</span><span class="o">-&gt;</span><span class="n">phy_map</span><span class="p">[</span><span class="n">TG3_PHY_MII_ADDR</span><span class="p">];</span>
		<span class="k">return</span> <span class="n">phy_mii_ioctl</span><span class="p">(</span><span class="n">phydev</span><span class="p">,</span> <span class="n">ifr</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SIOCGMIIPHY</span>:
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">phy_id</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">phy_addr</span><span class="p">;</span>

		<span class="cm">/* fallthru */</span>
	<span class="k">case</span> <span class="n">SIOCGMIIREG</span>: <span class="p">{</span>
		<span class="n">u32</span> <span class="n">mii_regval</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">phy_flags</span> <span class="o">&amp;</span> <span class="n">TG3_PHYFLG_PHY_SERDES</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>			<span class="cm">/* We have no PHY */</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">netif_running</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>

		<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">tg3_readphy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">reg_num</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mii_regval</span><span class="p">);</span>
		<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

		<span class="n">data</span><span class="o">-&gt;</span><span class="n">val_out</span> <span class="o">=</span> <span class="n">mii_regval</span><span class="p">;</span>

		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">case</span> <span class="n">SIOCSMIIREG</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">phy_flags</span> <span class="o">&amp;</span> <span class="n">TG3_PHYFLG_PHY_SERDES</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>			<span class="cm">/* We have no PHY */</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">netif_running</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>

		<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">tg3_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">reg_num</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">val_in</span><span class="p">);</span>
		<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="cm">/* do nothing */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tg3_get_coalesce</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ethtool_coalesce</span> <span class="o">*</span><span class="n">ec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">ec</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">coal</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ec</span><span class="p">));</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tg3_set_coalesce</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ethtool_coalesce</span> <span class="o">*</span><span class="n">ec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">max_rxcoal_tick_int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">max_txcoal_tick_int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">max_stat_coal_ticks</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">min_stat_coal_ticks</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">5705</span><span class="n">_PLUS</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">max_rxcoal_tick_int</span> <span class="o">=</span> <span class="n">MAX_RXCOAL_TICK_INT</span><span class="p">;</span>
		<span class="n">max_txcoal_tick_int</span> <span class="o">=</span> <span class="n">MAX_TXCOAL_TICK_INT</span><span class="p">;</span>
		<span class="n">max_stat_coal_ticks</span> <span class="o">=</span> <span class="n">MAX_STAT_COAL_TICKS</span><span class="p">;</span>
		<span class="n">min_stat_coal_ticks</span> <span class="o">=</span> <span class="n">MIN_STAT_COAL_TICKS</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ec</span><span class="o">-&gt;</span><span class="n">rx_coalesce_usecs</span> <span class="o">&gt;</span> <span class="n">MAX_RXCOL_TICKS</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">ec</span><span class="o">-&gt;</span><span class="n">tx_coalesce_usecs</span> <span class="o">&gt;</span> <span class="n">MAX_TXCOL_TICKS</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">ec</span><span class="o">-&gt;</span><span class="n">rx_max_coalesced_frames</span> <span class="o">&gt;</span> <span class="n">MAX_RXMAX_FRAMES</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">ec</span><span class="o">-&gt;</span><span class="n">tx_max_coalesced_frames</span> <span class="o">&gt;</span> <span class="n">MAX_TXMAX_FRAMES</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">ec</span><span class="o">-&gt;</span><span class="n">rx_coalesce_usecs_irq</span> <span class="o">&gt;</span> <span class="n">max_rxcoal_tick_int</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">ec</span><span class="o">-&gt;</span><span class="n">tx_coalesce_usecs_irq</span> <span class="o">&gt;</span> <span class="n">max_txcoal_tick_int</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">ec</span><span class="o">-&gt;</span><span class="n">rx_max_coalesced_frames_irq</span> <span class="o">&gt;</span> <span class="n">MAX_RXCOAL_MAXF_INT</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">ec</span><span class="o">-&gt;</span><span class="n">tx_max_coalesced_frames_irq</span> <span class="o">&gt;</span> <span class="n">MAX_TXCOAL_MAXF_INT</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">ec</span><span class="o">-&gt;</span><span class="n">stats_block_coalesce_usecs</span> <span class="o">&gt;</span> <span class="n">max_stat_coal_ticks</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">ec</span><span class="o">-&gt;</span><span class="n">stats_block_coalesce_usecs</span> <span class="o">&lt;</span> <span class="n">min_stat_coal_ticks</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/* No rx interrupts will be generated if both are zero */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ec</span><span class="o">-&gt;</span><span class="n">rx_coalesce_usecs</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">ec</span><span class="o">-&gt;</span><span class="n">rx_max_coalesced_frames</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/* No tx interrupts will be generated if both are zero */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ec</span><span class="o">-&gt;</span><span class="n">tx_coalesce_usecs</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">ec</span><span class="o">-&gt;</span><span class="n">tx_max_coalesced_frames</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/* Only copy relevant parameters, ignore all others. */</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">coal</span><span class="p">.</span><span class="n">rx_coalesce_usecs</span> <span class="o">=</span> <span class="n">ec</span><span class="o">-&gt;</span><span class="n">rx_coalesce_usecs</span><span class="p">;</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">coal</span><span class="p">.</span><span class="n">tx_coalesce_usecs</span> <span class="o">=</span> <span class="n">ec</span><span class="o">-&gt;</span><span class="n">tx_coalesce_usecs</span><span class="p">;</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">coal</span><span class="p">.</span><span class="n">rx_max_coalesced_frames</span> <span class="o">=</span> <span class="n">ec</span><span class="o">-&gt;</span><span class="n">rx_max_coalesced_frames</span><span class="p">;</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">coal</span><span class="p">.</span><span class="n">tx_max_coalesced_frames</span> <span class="o">=</span> <span class="n">ec</span><span class="o">-&gt;</span><span class="n">tx_max_coalesced_frames</span><span class="p">;</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">coal</span><span class="p">.</span><span class="n">rx_coalesce_usecs_irq</span> <span class="o">=</span> <span class="n">ec</span><span class="o">-&gt;</span><span class="n">rx_coalesce_usecs_irq</span><span class="p">;</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">coal</span><span class="p">.</span><span class="n">tx_coalesce_usecs_irq</span> <span class="o">=</span> <span class="n">ec</span><span class="o">-&gt;</span><span class="n">tx_coalesce_usecs_irq</span><span class="p">;</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">coal</span><span class="p">.</span><span class="n">rx_max_coalesced_frames_irq</span> <span class="o">=</span> <span class="n">ec</span><span class="o">-&gt;</span><span class="n">rx_max_coalesced_frames_irq</span><span class="p">;</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">coal</span><span class="p">.</span><span class="n">tx_max_coalesced_frames_irq</span> <span class="o">=</span> <span class="n">ec</span><span class="o">-&gt;</span><span class="n">tx_max_coalesced_frames_irq</span><span class="p">;</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">coal</span><span class="p">.</span><span class="n">stats_block_coalesce_usecs</span> <span class="o">=</span> <span class="n">ec</span><span class="o">-&gt;</span><span class="n">stats_block_coalesce_usecs</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">netif_running</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">tg3_full_lock</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">__tg3_set_coalesce</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">coal</span><span class="p">);</span>
		<span class="n">tg3_full_unlock</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ethtool_ops</span> <span class="n">tg3_ethtool_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">get_settings</span>		<span class="o">=</span> <span class="n">tg3_get_settings</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_settings</span>		<span class="o">=</span> <span class="n">tg3_set_settings</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_drvinfo</span>		<span class="o">=</span> <span class="n">tg3_get_drvinfo</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_regs_len</span>		<span class="o">=</span> <span class="n">tg3_get_regs_len</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_regs</span>		<span class="o">=</span> <span class="n">tg3_get_regs</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_wol</span>		<span class="o">=</span> <span class="n">tg3_get_wol</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_wol</span>		<span class="o">=</span> <span class="n">tg3_set_wol</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_msglevel</span>		<span class="o">=</span> <span class="n">tg3_get_msglevel</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_msglevel</span>		<span class="o">=</span> <span class="n">tg3_set_msglevel</span><span class="p">,</span>
	<span class="p">.</span><span class="n">nway_reset</span>		<span class="o">=</span> <span class="n">tg3_nway_reset</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_link</span>		<span class="o">=</span> <span class="n">ethtool_op_get_link</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_eeprom_len</span>		<span class="o">=</span> <span class="n">tg3_get_eeprom_len</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_eeprom</span>		<span class="o">=</span> <span class="n">tg3_get_eeprom</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_eeprom</span>		<span class="o">=</span> <span class="n">tg3_set_eeprom</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_ringparam</span>		<span class="o">=</span> <span class="n">tg3_get_ringparam</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_ringparam</span>		<span class="o">=</span> <span class="n">tg3_set_ringparam</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_pauseparam</span>		<span class="o">=</span> <span class="n">tg3_get_pauseparam</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_pauseparam</span>		<span class="o">=</span> <span class="n">tg3_set_pauseparam</span><span class="p">,</span>
	<span class="p">.</span><span class="n">self_test</span>		<span class="o">=</span> <span class="n">tg3_self_test</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_strings</span>		<span class="o">=</span> <span class="n">tg3_get_strings</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_phys_id</span>		<span class="o">=</span> <span class="n">tg3_set_phys_id</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_ethtool_stats</span>	<span class="o">=</span> <span class="n">tg3_get_ethtool_stats</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_coalesce</span>		<span class="o">=</span> <span class="n">tg3_get_coalesce</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_coalesce</span>		<span class="o">=</span> <span class="n">tg3_set_coalesce</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_sset_count</span>		<span class="o">=</span> <span class="n">tg3_get_sset_count</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_rxnfc</span>		<span class="o">=</span> <span class="n">tg3_get_rxnfc</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_rxfh_indir_size</span>    <span class="o">=</span> <span class="n">tg3_get_rxfh_indir_size</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_rxfh_indir</span>		<span class="o">=</span> <span class="n">tg3_get_rxfh_indir</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_rxfh_indir</span>		<span class="o">=</span> <span class="n">tg3_set_rxfh_indir</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_ts_info</span>		<span class="o">=</span> <span class="n">ethtool_op_get_ts_info</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">rtnl_link_stats64</span> <span class="o">*</span><span class="nf">tg3_get_stats64</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
						<span class="k">struct</span> <span class="n">rtnl_link_stats64</span> <span class="o">*</span><span class="n">stats</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">hw_stats</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">net_stats_prev</span><span class="p">;</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">tg3_get_nstats</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">stats</span><span class="p">);</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">stats</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tg3_set_rx_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">netif_running</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">tg3_full_lock</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">__tg3_set_rx_mode</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">tg3_full_unlock</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">tg3_set_mtu</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span><span class="p">,</span>
			       <span class="kt">int</span> <span class="n">new_mtu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">mtu</span> <span class="o">=</span> <span class="n">new_mtu</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">new_mtu</span> <span class="o">&gt;</span> <span class="n">ETH_DATA_LEN</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">5780</span><span class="n">_CLASS</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">netdev_update_features</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="n">tg3_flag_clear</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">TSO_CAPABLE</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">tg3_flag_set</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">JUMBO_RING_ENABLE</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">5780</span><span class="n">_CLASS</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">tg3_flag_set</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">TSO_CAPABLE</span><span class="p">);</span>
			<span class="n">netdev_update_features</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">tg3_flag_clear</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">JUMBO_RING_ENABLE</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tg3_change_mtu</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">new_mtu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">,</span> <span class="n">reset_phy</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">new_mtu</span> <span class="o">&lt;</span> <span class="n">TG3_MIN_MTU</span> <span class="o">||</span> <span class="n">new_mtu</span> <span class="o">&gt;</span> <span class="n">TG3_MAX_MTU</span><span class="p">(</span><span class="n">tp</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">netif_running</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* We&#39;ll just catch it later when the</span>
<span class="cm">		 * device is up&#39;d.</span>
<span class="cm">		 */</span>
		<span class="n">tg3_set_mtu</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">tp</span><span class="p">,</span> <span class="n">new_mtu</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">tg3_phy_stop</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>

	<span class="n">tg3_netif_stop</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>

	<span class="n">tg3_full_lock</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">tg3_halt</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">RESET_KIND_SHUTDOWN</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">tg3_set_mtu</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">tp</span><span class="p">,</span> <span class="n">new_mtu</span><span class="p">);</span>

	<span class="cm">/* Reset PHY, otherwise the read DMA engine will be in a mode that</span>
<span class="cm">	 * breaks all requests to 256 bytes.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">ASIC_REV_57766</span><span class="p">)</span>
		<span class="n">reset_phy</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">tg3_restart_hw</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">reset_phy</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span>
		<span class="n">tg3_netif_start</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>

	<span class="n">tg3_full_unlock</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span>
		<span class="n">tg3_phy_start</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">net_device_ops</span> <span class="n">tg3_netdev_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">ndo_open</span>		<span class="o">=</span> <span class="n">tg3_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_stop</span>		<span class="o">=</span> <span class="n">tg3_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_start_xmit</span>		<span class="o">=</span> <span class="n">tg3_start_xmit</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_get_stats64</span>	<span class="o">=</span> <span class="n">tg3_get_stats64</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_validate_addr</span>	<span class="o">=</span> <span class="n">eth_validate_addr</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_set_rx_mode</span>	<span class="o">=</span> <span class="n">tg3_set_rx_mode</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_set_mac_address</span>	<span class="o">=</span> <span class="n">tg3_set_mac_addr</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_do_ioctl</span>		<span class="o">=</span> <span class="n">tg3_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_tx_timeout</span>		<span class="o">=</span> <span class="n">tg3_tx_timeout</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_change_mtu</span>		<span class="o">=</span> <span class="n">tg3_change_mtu</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_fix_features</span>	<span class="o">=</span> <span class="n">tg3_fix_features</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_set_features</span>	<span class="o">=</span> <span class="n">tg3_set_features</span><span class="p">,</span>
<span class="cp">#ifdef CONFIG_NET_POLL_CONTROLLER</span>
	<span class="p">.</span><span class="n">ndo_poll_controller</span>	<span class="o">=</span> <span class="n">tg3_poll_controller</span><span class="p">,</span>
<span class="cp">#endif</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span> <span class="nf">tg3_get_eeprom_size</span><span class="p">(</span><span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">cursize</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">magic</span><span class="p">;</span>

	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">nvram_size</span> <span class="o">=</span> <span class="n">EEPROM_CHIP_SIZE</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tg3_nvram_read</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">magic</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">magic</span> <span class="o">!=</span> <span class="n">TG3_EEPROM_MAGIC</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">((</span><span class="n">magic</span> <span class="o">&amp;</span> <span class="n">TG3_EEPROM_MAGIC_FW_MSK</span><span class="p">)</span> <span class="o">!=</span> <span class="n">TG3_EEPROM_MAGIC_FW</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">((</span><span class="n">magic</span> <span class="o">&amp;</span> <span class="n">TG3_EEPROM_MAGIC_HW_MSK</span><span class="p">)</span> <span class="o">!=</span> <span class="n">TG3_EEPROM_MAGIC_HW</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Size the chip by reading offsets at increasing powers of two.</span>
<span class="cm">	 * When we encounter our validation signature, we know the addressing</span>
<span class="cm">	 * has wrapped around, and thus have our chip size.</span>
<span class="cm">	 */</span>
	<span class="n">cursize</span> <span class="o">=</span> <span class="mh">0x10</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">cursize</span> <span class="o">&lt;</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">nvram_size</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tg3_nvram_read</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">cursize</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">==</span> <span class="n">magic</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">cursize</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">nvram_size</span> <span class="o">=</span> <span class="n">cursize</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span> <span class="nf">tg3_get_nvram_size</span><span class="p">(</span><span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">NO_NVRAM</span><span class="p">)</span> <span class="o">||</span> <span class="n">tg3_nvram_read</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* Selfboot format */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">!=</span> <span class="n">TG3_EEPROM_MAGIC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tg3_get_eeprom_size</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tg3_nvram_read</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mh">0xf0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* This is confusing.  We want to operate on the</span>
<span class="cm">			 * 16-bit value at offset 0xf2.  The tg3_nvram_read()</span>
<span class="cm">			 * call will read from NVRAM and byteswap the data</span>
<span class="cm">			 * according to the byteswapping settings for all</span>
<span class="cm">			 * other register accesses.  This ensures the data we</span>
<span class="cm">			 * want will always reside in the lower 16-bits.</span>
<span class="cm">			 * However, the data in NVRAM is in LE format, which</span>
<span class="cm">			 * means the data from the NVRAM read will always be</span>
<span class="cm">			 * opposite the endianness of the CPU.  The 16-bit</span>
<span class="cm">			 * byteswap then brings the data to CPU endianness.</span>
<span class="cm">			 */</span>
			<span class="n">tp</span><span class="o">-&gt;</span><span class="n">nvram_size</span> <span class="o">=</span> <span class="n">swab16</span><span class="p">((</span><span class="n">u16</span><span class="p">)(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0x0000ffff</span><span class="p">))</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">;</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">nvram_size</span> <span class="o">=</span> <span class="n">TG3_NVRAM_SIZE_512KB</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span> <span class="nf">tg3_get_nvram_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">nvcfg1</span><span class="p">;</span>

	<span class="n">nvcfg1</span> <span class="o">=</span> <span class="n">tr32</span><span class="p">(</span><span class="n">NVRAM_CFG1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nvcfg1</span> <span class="o">&amp;</span> <span class="n">NVRAM_CFG1_FLASHIF_ENAB</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tg3_flag_set</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">FLASH</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">nvcfg1</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">NVRAM_CFG1_COMPAT_BYPASS</span><span class="p">;</span>
		<span class="n">tw32</span><span class="p">(</span><span class="n">NVRAM_CFG1</span><span class="p">,</span> <span class="n">nvcfg1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">ASIC_REV_5750</span> <span class="o">||</span>
	    <span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">5780</span><span class="n">_CLASS</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">nvcfg1</span> <span class="o">&amp;</span> <span class="n">NVRAM_CFG1_VENDOR_MASK</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">FLASH_VENDOR_ATMEL_FLASH_BUFFERED</span>:
			<span class="n">tp</span><span class="o">-&gt;</span><span class="n">nvram_jedecnum</span> <span class="o">=</span> <span class="n">JEDEC_ATMEL</span><span class="p">;</span>
			<span class="n">tp</span><span class="o">-&gt;</span><span class="n">nvram_pagesize</span> <span class="o">=</span> <span class="n">ATMEL_AT45DB0X1B_PAGE_SIZE</span><span class="p">;</span>
			<span class="n">tg3_flag_set</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">NVRAM_BUFFERED</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">FLASH_VENDOR_ATMEL_FLASH_UNBUFFERED</span>:
			<span class="n">tp</span><span class="o">-&gt;</span><span class="n">nvram_jedecnum</span> <span class="o">=</span> <span class="n">JEDEC_ATMEL</span><span class="p">;</span>
			<span class="n">tp</span><span class="o">-&gt;</span><span class="n">nvram_pagesize</span> <span class="o">=</span> <span class="n">ATMEL_AT25F512_PAGE_SIZE</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">FLASH_VENDOR_ATMEL_EEPROM</span>:
			<span class="n">tp</span><span class="o">-&gt;</span><span class="n">nvram_jedecnum</span> <span class="o">=</span> <span class="n">JEDEC_ATMEL</span><span class="p">;</span>
			<span class="n">tp</span><span class="o">-&gt;</span><span class="n">nvram_pagesize</span> <span class="o">=</span> <span class="n">ATMEL_AT24C512_CHIP_SIZE</span><span class="p">;</span>
			<span class="n">tg3_flag_set</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">NVRAM_BUFFERED</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">FLASH_VENDOR_ST</span>:
			<span class="n">tp</span><span class="o">-&gt;</span><span class="n">nvram_jedecnum</span> <span class="o">=</span> <span class="n">JEDEC_ST</span><span class="p">;</span>
			<span class="n">tp</span><span class="o">-&gt;</span><span class="n">nvram_pagesize</span> <span class="o">=</span> <span class="n">ST_M45PEX0_PAGE_SIZE</span><span class="p">;</span>
			<span class="n">tg3_flag_set</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">NVRAM_BUFFERED</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">FLASH_VENDOR_SAIFUN</span>:
			<span class="n">tp</span><span class="o">-&gt;</span><span class="n">nvram_jedecnum</span> <span class="o">=</span> <span class="n">JEDEC_SAIFUN</span><span class="p">;</span>
			<span class="n">tp</span><span class="o">-&gt;</span><span class="n">nvram_pagesize</span> <span class="o">=</span> <span class="n">SAIFUN_SA25F0XX_PAGE_SIZE</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">FLASH_VENDOR_SST_SMALL</span>:
		<span class="k">case</span> <span class="n">FLASH_VENDOR_SST_LARGE</span>:
			<span class="n">tp</span><span class="o">-&gt;</span><span class="n">nvram_jedecnum</span> <span class="o">=</span> <span class="n">JEDEC_SST</span><span class="p">;</span>
			<span class="n">tp</span><span class="o">-&gt;</span><span class="n">nvram_pagesize</span> <span class="o">=</span> <span class="n">SST_25VF0X0_PAGE_SIZE</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">nvram_jedecnum</span> <span class="o">=</span> <span class="n">JEDEC_ATMEL</span><span class="p">;</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">nvram_pagesize</span> <span class="o">=</span> <span class="n">ATMEL_AT45DB0X1B_PAGE_SIZE</span><span class="p">;</span>
		<span class="n">tg3_flag_set</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">NVRAM_BUFFERED</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span> <span class="nf">tg3_nvram_get_pagesize</span><span class="p">(</span><span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span><span class="p">,</span> <span class="n">u32</span> <span class="n">nvmcfg1</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">nvmcfg1</span> <span class="o">&amp;</span> <span class="n">NVRAM_CFG1_5752PAGE_SIZE_MASK</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">FLASH_5752PAGE_SIZE_256</span>:
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">nvram_pagesize</span> <span class="o">=</span> <span class="mi">256</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FLASH_5752PAGE_SIZE_512</span>:
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">nvram_pagesize</span> <span class="o">=</span> <span class="mi">512</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FLASH_5752PAGE_SIZE_1K</span>:
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">nvram_pagesize</span> <span class="o">=</span> <span class="mi">1024</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FLASH_5752PAGE_SIZE_2K</span>:
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">nvram_pagesize</span> <span class="o">=</span> <span class="mi">2048</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FLASH_5752PAGE_SIZE_4K</span>:
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">nvram_pagesize</span> <span class="o">=</span> <span class="mi">4096</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FLASH_5752PAGE_SIZE_264</span>:
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">nvram_pagesize</span> <span class="o">=</span> <span class="mi">264</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FLASH_5752PAGE_SIZE_528</span>:
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">nvram_pagesize</span> <span class="o">=</span> <span class="mi">528</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span> <span class="nf">tg3_get_5752_nvram_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">nvcfg1</span><span class="p">;</span>

	<span class="n">nvcfg1</span> <span class="o">=</span> <span class="n">tr32</span><span class="p">(</span><span class="n">NVRAM_CFG1</span><span class="p">);</span>

	<span class="cm">/* NVRAM protection for TPM */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nvcfg1</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">27</span><span class="p">))</span>
		<span class="n">tg3_flag_set</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">PROTECTED_NVRAM</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">nvcfg1</span> <span class="o">&amp;</span> <span class="n">NVRAM_CFG1_5752VENDOR_MASK</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">FLASH_5752VENDOR_ATMEL_EEPROM_64KHZ</span>:
	<span class="k">case</span> <span class="n">FLASH_5752VENDOR_ATMEL_EEPROM_376KHZ</span>:
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">nvram_jedecnum</span> <span class="o">=</span> <span class="n">JEDEC_ATMEL</span><span class="p">;</span>
		<span class="n">tg3_flag_set</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">NVRAM_BUFFERED</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FLASH_5752VENDOR_ATMEL_FLASH_BUFFERED</span>:
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">nvram_jedecnum</span> <span class="o">=</span> <span class="n">JEDEC_ATMEL</span><span class="p">;</span>
		<span class="n">tg3_flag_set</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">NVRAM_BUFFERED</span><span class="p">);</span>
		<span class="n">tg3_flag_set</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">FLASH</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FLASH_5752VENDOR_ST_M45PE10</span>:
	<span class="k">case</span> <span class="n">FLASH_5752VENDOR_ST_M45PE20</span>:
	<span class="k">case</span> <span class="n">FLASH_5752VENDOR_ST_M45PE40</span>:
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">nvram_jedecnum</span> <span class="o">=</span> <span class="n">JEDEC_ST</span><span class="p">;</span>
		<span class="n">tg3_flag_set</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">NVRAM_BUFFERED</span><span class="p">);</span>
		<span class="n">tg3_flag_set</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">FLASH</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">FLASH</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">tg3_nvram_get_pagesize</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">nvcfg1</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* For eeprom, set pagesize to maximum eeprom size */</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">nvram_pagesize</span> <span class="o">=</span> <span class="n">ATMEL_AT24C512_CHIP_SIZE</span><span class="p">;</span>

		<span class="n">nvcfg1</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">NVRAM_CFG1_COMPAT_BYPASS</span><span class="p">;</span>
		<span class="n">tw32</span><span class="p">(</span><span class="n">NVRAM_CFG1</span><span class="p">,</span> <span class="n">nvcfg1</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span> <span class="nf">tg3_get_5755_nvram_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">nvcfg1</span><span class="p">,</span> <span class="n">protect</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">nvcfg1</span> <span class="o">=</span> <span class="n">tr32</span><span class="p">(</span><span class="n">NVRAM_CFG1</span><span class="p">);</span>

	<span class="cm">/* NVRAM protection for TPM */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nvcfg1</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">27</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">tg3_flag_set</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">PROTECTED_NVRAM</span><span class="p">);</span>
		<span class="n">protect</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">nvcfg1</span> <span class="o">&amp;=</span> <span class="n">NVRAM_CFG1_5752VENDOR_MASK</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">nvcfg1</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">FLASH_5755VENDOR_ATMEL_FLASH_1</span>:
	<span class="k">case</span> <span class="n">FLASH_5755VENDOR_ATMEL_FLASH_2</span>:
	<span class="k">case</span> <span class="n">FLASH_5755VENDOR_ATMEL_FLASH_3</span>:
	<span class="k">case</span> <span class="n">FLASH_5755VENDOR_ATMEL_FLASH_5</span>:
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">nvram_jedecnum</span> <span class="o">=</span> <span class="n">JEDEC_ATMEL</span><span class="p">;</span>
		<span class="n">tg3_flag_set</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">NVRAM_BUFFERED</span><span class="p">);</span>
		<span class="n">tg3_flag_set</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">FLASH</span><span class="p">);</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">nvram_pagesize</span> <span class="o">=</span> <span class="mi">264</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">nvcfg1</span> <span class="o">==</span> <span class="n">FLASH_5755VENDOR_ATMEL_FLASH_1</span> <span class="o">||</span>
		    <span class="n">nvcfg1</span> <span class="o">==</span> <span class="n">FLASH_5755VENDOR_ATMEL_FLASH_5</span><span class="p">)</span>
			<span class="n">tp</span><span class="o">-&gt;</span><span class="n">nvram_size</span> <span class="o">=</span> <span class="p">(</span><span class="n">protect</span> <span class="o">?</span> <span class="mh">0x3e200</span> <span class="o">:</span>
					  <span class="n">TG3_NVRAM_SIZE_512KB</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">nvcfg1</span> <span class="o">==</span> <span class="n">FLASH_5755VENDOR_ATMEL_FLASH_2</span><span class="p">)</span>
			<span class="n">tp</span><span class="o">-&gt;</span><span class="n">nvram_size</span> <span class="o">=</span> <span class="p">(</span><span class="n">protect</span> <span class="o">?</span> <span class="mh">0x1f200</span> <span class="o">:</span>
					  <span class="n">TG3_NVRAM_SIZE_256KB</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">tp</span><span class="o">-&gt;</span><span class="n">nvram_size</span> <span class="o">=</span> <span class="p">(</span><span class="n">protect</span> <span class="o">?</span> <span class="mh">0x1f200</span> <span class="o">:</span>
					  <span class="n">TG3_NVRAM_SIZE_128KB</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FLASH_5752VENDOR_ST_M45PE10</span>:
	<span class="k">case</span> <span class="n">FLASH_5752VENDOR_ST_M45PE20</span>:
	<span class="k">case</span> <span class="n">FLASH_5752VENDOR_ST_M45PE40</span>:
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">nvram_jedecnum</span> <span class="o">=</span> <span class="n">JEDEC_ST</span><span class="p">;</span>
		<span class="n">tg3_flag_set</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">NVRAM_BUFFERED</span><span class="p">);</span>
		<span class="n">tg3_flag_set</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">FLASH</span><span class="p">);</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">nvram_pagesize</span> <span class="o">=</span> <span class="mi">256</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">nvcfg1</span> <span class="o">==</span> <span class="n">FLASH_5752VENDOR_ST_M45PE10</span><span class="p">)</span>
			<span class="n">tp</span><span class="o">-&gt;</span><span class="n">nvram_size</span> <span class="o">=</span> <span class="p">(</span><span class="n">protect</span> <span class="o">?</span>
					  <span class="n">TG3_NVRAM_SIZE_64KB</span> <span class="o">:</span>
					  <span class="n">TG3_NVRAM_SIZE_128KB</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">nvcfg1</span> <span class="o">==</span> <span class="n">FLASH_5752VENDOR_ST_M45PE20</span><span class="p">)</span>
			<span class="n">tp</span><span class="o">-&gt;</span><span class="n">nvram_size</span> <span class="o">=</span> <span class="p">(</span><span class="n">protect</span> <span class="o">?</span>
					  <span class="n">TG3_NVRAM_SIZE_64KB</span> <span class="o">:</span>
					  <span class="n">TG3_NVRAM_SIZE_256KB</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">tp</span><span class="o">-&gt;</span><span class="n">nvram_size</span> <span class="o">=</span> <span class="p">(</span><span class="n">protect</span> <span class="o">?</span>
					  <span class="n">TG3_NVRAM_SIZE_128KB</span> <span class="o">:</span>
					  <span class="n">TG3_NVRAM_SIZE_512KB</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span> <span class="nf">tg3_get_5787_nvram_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">nvcfg1</span><span class="p">;</span>

	<span class="n">nvcfg1</span> <span class="o">=</span> <span class="n">tr32</span><span class="p">(</span><span class="n">NVRAM_CFG1</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">nvcfg1</span> <span class="o">&amp;</span> <span class="n">NVRAM_CFG1_5752VENDOR_MASK</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">FLASH_5787VENDOR_ATMEL_EEPROM_64KHZ</span>:
	<span class="k">case</span> <span class="n">FLASH_5787VENDOR_ATMEL_EEPROM_376KHZ</span>:
	<span class="k">case</span> <span class="n">FLASH_5787VENDOR_MICRO_EEPROM_64KHZ</span>:
	<span class="k">case</span> <span class="n">FLASH_5787VENDOR_MICRO_EEPROM_376KHZ</span>:
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">nvram_jedecnum</span> <span class="o">=</span> <span class="n">JEDEC_ATMEL</span><span class="p">;</span>
		<span class="n">tg3_flag_set</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">NVRAM_BUFFERED</span><span class="p">);</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">nvram_pagesize</span> <span class="o">=</span> <span class="n">ATMEL_AT24C512_CHIP_SIZE</span><span class="p">;</span>

		<span class="n">nvcfg1</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">NVRAM_CFG1_COMPAT_BYPASS</span><span class="p">;</span>
		<span class="n">tw32</span><span class="p">(</span><span class="n">NVRAM_CFG1</span><span class="p">,</span> <span class="n">nvcfg1</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FLASH_5752VENDOR_ATMEL_FLASH_BUFFERED</span>:
	<span class="k">case</span> <span class="n">FLASH_5755VENDOR_ATMEL_FLASH_1</span>:
	<span class="k">case</span> <span class="n">FLASH_5755VENDOR_ATMEL_FLASH_2</span>:
	<span class="k">case</span> <span class="n">FLASH_5755VENDOR_ATMEL_FLASH_3</span>:
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">nvram_jedecnum</span> <span class="o">=</span> <span class="n">JEDEC_ATMEL</span><span class="p">;</span>
		<span class="n">tg3_flag_set</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">NVRAM_BUFFERED</span><span class="p">);</span>
		<span class="n">tg3_flag_set</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">FLASH</span><span class="p">);</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">nvram_pagesize</span> <span class="o">=</span> <span class="mi">264</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FLASH_5752VENDOR_ST_M45PE10</span>:
	<span class="k">case</span> <span class="n">FLASH_5752VENDOR_ST_M45PE20</span>:
	<span class="k">case</span> <span class="n">FLASH_5752VENDOR_ST_M45PE40</span>:
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">nvram_jedecnum</span> <span class="o">=</span> <span class="n">JEDEC_ST</span><span class="p">;</span>
		<span class="n">tg3_flag_set</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">NVRAM_BUFFERED</span><span class="p">);</span>
		<span class="n">tg3_flag_set</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">FLASH</span><span class="p">);</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">nvram_pagesize</span> <span class="o">=</span> <span class="mi">256</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span> <span class="nf">tg3_get_5761_nvram_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">nvcfg1</span><span class="p">,</span> <span class="n">protect</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">nvcfg1</span> <span class="o">=</span> <span class="n">tr32</span><span class="p">(</span><span class="n">NVRAM_CFG1</span><span class="p">);</span>

	<span class="cm">/* NVRAM protection for TPM */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nvcfg1</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">27</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">tg3_flag_set</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">PROTECTED_NVRAM</span><span class="p">);</span>
		<span class="n">protect</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">nvcfg1</span> <span class="o">&amp;=</span> <span class="n">NVRAM_CFG1_5752VENDOR_MASK</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">nvcfg1</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">FLASH_5761VENDOR_ATMEL_ADB021D</span>:
	<span class="k">case</span> <span class="n">FLASH_5761VENDOR_ATMEL_ADB041D</span>:
	<span class="k">case</span> <span class="n">FLASH_5761VENDOR_ATMEL_ADB081D</span>:
	<span class="k">case</span> <span class="n">FLASH_5761VENDOR_ATMEL_ADB161D</span>:
	<span class="k">case</span> <span class="n">FLASH_5761VENDOR_ATMEL_MDB021D</span>:
	<span class="k">case</span> <span class="n">FLASH_5761VENDOR_ATMEL_MDB041D</span>:
	<span class="k">case</span> <span class="n">FLASH_5761VENDOR_ATMEL_MDB081D</span>:
	<span class="k">case</span> <span class="n">FLASH_5761VENDOR_ATMEL_MDB161D</span>:
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">nvram_jedecnum</span> <span class="o">=</span> <span class="n">JEDEC_ATMEL</span><span class="p">;</span>
		<span class="n">tg3_flag_set</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">NVRAM_BUFFERED</span><span class="p">);</span>
		<span class="n">tg3_flag_set</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">FLASH</span><span class="p">);</span>
		<span class="n">tg3_flag_set</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">NO_NVRAM_ADDR_TRANS</span><span class="p">);</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">nvram_pagesize</span> <span class="o">=</span> <span class="mi">256</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FLASH_5761VENDOR_ST_A_M45PE20</span>:
	<span class="k">case</span> <span class="n">FLASH_5761VENDOR_ST_A_M45PE40</span>:
	<span class="k">case</span> <span class="n">FLASH_5761VENDOR_ST_A_M45PE80</span>:
	<span class="k">case</span> <span class="n">FLASH_5761VENDOR_ST_A_M45PE16</span>:
	<span class="k">case</span> <span class="n">FLASH_5761VENDOR_ST_M_M45PE20</span>:
	<span class="k">case</span> <span class="n">FLASH_5761VENDOR_ST_M_M45PE40</span>:
	<span class="k">case</span> <span class="n">FLASH_5761VENDOR_ST_M_M45PE80</span>:
	<span class="k">case</span> <span class="n">FLASH_5761VENDOR_ST_M_M45PE16</span>:
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">nvram_jedecnum</span> <span class="o">=</span> <span class="n">JEDEC_ST</span><span class="p">;</span>
		<span class="n">tg3_flag_set</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">NVRAM_BUFFERED</span><span class="p">);</span>
		<span class="n">tg3_flag_set</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">FLASH</span><span class="p">);</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">nvram_pagesize</span> <span class="o">=</span> <span class="mi">256</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">protect</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">nvram_size</span> <span class="o">=</span> <span class="n">tr32</span><span class="p">(</span><span class="n">NVRAM_ADDR_LOCKOUT</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">nvcfg1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">FLASH_5761VENDOR_ATMEL_ADB161D</span>:
		<span class="k">case</span> <span class="n">FLASH_5761VENDOR_ATMEL_MDB161D</span>:
		<span class="k">case</span> <span class="n">FLASH_5761VENDOR_ST_A_M45PE16</span>:
		<span class="k">case</span> <span class="n">FLASH_5761VENDOR_ST_M_M45PE16</span>:
			<span class="n">tp</span><span class="o">-&gt;</span><span class="n">nvram_size</span> <span class="o">=</span> <span class="n">TG3_NVRAM_SIZE_2MB</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">FLASH_5761VENDOR_ATMEL_ADB081D</span>:
		<span class="k">case</span> <span class="n">FLASH_5761VENDOR_ATMEL_MDB081D</span>:
		<span class="k">case</span> <span class="n">FLASH_5761VENDOR_ST_A_M45PE80</span>:
		<span class="k">case</span> <span class="n">FLASH_5761VENDOR_ST_M_M45PE80</span>:
			<span class="n">tp</span><span class="o">-&gt;</span><span class="n">nvram_size</span> <span class="o">=</span> <span class="n">TG3_NVRAM_SIZE_1MB</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">FLASH_5761VENDOR_ATMEL_ADB041D</span>:
		<span class="k">case</span> <span class="n">FLASH_5761VENDOR_ATMEL_MDB041D</span>:
		<span class="k">case</span> <span class="n">FLASH_5761VENDOR_ST_A_M45PE40</span>:
		<span class="k">case</span> <span class="n">FLASH_5761VENDOR_ST_M_M45PE40</span>:
			<span class="n">tp</span><span class="o">-&gt;</span><span class="n">nvram_size</span> <span class="o">=</span> <span class="n">TG3_NVRAM_SIZE_512KB</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">FLASH_5761VENDOR_ATMEL_ADB021D</span>:
		<span class="k">case</span> <span class="n">FLASH_5761VENDOR_ATMEL_MDB021D</span>:
		<span class="k">case</span> <span class="n">FLASH_5761VENDOR_ST_A_M45PE20</span>:
		<span class="k">case</span> <span class="n">FLASH_5761VENDOR_ST_M_M45PE20</span>:
			<span class="n">tp</span><span class="o">-&gt;</span><span class="n">nvram_size</span> <span class="o">=</span> <span class="n">TG3_NVRAM_SIZE_256KB</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span> <span class="nf">tg3_get_5906_nvram_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">nvram_jedecnum</span> <span class="o">=</span> <span class="n">JEDEC_ATMEL</span><span class="p">;</span>
	<span class="n">tg3_flag_set</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">NVRAM_BUFFERED</span><span class="p">);</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">nvram_pagesize</span> <span class="o">=</span> <span class="n">ATMEL_AT24C512_CHIP_SIZE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span> <span class="nf">tg3_get_57780_nvram_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">nvcfg1</span><span class="p">;</span>

	<span class="n">nvcfg1</span> <span class="o">=</span> <span class="n">tr32</span><span class="p">(</span><span class="n">NVRAM_CFG1</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">nvcfg1</span> <span class="o">&amp;</span> <span class="n">NVRAM_CFG1_5752VENDOR_MASK</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">FLASH_5787VENDOR_ATMEL_EEPROM_376KHZ</span>:
	<span class="k">case</span> <span class="n">FLASH_5787VENDOR_MICRO_EEPROM_376KHZ</span>:
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">nvram_jedecnum</span> <span class="o">=</span> <span class="n">JEDEC_ATMEL</span><span class="p">;</span>
		<span class="n">tg3_flag_set</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">NVRAM_BUFFERED</span><span class="p">);</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">nvram_pagesize</span> <span class="o">=</span> <span class="n">ATMEL_AT24C512_CHIP_SIZE</span><span class="p">;</span>

		<span class="n">nvcfg1</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">NVRAM_CFG1_COMPAT_BYPASS</span><span class="p">;</span>
		<span class="n">tw32</span><span class="p">(</span><span class="n">NVRAM_CFG1</span><span class="p">,</span> <span class="n">nvcfg1</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FLASH_5752VENDOR_ATMEL_FLASH_BUFFERED</span>:
	<span class="k">case</span> <span class="n">FLASH_57780VENDOR_ATMEL_AT45DB011D</span>:
	<span class="k">case</span> <span class="n">FLASH_57780VENDOR_ATMEL_AT45DB011B</span>:
	<span class="k">case</span> <span class="n">FLASH_57780VENDOR_ATMEL_AT45DB021D</span>:
	<span class="k">case</span> <span class="n">FLASH_57780VENDOR_ATMEL_AT45DB021B</span>:
	<span class="k">case</span> <span class="n">FLASH_57780VENDOR_ATMEL_AT45DB041D</span>:
	<span class="k">case</span> <span class="n">FLASH_57780VENDOR_ATMEL_AT45DB041B</span>:
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">nvram_jedecnum</span> <span class="o">=</span> <span class="n">JEDEC_ATMEL</span><span class="p">;</span>
		<span class="n">tg3_flag_set</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">NVRAM_BUFFERED</span><span class="p">);</span>
		<span class="n">tg3_flag_set</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">FLASH</span><span class="p">);</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">nvcfg1</span> <span class="o">&amp;</span> <span class="n">NVRAM_CFG1_5752VENDOR_MASK</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">FLASH_5752VENDOR_ATMEL_FLASH_BUFFERED</span>:
		<span class="k">case</span> <span class="n">FLASH_57780VENDOR_ATMEL_AT45DB011D</span>:
		<span class="k">case</span> <span class="n">FLASH_57780VENDOR_ATMEL_AT45DB011B</span>:
			<span class="n">tp</span><span class="o">-&gt;</span><span class="n">nvram_size</span> <span class="o">=</span> <span class="n">TG3_NVRAM_SIZE_128KB</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">FLASH_57780VENDOR_ATMEL_AT45DB021D</span>:
		<span class="k">case</span> <span class="n">FLASH_57780VENDOR_ATMEL_AT45DB021B</span>:
			<span class="n">tp</span><span class="o">-&gt;</span><span class="n">nvram_size</span> <span class="o">=</span> <span class="n">TG3_NVRAM_SIZE_256KB</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">FLASH_57780VENDOR_ATMEL_AT45DB041D</span>:
		<span class="k">case</span> <span class="n">FLASH_57780VENDOR_ATMEL_AT45DB041B</span>:
			<span class="n">tp</span><span class="o">-&gt;</span><span class="n">nvram_size</span> <span class="o">=</span> <span class="n">TG3_NVRAM_SIZE_512KB</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FLASH_5752VENDOR_ST_M45PE10</span>:
	<span class="k">case</span> <span class="n">FLASH_5752VENDOR_ST_M45PE20</span>:
	<span class="k">case</span> <span class="n">FLASH_5752VENDOR_ST_M45PE40</span>:
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">nvram_jedecnum</span> <span class="o">=</span> <span class="n">JEDEC_ST</span><span class="p">;</span>
		<span class="n">tg3_flag_set</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">NVRAM_BUFFERED</span><span class="p">);</span>
		<span class="n">tg3_flag_set</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">FLASH</span><span class="p">);</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">nvcfg1</span> <span class="o">&amp;</span> <span class="n">NVRAM_CFG1_5752VENDOR_MASK</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">FLASH_5752VENDOR_ST_M45PE10</span>:
			<span class="n">tp</span><span class="o">-&gt;</span><span class="n">nvram_size</span> <span class="o">=</span> <span class="n">TG3_NVRAM_SIZE_128KB</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">FLASH_5752VENDOR_ST_M45PE20</span>:
			<span class="n">tp</span><span class="o">-&gt;</span><span class="n">nvram_size</span> <span class="o">=</span> <span class="n">TG3_NVRAM_SIZE_256KB</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">FLASH_5752VENDOR_ST_M45PE40</span>:
			<span class="n">tp</span><span class="o">-&gt;</span><span class="n">nvram_size</span> <span class="o">=</span> <span class="n">TG3_NVRAM_SIZE_512KB</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">tg3_flag_set</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">NO_NVRAM</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">tg3_nvram_get_pagesize</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">nvcfg1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">nvram_pagesize</span> <span class="o">!=</span> <span class="mi">264</span> <span class="o">&amp;&amp;</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">nvram_pagesize</span> <span class="o">!=</span> <span class="mi">528</span><span class="p">)</span>
		<span class="n">tg3_flag_set</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">NO_NVRAM_ADDR_TRANS</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span> <span class="nf">tg3_get_5717_nvram_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">nvcfg1</span><span class="p">;</span>

	<span class="n">nvcfg1</span> <span class="o">=</span> <span class="n">tr32</span><span class="p">(</span><span class="n">NVRAM_CFG1</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">nvcfg1</span> <span class="o">&amp;</span> <span class="n">NVRAM_CFG1_5752VENDOR_MASK</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">FLASH_5717VENDOR_ATMEL_EEPROM</span>:
	<span class="k">case</span> <span class="n">FLASH_5717VENDOR_MICRO_EEPROM</span>:
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">nvram_jedecnum</span> <span class="o">=</span> <span class="n">JEDEC_ATMEL</span><span class="p">;</span>
		<span class="n">tg3_flag_set</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">NVRAM_BUFFERED</span><span class="p">);</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">nvram_pagesize</span> <span class="o">=</span> <span class="n">ATMEL_AT24C512_CHIP_SIZE</span><span class="p">;</span>

		<span class="n">nvcfg1</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">NVRAM_CFG1_COMPAT_BYPASS</span><span class="p">;</span>
		<span class="n">tw32</span><span class="p">(</span><span class="n">NVRAM_CFG1</span><span class="p">,</span> <span class="n">nvcfg1</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FLASH_5717VENDOR_ATMEL_MDB011D</span>:
	<span class="k">case</span> <span class="n">FLASH_5717VENDOR_ATMEL_ADB011B</span>:
	<span class="k">case</span> <span class="n">FLASH_5717VENDOR_ATMEL_ADB011D</span>:
	<span class="k">case</span> <span class="n">FLASH_5717VENDOR_ATMEL_MDB021D</span>:
	<span class="k">case</span> <span class="n">FLASH_5717VENDOR_ATMEL_ADB021B</span>:
	<span class="k">case</span> <span class="n">FLASH_5717VENDOR_ATMEL_ADB021D</span>:
	<span class="k">case</span> <span class="n">FLASH_5717VENDOR_ATMEL_45USPT</span>:
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">nvram_jedecnum</span> <span class="o">=</span> <span class="n">JEDEC_ATMEL</span><span class="p">;</span>
		<span class="n">tg3_flag_set</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">NVRAM_BUFFERED</span><span class="p">);</span>
		<span class="n">tg3_flag_set</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">FLASH</span><span class="p">);</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">nvcfg1</span> <span class="o">&amp;</span> <span class="n">NVRAM_CFG1_5752VENDOR_MASK</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">FLASH_5717VENDOR_ATMEL_MDB021D</span>:
			<span class="cm">/* Detect size with tg3_nvram_get_size() */</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">FLASH_5717VENDOR_ATMEL_ADB021B</span>:
		<span class="k">case</span> <span class="n">FLASH_5717VENDOR_ATMEL_ADB021D</span>:
			<span class="n">tp</span><span class="o">-&gt;</span><span class="n">nvram_size</span> <span class="o">=</span> <span class="n">TG3_NVRAM_SIZE_256KB</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">tp</span><span class="o">-&gt;</span><span class="n">nvram_size</span> <span class="o">=</span> <span class="n">TG3_NVRAM_SIZE_128KB</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FLASH_5717VENDOR_ST_M_M25PE10</span>:
	<span class="k">case</span> <span class="n">FLASH_5717VENDOR_ST_A_M25PE10</span>:
	<span class="k">case</span> <span class="n">FLASH_5717VENDOR_ST_M_M45PE10</span>:
	<span class="k">case</span> <span class="n">FLASH_5717VENDOR_ST_A_M45PE10</span>:
	<span class="k">case</span> <span class="n">FLASH_5717VENDOR_ST_M_M25PE20</span>:
	<span class="k">case</span> <span class="n">FLASH_5717VENDOR_ST_A_M25PE20</span>:
	<span class="k">case</span> <span class="n">FLASH_5717VENDOR_ST_M_M45PE20</span>:
	<span class="k">case</span> <span class="n">FLASH_5717VENDOR_ST_A_M45PE20</span>:
	<span class="k">case</span> <span class="n">FLASH_5717VENDOR_ST_25USPT</span>:
	<span class="k">case</span> <span class="n">FLASH_5717VENDOR_ST_45USPT</span>:
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">nvram_jedecnum</span> <span class="o">=</span> <span class="n">JEDEC_ST</span><span class="p">;</span>
		<span class="n">tg3_flag_set</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">NVRAM_BUFFERED</span><span class="p">);</span>
		<span class="n">tg3_flag_set</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">FLASH</span><span class="p">);</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">nvcfg1</span> <span class="o">&amp;</span> <span class="n">NVRAM_CFG1_5752VENDOR_MASK</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">FLASH_5717VENDOR_ST_M_M25PE20</span>:
		<span class="k">case</span> <span class="n">FLASH_5717VENDOR_ST_M_M45PE20</span>:
			<span class="cm">/* Detect size with tg3_nvram_get_size() */</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">FLASH_5717VENDOR_ST_A_M25PE20</span>:
		<span class="k">case</span> <span class="n">FLASH_5717VENDOR_ST_A_M45PE20</span>:
			<span class="n">tp</span><span class="o">-&gt;</span><span class="n">nvram_size</span> <span class="o">=</span> <span class="n">TG3_NVRAM_SIZE_256KB</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">tp</span><span class="o">-&gt;</span><span class="n">nvram_size</span> <span class="o">=</span> <span class="n">TG3_NVRAM_SIZE_128KB</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">tg3_flag_set</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">NO_NVRAM</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">tg3_nvram_get_pagesize</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">nvcfg1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">nvram_pagesize</span> <span class="o">!=</span> <span class="mi">264</span> <span class="o">&amp;&amp;</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">nvram_pagesize</span> <span class="o">!=</span> <span class="mi">528</span><span class="p">)</span>
		<span class="n">tg3_flag_set</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">NO_NVRAM_ADDR_TRANS</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span> <span class="nf">tg3_get_5720_nvram_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">nvcfg1</span><span class="p">,</span> <span class="n">nvmpinstrp</span><span class="p">;</span>

	<span class="n">nvcfg1</span> <span class="o">=</span> <span class="n">tr32</span><span class="p">(</span><span class="n">NVRAM_CFG1</span><span class="p">);</span>
	<span class="n">nvmpinstrp</span> <span class="o">=</span> <span class="n">nvcfg1</span> <span class="o">&amp;</span> <span class="n">NVRAM_CFG1_5752VENDOR_MASK</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">nvmpinstrp</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">FLASH_5720_EEPROM_HD</span>:
	<span class="k">case</span> <span class="n">FLASH_5720_EEPROM_LD</span>:
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">nvram_jedecnum</span> <span class="o">=</span> <span class="n">JEDEC_ATMEL</span><span class="p">;</span>
		<span class="n">tg3_flag_set</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">NVRAM_BUFFERED</span><span class="p">);</span>

		<span class="n">nvcfg1</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">NVRAM_CFG1_COMPAT_BYPASS</span><span class="p">;</span>
		<span class="n">tw32</span><span class="p">(</span><span class="n">NVRAM_CFG1</span><span class="p">,</span> <span class="n">nvcfg1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">nvmpinstrp</span> <span class="o">==</span> <span class="n">FLASH_5720_EEPROM_HD</span><span class="p">)</span>
			<span class="n">tp</span><span class="o">-&gt;</span><span class="n">nvram_pagesize</span> <span class="o">=</span> <span class="n">ATMEL_AT24C512_CHIP_SIZE</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">tp</span><span class="o">-&gt;</span><span class="n">nvram_pagesize</span> <span class="o">=</span> <span class="n">ATMEL_AT24C02_CHIP_SIZE</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FLASH_5720VENDOR_M_ATMEL_DB011D</span>:
	<span class="k">case</span> <span class="n">FLASH_5720VENDOR_A_ATMEL_DB011B</span>:
	<span class="k">case</span> <span class="n">FLASH_5720VENDOR_A_ATMEL_DB011D</span>:
	<span class="k">case</span> <span class="n">FLASH_5720VENDOR_M_ATMEL_DB021D</span>:
	<span class="k">case</span> <span class="n">FLASH_5720VENDOR_A_ATMEL_DB021B</span>:
	<span class="k">case</span> <span class="n">FLASH_5720VENDOR_A_ATMEL_DB021D</span>:
	<span class="k">case</span> <span class="n">FLASH_5720VENDOR_M_ATMEL_DB041D</span>:
	<span class="k">case</span> <span class="n">FLASH_5720VENDOR_A_ATMEL_DB041B</span>:
	<span class="k">case</span> <span class="n">FLASH_5720VENDOR_A_ATMEL_DB041D</span>:
	<span class="k">case</span> <span class="n">FLASH_5720VENDOR_M_ATMEL_DB081D</span>:
	<span class="k">case</span> <span class="n">FLASH_5720VENDOR_A_ATMEL_DB081D</span>:
	<span class="k">case</span> <span class="n">FLASH_5720VENDOR_ATMEL_45USPT</span>:
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">nvram_jedecnum</span> <span class="o">=</span> <span class="n">JEDEC_ATMEL</span><span class="p">;</span>
		<span class="n">tg3_flag_set</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">NVRAM_BUFFERED</span><span class="p">);</span>
		<span class="n">tg3_flag_set</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">FLASH</span><span class="p">);</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">nvmpinstrp</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">FLASH_5720VENDOR_M_ATMEL_DB021D</span>:
		<span class="k">case</span> <span class="n">FLASH_5720VENDOR_A_ATMEL_DB021B</span>:
		<span class="k">case</span> <span class="n">FLASH_5720VENDOR_A_ATMEL_DB021D</span>:
			<span class="n">tp</span><span class="o">-&gt;</span><span class="n">nvram_size</span> <span class="o">=</span> <span class="n">TG3_NVRAM_SIZE_256KB</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">FLASH_5720VENDOR_M_ATMEL_DB041D</span>:
		<span class="k">case</span> <span class="n">FLASH_5720VENDOR_A_ATMEL_DB041B</span>:
		<span class="k">case</span> <span class="n">FLASH_5720VENDOR_A_ATMEL_DB041D</span>:
			<span class="n">tp</span><span class="o">-&gt;</span><span class="n">nvram_size</span> <span class="o">=</span> <span class="n">TG3_NVRAM_SIZE_512KB</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">FLASH_5720VENDOR_M_ATMEL_DB081D</span>:
		<span class="k">case</span> <span class="n">FLASH_5720VENDOR_A_ATMEL_DB081D</span>:
			<span class="n">tp</span><span class="o">-&gt;</span><span class="n">nvram_size</span> <span class="o">=</span> <span class="n">TG3_NVRAM_SIZE_1MB</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">tp</span><span class="o">-&gt;</span><span class="n">nvram_size</span> <span class="o">=</span> <span class="n">TG3_NVRAM_SIZE_128KB</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FLASH_5720VENDOR_M_ST_M25PE10</span>:
	<span class="k">case</span> <span class="n">FLASH_5720VENDOR_M_ST_M45PE10</span>:
	<span class="k">case</span> <span class="n">FLASH_5720VENDOR_A_ST_M25PE10</span>:
	<span class="k">case</span> <span class="n">FLASH_5720VENDOR_A_ST_M45PE10</span>:
	<span class="k">case</span> <span class="n">FLASH_5720VENDOR_M_ST_M25PE20</span>:
	<span class="k">case</span> <span class="n">FLASH_5720VENDOR_M_ST_M45PE20</span>:
	<span class="k">case</span> <span class="n">FLASH_5720VENDOR_A_ST_M25PE20</span>:
	<span class="k">case</span> <span class="n">FLASH_5720VENDOR_A_ST_M45PE20</span>:
	<span class="k">case</span> <span class="n">FLASH_5720VENDOR_M_ST_M25PE40</span>:
	<span class="k">case</span> <span class="n">FLASH_5720VENDOR_M_ST_M45PE40</span>:
	<span class="k">case</span> <span class="n">FLASH_5720VENDOR_A_ST_M25PE40</span>:
	<span class="k">case</span> <span class="n">FLASH_5720VENDOR_A_ST_M45PE40</span>:
	<span class="k">case</span> <span class="n">FLASH_5720VENDOR_M_ST_M25PE80</span>:
	<span class="k">case</span> <span class="n">FLASH_5720VENDOR_M_ST_M45PE80</span>:
	<span class="k">case</span> <span class="n">FLASH_5720VENDOR_A_ST_M25PE80</span>:
	<span class="k">case</span> <span class="n">FLASH_5720VENDOR_A_ST_M45PE80</span>:
	<span class="k">case</span> <span class="n">FLASH_5720VENDOR_ST_25USPT</span>:
	<span class="k">case</span> <span class="n">FLASH_5720VENDOR_ST_45USPT</span>:
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">nvram_jedecnum</span> <span class="o">=</span> <span class="n">JEDEC_ST</span><span class="p">;</span>
		<span class="n">tg3_flag_set</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">NVRAM_BUFFERED</span><span class="p">);</span>
		<span class="n">tg3_flag_set</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">FLASH</span><span class="p">);</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">nvmpinstrp</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">FLASH_5720VENDOR_M_ST_M25PE20</span>:
		<span class="k">case</span> <span class="n">FLASH_5720VENDOR_M_ST_M45PE20</span>:
		<span class="k">case</span> <span class="n">FLASH_5720VENDOR_A_ST_M25PE20</span>:
		<span class="k">case</span> <span class="n">FLASH_5720VENDOR_A_ST_M45PE20</span>:
			<span class="n">tp</span><span class="o">-&gt;</span><span class="n">nvram_size</span> <span class="o">=</span> <span class="n">TG3_NVRAM_SIZE_256KB</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">FLASH_5720VENDOR_M_ST_M25PE40</span>:
		<span class="k">case</span> <span class="n">FLASH_5720VENDOR_M_ST_M45PE40</span>:
		<span class="k">case</span> <span class="n">FLASH_5720VENDOR_A_ST_M25PE40</span>:
		<span class="k">case</span> <span class="n">FLASH_5720VENDOR_A_ST_M45PE40</span>:
			<span class="n">tp</span><span class="o">-&gt;</span><span class="n">nvram_size</span> <span class="o">=</span> <span class="n">TG3_NVRAM_SIZE_512KB</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">FLASH_5720VENDOR_M_ST_M25PE80</span>:
		<span class="k">case</span> <span class="n">FLASH_5720VENDOR_M_ST_M45PE80</span>:
		<span class="k">case</span> <span class="n">FLASH_5720VENDOR_A_ST_M25PE80</span>:
		<span class="k">case</span> <span class="n">FLASH_5720VENDOR_A_ST_M45PE80</span>:
			<span class="n">tp</span><span class="o">-&gt;</span><span class="n">nvram_size</span> <span class="o">=</span> <span class="n">TG3_NVRAM_SIZE_1MB</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">tp</span><span class="o">-&gt;</span><span class="n">nvram_size</span> <span class="o">=</span> <span class="n">TG3_NVRAM_SIZE_128KB</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">tg3_flag_set</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">NO_NVRAM</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">tg3_nvram_get_pagesize</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">nvcfg1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">nvram_pagesize</span> <span class="o">!=</span> <span class="mi">264</span> <span class="o">&amp;&amp;</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">nvram_pagesize</span> <span class="o">!=</span> <span class="mi">528</span><span class="p">)</span>
		<span class="n">tg3_flag_set</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">NO_NVRAM_ADDR_TRANS</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Chips other than 5700/5701 use the NVRAM for fetching info. */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span> <span class="nf">tg3_nvram_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">tw32_f</span><span class="p">(</span><span class="n">GRC_EEPROM_ADDR</span><span class="p">,</span>
	     <span class="p">(</span><span class="n">EEPROM_ADDR_FSM_RESET</span> <span class="o">|</span>
	      <span class="p">(</span><span class="n">EEPROM_DEFAULT_CLOCK_PERIOD</span> <span class="o">&lt;&lt;</span>
	       <span class="n">EEPROM_ADDR_CLKPERD_SHIFT</span><span class="p">)));</span>

	<span class="n">msleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* Enable seeprom accesses. */</span>
	<span class="n">tw32_f</span><span class="p">(</span><span class="n">GRC_LOCAL_CTRL</span><span class="p">,</span>
	     <span class="n">tr32</span><span class="p">(</span><span class="n">GRC_LOCAL_CTRL</span><span class="p">)</span> <span class="o">|</span> <span class="n">GRC_LCLCTRL_AUTO_SEEPROM</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">!=</span> <span class="n">ASIC_REV_5700</span> <span class="o">&amp;&amp;</span>
	    <span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">!=</span> <span class="n">ASIC_REV_5701</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tg3_flag_set</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">NVRAM</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">tg3_nvram_lock</span><span class="p">(</span><span class="n">tp</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">netdev_warn</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				    <span class="s">&quot;Cannot get nvram lock, %s failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				    <span class="n">__func__</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">tg3_enable_nvram_access</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>

		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">nvram_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">ASIC_REV_5752</span><span class="p">)</span>
			<span class="n">tg3_get_5752_nvram_info</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">ASIC_REV_5755</span><span class="p">)</span>
			<span class="n">tg3_get_5755_nvram_info</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">ASIC_REV_5787</span> <span class="o">||</span>
			 <span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">ASIC_REV_5784</span> <span class="o">||</span>
			 <span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">ASIC_REV_5785</span><span class="p">)</span>
			<span class="n">tg3_get_5787_nvram_info</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">ASIC_REV_5761</span><span class="p">)</span>
			<span class="n">tg3_get_5761_nvram_info</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">ASIC_REV_5906</span><span class="p">)</span>
			<span class="n">tg3_get_5906_nvram_info</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">ASIC_REV_57780</span> <span class="o">||</span>
			 <span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">57765</span><span class="n">_CLASS</span><span class="p">))</span>
			<span class="n">tg3_get_57780_nvram_info</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">ASIC_REV_5717</span> <span class="o">||</span>
			 <span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">ASIC_REV_5719</span><span class="p">)</span>
			<span class="n">tg3_get_5717_nvram_info</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">ASIC_REV_5720</span><span class="p">)</span>
			<span class="n">tg3_get_5720_nvram_info</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">tg3_get_nvram_info</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">nvram_size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">tg3_get_nvram_size</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>

		<span class="n">tg3_disable_nvram_access</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
		<span class="n">tg3_nvram_unlock</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>

	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">tg3_flag_clear</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">NVRAM</span><span class="p">);</span>
		<span class="n">tg3_flag_clear</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">NVRAM_BUFFERED</span><span class="p">);</span>

		<span class="n">tg3_get_eeprom_size</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">subsys_tbl_ent</span> <span class="p">{</span>
	<span class="n">u16</span> <span class="n">subsys_vendor</span><span class="p">,</span> <span class="n">subsys_devid</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">phy_id</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">subsys_tbl_ent</span> <span class="n">subsys_id_to_phy_id</span><span class="p">[]</span> <span class="n">__devinitdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/* Broadcom boards. */</span>
	<span class="p">{</span> <span class="n">TG3PCI_SUBVENDOR_ID_BROADCOM</span><span class="p">,</span>
	  <span class="n">TG3PCI_SUBDEVICE_ID_BROADCOM_95700A6</span><span class="p">,</span> <span class="n">TG3_PHY_ID_BCM5401</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TG3PCI_SUBVENDOR_ID_BROADCOM</span><span class="p">,</span>
	  <span class="n">TG3PCI_SUBDEVICE_ID_BROADCOM_95701A5</span><span class="p">,</span> <span class="n">TG3_PHY_ID_BCM5701</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TG3PCI_SUBVENDOR_ID_BROADCOM</span><span class="p">,</span>
	  <span class="n">TG3PCI_SUBDEVICE_ID_BROADCOM_95700T6</span><span class="p">,</span> <span class="n">TG3_PHY_ID_BCM8002</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TG3PCI_SUBVENDOR_ID_BROADCOM</span><span class="p">,</span>
	  <span class="n">TG3PCI_SUBDEVICE_ID_BROADCOM_95700A9</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TG3PCI_SUBVENDOR_ID_BROADCOM</span><span class="p">,</span>
	  <span class="n">TG3PCI_SUBDEVICE_ID_BROADCOM_95701T1</span><span class="p">,</span> <span class="n">TG3_PHY_ID_BCM5701</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TG3PCI_SUBVENDOR_ID_BROADCOM</span><span class="p">,</span>
	  <span class="n">TG3PCI_SUBDEVICE_ID_BROADCOM_95701T8</span><span class="p">,</span> <span class="n">TG3_PHY_ID_BCM5701</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TG3PCI_SUBVENDOR_ID_BROADCOM</span><span class="p">,</span>
	  <span class="n">TG3PCI_SUBDEVICE_ID_BROADCOM_95701A7</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TG3PCI_SUBVENDOR_ID_BROADCOM</span><span class="p">,</span>
	  <span class="n">TG3PCI_SUBDEVICE_ID_BROADCOM_95701A10</span><span class="p">,</span> <span class="n">TG3_PHY_ID_BCM5701</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TG3PCI_SUBVENDOR_ID_BROADCOM</span><span class="p">,</span>
	  <span class="n">TG3PCI_SUBDEVICE_ID_BROADCOM_95701A12</span><span class="p">,</span> <span class="n">TG3_PHY_ID_BCM5701</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TG3PCI_SUBVENDOR_ID_BROADCOM</span><span class="p">,</span>
	  <span class="n">TG3PCI_SUBDEVICE_ID_BROADCOM_95703AX1</span><span class="p">,</span> <span class="n">TG3_PHY_ID_BCM5703</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TG3PCI_SUBVENDOR_ID_BROADCOM</span><span class="p">,</span>
	  <span class="n">TG3PCI_SUBDEVICE_ID_BROADCOM_95703AX2</span><span class="p">,</span> <span class="n">TG3_PHY_ID_BCM5703</span> <span class="p">},</span>

	<span class="cm">/* 3com boards. */</span>
	<span class="p">{</span> <span class="n">TG3PCI_SUBVENDOR_ID_3COM</span><span class="p">,</span>
	  <span class="n">TG3PCI_SUBDEVICE_ID_3COM_3C996T</span><span class="p">,</span> <span class="n">TG3_PHY_ID_BCM5401</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TG3PCI_SUBVENDOR_ID_3COM</span><span class="p">,</span>
	  <span class="n">TG3PCI_SUBDEVICE_ID_3COM_3C996BT</span><span class="p">,</span> <span class="n">TG3_PHY_ID_BCM5701</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TG3PCI_SUBVENDOR_ID_3COM</span><span class="p">,</span>
	  <span class="n">TG3PCI_SUBDEVICE_ID_3COM_3C996SX</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TG3PCI_SUBVENDOR_ID_3COM</span><span class="p">,</span>
	  <span class="n">TG3PCI_SUBDEVICE_ID_3COM_3C1000T</span><span class="p">,</span> <span class="n">TG3_PHY_ID_BCM5701</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TG3PCI_SUBVENDOR_ID_3COM</span><span class="p">,</span>
	  <span class="n">TG3PCI_SUBDEVICE_ID_3COM_3C940BR01</span><span class="p">,</span> <span class="n">TG3_PHY_ID_BCM5701</span> <span class="p">},</span>

	<span class="cm">/* DELL boards. */</span>
	<span class="p">{</span> <span class="n">TG3PCI_SUBVENDOR_ID_DELL</span><span class="p">,</span>
	  <span class="n">TG3PCI_SUBDEVICE_ID_DELL_VIPER</span><span class="p">,</span> <span class="n">TG3_PHY_ID_BCM5401</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TG3PCI_SUBVENDOR_ID_DELL</span><span class="p">,</span>
	  <span class="n">TG3PCI_SUBDEVICE_ID_DELL_JAGUAR</span><span class="p">,</span> <span class="n">TG3_PHY_ID_BCM5401</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TG3PCI_SUBVENDOR_ID_DELL</span><span class="p">,</span>
	  <span class="n">TG3PCI_SUBDEVICE_ID_DELL_MERLOT</span><span class="p">,</span> <span class="n">TG3_PHY_ID_BCM5411</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TG3PCI_SUBVENDOR_ID_DELL</span><span class="p">,</span>
	  <span class="n">TG3PCI_SUBDEVICE_ID_DELL_SLIM_MERLOT</span><span class="p">,</span> <span class="n">TG3_PHY_ID_BCM5411</span> <span class="p">},</span>

	<span class="cm">/* Compaq boards. */</span>
	<span class="p">{</span> <span class="n">TG3PCI_SUBVENDOR_ID_COMPAQ</span><span class="p">,</span>
	  <span class="n">TG3PCI_SUBDEVICE_ID_COMPAQ_BANSHEE</span><span class="p">,</span> <span class="n">TG3_PHY_ID_BCM5701</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TG3PCI_SUBVENDOR_ID_COMPAQ</span><span class="p">,</span>
	  <span class="n">TG3PCI_SUBDEVICE_ID_COMPAQ_BANSHEE_2</span><span class="p">,</span> <span class="n">TG3_PHY_ID_BCM5701</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TG3PCI_SUBVENDOR_ID_COMPAQ</span><span class="p">,</span>
	  <span class="n">TG3PCI_SUBDEVICE_ID_COMPAQ_CHANGELING</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TG3PCI_SUBVENDOR_ID_COMPAQ</span><span class="p">,</span>
	  <span class="n">TG3PCI_SUBDEVICE_ID_COMPAQ_NC7780</span><span class="p">,</span> <span class="n">TG3_PHY_ID_BCM5701</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">TG3PCI_SUBVENDOR_ID_COMPAQ</span><span class="p">,</span>
	  <span class="n">TG3PCI_SUBDEVICE_ID_COMPAQ_NC7780_2</span><span class="p">,</span> <span class="n">TG3_PHY_ID_BCM5701</span> <span class="p">},</span>

	<span class="cm">/* IBM boards. */</span>
	<span class="p">{</span> <span class="n">TG3PCI_SUBVENDOR_ID_IBM</span><span class="p">,</span>
	  <span class="n">TG3PCI_SUBDEVICE_ID_IBM_5703SAX2</span><span class="p">,</span> <span class="mi">0</span> <span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">subsys_tbl_ent</span> <span class="o">*</span> <span class="n">__devinit</span> <span class="nf">tg3_lookup_by_subsys</span><span class="p">(</span><span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">subsys_id_to_phy_id</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">subsys_id_to_phy_id</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">subsys_vendor</span> <span class="o">==</span>
		     <span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">subsystem_vendor</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">subsys_id_to_phy_id</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">subsys_devid</span> <span class="o">==</span>
		     <span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">subsystem_device</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">&amp;</span><span class="n">subsys_id_to_phy_id</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span> <span class="nf">tg3_get_eeprom_hw_cfg</span><span class="p">(</span><span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">phy_id</span> <span class="o">=</span> <span class="n">TG3_PHY_ID_INVALID</span><span class="p">;</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">led_ctrl</span> <span class="o">=</span> <span class="n">LED_CTRL_MODE_PHY_1</span><span class="p">;</span>

	<span class="cm">/* Assume an onboard device and WOL capable by default.  */</span>
	<span class="n">tg3_flag_set</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">EEPROM_WRITE_PROT</span><span class="p">);</span>
	<span class="n">tg3_flag_set</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">WOL_CAP</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">ASIC_REV_5906</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">tr32</span><span class="p">(</span><span class="n">PCIE_TRANSACTION_CFG</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">PCIE_TRANS_CFG_LOM</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">tg3_flag_clear</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">EEPROM_WRITE_PROT</span><span class="p">);</span>
			<span class="n">tg3_flag_set</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">IS_NIC</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">tr32</span><span class="p">(</span><span class="n">VCPU_CFGSHDW</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">VCPU_CFGSHDW_ASPM_DBNC</span><span class="p">)</span>
			<span class="n">tg3_flag_set</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">ASPM_WORKAROUND</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">VCPU_CFGSHDW_WOL_ENABLE</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">VCPU_CFGSHDW_WOL_MAGPKT</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">tg3_flag_set</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">WOL_ENABLE</span><span class="p">);</span>
			<span class="n">device_set_wakeup_enable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">tg3_read_mem</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">NIC_SRAM_DATA_SIG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">==</span> <span class="n">NIC_SRAM_DATA_SIG_MAGIC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">nic_cfg</span><span class="p">,</span> <span class="n">led_cfg</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">nic_phy_id</span><span class="p">,</span> <span class="n">ver</span><span class="p">,</span> <span class="n">cfg2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">cfg4</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">eeprom_phy_id</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">eeprom_phy_serdes</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">tg3_read_mem</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">NIC_SRAM_DATA_CFG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nic_cfg</span><span class="p">);</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">nic_sram_data_cfg</span> <span class="o">=</span> <span class="n">nic_cfg</span><span class="p">;</span>

		<span class="n">tg3_read_mem</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">NIC_SRAM_DATA_VER</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ver</span><span class="p">);</span>
		<span class="n">ver</span> <span class="o">&gt;&gt;=</span> <span class="n">NIC_SRAM_DATA_VER_SHIFT</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">!=</span> <span class="n">ASIC_REV_5700</span> <span class="o">&amp;&amp;</span>
		    <span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">!=</span> <span class="n">ASIC_REV_5701</span> <span class="o">&amp;&amp;</span>
		    <span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">!=</span> <span class="n">ASIC_REV_5703</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">ver</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ver</span> <span class="o">&lt;</span> <span class="mh">0x100</span><span class="p">))</span>
			<span class="n">tg3_read_mem</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">NIC_SRAM_DATA_CFG_2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cfg2</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">ASIC_REV_5785</span><span class="p">)</span>
			<span class="n">tg3_read_mem</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">NIC_SRAM_DATA_CFG_4</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cfg4</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">nic_cfg</span> <span class="o">&amp;</span> <span class="n">NIC_SRAM_DATA_CFG_PHY_TYPE_MASK</span><span class="p">)</span> <span class="o">==</span>
		    <span class="n">NIC_SRAM_DATA_CFG_PHY_TYPE_FIBER</span><span class="p">)</span>
			<span class="n">eeprom_phy_serdes</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="n">tg3_read_mem</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">NIC_SRAM_DATA_PHY_ID</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nic_phy_id</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">nic_phy_id</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u32</span> <span class="n">id1</span> <span class="o">=</span> <span class="n">nic_phy_id</span> <span class="o">&amp;</span> <span class="n">NIC_SRAM_DATA_PHY_ID1_MASK</span><span class="p">;</span>
			<span class="n">u32</span> <span class="n">id2</span> <span class="o">=</span> <span class="n">nic_phy_id</span> <span class="o">&amp;</span> <span class="n">NIC_SRAM_DATA_PHY_ID2_MASK</span><span class="p">;</span>

			<span class="n">eeprom_phy_id</span>  <span class="o">=</span> <span class="p">(</span><span class="n">id1</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">;</span>
			<span class="n">eeprom_phy_id</span> <span class="o">|=</span> <span class="p">(</span><span class="n">id2</span> <span class="o">&amp;</span> <span class="mh">0xfc00</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
			<span class="n">eeprom_phy_id</span> <span class="o">|=</span> <span class="p">(</span><span class="n">id2</span> <span class="o">&amp;</span> <span class="mh">0x03ff</span><span class="p">)</span> <span class="o">&lt;&lt;</span>  <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">eeprom_phy_id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">phy_id</span> <span class="o">=</span> <span class="n">eeprom_phy_id</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">eeprom_phy_serdes</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">5705</span><span class="n">_PLUS</span><span class="p">))</span>
				<span class="n">tp</span><span class="o">-&gt;</span><span class="n">phy_flags</span> <span class="o">|=</span> <span class="n">TG3_PHYFLG_PHY_SERDES</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">tp</span><span class="o">-&gt;</span><span class="n">phy_flags</span> <span class="o">|=</span> <span class="n">TG3_PHYFLG_MII_SERDES</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">5750</span><span class="n">_PLUS</span><span class="p">))</span>
			<span class="n">led_cfg</span> <span class="o">=</span> <span class="n">cfg2</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">NIC_SRAM_DATA_CFG_LED_MODE_MASK</span> <span class="o">|</span>
				    <span class="n">SHASTA_EXT_LED_MODE_MASK</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">led_cfg</span> <span class="o">=</span> <span class="n">nic_cfg</span> <span class="o">&amp;</span> <span class="n">NIC_SRAM_DATA_CFG_LED_MODE_MASK</span><span class="p">;</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">led_cfg</span><span class="p">)</span> <span class="p">{</span>
		<span class="nl">default:</span>
		<span class="k">case</span> <span class="n">NIC_SRAM_DATA_CFG_LED_MODE_PHY_1</span>:
			<span class="n">tp</span><span class="o">-&gt;</span><span class="n">led_ctrl</span> <span class="o">=</span> <span class="n">LED_CTRL_MODE_PHY_1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">NIC_SRAM_DATA_CFG_LED_MODE_PHY_2</span>:
			<span class="n">tp</span><span class="o">-&gt;</span><span class="n">led_ctrl</span> <span class="o">=</span> <span class="n">LED_CTRL_MODE_PHY_2</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">NIC_SRAM_DATA_CFG_LED_MODE_MAC</span>:
			<span class="n">tp</span><span class="o">-&gt;</span><span class="n">led_ctrl</span> <span class="o">=</span> <span class="n">LED_CTRL_MODE_MAC</span><span class="p">;</span>

			<span class="cm">/* Default to PHY_1_MODE if 0 (MAC_MODE) is</span>
<span class="cm">			 * read on some older 5700/5701 bootcode.</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span>
			    <span class="n">ASIC_REV_5700</span> <span class="o">||</span>
			    <span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span>
			    <span class="n">ASIC_REV_5701</span><span class="p">)</span>
				<span class="n">tp</span><span class="o">-&gt;</span><span class="n">led_ctrl</span> <span class="o">=</span> <span class="n">LED_CTRL_MODE_PHY_1</span><span class="p">;</span>

			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">SHASTA_EXT_LED_SHARED</span>:
			<span class="n">tp</span><span class="o">-&gt;</span><span class="n">led_ctrl</span> <span class="o">=</span> <span class="n">LED_CTRL_MODE_SHARED</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span> <span class="o">!=</span> <span class="n">CHIPREV_ID_5750_A0</span> <span class="o">&amp;&amp;</span>
			    <span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span> <span class="o">!=</span> <span class="n">CHIPREV_ID_5750_A1</span><span class="p">)</span>
				<span class="n">tp</span><span class="o">-&gt;</span><span class="n">led_ctrl</span> <span class="o">|=</span> <span class="p">(</span><span class="n">LED_CTRL_MODE_PHY_1</span> <span class="o">|</span>
						 <span class="n">LED_CTRL_MODE_PHY_2</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">SHASTA_EXT_LED_MAC</span>:
			<span class="n">tp</span><span class="o">-&gt;</span><span class="n">led_ctrl</span> <span class="o">=</span> <span class="n">LED_CTRL_MODE_SHASTA_MAC</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">SHASTA_EXT_LED_COMBO</span>:
			<span class="n">tp</span><span class="o">-&gt;</span><span class="n">led_ctrl</span> <span class="o">=</span> <span class="n">LED_CTRL_MODE_COMBO</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span> <span class="o">!=</span> <span class="n">CHIPREV_ID_5750_A0</span><span class="p">)</span>
				<span class="n">tp</span><span class="o">-&gt;</span><span class="n">led_ctrl</span> <span class="o">|=</span> <span class="p">(</span><span class="n">LED_CTRL_MODE_PHY_1</span> <span class="o">|</span>
						 <span class="n">LED_CTRL_MODE_PHY_2</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="p">}</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">ASIC_REV_5700</span> <span class="o">||</span>
		     <span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">ASIC_REV_5701</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">subsystem_vendor</span> <span class="o">==</span> <span class="n">PCI_VENDOR_ID_DELL</span><span class="p">)</span>
			<span class="n">tp</span><span class="o">-&gt;</span><span class="n">led_ctrl</span> <span class="o">=</span> <span class="n">LED_CTRL_MODE_PHY_2</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">GET_CHIP_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">CHIPREV_5784_AX</span><span class="p">)</span>
			<span class="n">tp</span><span class="o">-&gt;</span><span class="n">led_ctrl</span> <span class="o">=</span> <span class="n">LED_CTRL_MODE_PHY_1</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">nic_cfg</span> <span class="o">&amp;</span> <span class="n">NIC_SRAM_DATA_CFG_EEPROM_WP</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">tg3_flag_set</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">EEPROM_WRITE_PROT</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">subsystem_vendor</span> <span class="o">==</span>
			     <span class="n">PCI_VENDOR_ID_ARIMA</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">subsystem_device</span> <span class="o">==</span> <span class="mh">0x205a</span> <span class="o">||</span>
			     <span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">subsystem_device</span> <span class="o">==</span> <span class="mh">0x2063</span><span class="p">))</span>
				<span class="n">tg3_flag_clear</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">EEPROM_WRITE_PROT</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">tg3_flag_clear</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">EEPROM_WRITE_PROT</span><span class="p">);</span>
			<span class="n">tg3_flag_set</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">IS_NIC</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">nic_cfg</span> <span class="o">&amp;</span> <span class="n">NIC_SRAM_DATA_CFG_ASF_ENABLE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">tg3_flag_set</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">ENABLE_ASF</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">5750</span><span class="n">_PLUS</span><span class="p">))</span>
				<span class="n">tg3_flag_set</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">ASF_NEW_HANDSHAKE</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">nic_cfg</span> <span class="o">&amp;</span> <span class="n">NIC_SRAM_DATA_CFG_APE_ENABLE</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">5750</span><span class="n">_PLUS</span><span class="p">))</span>
			<span class="n">tg3_flag_set</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">ENABLE_APE</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">phy_flags</span> <span class="o">&amp;</span> <span class="n">TG3_PHYFLG_ANY_SERDES</span> <span class="o">&amp;&amp;</span>
		    <span class="o">!</span><span class="p">(</span><span class="n">nic_cfg</span> <span class="o">&amp;</span> <span class="n">NIC_SRAM_DATA_CFG_FIBER_WOL</span><span class="p">))</span>
			<span class="n">tg3_flag_clear</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">WOL_CAP</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">WOL_CAP</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">nic_cfg</span> <span class="o">&amp;</span> <span class="n">NIC_SRAM_DATA_CFG_WOL_ENABLE</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">tg3_flag_set</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">WOL_ENABLE</span><span class="p">);</span>
			<span class="n">device_set_wakeup_enable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">cfg2</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">17</span><span class="p">))</span>
			<span class="n">tp</span><span class="o">-&gt;</span><span class="n">phy_flags</span> <span class="o">|=</span> <span class="n">TG3_PHYFLG_CAPACITIVE_COUPLING</span><span class="p">;</span>

		<span class="cm">/* serdes signal pre-emphasis in register 0x590 set by */</span>
		<span class="cm">/* bootcode if bit 18 is set */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cfg2</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">18</span><span class="p">))</span>
			<span class="n">tp</span><span class="o">-&gt;</span><span class="n">phy_flags</span> <span class="o">|=</span> <span class="n">TG3_PHYFLG_SERDES_PREEMPHASIS</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">57765</span><span class="n">_PLUS</span><span class="p">)</span> <span class="o">||</span>
		     <span class="p">(</span><span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">ASIC_REV_5784</span> <span class="o">&amp;&amp;</span>
		      <span class="n">GET_CHIP_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">!=</span> <span class="n">CHIPREV_5784_AX</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">cfg2</span> <span class="o">&amp;</span> <span class="n">NIC_SRAM_DATA_CFG_2_APD_EN</span><span class="p">))</span>
			<span class="n">tp</span><span class="o">-&gt;</span><span class="n">phy_flags</span> <span class="o">|=</span> <span class="n">TG3_PHYFLG_ENABLE_APD</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">PCI_EXPRESS</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">!=</span> <span class="n">ASIC_REV_5785</span> <span class="o">&amp;&amp;</span>
		    <span class="o">!</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">57765</span><span class="n">_PLUS</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">u32</span> <span class="n">cfg3</span><span class="p">;</span>

			<span class="n">tg3_read_mem</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">NIC_SRAM_DATA_CFG_3</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cfg3</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cfg3</span> <span class="o">&amp;</span> <span class="n">NIC_SRAM_ASPM_DEBOUNCE</span><span class="p">)</span>
				<span class="n">tg3_flag_set</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">ASPM_WORKAROUND</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">cfg4</span> <span class="o">&amp;</span> <span class="n">NIC_SRAM_RGMII_INBAND_DISABLE</span><span class="p">)</span>
			<span class="n">tg3_flag_set</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">RGMII_INBAND_DISABLE</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cfg4</span> <span class="o">&amp;</span> <span class="n">NIC_SRAM_RGMII_EXT_IBND_RX_EN</span><span class="p">)</span>
			<span class="n">tg3_flag_set</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">RGMII_EXT_IBND_RX_EN</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cfg4</span> <span class="o">&amp;</span> <span class="n">NIC_SRAM_RGMII_EXT_IBND_TX_EN</span><span class="p">)</span>
			<span class="n">tg3_flag_set</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">RGMII_EXT_IBND_TX_EN</span><span class="p">);</span>
	<span class="p">}</span>
<span class="nl">done:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">WOL_CAP</span><span class="p">))</span>
		<span class="n">device_set_wakeup_enable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					 <span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">WOL_ENABLE</span><span class="p">));</span>
	<span class="k">else</span>
		<span class="n">device_set_wakeup_capable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">tg3_issue_otp_command</span><span class="p">(</span><span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span><span class="p">,</span> <span class="n">u32</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">tw32</span><span class="p">(</span><span class="n">OTP_CTRL</span><span class="p">,</span> <span class="n">cmd</span> <span class="o">|</span> <span class="n">OTP_CTRL_OTP_CMD_START</span><span class="p">);</span>
	<span class="n">tw32</span><span class="p">(</span><span class="n">OTP_CTRL</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>

	<span class="cm">/* Wait for up to 1 ms for command to execute. */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">tr32</span><span class="p">(</span><span class="n">OTP_STATUS</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">OTP_STATUS_CMD_DONE</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">OTP_STATUS_CMD_DONE</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Read the gphy configuration from the OTP region of the chip.  The gphy</span>
<span class="cm"> * configuration is a 32-bit value that straddles the alignment boundary.</span>
<span class="cm"> * We do two 32-bit reads and then shift and merge the results.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">u32</span> <span class="n">__devinit</span> <span class="nf">tg3_read_otp_phycfg</span><span class="p">(</span><span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">bhalf_otp</span><span class="p">,</span> <span class="n">thalf_otp</span><span class="p">;</span>

	<span class="n">tw32</span><span class="p">(</span><span class="n">OTP_MODE</span><span class="p">,</span> <span class="n">OTP_MODE_OTP_THRU_GRC</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tg3_issue_otp_command</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">OTP_CTRL_OTP_CMD_INIT</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">tw32</span><span class="p">(</span><span class="n">OTP_ADDRESS</span><span class="p">,</span> <span class="n">OTP_ADDRESS_MAGIC1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tg3_issue_otp_command</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">OTP_CTRL_OTP_CMD_READ</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">thalf_otp</span> <span class="o">=</span> <span class="n">tr32</span><span class="p">(</span><span class="n">OTP_READ_DATA</span><span class="p">);</span>

	<span class="n">tw32</span><span class="p">(</span><span class="n">OTP_ADDRESS</span><span class="p">,</span> <span class="n">OTP_ADDRESS_MAGIC2</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tg3_issue_otp_command</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">OTP_CTRL_OTP_CMD_READ</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">bhalf_otp</span> <span class="o">=</span> <span class="n">tr32</span><span class="p">(</span><span class="n">OTP_READ_DATA</span><span class="p">);</span>

	<span class="k">return</span> <span class="p">((</span><span class="n">thalf_otp</span> <span class="o">&amp;</span> <span class="mh">0x0000ffff</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">bhalf_otp</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span> <span class="nf">tg3_phy_init_link_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">adv</span> <span class="o">=</span> <span class="n">ADVERTISED_Autoneg</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">phy_flags</span> <span class="o">&amp;</span> <span class="n">TG3_PHYFLG_10_100_ONLY</span><span class="p">))</span>
		<span class="n">adv</span> <span class="o">|=</span> <span class="n">ADVERTISED_1000baseT_Half</span> <span class="o">|</span>
		       <span class="n">ADVERTISED_1000baseT_Full</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">phy_flags</span> <span class="o">&amp;</span> <span class="n">TG3_PHYFLG_ANY_SERDES</span><span class="p">))</span>
		<span class="n">adv</span> <span class="o">|=</span> <span class="n">ADVERTISED_100baseT_Half</span> <span class="o">|</span>
		       <span class="n">ADVERTISED_100baseT_Full</span> <span class="o">|</span>
		       <span class="n">ADVERTISED_10baseT_Half</span> <span class="o">|</span>
		       <span class="n">ADVERTISED_10baseT_Full</span> <span class="o">|</span>
		       <span class="n">ADVERTISED_TP</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">adv</span> <span class="o">|=</span> <span class="n">ADVERTISED_FIBRE</span><span class="p">;</span>

	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">link_config</span><span class="p">.</span><span class="n">advertising</span> <span class="o">=</span> <span class="n">adv</span><span class="p">;</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">link_config</span><span class="p">.</span><span class="n">speed</span> <span class="o">=</span> <span class="n">SPEED_UNKNOWN</span><span class="p">;</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">link_config</span><span class="p">.</span><span class="n">duplex</span> <span class="o">=</span> <span class="n">DUPLEX_UNKNOWN</span><span class="p">;</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">link_config</span><span class="p">.</span><span class="n">autoneg</span> <span class="o">=</span> <span class="n">AUTONEG_ENABLE</span><span class="p">;</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">link_config</span><span class="p">.</span><span class="n">active_speed</span> <span class="o">=</span> <span class="n">SPEED_UNKNOWN</span><span class="p">;</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">link_config</span><span class="p">.</span><span class="n">active_duplex</span> <span class="o">=</span> <span class="n">DUPLEX_UNKNOWN</span><span class="p">;</span>

	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">old_link</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">tg3_phy_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">hw_phy_id_1</span><span class="p">,</span> <span class="n">hw_phy_id_2</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">hw_phy_id</span><span class="p">,</span> <span class="n">hw_phy_id_masked</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="cm">/* flow control autonegotiation is default behavior */</span>
	<span class="n">tg3_flag_set</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">PAUSE_AUTONEG</span><span class="p">);</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">link_config</span><span class="p">.</span><span class="n">flowctrl</span> <span class="o">=</span> <span class="n">FLOW_CTRL_TX</span> <span class="o">|</span> <span class="n">FLOW_CTRL_RX</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">USE_PHYLIB</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">tg3_phy_init</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>

	<span class="cm">/* Reading the PHY ID register can conflict with ASF</span>
<span class="cm">	 * firmware access to the PHY hardware.</span>
<span class="cm">	 */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">ENABLE_ASF</span><span class="p">)</span> <span class="o">||</span> <span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">ENABLE_APE</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">hw_phy_id</span> <span class="o">=</span> <span class="n">hw_phy_id_masked</span> <span class="o">=</span> <span class="n">TG3_PHY_ID_INVALID</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Now read the physical PHY_ID from the chip and verify</span>
<span class="cm">		 * that it is sane.  If it doesn&#39;t look good, we fall back</span>
<span class="cm">		 * to either the hard-coded table based PHY_ID and failing</span>
<span class="cm">		 * that the value found in the eeprom area.</span>
<span class="cm">		 */</span>
		<span class="n">err</span> <span class="o">|=</span> <span class="n">tg3_readphy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">MII_PHYSID1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hw_phy_id_1</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">|=</span> <span class="n">tg3_readphy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">MII_PHYSID2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hw_phy_id_2</span><span class="p">);</span>

		<span class="n">hw_phy_id</span>  <span class="o">=</span> <span class="p">(</span><span class="n">hw_phy_id_1</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">;</span>
		<span class="n">hw_phy_id</span> <span class="o">|=</span> <span class="p">(</span><span class="n">hw_phy_id_2</span> <span class="o">&amp;</span> <span class="mh">0xfc00</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
		<span class="n">hw_phy_id</span> <span class="o">|=</span> <span class="p">(</span><span class="n">hw_phy_id_2</span> <span class="o">&amp;</span> <span class="mh">0x03ff</span><span class="p">)</span> <span class="o">&lt;&lt;</span>  <span class="mi">0</span><span class="p">;</span>

		<span class="n">hw_phy_id_masked</span> <span class="o">=</span> <span class="n">hw_phy_id</span> <span class="o">&amp;</span> <span class="n">TG3_PHY_ID_MASK</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span> <span class="o">&amp;&amp;</span> <span class="n">TG3_KNOWN_PHY_ID</span><span class="p">(</span><span class="n">hw_phy_id_masked</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">phy_id</span> <span class="o">=</span> <span class="n">hw_phy_id</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hw_phy_id_masked</span> <span class="o">==</span> <span class="n">TG3_PHY_ID_BCM8002</span><span class="p">)</span>
			<span class="n">tp</span><span class="o">-&gt;</span><span class="n">phy_flags</span> <span class="o">|=</span> <span class="n">TG3_PHYFLG_PHY_SERDES</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">tp</span><span class="o">-&gt;</span><span class="n">phy_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">TG3_PHYFLG_PHY_SERDES</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">phy_id</span> <span class="o">!=</span> <span class="n">TG3_PHY_ID_INVALID</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Do nothing, phy ID already set up in</span>
<span class="cm">			 * tg3_get_eeprom_hw_cfg().</span>
<span class="cm">			 */</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">subsys_tbl_ent</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>

			<span class="cm">/* No eeprom signature?  Try the hardcoded</span>
<span class="cm">			 * subsys device table.</span>
<span class="cm">			 */</span>
			<span class="n">p</span> <span class="o">=</span> <span class="n">tg3_lookup_by_subsys</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">p</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

			<span class="n">tp</span><span class="o">-&gt;</span><span class="n">phy_id</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">phy_id</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">phy_id</span> <span class="o">||</span>
			    <span class="n">tp</span><span class="o">-&gt;</span><span class="n">phy_id</span> <span class="o">==</span> <span class="n">TG3_PHY_ID_BCM8002</span><span class="p">)</span>
				<span class="n">tp</span><span class="o">-&gt;</span><span class="n">phy_flags</span> <span class="o">|=</span> <span class="n">TG3_PHYFLG_PHY_SERDES</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">phy_flags</span> <span class="o">&amp;</span> <span class="n">TG3_PHYFLG_ANY_SERDES</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">ASIC_REV_5719</span> <span class="o">||</span>
	     <span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">ASIC_REV_5720</span> <span class="o">||</span>
	     <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="n">TG3PCI_DEVICE_TIGON3_5718</span> <span class="o">&amp;&amp;</span>
	      <span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span> <span class="o">!=</span> <span class="n">CHIPREV_ID_5717_A0</span><span class="p">)</span> <span class="o">||</span>
	     <span class="p">(</span><span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">ASIC_REV_57765</span> <span class="o">&amp;&amp;</span>
	      <span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span> <span class="o">!=</span> <span class="n">CHIPREV_ID_57765_A0</span><span class="p">)))</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">phy_flags</span> <span class="o">|=</span> <span class="n">TG3_PHYFLG_EEE_CAP</span><span class="p">;</span>

	<span class="n">tg3_phy_init_link_config</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">phy_flags</span> <span class="o">&amp;</span> <span class="n">TG3_PHYFLG_ANY_SERDES</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">ENABLE_APE</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">ENABLE_ASF</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">bmsr</span><span class="p">,</span> <span class="n">dummy</span><span class="p">;</span>

		<span class="n">tg3_readphy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">MII_BMSR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bmsr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tg3_readphy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">MII_BMSR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bmsr</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">bmsr</span> <span class="o">&amp;</span> <span class="n">BMSR_LSTATUS</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">skip_phy_reset</span><span class="p">;</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">tg3_phy_reset</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

		<span class="n">tg3_phy_set_wirespeed</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tg3_phy_copper_an_config_ok</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dummy</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">tg3_phy_autoneg_cfg</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">link_config</span><span class="p">.</span><span class="n">advertising</span><span class="p">,</span>
					    <span class="n">tp</span><span class="o">-&gt;</span><span class="n">link_config</span><span class="p">.</span><span class="n">flowctrl</span><span class="p">);</span>

			<span class="n">tg3_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">MII_BMCR</span><span class="p">,</span>
				     <span class="n">BMCR_ANENABLE</span> <span class="o">|</span> <span class="n">BMCR_ANRESTART</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

<span class="nl">skip_phy_reset:</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">phy_id</span> <span class="o">&amp;</span> <span class="n">TG3_PHY_ID_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">TG3_PHY_ID_BCM5401</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">tg3_init_5401phy_dsp</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">tg3_init_5401phy_dsp</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span> <span class="nf">tg3_read_vpd</span><span class="p">(</span><span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">vpd_data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">block_end</span><span class="p">,</span> <span class="n">rosize</span><span class="p">,</span> <span class="n">len</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">vpdlen</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">j</span><span class="p">,</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">vpd_data</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">tg3_vpd_readblock</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vpdlen</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vpd_data</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_no_vpd</span><span class="p">;</span>

	<span class="n">i</span> <span class="o">=</span> <span class="n">pci_vpd_find_tag</span><span class="p">(</span><span class="n">vpd_data</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">vpdlen</span><span class="p">,</span> <span class="n">PCI_VPD_LRDT_RO_DATA</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_not_found</span><span class="p">;</span>

	<span class="n">rosize</span> <span class="o">=</span> <span class="n">pci_vpd_lrdt_size</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vpd_data</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="n">block_end</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="n">PCI_VPD_LRDT_TAG_SIZE</span> <span class="o">+</span> <span class="n">rosize</span><span class="p">;</span>
	<span class="n">i</span> <span class="o">+=</span> <span class="n">PCI_VPD_LRDT_TAG_SIZE</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">block_end</span> <span class="o">&gt;</span> <span class="n">vpdlen</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_not_found</span><span class="p">;</span>

	<span class="n">j</span> <span class="o">=</span> <span class="n">pci_vpd_find_info_keyword</span><span class="p">(</span><span class="n">vpd_data</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">rosize</span><span class="p">,</span>
				      <span class="n">PCI_VPD_RO_KEYWORD_MFR_ID</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">j</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">pci_vpd_info_field_size</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vpd_data</span><span class="p">[</span><span class="n">j</span><span class="p">]);</span>

		<span class="n">j</span> <span class="o">+=</span> <span class="n">PCI_VPD_INFO_FLD_HDR_SIZE</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">j</span> <span class="o">+</span> <span class="n">len</span> <span class="o">&gt;</span> <span class="n">block_end</span> <span class="o">||</span> <span class="n">len</span> <span class="o">!=</span> <span class="mi">4</span> <span class="o">||</span>
		    <span class="n">memcmp</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vpd_data</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="s">&quot;1028&quot;</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">partno</span><span class="p">;</span>

		<span class="n">j</span> <span class="o">=</span> <span class="n">pci_vpd_find_info_keyword</span><span class="p">(</span><span class="n">vpd_data</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">rosize</span><span class="p">,</span>
					      <span class="n">PCI_VPD_RO_KEYWORD_VENDOR0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">j</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">partno</span><span class="p">;</span>

		<span class="n">len</span> <span class="o">=</span> <span class="n">pci_vpd_info_field_size</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vpd_data</span><span class="p">[</span><span class="n">j</span><span class="p">]);</span>

		<span class="n">j</span> <span class="o">+=</span> <span class="n">PCI_VPD_INFO_FLD_HDR_SIZE</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">j</span> <span class="o">+</span> <span class="n">len</span> <span class="o">&gt;</span> <span class="n">block_end</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">partno</span><span class="p">;</span>

		<span class="n">memcpy</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">fw_ver</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vpd_data</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">len</span><span class="p">);</span>
		<span class="n">strncat</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">fw_ver</span><span class="p">,</span> <span class="s">&quot; bc &quot;</span><span class="p">,</span> <span class="n">vpdlen</span> <span class="o">-</span> <span class="n">len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

<span class="nl">partno:</span>
	<span class="n">i</span> <span class="o">=</span> <span class="n">pci_vpd_find_info_keyword</span><span class="p">(</span><span class="n">vpd_data</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">rosize</span><span class="p">,</span>
				      <span class="n">PCI_VPD_RO_KEYWORD_PARTNO</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_not_found</span><span class="p">;</span>

	<span class="n">len</span> <span class="o">=</span> <span class="n">pci_vpd_info_field_size</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vpd_data</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

	<span class="n">i</span> <span class="o">+=</span> <span class="n">PCI_VPD_INFO_FLD_HDR_SIZE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">TG3_BPN_SIZE</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">len</span> <span class="o">+</span> <span class="n">i</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">vpdlen</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_not_found</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">board_part_number</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vpd_data</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">len</span><span class="p">);</span>

<span class="nl">out_not_found:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">vpd_data</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">board_part_number</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
		<span class="k">return</span><span class="p">;</span>

<span class="nl">out_no_vpd:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">ASIC_REV_5717</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="n">TG3PCI_DEVICE_TIGON3_5717</span><span class="p">)</span>
			<span class="n">strcpy</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">board_part_number</span><span class="p">,</span> <span class="s">&quot;BCM5717&quot;</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="n">TG3PCI_DEVICE_TIGON3_5718</span><span class="p">)</span>
			<span class="n">strcpy</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">board_part_number</span><span class="p">,</span> <span class="s">&quot;BCM5718&quot;</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="k">goto</span> <span class="n">nomatch</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">ASIC_REV_57780</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="n">TG3PCI_DEVICE_TIGON3_57780</span><span class="p">)</span>
			<span class="n">strcpy</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">board_part_number</span><span class="p">,</span> <span class="s">&quot;BCM57780&quot;</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="n">TG3PCI_DEVICE_TIGON3_57760</span><span class="p">)</span>
			<span class="n">strcpy</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">board_part_number</span><span class="p">,</span> <span class="s">&quot;BCM57760&quot;</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="n">TG3PCI_DEVICE_TIGON3_57790</span><span class="p">)</span>
			<span class="n">strcpy</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">board_part_number</span><span class="p">,</span> <span class="s">&quot;BCM57790&quot;</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="n">TG3PCI_DEVICE_TIGON3_57788</span><span class="p">)</span>
			<span class="n">strcpy</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">board_part_number</span><span class="p">,</span> <span class="s">&quot;BCM57788&quot;</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="k">goto</span> <span class="n">nomatch</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">ASIC_REV_57765</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="n">TG3PCI_DEVICE_TIGON3_57761</span><span class="p">)</span>
			<span class="n">strcpy</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">board_part_number</span><span class="p">,</span> <span class="s">&quot;BCM57761&quot;</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="n">TG3PCI_DEVICE_TIGON3_57765</span><span class="p">)</span>
			<span class="n">strcpy</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">board_part_number</span><span class="p">,</span> <span class="s">&quot;BCM57765&quot;</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="n">TG3PCI_DEVICE_TIGON3_57781</span><span class="p">)</span>
			<span class="n">strcpy</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">board_part_number</span><span class="p">,</span> <span class="s">&quot;BCM57781&quot;</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="n">TG3PCI_DEVICE_TIGON3_57785</span><span class="p">)</span>
			<span class="n">strcpy</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">board_part_number</span><span class="p">,</span> <span class="s">&quot;BCM57785&quot;</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="n">TG3PCI_DEVICE_TIGON3_57791</span><span class="p">)</span>
			<span class="n">strcpy</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">board_part_number</span><span class="p">,</span> <span class="s">&quot;BCM57791&quot;</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="n">TG3PCI_DEVICE_TIGON3_57795</span><span class="p">)</span>
			<span class="n">strcpy</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">board_part_number</span><span class="p">,</span> <span class="s">&quot;BCM57795&quot;</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="k">goto</span> <span class="n">nomatch</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">ASIC_REV_57766</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="n">TG3PCI_DEVICE_TIGON3_57762</span><span class="p">)</span>
			<span class="n">strcpy</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">board_part_number</span><span class="p">,</span> <span class="s">&quot;BCM57762&quot;</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="n">TG3PCI_DEVICE_TIGON3_57766</span><span class="p">)</span>
			<span class="n">strcpy</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">board_part_number</span><span class="p">,</span> <span class="s">&quot;BCM57766&quot;</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="n">TG3PCI_DEVICE_TIGON3_57782</span><span class="p">)</span>
			<span class="n">strcpy</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">board_part_number</span><span class="p">,</span> <span class="s">&quot;BCM57782&quot;</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="n">TG3PCI_DEVICE_TIGON3_57786</span><span class="p">)</span>
			<span class="n">strcpy</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">board_part_number</span><span class="p">,</span> <span class="s">&quot;BCM57786&quot;</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="k">goto</span> <span class="n">nomatch</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">ASIC_REV_5906</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">strcpy</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">board_part_number</span><span class="p">,</span> <span class="s">&quot;BCM95906&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<span class="nl">nomatch:</span>
		<span class="n">strcpy</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">board_part_number</span><span class="p">,</span> <span class="s">&quot;none&quot;</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">tg3_fw_img_is_valid</span><span class="p">(</span><span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span><span class="p">,</span> <span class="n">u32</span> <span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tg3_nvram_read</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0xfc000000</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x0c000000</span> <span class="o">||</span>
	    <span class="n">tg3_nvram_read</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">offset</span> <span class="o">+</span> <span class="mi">4</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">val</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span> <span class="nf">tg3_read_bc_ver</span><span class="p">(</span><span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">ver_offset</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">dst_off</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">newver</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tg3_nvram_read</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mh">0xc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">offset</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">tg3_nvram_read</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mh">0x4</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">start</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">offset</span> <span class="o">=</span> <span class="n">tg3_nvram_logical_addr</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">offset</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tg3_nvram_read</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0xfc000000</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x0c000000</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tg3_nvram_read</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">offset</span> <span class="o">+</span> <span class="mi">4</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">))</span>
			<span class="k">return</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">newver</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dst_off</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">fw_ver</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">newver</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">TG3_VER_SIZE</span> <span class="o">-</span> <span class="n">dst_off</span> <span class="o">&lt;</span> <span class="mi">16</span> <span class="o">||</span>
		    <span class="n">tg3_nvram_read</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">offset</span> <span class="o">+</span> <span class="mi">8</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ver_offset</span><span class="p">))</span>
			<span class="k">return</span><span class="p">;</span>

		<span class="n">offset</span> <span class="o">=</span> <span class="n">offset</span> <span class="o">+</span> <span class="n">ver_offset</span> <span class="o">-</span> <span class="n">start</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">__be32</span> <span class="n">v</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tg3_nvram_read_be32</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">offset</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">v</span><span class="p">))</span>
				<span class="k">return</span><span class="p">;</span>

			<span class="n">memcpy</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">fw_ver</span> <span class="o">+</span> <span class="n">dst_off</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">v</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">v</span><span class="p">));</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">major</span><span class="p">,</span> <span class="n">minor</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">tg3_nvram_read</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">TG3_NVM_PTREV_BCVER</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ver_offset</span><span class="p">))</span>
			<span class="k">return</span><span class="p">;</span>

		<span class="n">major</span> <span class="o">=</span> <span class="p">(</span><span class="n">ver_offset</span> <span class="o">&amp;</span> <span class="n">TG3_NVM_BCVER_MAJMSK</span><span class="p">)</span> <span class="o">&gt;&gt;</span>
			<span class="n">TG3_NVM_BCVER_MAJSFT</span><span class="p">;</span>
		<span class="n">minor</span> <span class="o">=</span> <span class="n">ver_offset</span> <span class="o">&amp;</span> <span class="n">TG3_NVM_BCVER_MINMSK</span><span class="p">;</span>
		<span class="n">snprintf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">fw_ver</span><span class="p">[</span><span class="n">dst_off</span><span class="p">],</span> <span class="n">TG3_VER_SIZE</span> <span class="o">-</span> <span class="n">dst_off</span><span class="p">,</span>
			 <span class="s">&quot;v%d.%02d&quot;</span><span class="p">,</span> <span class="n">major</span><span class="p">,</span> <span class="n">minor</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span> <span class="nf">tg3_read_hwsb_ver</span><span class="p">(</span><span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">,</span> <span class="n">major</span><span class="p">,</span> <span class="n">minor</span><span class="p">;</span>

	<span class="cm">/* Use native endian representation */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tg3_nvram_read</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">TG3_NVM_HWSB_CFG1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">major</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">TG3_NVM_HWSB_CFG1_MAJMSK</span><span class="p">)</span> <span class="o">&gt;&gt;</span>
		<span class="n">TG3_NVM_HWSB_CFG1_MAJSFT</span><span class="p">;</span>
	<span class="n">minor</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">TG3_NVM_HWSB_CFG1_MINMSK</span><span class="p">)</span> <span class="o">&gt;&gt;</span>
		<span class="n">TG3_NVM_HWSB_CFG1_MINSFT</span><span class="p">;</span>

	<span class="n">snprintf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">fw_ver</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">32</span><span class="p">,</span> <span class="s">&quot;sb v%d.%02d&quot;</span><span class="p">,</span> <span class="n">major</span><span class="p">,</span> <span class="n">minor</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span> <span class="nf">tg3_read_sb_ver</span><span class="p">(</span><span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span><span class="p">,</span> <span class="n">u32</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">offset</span><span class="p">,</span> <span class="n">major</span><span class="p">,</span> <span class="n">minor</span><span class="p">,</span> <span class="n">build</span><span class="p">;</span>

	<span class="n">strncat</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">fw_ver</span><span class="p">,</span> <span class="s">&quot;sb&quot;</span><span class="p">,</span> <span class="n">TG3_VER_SIZE</span> <span class="o">-</span> <span class="n">strlen</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">fw_ver</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">TG3_EEPROM_SB_FORMAT_MASK</span><span class="p">)</span> <span class="o">!=</span> <span class="n">TG3_EEPROM_SB_FORMAT_1</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">TG3_EEPROM_SB_REVISION_MASK</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">TG3_EEPROM_SB_REVISION_0</span>:
		<span class="n">offset</span> <span class="o">=</span> <span class="n">TG3_EEPROM_SB_F1R0_EDH_OFF</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TG3_EEPROM_SB_REVISION_2</span>:
		<span class="n">offset</span> <span class="o">=</span> <span class="n">TG3_EEPROM_SB_F1R2_EDH_OFF</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TG3_EEPROM_SB_REVISION_3</span>:
		<span class="n">offset</span> <span class="o">=</span> <span class="n">TG3_EEPROM_SB_F1R3_EDH_OFF</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TG3_EEPROM_SB_REVISION_4</span>:
		<span class="n">offset</span> <span class="o">=</span> <span class="n">TG3_EEPROM_SB_F1R4_EDH_OFF</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TG3_EEPROM_SB_REVISION_5</span>:
		<span class="n">offset</span> <span class="o">=</span> <span class="n">TG3_EEPROM_SB_F1R5_EDH_OFF</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TG3_EEPROM_SB_REVISION_6</span>:
		<span class="n">offset</span> <span class="o">=</span> <span class="n">TG3_EEPROM_SB_F1R6_EDH_OFF</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tg3_nvram_read</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">build</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">TG3_EEPROM_SB_EDH_BLD_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span>
		<span class="n">TG3_EEPROM_SB_EDH_BLD_SHFT</span><span class="p">;</span>
	<span class="n">major</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">TG3_EEPROM_SB_EDH_MAJ_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span>
		<span class="n">TG3_EEPROM_SB_EDH_MAJ_SHFT</span><span class="p">;</span>
	<span class="n">minor</span> <span class="o">=</span>  <span class="n">val</span> <span class="o">&amp;</span> <span class="n">TG3_EEPROM_SB_EDH_MIN_MASK</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">minor</span> <span class="o">&gt;</span> <span class="mi">99</span> <span class="o">||</span> <span class="n">build</span> <span class="o">&gt;</span> <span class="mi">26</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">offset</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">fw_ver</span><span class="p">);</span>
	<span class="n">snprintf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">fw_ver</span><span class="p">[</span><span class="n">offset</span><span class="p">],</span> <span class="n">TG3_VER_SIZE</span> <span class="o">-</span> <span class="n">offset</span><span class="p">,</span>
		 <span class="s">&quot; v%d.%02d&quot;</span><span class="p">,</span> <span class="n">major</span><span class="p">,</span> <span class="n">minor</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">build</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">offset</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">fw_ver</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">offset</span> <span class="o">&lt;</span> <span class="n">TG3_VER_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">tp</span><span class="o">-&gt;</span><span class="n">fw_ver</span><span class="p">[</span><span class="n">offset</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;a&#39;</span> <span class="o">+</span> <span class="n">build</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span> <span class="nf">tg3_read_mgmtfw_ver</span><span class="p">(</span><span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">start</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">vlen</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">offset</span> <span class="o">=</span> <span class="n">TG3_NVM_DIR_START</span><span class="p">;</span>
	     <span class="n">offset</span> <span class="o">&lt;</span> <span class="n">TG3_NVM_DIR_END</span><span class="p">;</span>
	     <span class="n">offset</span> <span class="o">+=</span> <span class="n">TG3_NVM_DIRENT_SIZE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tg3_nvram_read</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">))</span>
			<span class="k">return</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="n">TG3_NVM_DIRTYPE_SHIFT</span><span class="p">)</span> <span class="o">==</span> <span class="n">TG3_NVM_DIRTYPE_ASFINI</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">offset</span> <span class="o">==</span> <span class="n">TG3_NVM_DIR_END</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">5705</span><span class="n">_PLUS</span><span class="p">))</span>
		<span class="n">start</span> <span class="o">=</span> <span class="mh">0x08000000</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">tg3_nvram_read</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">offset</span> <span class="o">-</span> <span class="mi">4</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">start</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tg3_nvram_read</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">offset</span> <span class="o">+</span> <span class="mi">4</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">offset</span><span class="p">)</span> <span class="o">||</span>
	    <span class="o">!</span><span class="n">tg3_fw_img_is_valid</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">offset</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">tg3_nvram_read</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">offset</span> <span class="o">+</span> <span class="mi">8</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">offset</span> <span class="o">+=</span> <span class="n">val</span> <span class="o">-</span> <span class="n">start</span><span class="p">;</span>

	<span class="n">vlen</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">fw_ver</span><span class="p">);</span>

	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">fw_ver</span><span class="p">[</span><span class="n">vlen</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;,&#39;</span><span class="p">;</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">fw_ver</span><span class="p">[</span><span class="n">vlen</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39; &#39;</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">__be32</span> <span class="n">v</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tg3_nvram_read_be32</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">v</span><span class="p">))</span>
			<span class="k">return</span><span class="p">;</span>

		<span class="n">offset</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">v</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">vlen</span> <span class="o">&gt;</span> <span class="n">TG3_VER_SIZE</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">v</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">fw_ver</span><span class="p">[</span><span class="n">vlen</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">v</span><span class="p">,</span> <span class="n">TG3_VER_SIZE</span> <span class="o">-</span> <span class="n">vlen</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">fw_ver</span><span class="p">[</span><span class="n">vlen</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">v</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">v</span><span class="p">));</span>
		<span class="n">vlen</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">v</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span> <span class="nf">tg3_read_dash_ver</span><span class="p">(</span><span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">vlen</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">apedata</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">fwtype</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">ENABLE_APE</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">ENABLE_ASF</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">apedata</span> <span class="o">=</span> <span class="n">tg3_ape_read32</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">TG3_APE_SEG_SIG</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">apedata</span> <span class="o">!=</span> <span class="n">APE_SEG_SIG_MAGIC</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">apedata</span> <span class="o">=</span> <span class="n">tg3_ape_read32</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">TG3_APE_FW_STATUS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">apedata</span> <span class="o">&amp;</span> <span class="n">APE_FW_STATUS_READY</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">apedata</span> <span class="o">=</span> <span class="n">tg3_ape_read32</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">TG3_APE_FW_VERSION</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tg3_ape_read32</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">TG3_APE_FW_FEATURES</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">TG3_APE_FW_FEATURE_NCSI</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tg3_flag_set</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">APE_HAS_NCSI</span><span class="p">);</span>
		<span class="n">fwtype</span> <span class="o">=</span> <span class="s">&quot;NCSI&quot;</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">fwtype</span> <span class="o">=</span> <span class="s">&quot;DASH&quot;</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">vlen</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">fw_ver</span><span class="p">);</span>

	<span class="n">snprintf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">fw_ver</span><span class="p">[</span><span class="n">vlen</span><span class="p">],</span> <span class="n">TG3_VER_SIZE</span> <span class="o">-</span> <span class="n">vlen</span><span class="p">,</span> <span class="s">&quot; %s v%d.%d.%d.%d&quot;</span><span class="p">,</span>
		 <span class="n">fwtype</span><span class="p">,</span>
		 <span class="p">(</span><span class="n">apedata</span> <span class="o">&amp;</span> <span class="n">APE_FW_VERSION_MAJMSK</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">APE_FW_VERSION_MAJSFT</span><span class="p">,</span>
		 <span class="p">(</span><span class="n">apedata</span> <span class="o">&amp;</span> <span class="n">APE_FW_VERSION_MINMSK</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">APE_FW_VERSION_MINSFT</span><span class="p">,</span>
		 <span class="p">(</span><span class="n">apedata</span> <span class="o">&amp;</span> <span class="n">APE_FW_VERSION_REVMSK</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">APE_FW_VERSION_REVSFT</span><span class="p">,</span>
		 <span class="p">(</span><span class="n">apedata</span> <span class="o">&amp;</span> <span class="n">APE_FW_VERSION_BLDMSK</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span> <span class="nf">tg3_read_fw_ver</span><span class="p">(</span><span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">vpd_vers</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">fw_ver</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">vpd_vers</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">NO_NVRAM</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">strcat</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">fw_ver</span><span class="p">,</span> <span class="s">&quot;sb&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tg3_nvram_read</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">==</span> <span class="n">TG3_EEPROM_MAGIC</span><span class="p">)</span>
		<span class="n">tg3_read_bc_ver</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">TG3_EEPROM_MAGIC_FW_MSK</span><span class="p">)</span> <span class="o">==</span> <span class="n">TG3_EEPROM_MAGIC_FW</span><span class="p">)</span>
		<span class="n">tg3_read_sb_ver</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">TG3_EEPROM_MAGIC_HW_MSK</span><span class="p">)</span> <span class="o">==</span> <span class="n">TG3_EEPROM_MAGIC_HW</span><span class="p">)</span>
		<span class="n">tg3_read_hwsb_ver</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vpd_vers</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">ENABLE_APE</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">ENABLE_ASF</span><span class="p">))</span>
			<span class="n">tg3_read_dash_ver</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">ENABLE_ASF</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">tg3_read_mgmtfw_ver</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
	<span class="p">}</span>

<span class="nl">done:</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">fw_ver</span><span class="p">[</span><span class="n">TG3_VER_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u32</span> <span class="nf">tg3_rx_ret_ring_size</span><span class="p">(</span><span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">LRG_PROD_RING_CAP</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">TG3_RX_RET_MAX_SIZE_5717</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">JUMBO_CAPABLE</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">5780</span><span class="n">_CLASS</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">TG3_RX_RET_MAX_SIZE_5700</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">TG3_RX_RET_MAX_SIZE_5705</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DEFINE_PCI_DEVICE_TABLE</span><span class="p">(</span><span class="n">tg3_write_reorder_chipsets</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_AMD</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_AMD_FE_GATE_700C</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_AMD</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_AMD_8131_BRIDGE</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_VIA</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_VIA_8385_0</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span> <span class="n">__devinit</span> <span class="nf">tg3_find_peer</span><span class="p">(</span><span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">peer</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">func</span><span class="p">,</span> <span class="n">devnr</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">devfn</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">7</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">func</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">func</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">func</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">peer</span> <span class="o">=</span> <span class="n">pci_get_slot</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">,</span> <span class="n">devnr</span> <span class="o">|</span> <span class="n">func</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">peer</span> <span class="o">&amp;&amp;</span> <span class="n">peer</span> <span class="o">!=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">pci_dev_put</span><span class="p">(</span><span class="n">peer</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/* 5704 can be configured in single-port mode, set peer to</span>
<span class="cm">	 * tp-&gt;pdev in that case.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">peer</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">peer</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">peer</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * We don&#39;t need to keep the refcount elevated; there&#39;s no way</span>
<span class="cm">	 * to remove one half of this device without removing the other</span>
<span class="cm">	 */</span>
	<span class="n">pci_dev_put</span><span class="p">(</span><span class="n">peer</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">peer</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span> <span class="nf">tg3_detect_asic_rev</span><span class="p">(</span><span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span><span class="p">,</span> <span class="n">u32</span> <span class="n">misc_ctrl_reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span> <span class="o">=</span> <span class="n">misc_ctrl_reg</span> <span class="o">&gt;&gt;</span> <span class="n">MISC_HOST_CTRL_CHIPREV_SHIFT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">ASIC_REV_USE_PROD_ID_REG</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">reg</span><span class="p">;</span>

		<span class="cm">/* All devices that use the alternate</span>
<span class="cm">		 * ASIC REV location have a CPMU.</span>
<span class="cm">		 */</span>
		<span class="n">tg3_flag_set</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">CPMU_PRESENT</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="n">TG3PCI_DEVICE_TIGON3_5717</span> <span class="o">||</span>
		    <span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="n">TG3PCI_DEVICE_TIGON3_5718</span> <span class="o">||</span>
		    <span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="n">TG3PCI_DEVICE_TIGON3_5719</span> <span class="o">||</span>
		    <span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="n">TG3PCI_DEVICE_TIGON3_5720</span><span class="p">)</span>
			<span class="n">reg</span> <span class="o">=</span> <span class="n">TG3PCI_GEN2_PRODID_ASICREV</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="n">TG3PCI_DEVICE_TIGON3_57781</span> <span class="o">||</span>
			 <span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="n">TG3PCI_DEVICE_TIGON3_57785</span> <span class="o">||</span>
			 <span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="n">TG3PCI_DEVICE_TIGON3_57761</span> <span class="o">||</span>
			 <span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="n">TG3PCI_DEVICE_TIGON3_57765</span> <span class="o">||</span>
			 <span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="n">TG3PCI_DEVICE_TIGON3_57791</span> <span class="o">||</span>
			 <span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="n">TG3PCI_DEVICE_TIGON3_57795</span> <span class="o">||</span>
			 <span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="n">TG3PCI_DEVICE_TIGON3_57762</span> <span class="o">||</span>
			 <span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="n">TG3PCI_DEVICE_TIGON3_57766</span> <span class="o">||</span>
			 <span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="n">TG3PCI_DEVICE_TIGON3_57782</span> <span class="o">||</span>
			 <span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="n">TG3PCI_DEVICE_TIGON3_57786</span><span class="p">)</span>
			<span class="n">reg</span> <span class="o">=</span> <span class="n">TG3PCI_GEN15_PRODID_ASICREV</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">reg</span> <span class="o">=</span> <span class="n">TG3PCI_PRODID_ASICREV</span><span class="p">;</span>

		<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Wrong chip ID in 5752 A0. This code can be removed later</span>
<span class="cm">	 * as A0 is not in production.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span> <span class="o">==</span> <span class="n">CHIPREV_ID_5752_A0_HW</span><span class="p">)</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span> <span class="o">=</span> <span class="n">CHIPREV_ID_5752_A0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">ASIC_REV_5717</span> <span class="o">||</span>
	    <span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">ASIC_REV_5719</span> <span class="o">||</span>
	    <span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">ASIC_REV_5720</span><span class="p">)</span>
		<span class="n">tg3_flag_set</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">5717</span><span class="n">_PLUS</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">ASIC_REV_57765</span> <span class="o">||</span>
	    <span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">ASIC_REV_57766</span><span class="p">)</span>
		<span class="n">tg3_flag_set</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">57765</span><span class="n">_CLASS</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">57765</span><span class="n">_CLASS</span><span class="p">)</span> <span class="o">||</span> <span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">5717</span><span class="n">_PLUS</span><span class="p">))</span>
		<span class="n">tg3_flag_set</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">57765</span><span class="n">_PLUS</span><span class="p">);</span>

	<span class="cm">/* Intentionally exclude ASIC_REV_5906 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">ASIC_REV_5755</span> <span class="o">||</span>
	    <span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">ASIC_REV_5787</span> <span class="o">||</span>
	    <span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">ASIC_REV_5784</span> <span class="o">||</span>
	    <span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">ASIC_REV_5761</span> <span class="o">||</span>
	    <span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">ASIC_REV_5785</span> <span class="o">||</span>
	    <span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">ASIC_REV_57780</span> <span class="o">||</span>
	    <span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">57765</span><span class="n">_PLUS</span><span class="p">))</span>
		<span class="n">tg3_flag_set</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">5755</span><span class="n">_PLUS</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">ASIC_REV_5780</span> <span class="o">||</span>
	    <span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">ASIC_REV_5714</span><span class="p">)</span>
		<span class="n">tg3_flag_set</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">5780</span><span class="n">_CLASS</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">ASIC_REV_5750</span> <span class="o">||</span>
	    <span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">ASIC_REV_5752</span> <span class="o">||</span>
	    <span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">ASIC_REV_5906</span> <span class="o">||</span>
	    <span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">5755</span><span class="n">_PLUS</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">5780</span><span class="n">_CLASS</span><span class="p">))</span>
		<span class="n">tg3_flag_set</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">5750</span><span class="n">_PLUS</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">ASIC_REV_5705</span> <span class="o">||</span>
	    <span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">5750</span><span class="n">_PLUS</span><span class="p">))</span>
		<span class="n">tg3_flag_set</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">5705</span><span class="n">_PLUS</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">tg3_get_invariants</span><span class="p">(</span><span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">misc_ctrl_reg</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">pci_state_reg</span><span class="p">,</span> <span class="n">grc_misc_cfg</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">pci_cmd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="cm">/* Force memory write invalidate off.  If we leave it on,</span>
<span class="cm">	 * then on 5700_BX chips we have to enable a workaround.</span>
<span class="cm">	 * The workaround is to set the TG3PCI_DMA_RW_CTRL boundary</span>
<span class="cm">	 * to match the cacheline size.  The Broadcom driver have this</span>
<span class="cm">	 * workaround but turns MWI off all the times so never uses</span>
<span class="cm">	 * it.  This seems to suggest that the workaround is insufficient.</span>
<span class="cm">	 */</span>
	<span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_COMMAND</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pci_cmd</span><span class="p">);</span>
	<span class="n">pci_cmd</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PCI_COMMAND_INVALIDATE</span><span class="p">;</span>
	<span class="n">pci_write_config_word</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_COMMAND</span><span class="p">,</span> <span class="n">pci_cmd</span><span class="p">);</span>

	<span class="cm">/* Important! -- Make sure register accesses are byteswapped</span>
<span class="cm">	 * correctly.  Also, for those chips that require it, make</span>
<span class="cm">	 * sure that indirect register accesses are enabled before</span>
<span class="cm">	 * the first operation.</span>
<span class="cm">	 */</span>
	<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">TG3PCI_MISC_HOST_CTRL</span><span class="p">,</span>
			      <span class="o">&amp;</span><span class="n">misc_ctrl_reg</span><span class="p">);</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">misc_host_ctrl</span> <span class="o">|=</span> <span class="p">(</span><span class="n">misc_ctrl_reg</span> <span class="o">&amp;</span>
			       <span class="n">MISC_HOST_CTRL_CHIPREV</span><span class="p">);</span>
	<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">TG3PCI_MISC_HOST_CTRL</span><span class="p">,</span>
			       <span class="n">tp</span><span class="o">-&gt;</span><span class="n">misc_host_ctrl</span><span class="p">);</span>

	<span class="n">tg3_detect_asic_rev</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">misc_ctrl_reg</span><span class="p">);</span>

	<span class="cm">/* If we have 5702/03 A1 or A2 on certain ICH chipsets,</span>
<span class="cm">	 * we need to disable memory and use config. cycles</span>
<span class="cm">	 * only to access all registers. The 5702/03 chips</span>
<span class="cm">	 * can mistakenly decode the special cycles from the</span>
<span class="cm">	 * ICH chipsets as memory write cycles, causing corruption</span>
<span class="cm">	 * of register and memory space. Only certain ICH bridges</span>
<span class="cm">	 * will drive special cycles with non-zero data during the</span>
<span class="cm">	 * address phase which can fall within the 5703&#39;s address</span>
<span class="cm">	 * range. This is not an ICH bug as the PCI spec allows</span>
<span class="cm">	 * non-zero address during special cycles. However, only</span>
<span class="cm">	 * these ICH bridges are known to drive non-zero addresses</span>
<span class="cm">	 * during special cycles.</span>
<span class="cm">	 *</span>
<span class="cm">	 * Since special cycles do not cross PCI bridges, we only</span>
<span class="cm">	 * enable this workaround if the 5703 is on the secondary</span>
<span class="cm">	 * bus of these ICH bridges.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span> <span class="o">==</span> <span class="n">CHIPREV_ID_5703_A1</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span> <span class="o">==</span> <span class="n">CHIPREV_ID_5703_A2</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">static</span> <span class="k">struct</span> <span class="n">tg3_dev_id</span> <span class="p">{</span>
			<span class="n">u32</span>	<span class="n">vendor</span><span class="p">;</span>
			<span class="n">u32</span>	<span class="n">device</span><span class="p">;</span>
			<span class="n">u32</span>	<span class="n">rev</span><span class="p">;</span>
		<span class="p">}</span> <span class="n">ich_chipsets</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">{</span> <span class="n">PCI_VENDOR_ID_INTEL</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_INTEL_82801AA_8</span><span class="p">,</span>
			  <span class="n">PCI_ANY_ID</span> <span class="p">},</span>
			<span class="p">{</span> <span class="n">PCI_VENDOR_ID_INTEL</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_INTEL_82801AB_8</span><span class="p">,</span>
			  <span class="n">PCI_ANY_ID</span> <span class="p">},</span>
			<span class="p">{</span> <span class="n">PCI_VENDOR_ID_INTEL</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_INTEL_82801BA_11</span><span class="p">,</span>
			  <span class="mh">0xa</span> <span class="p">},</span>
			<span class="p">{</span> <span class="n">PCI_VENDOR_ID_INTEL</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_INTEL_82801BA_6</span><span class="p">,</span>
			  <span class="n">PCI_ANY_ID</span> <span class="p">},</span>
			<span class="p">{</span> <span class="p">},</span>
		<span class="p">};</span>
		<span class="k">struct</span> <span class="n">tg3_dev_id</span> <span class="o">*</span><span class="n">pci_id</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ich_chipsets</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">bridge</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

		<span class="k">while</span> <span class="p">(</span><span class="n">pci_id</span><span class="o">-&gt;</span><span class="n">vendor</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">bridge</span> <span class="o">=</span> <span class="n">pci_get_device</span><span class="p">(</span><span class="n">pci_id</span><span class="o">-&gt;</span><span class="n">vendor</span><span class="p">,</span> <span class="n">pci_id</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span>
						<span class="n">bridge</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bridge</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">pci_id</span><span class="o">++</span><span class="p">;</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pci_id</span><span class="o">-&gt;</span><span class="n">rev</span> <span class="o">!=</span> <span class="n">PCI_ANY_ID</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">bridge</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">&gt;</span> <span class="n">pci_id</span><span class="o">-&gt;</span><span class="n">rev</span><span class="p">)</span>
					<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">bridge</span><span class="o">-&gt;</span><span class="n">subordinate</span> <span class="o">&amp;&amp;</span>
			    <span class="p">(</span><span class="n">bridge</span><span class="o">-&gt;</span><span class="n">subordinate</span><span class="o">-&gt;</span><span class="n">number</span> <span class="o">==</span>
			     <span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">tg3_flag_set</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">ICH_WORKAROUND</span><span class="p">);</span>
				<span class="n">pci_dev_put</span><span class="p">(</span><span class="n">bridge</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">ASIC_REV_5701</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">static</span> <span class="k">struct</span> <span class="n">tg3_dev_id</span> <span class="p">{</span>
			<span class="n">u32</span>	<span class="n">vendor</span><span class="p">;</span>
			<span class="n">u32</span>	<span class="n">device</span><span class="p">;</span>
		<span class="p">}</span> <span class="n">bridge_chipsets</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">{</span> <span class="n">PCI_VENDOR_ID_INTEL</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_INTEL_PXH_0</span> <span class="p">},</span>
			<span class="p">{</span> <span class="n">PCI_VENDOR_ID_INTEL</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_INTEL_PXH_1</span> <span class="p">},</span>
			<span class="p">{</span> <span class="p">},</span>
		<span class="p">};</span>
		<span class="k">struct</span> <span class="n">tg3_dev_id</span> <span class="o">*</span><span class="n">pci_id</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">bridge_chipsets</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">bridge</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

		<span class="k">while</span> <span class="p">(</span><span class="n">pci_id</span><span class="o">-&gt;</span><span class="n">vendor</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">bridge</span> <span class="o">=</span> <span class="n">pci_get_device</span><span class="p">(</span><span class="n">pci_id</span><span class="o">-&gt;</span><span class="n">vendor</span><span class="p">,</span>
						<span class="n">pci_id</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span>
						<span class="n">bridge</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bridge</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">pci_id</span><span class="o">++</span><span class="p">;</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">bridge</span><span class="o">-&gt;</span><span class="n">subordinate</span> <span class="o">&amp;&amp;</span>
			    <span class="p">(</span><span class="n">bridge</span><span class="o">-&gt;</span><span class="n">subordinate</span><span class="o">-&gt;</span><span class="n">number</span> <span class="o">&lt;=</span>
			     <span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="p">(</span><span class="n">bridge</span><span class="o">-&gt;</span><span class="n">subordinate</span><span class="o">-&gt;</span><span class="n">subordinate</span> <span class="o">&gt;=</span>
			     <span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">tg3_flag_set</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">5701</span><span class="n">_DMA_BUG</span><span class="p">);</span>
				<span class="n">pci_dev_put</span><span class="p">(</span><span class="n">bridge</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* The EPB bridge inside 5714, 5715, and 5780 cannot support</span>
<span class="cm">	 * DMA addresses &gt; 40-bit. This bridge may have other additional</span>
<span class="cm">	 * 57xx devices behind it in some 4-port NIC designs for example.</span>
<span class="cm">	 * Any tg3 device found behind the bridge will also need the 40-bit</span>
<span class="cm">	 * DMA workaround.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">5780</span><span class="n">_CLASS</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">tg3_flag_set</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">40</span><span class="n">BIT_DMA_BUG</span><span class="p">);</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">msi_cap</span> <span class="o">=</span> <span class="n">pci_find_capability</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_CAP_ID_MSI</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">bridge</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

		<span class="k">do</span> <span class="p">{</span>
			<span class="n">bridge</span> <span class="o">=</span> <span class="n">pci_get_device</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_SERVERWORKS</span><span class="p">,</span>
						<span class="n">PCI_DEVICE_ID_SERVERWORKS_EPB</span><span class="p">,</span>
						<span class="n">bridge</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">bridge</span> <span class="o">&amp;&amp;</span> <span class="n">bridge</span><span class="o">-&gt;</span><span class="n">subordinate</span> <span class="o">&amp;&amp;</span>
			    <span class="p">(</span><span class="n">bridge</span><span class="o">-&gt;</span><span class="n">subordinate</span><span class="o">-&gt;</span><span class="n">number</span> <span class="o">&lt;=</span>
			     <span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="p">(</span><span class="n">bridge</span><span class="o">-&gt;</span><span class="n">subordinate</span><span class="o">-&gt;</span><span class="n">subordinate</span> <span class="o">&gt;=</span>
			     <span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">tg3_flag_set</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">40</span><span class="n">BIT_DMA_BUG</span><span class="p">);</span>
				<span class="n">pci_dev_put</span><span class="p">(</span><span class="n">bridge</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">bridge</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">ASIC_REV_5704</span> <span class="o">||</span>
	    <span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">ASIC_REV_5714</span><span class="p">)</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev_peer</span> <span class="o">=</span> <span class="n">tg3_find_peer</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>

	<span class="cm">/* Determine TSO capabilities */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span> <span class="o">==</span> <span class="n">CHIPREV_ID_5719_A0</span><span class="p">)</span>
		<span class="p">;</span> <span class="cm">/* Do nothing. HW bug. */</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">57765</span><span class="n">_PLUS</span><span class="p">))</span>
		<span class="n">tg3_flag_set</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">HW_TSO_3</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">5755</span><span class="n">_PLUS</span><span class="p">)</span> <span class="o">||</span>
		 <span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">ASIC_REV_5906</span><span class="p">)</span>
		<span class="n">tg3_flag_set</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">HW_TSO_2</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">5750</span><span class="n">_PLUS</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">tg3_flag_set</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">HW_TSO_1</span><span class="p">);</span>
		<span class="n">tg3_flag_set</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">TSO_BUG</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">ASIC_REV_5750</span> <span class="o">&amp;&amp;</span>
		    <span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span> <span class="o">&gt;=</span> <span class="n">CHIPREV_ID_5750_C2</span><span class="p">)</span>
			<span class="n">tg3_flag_clear</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">TSO_BUG</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">!=</span> <span class="n">ASIC_REV_5700</span> <span class="o">&amp;&amp;</span>
		   <span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">!=</span> <span class="n">ASIC_REV_5701</span> <span class="o">&amp;&amp;</span>
		   <span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span> <span class="o">!=</span> <span class="n">CHIPREV_ID_5705_A0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">tg3_flag_set</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">TSO_BUG</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">ASIC_REV_5705</span><span class="p">)</span>
			<span class="n">tp</span><span class="o">-&gt;</span><span class="n">fw_needed</span> <span class="o">=</span> <span class="n">FIRMWARE_TG3TSO5</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">tp</span><span class="o">-&gt;</span><span class="n">fw_needed</span> <span class="o">=</span> <span class="n">FIRMWARE_TG3TSO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Selectively allow TSO based on operating conditions */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">HW_TSO_1</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">HW_TSO_2</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">HW_TSO_3</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">tp</span><span class="o">-&gt;</span><span class="n">fw_needed</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* For firmware TSO, assume ASF is disabled.</span>
<span class="cm">		 * We&#39;ll disable TSO later if we discover ASF</span>
<span class="cm">		 * is enabled in tg3_get_eeprom_hw_cfg().</span>
<span class="cm">		 */</span>
		<span class="n">tg3_flag_set</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">TSO_CAPABLE</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">tg3_flag_clear</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">TSO_CAPABLE</span><span class="p">);</span>
		<span class="n">tg3_flag_clear</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">TSO_BUG</span><span class="p">);</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">fw_needed</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span> <span class="o">==</span> <span class="n">CHIPREV_ID_5701_A0</span><span class="p">)</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">fw_needed</span> <span class="o">=</span> <span class="n">FIRMWARE_TG3</span><span class="p">;</span>

	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">irq_max</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">5750</span><span class="n">_PLUS</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">tg3_flag_set</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">SUPPORT_MSI</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">GET_CHIP_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">CHIPREV_5750_AX</span> <span class="o">||</span>
		    <span class="n">GET_CHIP_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">CHIPREV_5750_BX</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">ASIC_REV_5714</span> <span class="o">&amp;&amp;</span>
		     <span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span> <span class="o">&lt;=</span> <span class="n">CHIPREV_ID_5714_A2</span> <span class="o">&amp;&amp;</span>
		     <span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev_peer</span> <span class="o">==</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">))</span>
			<span class="n">tg3_flag_clear</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">SUPPORT_MSI</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">5755</span><span class="n">_PLUS</span><span class="p">)</span> <span class="o">||</span>
		    <span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">ASIC_REV_5906</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">tg3_flag_set</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">1</span><span class="n">SHOT_MSI</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">57765</span><span class="n">_PLUS</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">tg3_flag_set</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">SUPPORT_MSIX</span><span class="p">);</span>
			<span class="n">tp</span><span class="o">-&gt;</span><span class="n">irq_max</span> <span class="o">=</span> <span class="n">TG3_IRQ_MAX_VECS</span><span class="p">;</span>
			<span class="n">tg3_rss_init_dflt_indir_tbl</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">5755</span><span class="n">_PLUS</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">ASIC_REV_5906</span><span class="p">)</span>
		<span class="n">tg3_flag_set</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">SHORT_DMA_BUG</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">ASIC_REV_5719</span><span class="p">)</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">dma_limit</span> <span class="o">=</span> <span class="n">TG3_TX_BD_DMA_MAX_4K</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">ASIC_REV_5717</span> <span class="o">||</span>
	    <span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">ASIC_REV_5719</span> <span class="o">||</span>
	    <span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">ASIC_REV_5720</span><span class="p">)</span>
		<span class="n">tg3_flag_set</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">LRG_PROD_RING_CAP</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">57765</span><span class="n">_PLUS</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span> <span class="o">!=</span> <span class="n">CHIPREV_ID_5719_A0</span><span class="p">)</span>
		<span class="n">tg3_flag_set</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">USE_JUMBO_BDFLAG</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">5705</span><span class="n">_PLUS</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">5780</span><span class="n">_CLASS</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">USE_JUMBO_BDFLAG</span><span class="p">))</span>
		<span class="n">tg3_flag_set</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">JUMBO_CAPABLE</span><span class="p">);</span>

	<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">TG3PCI_PCISTATE</span><span class="p">,</span>
			      <span class="o">&amp;</span><span class="n">pci_state_reg</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pci_is_pcie</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">u16</span> <span class="n">lnkctl</span><span class="p">;</span>

		<span class="n">tg3_flag_set</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">PCI_EXPRESS</span><span class="p">);</span>

		<span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span>
				     <span class="n">pci_pcie_cap</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">)</span> <span class="o">+</span> <span class="n">PCI_EXP_LNKCTL</span><span class="p">,</span>
				     <span class="o">&amp;</span><span class="n">lnkctl</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lnkctl</span> <span class="o">&amp;</span> <span class="n">PCI_EXP_LNKCTL_CLKREQ_EN</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span>
			    <span class="n">ASIC_REV_5906</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">tg3_flag_clear</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">HW_TSO_2</span><span class="p">);</span>
				<span class="n">tg3_flag_clear</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">TSO_CAPABLE</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">ASIC_REV_5784</span> <span class="o">||</span>
			    <span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">ASIC_REV_5761</span> <span class="o">||</span>
			    <span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span> <span class="o">==</span> <span class="n">CHIPREV_ID_57780_A0</span> <span class="o">||</span>
			    <span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span> <span class="o">==</span> <span class="n">CHIPREV_ID_57780_A1</span><span class="p">)</span>
				<span class="n">tg3_flag_set</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">CLKREQ_BUG</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span> <span class="o">==</span> <span class="n">CHIPREV_ID_5717_A0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">tg3_flag_set</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">L1PLLPD_EN</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">ASIC_REV_5785</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* BCM5785 devices are effectively PCIe devices, and should</span>
<span class="cm">		 * follow PCIe codepaths, but do not have a PCIe capabilities</span>
<span class="cm">		 * section.</span>
<span class="cm">		 */</span>
		<span class="n">tg3_flag_set</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">PCI_EXPRESS</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">5705</span><span class="n">_PLUS</span><span class="p">)</span> <span class="o">||</span>
		   <span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">5780</span><span class="n">_CLASS</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">pcix_cap</span> <span class="o">=</span> <span class="n">pci_find_capability</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_CAP_ID_PCIX</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pcix_cap</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;Cannot find PCI-X capability, aborting</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">pci_state_reg</span> <span class="o">&amp;</span> <span class="n">PCISTATE_CONV_PCI_MODE</span><span class="p">))</span>
			<span class="n">tg3_flag_set</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">PCIX_MODE</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* If we have an AMD 762 or VIA K8T800 chipset, write</span>
<span class="cm">	 * reordering to the mailbox registers done by the host</span>
<span class="cm">	 * controller can cause major troubles.  We read back from</span>
<span class="cm">	 * every mailbox register write to force the writes to be</span>
<span class="cm">	 * posted to the chip in order.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pci_dev_present</span><span class="p">(</span><span class="n">tg3_write_reorder_chipsets</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">PCI_EXPRESS</span><span class="p">))</span>
		<span class="n">tg3_flag_set</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">MBOX_WRITE_REORDER</span><span class="p">);</span>

	<span class="n">pci_read_config_byte</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_CACHE_LINE_SIZE</span><span class="p">,</span>
			     <span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_cacheline_sz</span><span class="p">);</span>
	<span class="n">pci_read_config_byte</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_LATENCY_TIMER</span><span class="p">,</span>
			     <span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_lat_timer</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">ASIC_REV_5703</span> <span class="o">&amp;&amp;</span>
	    <span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_lat_timer</span> <span class="o">&lt;</span> <span class="mi">64</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_lat_timer</span> <span class="o">=</span> <span class="mi">64</span><span class="p">;</span>
		<span class="n">pci_write_config_byte</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_LATENCY_TIMER</span><span class="p">,</span>
				      <span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_lat_timer</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Important! -- It is critical that the PCI-X hw workaround</span>
<span class="cm">	 * situation is decided before the first MMIO register access.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">GET_CHIP_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">CHIPREV_5700_BX</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* 5700 BX chips need to have their TX producer index</span>
<span class="cm">		 * mailboxes written twice to workaround a bug.</span>
<span class="cm">		 */</span>
		<span class="n">tg3_flag_set</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">TXD_MBOX_HWBUG</span><span class="p">);</span>

		<span class="cm">/* If we are in PCI-X mode, enable register write workaround.</span>
<span class="cm">		 *</span>
<span class="cm">		 * The workaround is to use indirect register accesses</span>
<span class="cm">		 * for all chip writes not to mailbox registers.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">PCIX_MODE</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">u32</span> <span class="n">pm_reg</span><span class="p">;</span>

			<span class="n">tg3_flag_set</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">PCIX_TARGET_HWBUG</span><span class="p">);</span>

			<span class="cm">/* The chip can have it&#39;s power management PCI config</span>
<span class="cm">			 * space registers clobbered due to this bug.</span>
<span class="cm">			 * So explicitly force the chip into D0 here.</span>
<span class="cm">			 */</span>
			<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span>
					      <span class="n">tp</span><span class="o">-&gt;</span><span class="n">pm_cap</span> <span class="o">+</span> <span class="n">PCI_PM_CTRL</span><span class="p">,</span>
					      <span class="o">&amp;</span><span class="n">pm_reg</span><span class="p">);</span>
			<span class="n">pm_reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PCI_PM_CTRL_STATE_MASK</span><span class="p">;</span>
			<span class="n">pm_reg</span> <span class="o">|=</span> <span class="n">PCI_PM_CTRL_PME_ENABLE</span> <span class="o">|</span> <span class="mi">0</span> <span class="cm">/* D0 */</span><span class="p">;</span>
			<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span>
					       <span class="n">tp</span><span class="o">-&gt;</span><span class="n">pm_cap</span> <span class="o">+</span> <span class="n">PCI_PM_CTRL</span><span class="p">,</span>
					       <span class="n">pm_reg</span><span class="p">);</span>

			<span class="cm">/* Also, force SERR#/PERR# in PCI command. */</span>
			<span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_COMMAND</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pci_cmd</span><span class="p">);</span>
			<span class="n">pci_cmd</span> <span class="o">|=</span> <span class="n">PCI_COMMAND_PARITY</span> <span class="o">|</span> <span class="n">PCI_COMMAND_SERR</span><span class="p">;</span>
			<span class="n">pci_write_config_word</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_COMMAND</span><span class="p">,</span> <span class="n">pci_cmd</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">pci_state_reg</span> <span class="o">&amp;</span> <span class="n">PCISTATE_BUS_SPEED_HIGH</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">tg3_flag_set</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">PCI_HIGH_SPEED</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">pci_state_reg</span> <span class="o">&amp;</span> <span class="n">PCISTATE_BUS_32BIT</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">tg3_flag_set</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">PCI_32BIT</span><span class="p">);</span>

	<span class="cm">/* Chip-specific fixup from Broadcom driver */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span> <span class="o">==</span> <span class="n">CHIPREV_ID_5704_A0</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">pci_state_reg</span> <span class="o">&amp;</span> <span class="n">PCISTATE_RETRY_SAME_DMA</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">pci_state_reg</span> <span class="o">|=</span> <span class="n">PCISTATE_RETRY_SAME_DMA</span><span class="p">;</span>
		<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">TG3PCI_PCISTATE</span><span class="p">,</span> <span class="n">pci_state_reg</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Default fast path register access methods */</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">read32</span> <span class="o">=</span> <span class="n">tg3_read32</span><span class="p">;</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">write32</span> <span class="o">=</span> <span class="n">tg3_write32</span><span class="p">;</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">read32_mbox</span> <span class="o">=</span> <span class="n">tg3_read32</span><span class="p">;</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">write32_mbox</span> <span class="o">=</span> <span class="n">tg3_write32</span><span class="p">;</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">write32_tx_mbox</span> <span class="o">=</span> <span class="n">tg3_write32</span><span class="p">;</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">write32_rx_mbox</span> <span class="o">=</span> <span class="n">tg3_write32</span><span class="p">;</span>

	<span class="cm">/* Various workaround register access methods */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">PCIX_TARGET_HWBUG</span><span class="p">))</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">write32</span> <span class="o">=</span> <span class="n">tg3_write_indirect_reg32</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">ASIC_REV_5701</span> <span class="o">||</span>
		 <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">PCI_EXPRESS</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		  <span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span> <span class="o">==</span> <span class="n">CHIPREV_ID_5750_A0</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Back to back register writes can cause problems on these</span>
<span class="cm">		 * chips, the workaround is to read back all reg writes</span>
<span class="cm">		 * except those to mailbox regs.</span>
<span class="cm">		 *</span>
<span class="cm">		 * See tg3_write_indirect_reg32().</span>
<span class="cm">		 */</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">write32</span> <span class="o">=</span> <span class="n">tg3_write_flush_reg32</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">TXD_MBOX_HWBUG</span><span class="p">)</span> <span class="o">||</span> <span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">MBOX_WRITE_REORDER</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">write32_tx_mbox</span> <span class="o">=</span> <span class="n">tg3_write32_tx_mbox</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">MBOX_WRITE_REORDER</span><span class="p">))</span>
			<span class="n">tp</span><span class="o">-&gt;</span><span class="n">write32_rx_mbox</span> <span class="o">=</span> <span class="n">tg3_write_flush_reg32</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">ICH_WORKAROUND</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">read32</span> <span class="o">=</span> <span class="n">tg3_read_indirect_reg32</span><span class="p">;</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">write32</span> <span class="o">=</span> <span class="n">tg3_write_indirect_reg32</span><span class="p">;</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">read32_mbox</span> <span class="o">=</span> <span class="n">tg3_read_indirect_mbox</span><span class="p">;</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">write32_mbox</span> <span class="o">=</span> <span class="n">tg3_write_indirect_mbox</span><span class="p">;</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">write32_tx_mbox</span> <span class="o">=</span> <span class="n">tg3_write_indirect_mbox</span><span class="p">;</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">write32_rx_mbox</span> <span class="o">=</span> <span class="n">tg3_write_indirect_mbox</span><span class="p">;</span>

		<span class="n">iounmap</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">);</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

		<span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_COMMAND</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pci_cmd</span><span class="p">);</span>
		<span class="n">pci_cmd</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PCI_COMMAND_MEMORY</span><span class="p">;</span>
		<span class="n">pci_write_config_word</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_COMMAND</span><span class="p">,</span> <span class="n">pci_cmd</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">ASIC_REV_5906</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">read32_mbox</span> <span class="o">=</span> <span class="n">tg3_read32_mbox_5906</span><span class="p">;</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">write32_mbox</span> <span class="o">=</span> <span class="n">tg3_write32_mbox_5906</span><span class="p">;</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">write32_tx_mbox</span> <span class="o">=</span> <span class="n">tg3_write32_mbox_5906</span><span class="p">;</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">write32_rx_mbox</span> <span class="o">=</span> <span class="n">tg3_write32_mbox_5906</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">write32</span> <span class="o">==</span> <span class="n">tg3_write_indirect_reg32</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">PCIX_MODE</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	     <span class="p">(</span><span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">ASIC_REV_5700</span> <span class="o">||</span>
	      <span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">ASIC_REV_5701</span><span class="p">)))</span>
		<span class="n">tg3_flag_set</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">SRAM_USE_CONFIG</span><span class="p">);</span>

	<span class="cm">/* The memory arbiter has to be enabled in order for SRAM accesses</span>
<span class="cm">	 * to succeed.  Normally on powerup the tg3 chip firmware will make</span>
<span class="cm">	 * sure it is enabled, but other entities such as system netboot</span>
<span class="cm">	 * code might disable it.</span>
<span class="cm">	 */</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">tr32</span><span class="p">(</span><span class="n">MEMARB_MODE</span><span class="p">);</span>
	<span class="n">tw32</span><span class="p">(</span><span class="n">MEMARB_MODE</span><span class="p">,</span> <span class="n">val</span> <span class="o">|</span> <span class="n">MEMARB_MODE_ENABLE</span><span class="p">);</span>

	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_fn</span> <span class="o">=</span> <span class="n">PCI_FUNC</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">ASIC_REV_5704</span> <span class="o">||</span>
	    <span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">5780</span><span class="n">_CLASS</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">PCIX_MODE</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span>
					      <span class="n">tp</span><span class="o">-&gt;</span><span class="n">pcix_cap</span> <span class="o">+</span> <span class="n">PCI_X_STATUS</span><span class="p">,</span>
					      <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
			<span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_fn</span> <span class="o">=</span> <span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0x7</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">ASIC_REV_5717</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tg3_read_mem</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">NIC_SRAM_CPMU_STATUS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">NIC_SRAM_CPMUSTAT_SIG_MSK</span><span class="p">)</span> <span class="o">==</span>
		    <span class="n">NIC_SRAM_CPMUSTAT_SIG</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_fn</span> <span class="o">=</span> <span class="n">val</span> <span class="o">&amp;</span> <span class="n">TG3_CPMU_STATUS_FMSK_5717</span><span class="p">;</span>
			<span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_fn</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_fn</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">ASIC_REV_5719</span> <span class="o">||</span>
		   <span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">ASIC_REV_5720</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tg3_read_mem</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">NIC_SRAM_CPMU_STATUS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">NIC_SRAM_CPMUSTAT_SIG_MSK</span><span class="p">)</span> <span class="o">==</span>
		    <span class="n">NIC_SRAM_CPMUSTAT_SIG</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_fn</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">TG3_CPMU_STATUS_FMSK_5719</span><span class="p">)</span> <span class="o">&gt;&gt;</span>
				     <span class="n">TG3_CPMU_STATUS_FSHFT_5719</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Get eeprom hw config before calling tg3_set_power_state().</span>
<span class="cm">	 * In particular, the TG3_FLAG_IS_NIC flag must be</span>
<span class="cm">	 * determined before calling tg3_set_power_state() so that</span>
<span class="cm">	 * we know whether or not to switch out of Vaux power.</span>
<span class="cm">	 * When the flag is set, it means that GPIO1 is used for eeprom</span>
<span class="cm">	 * write protect and also implies that it is a LOM where GPIOs</span>
<span class="cm">	 * are not used to switch power.</span>
<span class="cm">	 */</span>
	<span class="n">tg3_get_eeprom_hw_cfg</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">fw_needed</span> <span class="o">&amp;&amp;</span> <span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">ENABLE_ASF</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">tg3_flag_clear</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">TSO_CAPABLE</span><span class="p">);</span>
		<span class="n">tg3_flag_clear</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">TSO_BUG</span><span class="p">);</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">fw_needed</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">ENABLE_APE</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Allow reads and writes to the</span>
<span class="cm">		 * APE register and memory space.</span>
<span class="cm">		 */</span>
		<span class="n">pci_state_reg</span> <span class="o">|=</span> <span class="n">PCISTATE_ALLOW_APE_CTLSPC_WR</span> <span class="o">|</span>
				 <span class="n">PCISTATE_ALLOW_APE_SHMEM_WR</span> <span class="o">|</span>
				 <span class="n">PCISTATE_ALLOW_APE_PSPACE_WR</span><span class="p">;</span>
		<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">TG3PCI_PCISTATE</span><span class="p">,</span>
				       <span class="n">pci_state_reg</span><span class="p">);</span>

		<span class="n">tg3_ape_lock_init</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Set up tp-&gt;grc_local_ctrl before calling</span>
<span class="cm">	 * tg3_pwrsrc_switch_to_vmain().  GPIO1 driven high</span>
<span class="cm">	 * will bring 5700&#39;s external PHY out of reset.</span>
<span class="cm">	 * It is also used as eeprom write protect on LOMs.</span>
<span class="cm">	 */</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">grc_local_ctrl</span> <span class="o">=</span> <span class="n">GRC_LCLCTRL_INT_ON_ATTN</span> <span class="o">|</span> <span class="n">GRC_LCLCTRL_AUTO_SEEPROM</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">ASIC_REV_5700</span> <span class="o">||</span>
	    <span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">EEPROM_WRITE_PROT</span><span class="p">))</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">grc_local_ctrl</span> <span class="o">|=</span> <span class="p">(</span><span class="n">GRC_LCLCTRL_GPIO_OE1</span> <span class="o">|</span>
				       <span class="n">GRC_LCLCTRL_GPIO_OUTPUT1</span><span class="p">);</span>
	<span class="cm">/* Unused GPIO3 must be driven as output on 5752 because there</span>
<span class="cm">	 * are no pull-up resistors on unused GPIO pins.</span>
<span class="cm">	 */</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">ASIC_REV_5752</span><span class="p">)</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">grc_local_ctrl</span> <span class="o">|=</span> <span class="n">GRC_LCLCTRL_GPIO_OE3</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">ASIC_REV_5755</span> <span class="o">||</span>
	    <span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">ASIC_REV_57780</span> <span class="o">||</span>
	    <span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">57765</span><span class="n">_CLASS</span><span class="p">))</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">grc_local_ctrl</span> <span class="o">|=</span> <span class="n">GRC_LCLCTRL_GPIO_UART_SEL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="n">PCI_DEVICE_ID_TIGON3_5761</span> <span class="o">||</span>
	    <span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="n">TG3PCI_DEVICE_TIGON3_5761S</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Turn off the debug UART. */</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">grc_local_ctrl</span> <span class="o">|=</span> <span class="n">GRC_LCLCTRL_GPIO_UART_SEL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">IS_NIC</span><span class="p">))</span>
			<span class="cm">/* Keep VMain power. */</span>
			<span class="n">tp</span><span class="o">-&gt;</span><span class="n">grc_local_ctrl</span> <span class="o">|=</span> <span class="n">GRC_LCLCTRL_GPIO_OE0</span> <span class="o">|</span>
					      <span class="n">GRC_LCLCTRL_GPIO_OUTPUT0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Switch out of Vaux if it is a NIC */</span>
	<span class="n">tg3_pwrsrc_switch_to_vmain</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>

	<span class="cm">/* Derive initial jumbo mode from MTU assigned in</span>
<span class="cm">	 * ether_setup() via the alloc_etherdev() call</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mtu</span> <span class="o">&gt;</span> <span class="n">ETH_DATA_LEN</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">5780</span><span class="n">_CLASS</span><span class="p">))</span>
		<span class="n">tg3_flag_set</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">JUMBO_RING_ENABLE</span><span class="p">);</span>

	<span class="cm">/* Determine WakeOnLan speed to use. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">ASIC_REV_5700</span> <span class="o">||</span>
	    <span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span> <span class="o">==</span> <span class="n">CHIPREV_ID_5701_A0</span> <span class="o">||</span>
	    <span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span> <span class="o">==</span> <span class="n">CHIPREV_ID_5701_B0</span> <span class="o">||</span>
	    <span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span> <span class="o">==</span> <span class="n">CHIPREV_ID_5701_B2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tg3_flag_clear</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">WOL_SPEED_100MB</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">tg3_flag_set</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">WOL_SPEED_100MB</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">ASIC_REV_5906</span><span class="p">)</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">phy_flags</span> <span class="o">|=</span> <span class="n">TG3_PHYFLG_IS_FET</span><span class="p">;</span>

	<span class="cm">/* A few boards don&#39;t want Ethernet@WireSpeed phy feature */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">ASIC_REV_5700</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">ASIC_REV_5705</span> <span class="o">&amp;&amp;</span>
	     <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span> <span class="o">!=</span> <span class="n">CHIPREV_ID_5705_A0</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	     <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span> <span class="o">!=</span> <span class="n">CHIPREV_ID_5705_A1</span><span class="p">))</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">phy_flags</span> <span class="o">&amp;</span> <span class="n">TG3_PHYFLG_IS_FET</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">phy_flags</span> <span class="o">&amp;</span> <span class="n">TG3_PHYFLG_ANY_SERDES</span><span class="p">))</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">phy_flags</span> <span class="o">|=</span> <span class="n">TG3_PHYFLG_NO_ETH_WIRE_SPEED</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">GET_CHIP_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">CHIPREV_5703_AX</span> <span class="o">||</span>
	    <span class="n">GET_CHIP_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">CHIPREV_5704_AX</span><span class="p">)</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">phy_flags</span> <span class="o">|=</span> <span class="n">TG3_PHYFLG_ADC_BUG</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span> <span class="o">==</span> <span class="n">CHIPREV_ID_5704_A0</span><span class="p">)</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">phy_flags</span> <span class="o">|=</span> <span class="n">TG3_PHYFLG_5704_A0_BUG</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">5705</span><span class="n">_PLUS</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">phy_flags</span> <span class="o">&amp;</span> <span class="n">TG3_PHYFLG_IS_FET</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">!=</span> <span class="n">ASIC_REV_5785</span> <span class="o">&amp;&amp;</span>
	    <span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">!=</span> <span class="n">ASIC_REV_57780</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">57765</span><span class="n">_PLUS</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">ASIC_REV_5755</span> <span class="o">||</span>
		    <span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">ASIC_REV_5787</span> <span class="o">||</span>
		    <span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">ASIC_REV_5784</span> <span class="o">||</span>
		    <span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">ASIC_REV_5761</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">!=</span> <span class="n">PCI_DEVICE_ID_TIGON3_5756</span> <span class="o">&amp;&amp;</span>
			    <span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">!=</span> <span class="n">PCI_DEVICE_ID_TIGON3_5722</span><span class="p">)</span>
				<span class="n">tp</span><span class="o">-&gt;</span><span class="n">phy_flags</span> <span class="o">|=</span> <span class="n">TG3_PHYFLG_JITTER_BUG</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="n">PCI_DEVICE_ID_TIGON3_5755M</span><span class="p">)</span>
				<span class="n">tp</span><span class="o">-&gt;</span><span class="n">phy_flags</span> <span class="o">|=</span> <span class="n">TG3_PHYFLG_ADJUST_TRIM</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">tp</span><span class="o">-&gt;</span><span class="n">phy_flags</span> <span class="o">|=</span> <span class="n">TG3_PHYFLG_BER_BUG</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">ASIC_REV_5784</span> <span class="o">&amp;&amp;</span>
	    <span class="n">GET_CHIP_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">!=</span> <span class="n">CHIPREV_5784_AX</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">phy_otp</span> <span class="o">=</span> <span class="n">tg3_read_otp_phycfg</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">phy_otp</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">tp</span><span class="o">-&gt;</span><span class="n">phy_otp</span> <span class="o">=</span> <span class="n">TG3_OTP_DEFAULT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">CPMU_PRESENT</span><span class="p">))</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">mi_mode</span> <span class="o">=</span> <span class="n">MAC_MI_MODE_500KHZ_CONST</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">mi_mode</span> <span class="o">=</span> <span class="n">MAC_MI_MODE_BASE</span><span class="p">;</span>

	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">coalesce_mode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">GET_CHIP_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">!=</span> <span class="n">CHIPREV_5700_AX</span> <span class="o">&amp;&amp;</span>
	    <span class="n">GET_CHIP_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">!=</span> <span class="n">CHIPREV_5700_BX</span><span class="p">)</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">coalesce_mode</span> <span class="o">|=</span> <span class="n">HOSTCC_MODE_32BYTE</span><span class="p">;</span>

	<span class="cm">/* Set these bits to enable statistics workaround. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">ASIC_REV_5717</span> <span class="o">||</span>
	    <span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span> <span class="o">==</span> <span class="n">CHIPREV_ID_5719_A0</span> <span class="o">||</span>
	    <span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span> <span class="o">==</span> <span class="n">CHIPREV_ID_5720_A0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">coalesce_mode</span> <span class="o">|=</span> <span class="n">HOSTCC_MODE_ATTN</span><span class="p">;</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">grc_mode</span> <span class="o">|=</span> <span class="n">GRC_MODE_IRQ_ON_FLOW_ATTN</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">ASIC_REV_5785</span> <span class="o">||</span>
	    <span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">ASIC_REV_57780</span><span class="p">)</span>
		<span class="n">tg3_flag_set</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">USE_PHYLIB</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">tg3_mdio_init</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="cm">/* Initialize data/descriptor byte/word swapping. */</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">tr32</span><span class="p">(</span><span class="n">GRC_MODE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">ASIC_REV_5720</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="n">GRC_MODE_BYTE_SWAP_B2HRX_DATA</span> <span class="o">|</span>
			<span class="n">GRC_MODE_WORD_SWAP_B2HRX_DATA</span> <span class="o">|</span>
			<span class="n">GRC_MODE_B2HRX_ENABLE</span> <span class="o">|</span>
			<span class="n">GRC_MODE_HTX2B_ENABLE</span> <span class="o">|</span>
			<span class="n">GRC_MODE_HOST_STACKUP</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">val</span> <span class="o">&amp;=</span> <span class="n">GRC_MODE_HOST_STACKUP</span><span class="p">;</span>

	<span class="n">tw32</span><span class="p">(</span><span class="n">GRC_MODE</span><span class="p">,</span> <span class="n">val</span> <span class="o">|</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">grc_mode</span><span class="p">);</span>

	<span class="n">tg3_switch_clocks</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>

	<span class="cm">/* Clear this out for sanity. */</span>
	<span class="n">tw32</span><span class="p">(</span><span class="n">TG3PCI_MEM_WIN_BASE_ADDR</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">TG3PCI_PCISTATE</span><span class="p">,</span>
			      <span class="o">&amp;</span><span class="n">pci_state_reg</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">pci_state_reg</span> <span class="o">&amp;</span> <span class="n">PCISTATE_CONV_PCI_MODE</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">PCIX_TARGET_HWBUG</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">chiprevid</span> <span class="o">=</span> <span class="n">GET_CHIP_REV_ID</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">misc_host_ctrl</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">chiprevid</span> <span class="o">==</span> <span class="n">CHIPREV_ID_5701_A0</span> <span class="o">||</span>
		    <span class="n">chiprevid</span> <span class="o">==</span> <span class="n">CHIPREV_ID_5701_B0</span> <span class="o">||</span>
		    <span class="n">chiprevid</span> <span class="o">==</span> <span class="n">CHIPREV_ID_5701_B2</span> <span class="o">||</span>
		    <span class="n">chiprevid</span> <span class="o">==</span> <span class="n">CHIPREV_ID_5701_B5</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">sram_base</span><span class="p">;</span>

			<span class="cm">/* Write some dummy words into the SRAM status block</span>
<span class="cm">			 * area, see if it reads back correctly.  If the return</span>
<span class="cm">			 * value is bad, force enable the PCIX workaround.</span>
<span class="cm">			 */</span>
			<span class="n">sram_base</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">NIC_SRAM_WIN_BASE</span> <span class="o">+</span> <span class="n">NIC_SRAM_STATS_BLK</span><span class="p">;</span>

			<span class="n">writel</span><span class="p">(</span><span class="mh">0x00000000</span><span class="p">,</span> <span class="n">sram_base</span><span class="p">);</span>
			<span class="n">writel</span><span class="p">(</span><span class="mh">0x00000000</span><span class="p">,</span> <span class="n">sram_base</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>
			<span class="n">writel</span><span class="p">(</span><span class="mh">0xffffffff</span><span class="p">,</span> <span class="n">sram_base</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">sram_base</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x00000000</span><span class="p">)</span>
				<span class="n">tg3_flag_set</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">PCIX_TARGET_HWBUG</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">udelay</span><span class="p">(</span><span class="mi">50</span><span class="p">);</span>
	<span class="n">tg3_nvram_init</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>

	<span class="n">grc_misc_cfg</span> <span class="o">=</span> <span class="n">tr32</span><span class="p">(</span><span class="n">GRC_MISC_CFG</span><span class="p">);</span>
	<span class="n">grc_misc_cfg</span> <span class="o">&amp;=</span> <span class="n">GRC_MISC_CFG_BOARD_ID_MASK</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">ASIC_REV_5705</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">grc_misc_cfg</span> <span class="o">==</span> <span class="n">GRC_MISC_CFG_BOARD_ID_5788</span> <span class="o">||</span>
	     <span class="n">grc_misc_cfg</span> <span class="o">==</span> <span class="n">GRC_MISC_CFG_BOARD_ID_5788M</span><span class="p">))</span>
		<span class="n">tg3_flag_set</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">IS_5788</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">IS_5788</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">!=</span> <span class="n">ASIC_REV_5700</span><span class="p">)</span>
		<span class="n">tg3_flag_set</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">TAGGED_STATUS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">TAGGED_STATUS</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">coalesce_mode</span> <span class="o">|=</span> <span class="p">(</span><span class="n">HOSTCC_MODE_CLRTICK_RXBD</span> <span class="o">|</span>
				      <span class="n">HOSTCC_MODE_CLRTICK_TXBD</span><span class="p">);</span>

		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">misc_host_ctrl</span> <span class="o">|=</span> <span class="n">MISC_HOST_CTRL_TAGGED_STATUS</span><span class="p">;</span>
		<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">TG3PCI_MISC_HOST_CTRL</span><span class="p">,</span>
				       <span class="n">tp</span><span class="o">-&gt;</span><span class="n">misc_host_ctrl</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Preserve the APE MAC_MODE bits */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">ENABLE_APE</span><span class="p">))</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">mac_mode</span> <span class="o">=</span> <span class="n">MAC_MODE_APE_TX_EN</span> <span class="o">|</span> <span class="n">MAC_MODE_APE_RX_EN</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">mac_mode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* these are limited to 10/100 only */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">ASIC_REV_5703</span> <span class="o">&amp;&amp;</span>
	     <span class="p">(</span><span class="n">grc_misc_cfg</span> <span class="o">==</span> <span class="mh">0x8000</span> <span class="o">||</span> <span class="n">grc_misc_cfg</span> <span class="o">==</span> <span class="mh">0x4000</span><span class="p">))</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">ASIC_REV_5705</span> <span class="o">&amp;&amp;</span>
	     <span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">vendor</span> <span class="o">==</span> <span class="n">PCI_VENDOR_ID_BROADCOM</span> <span class="o">&amp;&amp;</span>
	     <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="n">PCI_DEVICE_ID_TIGON3_5901</span> <span class="o">||</span>
	      <span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="n">PCI_DEVICE_ID_TIGON3_5901_2</span> <span class="o">||</span>
	      <span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="n">PCI_DEVICE_ID_TIGON3_5705F</span><span class="p">))</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">vendor</span> <span class="o">==</span> <span class="n">PCI_VENDOR_ID_BROADCOM</span> <span class="o">&amp;&amp;</span>
	     <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="n">PCI_DEVICE_ID_TIGON3_5751F</span> <span class="o">||</span>
	      <span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="n">PCI_DEVICE_ID_TIGON3_5753F</span> <span class="o">||</span>
	      <span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="n">PCI_DEVICE_ID_TIGON3_5787F</span><span class="p">))</span> <span class="o">||</span>
	    <span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="n">TG3PCI_DEVICE_TIGON3_57790</span> <span class="o">||</span>
	    <span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="n">TG3PCI_DEVICE_TIGON3_57791</span> <span class="o">||</span>
	    <span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="n">TG3PCI_DEVICE_TIGON3_57795</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">phy_flags</span> <span class="o">&amp;</span> <span class="n">TG3_PHYFLG_IS_FET</span><span class="p">))</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">phy_flags</span> <span class="o">|=</span> <span class="n">TG3_PHYFLG_10_100_ONLY</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">tg3_phy_probe</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;phy probe failed, err %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
		<span class="cm">/* ... but do not return immediately ... */</span>
		<span class="n">tg3_mdio_fini</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">tg3_read_vpd</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
	<span class="n">tg3_read_fw_ver</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">phy_flags</span> <span class="o">&amp;</span> <span class="n">TG3_PHYFLG_PHY_SERDES</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">phy_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">TG3_PHYFLG_USE_MI_INTERRUPT</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">ASIC_REV_5700</span><span class="p">)</span>
			<span class="n">tp</span><span class="o">-&gt;</span><span class="n">phy_flags</span> <span class="o">|=</span> <span class="n">TG3_PHYFLG_USE_MI_INTERRUPT</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">tp</span><span class="o">-&gt;</span><span class="n">phy_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">TG3_PHYFLG_USE_MI_INTERRUPT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* 5700 {AX,BX} chips have a broken status block link</span>
<span class="cm">	 * change bit implementation, so we must use the</span>
<span class="cm">	 * status register in those cases.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">ASIC_REV_5700</span><span class="p">)</span>
		<span class="n">tg3_flag_set</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">USE_LINKCHG_REG</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">tg3_flag_clear</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">USE_LINKCHG_REG</span><span class="p">);</span>

	<span class="cm">/* The led_ctrl is set during tg3_phy_probe, here we might</span>
<span class="cm">	 * have to force the link status polling mechanism based</span>
<span class="cm">	 * upon subsystem IDs.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">subsystem_vendor</span> <span class="o">==</span> <span class="n">PCI_VENDOR_ID_DELL</span> <span class="o">&amp;&amp;</span>
	    <span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">ASIC_REV_5701</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">phy_flags</span> <span class="o">&amp;</span> <span class="n">TG3_PHYFLG_PHY_SERDES</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">phy_flags</span> <span class="o">|=</span> <span class="n">TG3_PHYFLG_USE_MI_INTERRUPT</span><span class="p">;</span>
		<span class="n">tg3_flag_set</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">USE_LINKCHG_REG</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* For all SERDES we poll the MAC status register. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">phy_flags</span> <span class="o">&amp;</span> <span class="n">TG3_PHYFLG_PHY_SERDES</span><span class="p">)</span>
		<span class="n">tg3_flag_set</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">POLL_SERDES</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">tg3_flag_clear</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">POLL_SERDES</span><span class="p">);</span>

	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">rx_offset</span> <span class="o">=</span> <span class="n">NET_SKB_PAD</span> <span class="o">+</span> <span class="n">NET_IP_ALIGN</span><span class="p">;</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">rx_copy_thresh</span> <span class="o">=</span> <span class="n">TG3_RX_COPY_THRESHOLD</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">ASIC_REV_5701</span> <span class="o">&amp;&amp;</span>
	    <span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">PCIX_MODE</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">rx_offset</span> <span class="o">=</span> <span class="n">NET_SKB_PAD</span><span class="p">;</span>
<span class="cp">#ifndef CONFIG_HAVE_EFFICIENT_UNALIGNED_ACCESS</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">rx_copy_thresh</span> <span class="o">=</span> <span class="o">~</span><span class="p">(</span><span class="n">u16</span><span class="p">)</span><span class="mi">0</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="p">}</span>

	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">rx_std_ring_mask</span> <span class="o">=</span> <span class="n">TG3_RX_STD_RING_SIZE</span><span class="p">(</span><span class="n">tp</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">rx_jmb_ring_mask</span> <span class="o">=</span> <span class="n">TG3_RX_JMB_RING_SIZE</span><span class="p">(</span><span class="n">tp</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">rx_ret_ring_mask</span> <span class="o">=</span> <span class="n">tg3_rx_ret_ring_size</span><span class="p">(</span><span class="n">tp</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">rx_std_max_post</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">rx_std_ring_mask</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* Increment the rx prod index on the rx std ring by at most</span>
<span class="cm">	 * 8 for these chips to workaround hw errata.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">ASIC_REV_5750</span> <span class="o">||</span>
	    <span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">ASIC_REV_5752</span> <span class="o">||</span>
	    <span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">ASIC_REV_5755</span><span class="p">)</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">rx_std_max_post</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">ASPM_WORKAROUND</span><span class="p">))</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">pwrmgmt_thresh</span> <span class="o">=</span> <span class="n">tr32</span><span class="p">(</span><span class="n">PCIE_PWR_MGMT_THRESH</span><span class="p">)</span> <span class="o">&amp;</span>
				     <span class="n">PCIE_PWR_MGMT_L1_THRESH_MSK</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_SPARC</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">tg3_get_macaddr_sparc</span><span class="p">(</span><span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">dp</span> <span class="o">=</span> <span class="n">pci_device_to_OF_node</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">addr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">;</span>

	<span class="n">addr</span> <span class="o">=</span> <span class="n">of_get_property</span><span class="p">(</span><span class="n">dp</span><span class="p">,</span> <span class="s">&quot;local-mac-address&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">addr</span> <span class="o">&amp;&amp;</span> <span class="n">len</span> <span class="o">==</span> <span class="mi">6</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">perm_addr</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">tg3_get_default_macaddr_sparc</span><span class="p">(</span><span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">idprom</span><span class="o">-&gt;</span><span class="n">id_ethaddr</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">perm_addr</span><span class="p">,</span> <span class="n">idprom</span><span class="o">-&gt;</span><span class="n">id_ethaddr</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">tg3_get_device_address</span><span class="p">(</span><span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">hi</span><span class="p">,</span> <span class="n">lo</span><span class="p">,</span> <span class="n">mac_offset</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">addr_ok</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_SPARC</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tg3_get_macaddr_sparc</span><span class="p">(</span><span class="n">tp</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="n">mac_offset</span> <span class="o">=</span> <span class="mh">0x7c</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">ASIC_REV_5704</span> <span class="o">||</span>
	    <span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">5780</span><span class="n">_CLASS</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tr32</span><span class="p">(</span><span class="n">TG3PCI_DUAL_MAC_CTRL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">DUAL_MAC_CTRL_ID</span><span class="p">)</span>
			<span class="n">mac_offset</span> <span class="o">=</span> <span class="mh">0xcc</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tg3_nvram_lock</span><span class="p">(</span><span class="n">tp</span><span class="p">))</span>
			<span class="n">tw32_f</span><span class="p">(</span><span class="n">NVRAM_CMD</span><span class="p">,</span> <span class="n">NVRAM_CMD_RESET</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">tg3_nvram_unlock</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">5717</span><span class="n">_PLUS</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_fn</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">mac_offset</span> <span class="o">=</span> <span class="mh">0xcc</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_fn</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">mac_offset</span> <span class="o">+=</span> <span class="mh">0x18c</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">ASIC_REV_5906</span><span class="p">)</span>
		<span class="n">mac_offset</span> <span class="o">=</span> <span class="mh">0x10</span><span class="p">;</span>

	<span class="cm">/* First try to get it from MAC address mailbox. */</span>
	<span class="n">tg3_read_mem</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">NIC_SRAM_MAC_ADDR_HIGH_MBOX</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hi</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">hi</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x484b</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">hi</span> <span class="o">&gt;&gt;</span>  <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">hi</span> <span class="o">&gt;&gt;</span>  <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>

		<span class="n">tg3_read_mem</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">NIC_SRAM_MAC_ADDR_LOW_MBOX</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lo</span><span class="p">);</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">lo</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">lo</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">lo</span> <span class="o">&gt;&gt;</span>  <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">lo</span> <span class="o">&gt;&gt;</span>  <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>

		<span class="cm">/* Some old bootcode may report a 0 MAC address in SRAM */</span>
		<span class="n">addr_ok</span> <span class="o">=</span> <span class="n">is_valid_ether_addr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">addr_ok</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Next, try NVRAM. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">NO_NVRAM</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="o">!</span><span class="n">tg3_nvram_read_be32</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">mac_offset</span> <span class="o">+</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hi</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="o">!</span><span class="n">tg3_nvram_read_be32</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">mac_offset</span> <span class="o">+</span> <span class="mi">4</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lo</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">hi</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">lo</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">lo</span><span class="p">));</span>
		<span class="p">}</span>
		<span class="cm">/* Finally just fetch it out of the MAC control regs. */</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">hi</span> <span class="o">=</span> <span class="n">tr32</span><span class="p">(</span><span class="n">MAC_ADDR_0_HIGH</span><span class="p">);</span>
			<span class="n">lo</span> <span class="o">=</span> <span class="n">tr32</span><span class="p">(</span><span class="n">MAC_ADDR_0_LOW</span><span class="p">);</span>

			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">lo</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">lo</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">lo</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">lo</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">hi</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">hi</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_valid_ether_addr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span> <span class="p">{</span>
<span class="cp">#ifdef CONFIG_SPARC</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tg3_get_default_macaddr_sparc</span><span class="p">(</span><span class="n">tp</span><span class="p">))</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#endif</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">perm_addr</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">addr_len</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define BOUNDARY_SINGLE_CACHELINE	1</span>
<span class="cp">#define BOUNDARY_MULTI_CACHELINE	2</span>

<span class="k">static</span> <span class="n">u32</span> <span class="n">__devinit</span> <span class="nf">tg3_calc_dma_bndry</span><span class="p">(</span><span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span><span class="p">,</span> <span class="n">u32</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">cacheline_size</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">byte</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">goal</span><span class="p">;</span>

	<span class="n">pci_read_config_byte</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_CACHE_LINE_SIZE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">byte</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">byte</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">cacheline_size</span> <span class="o">=</span> <span class="mi">1024</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">cacheline_size</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">byte</span> <span class="o">*</span> <span class="mi">4</span><span class="p">;</span>

	<span class="cm">/* On 5703 and later chips, the boundary bits have no</span>
<span class="cm">	 * effect.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">!=</span> <span class="n">ASIC_REV_5700</span> <span class="o">&amp;&amp;</span>
	    <span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">!=</span> <span class="n">ASIC_REV_5701</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">PCI_EXPRESS</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

<span class="cp">#if defined(CONFIG_PPC64) || defined(CONFIG_IA64) || defined(CONFIG_PARISC)</span>
	<span class="n">goal</span> <span class="o">=</span> <span class="n">BOUNDARY_MULTI_CACHELINE</span><span class="p">;</span>
<span class="cp">#else</span>
<span class="cp">#if defined(CONFIG_SPARC64) || defined(CONFIG_ALPHA)</span>
	<span class="n">goal</span> <span class="o">=</span> <span class="n">BOUNDARY_SINGLE_CACHELINE</span><span class="p">;</span>
<span class="cp">#else</span>
	<span class="n">goal</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">57765</span><span class="n">_PLUS</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">goal</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">DMA_RWCTRL_DIS_CACHE_ALIGNMENT</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">goal</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="cm">/* PCI controllers on most RISC systems tend to disconnect</span>
<span class="cm">	 * when a device tries to burst across a cache-line boundary.</span>
<span class="cm">	 * Therefore, letting tg3 do so just wastes PCI bandwidth.</span>
<span class="cm">	 *</span>
<span class="cm">	 * Unfortunately, for PCI-E there are only limited</span>
<span class="cm">	 * write-side controls for this, and thus for reads</span>
<span class="cm">	 * we will still get the disconnects.  We&#39;ll also waste</span>
<span class="cm">	 * these PCI cycles for both read and write for chips</span>
<span class="cm">	 * other than 5700 and 5701 which do not implement the</span>
<span class="cm">	 * boundary bits.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">PCIX_MODE</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">PCI_EXPRESS</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">cacheline_size</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">16</span>:
		<span class="k">case</span> <span class="mi">32</span>:
		<span class="k">case</span> <span class="mi">64</span>:
		<span class="k">case</span> <span class="mi">128</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">goal</span> <span class="o">==</span> <span class="n">BOUNDARY_SINGLE_CACHELINE</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">val</span> <span class="o">|=</span> <span class="p">(</span><span class="n">DMA_RWCTRL_READ_BNDRY_128_PCIX</span> <span class="o">|</span>
					<span class="n">DMA_RWCTRL_WRITE_BNDRY_128_PCIX</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">val</span> <span class="o">|=</span> <span class="p">(</span><span class="n">DMA_RWCTRL_READ_BNDRY_384_PCIX</span> <span class="o">|</span>
					<span class="n">DMA_RWCTRL_WRITE_BNDRY_384_PCIX</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="mi">256</span>:
			<span class="n">val</span> <span class="o">|=</span> <span class="p">(</span><span class="n">DMA_RWCTRL_READ_BNDRY_256_PCIX</span> <span class="o">|</span>
				<span class="n">DMA_RWCTRL_WRITE_BNDRY_256_PCIX</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="nl">default:</span>
			<span class="n">val</span> <span class="o">|=</span> <span class="p">(</span><span class="n">DMA_RWCTRL_READ_BNDRY_384_PCIX</span> <span class="o">|</span>
				<span class="n">DMA_RWCTRL_WRITE_BNDRY_384_PCIX</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">PCI_EXPRESS</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">cacheline_size</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">16</span>:
		<span class="k">case</span> <span class="mi">32</span>:
		<span class="k">case</span> <span class="mi">64</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">goal</span> <span class="o">==</span> <span class="n">BOUNDARY_SINGLE_CACHELINE</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">DMA_RWCTRL_WRITE_BNDRY_DISAB_PCIE</span><span class="p">;</span>
				<span class="n">val</span> <span class="o">|=</span> <span class="n">DMA_RWCTRL_WRITE_BNDRY_64_PCIE</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="cm">/* fallthrough */</span>
		<span class="k">case</span> <span class="mi">128</span>:
		<span class="nl">default:</span>
			<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">DMA_RWCTRL_WRITE_BNDRY_DISAB_PCIE</span><span class="p">;</span>
			<span class="n">val</span> <span class="o">|=</span> <span class="n">DMA_RWCTRL_WRITE_BNDRY_128_PCIE</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">cacheline_size</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">16</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">goal</span> <span class="o">==</span> <span class="n">BOUNDARY_SINGLE_CACHELINE</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">val</span> <span class="o">|=</span> <span class="p">(</span><span class="n">DMA_RWCTRL_READ_BNDRY_16</span> <span class="o">|</span>
					<span class="n">DMA_RWCTRL_WRITE_BNDRY_16</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="cm">/* fallthrough */</span>
		<span class="k">case</span> <span class="mi">32</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">goal</span> <span class="o">==</span> <span class="n">BOUNDARY_SINGLE_CACHELINE</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">val</span> <span class="o">|=</span> <span class="p">(</span><span class="n">DMA_RWCTRL_READ_BNDRY_32</span> <span class="o">|</span>
					<span class="n">DMA_RWCTRL_WRITE_BNDRY_32</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="cm">/* fallthrough */</span>
		<span class="k">case</span> <span class="mi">64</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">goal</span> <span class="o">==</span> <span class="n">BOUNDARY_SINGLE_CACHELINE</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">val</span> <span class="o">|=</span> <span class="p">(</span><span class="n">DMA_RWCTRL_READ_BNDRY_64</span> <span class="o">|</span>
					<span class="n">DMA_RWCTRL_WRITE_BNDRY_64</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="cm">/* fallthrough */</span>
		<span class="k">case</span> <span class="mi">128</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">goal</span> <span class="o">==</span> <span class="n">BOUNDARY_SINGLE_CACHELINE</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">val</span> <span class="o">|=</span> <span class="p">(</span><span class="n">DMA_RWCTRL_READ_BNDRY_128</span> <span class="o">|</span>
					<span class="n">DMA_RWCTRL_WRITE_BNDRY_128</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="cm">/* fallthrough */</span>
		<span class="k">case</span> <span class="mi">256</span>:
			<span class="n">val</span> <span class="o">|=</span> <span class="p">(</span><span class="n">DMA_RWCTRL_READ_BNDRY_256</span> <span class="o">|</span>
				<span class="n">DMA_RWCTRL_WRITE_BNDRY_256</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">512</span>:
			<span class="n">val</span> <span class="o">|=</span> <span class="p">(</span><span class="n">DMA_RWCTRL_READ_BNDRY_512</span> <span class="o">|</span>
				<span class="n">DMA_RWCTRL_WRITE_BNDRY_512</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">1024</span>:
		<span class="nl">default:</span>
			<span class="n">val</span> <span class="o">|=</span> <span class="p">(</span><span class="n">DMA_RWCTRL_READ_BNDRY_1024</span> <span class="o">|</span>
				<span class="n">DMA_RWCTRL_WRITE_BNDRY_1024</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">val</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">tg3_do_test_dma</span><span class="p">(</span><span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="n">dma_addr_t</span> <span class="n">buf_dma</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">,</span> <span class="kt">int</span> <span class="n">to_device</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tg3_internal_buffer_desc</span> <span class="n">test_desc</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">sram_dma_descs</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">sram_dma_descs</span> <span class="o">=</span> <span class="n">NIC_SRAM_DMA_DESC_POOL_BASE</span><span class="p">;</span>

	<span class="n">tw32</span><span class="p">(</span><span class="n">FTQ_RCVBD_COMP_FIFO_ENQDEQ</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">tw32</span><span class="p">(</span><span class="n">FTQ_RCVDATA_COMP_FIFO_ENQDEQ</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">tw32</span><span class="p">(</span><span class="n">RDMAC_STATUS</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">tw32</span><span class="p">(</span><span class="n">WDMAC_STATUS</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">tw32</span><span class="p">(</span><span class="n">BUFMGR_MODE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">tw32</span><span class="p">(</span><span class="n">FTQ_RESET</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">test_desc</span><span class="p">.</span><span class="n">addr_hi</span> <span class="o">=</span> <span class="p">((</span><span class="n">u64</span><span class="p">)</span> <span class="n">buf_dma</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">;</span>
	<span class="n">test_desc</span><span class="p">.</span><span class="n">addr_lo</span> <span class="o">=</span> <span class="n">buf_dma</span> <span class="o">&amp;</span> <span class="mh">0xffffffff</span><span class="p">;</span>
	<span class="n">test_desc</span><span class="p">.</span><span class="n">nic_mbuf</span> <span class="o">=</span> <span class="mh">0x00002100</span><span class="p">;</span>
	<span class="n">test_desc</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * HP ZX1 was seeing test failures for 5701 cards running at 33Mhz</span>
<span class="cm">	 * the *second* time the tg3 driver was getting loaded after an</span>
<span class="cm">	 * initial scan.</span>
<span class="cm">	 *</span>
<span class="cm">	 * Broadcom tells me:</span>
<span class="cm">	 *   ...the DMA engine is connected to the GRC block and a DMA</span>
<span class="cm">	 *   reset may affect the GRC block in some unpredictable way...</span>
<span class="cm">	 *   The behavior of resets to individual blocks has not been tested.</span>
<span class="cm">	 *</span>
<span class="cm">	 * Broadcom noted the GRC reset will also reset all sub-components.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">to_device</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">test_desc</span><span class="p">.</span><span class="n">cqid_sqid</span> <span class="o">=</span> <span class="p">(</span><span class="mi">13</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="mi">2</span><span class="p">;</span>

		<span class="n">tw32_f</span><span class="p">(</span><span class="n">RDMAC_MODE</span><span class="p">,</span> <span class="n">RDMAC_MODE_ENABLE</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">40</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">test_desc</span><span class="p">.</span><span class="n">cqid_sqid</span> <span class="o">=</span> <span class="p">(</span><span class="mi">16</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="mi">7</span><span class="p">;</span>

		<span class="n">tw32_f</span><span class="p">(</span><span class="n">WDMAC_MODE</span><span class="p">,</span> <span class="n">WDMAC_MODE_ENABLE</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">40</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">test_desc</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="mh">0x00000005</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">test_desc</span><span class="p">)</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">));</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>

		<span class="n">val</span> <span class="o">=</span> <span class="o">*</span><span class="p">(((</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">test_desc</span><span class="p">)</span> <span class="o">+</span> <span class="n">i</span><span class="p">);</span>
		<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">TG3PCI_MEM_WIN_BASE_ADDR</span><span class="p">,</span>
				       <span class="n">sram_dma_descs</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">)));</span>
		<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">TG3PCI_MEM_WIN_DATA</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">TG3PCI_MEM_WIN_BASE_ADDR</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">to_device</span><span class="p">)</span>
		<span class="n">tw32</span><span class="p">(</span><span class="n">FTQ_DMA_HIGH_READ_FIFO_ENQDEQ</span><span class="p">,</span> <span class="n">sram_dma_descs</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">tw32</span><span class="p">(</span><span class="n">FTQ_DMA_HIGH_WRITE_FIFO_ENQDEQ</span><span class="p">,</span> <span class="n">sram_dma_descs</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">40</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">to_device</span><span class="p">)</span>
			<span class="n">val</span> <span class="o">=</span> <span class="n">tr32</span><span class="p">(</span><span class="n">FTQ_RCVBD_COMP_FIFO_ENQDEQ</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">val</span> <span class="o">=</span> <span class="n">tr32</span><span class="p">(</span><span class="n">FTQ_RCVDATA_COMP_FIFO_ENQDEQ</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">)</span> <span class="o">==</span> <span class="n">sram_dma_descs</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">udelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define TEST_BUFFER_SIZE	0x2000</span>

<span class="k">static</span> <span class="n">DEFINE_PCI_DEVICE_TABLE</span><span class="p">(</span><span class="n">tg3_dma_wait_state_chipsets</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_APPLE</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_APPLE_UNI_N_PCI15</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">tg3_test_dma</span><span class="p">(</span><span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dma_addr_t</span> <span class="n">buf_dma</span><span class="p">;</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="n">saved_dma_rwctrl</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">buf</span> <span class="o">=</span> <span class="n">dma_alloc_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">TEST_BUFFER_SIZE</span><span class="p">,</span>
				 <span class="o">&amp;</span><span class="n">buf_dma</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buf</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_nofree</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">dma_rwctrl</span> <span class="o">=</span> <span class="p">((</span><span class="mh">0x7</span> <span class="o">&lt;&lt;</span> <span class="n">DMA_RWCTRL_PCI_WRITE_CMD_SHIFT</span><span class="p">)</span> <span class="o">|</span>
			  <span class="p">(</span><span class="mh">0x6</span> <span class="o">&lt;&lt;</span> <span class="n">DMA_RWCTRL_PCI_READ_CMD_SHIFT</span><span class="p">));</span>

	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">dma_rwctrl</span> <span class="o">=</span> <span class="n">tg3_calc_dma_bndry</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">dma_rwctrl</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">57765</span><span class="n">_PLUS</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">PCI_EXPRESS</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* DMA read watermark not used on PCIE */</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">dma_rwctrl</span> <span class="o">|=</span> <span class="mh">0x00180000</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">PCIX_MODE</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">ASIC_REV_5705</span> <span class="o">||</span>
		    <span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">ASIC_REV_5750</span><span class="p">)</span>
			<span class="n">tp</span><span class="o">-&gt;</span><span class="n">dma_rwctrl</span> <span class="o">|=</span> <span class="mh">0x003f0000</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">tp</span><span class="o">-&gt;</span><span class="n">dma_rwctrl</span> <span class="o">|=</span> <span class="mh">0x003f000f</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">ASIC_REV_5703</span> <span class="o">||</span>
		    <span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">ASIC_REV_5704</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u32</span> <span class="n">ccval</span> <span class="o">=</span> <span class="p">(</span><span class="n">tr32</span><span class="p">(</span><span class="n">TG3PCI_CLOCK_CTRL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">);</span>
			<span class="n">u32</span> <span class="n">read_water</span> <span class="o">=</span> <span class="mh">0x7</span><span class="p">;</span>

			<span class="cm">/* If the 5704 is behind the EPB bridge, we can</span>
<span class="cm">			 * do the less restrictive ONE_DMA workaround for</span>
<span class="cm">			 * better performance.</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">40</span><span class="n">BIT_DMA_BUG</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">ASIC_REV_5704</span><span class="p">)</span>
				<span class="n">tp</span><span class="o">-&gt;</span><span class="n">dma_rwctrl</span> <span class="o">|=</span> <span class="mh">0x8000</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ccval</span> <span class="o">==</span> <span class="mh">0x6</span> <span class="o">||</span> <span class="n">ccval</span> <span class="o">==</span> <span class="mh">0x7</span><span class="p">)</span>
				<span class="n">tp</span><span class="o">-&gt;</span><span class="n">dma_rwctrl</span> <span class="o">|=</span> <span class="n">DMA_RWCTRL_ONE_DMA</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">ASIC_REV_5703</span><span class="p">)</span>
				<span class="n">read_water</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
			<span class="cm">/* Set bit 23 to enable PCIX hw bug fix */</span>
			<span class="n">tp</span><span class="o">-&gt;</span><span class="n">dma_rwctrl</span> <span class="o">|=</span>
				<span class="p">(</span><span class="n">read_water</span> <span class="o">&lt;&lt;</span> <span class="n">DMA_RWCTRL_READ_WATER_SHIFT</span><span class="p">)</span> <span class="o">|</span>
				<span class="p">(</span><span class="mh">0x3</span> <span class="o">&lt;&lt;</span> <span class="n">DMA_RWCTRL_WRITE_WATER_SHIFT</span><span class="p">)</span> <span class="o">|</span>
				<span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">23</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">ASIC_REV_5780</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* 5780 always in PCIX mode */</span>
			<span class="n">tp</span><span class="o">-&gt;</span><span class="n">dma_rwctrl</span> <span class="o">|=</span> <span class="mh">0x00144000</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">ASIC_REV_5714</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* 5714 always in PCIX mode */</span>
			<span class="n">tp</span><span class="o">-&gt;</span><span class="n">dma_rwctrl</span> <span class="o">|=</span> <span class="mh">0x00148000</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">tp</span><span class="o">-&gt;</span><span class="n">dma_rwctrl</span> <span class="o">|=</span> <span class="mh">0x001b000f</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">ASIC_REV_5703</span> <span class="o">||</span>
	    <span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">ASIC_REV_5704</span><span class="p">)</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">dma_rwctrl</span> <span class="o">&amp;=</span> <span class="mh">0xfffffff0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">ASIC_REV_5700</span> <span class="o">||</span>
	    <span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">ASIC_REV_5701</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Remove this if it causes problems for some boards. */</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">dma_rwctrl</span> <span class="o">|=</span> <span class="n">DMA_RWCTRL_USE_MEM_READ_MULT</span><span class="p">;</span>

		<span class="cm">/* On 5700/5701 chips, we need to set this bit.</span>
<span class="cm">		 * Otherwise the chip will issue cacheline transactions</span>
<span class="cm">		 * to streamable DMA memory with not all the byte</span>
<span class="cm">		 * enables turned on.  This is an error on several</span>
<span class="cm">		 * RISC PCI controllers, in particular sparc64.</span>
<span class="cm">		 *</span>
<span class="cm">		 * On 5703/5704 chips, this bit has been reassigned</span>
<span class="cm">		 * a different meaning.  In particular, it is used</span>
<span class="cm">		 * on those chips to enable a PCI-X workaround.</span>
<span class="cm">		 */</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">dma_rwctrl</span> <span class="o">|=</span> <span class="n">DMA_RWCTRL_ASSERT_ALL_BE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">tw32</span><span class="p">(</span><span class="n">TG3PCI_DMA_RW_CTRL</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">dma_rwctrl</span><span class="p">);</span>

<span class="cp">#if 0</span><span class="c"></span>
<span class="c">	/* Unneeded, already done by tg3_get_invariants.  */</span>
<span class="c">	tg3_switch_clocks(tp);</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">!=</span> <span class="n">ASIC_REV_5700</span> <span class="o">&amp;&amp;</span>
	    <span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">!=</span> <span class="n">ASIC_REV_5701</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="cm">/* It is best to perform DMA test with maximum write burst size</span>
<span class="cm">	 * to expose the 5700/5701 write DMA bug.</span>
<span class="cm">	 */</span>
	<span class="n">saved_dma_rwctrl</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">dma_rwctrl</span><span class="p">;</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">dma_rwctrl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">DMA_RWCTRL_WRITE_BNDRY_MASK</span><span class="p">;</span>
	<span class="n">tw32</span><span class="p">(</span><span class="n">TG3PCI_DMA_RW_CTRL</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">dma_rwctrl</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">buf</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">TEST_BUFFER_SIZE</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">p</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>

		<span class="cm">/* Send the buffer to the chip. */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">tg3_do_test_dma</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">buf_dma</span><span class="p">,</span> <span class="n">TEST_BUFFER_SIZE</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;%s: Buffer write failed. err = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

<span class="cp">#if 0</span><span class="c"></span>
<span class="c">		/* validate data reached card RAM correctly. */</span>
<span class="c">		for (i = 0; i &lt; TEST_BUFFER_SIZE / sizeof(u32); i++) {</span>
<span class="c">			u32 val;</span>
<span class="c">			tg3_read_mem(tp, 0x2100 + (i*4), &amp;val);</span>
<span class="c">			if (le32_to_cpu(val) != p[i]) {</span>
<span class="c">				dev_err(&amp;tp-&gt;pdev-&gt;dev,</span>
<span class="c">					&quot;%s: Buffer corrupted on device! &quot;</span>
<span class="c">					&quot;(%d != %d)\n&quot;, __func__, val, i);</span>
<span class="c">				/* ret = -ENODEV here? */</span>
<span class="c">			}</span>
<span class="c">			p[i] = 0;</span>
<span class="c">		}</span>
<span class="cp">#endif</span>
		<span class="cm">/* Now read it back. */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">tg3_do_test_dma</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">buf_dma</span><span class="p">,</span> <span class="n">TEST_BUFFER_SIZE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: Buffer read failed. &quot;</span>
				<span class="s">&quot;err = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Verify it. */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">TEST_BUFFER_SIZE</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">i</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">((</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">dma_rwctrl</span> <span class="o">&amp;</span> <span class="n">DMA_RWCTRL_WRITE_BNDRY_MASK</span><span class="p">)</span> <span class="o">!=</span>
			    <span class="n">DMA_RWCTRL_WRITE_BNDRY_16</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">tp</span><span class="o">-&gt;</span><span class="n">dma_rwctrl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">DMA_RWCTRL_WRITE_BNDRY_MASK</span><span class="p">;</span>
				<span class="n">tp</span><span class="o">-&gt;</span><span class="n">dma_rwctrl</span> <span class="o">|=</span> <span class="n">DMA_RWCTRL_WRITE_BNDRY_16</span><span class="p">;</span>
				<span class="n">tw32</span><span class="p">(</span><span class="n">TG3PCI_DMA_RW_CTRL</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">dma_rwctrl</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					<span class="s">&quot;%s: Buffer corrupted on read back! &quot;</span>
					<span class="s">&quot;(%d != %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">p</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">i</span><span class="p">);</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="p">(</span><span class="n">TEST_BUFFER_SIZE</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">)))</span> <span class="p">{</span>
			<span class="cm">/* Success. */</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">dma_rwctrl</span> <span class="o">&amp;</span> <span class="n">DMA_RWCTRL_WRITE_BNDRY_MASK</span><span class="p">)</span> <span class="o">!=</span>
	    <span class="n">DMA_RWCTRL_WRITE_BNDRY_16</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* DMA test passed without adjusting DMA boundary,</span>
<span class="cm">		 * now look for chipsets that are known to expose the</span>
<span class="cm">		 * DMA bug without failing the test.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pci_dev_present</span><span class="p">(</span><span class="n">tg3_dma_wait_state_chipsets</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">tp</span><span class="o">-&gt;</span><span class="n">dma_rwctrl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">DMA_RWCTRL_WRITE_BNDRY_MASK</span><span class="p">;</span>
			<span class="n">tp</span><span class="o">-&gt;</span><span class="n">dma_rwctrl</span> <span class="o">|=</span> <span class="n">DMA_RWCTRL_WRITE_BNDRY_16</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* Safe to use the calculated DMA boundary. */</span>
			<span class="n">tp</span><span class="o">-&gt;</span><span class="n">dma_rwctrl</span> <span class="o">=</span> <span class="n">saved_dma_rwctrl</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">tw32</span><span class="p">(</span><span class="n">TG3PCI_DMA_RW_CTRL</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">dma_rwctrl</span><span class="p">);</span>
	<span class="p">}</span>

<span class="nl">out:</span>
	<span class="n">dma_free_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">TEST_BUFFER_SIZE</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">buf_dma</span><span class="p">);</span>
<span class="nl">out_nofree:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span> <span class="nf">tg3_init_bufmgr_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">57765</span><span class="n">_PLUS</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">bufmgr_config</span><span class="p">.</span><span class="n">mbuf_read_dma_low_water</span> <span class="o">=</span>
			<span class="n">DEFAULT_MB_RDMA_LOW_WATER_5705</span><span class="p">;</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">bufmgr_config</span><span class="p">.</span><span class="n">mbuf_mac_rx_low_water</span> <span class="o">=</span>
			<span class="n">DEFAULT_MB_MACRX_LOW_WATER_57765</span><span class="p">;</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">bufmgr_config</span><span class="p">.</span><span class="n">mbuf_high_water</span> <span class="o">=</span>
			<span class="n">DEFAULT_MB_HIGH_WATER_57765</span><span class="p">;</span>

		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">bufmgr_config</span><span class="p">.</span><span class="n">mbuf_read_dma_low_water_jumbo</span> <span class="o">=</span>
			<span class="n">DEFAULT_MB_RDMA_LOW_WATER_5705</span><span class="p">;</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">bufmgr_config</span><span class="p">.</span><span class="n">mbuf_mac_rx_low_water_jumbo</span> <span class="o">=</span>
			<span class="n">DEFAULT_MB_MACRX_LOW_WATER_JUMBO_57765</span><span class="p">;</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">bufmgr_config</span><span class="p">.</span><span class="n">mbuf_high_water_jumbo</span> <span class="o">=</span>
			<span class="n">DEFAULT_MB_HIGH_WATER_JUMBO_57765</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">5705</span><span class="n">_PLUS</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">bufmgr_config</span><span class="p">.</span><span class="n">mbuf_read_dma_low_water</span> <span class="o">=</span>
			<span class="n">DEFAULT_MB_RDMA_LOW_WATER_5705</span><span class="p">;</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">bufmgr_config</span><span class="p">.</span><span class="n">mbuf_mac_rx_low_water</span> <span class="o">=</span>
			<span class="n">DEFAULT_MB_MACRX_LOW_WATER_5705</span><span class="p">;</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">bufmgr_config</span><span class="p">.</span><span class="n">mbuf_high_water</span> <span class="o">=</span>
			<span class="n">DEFAULT_MB_HIGH_WATER_5705</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">ASIC_REV_5906</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">tp</span><span class="o">-&gt;</span><span class="n">bufmgr_config</span><span class="p">.</span><span class="n">mbuf_mac_rx_low_water</span> <span class="o">=</span>
				<span class="n">DEFAULT_MB_MACRX_LOW_WATER_5906</span><span class="p">;</span>
			<span class="n">tp</span><span class="o">-&gt;</span><span class="n">bufmgr_config</span><span class="p">.</span><span class="n">mbuf_high_water</span> <span class="o">=</span>
				<span class="n">DEFAULT_MB_HIGH_WATER_5906</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">bufmgr_config</span><span class="p">.</span><span class="n">mbuf_read_dma_low_water_jumbo</span> <span class="o">=</span>
			<span class="n">DEFAULT_MB_RDMA_LOW_WATER_JUMBO_5780</span><span class="p">;</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">bufmgr_config</span><span class="p">.</span><span class="n">mbuf_mac_rx_low_water_jumbo</span> <span class="o">=</span>
			<span class="n">DEFAULT_MB_MACRX_LOW_WATER_JUMBO_5780</span><span class="p">;</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">bufmgr_config</span><span class="p">.</span><span class="n">mbuf_high_water_jumbo</span> <span class="o">=</span>
			<span class="n">DEFAULT_MB_HIGH_WATER_JUMBO_5780</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">bufmgr_config</span><span class="p">.</span><span class="n">mbuf_read_dma_low_water</span> <span class="o">=</span>
			<span class="n">DEFAULT_MB_RDMA_LOW_WATER</span><span class="p">;</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">bufmgr_config</span><span class="p">.</span><span class="n">mbuf_mac_rx_low_water</span> <span class="o">=</span>
			<span class="n">DEFAULT_MB_MACRX_LOW_WATER</span><span class="p">;</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">bufmgr_config</span><span class="p">.</span><span class="n">mbuf_high_water</span> <span class="o">=</span>
			<span class="n">DEFAULT_MB_HIGH_WATER</span><span class="p">;</span>

		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">bufmgr_config</span><span class="p">.</span><span class="n">mbuf_read_dma_low_water_jumbo</span> <span class="o">=</span>
			<span class="n">DEFAULT_MB_RDMA_LOW_WATER_JUMBO</span><span class="p">;</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">bufmgr_config</span><span class="p">.</span><span class="n">mbuf_mac_rx_low_water_jumbo</span> <span class="o">=</span>
			<span class="n">DEFAULT_MB_MACRX_LOW_WATER_JUMBO</span><span class="p">;</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">bufmgr_config</span><span class="p">.</span><span class="n">mbuf_high_water_jumbo</span> <span class="o">=</span>
			<span class="n">DEFAULT_MB_HIGH_WATER_JUMBO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">bufmgr_config</span><span class="p">.</span><span class="n">dma_low_water</span> <span class="o">=</span> <span class="n">DEFAULT_DMA_LOW_WATER</span><span class="p">;</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">bufmgr_config</span><span class="p">.</span><span class="n">dma_high_water</span> <span class="o">=</span> <span class="n">DEFAULT_DMA_HIGH_WATER</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">__devinit</span> <span class="nf">tg3_phy_string</span><span class="p">(</span><span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">phy_id</span> <span class="o">&amp;</span> <span class="n">TG3_PHY_ID_MASK</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">TG3_PHY_ID_BCM5400</span>:	<span class="k">return</span> <span class="s">&quot;5400&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TG3_PHY_ID_BCM5401</span>:	<span class="k">return</span> <span class="s">&quot;5401&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TG3_PHY_ID_BCM5411</span>:	<span class="k">return</span> <span class="s">&quot;5411&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TG3_PHY_ID_BCM5701</span>:	<span class="k">return</span> <span class="s">&quot;5701&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TG3_PHY_ID_BCM5703</span>:	<span class="k">return</span> <span class="s">&quot;5703&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TG3_PHY_ID_BCM5704</span>:	<span class="k">return</span> <span class="s">&quot;5704&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TG3_PHY_ID_BCM5705</span>:	<span class="k">return</span> <span class="s">&quot;5705&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TG3_PHY_ID_BCM5750</span>:	<span class="k">return</span> <span class="s">&quot;5750&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TG3_PHY_ID_BCM5752</span>:	<span class="k">return</span> <span class="s">&quot;5752&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TG3_PHY_ID_BCM5714</span>:	<span class="k">return</span> <span class="s">&quot;5714&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TG3_PHY_ID_BCM5780</span>:	<span class="k">return</span> <span class="s">&quot;5780&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TG3_PHY_ID_BCM5755</span>:	<span class="k">return</span> <span class="s">&quot;5755&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TG3_PHY_ID_BCM5787</span>:	<span class="k">return</span> <span class="s">&quot;5787&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TG3_PHY_ID_BCM5784</span>:	<span class="k">return</span> <span class="s">&quot;5784&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TG3_PHY_ID_BCM5756</span>:	<span class="k">return</span> <span class="s">&quot;5722/5756&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TG3_PHY_ID_BCM5906</span>:	<span class="k">return</span> <span class="s">&quot;5906&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TG3_PHY_ID_BCM5761</span>:	<span class="k">return</span> <span class="s">&quot;5761&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TG3_PHY_ID_BCM5718C</span>:	<span class="k">return</span> <span class="s">&quot;5718C&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TG3_PHY_ID_BCM5718S</span>:	<span class="k">return</span> <span class="s">&quot;5718S&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TG3_PHY_ID_BCM57765</span>:	<span class="k">return</span> <span class="s">&quot;57765&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TG3_PHY_ID_BCM5719C</span>:	<span class="k">return</span> <span class="s">&quot;5719C&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TG3_PHY_ID_BCM5720C</span>:	<span class="k">return</span> <span class="s">&quot;5720C&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TG3_PHY_ID_BCM8002</span>:	<span class="k">return</span> <span class="s">&quot;8002/serdes&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">0</span>:			<span class="k">return</span> <span class="s">&quot;serdes&quot;</span><span class="p">;</span>
	<span class="nl">default:</span>		<span class="k">return</span> <span class="s">&quot;unknown&quot;</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">__devinit</span> <span class="nf">tg3_bus_string</span><span class="p">(</span><span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">PCI_EXPRESS</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">strcpy</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="s">&quot;PCI Express&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">str</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">PCIX_MODE</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">clock_ctrl</span> <span class="o">=</span> <span class="n">tr32</span><span class="p">(</span><span class="n">TG3PCI_CLOCK_CTRL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">;</span>

		<span class="n">strcpy</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="s">&quot;PCIX:&quot;</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">clock_ctrl</span> <span class="o">==</span> <span class="mi">7</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">((</span><span class="n">tr32</span><span class="p">(</span><span class="n">GRC_MISC_CFG</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">GRC_MISC_CFG_BOARD_ID_MASK</span><span class="p">)</span> <span class="o">==</span>
		     <span class="n">GRC_MISC_CFG_BOARD_ID_5704CIOBE</span><span class="p">))</span>
			<span class="n">strcat</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="s">&quot;133MHz&quot;</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">clock_ctrl</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">strcat</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="s">&quot;33MHz&quot;</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">clock_ctrl</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
			<span class="n">strcat</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="s">&quot;50MHz&quot;</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">clock_ctrl</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span>
			<span class="n">strcat</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="s">&quot;66MHz&quot;</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">clock_ctrl</span> <span class="o">==</span> <span class="mi">6</span><span class="p">)</span>
			<span class="n">strcat</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="s">&quot;100MHz&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">strcpy</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="s">&quot;PCI:&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">PCI_HIGH_SPEED</span><span class="p">))</span>
			<span class="n">strcat</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="s">&quot;66MHz&quot;</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">strcat</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="s">&quot;33MHz&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">PCI_32BIT</span><span class="p">))</span>
		<span class="n">strcat</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="s">&quot;:32-bit&quot;</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">strcat</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="s">&quot;:64-bit&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">str</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span> <span class="nf">tg3_init_coal</span><span class="p">(</span><span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ethtool_coalesce</span> <span class="o">*</span><span class="n">ec</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">coal</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">ec</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ec</span><span class="p">));</span>
	<span class="n">ec</span><span class="o">-&gt;</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">ETHTOOL_GCOALESCE</span><span class="p">;</span>
	<span class="n">ec</span><span class="o">-&gt;</span><span class="n">rx_coalesce_usecs</span> <span class="o">=</span> <span class="n">LOW_RXCOL_TICKS</span><span class="p">;</span>
	<span class="n">ec</span><span class="o">-&gt;</span><span class="n">tx_coalesce_usecs</span> <span class="o">=</span> <span class="n">LOW_TXCOL_TICKS</span><span class="p">;</span>
	<span class="n">ec</span><span class="o">-&gt;</span><span class="n">rx_max_coalesced_frames</span> <span class="o">=</span> <span class="n">LOW_RXMAX_FRAMES</span><span class="p">;</span>
	<span class="n">ec</span><span class="o">-&gt;</span><span class="n">tx_max_coalesced_frames</span> <span class="o">=</span> <span class="n">LOW_TXMAX_FRAMES</span><span class="p">;</span>
	<span class="n">ec</span><span class="o">-&gt;</span><span class="n">rx_coalesce_usecs_irq</span> <span class="o">=</span> <span class="n">DEFAULT_RXCOAL_TICK_INT</span><span class="p">;</span>
	<span class="n">ec</span><span class="o">-&gt;</span><span class="n">tx_coalesce_usecs_irq</span> <span class="o">=</span> <span class="n">DEFAULT_TXCOAL_TICK_INT</span><span class="p">;</span>
	<span class="n">ec</span><span class="o">-&gt;</span><span class="n">rx_max_coalesced_frames_irq</span> <span class="o">=</span> <span class="n">DEFAULT_RXCOAL_MAXF_INT</span><span class="p">;</span>
	<span class="n">ec</span><span class="o">-&gt;</span><span class="n">tx_max_coalesced_frames_irq</span> <span class="o">=</span> <span class="n">DEFAULT_TXCOAL_MAXF_INT</span><span class="p">;</span>
	<span class="n">ec</span><span class="o">-&gt;</span><span class="n">stats_block_coalesce_usecs</span> <span class="o">=</span> <span class="n">DEFAULT_STAT_COAL_TICKS</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">coalesce_mode</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">HOSTCC_MODE_CLRTICK_RXBD</span> <span class="o">|</span>
				 <span class="n">HOSTCC_MODE_CLRTICK_TXBD</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ec</span><span class="o">-&gt;</span><span class="n">rx_coalesce_usecs</span> <span class="o">=</span> <span class="n">LOW_RXCOL_TICKS_CLRTCKS</span><span class="p">;</span>
		<span class="n">ec</span><span class="o">-&gt;</span><span class="n">rx_coalesce_usecs_irq</span> <span class="o">=</span> <span class="n">DEFAULT_RXCOAL_TICK_INT_CLRTCKS</span><span class="p">;</span>
		<span class="n">ec</span><span class="o">-&gt;</span><span class="n">tx_coalesce_usecs</span> <span class="o">=</span> <span class="n">LOW_TXCOL_TICKS_CLRTCKS</span><span class="p">;</span>
		<span class="n">ec</span><span class="o">-&gt;</span><span class="n">tx_coalesce_usecs_irq</span> <span class="o">=</span> <span class="n">DEFAULT_TXCOAL_TICK_INT_CLRTCKS</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">5705</span><span class="n">_PLUS</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ec</span><span class="o">-&gt;</span><span class="n">rx_coalesce_usecs_irq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ec</span><span class="o">-&gt;</span><span class="n">tx_coalesce_usecs_irq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ec</span><span class="o">-&gt;</span><span class="n">stats_block_coalesce_usecs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">tg3_init_one</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span>
				  <span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="o">*</span><span class="n">ent</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">err</span><span class="p">,</span> <span class="n">pm_cap</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">sndmbx</span><span class="p">,</span> <span class="n">rcvmbx</span><span class="p">,</span> <span class="n">intmbx</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">str</span><span class="p">[</span><span class="mi">40</span><span class="p">];</span>
	<span class="n">u64</span> <span class="n">dma_mask</span><span class="p">,</span> <span class="n">persist_dma_mask</span><span class="p">;</span>
	<span class="n">netdev_features_t</span> <span class="n">features</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">printk_once</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">version</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">pci_enable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Cannot enable PCI device, aborting</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">pci_request_regions</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">DRV_MODULE_NAME</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Cannot obtain PCI resources, aborting</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_out_disable_pdev</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pci_set_master</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="cm">/* Find power-management capability. */</span>
	<span class="n">pm_cap</span> <span class="o">=</span> <span class="n">pci_find_capability</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_CAP_ID_PM</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pm_cap</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;Cannot find Power Management capability, aborting</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_out_free_res</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">pci_set_power_state</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_D0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Transition to D0 failed, aborting</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_out_free_res</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev</span> <span class="o">=</span> <span class="n">alloc_etherdev_mq</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">tp</span><span class="p">),</span> <span class="n">TG3_IRQ_MAX_VECS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_out_power_down</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">SET_NETDEV_DEV</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">tp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">pdev</span><span class="p">;</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">pm_cap</span> <span class="o">=</span> <span class="n">pm_cap</span><span class="p">;</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">rx_mode</span> <span class="o">=</span> <span class="n">TG3_DEF_RX_MODE</span><span class="p">;</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">tx_mode</span> <span class="o">=</span> <span class="n">TG3_DEF_TX_MODE</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tg3_debug</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">msg_enable</span> <span class="o">=</span> <span class="n">tg3_debug</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">msg_enable</span> <span class="o">=</span> <span class="n">TG3_DEF_MSG_ENABLE</span><span class="p">;</span>

	<span class="cm">/* The word/byte swap controls here control register access byte</span>
<span class="cm">	 * swapping.  DMA data byte swapping is controlled in the GRC_MODE</span>
<span class="cm">	 * setting below.</span>
<span class="cm">	 */</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">misc_host_ctrl</span> <span class="o">=</span>
		<span class="n">MISC_HOST_CTRL_MASK_PCI_INT</span> <span class="o">|</span>
		<span class="n">MISC_HOST_CTRL_WORD_SWAP</span> <span class="o">|</span>
		<span class="n">MISC_HOST_CTRL_INDIR_ACCESS</span> <span class="o">|</span>
		<span class="n">MISC_HOST_CTRL_PCISTATE_RW</span><span class="p">;</span>

	<span class="cm">/* The NONFRM (non-frame) byte/word swap controls take effect</span>
<span class="cm">	 * on descriptor entries, anything which isn&#39;t packet data.</span>
<span class="cm">	 *</span>
<span class="cm">	 * The StrongARM chips on the board (one for tx, one for rx)</span>
<span class="cm">	 * are running in big-endian mode.</span>
<span class="cm">	 */</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">grc_mode</span> <span class="o">=</span> <span class="p">(</span><span class="n">GRC_MODE_WSWAP_DATA</span> <span class="o">|</span> <span class="n">GRC_MODE_BSWAP_DATA</span> <span class="o">|</span>
			<span class="n">GRC_MODE_WSWAP_NONFRM_DATA</span><span class="p">);</span>
<span class="cp">#ifdef __BIG_ENDIAN</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">grc_mode</span> <span class="o">|=</span> <span class="n">GRC_MODE_BSWAP_NONFRM_DATA</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">indirect_lock</span><span class="p">);</span>
	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">reset_task</span><span class="p">,</span> <span class="n">tg3_reset_task</span><span class="p">);</span>

	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">=</span> <span class="n">pci_ioremap_bar</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">BAR_0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Cannot map device registers, aborting</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_out_free_dev</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="n">PCI_DEVICE_ID_TIGON3_5761</span> <span class="o">||</span>
	    <span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="n">PCI_DEVICE_ID_TIGON3_5761E</span> <span class="o">||</span>
	    <span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="n">TG3PCI_DEVICE_TIGON3_5761S</span> <span class="o">||</span>
	    <span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="n">TG3PCI_DEVICE_TIGON3_5761SE</span> <span class="o">||</span>
	    <span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="n">TG3PCI_DEVICE_TIGON3_5717</span> <span class="o">||</span>
	    <span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="n">TG3PCI_DEVICE_TIGON3_5718</span> <span class="o">||</span>
	    <span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="n">TG3PCI_DEVICE_TIGON3_5719</span> <span class="o">||</span>
	    <span class="n">tp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="n">TG3PCI_DEVICE_TIGON3_5720</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tg3_flag_set</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">ENABLE_APE</span><span class="p">);</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">aperegs</span> <span class="o">=</span> <span class="n">pci_ioremap_bar</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">BAR_2</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">aperegs</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;Cannot map APE registers, aborting</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">err_out_iounmap</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">rx_pending</span> <span class="o">=</span> <span class="n">TG3_DEF_RX_RING_PENDING</span><span class="p">;</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">rx_jumbo_pending</span> <span class="o">=</span> <span class="n">TG3_DEF_RX_JUMBO_RING_PENDING</span><span class="p">;</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ethtool_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tg3_ethtool_ops</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">watchdog_timeo</span> <span class="o">=</span> <span class="n">TG3_TX_TIMEOUT</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">netdev_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tg3_netdev_ops</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">tg3_get_invariants</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;Problem fetching invariants of chip, aborting</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_out_apeunmap</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* The EPB bridge inside 5714, 5715, and 5780 and any</span>
<span class="cm">	 * device behind the EPB cannot support DMA addresses &gt; 40-bit.</span>
<span class="cm">	 * On 64-bit systems with IOMMU, use 40-bit dma_mask.</span>
<span class="cm">	 * On 64-bit systems without IOMMU, use 64-bit dma_mask and</span>
<span class="cm">	 * do DMA address check in tg3_start_xmit().</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">IS_5788</span><span class="p">))</span>
		<span class="n">persist_dma_mask</span> <span class="o">=</span> <span class="n">dma_mask</span> <span class="o">=</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">32</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">40</span><span class="n">BIT_DMA_BUG</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">persist_dma_mask</span> <span class="o">=</span> <span class="n">dma_mask</span> <span class="o">=</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">40</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_HIGHMEM</span>
		<span class="n">dma_mask</span> <span class="o">=</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">64</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">persist_dma_mask</span> <span class="o">=</span> <span class="n">dma_mask</span> <span class="o">=</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">64</span><span class="p">);</span>

	<span class="cm">/* Configure DMA attributes. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dma_mask</span> <span class="o">&gt;</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">32</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">pci_set_dma_mask</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">dma_mask</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">features</span> <span class="o">|=</span> <span class="n">NETIF_F_HIGHDMA</span><span class="p">;</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">pci_set_consistent_dma_mask</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span>
							  <span class="n">persist_dma_mask</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Unable to obtain 64 bit &quot;</span>
					<span class="s">&quot;DMA for consistent allocations</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">err_out_apeunmap</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">||</span> <span class="n">dma_mask</span> <span class="o">==</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">32</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">pci_set_dma_mask</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">32</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;No usable DMA configuration, aborting</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">err_out_apeunmap</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">tg3_init_bufmgr_config</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>

	<span class="n">features</span> <span class="o">|=</span> <span class="n">NETIF_F_HW_VLAN_TX</span> <span class="o">|</span> <span class="n">NETIF_F_HW_VLAN_RX</span><span class="p">;</span>

	<span class="cm">/* 5700 B0 chips do not support checksumming correctly due</span>
<span class="cm">	 * to hardware bugs.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span> <span class="o">!=</span> <span class="n">CHIPREV_ID_5700_B0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">features</span> <span class="o">|=</span> <span class="n">NETIF_F_SG</span> <span class="o">|</span> <span class="n">NETIF_F_IP_CSUM</span> <span class="o">|</span> <span class="n">NETIF_F_RXCSUM</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">5755</span><span class="n">_PLUS</span><span class="p">))</span>
			<span class="n">features</span> <span class="o">|=</span> <span class="n">NETIF_F_IPV6_CSUM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* TSO is on by default on chips that support hardware TSO.</span>
<span class="cm">	 * Firmware TSO on older chips gives lower performance, so it</span>
<span class="cm">	 * is off by default, but can be enabled using ethtool.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">HW_TSO_1</span><span class="p">)</span> <span class="o">||</span>
	     <span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">HW_TSO_2</span><span class="p">)</span> <span class="o">||</span>
	     <span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">HW_TSO_3</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">NETIF_F_IP_CSUM</span><span class="p">))</span>
		<span class="n">features</span> <span class="o">|=</span> <span class="n">NETIF_F_TSO</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">HW_TSO_2</span><span class="p">)</span> <span class="o">||</span> <span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">HW_TSO_3</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">NETIF_F_IPV6_CSUM</span><span class="p">)</span>
			<span class="n">features</span> <span class="o">|=</span> <span class="n">NETIF_F_TSO6</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">HW_TSO_3</span><span class="p">)</span> <span class="o">||</span>
		    <span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">ASIC_REV_5761</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">ASIC_REV_5784</span> <span class="o">&amp;&amp;</span>
		     <span class="n">GET_CHIP_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">!=</span> <span class="n">CHIPREV_5784_AX</span><span class="p">)</span> <span class="o">||</span>
		    <span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">ASIC_REV_5785</span> <span class="o">||</span>
		    <span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">ASIC_REV_57780</span><span class="p">)</span>
			<span class="n">features</span> <span class="o">|=</span> <span class="n">NETIF_F_TSO_ECN</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">|=</span> <span class="n">features</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">vlan_features</span> <span class="o">|=</span> <span class="n">features</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Add loopback capability only for a subset of devices that support</span>
<span class="cm">	 * MAC-LOOPBACK. Eventually this need to be enhanced to allow INT-PHY</span>
<span class="cm">	 * loopback for the remaining devices.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">GET_ASIC_REV</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">)</span> <span class="o">!=</span> <span class="n">ASIC_REV_5780</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">CPMU_PRESENT</span><span class="p">))</span>
		<span class="cm">/* Add the loopback capability */</span>
		<span class="n">features</span> <span class="o">|=</span> <span class="n">NETIF_F_LOOPBACK</span><span class="p">;</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">hw_features</span> <span class="o">|=</span> <span class="n">features</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span> <span class="o">==</span> <span class="n">CHIPREV_ID_5705_A1</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">TSO_CAPABLE</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="p">(</span><span class="n">tr32</span><span class="p">(</span><span class="n">TG3PCI_PCISTATE</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">PCISTATE_BUS_SPEED_HIGH</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">tg3_flag_set</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">MAX_RXPEND_64</span><span class="p">);</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">rx_pending</span> <span class="o">=</span> <span class="mi">63</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">tg3_get_device_address</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;Could not obtain valid ethernet address, aborting</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_out_apeunmap</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Reset chip in case UNDI or EFI driver did not shutdown</span>
<span class="cm">	 * DMA self test will enable WDMAC and we&#39;ll see (spurious)</span>
<span class="cm">	 * pending DMA on the PCI bus at that point.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">tr32</span><span class="p">(</span><span class="n">HOSTCC_MODE</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">HOSTCC_MODE_ENABLE</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">tr32</span><span class="p">(</span><span class="n">WDMAC_MODE</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">WDMAC_MODE_ENABLE</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">tw32</span><span class="p">(</span><span class="n">MEMARB_MODE</span><span class="p">,</span> <span class="n">MEMARB_MODE_ENABLE</span><span class="p">);</span>
		<span class="n">tg3_halt</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">RESET_KIND_SHUTDOWN</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">tg3_test_dma</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;DMA engine test failed, aborting</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_out_apeunmap</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">intmbx</span> <span class="o">=</span> <span class="n">MAILBOX_INTERRUPT_0</span> <span class="o">+</span> <span class="n">TG3_64BIT_REG_LOW</span><span class="p">;</span>
	<span class="n">rcvmbx</span> <span class="o">=</span> <span class="n">MAILBOX_RCVRET_CON_IDX_0</span> <span class="o">+</span> <span class="n">TG3_64BIT_REG_LOW</span><span class="p">;</span>
	<span class="n">sndmbx</span> <span class="o">=</span> <span class="n">MAILBOX_SNDHOST_PROD_IDX_0</span> <span class="o">+</span> <span class="n">TG3_64BIT_REG_LOW</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">irq_max</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">tg3_napi</span> <span class="o">*</span><span class="n">tnapi</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="n">tnapi</span><span class="o">-&gt;</span><span class="n">tp</span> <span class="o">=</span> <span class="n">tp</span><span class="p">;</span>
		<span class="n">tnapi</span><span class="o">-&gt;</span><span class="n">tx_pending</span> <span class="o">=</span> <span class="n">TG3_DEF_TX_RING_PENDING</span><span class="p">;</span>

		<span class="n">tnapi</span><span class="o">-&gt;</span><span class="n">int_mbox</span> <span class="o">=</span> <span class="n">intmbx</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;=</span> <span class="mi">4</span><span class="p">)</span>
			<span class="n">intmbx</span> <span class="o">+=</span> <span class="mh">0x8</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">intmbx</span> <span class="o">+=</span> <span class="mh">0x4</span><span class="p">;</span>

		<span class="n">tnapi</span><span class="o">-&gt;</span><span class="n">consmbox</span> <span class="o">=</span> <span class="n">rcvmbx</span><span class="p">;</span>
		<span class="n">tnapi</span><span class="o">-&gt;</span><span class="n">prodmbox</span> <span class="o">=</span> <span class="n">sndmbx</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="p">)</span>
			<span class="n">tnapi</span><span class="o">-&gt;</span><span class="n">coal_now</span> <span class="o">=</span> <span class="n">HOSTCC_MODE_COAL_VEC1_NOW</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">tnapi</span><span class="o">-&gt;</span><span class="n">coal_now</span> <span class="o">=</span> <span class="n">HOSTCC_MODE_NOW</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">SUPPORT_MSIX</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * If we support MSIX, we&#39;ll be using RSS.  If we&#39;re using</span>
<span class="cm">		 * RSS, the first vector only handles link interrupts and the</span>
<span class="cm">		 * remaining vectors handle rx and tx interrupts.  Reuse the</span>
<span class="cm">		 * mailbox values for the next iteration.  The values we setup</span>
<span class="cm">		 * above are still useful for the single vectored mode.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">i</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">rcvmbx</span> <span class="o">+=</span> <span class="mh">0x8</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">sndmbx</span> <span class="o">&amp;</span> <span class="mh">0x4</span><span class="p">)</span>
			<span class="n">sndmbx</span> <span class="o">-=</span> <span class="mh">0x4</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">sndmbx</span> <span class="o">+=</span> <span class="mh">0xc</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">tg3_init_coal</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>

	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">5717</span><span class="n">_PLUS</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Resume a low-power mode */</span>
		<span class="n">tg3_frob_aux_power</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">tg3_timer_init</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">register_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Cannot register net device, aborting</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_out_apeunmap</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">netdev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Tigon3 [partno(%s) rev %04x] (%s) MAC address %pM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">tp</span><span class="o">-&gt;</span><span class="n">board_part_number</span><span class="p">,</span>
		    <span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_chip_rev_id</span><span class="p">,</span>
		    <span class="n">tg3_bus_string</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">str</span><span class="p">),</span>
		    <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">phy_flags</span> <span class="o">&amp;</span> <span class="n">TG3_PHYFLG_IS_CONNECTED</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">phy_device</span> <span class="o">*</span><span class="n">phydev</span><span class="p">;</span>
		<span class="n">phydev</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">mdio_bus</span><span class="o">-&gt;</span><span class="n">phy_map</span><span class="p">[</span><span class="n">TG3_PHY_MII_ADDR</span><span class="p">];</span>
		<span class="n">netdev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
			    <span class="s">&quot;attached PHY driver [%s] (mii_bus:phy_addr=%s)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">phydev</span><span class="o">-&gt;</span><span class="n">drv</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">dev_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phydev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="kt">char</span> <span class="o">*</span><span class="n">ethtype</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">phy_flags</span> <span class="o">&amp;</span> <span class="n">TG3_PHYFLG_10_100_ONLY</span><span class="p">)</span>
			<span class="n">ethtype</span> <span class="o">=</span> <span class="s">&quot;10/100Base-TX&quot;</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">phy_flags</span> <span class="o">&amp;</span> <span class="n">TG3_PHYFLG_ANY_SERDES</span><span class="p">)</span>
			<span class="n">ethtype</span> <span class="o">=</span> <span class="s">&quot;1000Base-SX&quot;</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">ethtype</span> <span class="o">=</span> <span class="s">&quot;10/100/1000Base-T&quot;</span><span class="p">;</span>

		<span class="n">netdev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;attached PHY is %s (%s Ethernet) &quot;</span>
			    <span class="s">&quot;(WireSpeed[%d], EEE[%d])</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">tg3_phy_string</span><span class="p">(</span><span class="n">tp</span><span class="p">),</span> <span class="n">ethtype</span><span class="p">,</span>
			    <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">phy_flags</span> <span class="o">&amp;</span> <span class="n">TG3_PHYFLG_NO_ETH_WIRE_SPEED</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span>
			    <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">phy_flags</span> <span class="o">&amp;</span> <span class="n">TG3_PHYFLG_EEE_CAP</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">netdev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;RXcsums[%d] LinkChgREG[%d] MIirq[%d] ASF[%d] TSOcap[%d]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">NETIF_F_RXCSUM</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">,</span>
		    <span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">USE_LINKCHG_REG</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">,</span>
		    <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">phy_flags</span> <span class="o">&amp;</span> <span class="n">TG3_PHYFLG_USE_MI_INTERRUPT</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">,</span>
		    <span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">ENABLE_ASF</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">,</span>
		    <span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">TSO_CAPABLE</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">netdev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;dma_rwctrl[%08x] dma_mask[%d-bit]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">tp</span><span class="o">-&gt;</span><span class="n">dma_rwctrl</span><span class="p">,</span>
		    <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dma_mask</span> <span class="o">==</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span> <span class="o">?</span> <span class="mi">32</span> <span class="o">:</span>
		    <span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dma_mask</span><span class="p">)</span> <span class="o">==</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">40</span><span class="p">)</span> <span class="o">?</span> <span class="mi">40</span> <span class="o">:</span> <span class="mi">64</span><span class="p">);</span>

	<span class="n">pci_save_state</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_out_apeunmap:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">aperegs</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">iounmap</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">aperegs</span><span class="p">);</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">aperegs</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">err_out_iounmap:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">iounmap</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">);</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">err_out_free_dev:</span>
	<span class="n">free_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

<span class="nl">err_out_power_down:</span>
	<span class="n">pci_set_power_state</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_D3hot</span><span class="p">);</span>

<span class="nl">err_out_free_res:</span>
	<span class="n">pci_release_regions</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

<span class="nl">err_out_disable_pdev:</span>
	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devexit</span> <span class="nf">tg3_remove_one</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

		<span class="n">release_firmware</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">fw</span><span class="p">);</span>

		<span class="n">tg3_reset_task_cancel</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">tg3_flag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">USE_PHYLIB</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">tg3_phy_fini</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
			<span class="n">tg3_mdio_fini</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">unregister_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">aperegs</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">iounmap</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">aperegs</span><span class="p">);</span>
			<span class="n">tp</span><span class="o">-&gt;</span><span class="n">aperegs</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">iounmap</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">);</span>
			<span class="n">tp</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">free_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">pci_release_regions</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
		<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
		<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_PM_SLEEP</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">tg3_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">device</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">to_pci_dev</span><span class="p">(</span><span class="n">device</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">netif_running</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">tg3_reset_task_cancel</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
	<span class="n">tg3_phy_stop</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
	<span class="n">tg3_netif_stop</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>

	<span class="n">tg3_timer_stop</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>

	<span class="n">tg3_full_lock</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">tg3_disable_ints</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
	<span class="n">tg3_full_unlock</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>

	<span class="n">netif_device_detach</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">tg3_full_lock</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">tg3_halt</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">RESET_KIND_SHUTDOWN</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">tg3_flag_clear</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">INIT_COMPLETE</span><span class="p">);</span>
	<span class="n">tg3_full_unlock</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">tg3_power_down_prepare</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">err2</span><span class="p">;</span>

		<span class="n">tg3_full_lock</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="n">tg3_flag_set</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">INIT_COMPLETE</span><span class="p">);</span>
		<span class="n">err2</span> <span class="o">=</span> <span class="n">tg3_restart_hw</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err2</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

		<span class="n">tg3_timer_start</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>

		<span class="n">netif_device_attach</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">tg3_netif_start</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>

<span class="nl">out:</span>
		<span class="n">tg3_full_unlock</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err2</span><span class="p">)</span>
			<span class="n">tg3_phy_start</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tg3_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">device</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">to_pci_dev</span><span class="p">(</span><span class="n">device</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">netif_running</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">netif_device_attach</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">tg3_full_lock</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">tg3_flag_set</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">INIT_COMPLETE</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">tg3_restart_hw</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">tg3_timer_start</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>

	<span class="n">tg3_netif_start</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="n">tg3_full_unlock</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span>
		<span class="n">tg3_phy_start</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">SIMPLE_DEV_PM_OPS</span><span class="p">(</span><span class="n">tg3_pm_ops</span><span class="p">,</span> <span class="n">tg3_suspend</span><span class="p">,</span> <span class="n">tg3_resume</span><span class="p">);</span>
<span class="cp">#define TG3_PM_OPS (&amp;tg3_pm_ops)</span>

<span class="cp">#else</span>

<span class="cp">#define TG3_PM_OPS NULL</span>

<span class="cp">#endif </span><span class="cm">/* CONFIG_PM_SLEEP */</span><span class="cp"></span>

<span class="cm">/**</span>
<span class="cm"> * tg3_io_error_detected - called when PCI error is detected</span>
<span class="cm"> * @pdev: Pointer to PCI device</span>
<span class="cm"> * @state: The current pci connection state</span>
<span class="cm"> *</span>
<span class="cm"> * This function is called after a PCI bus error affecting</span>
<span class="cm"> * this device has been detected.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">pci_ers_result_t</span> <span class="nf">tg3_io_error_detected</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span>
					      <span class="n">pci_channel_state_t</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="n">pci_ers_result_t</span> <span class="n">err</span> <span class="o">=</span> <span class="n">PCI_ERS_RESULT_NEED_RESET</span><span class="p">;</span>

	<span class="n">netdev_info</span><span class="p">(</span><span class="n">netdev</span><span class="p">,</span> <span class="s">&quot;PCI I/O error detected</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">rtnl_lock</span><span class="p">();</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">netif_running</span><span class="p">(</span><span class="n">netdev</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

	<span class="n">tg3_phy_stop</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>

	<span class="n">tg3_netif_stop</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>

	<span class="n">tg3_timer_stop</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>

	<span class="cm">/* Want to make sure that the reset task doesn&#39;t run */</span>
	<span class="n">tg3_reset_task_cancel</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>

	<span class="n">netif_device_detach</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>

	<span class="cm">/* Clean up software state, even if MMIO is blocked */</span>
	<span class="n">tg3_full_lock</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">tg3_halt</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">RESET_KIND_SHUTDOWN</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">tg3_full_unlock</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>

<span class="nl">done:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">state</span> <span class="o">==</span> <span class="n">pci_channel_io_perm_failure</span><span class="p">)</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">PCI_ERS_RESULT_DISCONNECT</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="n">rtnl_unlock</span><span class="p">();</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * tg3_io_slot_reset - called after the pci bus has been reset.</span>
<span class="cm"> * @pdev: Pointer to PCI device</span>
<span class="cm"> *</span>
<span class="cm"> * Restart the card from scratch, as if from a cold-boot.</span>
<span class="cm"> * At this point, the card has exprienced a hard reset,</span>
<span class="cm"> * followed by fixups by BIOS, and has its config space</span>
<span class="cm"> * set up identically to what it was at cold boot.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">pci_ers_result_t</span> <span class="nf">tg3_io_slot_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="n">pci_ers_result_t</span> <span class="n">rc</span> <span class="o">=</span> <span class="n">PCI_ERS_RESULT_DISCONNECT</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">rtnl_lock</span><span class="p">();</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pci_enable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">netdev_err</span><span class="p">(</span><span class="n">netdev</span><span class="p">,</span> <span class="s">&quot;Cannot re-enable PCI device after reset.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pci_set_master</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">pci_restore_state</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">pci_save_state</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">netif_running</span><span class="p">(</span><span class="n">netdev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">PCI_ERS_RESULT_RECOVERED</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">tg3_power_up</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">PCI_ERS_RESULT_RECOVERED</span><span class="p">;</span>

<span class="nl">done:</span>
	<span class="n">rtnl_unlock</span><span class="p">();</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * tg3_io_resume - called when traffic can start flowing again.</span>
<span class="cm"> * @pdev: Pointer to PCI device</span>
<span class="cm"> *</span>
<span class="cm"> * This callback is called when the error recovery driver tells</span>
<span class="cm"> * us that its OK to resume normal operation.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">tg3_io_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">tg3</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">rtnl_lock</span><span class="p">();</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">netif_running</span><span class="p">(</span><span class="n">netdev</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

	<span class="n">tg3_full_lock</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">tg3_flag_set</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">INIT_COMPLETE</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">tg3_restart_hw</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">tg3_full_unlock</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netdev_err</span><span class="p">(</span><span class="n">netdev</span><span class="p">,</span> <span class="s">&quot;Cannot restart hardware after reset.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">netif_device_attach</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>

	<span class="n">tg3_timer_start</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>

	<span class="n">tg3_netif_start</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>

	<span class="n">tg3_phy_start</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>

<span class="nl">done:</span>
	<span class="n">rtnl_unlock</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_error_handlers</span> <span class="n">tg3_err_handler</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">error_detected</span>	<span class="o">=</span> <span class="n">tg3_io_error_detected</span><span class="p">,</span>
	<span class="p">.</span><span class="n">slot_reset</span>	<span class="o">=</span> <span class="n">tg3_io_slot_reset</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume</span>		<span class="o">=</span> <span class="n">tg3_io_resume</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_driver</span> <span class="n">tg3_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="n">DRV_MODULE_NAME</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span>	<span class="o">=</span> <span class="n">tg3_pci_tbl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span>		<span class="o">=</span> <span class="n">tg3_init_one</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>		<span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">tg3_remove_one</span><span class="p">),</span>
	<span class="p">.</span><span class="n">err_handler</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">tg3_err_handler</span><span class="p">,</span>
	<span class="p">.</span><span class="n">driver</span><span class="p">.</span><span class="n">pm</span>	<span class="o">=</span> <span class="n">TG3_PM_OPS</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">tg3_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">pci_register_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tg3_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">tg3_cleanup</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pci_unregister_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tg3_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">tg3_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">tg3_cleanup</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
