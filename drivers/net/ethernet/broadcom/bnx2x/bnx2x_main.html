<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › ethernet › broadcom › bnx2x › bnx2x_main.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../../index.html"></a><h1>bnx2x_main.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/* bnx2x_main.c: Broadcom Everest network driver.</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (c) 2007-2012 Broadcom Corporation</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License as published by</span>
<span class="cm"> * the Free Software Foundation.</span>
<span class="cm"> *</span>
<span class="cm"> * Maintained by: Eilon Greenstein &lt;eilong@broadcom.com&gt;</span>
<span class="cm"> * Written by: Eliezer Tamir</span>
<span class="cm"> * Based on code from Michael Chan&#39;s bnx2 driver</span>
<span class="cm"> * UDP CSUM errata workaround by Arik Gendelman</span>
<span class="cm"> * Slowpath and fastpath rework by Vladislav Zolotarov</span>
<span class="cm"> * Statistics and Link management by Yitchak Gertner</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#define pr_fmt(fmt) KBUILD_MODNAME &quot;: &quot; fmt</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/moduleparam.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/device.h&gt;  </span><span class="cm">/* for dev_info() */</span><span class="cp"></span>
<span class="cp">#include &lt;linux/timer.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/ioport.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/netdevice.h&gt;</span>
<span class="cp">#include &lt;linux/etherdevice.h&gt;</span>
<span class="cp">#include &lt;linux/skbuff.h&gt;</span>
<span class="cp">#include &lt;linux/dma-mapping.h&gt;</span>
<span class="cp">#include &lt;linux/bitops.h&gt;</span>
<span class="cp">#include &lt;linux/irq.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;asm/byteorder.h&gt;</span>
<span class="cp">#include &lt;linux/time.h&gt;</span>
<span class="cp">#include &lt;linux/ethtool.h&gt;</span>
<span class="cp">#include &lt;linux/mii.h&gt;</span>
<span class="cp">#include &lt;linux/if_vlan.h&gt;</span>
<span class="cp">#include &lt;net/ip.h&gt;</span>
<span class="cp">#include &lt;net/ipv6.h&gt;</span>
<span class="cp">#include &lt;net/tcp.h&gt;</span>
<span class="cp">#include &lt;net/checksum.h&gt;</span>
<span class="cp">#include &lt;net/ip6_checksum.h&gt;</span>
<span class="cp">#include &lt;linux/workqueue.h&gt;</span>
<span class="cp">#include &lt;linux/crc32.h&gt;</span>
<span class="cp">#include &lt;linux/crc32c.h&gt;</span>
<span class="cp">#include &lt;linux/prefetch.h&gt;</span>
<span class="cp">#include &lt;linux/zlib.h&gt;</span>
<span class="cp">#include &lt;linux/io.h&gt;</span>
<span class="cp">#include &lt;linux/semaphore.h&gt;</span>
<span class="cp">#include &lt;linux/stringify.h&gt;</span>
<span class="cp">#include &lt;linux/vmalloc.h&gt;</span>

<span class="cp">#include &quot;bnx2x.h&quot;</span>
<span class="cp">#include &quot;bnx2x_init.h&quot;</span>
<span class="cp">#include &quot;bnx2x_init_ops.h&quot;</span>
<span class="cp">#include &quot;bnx2x_cmn.h&quot;</span>
<span class="cp">#include &quot;bnx2x_dcb.h&quot;</span>
<span class="cp">#include &quot;bnx2x_sp.h&quot;</span>

<span class="cp">#include &lt;linux/firmware.h&gt;</span>
<span class="cp">#include &quot;bnx2x_fw_file_hdr.h&quot;</span>
<span class="cm">/* FW files */</span>
<span class="cp">#define FW_FILE_VERSION					\</span>
<span class="cp">	__stringify(BCM_5710_FW_MAJOR_VERSION) &quot;.&quot;	\</span>
<span class="cp">	__stringify(BCM_5710_FW_MINOR_VERSION) &quot;.&quot;	\</span>
<span class="cp">	__stringify(BCM_5710_FW_REVISION_VERSION) &quot;.&quot;	\</span>
<span class="cp">	__stringify(BCM_5710_FW_ENGINEERING_VERSION)</span>
<span class="cp">#define FW_FILE_NAME_E1		&quot;bnx2x/bnx2x-e1-&quot; FW_FILE_VERSION &quot;.fw&quot;</span>
<span class="cp">#define FW_FILE_NAME_E1H	&quot;bnx2x/bnx2x-e1h-&quot; FW_FILE_VERSION &quot;.fw&quot;</span>
<span class="cp">#define FW_FILE_NAME_E2		&quot;bnx2x/bnx2x-e2-&quot; FW_FILE_VERSION &quot;.fw&quot;</span>

<span class="cm">/* Time in jiffies before concluding the transmitter is hung */</span>
<span class="cp">#define TX_TIMEOUT		(5*HZ)</span>

<span class="k">static</span> <span class="kt">char</span> <span class="n">version</span><span class="p">[]</span> <span class="n">__devinitdata</span> <span class="o">=</span>
	<span class="s">&quot;Broadcom NetXtreme II 5771x/578xx 10/20-Gigabit Ethernet Driver &quot;</span>
	<span class="n">DRV_MODULE_NAME</span> <span class="s">&quot; &quot;</span> <span class="n">DRV_MODULE_VERSION</span> <span class="s">&quot; (&quot;</span> <span class="n">DRV_MODULE_RELDATE</span> <span class="s">&quot;)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Eliezer Tamir&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Broadcom NetXtreme II &quot;</span>
		   <span class="s">&quot;BCM57710/57711/57711E/&quot;</span>
		   <span class="s">&quot;57712/57712_MF/57800/57800_MF/57810/57810_MF/&quot;</span>
		   <span class="s">&quot;57840/57840_MF Driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_VERSION</span><span class="p">(</span><span class="n">DRV_MODULE_VERSION</span><span class="p">);</span>
<span class="n">MODULE_FIRMWARE</span><span class="p">(</span><span class="n">FW_FILE_NAME_E1</span><span class="p">);</span>
<span class="n">MODULE_FIRMWARE</span><span class="p">(</span><span class="n">FW_FILE_NAME_E1H</span><span class="p">);</span>
<span class="n">MODULE_FIRMWARE</span><span class="p">(</span><span class="n">FW_FILE_NAME_E2</span><span class="p">);</span>


<span class="kt">int</span> <span class="n">num_queues</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">num_queues</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">num_queues</span><span class="p">,</span>
		 <span class="s">&quot; Set number of queues (default is as a number of CPUs)&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">disable_tpa</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">disable_tpa</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">disable_tpa</span><span class="p">,</span> <span class="s">&quot; Disable the TPA (LRO) feature&quot;</span><span class="p">);</span>

<span class="cp">#define INT_MODE_INTx			1</span>
<span class="cp">#define INT_MODE_MSI			2</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">int_mode</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">int_mode</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">int_mode</span><span class="p">,</span> <span class="s">&quot; Force interrupt mode other than MSI-X &quot;</span>
				<span class="s">&quot;(1 INT#x; 2 MSI)&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">dropless_fc</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">dropless_fc</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">dropless_fc</span><span class="p">,</span> <span class="s">&quot; Pause on exhausted host ring&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">mrrs</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">mrrs</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">mrrs</span><span class="p">,</span> <span class="s">&quot; Force Max Read Req Size (0..3) (for debug)&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">debug</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="s">&quot; Default debug msglevel&quot;</span><span class="p">);</span>



<span class="k">struct</span> <span class="n">workqueue_struct</span> <span class="o">*</span><span class="n">bnx2x_wq</span><span class="p">;</span>

<span class="k">enum</span> <span class="n">bnx2x_board_type</span> <span class="p">{</span>
	<span class="n">BCM57710</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="n">BCM57711</span><span class="p">,</span>
	<span class="n">BCM57711E</span><span class="p">,</span>
	<span class="n">BCM57712</span><span class="p">,</span>
	<span class="n">BCM57712_MF</span><span class="p">,</span>
	<span class="n">BCM57800</span><span class="p">,</span>
	<span class="n">BCM57800_MF</span><span class="p">,</span>
	<span class="n">BCM57810</span><span class="p">,</span>
	<span class="n">BCM57810_MF</span><span class="p">,</span>
	<span class="n">BCM57840</span><span class="p">,</span>
	<span class="n">BCM57840_MF</span><span class="p">,</span>
	<span class="n">BCM57811</span><span class="p">,</span>
	<span class="n">BCM57811_MF</span>
<span class="p">};</span>

<span class="cm">/* indexed by board_type, above */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>
<span class="p">}</span> <span class="n">board_info</span><span class="p">[]</span> <span class="n">__devinitdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="s">&quot;Broadcom NetXtreme II BCM57710 10 Gigabit PCIe [Everest]&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;Broadcom NetXtreme II BCM57711 10 Gigabit PCIe&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;Broadcom NetXtreme II BCM57711E 10 Gigabit PCIe&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;Broadcom NetXtreme II BCM57712 10 Gigabit Ethernet&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;Broadcom NetXtreme II BCM57712 10 Gigabit Ethernet Multi Function&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;Broadcom NetXtreme II BCM57800 10 Gigabit Ethernet&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;Broadcom NetXtreme II BCM57800 10 Gigabit Ethernet Multi Function&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;Broadcom NetXtreme II BCM57810 10 Gigabit Ethernet&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;Broadcom NetXtreme II BCM57810 10 Gigabit Ethernet Multi Function&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;Broadcom NetXtreme II BCM57840 10/20 Gigabit Ethernet&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;Broadcom NetXtreme II BCM57840 10/20 Gigabit Ethernet Multi Function&quot;</span><span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;Broadcom NetXtreme II BCM57811 10 Gigabit Ethernet&quot;</span><span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;Broadcom NetXtreme II BCM57811 10 Gigabit Ethernet Multi Function&quot;</span><span class="p">},</span>
<span class="p">};</span>

<span class="cp">#ifndef PCI_DEVICE_ID_NX2_57710</span>
<span class="cp">#define PCI_DEVICE_ID_NX2_57710		CHIP_NUM_57710</span>
<span class="cp">#endif</span>
<span class="cp">#ifndef PCI_DEVICE_ID_NX2_57711</span>
<span class="cp">#define PCI_DEVICE_ID_NX2_57711		CHIP_NUM_57711</span>
<span class="cp">#endif</span>
<span class="cp">#ifndef PCI_DEVICE_ID_NX2_57711E</span>
<span class="cp">#define PCI_DEVICE_ID_NX2_57711E	CHIP_NUM_57711E</span>
<span class="cp">#endif</span>
<span class="cp">#ifndef PCI_DEVICE_ID_NX2_57712</span>
<span class="cp">#define PCI_DEVICE_ID_NX2_57712		CHIP_NUM_57712</span>
<span class="cp">#endif</span>
<span class="cp">#ifndef PCI_DEVICE_ID_NX2_57712_MF</span>
<span class="cp">#define PCI_DEVICE_ID_NX2_57712_MF	CHIP_NUM_57712_MF</span>
<span class="cp">#endif</span>
<span class="cp">#ifndef PCI_DEVICE_ID_NX2_57800</span>
<span class="cp">#define PCI_DEVICE_ID_NX2_57800		CHIP_NUM_57800</span>
<span class="cp">#endif</span>
<span class="cp">#ifndef PCI_DEVICE_ID_NX2_57800_MF</span>
<span class="cp">#define PCI_DEVICE_ID_NX2_57800_MF	CHIP_NUM_57800_MF</span>
<span class="cp">#endif</span>
<span class="cp">#ifndef PCI_DEVICE_ID_NX2_57810</span>
<span class="cp">#define PCI_DEVICE_ID_NX2_57810		CHIP_NUM_57810</span>
<span class="cp">#endif</span>
<span class="cp">#ifndef PCI_DEVICE_ID_NX2_57810_MF</span>
<span class="cp">#define PCI_DEVICE_ID_NX2_57810_MF	CHIP_NUM_57810_MF</span>
<span class="cp">#endif</span>
<span class="cp">#ifndef PCI_DEVICE_ID_NX2_57840</span>
<span class="cp">#define PCI_DEVICE_ID_NX2_57840		CHIP_NUM_57840</span>
<span class="cp">#endif</span>
<span class="cp">#ifndef PCI_DEVICE_ID_NX2_57840_MF</span>
<span class="cp">#define PCI_DEVICE_ID_NX2_57840_MF	CHIP_NUM_57840_MF</span>
<span class="cp">#endif</span>
<span class="cp">#ifndef PCI_DEVICE_ID_NX2_57811</span>
<span class="cp">#define PCI_DEVICE_ID_NX2_57811		CHIP_NUM_57811</span>
<span class="cp">#endif</span>
<span class="cp">#ifndef PCI_DEVICE_ID_NX2_57811_MF</span>
<span class="cp">#define PCI_DEVICE_ID_NX2_57811_MF	CHIP_NUM_57811_MF</span>
<span class="cp">#endif</span>
<span class="k">static</span> <span class="n">DEFINE_PCI_DEVICE_TABLE</span><span class="p">(</span><span class="n">bnx2x_pci_tbl</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">BROADCOM</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_NX2_57710</span><span class="p">),</span> <span class="n">BCM57710</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">BROADCOM</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_NX2_57711</span><span class="p">),</span> <span class="n">BCM57711</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">BROADCOM</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_NX2_57711E</span><span class="p">),</span> <span class="n">BCM57711E</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">BROADCOM</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_NX2_57712</span><span class="p">),</span> <span class="n">BCM57712</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">BROADCOM</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_NX2_57712_MF</span><span class="p">),</span> <span class="n">BCM57712_MF</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">BROADCOM</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_NX2_57800</span><span class="p">),</span> <span class="n">BCM57800</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">BROADCOM</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_NX2_57800_MF</span><span class="p">),</span> <span class="n">BCM57800_MF</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">BROADCOM</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_NX2_57810</span><span class="p">),</span> <span class="n">BCM57810</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">BROADCOM</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_NX2_57810_MF</span><span class="p">),</span> <span class="n">BCM57810_MF</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">BROADCOM</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_NX2_57840</span><span class="p">),</span> <span class="n">BCM57840</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">BROADCOM</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_NX2_57840_MF</span><span class="p">),</span> <span class="n">BCM57840_MF</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">BROADCOM</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_NX2_57811</span><span class="p">),</span> <span class="n">BCM57811</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">BROADCOM</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_NX2_57811_MF</span><span class="p">),</span> <span class="n">BCM57811_MF</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">0</span> <span class="p">}</span>
<span class="p">};</span>

<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">bnx2x_pci_tbl</span><span class="p">);</span>

<span class="cm">/* Global resources for unloading a previously loaded device */</span>
<span class="cp">#define BNX2X_PREV_WAIT_NEEDED 1</span>
<span class="k">static</span> <span class="n">DEFINE_SEMAPHORE</span><span class="p">(</span><span class="n">bnx2x_prev_sem</span><span class="p">);</span>
<span class="k">static</span> <span class="n">LIST_HEAD</span><span class="p">(</span><span class="n">bnx2x_prev_list</span><span class="p">);</span>
<span class="cm">/****************************************************************************</span>
<span class="cm">* General service functions</span>
<span class="cm">****************************************************************************/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">__storm_memset_dma_mapping</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">,</span>
				       <span class="n">u32</span> <span class="n">addr</span><span class="p">,</span> <span class="n">dma_addr_t</span> <span class="n">mapping</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span>  <span class="n">addr</span><span class="p">,</span> <span class="n">U64_LO</span><span class="p">(</span><span class="n">mapping</span><span class="p">));</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span>  <span class="n">addr</span> <span class="o">+</span> <span class="mi">4</span><span class="p">,</span> <span class="n">U64_HI</span><span class="p">(</span><span class="n">mapping</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">storm_memset_spq_addr</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">,</span>
				  <span class="n">dma_addr_t</span> <span class="n">mapping</span><span class="p">,</span> <span class="n">u16</span> <span class="n">abs_fid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">addr</span> <span class="o">=</span> <span class="n">XSEM_REG_FAST_MEMORY</span> <span class="o">+</span>
			<span class="n">XSTORM_SPQ_PAGE_BASE_OFFSET</span><span class="p">(</span><span class="n">abs_fid</span><span class="p">);</span>

	<span class="n">__storm_memset_dma_mapping</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">mapping</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">storm_memset_vf_to_pf</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">,</span> <span class="n">u16</span> <span class="n">abs_fid</span><span class="p">,</span>
				  <span class="n">u16</span> <span class="n">pf_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">REG_WR8</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">BAR_XSTRORM_INTMEM</span> <span class="o">+</span> <span class="n">XSTORM_VF_TO_PF_OFFSET</span><span class="p">(</span><span class="n">abs_fid</span><span class="p">),</span>
		<span class="n">pf_id</span><span class="p">);</span>
	<span class="n">REG_WR8</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">BAR_CSTRORM_INTMEM</span> <span class="o">+</span> <span class="n">CSTORM_VF_TO_PF_OFFSET</span><span class="p">(</span><span class="n">abs_fid</span><span class="p">),</span>
		<span class="n">pf_id</span><span class="p">);</span>
	<span class="n">REG_WR8</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">BAR_TSTRORM_INTMEM</span> <span class="o">+</span> <span class="n">TSTORM_VF_TO_PF_OFFSET</span><span class="p">(</span><span class="n">abs_fid</span><span class="p">),</span>
		<span class="n">pf_id</span><span class="p">);</span>
	<span class="n">REG_WR8</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">BAR_USTRORM_INTMEM</span> <span class="o">+</span> <span class="n">USTORM_VF_TO_PF_OFFSET</span><span class="p">(</span><span class="n">abs_fid</span><span class="p">),</span>
		<span class="n">pf_id</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">storm_memset_func_en</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">,</span> <span class="n">u16</span> <span class="n">abs_fid</span><span class="p">,</span>
				 <span class="n">u8</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">REG_WR8</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">BAR_XSTRORM_INTMEM</span> <span class="o">+</span> <span class="n">XSTORM_FUNC_EN_OFFSET</span><span class="p">(</span><span class="n">abs_fid</span><span class="p">),</span>
		<span class="n">enable</span><span class="p">);</span>
	<span class="n">REG_WR8</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">BAR_CSTRORM_INTMEM</span> <span class="o">+</span> <span class="n">CSTORM_FUNC_EN_OFFSET</span><span class="p">(</span><span class="n">abs_fid</span><span class="p">),</span>
		<span class="n">enable</span><span class="p">);</span>
	<span class="n">REG_WR8</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">BAR_TSTRORM_INTMEM</span> <span class="o">+</span> <span class="n">TSTORM_FUNC_EN_OFFSET</span><span class="p">(</span><span class="n">abs_fid</span><span class="p">),</span>
		<span class="n">enable</span><span class="p">);</span>
	<span class="n">REG_WR8</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">BAR_USTRORM_INTMEM</span> <span class="o">+</span> <span class="n">USTORM_FUNC_EN_OFFSET</span><span class="p">(</span><span class="n">abs_fid</span><span class="p">),</span>
		<span class="n">enable</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">storm_memset_eq_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">event_ring_data</span> <span class="o">*</span><span class="n">eq_data</span><span class="p">,</span>
				<span class="n">u16</span> <span class="n">pfid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">size_t</span> <span class="n">size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">event_ring_data</span><span class="p">);</span>

	<span class="n">u32</span> <span class="n">addr</span> <span class="o">=</span> <span class="n">BAR_CSTRORM_INTMEM</span> <span class="o">+</span> <span class="n">CSTORM_EVENT_RING_DATA_OFFSET</span><span class="p">(</span><span class="n">pfid</span><span class="p">);</span>

	<span class="n">__storm_memset_struct</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="n">eq_data</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">storm_memset_eq_prod</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">,</span> <span class="n">u16</span> <span class="n">eq_prod</span><span class="p">,</span>
				 <span class="n">u16</span> <span class="n">pfid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">addr</span> <span class="o">=</span> <span class="n">BAR_CSTRORM_INTMEM</span> <span class="o">+</span> <span class="n">CSTORM_EVENT_RING_PROD_OFFSET</span><span class="p">(</span><span class="n">pfid</span><span class="p">);</span>
	<span class="n">REG_WR16</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">eq_prod</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* used only at init</span>
<span class="cm"> * locking is done by mcp</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_reg_wr_ind</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">,</span> <span class="n">u32</span> <span class="n">addr</span><span class="p">,</span> <span class="n">u32</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCICFG_GRC_ADDRESS</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
	<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCICFG_GRC_DATA</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCICFG_GRC_ADDRESS</span><span class="p">,</span>
			       <span class="n">PCICFG_VENDOR_ID_OFFSET</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">bnx2x_reg_rd_ind</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">,</span> <span class="n">u32</span> <span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCICFG_GRC_ADDRESS</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
	<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCICFG_GRC_DATA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
	<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCICFG_GRC_ADDRESS</span><span class="p">,</span>
			       <span class="n">PCICFG_VENDOR_ID_OFFSET</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">val</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define DMAE_DP_SRC_GRC		&quot;grc src_addr [%08x]&quot;</span>
<span class="cp">#define DMAE_DP_SRC_PCI		&quot;pci src_addr [%x:%08x]&quot;</span>
<span class="cp">#define DMAE_DP_DST_GRC		&quot;grc dst_addr [%08x]&quot;</span>
<span class="cp">#define DMAE_DP_DST_PCI		&quot;pci dst_addr [%x:%08x]&quot;</span>
<span class="cp">#define DMAE_DP_DST_NONE	&quot;dst_addr [none]&quot;</span>


<span class="cm">/* copy command into DMAE command memory and set DMAE command go */</span>
<span class="kt">void</span> <span class="nf">bnx2x_post_dmae</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dmae_command</span> <span class="o">*</span><span class="n">dmae</span><span class="p">,</span> <span class="kt">int</span> <span class="n">idx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">cmd_offset</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">cmd_offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">DMAE_REG_CMD_MEM</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">dmae_command</span><span class="p">)</span> <span class="o">*</span> <span class="n">idx</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">dmae_command</span><span class="p">)</span><span class="o">/</span><span class="mi">4</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">cmd_offset</span> <span class="o">+</span> <span class="n">i</span><span class="o">*</span><span class="mi">4</span><span class="p">,</span> <span class="o">*</span><span class="p">(((</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="n">dmae</span><span class="p">)</span> <span class="o">+</span> <span class="n">i</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">dmae_reg_go_c</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">u32</span> <span class="nf">bnx2x_dmae_opcode_add_comp</span><span class="p">(</span><span class="n">u32</span> <span class="n">opcode</span><span class="p">,</span> <span class="n">u8</span> <span class="n">comp_type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">opcode</span> <span class="o">|</span> <span class="p">((</span><span class="n">comp_type</span> <span class="o">&lt;&lt;</span> <span class="n">DMAE_COMMAND_C_DST_SHIFT</span><span class="p">)</span> <span class="o">|</span>
			   <span class="n">DMAE_CMD_C_ENABLE</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">u32</span> <span class="nf">bnx2x_dmae_opcode_clr_src_reset</span><span class="p">(</span><span class="n">u32</span> <span class="n">opcode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">opcode</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">DMAE_CMD_SRC_RESET</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">u32</span> <span class="nf">bnx2x_dmae_opcode</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">,</span> <span class="n">u8</span> <span class="n">src_type</span><span class="p">,</span> <span class="n">u8</span> <span class="n">dst_type</span><span class="p">,</span>
			     <span class="n">bool</span> <span class="n">with_comp</span><span class="p">,</span> <span class="n">u8</span> <span class="n">comp_type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">opcode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">opcode</span> <span class="o">|=</span> <span class="p">((</span><span class="n">src_type</span> <span class="o">&lt;&lt;</span> <span class="n">DMAE_COMMAND_SRC_SHIFT</span><span class="p">)</span> <span class="o">|</span>
		   <span class="p">(</span><span class="n">dst_type</span> <span class="o">&lt;&lt;</span> <span class="n">DMAE_COMMAND_DST_SHIFT</span><span class="p">));</span>

	<span class="n">opcode</span> <span class="o">|=</span> <span class="p">(</span><span class="n">DMAE_CMD_SRC_RESET</span> <span class="o">|</span> <span class="n">DMAE_CMD_DST_RESET</span><span class="p">);</span>

	<span class="n">opcode</span> <span class="o">|=</span> <span class="p">(</span><span class="n">BP_PORT</span><span class="p">(</span><span class="n">bp</span><span class="p">)</span> <span class="o">?</span> <span class="n">DMAE_CMD_PORT_1</span> <span class="o">:</span> <span class="n">DMAE_CMD_PORT_0</span><span class="p">);</span>
	<span class="n">opcode</span> <span class="o">|=</span> <span class="p">((</span><span class="n">BP_VN</span><span class="p">(</span><span class="n">bp</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">DMAE_CMD_E1HVN_SHIFT</span><span class="p">)</span> <span class="o">|</span>
		   <span class="p">(</span><span class="n">BP_VN</span><span class="p">(</span><span class="n">bp</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">DMAE_COMMAND_DST_VN_SHIFT</span><span class="p">));</span>
	<span class="n">opcode</span> <span class="o">|=</span> <span class="p">(</span><span class="n">DMAE_COM_SET_ERR</span> <span class="o">&lt;&lt;</span> <span class="n">DMAE_COMMAND_ERR_POLICY_SHIFT</span><span class="p">);</span>

<span class="cp">#ifdef __BIG_ENDIAN</span>
	<span class="n">opcode</span> <span class="o">|=</span> <span class="n">DMAE_CMD_ENDIANITY_B_DW_SWAP</span><span class="p">;</span>
<span class="cp">#else</span>
	<span class="n">opcode</span> <span class="o">|=</span> <span class="n">DMAE_CMD_ENDIANITY_DW_SWAP</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">with_comp</span><span class="p">)</span>
		<span class="n">opcode</span> <span class="o">=</span> <span class="n">bnx2x_dmae_opcode_add_comp</span><span class="p">(</span><span class="n">opcode</span><span class="p">,</span> <span class="n">comp_type</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">opcode</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_prep_dmae_with_comp</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">dmae_command</span> <span class="o">*</span><span class="n">dmae</span><span class="p">,</span>
				      <span class="n">u8</span> <span class="n">src_type</span><span class="p">,</span> <span class="n">u8</span> <span class="n">dst_type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">dmae</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">dmae_command</span><span class="p">));</span>

	<span class="cm">/* set the opcode */</span>
	<span class="n">dmae</span><span class="o">-&gt;</span><span class="n">opcode</span> <span class="o">=</span> <span class="n">bnx2x_dmae_opcode</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">src_type</span><span class="p">,</span> <span class="n">dst_type</span><span class="p">,</span>
					 <span class="nb">true</span><span class="p">,</span> <span class="n">DMAE_COMP_PCI</span><span class="p">);</span>

	<span class="cm">/* fill in the completion parameters */</span>
	<span class="n">dmae</span><span class="o">-&gt;</span><span class="n">comp_addr_lo</span> <span class="o">=</span> <span class="n">U64_LO</span><span class="p">(</span><span class="n">bnx2x_sp_mapping</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">wb_comp</span><span class="p">));</span>
	<span class="n">dmae</span><span class="o">-&gt;</span><span class="n">comp_addr_hi</span> <span class="o">=</span> <span class="n">U64_HI</span><span class="p">(</span><span class="n">bnx2x_sp_mapping</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">wb_comp</span><span class="p">));</span>
	<span class="n">dmae</span><span class="o">-&gt;</span><span class="n">comp_val</span> <span class="o">=</span> <span class="n">DMAE_COMP_VAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* issue a dmae command over the init-channel and wailt for completion */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">bnx2x_issue_dmae_with_comp</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">dmae_command</span> <span class="o">*</span><span class="n">dmae</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">wb_comp</span> <span class="o">=</span> <span class="n">bnx2x_sp</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">wb_comp</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">cnt</span> <span class="o">=</span> <span class="n">CHIP_REV_IS_SLOW</span><span class="p">(</span><span class="n">bp</span><span class="p">)</span> <span class="o">?</span> <span class="p">(</span><span class="mi">400000</span><span class="p">)</span> <span class="o">:</span> <span class="mi">4000</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Lock the dmae channel. Disable BHs to prevent a dead-lock</span>
<span class="cm">	 * as long as this code is called both from syscall context and</span>
<span class="cm">	 * from ndo_set_rx_mode() flow that may be called from BH.</span>
<span class="cm">	 */</span>
	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">dmae_lock</span><span class="p">);</span>

	<span class="cm">/* reset completion */</span>
	<span class="o">*</span><span class="n">wb_comp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* post the command on the channel used for initializations */</span>
	<span class="n">bnx2x_post_dmae</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">dmae</span><span class="p">,</span> <span class="n">INIT_DMAE_C</span><span class="p">(</span><span class="n">bp</span><span class="p">));</span>

	<span class="cm">/* wait for completion */</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">((</span><span class="o">*</span><span class="n">wb_comp</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">DMAE_PCI_ERR_FLAG</span><span class="p">)</span> <span class="o">!=</span> <span class="n">DMAE_COMP_VAL</span><span class="p">)</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cnt</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">recovery_state</span> <span class="o">!=</span> <span class="n">BNX2X_RECOVERY_DONE</span> <span class="o">&amp;&amp;</span>
		     <span class="n">bp</span><span class="o">-&gt;</span><span class="n">recovery_state</span> <span class="o">!=</span> <span class="n">BNX2X_RECOVERY_NIC_LOADING</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">BNX2X_ERR</span><span class="p">(</span><span class="s">&quot;DMAE timeout!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">DMAE_TIMEOUT</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">unlock</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">cnt</span><span class="o">--</span><span class="p">;</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">50</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">wb_comp</span> <span class="o">&amp;</span> <span class="n">DMAE_PCI_ERR_FLAG</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BNX2X_ERR</span><span class="p">(</span><span class="s">&quot;DMAE PCI error!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">DMAE_PCI_ERROR</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">unlock:</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">dmae_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">bnx2x_write_dmae</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">,</span> <span class="n">dma_addr_t</span> <span class="n">dma_addr</span><span class="p">,</span> <span class="n">u32</span> <span class="n">dst_addr</span><span class="p">,</span>
		      <span class="n">u32</span> <span class="n">len32</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dmae_command</span> <span class="n">dmae</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">dmae_ready</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">bnx2x_sp</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">wb_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">CHIP_IS_E1</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span>
			<span class="n">bnx2x_init_ind_wr</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">dst_addr</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">len32</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">bnx2x_init_str_wr</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">dst_addr</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">len32</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* set opcode and fixed command fields */</span>
	<span class="n">bnx2x_prep_dmae_with_comp</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dmae</span><span class="p">,</span> <span class="n">DMAE_SRC_PCI</span><span class="p">,</span> <span class="n">DMAE_DST_GRC</span><span class="p">);</span>

	<span class="cm">/* fill in addresses and len */</span>
	<span class="n">dmae</span><span class="p">.</span><span class="n">src_addr_lo</span> <span class="o">=</span> <span class="n">U64_LO</span><span class="p">(</span><span class="n">dma_addr</span><span class="p">);</span>
	<span class="n">dmae</span><span class="p">.</span><span class="n">src_addr_hi</span> <span class="o">=</span> <span class="n">U64_HI</span><span class="p">(</span><span class="n">dma_addr</span><span class="p">);</span>
	<span class="n">dmae</span><span class="p">.</span><span class="n">dst_addr_lo</span> <span class="o">=</span> <span class="n">dst_addr</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">dmae</span><span class="p">.</span><span class="n">dst_addr_hi</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dmae</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">len32</span><span class="p">;</span>

	<span class="cm">/* issue the command and wait for completion */</span>
	<span class="n">bnx2x_issue_dmae_with_comp</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dmae</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">bnx2x_read_dmae</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">,</span> <span class="n">u32</span> <span class="n">src_addr</span><span class="p">,</span> <span class="n">u32</span> <span class="n">len32</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dmae_command</span> <span class="n">dmae</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">dmae_ready</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">bnx2x_sp</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">wb_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">CHIP_IS_E1</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">len32</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
				<span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">bnx2x_reg_rd_ind</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">src_addr</span> <span class="o">+</span> <span class="n">i</span><span class="o">*</span><span class="mi">4</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">len32</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
				<span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">src_addr</span> <span class="o">+</span> <span class="n">i</span><span class="o">*</span><span class="mi">4</span><span class="p">);</span>

		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* set opcode and fixed command fields */</span>
	<span class="n">bnx2x_prep_dmae_with_comp</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dmae</span><span class="p">,</span> <span class="n">DMAE_SRC_GRC</span><span class="p">,</span> <span class="n">DMAE_DST_PCI</span><span class="p">);</span>

	<span class="cm">/* fill in addresses and len */</span>
	<span class="n">dmae</span><span class="p">.</span><span class="n">src_addr_lo</span> <span class="o">=</span> <span class="n">src_addr</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">dmae</span><span class="p">.</span><span class="n">src_addr_hi</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dmae</span><span class="p">.</span><span class="n">dst_addr_lo</span> <span class="o">=</span> <span class="n">U64_LO</span><span class="p">(</span><span class="n">bnx2x_sp_mapping</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">wb_data</span><span class="p">));</span>
	<span class="n">dmae</span><span class="p">.</span><span class="n">dst_addr_hi</span> <span class="o">=</span> <span class="n">U64_HI</span><span class="p">(</span><span class="n">bnx2x_sp_mapping</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">wb_data</span><span class="p">));</span>
	<span class="n">dmae</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">len32</span><span class="p">;</span>

	<span class="cm">/* issue the command and wait for completion */</span>
	<span class="n">bnx2x_issue_dmae_with_comp</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dmae</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_write_dmae_phys_len</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">,</span> <span class="n">dma_addr_t</span> <span class="n">phys_addr</span><span class="p">,</span>
				      <span class="n">u32</span> <span class="n">addr</span><span class="p">,</span> <span class="n">u32</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">dmae_wr_max</span> <span class="o">=</span> <span class="n">DMAE_LEN32_WR_MAX</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">dmae_wr_max</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bnx2x_write_dmae</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phys_addr</span> <span class="o">+</span> <span class="n">offset</span><span class="p">,</span>
				 <span class="n">addr</span> <span class="o">+</span> <span class="n">offset</span><span class="p">,</span> <span class="n">dmae_wr_max</span><span class="p">);</span>
		<span class="n">offset</span> <span class="o">+=</span> <span class="n">dmae_wr_max</span> <span class="o">*</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">len</span> <span class="o">-=</span> <span class="n">dmae_wr_max</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">bnx2x_write_dmae</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phys_addr</span> <span class="o">+</span> <span class="n">offset</span><span class="p">,</span> <span class="n">addr</span> <span class="o">+</span> <span class="n">offset</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bnx2x_mc_assert</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">last_idx</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">row0</span><span class="p">,</span> <span class="n">row1</span><span class="p">,</span> <span class="n">row2</span><span class="p">,</span> <span class="n">row3</span><span class="p">;</span>

	<span class="cm">/* XSTORM */</span>
	<span class="n">last_idx</span> <span class="o">=</span> <span class="n">REG_RD8</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">BAR_XSTRORM_INTMEM</span> <span class="o">+</span>
			   <span class="n">XSTORM_ASSERT_LIST_INDEX_OFFSET</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">last_idx</span><span class="p">)</span>
		<span class="n">BNX2X_ERR</span><span class="p">(</span><span class="s">&quot;XSTORM_ASSERT_LIST_INDEX 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">last_idx</span><span class="p">);</span>

	<span class="cm">/* print the asserts */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">STROM_ASSERT_ARRAY_SIZE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">row0</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">BAR_XSTRORM_INTMEM</span> <span class="o">+</span>
			      <span class="n">XSTORM_ASSERT_LIST_OFFSET</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
		<span class="n">row1</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">BAR_XSTRORM_INTMEM</span> <span class="o">+</span>
			      <span class="n">XSTORM_ASSERT_LIST_OFFSET</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>
		<span class="n">row2</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">BAR_XSTRORM_INTMEM</span> <span class="o">+</span>
			      <span class="n">XSTORM_ASSERT_LIST_OFFSET</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="mi">8</span><span class="p">);</span>
		<span class="n">row3</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">BAR_XSTRORM_INTMEM</span> <span class="o">+</span>
			      <span class="n">XSTORM_ASSERT_LIST_OFFSET</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="mi">12</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">row0</span> <span class="o">!=</span> <span class="n">COMMON_ASM_INVALID_ASSERT_OPCODE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">BNX2X_ERR</span><span class="p">(</span><span class="s">&quot;XSTORM_ASSERT_INDEX 0x%x = 0x%08x 0x%08x 0x%08x 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				  <span class="n">i</span><span class="p">,</span> <span class="n">row3</span><span class="p">,</span> <span class="n">row2</span><span class="p">,</span> <span class="n">row1</span><span class="p">,</span> <span class="n">row0</span><span class="p">);</span>
			<span class="n">rc</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* TSTORM */</span>
	<span class="n">last_idx</span> <span class="o">=</span> <span class="n">REG_RD8</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">BAR_TSTRORM_INTMEM</span> <span class="o">+</span>
			   <span class="n">TSTORM_ASSERT_LIST_INDEX_OFFSET</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">last_idx</span><span class="p">)</span>
		<span class="n">BNX2X_ERR</span><span class="p">(</span><span class="s">&quot;TSTORM_ASSERT_LIST_INDEX 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">last_idx</span><span class="p">);</span>

	<span class="cm">/* print the asserts */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">STROM_ASSERT_ARRAY_SIZE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">row0</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">BAR_TSTRORM_INTMEM</span> <span class="o">+</span>
			      <span class="n">TSTORM_ASSERT_LIST_OFFSET</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
		<span class="n">row1</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">BAR_TSTRORM_INTMEM</span> <span class="o">+</span>
			      <span class="n">TSTORM_ASSERT_LIST_OFFSET</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>
		<span class="n">row2</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">BAR_TSTRORM_INTMEM</span> <span class="o">+</span>
			      <span class="n">TSTORM_ASSERT_LIST_OFFSET</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="mi">8</span><span class="p">);</span>
		<span class="n">row3</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">BAR_TSTRORM_INTMEM</span> <span class="o">+</span>
			      <span class="n">TSTORM_ASSERT_LIST_OFFSET</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="mi">12</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">row0</span> <span class="o">!=</span> <span class="n">COMMON_ASM_INVALID_ASSERT_OPCODE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">BNX2X_ERR</span><span class="p">(</span><span class="s">&quot;TSTORM_ASSERT_INDEX 0x%x = 0x%08x 0x%08x 0x%08x 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				  <span class="n">i</span><span class="p">,</span> <span class="n">row3</span><span class="p">,</span> <span class="n">row2</span><span class="p">,</span> <span class="n">row1</span><span class="p">,</span> <span class="n">row0</span><span class="p">);</span>
			<span class="n">rc</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* CSTORM */</span>
	<span class="n">last_idx</span> <span class="o">=</span> <span class="n">REG_RD8</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">BAR_CSTRORM_INTMEM</span> <span class="o">+</span>
			   <span class="n">CSTORM_ASSERT_LIST_INDEX_OFFSET</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">last_idx</span><span class="p">)</span>
		<span class="n">BNX2X_ERR</span><span class="p">(</span><span class="s">&quot;CSTORM_ASSERT_LIST_INDEX 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">last_idx</span><span class="p">);</span>

	<span class="cm">/* print the asserts */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">STROM_ASSERT_ARRAY_SIZE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">row0</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">BAR_CSTRORM_INTMEM</span> <span class="o">+</span>
			      <span class="n">CSTORM_ASSERT_LIST_OFFSET</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
		<span class="n">row1</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">BAR_CSTRORM_INTMEM</span> <span class="o">+</span>
			      <span class="n">CSTORM_ASSERT_LIST_OFFSET</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>
		<span class="n">row2</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">BAR_CSTRORM_INTMEM</span> <span class="o">+</span>
			      <span class="n">CSTORM_ASSERT_LIST_OFFSET</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="mi">8</span><span class="p">);</span>
		<span class="n">row3</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">BAR_CSTRORM_INTMEM</span> <span class="o">+</span>
			      <span class="n">CSTORM_ASSERT_LIST_OFFSET</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="mi">12</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">row0</span> <span class="o">!=</span> <span class="n">COMMON_ASM_INVALID_ASSERT_OPCODE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">BNX2X_ERR</span><span class="p">(</span><span class="s">&quot;CSTORM_ASSERT_INDEX 0x%x = 0x%08x 0x%08x 0x%08x 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				  <span class="n">i</span><span class="p">,</span> <span class="n">row3</span><span class="p">,</span> <span class="n">row2</span><span class="p">,</span> <span class="n">row1</span><span class="p">,</span> <span class="n">row0</span><span class="p">);</span>
			<span class="n">rc</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* USTORM */</span>
	<span class="n">last_idx</span> <span class="o">=</span> <span class="n">REG_RD8</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">BAR_USTRORM_INTMEM</span> <span class="o">+</span>
			   <span class="n">USTORM_ASSERT_LIST_INDEX_OFFSET</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">last_idx</span><span class="p">)</span>
		<span class="n">BNX2X_ERR</span><span class="p">(</span><span class="s">&quot;USTORM_ASSERT_LIST_INDEX 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">last_idx</span><span class="p">);</span>

	<span class="cm">/* print the asserts */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">STROM_ASSERT_ARRAY_SIZE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">row0</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">BAR_USTRORM_INTMEM</span> <span class="o">+</span>
			      <span class="n">USTORM_ASSERT_LIST_OFFSET</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
		<span class="n">row1</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">BAR_USTRORM_INTMEM</span> <span class="o">+</span>
			      <span class="n">USTORM_ASSERT_LIST_OFFSET</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>
		<span class="n">row2</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">BAR_USTRORM_INTMEM</span> <span class="o">+</span>
			      <span class="n">USTORM_ASSERT_LIST_OFFSET</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="mi">8</span><span class="p">);</span>
		<span class="n">row3</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">BAR_USTRORM_INTMEM</span> <span class="o">+</span>
			      <span class="n">USTORM_ASSERT_LIST_OFFSET</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="mi">12</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">row0</span> <span class="o">!=</span> <span class="n">COMMON_ASM_INVALID_ASSERT_OPCODE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">BNX2X_ERR</span><span class="p">(</span><span class="s">&quot;USTORM_ASSERT_INDEX 0x%x = 0x%08x 0x%08x 0x%08x 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				  <span class="n">i</span><span class="p">,</span> <span class="n">row3</span><span class="p">,</span> <span class="n">row2</span><span class="p">,</span> <span class="n">row1</span><span class="p">,</span> <span class="n">row0</span><span class="p">);</span>
			<span class="n">rc</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">bnx2x_fw_dump_lvl</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">lvl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">addr</span><span class="p">,</span> <span class="n">val</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">mark</span><span class="p">,</span> <span class="n">offset</span><span class="p">;</span>
	<span class="n">__be32</span> <span class="n">data</span><span class="p">[</span><span class="mi">9</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">word</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">trace_shmem_base</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">BP_NOMCP</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">BNX2X_ERR</span><span class="p">(</span><span class="s">&quot;NO MCP - can not dump</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">netdev_printk</span><span class="p">(</span><span class="n">lvl</span><span class="p">,</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;bc %d.%d.%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">.</span><span class="n">bc_ver</span> <span class="o">&amp;</span> <span class="mh">0xff0000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">,</span>
		<span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">.</span><span class="n">bc_ver</span> <span class="o">&amp;</span> <span class="mh">0xff00</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">,</span>
		<span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">.</span><span class="n">bc_ver</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">));</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">MCP_REG_MCPR_CPU_PROGRAM_COUNTER</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">==</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">MCP_REG_MCPR_CPU_PROGRAM_COUNTER</span><span class="p">))</span>
		<span class="n">BNX2X_ERR</span><span class="p">(</span><span class="s">&quot;%s&quot;</span> <span class="s">&quot;MCP PC at 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">lvl</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">BP_PATH</span><span class="p">(</span><span class="n">bp</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">trace_shmem_base</span> <span class="o">=</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">.</span><span class="n">shmem_base</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">trace_shmem_base</span> <span class="o">=</span> <span class="n">SHMEM2_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">other_shmem_base_addr</span><span class="p">);</span>
	<span class="n">addr</span> <span class="o">=</span> <span class="n">trace_shmem_base</span> <span class="o">-</span> <span class="mh">0x800</span><span class="p">;</span>

	<span class="cm">/* validate TRCB signature */</span>
	<span class="n">mark</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mark</span> <span class="o">!=</span> <span class="n">MFW_TRACE_SIGNATURE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BNX2X_ERR</span><span class="p">(</span><span class="s">&quot;Trace buffer signature is missing.&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* read cyclic buffer pointer */</span>
	<span class="n">addr</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">mark</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
	<span class="n">mark</span> <span class="o">=</span> <span class="p">(</span><span class="n">CHIP_IS_E1x</span><span class="p">(</span><span class="n">bp</span><span class="p">)</span> <span class="o">?</span> <span class="n">MCP_REG_MCPR_SCRATCH</span> <span class="o">:</span> <span class="n">MCP_A_REG_MCPR_SCRATCH</span><span class="p">)</span>
			<span class="o">+</span> <span class="p">((</span><span class="n">mark</span> <span class="o">+</span> <span class="mh">0x3</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x3</span><span class="p">)</span> <span class="o">-</span> <span class="mh">0x08000000</span><span class="p">;</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s&quot;</span> <span class="s">&quot;begin fw dump (mark 0x%x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">lvl</span><span class="p">,</span> <span class="n">mark</span><span class="p">);</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">lvl</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">offset</span> <span class="o">=</span> <span class="n">mark</span><span class="p">;</span> <span class="n">offset</span> <span class="o">&lt;=</span> <span class="n">trace_shmem_base</span><span class="p">;</span> <span class="n">offset</span> <span class="o">+=</span> <span class="mh">0x8</span><span class="o">*</span><span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">word</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">word</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">word</span><span class="o">++</span><span class="p">)</span>
			<span class="n">data</span><span class="p">[</span><span class="n">word</span><span class="p">]</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">offset</span> <span class="o">+</span> <span class="mi">4</span><span class="o">*</span><span class="n">word</span><span class="p">));</span>
		<span class="n">data</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>
		<span class="n">pr_cont</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">offset</span> <span class="o">=</span> <span class="n">addr</span> <span class="o">+</span> <span class="mi">4</span><span class="p">;</span> <span class="n">offset</span> <span class="o">&lt;=</span> <span class="n">mark</span><span class="p">;</span> <span class="n">offset</span> <span class="o">+=</span> <span class="mh">0x8</span><span class="o">*</span><span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">word</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">word</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">word</span><span class="o">++</span><span class="p">)</span>
			<span class="n">data</span><span class="p">[</span><span class="n">word</span><span class="p">]</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">offset</span> <span class="o">+</span> <span class="mi">4</span><span class="o">*</span><span class="n">word</span><span class="p">));</span>
		<span class="n">data</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>
		<span class="n">pr_cont</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s&quot;</span> <span class="s">&quot;end of fw dump</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">lvl</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_fw_dump</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bnx2x_fw_dump_lvl</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">bnx2x_panic_dump</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">j</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hc_sp_status_block_data</span> <span class="n">sp_sb_data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">func</span> <span class="o">=</span> <span class="n">BP_FUNC</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
<span class="cp">#ifdef BNX2X_STOP_ON_ERROR</span>
	<span class="n">u16</span> <span class="n">start</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">cos</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="n">bp</span><span class="o">-&gt;</span><span class="n">stats_state</span> <span class="o">=</span> <span class="n">STATS_STATE_DISABLED</span><span class="p">;</span>
	<span class="n">bp</span><span class="o">-&gt;</span><span class="n">eth_stats</span><span class="p">.</span><span class="n">unrecoverable_error</span><span class="o">++</span><span class="p">;</span>
	<span class="n">DP</span><span class="p">(</span><span class="n">BNX2X_MSG_STATS</span><span class="p">,</span> <span class="s">&quot;stats_state - DISABLED</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">BNX2X_ERR</span><span class="p">(</span><span class="s">&quot;begin crash dump -----------------</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* Indices */</span>
	<span class="cm">/* Common */</span>
	<span class="n">BNX2X_ERR</span><span class="p">(</span><span class="s">&quot;def_idx(0x%x)  def_att_idx(0x%x)  attn_state(0x%x)  spq_prod_idx(0x%x) next_stats_cnt(0x%x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		  <span class="n">bp</span><span class="o">-&gt;</span><span class="n">def_idx</span><span class="p">,</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">def_att_idx</span><span class="p">,</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">attn_state</span><span class="p">,</span>
		  <span class="n">bp</span><span class="o">-&gt;</span><span class="n">spq_prod_idx</span><span class="p">,</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">stats_counter</span><span class="p">);</span>
	<span class="n">BNX2X_ERR</span><span class="p">(</span><span class="s">&quot;DSB: attn bits(0x%x)  ack(0x%x)  id(0x%x)  idx(0x%x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		  <span class="n">bp</span><span class="o">-&gt;</span><span class="n">def_status_blk</span><span class="o">-&gt;</span><span class="n">atten_status_block</span><span class="p">.</span><span class="n">attn_bits</span><span class="p">,</span>
		  <span class="n">bp</span><span class="o">-&gt;</span><span class="n">def_status_blk</span><span class="o">-&gt;</span><span class="n">atten_status_block</span><span class="p">.</span><span class="n">attn_bits_ack</span><span class="p">,</span>
		  <span class="n">bp</span><span class="o">-&gt;</span><span class="n">def_status_blk</span><span class="o">-&gt;</span><span class="n">atten_status_block</span><span class="p">.</span><span class="n">status_block_id</span><span class="p">,</span>
		  <span class="n">bp</span><span class="o">-&gt;</span><span class="n">def_status_blk</span><span class="o">-&gt;</span><span class="n">atten_status_block</span><span class="p">.</span><span class="n">attn_bits_index</span><span class="p">);</span>
	<span class="n">BNX2X_ERR</span><span class="p">(</span><span class="s">&quot;     def (&quot;</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">HC_SP_SB_MAX_INDICES</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">pr_cont</span><span class="p">(</span><span class="s">&quot;0x%x%s&quot;</span><span class="p">,</span>
			<span class="n">bp</span><span class="o">-&gt;</span><span class="n">def_status_blk</span><span class="o">-&gt;</span><span class="n">sp_sb</span><span class="p">.</span><span class="n">index_values</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
			<span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">HC_SP_SB_MAX_INDICES</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;)  &quot;</span> <span class="o">:</span> <span class="s">&quot; &quot;</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">hc_sp_status_block_data</span><span class="p">)</span><span class="o">/</span><span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="o">*</span><span class="p">((</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">sp_sb_data</span> <span class="o">+</span> <span class="n">i</span><span class="p">)</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">BAR_CSTRORM_INTMEM</span> <span class="o">+</span>
			<span class="n">CSTORM_SP_STATUS_BLOCK_DATA_OFFSET</span><span class="p">(</span><span class="n">func</span><span class="p">)</span> <span class="o">+</span>
			<span class="n">i</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">));</span>

	<span class="n">pr_cont</span><span class="p">(</span><span class="s">&quot;igu_sb_id(0x%x)  igu_seg_id(0x%x) pf_id(0x%x)  vnic_id(0x%x)  vf_id(0x%x)  vf_valid (0x%x) state(0x%x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">sp_sb_data</span><span class="p">.</span><span class="n">igu_sb_id</span><span class="p">,</span>
	       <span class="n">sp_sb_data</span><span class="p">.</span><span class="n">igu_seg_id</span><span class="p">,</span>
	       <span class="n">sp_sb_data</span><span class="p">.</span><span class="n">p_func</span><span class="p">.</span><span class="n">pf_id</span><span class="p">,</span>
	       <span class="n">sp_sb_data</span><span class="p">.</span><span class="n">p_func</span><span class="p">.</span><span class="n">vnic_id</span><span class="p">,</span>
	       <span class="n">sp_sb_data</span><span class="p">.</span><span class="n">p_func</span><span class="p">.</span><span class="n">vf_id</span><span class="p">,</span>
	       <span class="n">sp_sb_data</span><span class="p">.</span><span class="n">p_func</span><span class="p">.</span><span class="n">vf_valid</span><span class="p">,</span>
	       <span class="n">sp_sb_data</span><span class="p">.</span><span class="n">state</span><span class="p">);</span>


	<span class="n">for_each_eth_queue</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">bnx2x_fastpath</span> <span class="o">*</span><span class="n">fp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">fp</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="kt">int</span> <span class="n">loop</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">hc_status_block_data_e2</span> <span class="n">sb_data_e2</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">hc_status_block_data_e1x</span> <span class="n">sb_data_e1x</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">hc_status_block_sm</span>  <span class="o">*</span><span class="n">hc_sm_p</span> <span class="o">=</span>
			<span class="n">CHIP_IS_E1x</span><span class="p">(</span><span class="n">bp</span><span class="p">)</span> <span class="o">?</span>
			<span class="n">sb_data_e1x</span><span class="p">.</span><span class="n">common</span><span class="p">.</span><span class="n">state_machine</span> <span class="o">:</span>
			<span class="n">sb_data_e2</span><span class="p">.</span><span class="n">common</span><span class="p">.</span><span class="n">state_machine</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">hc_index_data</span> <span class="o">*</span><span class="n">hc_index_p</span> <span class="o">=</span>
			<span class="n">CHIP_IS_E1x</span><span class="p">(</span><span class="n">bp</span><span class="p">)</span> <span class="o">?</span>
			<span class="n">sb_data_e1x</span><span class="p">.</span><span class="n">index_data</span> <span class="o">:</span>
			<span class="n">sb_data_e2</span><span class="p">.</span><span class="n">index_data</span><span class="p">;</span>
		<span class="n">u8</span> <span class="n">data_size</span><span class="p">,</span> <span class="n">cos</span><span class="p">;</span>
		<span class="n">u32</span> <span class="o">*</span><span class="n">sb_data_p</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">bnx2x_fp_txdata</span> <span class="n">txdata</span><span class="p">;</span>

		<span class="cm">/* Rx */</span>
		<span class="n">BNX2X_ERR</span><span class="p">(</span><span class="s">&quot;fp%d: rx_bd_prod(0x%x)  rx_bd_cons(0x%x)  rx_comp_prod(0x%x)  rx_comp_cons(0x%x)  *rx_cons_sb(0x%x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">i</span><span class="p">,</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">rx_bd_prod</span><span class="p">,</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">rx_bd_cons</span><span class="p">,</span>
			  <span class="n">fp</span><span class="o">-&gt;</span><span class="n">rx_comp_prod</span><span class="p">,</span>
			  <span class="n">fp</span><span class="o">-&gt;</span><span class="n">rx_comp_cons</span><span class="p">,</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="o">*</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">rx_cons_sb</span><span class="p">));</span>
		<span class="n">BNX2X_ERR</span><span class="p">(</span><span class="s">&quot;     rx_sge_prod(0x%x)  last_max_sge(0x%x)  fp_hc_idx(0x%x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">fp</span><span class="o">-&gt;</span><span class="n">rx_sge_prod</span><span class="p">,</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">last_max_sge</span><span class="p">,</span>
			  <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">fp_hc_idx</span><span class="p">));</span>

		<span class="cm">/* Tx */</span>
		<span class="n">for_each_cos_in_tx_queue</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">cos</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">txdata</span> <span class="o">=</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">txdata</span><span class="p">[</span><span class="n">cos</span><span class="p">];</span>
			<span class="n">BNX2X_ERR</span><span class="p">(</span><span class="s">&quot;fp%d: tx_pkt_prod(0x%x)  tx_pkt_cons(0x%x)  tx_bd_prod(0x%x)  tx_bd_cons(0x%x)  *tx_cons_sb(0x%x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				  <span class="n">i</span><span class="p">,</span> <span class="n">txdata</span><span class="p">.</span><span class="n">tx_pkt_prod</span><span class="p">,</span>
				  <span class="n">txdata</span><span class="p">.</span><span class="n">tx_pkt_cons</span><span class="p">,</span> <span class="n">txdata</span><span class="p">.</span><span class="n">tx_bd_prod</span><span class="p">,</span>
				  <span class="n">txdata</span><span class="p">.</span><span class="n">tx_bd_cons</span><span class="p">,</span>
				  <span class="n">le16_to_cpu</span><span class="p">(</span><span class="o">*</span><span class="n">txdata</span><span class="p">.</span><span class="n">tx_cons_sb</span><span class="p">));</span>
		<span class="p">}</span>

		<span class="n">loop</span> <span class="o">=</span> <span class="n">CHIP_IS_E1x</span><span class="p">(</span><span class="n">bp</span><span class="p">)</span> <span class="o">?</span>
			<span class="n">HC_SB_MAX_INDICES_E1X</span> <span class="o">:</span> <span class="n">HC_SB_MAX_INDICES_E2</span><span class="p">;</span>

		<span class="cm">/* host sb data */</span>

<span class="cp">#ifdef BCM_CNIC</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_FCOE_FP</span><span class="p">(</span><span class="n">fp</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>
<span class="cp">#endif</span>
		<span class="n">BNX2X_ERR</span><span class="p">(</span><span class="s">&quot;     run indexes (&quot;</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">HC_SB_MAX_SM</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
			<span class="n">pr_cont</span><span class="p">(</span><span class="s">&quot;0x%x%s&quot;</span><span class="p">,</span>
			       <span class="n">fp</span><span class="o">-&gt;</span><span class="n">sb_running_index</span><span class="p">[</span><span class="n">j</span><span class="p">],</span>
			       <span class="p">(</span><span class="n">j</span> <span class="o">==</span> <span class="n">HC_SB_MAX_SM</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;)&quot;</span> <span class="o">:</span> <span class="s">&quot; &quot;</span><span class="p">);</span>

		<span class="n">BNX2X_ERR</span><span class="p">(</span><span class="s">&quot;     indexes (&quot;</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">loop</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
			<span class="n">pr_cont</span><span class="p">(</span><span class="s">&quot;0x%x%s&quot;</span><span class="p">,</span>
			       <span class="n">fp</span><span class="o">-&gt;</span><span class="n">sb_index_values</span><span class="p">[</span><span class="n">j</span><span class="p">],</span>
			       <span class="p">(</span><span class="n">j</span> <span class="o">==</span> <span class="n">loop</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;)&quot;</span> <span class="o">:</span> <span class="s">&quot; &quot;</span><span class="p">);</span>
		<span class="cm">/* fw sb data */</span>
		<span class="n">data_size</span> <span class="o">=</span> <span class="n">CHIP_IS_E1x</span><span class="p">(</span><span class="n">bp</span><span class="p">)</span> <span class="o">?</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">hc_status_block_data_e1x</span><span class="p">)</span> <span class="o">:</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">hc_status_block_data_e2</span><span class="p">);</span>
		<span class="n">data_size</span> <span class="o">/=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">);</span>
		<span class="n">sb_data_p</span> <span class="o">=</span> <span class="n">CHIP_IS_E1x</span><span class="p">(</span><span class="n">bp</span><span class="p">)</span> <span class="o">?</span>
			<span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">sb_data_e1x</span> <span class="o">:</span>
			<span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">sb_data_e2</span><span class="p">;</span>
		<span class="cm">/* copy sb data in here */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">data_size</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
			<span class="o">*</span><span class="p">(</span><span class="n">sb_data_p</span> <span class="o">+</span> <span class="n">j</span><span class="p">)</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">BAR_CSTRORM_INTMEM</span> <span class="o">+</span>
				<span class="n">CSTORM_STATUS_BLOCK_DATA_OFFSET</span><span class="p">(</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">fw_sb_id</span><span class="p">)</span> <span class="o">+</span>
				<span class="n">j</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">));</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CHIP_IS_E1x</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">pr_cont</span><span class="p">(</span><span class="s">&quot;pf_id(0x%x)  vf_id(0x%x)  vf_valid(0x%x) vnic_id(0x%x)  same_igu_sb_1b(0x%x) state(0x%x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">sb_data_e2</span><span class="p">.</span><span class="n">common</span><span class="p">.</span><span class="n">p_func</span><span class="p">.</span><span class="n">pf_id</span><span class="p">,</span>
				<span class="n">sb_data_e2</span><span class="p">.</span><span class="n">common</span><span class="p">.</span><span class="n">p_func</span><span class="p">.</span><span class="n">vf_id</span><span class="p">,</span>
				<span class="n">sb_data_e2</span><span class="p">.</span><span class="n">common</span><span class="p">.</span><span class="n">p_func</span><span class="p">.</span><span class="n">vf_valid</span><span class="p">,</span>
				<span class="n">sb_data_e2</span><span class="p">.</span><span class="n">common</span><span class="p">.</span><span class="n">p_func</span><span class="p">.</span><span class="n">vnic_id</span><span class="p">,</span>
				<span class="n">sb_data_e2</span><span class="p">.</span><span class="n">common</span><span class="p">.</span><span class="n">same_igu_sb_1b</span><span class="p">,</span>
				<span class="n">sb_data_e2</span><span class="p">.</span><span class="n">common</span><span class="p">.</span><span class="n">state</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">pr_cont</span><span class="p">(</span><span class="s">&quot;pf_id(0x%x)  vf_id(0x%x)  vf_valid(0x%x) vnic_id(0x%x)  same_igu_sb_1b(0x%x) state(0x%x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">sb_data_e1x</span><span class="p">.</span><span class="n">common</span><span class="p">.</span><span class="n">p_func</span><span class="p">.</span><span class="n">pf_id</span><span class="p">,</span>
				<span class="n">sb_data_e1x</span><span class="p">.</span><span class="n">common</span><span class="p">.</span><span class="n">p_func</span><span class="p">.</span><span class="n">vf_id</span><span class="p">,</span>
				<span class="n">sb_data_e1x</span><span class="p">.</span><span class="n">common</span><span class="p">.</span><span class="n">p_func</span><span class="p">.</span><span class="n">vf_valid</span><span class="p">,</span>
				<span class="n">sb_data_e1x</span><span class="p">.</span><span class="n">common</span><span class="p">.</span><span class="n">p_func</span><span class="p">.</span><span class="n">vnic_id</span><span class="p">,</span>
				<span class="n">sb_data_e1x</span><span class="p">.</span><span class="n">common</span><span class="p">.</span><span class="n">same_igu_sb_1b</span><span class="p">,</span>
				<span class="n">sb_data_e1x</span><span class="p">.</span><span class="n">common</span><span class="p">.</span><span class="n">state</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* SB_SMs data */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">HC_SB_MAX_SM</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_cont</span><span class="p">(</span><span class="s">&quot;SM[%d] __flags (0x%x) igu_sb_id (0x%x)  igu_seg_id(0x%x) time_to_expire (0x%x) timer_value(0x%x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">j</span><span class="p">,</span> <span class="n">hc_sm_p</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">__flags</span><span class="p">,</span>
				<span class="n">hc_sm_p</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">igu_sb_id</span><span class="p">,</span>
				<span class="n">hc_sm_p</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">igu_seg_id</span><span class="p">,</span>
				<span class="n">hc_sm_p</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">time_to_expire</span><span class="p">,</span>
				<span class="n">hc_sm_p</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">timer_value</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* Indecies data */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">loop</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_cont</span><span class="p">(</span><span class="s">&quot;INDEX[%d] flags (0x%x) timeout (0x%x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span>
			       <span class="n">hc_index_p</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">flags</span><span class="p">,</span>
			       <span class="n">hc_index_p</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">timeout</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

<span class="cp">#ifdef BNX2X_STOP_ON_ERROR</span>
	<span class="cm">/* Rings */</span>
	<span class="cm">/* Rx */</span>
	<span class="n">for_each_rx_queue</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">bnx2x_fastpath</span> <span class="o">*</span><span class="n">fp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">fp</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="n">start</span> <span class="o">=</span> <span class="n">RX_BD</span><span class="p">(</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="o">*</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">rx_cons_sb</span><span class="p">)</span> <span class="o">-</span> <span class="mi">10</span><span class="p">);</span>
		<span class="n">end</span> <span class="o">=</span> <span class="n">RX_BD</span><span class="p">(</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="o">*</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">rx_cons_sb</span><span class="p">)</span> <span class="o">+</span> <span class="mi">503</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="n">start</span><span class="p">;</span> <span class="n">j</span> <span class="o">!=</span> <span class="n">end</span><span class="p">;</span> <span class="n">j</span> <span class="o">=</span> <span class="n">RX_BD</span><span class="p">(</span><span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">u32</span> <span class="o">*</span><span class="n">rx_bd</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">rx_desc_ring</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>
			<span class="k">struct</span> <span class="n">sw_rx_bd</span> <span class="o">*</span><span class="n">sw_bd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">rx_buf_ring</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>

			<span class="n">BNX2X_ERR</span><span class="p">(</span><span class="s">&quot;fp%d: rx_bd[%x]=[%x:%x]  sw_bd=[%p]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				  <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">rx_bd</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">rx_bd</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">sw_bd</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">start</span> <span class="o">=</span> <span class="n">RX_SGE</span><span class="p">(</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">rx_sge_prod</span><span class="p">);</span>
		<span class="n">end</span> <span class="o">=</span> <span class="n">RX_SGE</span><span class="p">(</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">last_max_sge</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="n">start</span><span class="p">;</span> <span class="n">j</span> <span class="o">!=</span> <span class="n">end</span><span class="p">;</span> <span class="n">j</span> <span class="o">=</span> <span class="n">RX_SGE</span><span class="p">(</span><span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">u32</span> <span class="o">*</span><span class="n">rx_sge</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">rx_sge_ring</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>
			<span class="k">struct</span> <span class="n">sw_rx_page</span> <span class="o">*</span><span class="n">sw_page</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">rx_page_ring</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>

			<span class="n">BNX2X_ERR</span><span class="p">(</span><span class="s">&quot;fp%d: rx_sge[%x]=[%x:%x]  sw_page=[%p]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				  <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">rx_sge</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">rx_sge</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">sw_page</span><span class="o">-&gt;</span><span class="n">page</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">start</span> <span class="o">=</span> <span class="n">RCQ_BD</span><span class="p">(</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">rx_comp_cons</span> <span class="o">-</span> <span class="mi">10</span><span class="p">);</span>
		<span class="n">end</span> <span class="o">=</span> <span class="n">RCQ_BD</span><span class="p">(</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">rx_comp_cons</span> <span class="o">+</span> <span class="mi">503</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="n">start</span><span class="p">;</span> <span class="n">j</span> <span class="o">!=</span> <span class="n">end</span><span class="p">;</span> <span class="n">j</span> <span class="o">=</span> <span class="n">RCQ_BD</span><span class="p">(</span><span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">u32</span> <span class="o">*</span><span class="n">cqe</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">rx_comp_ring</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>

			<span class="n">BNX2X_ERR</span><span class="p">(</span><span class="s">&quot;fp%d: cqe[%x]=[%x:%x:%x:%x]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				  <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">cqe</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">cqe</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">cqe</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">cqe</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Tx */</span>
	<span class="n">for_each_tx_queue</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">bnx2x_fastpath</span> <span class="o">*</span><span class="n">fp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">fp</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">for_each_cos_in_tx_queue</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">cos</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">bnx2x_fp_txdata</span> <span class="o">*</span><span class="n">txdata</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">txdata</span><span class="p">[</span><span class="n">cos</span><span class="p">];</span>

			<span class="n">start</span> <span class="o">=</span> <span class="n">TX_BD</span><span class="p">(</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="o">*</span><span class="n">txdata</span><span class="o">-&gt;</span><span class="n">tx_cons_sb</span><span class="p">)</span> <span class="o">-</span> <span class="mi">10</span><span class="p">);</span>
			<span class="n">end</span> <span class="o">=</span> <span class="n">TX_BD</span><span class="p">(</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="o">*</span><span class="n">txdata</span><span class="o">-&gt;</span><span class="n">tx_cons_sb</span><span class="p">)</span> <span class="o">+</span> <span class="mi">245</span><span class="p">);</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="n">start</span><span class="p">;</span> <span class="n">j</span> <span class="o">!=</span> <span class="n">end</span><span class="p">;</span> <span class="n">j</span> <span class="o">=</span> <span class="n">TX_BD</span><span class="p">(</span><span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">struct</span> <span class="n">sw_tx_bd</span> <span class="o">*</span><span class="n">sw_bd</span> <span class="o">=</span>
					<span class="o">&amp;</span><span class="n">txdata</span><span class="o">-&gt;</span><span class="n">tx_buf_ring</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>

				<span class="n">BNX2X_ERR</span><span class="p">(</span><span class="s">&quot;fp%d: txdata %d, packet[%x]=[%p,%x]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					  <span class="n">i</span><span class="p">,</span> <span class="n">cos</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">sw_bd</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">,</span>
					  <span class="n">sw_bd</span><span class="o">-&gt;</span><span class="n">first_bd</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="n">start</span> <span class="o">=</span> <span class="n">TX_BD</span><span class="p">(</span><span class="n">txdata</span><span class="o">-&gt;</span><span class="n">tx_bd_cons</span> <span class="o">-</span> <span class="mi">10</span><span class="p">);</span>
			<span class="n">end</span> <span class="o">=</span> <span class="n">TX_BD</span><span class="p">(</span><span class="n">txdata</span><span class="o">-&gt;</span><span class="n">tx_bd_cons</span> <span class="o">+</span> <span class="mi">254</span><span class="p">);</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="n">start</span><span class="p">;</span> <span class="n">j</span> <span class="o">!=</span> <span class="n">end</span><span class="p">;</span> <span class="n">j</span> <span class="o">=</span> <span class="n">TX_BD</span><span class="p">(</span><span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">u32</span> <span class="o">*</span><span class="n">tx_bd</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">txdata</span><span class="o">-&gt;</span><span class="n">tx_desc_ring</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>

				<span class="n">BNX2X_ERR</span><span class="p">(</span><span class="s">&quot;fp%d: txdata %d, tx_bd[%x]=[%x:%x:%x:%x]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					  <span class="n">i</span><span class="p">,</span> <span class="n">cos</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">tx_bd</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">tx_bd</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
					  <span class="n">tx_bd</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">tx_bd</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="n">bnx2x_fw_dump</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
	<span class="n">bnx2x_mc_assert</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
	<span class="n">BNX2X_ERR</span><span class="p">(</span><span class="s">&quot;end crash dump -----------------</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * FLR Support for E2</span>
<span class="cm"> *</span>
<span class="cm"> * bnx2x_pf_flr_clnup() is called during nic_load in the per function HW</span>
<span class="cm"> * initialization.</span>
<span class="cm"> */</span>
<span class="cp">#define FLR_WAIT_USEC		10000	</span><span class="cm">/* 10 miliseconds */</span><span class="cp"></span>
<span class="cp">#define FLR_WAIT_INTERVAL	50	</span><span class="cm">/* usec */</span><span class="cp"></span>
<span class="cp">#define	FLR_POLL_CNT		(FLR_WAIT_USEC/FLR_WAIT_INTERVAL) </span><span class="cm">/* 200 */</span><span class="cp"></span>

<span class="k">struct</span> <span class="n">pbf_pN_buf_regs</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="n">pN</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">init_crd</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">crd</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">crd_freed</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">pbf_pN_cmd_regs</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="n">pN</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">lines_occup</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">lines_freed</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_pbf_pN_buf_flushed</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">pbf_pN_buf_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">,</span>
				     <span class="n">u32</span> <span class="n">poll_count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">init_crd</span><span class="p">,</span> <span class="n">crd</span><span class="p">,</span> <span class="n">crd_start</span><span class="p">,</span> <span class="n">crd_freed</span><span class="p">,</span> <span class="n">crd_freed_start</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">cur_cnt</span> <span class="o">=</span> <span class="n">poll_count</span><span class="p">;</span>

	<span class="n">crd_freed</span> <span class="o">=</span> <span class="n">crd_freed_start</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">crd_freed</span><span class="p">);</span>
	<span class="n">crd</span> <span class="o">=</span> <span class="n">crd_start</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">crd</span><span class="p">);</span>
	<span class="n">init_crd</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">init_crd</span><span class="p">);</span>

	<span class="n">DP</span><span class="p">(</span><span class="n">BNX2X_MSG_SP</span><span class="p">,</span> <span class="s">&quot;INIT CREDIT[%d] : %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">pN</span><span class="p">,</span> <span class="n">init_crd</span><span class="p">);</span>
	<span class="n">DP</span><span class="p">(</span><span class="n">BNX2X_MSG_SP</span><span class="p">,</span> <span class="s">&quot;CREDIT[%d]      : s:%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">pN</span><span class="p">,</span> <span class="n">crd</span><span class="p">);</span>
	<span class="n">DP</span><span class="p">(</span><span class="n">BNX2X_MSG_SP</span><span class="p">,</span> <span class="s">&quot;CREDIT_FREED[%d]: s:%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">pN</span><span class="p">,</span> <span class="n">crd_freed</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">((</span><span class="n">crd</span> <span class="o">!=</span> <span class="n">init_crd</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">SUB_S32</span><span class="p">(</span><span class="n">crd_freed</span><span class="p">,</span> <span class="n">crd_freed_start</span><span class="p">)</span> <span class="o">&lt;</span>
	       <span class="p">(</span><span class="n">init_crd</span> <span class="o">-</span> <span class="n">crd_start</span><span class="p">)))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cur_cnt</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">udelay</span><span class="p">(</span><span class="n">FLR_WAIT_INTERVAL</span><span class="p">);</span>
			<span class="n">crd</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">crd</span><span class="p">);</span>
			<span class="n">crd_freed</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">crd_freed</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">DP</span><span class="p">(</span><span class="n">BNX2X_MSG_SP</span><span class="p">,</span> <span class="s">&quot;PBF tx buffer[%d] timed out</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">regs</span><span class="o">-&gt;</span><span class="n">pN</span><span class="p">);</span>
			<span class="n">DP</span><span class="p">(</span><span class="n">BNX2X_MSG_SP</span><span class="p">,</span> <span class="s">&quot;CREDIT[%d]      : c:%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">regs</span><span class="o">-&gt;</span><span class="n">pN</span><span class="p">,</span> <span class="n">crd</span><span class="p">);</span>
			<span class="n">DP</span><span class="p">(</span><span class="n">BNX2X_MSG_SP</span><span class="p">,</span> <span class="s">&quot;CREDIT_FREED[%d]: c:%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">regs</span><span class="o">-&gt;</span><span class="n">pN</span><span class="p">,</span> <span class="n">crd_freed</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">DP</span><span class="p">(</span><span class="n">BNX2X_MSG_SP</span><span class="p">,</span> <span class="s">&quot;Waited %d*%d usec for PBF tx buffer[%d]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	   <span class="n">poll_count</span><span class="o">-</span><span class="n">cur_cnt</span><span class="p">,</span> <span class="n">FLR_WAIT_INTERVAL</span><span class="p">,</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">pN</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_pbf_pN_cmd_flushed</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">pbf_pN_cmd_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">,</span>
				     <span class="n">u32</span> <span class="n">poll_count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">occup</span><span class="p">,</span> <span class="n">to_free</span><span class="p">,</span> <span class="n">freed</span><span class="p">,</span> <span class="n">freed_start</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">cur_cnt</span> <span class="o">=</span> <span class="n">poll_count</span><span class="p">;</span>

	<span class="n">occup</span> <span class="o">=</span> <span class="n">to_free</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">lines_occup</span><span class="p">);</span>
	<span class="n">freed</span> <span class="o">=</span> <span class="n">freed_start</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">lines_freed</span><span class="p">);</span>

	<span class="n">DP</span><span class="p">(</span><span class="n">BNX2X_MSG_SP</span><span class="p">,</span> <span class="s">&quot;OCCUPANCY[%d]   : s:%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">pN</span><span class="p">,</span> <span class="n">occup</span><span class="p">);</span>
	<span class="n">DP</span><span class="p">(</span><span class="n">BNX2X_MSG_SP</span><span class="p">,</span> <span class="s">&quot;LINES_FREED[%d] : s:%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">pN</span><span class="p">,</span> <span class="n">freed</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">occup</span> <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">SUB_S32</span><span class="p">(</span><span class="n">freed</span><span class="p">,</span> <span class="n">freed_start</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">to_free</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cur_cnt</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">udelay</span><span class="p">(</span><span class="n">FLR_WAIT_INTERVAL</span><span class="p">);</span>
			<span class="n">occup</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">lines_occup</span><span class="p">);</span>
			<span class="n">freed</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">lines_freed</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">DP</span><span class="p">(</span><span class="n">BNX2X_MSG_SP</span><span class="p">,</span> <span class="s">&quot;PBF cmd queue[%d] timed out</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">regs</span><span class="o">-&gt;</span><span class="n">pN</span><span class="p">);</span>
			<span class="n">DP</span><span class="p">(</span><span class="n">BNX2X_MSG_SP</span><span class="p">,</span> <span class="s">&quot;OCCUPANCY[%d]   : s:%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">regs</span><span class="o">-&gt;</span><span class="n">pN</span><span class="p">,</span> <span class="n">occup</span><span class="p">);</span>
			<span class="n">DP</span><span class="p">(</span><span class="n">BNX2X_MSG_SP</span><span class="p">,</span> <span class="s">&quot;LINES_FREED[%d] : s:%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">regs</span><span class="o">-&gt;</span><span class="n">pN</span><span class="p">,</span> <span class="n">freed</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">DP</span><span class="p">(</span><span class="n">BNX2X_MSG_SP</span><span class="p">,</span> <span class="s">&quot;Waited %d*%d usec for PBF cmd queue[%d]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	   <span class="n">poll_count</span><span class="o">-</span><span class="n">cur_cnt</span><span class="p">,</span> <span class="n">FLR_WAIT_INTERVAL</span><span class="p">,</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">pN</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">bnx2x_flr_clnup_reg_poll</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">,</span> <span class="n">u32</span> <span class="n">reg</span><span class="p">,</span>
				    <span class="n">u32</span> <span class="n">expected</span><span class="p">,</span> <span class="n">u32</span> <span class="n">poll_count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">cur_cnt</span> <span class="o">=</span> <span class="n">poll_count</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">((</span><span class="n">val</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">reg</span><span class="p">))</span> <span class="o">!=</span> <span class="n">expected</span> <span class="o">&amp;&amp;</span> <span class="n">cur_cnt</span><span class="o">--</span><span class="p">)</span>
		<span class="n">udelay</span><span class="p">(</span><span class="n">FLR_WAIT_INTERVAL</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">val</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bnx2x_flr_clnup_poll_hw_counter</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">,</span> <span class="n">u32</span> <span class="n">reg</span><span class="p">,</span>
					   <span class="kt">char</span> <span class="o">*</span><span class="n">msg</span><span class="p">,</span> <span class="n">u32</span> <span class="n">poll_cnt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">val</span> <span class="o">=</span> <span class="n">bnx2x_flr_clnup_reg_poll</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">poll_cnt</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BNX2X_ERR</span><span class="p">(</span><span class="s">&quot;%s usage count=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">bnx2x_flr_clnup_poll_count</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* adjust polling timeout */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">CHIP_REV_IS_EMUL</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">FLR_POLL_CNT</span> <span class="o">*</span> <span class="mi">2000</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">CHIP_REV_IS_FPGA</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">FLR_POLL_CNT</span> <span class="o">*</span> <span class="mi">120</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">FLR_POLL_CNT</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_tx_hw_flushed</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">,</span> <span class="n">u32</span> <span class="n">poll_count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pbf_pN_cmd_regs</span> <span class="n">cmd_regs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="n">CHIP_IS_E3B0</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span> <span class="o">?</span>
			<span class="n">PBF_REG_TQ_OCCUPANCY_Q0</span> <span class="o">:</span>
			<span class="n">PBF_REG_P0_TQ_OCCUPANCY</span><span class="p">,</span>
		    <span class="p">(</span><span class="n">CHIP_IS_E3B0</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span> <span class="o">?</span>
			<span class="n">PBF_REG_TQ_LINES_FREED_CNT_Q0</span> <span class="o">:</span>
			<span class="n">PBF_REG_P0_TQ_LINES_FREED_CNT</span><span class="p">},</span>
		<span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="n">CHIP_IS_E3B0</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span> <span class="o">?</span>
			<span class="n">PBF_REG_TQ_OCCUPANCY_Q1</span> <span class="o">:</span>
			<span class="n">PBF_REG_P1_TQ_OCCUPANCY</span><span class="p">,</span>
		    <span class="p">(</span><span class="n">CHIP_IS_E3B0</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span> <span class="o">?</span>
			<span class="n">PBF_REG_TQ_LINES_FREED_CNT_Q1</span> <span class="o">:</span>
			<span class="n">PBF_REG_P1_TQ_LINES_FREED_CNT</span><span class="p">},</span>
		<span class="p">{</span><span class="mi">4</span><span class="p">,</span> <span class="p">(</span><span class="n">CHIP_IS_E3B0</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span> <span class="o">?</span>
			<span class="n">PBF_REG_TQ_OCCUPANCY_LB_Q</span> <span class="o">:</span>
			<span class="n">PBF_REG_P4_TQ_OCCUPANCY</span><span class="p">,</span>
		    <span class="p">(</span><span class="n">CHIP_IS_E3B0</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span> <span class="o">?</span>
			<span class="n">PBF_REG_TQ_LINES_FREED_CNT_LB_Q</span> <span class="o">:</span>
			<span class="n">PBF_REG_P4_TQ_LINES_FREED_CNT</span><span class="p">}</span>
	<span class="p">};</span>

	<span class="k">struct</span> <span class="n">pbf_pN_buf_regs</span> <span class="n">buf_regs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="n">CHIP_IS_E3B0</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span> <span class="o">?</span>
			<span class="n">PBF_REG_INIT_CRD_Q0</span> <span class="o">:</span>
			<span class="n">PBF_REG_P0_INIT_CRD</span> <span class="p">,</span>
		    <span class="p">(</span><span class="n">CHIP_IS_E3B0</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span> <span class="o">?</span>
			<span class="n">PBF_REG_CREDIT_Q0</span> <span class="o">:</span>
			<span class="n">PBF_REG_P0_CREDIT</span><span class="p">,</span>
		    <span class="p">(</span><span class="n">CHIP_IS_E3B0</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span> <span class="o">?</span>
			<span class="n">PBF_REG_INTERNAL_CRD_FREED_CNT_Q0</span> <span class="o">:</span>
			<span class="n">PBF_REG_P0_INTERNAL_CRD_FREED_CNT</span><span class="p">},</span>
		<span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="n">CHIP_IS_E3B0</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span> <span class="o">?</span>
			<span class="n">PBF_REG_INIT_CRD_Q1</span> <span class="o">:</span>
			<span class="n">PBF_REG_P1_INIT_CRD</span><span class="p">,</span>
		    <span class="p">(</span><span class="n">CHIP_IS_E3B0</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span> <span class="o">?</span>
			<span class="n">PBF_REG_CREDIT_Q1</span> <span class="o">:</span>
			<span class="n">PBF_REG_P1_CREDIT</span><span class="p">,</span>
		    <span class="p">(</span><span class="n">CHIP_IS_E3B0</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span> <span class="o">?</span>
			<span class="n">PBF_REG_INTERNAL_CRD_FREED_CNT_Q1</span> <span class="o">:</span>
			<span class="n">PBF_REG_P1_INTERNAL_CRD_FREED_CNT</span><span class="p">},</span>
		<span class="p">{</span><span class="mi">4</span><span class="p">,</span> <span class="p">(</span><span class="n">CHIP_IS_E3B0</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span> <span class="o">?</span>
			<span class="n">PBF_REG_INIT_CRD_LB_Q</span> <span class="o">:</span>
			<span class="n">PBF_REG_P4_INIT_CRD</span><span class="p">,</span>
		    <span class="p">(</span><span class="n">CHIP_IS_E3B0</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span> <span class="o">?</span>
			<span class="n">PBF_REG_CREDIT_LB_Q</span> <span class="o">:</span>
			<span class="n">PBF_REG_P4_CREDIT</span><span class="p">,</span>
		    <span class="p">(</span><span class="n">CHIP_IS_E3B0</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span> <span class="o">?</span>
			<span class="n">PBF_REG_INTERNAL_CRD_FREED_CNT_LB_Q</span> <span class="o">:</span>
			<span class="n">PBF_REG_P4_INTERNAL_CRD_FREED_CNT</span><span class="p">},</span>
	<span class="p">};</span>

	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* Verify the command queues are flushed P0, P1, P4 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">cmd_regs</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">bnx2x_pbf_pN_cmd_flushed</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd_regs</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">poll_count</span><span class="p">);</span>


	<span class="cm">/* Verify the transmission buffers are flushed P0, P1, P4 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">buf_regs</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">bnx2x_pbf_pN_buf_flushed</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buf_regs</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">poll_count</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#define OP_GEN_PARAM(param) \</span>
<span class="cp">	(((param) &lt;&lt; SDM_OP_GEN_COMP_PARAM_SHIFT) &amp; SDM_OP_GEN_COMP_PARAM)</span>

<span class="cp">#define OP_GEN_TYPE(type) \</span>
<span class="cp">	(((type) &lt;&lt; SDM_OP_GEN_COMP_TYPE_SHIFT) &amp; SDM_OP_GEN_COMP_TYPE)</span>

<span class="cp">#define OP_GEN_AGG_VECT(index) \</span>
<span class="cp">	(((index) &lt;&lt; SDM_OP_GEN_AGG_VECT_IDX_SHIFT) &amp; SDM_OP_GEN_AGG_VECT_IDX)</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">bnx2x_send_final_clnup</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">,</span> <span class="n">u8</span> <span class="n">clnup_func</span><span class="p">,</span>
					 <span class="n">u32</span> <span class="n">poll_cnt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sdm_op_gen</span> <span class="n">op_gen</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>

	<span class="n">u32</span> <span class="n">comp_addr</span> <span class="o">=</span> <span class="n">BAR_CSTRORM_INTMEM</span> <span class="o">+</span>
			<span class="n">CSTORM_FINAL_CLEANUP_COMPLETE_OFFSET</span><span class="p">(</span><span class="n">clnup_func</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">comp_addr</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">BNX2X_ERR</span><span class="p">(</span><span class="s">&quot;Cleanup complete was not 0 before sending</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">op_gen</span><span class="p">.</span><span class="n">command</span> <span class="o">|=</span> <span class="n">OP_GEN_PARAM</span><span class="p">(</span><span class="n">XSTORM_AGG_INT_FINAL_CLEANUP_INDEX</span><span class="p">);</span>
	<span class="n">op_gen</span><span class="p">.</span><span class="n">command</span> <span class="o">|=</span> <span class="n">OP_GEN_TYPE</span><span class="p">(</span><span class="n">XSTORM_AGG_INT_FINAL_CLEANUP_COMP_TYPE</span><span class="p">);</span>
	<span class="n">op_gen</span><span class="p">.</span><span class="n">command</span> <span class="o">|=</span> <span class="n">OP_GEN_AGG_VECT</span><span class="p">(</span><span class="n">clnup_func</span><span class="p">);</span>
	<span class="n">op_gen</span><span class="p">.</span><span class="n">command</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">SDM_OP_GEN_AGG_VECT_IDX_VALID_SHIFT</span><span class="p">;</span>

	<span class="n">DP</span><span class="p">(</span><span class="n">BNX2X_MSG_SP</span><span class="p">,</span> <span class="s">&quot;sending FW Final cleanup</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">XSDM_REG_OPERATION_GEN</span><span class="p">,</span> <span class="n">op_gen</span><span class="p">.</span><span class="n">command</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bnx2x_flr_clnup_reg_poll</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">comp_addr</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">poll_cnt</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BNX2X_ERR</span><span class="p">(</span><span class="s">&quot;FW final cleanup did not succeed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">DP</span><span class="p">(</span><span class="n">BNX2X_MSG_SP</span><span class="p">,</span> <span class="s">&quot;At timeout completion address contained %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="p">(</span><span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">comp_addr</span><span class="p">)));</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* Zero completion for nxt FLR */</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">comp_addr</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u8</span> <span class="nf">bnx2x_is_pcie_pending</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">pos</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">pos</span> <span class="o">=</span> <span class="n">pci_pcie_cap</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pos</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">pos</span> <span class="o">+</span> <span class="n">PCI_EXP_DEVSTA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span> <span class="o">&amp;</span> <span class="n">PCI_EXP_DEVSTA_TRPND</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* PF FLR specific routines</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">bnx2x_poll_hw_usage_counters</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">,</span> <span class="n">u32</span> <span class="n">poll_cnt</span><span class="p">)</span>
<span class="p">{</span>

	<span class="cm">/* wait for CFC PF usage-counter to zero (includes all the VFs) */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bnx2x_flr_clnup_poll_hw_counter</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span>
			<span class="n">CFC_REG_NUM_LCIDS_INSIDE_PF</span><span class="p">,</span>
			<span class="s">&quot;CFC PF usage counter timed out&quot;</span><span class="p">,</span>
			<span class="n">poll_cnt</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>


	<span class="cm">/* Wait for DQ PF usage-counter to zero (until DQ cleanup) */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bnx2x_flr_clnup_poll_hw_counter</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span>
			<span class="n">DORQ_REG_PF_USAGE_CNT</span><span class="p">,</span>
			<span class="s">&quot;DQ PF usage counter timed out&quot;</span><span class="p">,</span>
			<span class="n">poll_cnt</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* Wait for QM PF usage-counter to zero (until DQ cleanup) */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bnx2x_flr_clnup_poll_hw_counter</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span>
			<span class="n">QM_REG_PF_USG_CNT_0</span> <span class="o">+</span> <span class="mi">4</span><span class="o">*</span><span class="n">BP_FUNC</span><span class="p">(</span><span class="n">bp</span><span class="p">),</span>
			<span class="s">&quot;QM PF usage counter timed out&quot;</span><span class="p">,</span>
			<span class="n">poll_cnt</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* Wait for Timer PF usage-counters to zero (until DQ cleanup) */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bnx2x_flr_clnup_poll_hw_counter</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span>
			<span class="n">TM_REG_LIN0_VNIC_UC</span> <span class="o">+</span> <span class="mi">4</span><span class="o">*</span><span class="n">BP_PORT</span><span class="p">(</span><span class="n">bp</span><span class="p">),</span>
			<span class="s">&quot;Timers VNIC usage counter timed out&quot;</span><span class="p">,</span>
			<span class="n">poll_cnt</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bnx2x_flr_clnup_poll_hw_counter</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span>
			<span class="n">TM_REG_LIN0_NUM_SCANS</span> <span class="o">+</span> <span class="mi">4</span><span class="o">*</span><span class="n">BP_PORT</span><span class="p">(</span><span class="n">bp</span><span class="p">),</span>
			<span class="s">&quot;Timers NUM_SCANS usage counter timed out&quot;</span><span class="p">,</span>
			<span class="n">poll_cnt</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* Wait DMAE PF usage counter to zero */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bnx2x_flr_clnup_poll_hw_counter</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span>
			<span class="n">dmae_reg_go_c</span><span class="p">[</span><span class="n">INIT_DMAE_C</span><span class="p">(</span><span class="n">bp</span><span class="p">)],</span>
			<span class="s">&quot;DMAE dommand register timed out&quot;</span><span class="p">,</span>
			<span class="n">poll_cnt</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_hw_enable_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">CFC_REG_WEAK_ENABLE_PF</span><span class="p">);</span>
	<span class="n">DP</span><span class="p">(</span><span class="n">BNX2X_MSG_SP</span><span class="p">,</span> <span class="s">&quot;CFC_REG_WEAK_ENABLE_PF is 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">PBF_REG_DISABLE_PF</span><span class="p">);</span>
	<span class="n">DP</span><span class="p">(</span><span class="n">BNX2X_MSG_SP</span><span class="p">,</span> <span class="s">&quot;PBF_REG_DISABLE_PF is 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">IGU_REG_PCI_PF_MSI_EN</span><span class="p">);</span>
	<span class="n">DP</span><span class="p">(</span><span class="n">BNX2X_MSG_SP</span><span class="p">,</span> <span class="s">&quot;IGU_REG_PCI_PF_MSI_EN is 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">IGU_REG_PCI_PF_MSIX_EN</span><span class="p">);</span>
	<span class="n">DP</span><span class="p">(</span><span class="n">BNX2X_MSG_SP</span><span class="p">,</span> <span class="s">&quot;IGU_REG_PCI_PF_MSIX_EN is 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">IGU_REG_PCI_PF_MSIX_FUNC_MASK</span><span class="p">);</span>
	<span class="n">DP</span><span class="p">(</span><span class="n">BNX2X_MSG_SP</span><span class="p">,</span> <span class="s">&quot;IGU_REG_PCI_PF_MSIX_FUNC_MASK is 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">PGLUE_B_REG_SHADOW_BME_PF_7_0_CLR</span><span class="p">);</span>
	<span class="n">DP</span><span class="p">(</span><span class="n">BNX2X_MSG_SP</span><span class="p">,</span> <span class="s">&quot;PGLUE_B_REG_SHADOW_BME_PF_7_0_CLR is 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">PGLUE_B_REG_FLR_REQUEST_PF_7_0_CLR</span><span class="p">);</span>
	<span class="n">DP</span><span class="p">(</span><span class="n">BNX2X_MSG_SP</span><span class="p">,</span> <span class="s">&quot;PGLUE_B_REG_FLR_REQUEST_PF_7_0_CLR is 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">PGLUE_B_REG_INTERNAL_PFID_ENABLE_MASTER</span><span class="p">);</span>
	<span class="n">DP</span><span class="p">(</span><span class="n">BNX2X_MSG_SP</span><span class="p">,</span> <span class="s">&quot;PGLUE_B_REG_INTERNAL_PFID_ENABLE_MASTER is 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	   <span class="n">val</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bnx2x_pf_flr_clnup</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">poll_cnt</span> <span class="o">=</span> <span class="n">bnx2x_flr_clnup_poll_count</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>

	<span class="n">DP</span><span class="p">(</span><span class="n">BNX2X_MSG_SP</span><span class="p">,</span> <span class="s">&quot;Cleanup after FLR PF[%d]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">BP_ABS_FUNC</span><span class="p">(</span><span class="n">bp</span><span class="p">));</span>

	<span class="cm">/* Re-enable PF target read access */</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">PGLUE_B_REG_INTERNAL_PFID_ENABLE_TARGET_READ</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* Poll HW usage counters */</span>
	<span class="n">DP</span><span class="p">(</span><span class="n">BNX2X_MSG_SP</span><span class="p">,</span> <span class="s">&quot;Polling usage counters</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bnx2x_poll_hw_usage_counters</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">poll_cnt</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="cm">/* Zero the igu &#39;trailing edge&#39; and &#39;leading edge&#39; */</span>

	<span class="cm">/* Send the FW cleanup command */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bnx2x_send_final_clnup</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">BP_FUNC</span><span class="p">(</span><span class="n">bp</span><span class="p">),</span> <span class="n">poll_cnt</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="cm">/* ATC cleanup */</span>

	<span class="cm">/* Verify TX hw is flushed */</span>
	<span class="n">bnx2x_tx_hw_flushed</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">poll_cnt</span><span class="p">);</span>

	<span class="cm">/* Wait 100ms (not adjusted according to platform) */</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>

	<span class="cm">/* Verify no pending pci transactions */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bnx2x_is_pcie_pending</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">))</span>
		<span class="n">BNX2X_ERR</span><span class="p">(</span><span class="s">&quot;PCIE Transactions still pending</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* Debug */</span>
	<span class="n">bnx2x_hw_enable_status</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Master enable - Due to WB DMAE writes performed before this</span>
<span class="cm">	 * register is re-initialized as part of the regular function init</span>
<span class="cm">	 */</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">PGLUE_B_REG_INTERNAL_PFID_ENABLE_MASTER</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_hc_int_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">port</span> <span class="o">=</span> <span class="n">BP_PORT</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">addr</span> <span class="o">=</span> <span class="n">port</span> <span class="o">?</span> <span class="n">HC_REG_CONFIG_1</span> <span class="o">:</span> <span class="n">HC_REG_CONFIG_0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">val</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
	<span class="n">bool</span> <span class="n">msix</span> <span class="o">=</span> <span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">USING_MSIX_FLAG</span><span class="p">)</span> <span class="o">?</span> <span class="nb">true</span> <span class="o">:</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">single_msix</span> <span class="o">=</span> <span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">USING_SINGLE_MSIX_FLAG</span><span class="p">)</span> <span class="o">?</span> <span class="nb">true</span> <span class="o">:</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">msi</span> <span class="o">=</span> <span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">USING_MSI_FLAG</span><span class="p">)</span> <span class="o">?</span> <span class="nb">true</span> <span class="o">:</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">msix</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">HC_CONFIG_0_REG_SINGLE_ISR_EN_0</span> <span class="o">|</span>
			 <span class="n">HC_CONFIG_0_REG_INT_LINE_EN_0</span><span class="p">);</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="p">(</span><span class="n">HC_CONFIG_0_REG_MSI_MSIX_INT_EN_0</span> <span class="o">|</span>
			<span class="n">HC_CONFIG_0_REG_ATTN_BIT_EN_0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">single_msix</span><span class="p">)</span>
			<span class="n">val</span> <span class="o">|=</span> <span class="n">HC_CONFIG_0_REG_SINGLE_ISR_EN_0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">msi</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">HC_CONFIG_0_REG_INT_LINE_EN_0</span><span class="p">;</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="p">(</span><span class="n">HC_CONFIG_0_REG_SINGLE_ISR_EN_0</span> <span class="o">|</span>
			<span class="n">HC_CONFIG_0_REG_MSI_MSIX_INT_EN_0</span> <span class="o">|</span>
			<span class="n">HC_CONFIG_0_REG_ATTN_BIT_EN_0</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="p">(</span><span class="n">HC_CONFIG_0_REG_SINGLE_ISR_EN_0</span> <span class="o">|</span>
			<span class="n">HC_CONFIG_0_REG_MSI_MSIX_INT_EN_0</span> <span class="o">|</span>
			<span class="n">HC_CONFIG_0_REG_INT_LINE_EN_0</span> <span class="o">|</span>
			<span class="n">HC_CONFIG_0_REG_ATTN_BIT_EN_0</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CHIP_IS_E1</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_IFUP</span><span class="p">,</span>
			   <span class="s">&quot;write %x to HC %d (addr 0x%x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>

			<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

			<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">HC_CONFIG_0_REG_MSI_MSIX_INT_EN_0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">CHIP_IS_E1</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span>
		<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">HC_REG_INT_MASK</span> <span class="o">+</span> <span class="n">port</span><span class="o">*</span><span class="mi">4</span><span class="p">,</span> <span class="mh">0x1FFFF</span><span class="p">);</span>

	<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_IFUP</span><span class="p">,</span>
	   <span class="s">&quot;write %x to HC %d (addr 0x%x) mode %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span>
	   <span class="p">(</span><span class="n">msix</span> <span class="o">?</span> <span class="s">&quot;MSI-X&quot;</span> <span class="o">:</span> <span class="p">(</span><span class="n">msi</span> <span class="o">?</span> <span class="s">&quot;MSI&quot;</span> <span class="o">:</span> <span class="s">&quot;INTx&quot;</span><span class="p">)));</span>

	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * Ensure that HC_CONFIG is written before leading/trailing edge config</span>
<span class="cm">	 */</span>
	<span class="n">mmiowb</span><span class="p">();</span>
	<span class="n">barrier</span><span class="p">();</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CHIP_IS_E1</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* init leading/trailing edge */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_MF</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="mh">0xee0f</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">BP_VN</span><span class="p">(</span><span class="n">bp</span><span class="p">)</span> <span class="o">+</span> <span class="mi">4</span><span class="p">)));</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">pmf</span><span class="p">)</span>
				<span class="cm">/* enable nig and gpio3 attention */</span>
				<span class="n">val</span> <span class="o">|=</span> <span class="mh">0x1100</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">val</span> <span class="o">=</span> <span class="mh">0xffff</span><span class="p">;</span>

		<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">HC_REG_TRAILING_EDGE_0</span> <span class="o">+</span> <span class="n">port</span><span class="o">*</span><span class="mi">8</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
		<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">HC_REG_LEADING_EDGE_0</span> <span class="o">+</span> <span class="n">port</span><span class="o">*</span><span class="mi">8</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Make sure that interrupts are indeed enabled from here on */</span>
	<span class="n">mmiowb</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_igu_int_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">msix</span> <span class="o">=</span> <span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">USING_MSIX_FLAG</span><span class="p">)</span> <span class="o">?</span> <span class="nb">true</span> <span class="o">:</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">single_msix</span> <span class="o">=</span> <span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">USING_SINGLE_MSIX_FLAG</span><span class="p">)</span> <span class="o">?</span> <span class="nb">true</span> <span class="o">:</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">msi</span> <span class="o">=</span> <span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">USING_MSI_FLAG</span><span class="p">)</span> <span class="o">?</span> <span class="nb">true</span> <span class="o">:</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">IGU_REG_PF_CONFIGURATION</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">msix</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">IGU_PF_CONF_INT_LINE_EN</span> <span class="o">|</span>
			 <span class="n">IGU_PF_CONF_SINGLE_ISR_EN</span><span class="p">);</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="p">(</span><span class="n">IGU_PF_CONF_FUNC_EN</span> <span class="o">|</span>
			<span class="n">IGU_PF_CONF_MSI_MSIX_EN</span> <span class="o">|</span>
			<span class="n">IGU_PF_CONF_ATTN_BIT_EN</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">single_msix</span><span class="p">)</span>
			<span class="n">val</span> <span class="o">|=</span> <span class="n">IGU_PF_CONF_SINGLE_ISR_EN</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">msi</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">IGU_PF_CONF_INT_LINE_EN</span><span class="p">;</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="p">(</span><span class="n">IGU_PF_CONF_FUNC_EN</span> <span class="o">|</span>
			<span class="n">IGU_PF_CONF_MSI_MSIX_EN</span> <span class="o">|</span>
			<span class="n">IGU_PF_CONF_ATTN_BIT_EN</span> <span class="o">|</span>
			<span class="n">IGU_PF_CONF_SINGLE_ISR_EN</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">IGU_PF_CONF_MSI_MSIX_EN</span><span class="p">;</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="p">(</span><span class="n">IGU_PF_CONF_FUNC_EN</span> <span class="o">|</span>
			<span class="n">IGU_PF_CONF_INT_LINE_EN</span> <span class="o">|</span>
			<span class="n">IGU_PF_CONF_ATTN_BIT_EN</span> <span class="o">|</span>
			<span class="n">IGU_PF_CONF_SINGLE_ISR_EN</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_IFUP</span><span class="p">,</span> <span class="s">&quot;write 0x%x to IGU  mode %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	   <span class="n">val</span><span class="p">,</span> <span class="p">(</span><span class="n">msix</span> <span class="o">?</span> <span class="s">&quot;MSI-X&quot;</span> <span class="o">:</span> <span class="p">(</span><span class="n">msi</span> <span class="o">?</span> <span class="s">&quot;MSI&quot;</span> <span class="o">:</span> <span class="s">&quot;INTx&quot;</span><span class="p">)));</span>

	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">IGU_REG_PF_CONFIGURATION</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">IGU_PF_CONF_INT_LINE_EN</span><span class="p">)</span>
		<span class="n">pci_intx</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>

	<span class="n">barrier</span><span class="p">();</span>

	<span class="cm">/* init leading/trailing edge */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_MF</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="mh">0xee0f</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">BP_VN</span><span class="p">(</span><span class="n">bp</span><span class="p">)</span> <span class="o">+</span> <span class="mi">4</span><span class="p">)));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">pmf</span><span class="p">)</span>
			<span class="cm">/* enable nig and gpio3 attention */</span>
			<span class="n">val</span> <span class="o">|=</span> <span class="mh">0x1100</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">val</span> <span class="o">=</span> <span class="mh">0xffff</span><span class="p">;</span>

	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">IGU_REG_TRAILING_EDGE_LATCH</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">IGU_REG_LEADING_EDGE_LATCH</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

	<span class="cm">/* Make sure that interrupts are indeed enabled from here on */</span>
	<span class="n">mmiowb</span><span class="p">();</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">bnx2x_int_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">.</span><span class="n">int_block</span> <span class="o">==</span> <span class="n">INT_BLOCK_HC</span><span class="p">)</span>
		<span class="n">bnx2x_hc_int_enable</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">bnx2x_igu_int_enable</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_hc_int_disable</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">port</span> <span class="o">=</span> <span class="n">BP_PORT</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">addr</span> <span class="o">=</span> <span class="n">port</span> <span class="o">?</span> <span class="n">HC_REG_CONFIG_1</span> <span class="o">:</span> <span class="n">HC_REG_CONFIG_0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">val</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * in E1 we must use only PCI configuration space to disable</span>
<span class="cm">	 * MSI/MSIX capablility</span>
<span class="cm">	 * It&#39;s forbitten to disable IGU_PF_CONF_MSI_MSIX_EN in HC block</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">CHIP_IS_E1</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/*  Since IGU_PF_CONF_MSI_MSIX_EN still always on</span>
<span class="cm">		 *  Use mask register to prevent from HC sending interrupts</span>
<span class="cm">		 *  after we exit the function</span>
<span class="cm">		 */</span>
		<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">HC_REG_INT_MASK</span> <span class="o">+</span> <span class="n">port</span><span class="o">*</span><span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">HC_CONFIG_0_REG_SINGLE_ISR_EN_0</span> <span class="o">|</span>
			 <span class="n">HC_CONFIG_0_REG_INT_LINE_EN_0</span> <span class="o">|</span>
			 <span class="n">HC_CONFIG_0_REG_ATTN_BIT_EN_0</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">HC_CONFIG_0_REG_SINGLE_ISR_EN_0</span> <span class="o">|</span>
			 <span class="n">HC_CONFIG_0_REG_MSI_MSIX_INT_EN_0</span> <span class="o">|</span>
			 <span class="n">HC_CONFIG_0_REG_INT_LINE_EN_0</span> <span class="o">|</span>
			 <span class="n">HC_CONFIG_0_REG_ATTN_BIT_EN_0</span><span class="p">);</span>

	<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_IFDOWN</span><span class="p">,</span>
	   <span class="s">&quot;write %x to HC %d (addr 0x%x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	   <span class="n">val</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>

	<span class="cm">/* flush all outstanding writes */</span>
	<span class="n">mmiowb</span><span class="p">();</span>

	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">addr</span><span class="p">)</span> <span class="o">!=</span> <span class="n">val</span><span class="p">)</span>
		<span class="n">BNX2X_ERR</span><span class="p">(</span><span class="s">&quot;BUG! proper val not read from IGU!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_igu_int_disable</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">val</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">IGU_REG_PF_CONFIGURATION</span><span class="p">);</span>

	<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">IGU_PF_CONF_MSI_MSIX_EN</span> <span class="o">|</span>
		 <span class="n">IGU_PF_CONF_INT_LINE_EN</span> <span class="o">|</span>
		 <span class="n">IGU_PF_CONF_ATTN_BIT_EN</span><span class="p">);</span>

	<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_IFDOWN</span><span class="p">,</span> <span class="s">&quot;write %x to IGU</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

	<span class="cm">/* flush all outstanding writes */</span>
	<span class="n">mmiowb</span><span class="p">();</span>

	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">IGU_REG_PF_CONFIGURATION</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">IGU_REG_PF_CONFIGURATION</span><span class="p">)</span> <span class="o">!=</span> <span class="n">val</span><span class="p">)</span>
		<span class="n">BNX2X_ERR</span><span class="p">(</span><span class="s">&quot;BUG! proper val not read from IGU!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">bnx2x_int_disable</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">.</span><span class="n">int_block</span> <span class="o">==</span> <span class="n">INT_BLOCK_HC</span><span class="p">)</span>
		<span class="n">bnx2x_hc_int_disable</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">bnx2x_igu_int_disable</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">bnx2x_int_disable_sync</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">disable_hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">msix</span> <span class="o">=</span> <span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">USING_MSIX_FLAG</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">offset</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">disable_hw</span><span class="p">)</span>
		<span class="cm">/* prevent the HW from sending interrupts */</span>
		<span class="n">bnx2x_int_disable</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>

	<span class="cm">/* make sure all ISRs are done */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">msix</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">synchronize_irq</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">msix_table</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">vector</span><span class="p">);</span>
		<span class="n">offset</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="cp">#ifdef BCM_CNIC</span>
		<span class="n">offset</span><span class="o">++</span><span class="p">;</span>
<span class="cp">#endif</span>
		<span class="n">for_each_eth_queue</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
			<span class="n">synchronize_irq</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">msix_table</span><span class="p">[</span><span class="n">offset</span><span class="o">++</span><span class="p">].</span><span class="n">vector</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">synchronize_irq</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>

	<span class="cm">/* make sure sp_task is not running */</span>
	<span class="n">cancel_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">sp_task</span><span class="p">);</span>
	<span class="n">cancel_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">period_task</span><span class="p">);</span>
	<span class="n">flush_workqueue</span><span class="p">(</span><span class="n">bnx2x_wq</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* fast path */</span>

<span class="cm">/*</span>
<span class="cm"> * General service functions</span>
<span class="cm"> */</span>

<span class="cm">/* Return true if succeeded to acquire the lock */</span>
<span class="k">static</span> <span class="n">bool</span> <span class="nf">bnx2x_trylock_hw_lock</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">,</span> <span class="n">u32</span> <span class="n">resource</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">lock_status</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">resource_bit</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">resource</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">func</span> <span class="o">=</span> <span class="n">BP_FUNC</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">hw_lock_control_reg</span><span class="p">;</span>

	<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_HW</span> <span class="o">|</span> <span class="n">NETIF_MSG_IFUP</span><span class="p">,</span>
	   <span class="s">&quot;Trying to take a lock on resource %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">resource</span><span class="p">);</span>

	<span class="cm">/* Validating that the resource is within range */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">resource</span> <span class="o">&gt;</span> <span class="n">HW_LOCK_MAX_RESOURCE_VALUE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_HW</span> <span class="o">|</span> <span class="n">NETIF_MSG_IFUP</span><span class="p">,</span>
		   <span class="s">&quot;resource(0x%x) &gt; HW_LOCK_MAX_RESOURCE_VALUE(0x%x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">resource</span><span class="p">,</span> <span class="n">HW_LOCK_MAX_RESOURCE_VALUE</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">func</span> <span class="o">&lt;=</span> <span class="mi">5</span><span class="p">)</span>
		<span class="n">hw_lock_control_reg</span> <span class="o">=</span> <span class="p">(</span><span class="n">MISC_REG_DRIVER_CONTROL_1</span> <span class="o">+</span> <span class="n">func</span><span class="o">*</span><span class="mi">8</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">hw_lock_control_reg</span> <span class="o">=</span>
				<span class="p">(</span><span class="n">MISC_REG_DRIVER_CONTROL_7</span> <span class="o">+</span> <span class="p">(</span><span class="n">func</span> <span class="o">-</span> <span class="mi">6</span><span class="p">)</span><span class="o">*</span><span class="mi">8</span><span class="p">);</span>

	<span class="cm">/* Try to acquire the lock */</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">hw_lock_control_reg</span> <span class="o">+</span> <span class="mi">4</span><span class="p">,</span> <span class="n">resource_bit</span><span class="p">);</span>
	<span class="n">lock_status</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">hw_lock_control_reg</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lock_status</span> <span class="o">&amp;</span> <span class="n">resource_bit</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>

	<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_HW</span> <span class="o">|</span> <span class="n">NETIF_MSG_IFUP</span><span class="p">,</span>
	   <span class="s">&quot;Failed to get a lock on resource %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">resource</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * bnx2x_get_leader_lock_resource - get the recovery leader resource id</span>
<span class="cm"> *</span>
<span class="cm"> * @bp:	driver handle</span>
<span class="cm"> *</span>
<span class="cm"> * Returns the recovery leader resource id according to the engine this function</span>
<span class="cm"> * belongs to. Currently only only 2 engines is supported.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">bnx2x_get_leader_lock_resource</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">BP_PATH</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">HW_LOCK_RESOURCE_RECOVERY_LEADER_1</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">HW_LOCK_RESOURCE_RECOVERY_LEADER_0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * bnx2x_trylock_leader_lock- try to aquire a leader lock.</span>
<span class="cm"> *</span>
<span class="cm"> * @bp: driver handle</span>
<span class="cm"> *</span>
<span class="cm"> * Tries to aquire a leader lock for current engine.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">bool</span> <span class="nf">bnx2x_trylock_leader_lock</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">bnx2x_trylock_hw_lock</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">bnx2x_get_leader_lock_resource</span><span class="p">(</span><span class="n">bp</span><span class="p">));</span>
<span class="p">}</span>

<span class="cp">#ifdef BCM_CNIC</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">bnx2x_cnic_cfc_comp</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cid</span><span class="p">,</span> <span class="n">u8</span> <span class="n">err</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="kt">void</span> <span class="nf">bnx2x_sp_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x_fastpath</span> <span class="o">*</span><span class="n">fp</span><span class="p">,</span> <span class="k">union</span> <span class="n">eth_rx_cqe</span> <span class="o">*</span><span class="n">rr_cqe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">bp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cid</span> <span class="o">=</span> <span class="n">SW_CID</span><span class="p">(</span><span class="n">rr_cqe</span><span class="o">-&gt;</span><span class="n">ramrod_cqe</span><span class="p">.</span><span class="n">conn_and_cmd_data</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">command</span> <span class="o">=</span> <span class="n">CQE_CMD</span><span class="p">(</span><span class="n">rr_cqe</span><span class="o">-&gt;</span><span class="n">ramrod_cqe</span><span class="p">.</span><span class="n">conn_and_cmd_data</span><span class="p">);</span>
	<span class="k">enum</span> <span class="n">bnx2x_queue_cmd</span> <span class="n">drv_cmd</span> <span class="o">=</span> <span class="n">BNX2X_Q_CMD_MAX</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bnx2x_queue_sp_obj</span> <span class="o">*</span><span class="n">q_obj</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">q_obj</span><span class="p">;</span>

	<span class="n">DP</span><span class="p">(</span><span class="n">BNX2X_MSG_SP</span><span class="p">,</span>
	   <span class="s">&quot;fp %d  cid %d  got ramrod #%d  state is %x  type is %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	   <span class="n">fp</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">,</span> <span class="n">cid</span><span class="p">,</span> <span class="n">command</span><span class="p">,</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">,</span>
	   <span class="n">rr_cqe</span><span class="o">-&gt;</span><span class="n">ramrod_cqe</span><span class="p">.</span><span class="n">ramrod_type</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">command</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="p">(</span><span class="n">RAMROD_CMD_ID_ETH_CLIENT_UPDATE</span><span class="p">)</span>:
		<span class="n">DP</span><span class="p">(</span><span class="n">BNX2X_MSG_SP</span><span class="p">,</span> <span class="s">&quot;got UPDATE ramrod. CID %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cid</span><span class="p">);</span>
		<span class="n">drv_cmd</span> <span class="o">=</span> <span class="n">BNX2X_Q_CMD_UPDATE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="p">(</span><span class="n">RAMROD_CMD_ID_ETH_CLIENT_SETUP</span><span class="p">)</span>:
		<span class="n">DP</span><span class="p">(</span><span class="n">BNX2X_MSG_SP</span><span class="p">,</span> <span class="s">&quot;got MULTI[%d] setup ramrod</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cid</span><span class="p">);</span>
		<span class="n">drv_cmd</span> <span class="o">=</span> <span class="n">BNX2X_Q_CMD_SETUP</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="p">(</span><span class="n">RAMROD_CMD_ID_ETH_TX_QUEUE_SETUP</span><span class="p">)</span>:
		<span class="n">DP</span><span class="p">(</span><span class="n">BNX2X_MSG_SP</span><span class="p">,</span> <span class="s">&quot;got MULTI[%d] tx-only setup ramrod</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cid</span><span class="p">);</span>
		<span class="n">drv_cmd</span> <span class="o">=</span> <span class="n">BNX2X_Q_CMD_SETUP_TX_ONLY</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="p">(</span><span class="n">RAMROD_CMD_ID_ETH_HALT</span><span class="p">)</span>:
		<span class="n">DP</span><span class="p">(</span><span class="n">BNX2X_MSG_SP</span><span class="p">,</span> <span class="s">&quot;got MULTI[%d] halt ramrod</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cid</span><span class="p">);</span>
		<span class="n">drv_cmd</span> <span class="o">=</span> <span class="n">BNX2X_Q_CMD_HALT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="p">(</span><span class="n">RAMROD_CMD_ID_ETH_TERMINATE</span><span class="p">)</span>:
		<span class="n">DP</span><span class="p">(</span><span class="n">BNX2X_MSG_SP</span><span class="p">,</span> <span class="s">&quot;got MULTI[%d] teminate ramrod</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cid</span><span class="p">);</span>
		<span class="n">drv_cmd</span> <span class="o">=</span> <span class="n">BNX2X_Q_CMD_TERMINATE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="p">(</span><span class="n">RAMROD_CMD_ID_ETH_EMPTY</span><span class="p">)</span>:
		<span class="n">DP</span><span class="p">(</span><span class="n">BNX2X_MSG_SP</span><span class="p">,</span> <span class="s">&quot;got MULTI[%d] empty ramrod</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cid</span><span class="p">);</span>
		<span class="n">drv_cmd</span> <span class="o">=</span> <span class="n">BNX2X_Q_CMD_EMPTY</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">BNX2X_ERR</span><span class="p">(</span><span class="s">&quot;unexpected MC reply (%d) on fp[%d]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">command</span><span class="p">,</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">drv_cmd</span> <span class="o">!=</span> <span class="n">BNX2X_Q_CMD_MAX</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">q_obj</span><span class="o">-&gt;</span><span class="n">complete_cmd</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">q_obj</span><span class="p">,</span> <span class="n">drv_cmd</span><span class="p">))</span>
		<span class="cm">/* q_obj-&gt;complete_cmd() failure means that this was</span>
<span class="cm">		 * an unexpected completion.</span>
<span class="cm">		 *</span>
<span class="cm">		 * In this case we don&#39;t want to increase the bp-&gt;spq_left</span>
<span class="cm">		 * because apparently we haven&#39;t sent this command the first</span>
<span class="cm">		 * place.</span>
<span class="cm">		 */</span>
<span class="cp">#ifdef BNX2X_STOP_ON_ERROR</span>
		<span class="n">bnx2x_panic</span><span class="p">();</span>
<span class="cp">#else</span>
		<span class="k">return</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="n">smp_mb__before_atomic_inc</span><span class="p">();</span>
	<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">cq_spq_left</span><span class="p">);</span>
	<span class="cm">/* push the change in bp-&gt;spq_left and towards the memory */</span>
	<span class="n">smp_mb__after_atomic_inc</span><span class="p">();</span>

	<span class="n">DP</span><span class="p">(</span><span class="n">BNX2X_MSG_SP</span><span class="p">,</span> <span class="s">&quot;bp-&gt;cq_spq_left %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">cq_spq_left</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">drv_cmd</span> <span class="o">==</span> <span class="n">BNX2X_Q_CMD_UPDATE</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">IS_FCOE_FP</span><span class="p">(</span><span class="n">fp</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="o">!!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">BNX2X_AFEX_FCOE_Q_UPDATE_PENDING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">sp_state</span><span class="p">)))</span> <span class="p">{</span>
		<span class="cm">/* if Q update ramrod is completed for last Q in AFEX vif set</span>
<span class="cm">		 * flow, then ACK MCP at the end</span>
<span class="cm">		 *</span>
<span class="cm">		 * mark pending ACK to MCP bit.</span>
<span class="cm">		 * prevent case that both bits are cleared.</span>
<span class="cm">		 * At the end of load/unload driver checks that</span>
<span class="cm">		 * sp_state is cleaerd, and this order prevents</span>
<span class="cm">		 * races</span>
<span class="cm">		 */</span>
		<span class="n">smp_mb__before_clear_bit</span><span class="p">();</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">BNX2X_AFEX_PENDING_VIFSET_MCP_ACK</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">sp_state</span><span class="p">);</span>
		<span class="n">wmb</span><span class="p">();</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">BNX2X_AFEX_FCOE_Q_UPDATE_PENDING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">sp_state</span><span class="p">);</span>
		<span class="n">smp_mb__after_clear_bit</span><span class="p">();</span>

		<span class="cm">/* schedule workqueue to send ack to MCP */</span>
		<span class="n">queue_delayed_work</span><span class="p">(</span><span class="n">bnx2x_wq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">sp_task</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">bnx2x_update_rx_prod</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bnx2x_fastpath</span> <span class="o">*</span><span class="n">fp</span><span class="p">,</span>
			<span class="n">u16</span> <span class="n">bd_prod</span><span class="p">,</span> <span class="n">u16</span> <span class="n">rx_comp_prod</span><span class="p">,</span> <span class="n">u16</span> <span class="n">rx_sge_prod</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">start</span> <span class="o">=</span> <span class="n">BAR_USTRORM_INTMEM</span> <span class="o">+</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">ustorm_rx_prods_offset</span><span class="p">;</span>

	<span class="n">bnx2x_update_rx_prod_gen</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">fp</span><span class="p">,</span> <span class="n">bd_prod</span><span class="p">,</span> <span class="n">rx_comp_prod</span><span class="p">,</span> <span class="n">rx_sge_prod</span><span class="p">,</span>
				 <span class="n">start</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">irqreturn_t</span> <span class="nf">bnx2x_interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_instance</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev_instance</span><span class="p">);</span>
	<span class="n">u16</span> <span class="n">status</span> <span class="o">=</span> <span class="n">bnx2x_ack_int</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
	<span class="n">u16</span> <span class="n">mask</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">cos</span><span class="p">;</span>

	<span class="cm">/* Return here if interrupt is shared and it&#39;s not for us */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_INTR</span><span class="p">,</span> <span class="s">&quot;not our interrupt!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_INTR</span><span class="p">,</span> <span class="s">&quot;got an interrupt  status 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>

<span class="cp">#ifdef BNX2X_STOP_ON_ERROR</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">panic</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="n">for_each_eth_queue</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">bnx2x_fastpath</span> <span class="o">*</span><span class="n">fp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">fp</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="n">mask</span> <span class="o">=</span> <span class="mh">0x2</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">+</span> <span class="n">CNIC_PRESENT</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Handle Rx or Tx according to SB id */</span>
			<span class="n">prefetch</span><span class="p">(</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">rx_cons_sb</span><span class="p">);</span>
			<span class="n">for_each_cos_in_tx_queue</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">cos</span><span class="p">)</span>
				<span class="n">prefetch</span><span class="p">(</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">txdata</span><span class="p">[</span><span class="n">cos</span><span class="p">].</span><span class="n">tx_cons_sb</span><span class="p">);</span>
			<span class="n">prefetch</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">sb_running_index</span><span class="p">[</span><span class="n">SM_RX_ID</span><span class="p">]);</span>
			<span class="n">napi_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bnx2x_fp</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">,</span> <span class="n">napi</span><span class="p">));</span>
			<span class="n">status</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">mask</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

<span class="cp">#ifdef BCM_CNIC</span>
	<span class="n">mask</span> <span class="o">=</span> <span class="mh">0x2</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">mask</span> <span class="o">|</span> <span class="mh">0x1</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">cnic_ops</span> <span class="o">*</span><span class="n">c_ops</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">BNX2X_STATE_OPEN</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">rcu_read_lock</span><span class="p">();</span>
			<span class="n">c_ops</span> <span class="o">=</span> <span class="n">rcu_dereference</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">cnic_ops</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">c_ops</span><span class="p">)</span>
				<span class="n">c_ops</span><span class="o">-&gt;</span><span class="n">cnic_handler</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">cnic_data</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
			<span class="n">rcu_read_unlock</span><span class="p">();</span>
		<span class="p">}</span>

		<span class="n">status</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">mask</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">queue_delayed_work</span><span class="p">(</span><span class="n">bnx2x_wq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">sp_task</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="n">status</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">status</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">status</span><span class="p">))</span>
		<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_INTR</span><span class="p">,</span> <span class="s">&quot;got an unknown interrupt! (status 0x%x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">status</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Link */</span>

<span class="cm">/*</span>
<span class="cm"> * General service functions</span>
<span class="cm"> */</span>

<span class="kt">int</span> <span class="nf">bnx2x_acquire_hw_lock</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">,</span> <span class="n">u32</span> <span class="n">resource</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">lock_status</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">resource_bit</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">resource</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">func</span> <span class="o">=</span> <span class="n">BP_FUNC</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">hw_lock_control_reg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cnt</span><span class="p">;</span>

	<span class="cm">/* Validating that the resource is within range */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">resource</span> <span class="o">&gt;</span> <span class="n">HW_LOCK_MAX_RESOURCE_VALUE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BNX2X_ERR</span><span class="p">(</span><span class="s">&quot;resource(0x%x) &gt; HW_LOCK_MAX_RESOURCE_VALUE(0x%x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">resource</span><span class="p">,</span> <span class="n">HW_LOCK_MAX_RESOURCE_VALUE</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">func</span> <span class="o">&lt;=</span> <span class="mi">5</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hw_lock_control_reg</span> <span class="o">=</span> <span class="p">(</span><span class="n">MISC_REG_DRIVER_CONTROL_1</span> <span class="o">+</span> <span class="n">func</span><span class="o">*</span><span class="mi">8</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">hw_lock_control_reg</span> <span class="o">=</span>
				<span class="p">(</span><span class="n">MISC_REG_DRIVER_CONTROL_7</span> <span class="o">+</span> <span class="p">(</span><span class="n">func</span> <span class="o">-</span> <span class="mi">6</span><span class="p">)</span><span class="o">*</span><span class="mi">8</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Validating that the resource is not already taken */</span>
	<span class="n">lock_status</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">hw_lock_control_reg</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lock_status</span> <span class="o">&amp;</span> <span class="n">resource_bit</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BNX2X_ERR</span><span class="p">(</span><span class="s">&quot;lock_status 0x%x  resource_bit 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">lock_status</span><span class="p">,</span> <span class="n">resource_bit</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EEXIST</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Try for 5 second every 5ms */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">cnt</span> <span class="o">&lt;</span> <span class="mi">1000</span><span class="p">;</span> <span class="n">cnt</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Try to acquire the lock */</span>
		<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">hw_lock_control_reg</span> <span class="o">+</span> <span class="mi">4</span><span class="p">,</span> <span class="n">resource_bit</span><span class="p">);</span>
		<span class="n">lock_status</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">hw_lock_control_reg</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lock_status</span> <span class="o">&amp;</span> <span class="n">resource_bit</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">msleep</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">BNX2X_ERR</span><span class="p">(</span><span class="s">&quot;Timeout</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">bnx2x_release_leader_lock</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">bnx2x_release_hw_lock</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">bnx2x_get_leader_lock_resource</span><span class="p">(</span><span class="n">bp</span><span class="p">));</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">bnx2x_release_hw_lock</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">,</span> <span class="n">u32</span> <span class="n">resource</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">lock_status</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">resource_bit</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">resource</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">func</span> <span class="o">=</span> <span class="n">BP_FUNC</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">hw_lock_control_reg</span><span class="p">;</span>

	<span class="cm">/* Validating that the resource is within range */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">resource</span> <span class="o">&gt;</span> <span class="n">HW_LOCK_MAX_RESOURCE_VALUE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BNX2X_ERR</span><span class="p">(</span><span class="s">&quot;resource(0x%x) &gt; HW_LOCK_MAX_RESOURCE_VALUE(0x%x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">resource</span><span class="p">,</span> <span class="n">HW_LOCK_MAX_RESOURCE_VALUE</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">func</span> <span class="o">&lt;=</span> <span class="mi">5</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hw_lock_control_reg</span> <span class="o">=</span> <span class="p">(</span><span class="n">MISC_REG_DRIVER_CONTROL_1</span> <span class="o">+</span> <span class="n">func</span><span class="o">*</span><span class="mi">8</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">hw_lock_control_reg</span> <span class="o">=</span>
				<span class="p">(</span><span class="n">MISC_REG_DRIVER_CONTROL_7</span> <span class="o">+</span> <span class="p">(</span><span class="n">func</span> <span class="o">-</span> <span class="mi">6</span><span class="p">)</span><span class="o">*</span><span class="mi">8</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Validating that the resource is currently taken */</span>
	<span class="n">lock_status</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">hw_lock_control_reg</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">lock_status</span> <span class="o">&amp;</span> <span class="n">resource_bit</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">BNX2X_ERR</span><span class="p">(</span><span class="s">&quot;lock_status 0x%x resource_bit 0x%x. unlock was called but lock wasn&#39;t taken!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">lock_status</span><span class="p">,</span> <span class="n">resource_bit</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">hw_lock_control_reg</span><span class="p">,</span> <span class="n">resource_bit</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="kt">int</span> <span class="nf">bnx2x_get_gpio</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">gpio_num</span><span class="p">,</span> <span class="n">u8</span> <span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* The GPIO should be swapped if swap register is set and active */</span>
	<span class="kt">int</span> <span class="n">gpio_port</span> <span class="o">=</span> <span class="p">(</span><span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">NIG_REG_PORT_SWAP</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			 <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">NIG_REG_STRAP_OVERRIDE</span><span class="p">))</span> <span class="o">^</span> <span class="n">port</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">gpio_shift</span> <span class="o">=</span> <span class="n">gpio_num</span> <span class="o">+</span>
			<span class="p">(</span><span class="n">gpio_port</span> <span class="o">?</span> <span class="n">MISC_REGISTERS_GPIO_PORT_SHIFT</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">gpio_mask</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">gpio_shift</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">gpio_reg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">value</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">gpio_num</span> <span class="o">&gt;</span> <span class="n">MISC_REGISTERS_GPIO_3</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BNX2X_ERR</span><span class="p">(</span><span class="s">&quot;Invalid GPIO %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">gpio_num</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* read GPIO value */</span>
	<span class="n">gpio_reg</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">MISC_REG_GPIO</span><span class="p">);</span>

	<span class="cm">/* get the requested pin value */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">gpio_reg</span> <span class="o">&amp;</span> <span class="n">gpio_mask</span><span class="p">)</span> <span class="o">==</span> <span class="n">gpio_mask</span><span class="p">)</span>
		<span class="n">value</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">value</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;pin %d  value 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">gpio_num</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">value</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">bnx2x_set_gpio</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">gpio_num</span><span class="p">,</span> <span class="n">u32</span> <span class="n">mode</span><span class="p">,</span> <span class="n">u8</span> <span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* The GPIO should be swapped if swap register is set and active */</span>
	<span class="kt">int</span> <span class="n">gpio_port</span> <span class="o">=</span> <span class="p">(</span><span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">NIG_REG_PORT_SWAP</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			 <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">NIG_REG_STRAP_OVERRIDE</span><span class="p">))</span> <span class="o">^</span> <span class="n">port</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">gpio_shift</span> <span class="o">=</span> <span class="n">gpio_num</span> <span class="o">+</span>
			<span class="p">(</span><span class="n">gpio_port</span> <span class="o">?</span> <span class="n">MISC_REGISTERS_GPIO_PORT_SHIFT</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">gpio_mask</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">gpio_shift</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">gpio_reg</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">gpio_num</span> <span class="o">&gt;</span> <span class="n">MISC_REGISTERS_GPIO_3</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BNX2X_ERR</span><span class="p">(</span><span class="s">&quot;Invalid GPIO %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">gpio_num</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">bnx2x_acquire_hw_lock</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">HW_LOCK_RESOURCE_GPIO</span><span class="p">);</span>
	<span class="cm">/* read GPIO and mask except the float bits */</span>
	<span class="n">gpio_reg</span> <span class="o">=</span> <span class="p">(</span><span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">MISC_REG_GPIO</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">MISC_REGISTERS_GPIO_FLOAT</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">MISC_REGISTERS_GPIO_OUTPUT_LOW</span>:
		<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span>
		   <span class="s">&quot;Set GPIO %d (shift %d) -&gt; output low</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">gpio_num</span><span class="p">,</span> <span class="n">gpio_shift</span><span class="p">);</span>
		<span class="cm">/* clear FLOAT and set CLR */</span>
		<span class="n">gpio_reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">gpio_mask</span> <span class="o">&lt;&lt;</span> <span class="n">MISC_REGISTERS_GPIO_FLOAT_POS</span><span class="p">);</span>
		<span class="n">gpio_reg</span> <span class="o">|=</span>  <span class="p">(</span><span class="n">gpio_mask</span> <span class="o">&lt;&lt;</span> <span class="n">MISC_REGISTERS_GPIO_CLR_POS</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">MISC_REGISTERS_GPIO_OUTPUT_HIGH</span>:
		<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span>
		   <span class="s">&quot;Set GPIO %d (shift %d) -&gt; output high</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">gpio_num</span><span class="p">,</span> <span class="n">gpio_shift</span><span class="p">);</span>
		<span class="cm">/* clear FLOAT and set SET */</span>
		<span class="n">gpio_reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">gpio_mask</span> <span class="o">&lt;&lt;</span> <span class="n">MISC_REGISTERS_GPIO_FLOAT_POS</span><span class="p">);</span>
		<span class="n">gpio_reg</span> <span class="o">|=</span>  <span class="p">(</span><span class="n">gpio_mask</span> <span class="o">&lt;&lt;</span> <span class="n">MISC_REGISTERS_GPIO_SET_POS</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">MISC_REGISTERS_GPIO_INPUT_HI_Z</span>:
		<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span>
		   <span class="s">&quot;Set GPIO %d (shift %d) -&gt; input</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">gpio_num</span><span class="p">,</span> <span class="n">gpio_shift</span><span class="p">);</span>
		<span class="cm">/* set FLOAT */</span>
		<span class="n">gpio_reg</span> <span class="o">|=</span> <span class="p">(</span><span class="n">gpio_mask</span> <span class="o">&lt;&lt;</span> <span class="n">MISC_REGISTERS_GPIO_FLOAT_POS</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">MISC_REG_GPIO</span><span class="p">,</span> <span class="n">gpio_reg</span><span class="p">);</span>
	<span class="n">bnx2x_release_hw_lock</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">HW_LOCK_RESOURCE_GPIO</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">bnx2x_set_mult_gpio</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">,</span> <span class="n">u8</span> <span class="n">pins</span><span class="p">,</span> <span class="n">u32</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">gpio_reg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Any port swapping should be handled by caller. */</span>

	<span class="n">bnx2x_acquire_hw_lock</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">HW_LOCK_RESOURCE_GPIO</span><span class="p">);</span>
	<span class="cm">/* read GPIO and mask except the float bits */</span>
	<span class="n">gpio_reg</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">MISC_REG_GPIO</span><span class="p">);</span>
	<span class="n">gpio_reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">pins</span> <span class="o">&lt;&lt;</span> <span class="n">MISC_REGISTERS_GPIO_FLOAT_POS</span><span class="p">);</span>
	<span class="n">gpio_reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">pins</span> <span class="o">&lt;&lt;</span> <span class="n">MISC_REGISTERS_GPIO_CLR_POS</span><span class="p">);</span>
	<span class="n">gpio_reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">pins</span> <span class="o">&lt;&lt;</span> <span class="n">MISC_REGISTERS_GPIO_SET_POS</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">MISC_REGISTERS_GPIO_OUTPUT_LOW</span>:
		<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;Set GPIO 0x%x -&gt; output low</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pins</span><span class="p">);</span>
		<span class="cm">/* set CLR */</span>
		<span class="n">gpio_reg</span> <span class="o">|=</span> <span class="p">(</span><span class="n">pins</span> <span class="o">&lt;&lt;</span> <span class="n">MISC_REGISTERS_GPIO_CLR_POS</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">MISC_REGISTERS_GPIO_OUTPUT_HIGH</span>:
		<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;Set GPIO 0x%x -&gt; output high</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pins</span><span class="p">);</span>
		<span class="cm">/* set SET */</span>
		<span class="n">gpio_reg</span> <span class="o">|=</span> <span class="p">(</span><span class="n">pins</span> <span class="o">&lt;&lt;</span> <span class="n">MISC_REGISTERS_GPIO_SET_POS</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">MISC_REGISTERS_GPIO_INPUT_HI_Z</span>:
		<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;Set GPIO 0x%x -&gt; input</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pins</span><span class="p">);</span>
		<span class="cm">/* set FLOAT */</span>
		<span class="n">gpio_reg</span> <span class="o">|=</span> <span class="p">(</span><span class="n">pins</span> <span class="o">&lt;&lt;</span> <span class="n">MISC_REGISTERS_GPIO_FLOAT_POS</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">BNX2X_ERR</span><span class="p">(</span><span class="s">&quot;Invalid GPIO mode assignment %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">MISC_REG_GPIO</span><span class="p">,</span> <span class="n">gpio_reg</span><span class="p">);</span>

	<span class="n">bnx2x_release_hw_lock</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">HW_LOCK_RESOURCE_GPIO</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">bnx2x_set_gpio_int</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">gpio_num</span><span class="p">,</span> <span class="n">u32</span> <span class="n">mode</span><span class="p">,</span> <span class="n">u8</span> <span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* The GPIO should be swapped if swap register is set and active */</span>
	<span class="kt">int</span> <span class="n">gpio_port</span> <span class="o">=</span> <span class="p">(</span><span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">NIG_REG_PORT_SWAP</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			 <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">NIG_REG_STRAP_OVERRIDE</span><span class="p">))</span> <span class="o">^</span> <span class="n">port</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">gpio_shift</span> <span class="o">=</span> <span class="n">gpio_num</span> <span class="o">+</span>
			<span class="p">(</span><span class="n">gpio_port</span> <span class="o">?</span> <span class="n">MISC_REGISTERS_GPIO_PORT_SHIFT</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">gpio_mask</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">gpio_shift</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">gpio_reg</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">gpio_num</span> <span class="o">&gt;</span> <span class="n">MISC_REGISTERS_GPIO_3</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BNX2X_ERR</span><span class="p">(</span><span class="s">&quot;Invalid GPIO %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">gpio_num</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">bnx2x_acquire_hw_lock</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">HW_LOCK_RESOURCE_GPIO</span><span class="p">);</span>
	<span class="cm">/* read GPIO int */</span>
	<span class="n">gpio_reg</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">MISC_REG_GPIO_INT</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">MISC_REGISTERS_GPIO_INT_OUTPUT_CLR</span>:
		<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span>
		   <span class="s">&quot;Clear GPIO INT %d (shift %d) -&gt; output low</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">gpio_num</span><span class="p">,</span> <span class="n">gpio_shift</span><span class="p">);</span>
		<span class="cm">/* clear SET and set CLR */</span>
		<span class="n">gpio_reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">gpio_mask</span> <span class="o">&lt;&lt;</span> <span class="n">MISC_REGISTERS_GPIO_INT_SET_POS</span><span class="p">);</span>
		<span class="n">gpio_reg</span> <span class="o">|=</span>  <span class="p">(</span><span class="n">gpio_mask</span> <span class="o">&lt;&lt;</span> <span class="n">MISC_REGISTERS_GPIO_INT_CLR_POS</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">MISC_REGISTERS_GPIO_INT_OUTPUT_SET</span>:
		<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span>
		   <span class="s">&quot;Set GPIO INT %d (shift %d) -&gt; output high</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">gpio_num</span><span class="p">,</span> <span class="n">gpio_shift</span><span class="p">);</span>
		<span class="cm">/* clear CLR and set SET */</span>
		<span class="n">gpio_reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">gpio_mask</span> <span class="o">&lt;&lt;</span> <span class="n">MISC_REGISTERS_GPIO_INT_CLR_POS</span><span class="p">);</span>
		<span class="n">gpio_reg</span> <span class="o">|=</span>  <span class="p">(</span><span class="n">gpio_mask</span> <span class="o">&lt;&lt;</span> <span class="n">MISC_REGISTERS_GPIO_INT_SET_POS</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">MISC_REG_GPIO_INT</span><span class="p">,</span> <span class="n">gpio_reg</span><span class="p">);</span>
	<span class="n">bnx2x_release_hw_lock</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">HW_LOCK_RESOURCE_GPIO</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bnx2x_set_spio</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">spio_num</span><span class="p">,</span> <span class="n">u32</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">spio_mask</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">spio_num</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">spio_reg</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">spio_num</span> <span class="o">&lt;</span> <span class="n">MISC_REGISTERS_SPIO_4</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">spio_num</span> <span class="o">&gt;</span> <span class="n">MISC_REGISTERS_SPIO_7</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">BNX2X_ERR</span><span class="p">(</span><span class="s">&quot;Invalid SPIO %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">spio_num</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">bnx2x_acquire_hw_lock</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">HW_LOCK_RESOURCE_SPIO</span><span class="p">);</span>
	<span class="cm">/* read SPIO and mask except the float bits */</span>
	<span class="n">spio_reg</span> <span class="o">=</span> <span class="p">(</span><span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">MISC_REG_SPIO</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">MISC_REGISTERS_SPIO_FLOAT</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">MISC_REGISTERS_SPIO_OUTPUT_LOW</span>:
		<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_HW</span><span class="p">,</span> <span class="s">&quot;Set SPIO %d -&gt; output low</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">spio_num</span><span class="p">);</span>
		<span class="cm">/* clear FLOAT and set CLR */</span>
		<span class="n">spio_reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">spio_mask</span> <span class="o">&lt;&lt;</span> <span class="n">MISC_REGISTERS_SPIO_FLOAT_POS</span><span class="p">);</span>
		<span class="n">spio_reg</span> <span class="o">|=</span>  <span class="p">(</span><span class="n">spio_mask</span> <span class="o">&lt;&lt;</span> <span class="n">MISC_REGISTERS_SPIO_CLR_POS</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">MISC_REGISTERS_SPIO_OUTPUT_HIGH</span>:
		<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_HW</span><span class="p">,</span> <span class="s">&quot;Set SPIO %d -&gt; output high</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">spio_num</span><span class="p">);</span>
		<span class="cm">/* clear FLOAT and set SET */</span>
		<span class="n">spio_reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">spio_mask</span> <span class="o">&lt;&lt;</span> <span class="n">MISC_REGISTERS_SPIO_FLOAT_POS</span><span class="p">);</span>
		<span class="n">spio_reg</span> <span class="o">|=</span>  <span class="p">(</span><span class="n">spio_mask</span> <span class="o">&lt;&lt;</span> <span class="n">MISC_REGISTERS_SPIO_SET_POS</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">MISC_REGISTERS_SPIO_INPUT_HI_Z</span>:
		<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_HW</span><span class="p">,</span> <span class="s">&quot;Set SPIO %d -&gt; input</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">spio_num</span><span class="p">);</span>
		<span class="cm">/* set FLOAT */</span>
		<span class="n">spio_reg</span> <span class="o">|=</span> <span class="p">(</span><span class="n">spio_mask</span> <span class="o">&lt;&lt;</span> <span class="n">MISC_REGISTERS_SPIO_FLOAT_POS</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">MISC_REG_SPIO</span><span class="p">,</span> <span class="n">spio_reg</span><span class="p">);</span>
	<span class="n">bnx2x_release_hw_lock</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">HW_LOCK_RESOURCE_SPIO</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">bnx2x_calc_fc_adv</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">cfg_idx</span> <span class="o">=</span> <span class="n">bnx2x_get_link_cfg_idx</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">link_vars</span><span class="p">.</span><span class="n">ieee_fc</span> <span class="o">&amp;</span>
		<span class="n">MDIO_COMBO_IEEE0_AUTO_NEG_ADV_PAUSE_MASK</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">MDIO_COMBO_IEEE0_AUTO_NEG_ADV_PAUSE_NONE</span>:
		<span class="n">bp</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">advertising</span><span class="p">[</span><span class="n">cfg_idx</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">ADVERTISED_Asym_Pause</span> <span class="o">|</span>
						   <span class="n">ADVERTISED_Pause</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">MDIO_COMBO_IEEE0_AUTO_NEG_ADV_PAUSE_BOTH</span>:
		<span class="n">bp</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">advertising</span><span class="p">[</span><span class="n">cfg_idx</span><span class="p">]</span> <span class="o">|=</span> <span class="p">(</span><span class="n">ADVERTISED_Asym_Pause</span> <span class="o">|</span>
						  <span class="n">ADVERTISED_Pause</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">MDIO_COMBO_IEEE0_AUTO_NEG_ADV_PAUSE_ASYMMETRIC</span>:
		<span class="n">bp</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">advertising</span><span class="p">[</span><span class="n">cfg_idx</span><span class="p">]</span> <span class="o">|=</span> <span class="n">ADVERTISED_Asym_Pause</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">bp</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">advertising</span><span class="p">[</span><span class="n">cfg_idx</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">ADVERTISED_Asym_Pause</span> <span class="o">|</span>
						   <span class="n">ADVERTISED_Pause</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="n">u8</span> <span class="nf">bnx2x_initial_phy_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">load_mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">BP_NOMCP</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="n">rc</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">cfx_idx</span> <span class="o">=</span> <span class="n">bnx2x_get_link_cfg_idx</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
		<span class="n">u16</span> <span class="n">req_line_speed</span> <span class="o">=</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">link_params</span><span class="p">.</span><span class="n">req_line_speed</span><span class="p">[</span><span class="n">cfx_idx</span><span class="p">];</span>
		<span class="cm">/*</span>
<span class="cm">		 * Initialize link parameters structure variables</span>
<span class="cm">		 * It is recommended to turn off RX FC for jumbo frames</span>
<span class="cm">		 * for better performance</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">CHIP_IS_E1x</span><span class="p">(</span><span class="n">bp</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mtu</span> <span class="o">&gt;</span> <span class="mi">5000</span><span class="p">))</span>
			<span class="n">bp</span><span class="o">-&gt;</span><span class="n">link_params</span><span class="p">.</span><span class="n">req_fc_auto_adv</span> <span class="o">=</span> <span class="n">BNX2X_FLOW_CTRL_TX</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">bp</span><span class="o">-&gt;</span><span class="n">link_params</span><span class="p">.</span><span class="n">req_fc_auto_adv</span> <span class="o">=</span> <span class="n">BNX2X_FLOW_CTRL_BOTH</span><span class="p">;</span>

		<span class="n">bnx2x_acquire_phy_lock</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">load_mode</span> <span class="o">==</span> <span class="n">LOAD_DIAG</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">link_params</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">link_params</span><span class="p">;</span>
			<span class="n">lp</span><span class="o">-&gt;</span><span class="n">loopback_mode</span> <span class="o">=</span> <span class="n">LOOPBACK_XGXS</span><span class="p">;</span>
			<span class="cm">/* do PHY loopback at 10G speed, if possible */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">req_line_speed</span><span class="p">[</span><span class="n">cfx_idx</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">SPEED_10000</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">speed_cap_mask</span><span class="p">[</span><span class="n">cfx_idx</span><span class="p">]</span> <span class="o">&amp;</span>
				    <span class="n">PORT_HW_CFG_SPEED_CAPABILITY_D0_10G</span><span class="p">)</span>
					<span class="n">lp</span><span class="o">-&gt;</span><span class="n">req_line_speed</span><span class="p">[</span><span class="n">cfx_idx</span><span class="p">]</span> <span class="o">=</span>
					<span class="n">SPEED_10000</span><span class="p">;</span>
				<span class="k">else</span>
					<span class="n">lp</span><span class="o">-&gt;</span><span class="n">req_line_speed</span><span class="p">[</span><span class="n">cfx_idx</span><span class="p">]</span> <span class="o">=</span>
					<span class="n">SPEED_1000</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="n">rc</span> <span class="o">=</span> <span class="n">bnx2x_phy_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">link_params</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">link_vars</span><span class="p">);</span>

		<span class="n">bnx2x_release_phy_lock</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>

		<span class="n">bnx2x_calc_fc_adv</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">CHIP_REV_IS_SLOW</span><span class="p">(</span><span class="n">bp</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">link_vars</span><span class="p">.</span><span class="n">link_up</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">bnx2x_stats_handle</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">STATS_EVENT_LINK_UP</span><span class="p">);</span>
			<span class="n">bnx2x_link_report</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">queue_delayed_work</span><span class="p">(</span><span class="n">bnx2x_wq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">period_task</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">bp</span><span class="o">-&gt;</span><span class="n">link_params</span><span class="p">.</span><span class="n">req_line_speed</span><span class="p">[</span><span class="n">cfx_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">req_line_speed</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">BNX2X_ERR</span><span class="p">(</span><span class="s">&quot;Bootcode is missing - can not initialize link</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">bnx2x_link_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">BP_NOMCP</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">bnx2x_acquire_phy_lock</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
		<span class="n">bnx2x_link_reset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">link_params</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">link_vars</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">bnx2x_phy_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">link_params</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">link_vars</span><span class="p">);</span>
		<span class="n">bnx2x_release_phy_lock</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>

		<span class="n">bnx2x_calc_fc_adv</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">BNX2X_ERR</span><span class="p">(</span><span class="s">&quot;Bootcode is missing - can not set link</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x__link_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">BP_NOMCP</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">bnx2x_acquire_phy_lock</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
		<span class="n">bnx2x_link_reset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">link_params</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">link_vars</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">bnx2x_release_phy_lock</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">BNX2X_ERR</span><span class="p">(</span><span class="s">&quot;Bootcode is missing - can not reset link</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">u8</span> <span class="nf">bnx2x_link_test</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">,</span> <span class="n">u8</span> <span class="n">is_serdes</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">BP_NOMCP</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">bnx2x_acquire_phy_lock</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">bnx2x_test_link</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">link_params</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">link_vars</span><span class="p">,</span>
				     <span class="n">is_serdes</span><span class="p">);</span>
		<span class="n">bnx2x_release_phy_lock</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">BNX2X_ERR</span><span class="p">(</span><span class="s">&quot;Bootcode is missing - can not test link</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* Calculates the sum of vn_min_rates.</span>
<span class="cm">   It&#39;s needed for further normalizing of the min_rates.</span>
<span class="cm">   Returns:</span>
<span class="cm">     sum of vn_min_rates.</span>
<span class="cm">       or</span>
<span class="cm">     0 - if all the min_rates are 0.</span>
<span class="cm">     In the later case fainess algorithm should be deactivated.</span>
<span class="cm">     If not all min_rates are zero then those that are zeroes will be set to 1.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_calc_vn_min</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">cmng_init_input</span> <span class="o">*</span><span class="n">input</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">all_zero</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">vn</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">vn</span> <span class="o">=</span> <span class="n">VN_0</span><span class="p">;</span> <span class="n">vn</span> <span class="o">&lt;</span> <span class="n">BP_MAX_VN_NUM</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span> <span class="n">vn</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">vn_cfg</span> <span class="o">=</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">mf_config</span><span class="p">[</span><span class="n">vn</span><span class="p">];</span>
		<span class="n">u32</span> <span class="n">vn_min_rate</span> <span class="o">=</span> <span class="p">((</span><span class="n">vn_cfg</span> <span class="o">&amp;</span> <span class="n">FUNC_MF_CFG_MIN_BW_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span>
				   <span class="n">FUNC_MF_CFG_MIN_BW_SHIFT</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span><span class="p">;</span>

		<span class="cm">/* Skip hidden vns */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vn_cfg</span> <span class="o">&amp;</span> <span class="n">FUNC_MF_CFG_FUNC_HIDE</span><span class="p">)</span>
			<span class="n">vn_min_rate</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="cm">/* If min rate is zero - set it to 1 */</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vn_min_rate</span><span class="p">)</span>
			<span class="n">vn_min_rate</span> <span class="o">=</span> <span class="n">DEF_MIN_RATE</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">all_zero</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">input</span><span class="o">-&gt;</span><span class="n">vnic_min_rate</span><span class="p">[</span><span class="n">vn</span><span class="p">]</span> <span class="o">=</span> <span class="n">vn_min_rate</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* if ETS or all min rates are zeros - disable fairness */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">BNX2X_IS_ETS_ENABLED</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">input</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">cmng_enables</span> <span class="o">&amp;=</span>
					<span class="o">~</span><span class="n">CMNG_FLAGS_PER_PORT_FAIRNESS_VN</span><span class="p">;</span>
		<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_IFUP</span><span class="p">,</span> <span class="s">&quot;Fairness will be disabled due to ETS</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">all_zero</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">input</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">cmng_enables</span> <span class="o">&amp;=</span>
					<span class="o">~</span><span class="n">CMNG_FLAGS_PER_PORT_FAIRNESS_VN</span><span class="p">;</span>
		<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_IFUP</span><span class="p">,</span>
		   <span class="s">&quot;All MIN values are zeroes fairness will be disabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">input</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">cmng_enables</span> <span class="o">|=</span>
					<span class="n">CMNG_FLAGS_PER_PORT_FAIRNESS_VN</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_calc_vn_max</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">vn</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">cmng_init_input</span> <span class="o">*</span><span class="n">input</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">vn_max_rate</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">vn_cfg</span> <span class="o">=</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">mf_config</span><span class="p">[</span><span class="n">vn</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vn_cfg</span> <span class="o">&amp;</span> <span class="n">FUNC_MF_CFG_FUNC_HIDE</span><span class="p">)</span>
		<span class="n">vn_max_rate</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">maxCfg</span> <span class="o">=</span> <span class="n">bnx2x_extract_max_cfg</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">vn_cfg</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">IS_MF_SI</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* maxCfg in percents of linkspeed */</span>
			<span class="n">vn_max_rate</span> <span class="o">=</span> <span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">link_vars</span><span class="p">.</span><span class="n">line_speed</span> <span class="o">*</span> <span class="n">maxCfg</span><span class="p">)</span> <span class="o">/</span> <span class="mi">100</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="cm">/* SD modes */</span>
			<span class="cm">/* maxCfg is absolute in 100Mb units */</span>
			<span class="n">vn_max_rate</span> <span class="o">=</span> <span class="n">maxCfg</span> <span class="o">*</span> <span class="mi">100</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_IFUP</span><span class="p">,</span> <span class="s">&quot;vn %d: vn_max_rate %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">vn</span><span class="p">,</span> <span class="n">vn_max_rate</span><span class="p">);</span>

	<span class="n">input</span><span class="o">-&gt;</span><span class="n">vnic_max_rate</span><span class="p">[</span><span class="n">vn</span><span class="p">]</span> <span class="o">=</span> <span class="n">vn_max_rate</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">bnx2x_get_cmng_fns_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">CHIP_REV_IS_SLOW</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">CMNG_FNS_NONE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_MF</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">CMNG_FNS_MINMAX</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">CMNG_FNS_NONE</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">bnx2x_read_mf_cfg</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">vn</span><span class="p">,</span> <span class="n">n</span> <span class="o">=</span> <span class="p">(</span><span class="n">CHIP_MODE_IS_4_PORT</span><span class="p">(</span><span class="n">bp</span><span class="p">)</span> <span class="o">?</span> <span class="mi">2</span> <span class="o">:</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">BP_NOMCP</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span> <span class="cm">/* what should be the default bvalue in this case */</span>

	<span class="cm">/* For 2 port configuration the absolute function number formula</span>
<span class="cm">	 * is:</span>
<span class="cm">	 *      abs_func = 2 * vn + BP_PORT + BP_PATH</span>
<span class="cm">	 *</span>
<span class="cm">	 *      and there are 4 functions per port</span>
<span class="cm">	 *</span>
<span class="cm">	 * For 4 port configuration it is</span>
<span class="cm">	 *      abs_func = 4 * vn + 2 * BP_PORT + BP_PATH</span>
<span class="cm">	 *</span>
<span class="cm">	 *      and there are 2 functions per port</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">vn</span> <span class="o">=</span> <span class="n">VN_0</span><span class="p">;</span> <span class="n">vn</span> <span class="o">&lt;</span> <span class="n">BP_MAX_VN_NUM</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span> <span class="n">vn</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="cm">/*abs*/</span><span class="n">func</span> <span class="o">=</span> <span class="n">n</span> <span class="o">*</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">vn</span> <span class="o">+</span> <span class="n">BP_PORT</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span> <span class="o">+</span> <span class="n">BP_PATH</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">func</span> <span class="o">&gt;=</span> <span class="n">E1H_FUNC_MAX</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">bp</span><span class="o">-&gt;</span><span class="n">mf_config</span><span class="p">[</span><span class="n">vn</span><span class="p">]</span> <span class="o">=</span>
			<span class="n">MF_CFG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">func_mf_config</span><span class="p">[</span><span class="n">func</span><span class="p">].</span><span class="n">config</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">mf_config</span><span class="p">[</span><span class="n">BP_VN</span><span class="p">(</span><span class="n">bp</span><span class="p">)]</span> <span class="o">&amp;</span> <span class="n">FUNC_MF_CFG_FUNC_DISABLED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_IFUP</span><span class="p">,</span> <span class="s">&quot;mf_cfg function disabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">bp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">MF_FUNC_DIS</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_IFUP</span><span class="p">,</span> <span class="s">&quot;mf_cfg function enabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">bp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MF_FUNC_DIS</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_cmng_fns_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">,</span> <span class="n">u8</span> <span class="n">read_cfg</span><span class="p">,</span> <span class="n">u8</span> <span class="n">cmng_type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cmng_init_input</span> <span class="n">input</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">input</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">cmng_init_input</span><span class="p">));</span>

	<span class="n">input</span><span class="p">.</span><span class="n">port_rate</span> <span class="o">=</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">link_vars</span><span class="p">.</span><span class="n">line_speed</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmng_type</span> <span class="o">==</span> <span class="n">CMNG_FNS_MINMAX</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">vn</span><span class="p">;</span>

		<span class="cm">/* read mf conf from shmem */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">read_cfg</span><span class="p">)</span>
			<span class="n">bnx2x_read_mf_cfg</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>

		<span class="cm">/* vn_weight_sum and enable fairness if not 0 */</span>
		<span class="n">bnx2x_calc_vn_min</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">input</span><span class="p">);</span>

		<span class="cm">/* calculate and set min-max rate for each vn */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">pmf</span><span class="p">)</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">vn</span> <span class="o">=</span> <span class="n">VN_0</span><span class="p">;</span> <span class="n">vn</span> <span class="o">&lt;</span> <span class="n">BP_MAX_VN_NUM</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span> <span class="n">vn</span><span class="o">++</span><span class="p">)</span>
				<span class="n">bnx2x_calc_vn_max</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">vn</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">input</span><span class="p">);</span>

		<span class="cm">/* always enable rate shaping and fairness */</span>
		<span class="n">input</span><span class="p">.</span><span class="n">flags</span><span class="p">.</span><span class="n">cmng_enables</span> <span class="o">|=</span>
					<span class="n">CMNG_FLAGS_PER_PORT_RATE_SHAPING_VN</span><span class="p">;</span>

		<span class="n">bnx2x_init_cmng</span><span class="p">(</span><span class="o">&amp;</span><span class="n">input</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">cmng</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* rate shaping and fairness are disabled */</span>
	<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_IFUP</span><span class="p">,</span>
	   <span class="s">&quot;rate shaping and fairness are disabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">storm_memset_cmng</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">cmng_init</span> <span class="o">*</span><span class="n">cmng</span><span class="p">,</span>
			      <span class="n">u8</span> <span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">vn</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">cmng_struct_per_port</span><span class="p">);</span>

	<span class="n">u32</span> <span class="n">addr</span> <span class="o">=</span> <span class="n">BAR_XSTRORM_INTMEM</span> <span class="o">+</span>
			<span class="n">XSTORM_CMNG_PER_PORT_VARS_OFFSET</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>

	<span class="n">__storm_memset_struct</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">cmng</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">vn</span> <span class="o">=</span> <span class="n">VN_0</span><span class="p">;</span> <span class="n">vn</span> <span class="o">&lt;</span> <span class="n">BP_MAX_VN_NUM</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span> <span class="n">vn</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">func</span> <span class="o">=</span> <span class="n">func_by_vn</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">vn</span><span class="p">);</span>

		<span class="n">addr</span> <span class="o">=</span> <span class="n">BAR_XSTRORM_INTMEM</span> <span class="o">+</span>
		       <span class="n">XSTORM_RATE_SHAPING_PER_VN_VARS_OFFSET</span><span class="p">(</span><span class="n">func</span><span class="p">);</span>
		<span class="n">size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">rate_shaping_vars_per_vn</span><span class="p">);</span>
		<span class="n">__storm_memset_struct</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span>
				      <span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">cmng</span><span class="o">-&gt;</span><span class="n">vnic</span><span class="p">.</span><span class="n">vnic_max_rate</span><span class="p">[</span><span class="n">vn</span><span class="p">]);</span>

		<span class="n">addr</span> <span class="o">=</span> <span class="n">BAR_XSTRORM_INTMEM</span> <span class="o">+</span>
		       <span class="n">XSTORM_FAIRNESS_PER_VN_VARS_OFFSET</span><span class="p">(</span><span class="n">func</span><span class="p">);</span>
		<span class="n">size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fairness_vars_per_vn</span><span class="p">);</span>
		<span class="n">__storm_memset_struct</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span>
				      <span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">cmng</span><span class="o">-&gt;</span><span class="n">vnic</span><span class="p">.</span><span class="n">vnic_min_rate</span><span class="p">[</span><span class="n">vn</span><span class="p">]);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* This function is called upon link interrupt */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_link_attn</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Make sure that we are synced with the current statistics */</span>
	<span class="n">bnx2x_stats_handle</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">STATS_EVENT_STOP</span><span class="p">);</span>

	<span class="n">bnx2x_link_update</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">link_params</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">link_vars</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">link_vars</span><span class="p">.</span><span class="n">link_up</span><span class="p">)</span> <span class="p">{</span>

		<span class="cm">/* dropless flow control */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CHIP_IS_E1</span><span class="p">(</span><span class="n">bp</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">dropless_fc</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">port</span> <span class="o">=</span> <span class="n">BP_PORT</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
			<span class="n">u32</span> <span class="n">pause_enabled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">link_vars</span><span class="p">.</span><span class="n">flow_ctrl</span> <span class="o">&amp;</span> <span class="n">BNX2X_FLOW_CTRL_TX</span><span class="p">)</span>
				<span class="n">pause_enabled</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

			<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">BAR_USTRORM_INTMEM</span> <span class="o">+</span>
			       <span class="n">USTORM_ETH_PAUSE_ENABLED_OFFSET</span><span class="p">(</span><span class="n">port</span><span class="p">),</span>
			       <span class="n">pause_enabled</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">link_vars</span><span class="p">.</span><span class="n">mac_type</span> <span class="o">!=</span> <span class="n">MAC_TYPE_EMAC</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">host_port_stats</span> <span class="o">*</span><span class="n">pstats</span><span class="p">;</span>

			<span class="n">pstats</span> <span class="o">=</span> <span class="n">bnx2x_sp</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">port_stats</span><span class="p">);</span>
			<span class="cm">/* reset old mac stats */</span>
			<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">pstats</span><span class="o">-&gt;</span><span class="n">mac_stx</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="mi">0</span><span class="p">,</span>
			       <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mac_stx</span><span class="p">));</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">BNX2X_STATE_OPEN</span><span class="p">)</span>
			<span class="n">bnx2x_stats_handle</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">STATS_EVENT_LINK_UP</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">link_vars</span><span class="p">.</span><span class="n">link_up</span> <span class="o">&amp;&amp;</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">link_vars</span><span class="p">.</span><span class="n">line_speed</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">cmng_fns</span> <span class="o">=</span> <span class="n">bnx2x_get_cmng_fns_mode</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">cmng_fns</span> <span class="o">!=</span> <span class="n">CMNG_FNS_NONE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">bnx2x_cmng_fns_init</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="n">cmng_fns</span><span class="p">);</span>
			<span class="n">storm_memset_cmng</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">cmng</span><span class="p">,</span> <span class="n">BP_PORT</span><span class="p">(</span><span class="n">bp</span><span class="p">));</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="cm">/* rate shaping and fairness are disabled */</span>
			<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_IFUP</span><span class="p">,</span>
			   <span class="s">&quot;single function mode without fairness</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">__bnx2x_link_report</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_MF</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span>
		<span class="n">bnx2x_link_sync_notify</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">bnx2x__link_status_update</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">BNX2X_STATE_OPEN</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* read updated dcb configuration */</span>
	<span class="n">bnx2x_dcbx_pmf_update</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>

	<span class="n">bnx2x_link_status_update</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">link_params</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">link_vars</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">link_vars</span><span class="p">.</span><span class="n">link_up</span><span class="p">)</span>
		<span class="n">bnx2x_stats_handle</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">STATS_EVENT_LINK_UP</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">bnx2x_stats_handle</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">STATS_EVENT_STOP</span><span class="p">);</span>

	<span class="cm">/* indicate link status */</span>
	<span class="n">bnx2x_link_report</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bnx2x_afex_func_update</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">,</span> <span class="n">u16</span> <span class="n">vifid</span><span class="p">,</span>
				  <span class="n">u16</span> <span class="n">vlan_val</span><span class="p">,</span> <span class="n">u8</span> <span class="n">allowed_prio</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2x_func_state_params</span> <span class="n">func_params</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
	<span class="k">struct</span> <span class="n">bnx2x_func_afex_update_params</span> <span class="o">*</span><span class="n">f_update_params</span> <span class="o">=</span>
		<span class="o">&amp;</span><span class="n">func_params</span><span class="p">.</span><span class="n">params</span><span class="p">.</span><span class="n">afex_update</span><span class="p">;</span>

	<span class="n">func_params</span><span class="p">.</span><span class="n">f_obj</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">func_obj</span><span class="p">;</span>
	<span class="n">func_params</span><span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">BNX2X_F_CMD_AFEX_UPDATE</span><span class="p">;</span>

	<span class="cm">/* no need to wait for RAMROD completion, so don&#39;t</span>
<span class="cm">	 * set RAMROD_COMP_WAIT flag</span>
<span class="cm">	 */</span>

	<span class="n">f_update_params</span><span class="o">-&gt;</span><span class="n">vif_id</span> <span class="o">=</span> <span class="n">vifid</span><span class="p">;</span>
	<span class="n">f_update_params</span><span class="o">-&gt;</span><span class="n">afex_default_vlan</span> <span class="o">=</span> <span class="n">vlan_val</span><span class="p">;</span>
	<span class="n">f_update_params</span><span class="o">-&gt;</span><span class="n">allowed_priorities</span> <span class="o">=</span> <span class="n">allowed_prio</span><span class="p">;</span>

	<span class="cm">/* if ramrod can not be sent, response to MCP immediately */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bnx2x_func_state_change</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">func_params</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">bnx2x_fw_command</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">DRV_MSG_CODE_AFEX_VIFSET_ACK</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bnx2x_afex_handle_vif_list_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">,</span> <span class="n">u8</span> <span class="n">cmd_type</span><span class="p">,</span>
					  <span class="n">u16</span> <span class="n">vif_index</span><span class="p">,</span> <span class="n">u8</span> <span class="n">func_bit_map</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2x_func_state_params</span> <span class="n">func_params</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
	<span class="k">struct</span> <span class="n">bnx2x_func_afex_viflists_params</span> <span class="o">*</span><span class="n">update_params</span> <span class="o">=</span>
		<span class="o">&amp;</span><span class="n">func_params</span><span class="p">.</span><span class="n">params</span><span class="p">.</span><span class="n">afex_viflists</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">drv_msg_code</span><span class="p">;</span>

	<span class="cm">/* validate only LIST_SET and LIST_GET are received from switch */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">cmd_type</span> <span class="o">!=</span> <span class="n">VIF_LIST_RULE_GET</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">cmd_type</span> <span class="o">!=</span> <span class="n">VIF_LIST_RULE_SET</span><span class="p">))</span>
		<span class="n">BNX2X_ERR</span><span class="p">(</span><span class="s">&quot;BUG! afex_handle_vif_list_cmd invalid type 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">cmd_type</span><span class="p">);</span>

	<span class="n">func_params</span><span class="p">.</span><span class="n">f_obj</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">func_obj</span><span class="p">;</span>
	<span class="n">func_params</span><span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">BNX2X_F_CMD_AFEX_VIFLISTS</span><span class="p">;</span>

	<span class="cm">/* set parameters according to cmd_type */</span>
	<span class="n">update_params</span><span class="o">-&gt;</span><span class="n">afex_vif_list_command</span> <span class="o">=</span> <span class="n">cmd_type</span><span class="p">;</span>
	<span class="n">update_params</span><span class="o">-&gt;</span><span class="n">vif_list_index</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">vif_index</span><span class="p">);</span>
	<span class="n">update_params</span><span class="o">-&gt;</span><span class="n">func_bit_map</span> <span class="o">=</span>
		<span class="p">(</span><span class="n">cmd_type</span> <span class="o">==</span> <span class="n">VIF_LIST_RULE_GET</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">func_bit_map</span><span class="p">;</span>
	<span class="n">update_params</span><span class="o">-&gt;</span><span class="n">func_to_clear</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">drv_msg_code</span> <span class="o">=</span>
		<span class="p">(</span><span class="n">cmd_type</span> <span class="o">==</span> <span class="n">VIF_LIST_RULE_GET</span><span class="p">)</span> <span class="o">?</span>
		<span class="n">DRV_MSG_CODE_AFEX_LISTGET_ACK</span> <span class="o">:</span>
		<span class="n">DRV_MSG_CODE_AFEX_LISTSET_ACK</span><span class="p">;</span>

	<span class="cm">/* if ramrod can not be sent, respond to MCP immediately for</span>
<span class="cm">	 * SET and GET requests (other are not triggered from MCP)</span>
<span class="cm">	 */</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">bnx2x_func_state_change</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">func_params</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">bnx2x_fw_command</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">drv_msg_code</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_handle_afex_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">,</span> <span class="n">u32</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">afex_stats</span> <span class="n">afex_stats</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">func</span> <span class="o">=</span> <span class="n">BP_ABS_FUNC</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">mf_config</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">vlan_val</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">vlan_prio</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">vif_id</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">allowed_prio</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">vlan_mode</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">addr_to_write</span><span class="p">,</span> <span class="n">vifid</span><span class="p">,</span> <span class="n">addrs</span><span class="p">,</span> <span class="n">stats_type</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">&amp;</span> <span class="n">DRV_STATUS_AFEX_LISTGET_REQ</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vifid</span> <span class="o">=</span> <span class="n">SHMEM2_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">afex_param1_to_driver</span><span class="p">[</span><span class="n">BP_FW_MB_IDX</span><span class="p">(</span><span class="n">bp</span><span class="p">)]);</span>
		<span class="n">DP</span><span class="p">(</span><span class="n">BNX2X_MSG_MCP</span><span class="p">,</span>
		   <span class="s">&quot;afex: got MCP req LISTGET_REQ for vifid 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">vifid</span><span class="p">);</span>
		<span class="n">bnx2x_afex_handle_vif_list_cmd</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">VIF_LIST_RULE_GET</span><span class="p">,</span> <span class="n">vifid</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">&amp;</span> <span class="n">DRV_STATUS_AFEX_LISTSET_REQ</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vifid</span> <span class="o">=</span> <span class="n">SHMEM2_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">afex_param1_to_driver</span><span class="p">[</span><span class="n">BP_FW_MB_IDX</span><span class="p">(</span><span class="n">bp</span><span class="p">)]);</span>
		<span class="n">addrs</span> <span class="o">=</span> <span class="n">SHMEM2_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">afex_param2_to_driver</span><span class="p">[</span><span class="n">BP_FW_MB_IDX</span><span class="p">(</span><span class="n">bp</span><span class="p">)]);</span>
		<span class="n">DP</span><span class="p">(</span><span class="n">BNX2X_MSG_MCP</span><span class="p">,</span>
		   <span class="s">&quot;afex: got MCP req LISTSET_REQ for vifid 0x%x addrs 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">vifid</span><span class="p">,</span> <span class="n">addrs</span><span class="p">);</span>
		<span class="n">bnx2x_afex_handle_vif_list_cmd</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">VIF_LIST_RULE_SET</span><span class="p">,</span> <span class="n">vifid</span><span class="p">,</span>
					       <span class="n">addrs</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">&amp;</span> <span class="n">DRV_STATUS_AFEX_STATSGET_REQ</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">addr_to_write</span> <span class="o">=</span> <span class="n">SHMEM2_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span>
			<span class="n">afex_scratchpad_addr_to_write</span><span class="p">[</span><span class="n">BP_FW_MB_IDX</span><span class="p">(</span><span class="n">bp</span><span class="p">)]);</span>
		<span class="n">stats_type</span> <span class="o">=</span> <span class="n">SHMEM2_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span>
			<span class="n">afex_param1_to_driver</span><span class="p">[</span><span class="n">BP_FW_MB_IDX</span><span class="p">(</span><span class="n">bp</span><span class="p">)]);</span>

		<span class="n">DP</span><span class="p">(</span><span class="n">BNX2X_MSG_MCP</span><span class="p">,</span>
		   <span class="s">&quot;afex: got MCP req STATSGET_REQ, write to addr 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">addr_to_write</span><span class="p">);</span>

		<span class="n">bnx2x_afex_collect_stats</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">afex_stats</span><span class="p">,</span> <span class="n">stats_type</span><span class="p">);</span>

		<span class="cm">/* write response to scratchpad, for MCP */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">afex_stats</span><span class="p">)</span><span class="o">/</span><span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">));</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">addr_to_write</span> <span class="o">+</span> <span class="n">i</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">),</span>
			       <span class="o">*</span><span class="p">(((</span><span class="n">u32</span> <span class="o">*</span><span class="p">)(</span><span class="o">&amp;</span><span class="n">afex_stats</span><span class="p">))</span><span class="o">+</span><span class="n">i</span><span class="p">));</span>

		<span class="cm">/* send ack message to MCP */</span>
		<span class="n">bnx2x_fw_command</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">DRV_MSG_CODE_AFEX_STATSGET_ACK</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">&amp;</span> <span class="n">DRV_STATUS_AFEX_VIFSET_REQ</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mf_config</span> <span class="o">=</span> <span class="n">MF_CFG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">func_mf_config</span><span class="p">[</span><span class="n">func</span><span class="p">].</span><span class="n">config</span><span class="p">);</span>
		<span class="n">bp</span><span class="o">-&gt;</span><span class="n">mf_config</span><span class="p">[</span><span class="n">BP_VN</span><span class="p">(</span><span class="n">bp</span><span class="p">)]</span> <span class="o">=</span> <span class="n">mf_config</span><span class="p">;</span>
		<span class="n">DP</span><span class="p">(</span><span class="n">BNX2X_MSG_MCP</span><span class="p">,</span>
		   <span class="s">&quot;afex: got MCP req VIFSET_REQ, mf_config 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">mf_config</span><span class="p">);</span>

		<span class="cm">/* if VIF_SET is &quot;enabled&quot; */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">mf_config</span> <span class="o">&amp;</span> <span class="n">FUNC_MF_CFG_FUNC_DISABLED</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* set rate limit directly to internal RAM */</span>
			<span class="k">struct</span> <span class="n">cmng_init_input</span> <span class="n">cmng_input</span><span class="p">;</span>
			<span class="k">struct</span> <span class="n">rate_shaping_vars_per_vn</span> <span class="n">m_rs_vn</span><span class="p">;</span>
			<span class="kt">size_t</span> <span class="n">size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">rate_shaping_vars_per_vn</span><span class="p">);</span>
			<span class="n">u32</span> <span class="n">addr</span> <span class="o">=</span> <span class="n">BAR_XSTRORM_INTMEM</span> <span class="o">+</span>
			    <span class="n">XSTORM_RATE_SHAPING_PER_VN_VARS_OFFSET</span><span class="p">(</span><span class="n">BP_FUNC</span><span class="p">(</span><span class="n">bp</span><span class="p">));</span>

			<span class="n">bp</span><span class="o">-&gt;</span><span class="n">mf_config</span><span class="p">[</span><span class="n">BP_VN</span><span class="p">(</span><span class="n">bp</span><span class="p">)]</span> <span class="o">=</span> <span class="n">mf_config</span><span class="p">;</span>

			<span class="n">bnx2x_calc_vn_max</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">BP_VN</span><span class="p">(</span><span class="n">bp</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">cmng_input</span><span class="p">);</span>
			<span class="n">m_rs_vn</span><span class="p">.</span><span class="n">vn_counter</span><span class="p">.</span><span class="n">rate</span> <span class="o">=</span>
				<span class="n">cmng_input</span><span class="p">.</span><span class="n">vnic_max_rate</span><span class="p">[</span><span class="n">BP_VN</span><span class="p">(</span><span class="n">bp</span><span class="p">)];</span>
			<span class="n">m_rs_vn</span><span class="p">.</span><span class="n">vn_counter</span><span class="p">.</span><span class="n">quota</span> <span class="o">=</span>
				<span class="p">(</span><span class="n">m_rs_vn</span><span class="p">.</span><span class="n">vn_counter</span><span class="p">.</span><span class="n">rate</span> <span class="o">*</span>
				 <span class="n">RS_PERIODIC_TIMEOUT_USEC</span><span class="p">)</span> <span class="o">/</span> <span class="mi">8</span><span class="p">;</span>

			<span class="n">__storm_memset_struct</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">m_rs_vn</span><span class="p">);</span>

			<span class="cm">/* read relevant values from mf_cfg struct in shmem */</span>
			<span class="n">vif_id</span> <span class="o">=</span>
				<span class="p">(</span><span class="n">MF_CFG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">func_mf_config</span><span class="p">[</span><span class="n">func</span><span class="p">].</span><span class="n">e1hov_tag</span><span class="p">)</span> <span class="o">&amp;</span>
				 <span class="n">FUNC_MF_CFG_E1HOV_TAG_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span>
				<span class="n">FUNC_MF_CFG_E1HOV_TAG_SHIFT</span><span class="p">;</span>
			<span class="n">vlan_val</span> <span class="o">=</span>
				<span class="p">(</span><span class="n">MF_CFG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">func_mf_config</span><span class="p">[</span><span class="n">func</span><span class="p">].</span><span class="n">e1hov_tag</span><span class="p">)</span> <span class="o">&amp;</span>
				 <span class="n">FUNC_MF_CFG_AFEX_VLAN_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span>
				<span class="n">FUNC_MF_CFG_AFEX_VLAN_SHIFT</span><span class="p">;</span>
			<span class="n">vlan_prio</span> <span class="o">=</span> <span class="p">(</span><span class="n">mf_config</span> <span class="o">&amp;</span>
				     <span class="n">FUNC_MF_CFG_TRANSMIT_PRIORITY_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span>
				    <span class="n">FUNC_MF_CFG_TRANSMIT_PRIORITY_SHIFT</span><span class="p">;</span>
			<span class="n">vlan_val</span> <span class="o">|=</span> <span class="p">(</span><span class="n">vlan_prio</span> <span class="o">&lt;&lt;</span> <span class="n">VLAN_PRIO_SHIFT</span><span class="p">);</span>
			<span class="n">vlan_mode</span> <span class="o">=</span>
				<span class="p">(</span><span class="n">MF_CFG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span>
					   <span class="n">func_mf_config</span><span class="p">[</span><span class="n">func</span><span class="p">].</span><span class="n">afex_config</span><span class="p">)</span> <span class="o">&amp;</span>
				 <span class="n">FUNC_MF_CFG_AFEX_VLAN_MODE_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span>
				<span class="n">FUNC_MF_CFG_AFEX_VLAN_MODE_SHIFT</span><span class="p">;</span>
			<span class="n">allowed_prio</span> <span class="o">=</span>
				<span class="p">(</span><span class="n">MF_CFG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span>
					   <span class="n">func_mf_config</span><span class="p">[</span><span class="n">func</span><span class="p">].</span><span class="n">afex_config</span><span class="p">)</span> <span class="o">&amp;</span>
				 <span class="n">FUNC_MF_CFG_AFEX_COS_FILTER_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span>
				<span class="n">FUNC_MF_CFG_AFEX_COS_FILTER_SHIFT</span><span class="p">;</span>

			<span class="cm">/* send ramrod to FW, return in case of failure */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">bnx2x_afex_func_update</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">vif_id</span><span class="p">,</span> <span class="n">vlan_val</span><span class="p">,</span>
						   <span class="n">allowed_prio</span><span class="p">))</span>
				<span class="k">return</span><span class="p">;</span>

			<span class="n">bp</span><span class="o">-&gt;</span><span class="n">afex_def_vlan_tag</span> <span class="o">=</span> <span class="n">vlan_val</span><span class="p">;</span>
			<span class="n">bp</span><span class="o">-&gt;</span><span class="n">afex_vlan_mode</span> <span class="o">=</span> <span class="n">vlan_mode</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* notify link down because BP-&gt;flags is disabled */</span>
			<span class="n">bnx2x_link_report</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>

			<span class="cm">/* send INVALID VIF ramrod to FW */</span>
			<span class="n">bnx2x_afex_func_update</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="mh">0xFFFF</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

			<span class="cm">/* Reset the default afex VLAN */</span>
			<span class="n">bp</span><span class="o">-&gt;</span><span class="n">afex_def_vlan_tag</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_pmf_update</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">port</span> <span class="o">=</span> <span class="n">BP_PORT</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">bp</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">pmf</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">DP</span><span class="p">(</span><span class="n">BNX2X_MSG_MCP</span><span class="p">,</span> <span class="s">&quot;pmf %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">pmf</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * We need the mb() to ensure the ordering between the writing to</span>
<span class="cm">	 * bp-&gt;port.pmf here and reading it from the bnx2x_periodic_task().</span>
<span class="cm">	 */</span>
	<span class="n">smp_mb</span><span class="p">();</span>

	<span class="cm">/* queue a periodic task */</span>
	<span class="n">queue_delayed_work</span><span class="p">(</span><span class="n">bnx2x_wq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">period_task</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">bnx2x_dcbx_pmf_update</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>

	<span class="cm">/* enable nig attention */</span>
	<span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="mh">0xff0f</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">BP_VN</span><span class="p">(</span><span class="n">bp</span><span class="p">)</span> <span class="o">+</span> <span class="mi">4</span><span class="p">)));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">.</span><span class="n">int_block</span> <span class="o">==</span> <span class="n">INT_BLOCK_HC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">HC_REG_TRAILING_EDGE_0</span> <span class="o">+</span> <span class="n">port</span><span class="o">*</span><span class="mi">8</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
		<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">HC_REG_LEADING_EDGE_0</span> <span class="o">+</span> <span class="n">port</span><span class="o">*</span><span class="mi">8</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CHIP_IS_E1x</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">IGU_REG_TRAILING_EDGE_LATCH</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
		<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">IGU_REG_LEADING_EDGE_LATCH</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">bnx2x_stats_handle</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">STATS_EVENT_PMF</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* end of Link */</span>

<span class="cm">/* slow path */</span>

<span class="cm">/*</span>
<span class="cm"> * General service functions</span>
<span class="cm"> */</span>

<span class="cm">/* send the MCP a request, block until there is a reply */</span>
<span class="n">u32</span> <span class="nf">bnx2x_fw_command</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">,</span> <span class="n">u32</span> <span class="n">command</span><span class="p">,</span> <span class="n">u32</span> <span class="n">param</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">mb_idx</span> <span class="o">=</span> <span class="n">BP_FW_MB_IDX</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">seq</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">cnt</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">delay</span> <span class="o">=</span> <span class="n">CHIP_REV_IS_SLOW</span><span class="p">(</span><span class="n">bp</span><span class="p">)</span> <span class="o">?</span> <span class="mi">100</span> <span class="o">:</span> <span class="mi">10</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">fw_mb_mutex</span><span class="p">);</span>
	<span class="n">seq</span> <span class="o">=</span> <span class="o">++</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">fw_seq</span><span class="p">;</span>
	<span class="n">SHMEM_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">func_mb</span><span class="p">[</span><span class="n">mb_idx</span><span class="p">].</span><span class="n">drv_mb_param</span><span class="p">,</span> <span class="n">param</span><span class="p">);</span>
	<span class="n">SHMEM_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">func_mb</span><span class="p">[</span><span class="n">mb_idx</span><span class="p">].</span><span class="n">drv_mb_header</span><span class="p">,</span> <span class="p">(</span><span class="n">command</span> <span class="o">|</span> <span class="n">seq</span><span class="p">));</span>

	<span class="n">DP</span><span class="p">(</span><span class="n">BNX2X_MSG_MCP</span><span class="p">,</span> <span class="s">&quot;wrote command (%x) to FW MB param 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="n">command</span> <span class="o">|</span> <span class="n">seq</span><span class="p">),</span> <span class="n">param</span><span class="p">);</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="cm">/* let the FW do it&#39;s magic ... */</span>
		<span class="n">msleep</span><span class="p">(</span><span class="n">delay</span><span class="p">);</span>

		<span class="n">rc</span> <span class="o">=</span> <span class="n">SHMEM_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">func_mb</span><span class="p">[</span><span class="n">mb_idx</span><span class="p">].</span><span class="n">fw_mb_header</span><span class="p">);</span>

		<span class="cm">/* Give the FW up to 5 second (500*10ms) */</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">((</span><span class="n">seq</span> <span class="o">!=</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&amp;</span> <span class="n">FW_MSG_SEQ_NUMBER_MASK</span><span class="p">))</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">cnt</span><span class="o">++</span> <span class="o">&lt;</span> <span class="mi">500</span><span class="p">));</span>

	<span class="n">DP</span><span class="p">(</span><span class="n">BNX2X_MSG_MCP</span><span class="p">,</span> <span class="s">&quot;[after %d ms] read (%x) seq is (%x) from FW MB</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	   <span class="n">cnt</span><span class="o">*</span><span class="n">delay</span><span class="p">,</span> <span class="n">rc</span><span class="p">,</span> <span class="n">seq</span><span class="p">);</span>

	<span class="cm">/* is this a reply to our command? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">seq</span> <span class="o">==</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&amp;</span> <span class="n">FW_MSG_SEQ_NUMBER_MASK</span><span class="p">))</span>
		<span class="n">rc</span> <span class="o">&amp;=</span> <span class="n">FW_MSG_CODE_MASK</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* FW BUG! */</span>
		<span class="n">BNX2X_ERR</span><span class="p">(</span><span class="s">&quot;FW failed to respond!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">bnx2x_fw_dump</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">fw_mb_mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">storm_memset_func_cfg</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">tstorm_eth_function_common_config</span> <span class="o">*</span><span class="n">tcfg</span><span class="p">,</span>
				 <span class="n">u16</span> <span class="n">abs_fid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">size_t</span> <span class="n">size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">tstorm_eth_function_common_config</span><span class="p">);</span>

	<span class="n">u32</span> <span class="n">addr</span> <span class="o">=</span> <span class="n">BAR_TSTRORM_INTMEM</span> <span class="o">+</span>
			<span class="n">TSTORM_FUNCTION_COMMON_CONFIG_OFFSET</span><span class="p">(</span><span class="n">abs_fid</span><span class="p">);</span>

	<span class="n">__storm_memset_struct</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="n">tcfg</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">bnx2x_func_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bnx2x_func_init_params</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">CHIP_IS_E1x</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">tstorm_eth_function_common_config</span> <span class="n">tcfg</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>

		<span class="n">storm_memset_func_cfg</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tcfg</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">func_id</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Enable the function in the FW */</span>
	<span class="n">storm_memset_vf_to_pf</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">func_id</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">pf_id</span><span class="p">);</span>
	<span class="n">storm_memset_func_en</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">func_id</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* spq */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">func_flgs</span> <span class="o">&amp;</span> <span class="n">FUNC_FLG_SPQ</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">storm_memset_spq_addr</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">spq_map</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">func_id</span><span class="p">);</span>
		<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">XSEM_REG_FAST_MEMORY</span> <span class="o">+</span>
		       <span class="n">XSTORM_SPQ_PROD_OFFSET</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">func_id</span><span class="p">),</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">spq_prod</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * bnx2x_get_tx_only_flags - Return common flags</span>
<span class="cm"> *</span>
<span class="cm"> * @bp		device handle</span>
<span class="cm"> * @fp		queue handle</span>
<span class="cm"> * @zero_stats	TRUE if statistics zeroing is needed</span>
<span class="cm"> *</span>
<span class="cm"> * Return the flags that are common for the Tx-only and not normal connections.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="nf">bnx2x_get_common_flags</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">,</span>
					    <span class="k">struct</span> <span class="n">bnx2x_fastpath</span> <span class="o">*</span><span class="n">fp</span><span class="p">,</span>
					    <span class="n">bool</span> <span class="n">zero_stats</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* PF driver will always initialize the Queue to an ACTIVE state */</span>
	<span class="n">__set_bit</span><span class="p">(</span><span class="n">BNX2X_Q_FLG_ACTIVE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* tx only connections collect statistics (on the same index as the</span>
<span class="cm">	 *  parent connection). The statistics are zeroed when the parent</span>
<span class="cm">	 *  connection is initialized.</span>
<span class="cm">	 */</span>

	<span class="n">__set_bit</span><span class="p">(</span><span class="n">BNX2X_Q_FLG_STATS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">zero_stats</span><span class="p">)</span>
		<span class="n">__set_bit</span><span class="p">(</span><span class="n">BNX2X_Q_FLG_ZERO_STATS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">flags</span><span class="p">);</span>


	<span class="k">return</span> <span class="n">flags</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="nf">bnx2x_get_q_flags</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">bnx2x_fastpath</span> <span class="o">*</span><span class="n">fp</span><span class="p">,</span>
				       <span class="n">bool</span> <span class="n">leading</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* calculate other queue flags */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_MF_SD</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span>
		<span class="n">__set_bit</span><span class="p">(</span><span class="n">BNX2X_Q_FLG_OV</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_FCOE_FP</span><span class="p">(</span><span class="n">fp</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">__set_bit</span><span class="p">(</span><span class="n">BNX2X_Q_FLG_FCOE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">flags</span><span class="p">);</span>
		<span class="cm">/* For FCoE - force usage of default priority (for afex) */</span>
		<span class="n">__set_bit</span><span class="p">(</span><span class="n">BNX2X_Q_FLG_FORCE_DEFAULT_PRI</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">disable_tpa</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">__set_bit</span><span class="p">(</span><span class="n">BNX2X_Q_FLG_TPA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">__set_bit</span><span class="p">(</span><span class="n">BNX2X_Q_FLG_TPA_IPV6</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">==</span> <span class="n">TPA_MODE_GRO</span><span class="p">)</span>
			<span class="n">__set_bit</span><span class="p">(</span><span class="n">BNX2X_Q_FLG_TPA_GRO</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">leading</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">__set_bit</span><span class="p">(</span><span class="n">BNX2X_Q_FLG_LEADING_RSS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">__set_bit</span><span class="p">(</span><span class="n">BNX2X_Q_FLG_MCAST</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Always set HW VLAN stripping */</span>
	<span class="n">__set_bit</span><span class="p">(</span><span class="n">BNX2X_Q_FLG_VLAN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* configure silent vlan removal */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_MF_AFEX</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span>
		<span class="n">__set_bit</span><span class="p">(</span><span class="n">BNX2X_Q_FLG_SILENT_VLAN_REM</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">flags</span><span class="p">);</span>


	<span class="k">return</span> <span class="n">flags</span> <span class="o">|</span> <span class="n">bnx2x_get_common_flags</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">fp</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_pf_q_prep_general</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">bnx2x_fastpath</span> <span class="o">*</span><span class="n">fp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bnx2x_general_setup_params</span> <span class="o">*</span><span class="n">gen_init</span><span class="p">,</span>
	<span class="n">u8</span> <span class="n">cos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">gen_init</span><span class="o">-&gt;</span><span class="n">stat_id</span> <span class="o">=</span> <span class="n">bnx2x_stats_id</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
	<span class="n">gen_init</span><span class="o">-&gt;</span><span class="n">spcl_id</span> <span class="o">=</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">cl_id</span><span class="p">;</span>

	<span class="cm">/* Always use mini-jumbo MTU for FCoE L2 ring */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_FCOE_FP</span><span class="p">(</span><span class="n">fp</span><span class="p">))</span>
		<span class="n">gen_init</span><span class="o">-&gt;</span><span class="n">mtu</span> <span class="o">=</span> <span class="n">BNX2X_FCOE_MINI_JUMBO_MTU</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">gen_init</span><span class="o">-&gt;</span><span class="n">mtu</span> <span class="o">=</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mtu</span><span class="p">;</span>

	<span class="n">gen_init</span><span class="o">-&gt;</span><span class="n">cos</span> <span class="o">=</span> <span class="n">cos</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_pf_rx_q_prep</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">bnx2x_fastpath</span> <span class="o">*</span><span class="n">fp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rxq_pause_params</span> <span class="o">*</span><span class="n">pause</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">bnx2x_rxq_setup_params</span> <span class="o">*</span><span class="n">rxq_init</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">max_sge</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">sge_sz</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">tpa_agg_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">disable_tpa</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pause</span><span class="o">-&gt;</span><span class="n">sge_th_lo</span> <span class="o">=</span> <span class="n">SGE_TH_LO</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
		<span class="n">pause</span><span class="o">-&gt;</span><span class="n">sge_th_hi</span> <span class="o">=</span> <span class="n">SGE_TH_HI</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>

		<span class="cm">/* validate SGE ring has enough to cross high threshold */</span>
		<span class="n">WARN_ON</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">dropless_fc</span> <span class="o">&amp;&amp;</span>
				<span class="n">pause</span><span class="o">-&gt;</span><span class="n">sge_th_hi</span> <span class="o">+</span> <span class="n">FW_PREFETCH_CNT</span> <span class="o">&gt;</span>
				<span class="n">MAX_RX_SGE_CNT</span> <span class="o">*</span> <span class="n">NUM_RX_SGE_PAGES</span><span class="p">);</span>

		<span class="n">tpa_agg_size</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="n">u32</span><span class="p">,</span>
			<span class="p">(</span><span class="n">min_t</span><span class="p">(</span><span class="n">u32</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="n">MAX_SKB_FRAGS</span><span class="p">)</span> <span class="o">*</span>
			<span class="n">SGE_PAGE_SIZE</span> <span class="o">*</span> <span class="n">PAGES_PER_SGE</span><span class="p">),</span> <span class="mh">0xffff</span><span class="p">);</span>
		<span class="n">max_sge</span> <span class="o">=</span> <span class="n">SGE_PAGE_ALIGN</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mtu</span><span class="p">)</span> <span class="o">&gt;&gt;</span>
			<span class="n">SGE_PAGE_SHIFT</span><span class="p">;</span>
		<span class="n">max_sge</span> <span class="o">=</span> <span class="p">((</span><span class="n">max_sge</span> <span class="o">+</span> <span class="n">PAGES_PER_SGE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span>
			  <span class="p">(</span><span class="o">~</span><span class="p">(</span><span class="n">PAGES_PER_SGE</span><span class="o">-</span><span class="mi">1</span><span class="p">)))</span> <span class="o">&gt;&gt;</span> <span class="n">PAGES_PER_SGE_SHIFT</span><span class="p">;</span>
		<span class="n">sge_sz</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span><span class="n">min_t</span><span class="p">(</span><span class="n">u32</span><span class="p">,</span> <span class="n">SGE_PAGE_SIZE</span> <span class="o">*</span> <span class="n">PAGES_PER_SGE</span><span class="p">,</span>
				    <span class="mh">0xffff</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* pause - not for e1 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CHIP_IS_E1</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pause</span><span class="o">-&gt;</span><span class="n">bd_th_lo</span> <span class="o">=</span> <span class="n">BD_TH_LO</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
		<span class="n">pause</span><span class="o">-&gt;</span><span class="n">bd_th_hi</span> <span class="o">=</span> <span class="n">BD_TH_HI</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>

		<span class="n">pause</span><span class="o">-&gt;</span><span class="n">rcq_th_lo</span> <span class="o">=</span> <span class="n">RCQ_TH_LO</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
		<span class="n">pause</span><span class="o">-&gt;</span><span class="n">rcq_th_hi</span> <span class="o">=</span> <span class="n">RCQ_TH_HI</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
		<span class="cm">/*</span>
<span class="cm">		 * validate that rings have enough entries to cross</span>
<span class="cm">		 * high thresholds</span>
<span class="cm">		 */</span>
		<span class="n">WARN_ON</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">dropless_fc</span> <span class="o">&amp;&amp;</span>
				<span class="n">pause</span><span class="o">-&gt;</span><span class="n">bd_th_hi</span> <span class="o">+</span> <span class="n">FW_PREFETCH_CNT</span> <span class="o">&gt;</span>
				<span class="n">bp</span><span class="o">-&gt;</span><span class="n">rx_ring_size</span><span class="p">);</span>
		<span class="n">WARN_ON</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">dropless_fc</span> <span class="o">&amp;&amp;</span>
				<span class="n">pause</span><span class="o">-&gt;</span><span class="n">rcq_th_hi</span> <span class="o">+</span> <span class="n">FW_PREFETCH_CNT</span> <span class="o">&gt;</span>
				<span class="n">NUM_RCQ_RINGS</span> <span class="o">*</span> <span class="n">MAX_RCQ_DESC_CNT</span><span class="p">);</span>

		<span class="n">pause</span><span class="o">-&gt;</span><span class="n">pri_map</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* rxq setup */</span>
	<span class="n">rxq_init</span><span class="o">-&gt;</span><span class="n">dscr_map</span> <span class="o">=</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">rx_desc_mapping</span><span class="p">;</span>
	<span class="n">rxq_init</span><span class="o">-&gt;</span><span class="n">sge_map</span> <span class="o">=</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">rx_sge_mapping</span><span class="p">;</span>
	<span class="n">rxq_init</span><span class="o">-&gt;</span><span class="n">rcq_map</span> <span class="o">=</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">rx_comp_mapping</span><span class="p">;</span>
	<span class="n">rxq_init</span><span class="o">-&gt;</span><span class="n">rcq_np_map</span> <span class="o">=</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">rx_comp_mapping</span> <span class="o">+</span> <span class="n">BCM_PAGE_SIZE</span><span class="p">;</span>

	<span class="cm">/* This should be a maximum number of data bytes that may be</span>
<span class="cm">	 * placed on the BD (not including paddings).</span>
<span class="cm">	 */</span>
	<span class="n">rxq_init</span><span class="o">-&gt;</span><span class="n">buf_sz</span> <span class="o">=</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">rx_buf_size</span> <span class="o">-</span> <span class="n">BNX2X_FW_RX_ALIGN_START</span> <span class="o">-</span>
		<span class="n">BNX2X_FW_RX_ALIGN_END</span> <span class="o">-</span>	<span class="n">IP_HEADER_ALIGNMENT_PADDING</span><span class="p">;</span>

	<span class="n">rxq_init</span><span class="o">-&gt;</span><span class="n">cl_qzone_id</span> <span class="o">=</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">cl_qzone_id</span><span class="p">;</span>
	<span class="n">rxq_init</span><span class="o">-&gt;</span><span class="n">tpa_agg_sz</span> <span class="o">=</span> <span class="n">tpa_agg_size</span><span class="p">;</span>
	<span class="n">rxq_init</span><span class="o">-&gt;</span><span class="n">sge_buf_sz</span> <span class="o">=</span> <span class="n">sge_sz</span><span class="p">;</span>
	<span class="n">rxq_init</span><span class="o">-&gt;</span><span class="n">max_sges_pkt</span> <span class="o">=</span> <span class="n">max_sge</span><span class="p">;</span>
	<span class="n">rxq_init</span><span class="o">-&gt;</span><span class="n">rss_engine_id</span> <span class="o">=</span> <span class="n">BP_FUNC</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
	<span class="n">rxq_init</span><span class="o">-&gt;</span><span class="n">mcast_engine_id</span> <span class="o">=</span> <span class="n">BP_FUNC</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>

	<span class="cm">/* Maximum number or simultaneous TPA aggregation for this Queue.</span>
<span class="cm">	 *</span>
<span class="cm">	 * For PF Clients it should be the maximum avaliable number.</span>
<span class="cm">	 * VF driver(s) may want to define it to a smaller value.</span>
<span class="cm">	 */</span>
	<span class="n">rxq_init</span><span class="o">-&gt;</span><span class="n">max_tpa_queues</span> <span class="o">=</span> <span class="n">MAX_AGG_QS</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>

	<span class="n">rxq_init</span><span class="o">-&gt;</span><span class="n">cache_line_log</span> <span class="o">=</span> <span class="n">BNX2X_RX_ALIGN_SHIFT</span><span class="p">;</span>
	<span class="n">rxq_init</span><span class="o">-&gt;</span><span class="n">fw_sb_id</span> <span class="o">=</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">fw_sb_id</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_FCOE_FP</span><span class="p">(</span><span class="n">fp</span><span class="p">))</span>
		<span class="n">rxq_init</span><span class="o">-&gt;</span><span class="n">sb_cq_index</span> <span class="o">=</span> <span class="n">HC_SP_INDEX_ETH_FCOE_RX_CQ_CONS</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">rxq_init</span><span class="o">-&gt;</span><span class="n">sb_cq_index</span> <span class="o">=</span> <span class="n">HC_INDEX_ETH_RX_CQ_CONS</span><span class="p">;</span>
	<span class="cm">/* configure silent vlan removal</span>
<span class="cm">	 * if multi function mode is afex, then mask default vlan</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_MF_AFEX</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rxq_init</span><span class="o">-&gt;</span><span class="n">silent_removal_value</span> <span class="o">=</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">afex_def_vlan_tag</span><span class="p">;</span>
		<span class="n">rxq_init</span><span class="o">-&gt;</span><span class="n">silent_removal_mask</span> <span class="o">=</span> <span class="n">VLAN_VID_MASK</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_pf_tx_q_prep</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">bnx2x_fastpath</span> <span class="o">*</span><span class="n">fp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bnx2x_txq_setup_params</span> <span class="o">*</span><span class="n">txq_init</span><span class="p">,</span>
	<span class="n">u8</span> <span class="n">cos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">txq_init</span><span class="o">-&gt;</span><span class="n">dscr_map</span> <span class="o">=</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">txdata</span><span class="p">[</span><span class="n">cos</span><span class="p">].</span><span class="n">tx_desc_mapping</span><span class="p">;</span>
	<span class="n">txq_init</span><span class="o">-&gt;</span><span class="n">sb_cq_index</span> <span class="o">=</span> <span class="n">HC_INDEX_ETH_FIRST_TX_CQ_CONS</span> <span class="o">+</span> <span class="n">cos</span><span class="p">;</span>
	<span class="n">txq_init</span><span class="o">-&gt;</span><span class="n">traffic_type</span> <span class="o">=</span> <span class="n">LLFC_TRAFFIC_TYPE_NW</span><span class="p">;</span>
	<span class="n">txq_init</span><span class="o">-&gt;</span><span class="n">fw_sb_id</span> <span class="o">=</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">fw_sb_id</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * set the tss leading client id for TX classfication ==</span>
<span class="cm">	 * leading RSS client id</span>
<span class="cm">	 */</span>
	<span class="n">txq_init</span><span class="o">-&gt;</span><span class="n">tss_leading_cl_id</span> <span class="o">=</span> <span class="n">bnx2x_fp</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">cl_id</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_FCOE_FP</span><span class="p">(</span><span class="n">fp</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">txq_init</span><span class="o">-&gt;</span><span class="n">sb_cq_index</span> <span class="o">=</span> <span class="n">HC_SP_INDEX_ETH_FCOE_TX_CQ_CONS</span><span class="p">;</span>
		<span class="n">txq_init</span><span class="o">-&gt;</span><span class="n">traffic_type</span> <span class="o">=</span> <span class="n">LLFC_TRAFFIC_TYPE_FCOE</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_pf_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2x_func_init_params</span> <span class="n">func_init</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
	<span class="k">struct</span> <span class="n">event_ring_data</span> <span class="n">eq_data</span> <span class="o">=</span> <span class="p">{</span> <span class="p">{</span><span class="mi">0</span><span class="p">}</span> <span class="p">};</span>
	<span class="n">u16</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CHIP_IS_E1x</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* reset IGU PF statistics: MSIX + ATTN */</span>
		<span class="cm">/* PF */</span>
		<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">IGU_REG_STATISTIC_NUM_MESSAGE_SENT</span> <span class="o">+</span>
			   <span class="n">BNX2X_IGU_STAS_MSG_VF_CNT</span><span class="o">*</span><span class="mi">4</span> <span class="o">+</span>
			   <span class="p">(</span><span class="n">CHIP_MODE_IS_4_PORT</span><span class="p">(</span><span class="n">bp</span><span class="p">)</span> <span class="o">?</span>
				<span class="n">BP_FUNC</span><span class="p">(</span><span class="n">bp</span><span class="p">)</span> <span class="o">:</span> <span class="n">BP_VN</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span><span class="o">*</span><span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="cm">/* ATTN */</span>
		<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">IGU_REG_STATISTIC_NUM_MESSAGE_SENT</span> <span class="o">+</span>
			   <span class="n">BNX2X_IGU_STAS_MSG_VF_CNT</span><span class="o">*</span><span class="mi">4</span> <span class="o">+</span>
			   <span class="n">BNX2X_IGU_STAS_MSG_PF_CNT</span><span class="o">*</span><span class="mi">4</span> <span class="o">+</span>
			   <span class="p">(</span><span class="n">CHIP_MODE_IS_4_PORT</span><span class="p">(</span><span class="n">bp</span><span class="p">)</span> <span class="o">?</span>
				<span class="n">BP_FUNC</span><span class="p">(</span><span class="n">bp</span><span class="p">)</span> <span class="o">:</span> <span class="n">BP_VN</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span><span class="o">*</span><span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* function setup flags */</span>
	<span class="n">flags</span> <span class="o">=</span> <span class="p">(</span><span class="n">FUNC_FLG_STATS</span> <span class="o">|</span> <span class="n">FUNC_FLG_LEADING</span> <span class="o">|</span> <span class="n">FUNC_FLG_SPQ</span><span class="p">);</span>

	<span class="cm">/* This flag is relevant for E1x only.</span>
<span class="cm">	 * E2 doesn&#39;t have a TPA configuration in a function level.</span>
<span class="cm">	 */</span>
	<span class="n">flags</span> <span class="o">|=</span> <span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">TPA_ENABLE_FLAG</span><span class="p">)</span> <span class="o">?</span> <span class="n">FUNC_FLG_TPA</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">func_init</span><span class="p">.</span><span class="n">func_flgs</span> <span class="o">=</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">func_init</span><span class="p">.</span><span class="n">pf_id</span> <span class="o">=</span> <span class="n">BP_FUNC</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
	<span class="n">func_init</span><span class="p">.</span><span class="n">func_id</span> <span class="o">=</span> <span class="n">BP_FUNC</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
	<span class="n">func_init</span><span class="p">.</span><span class="n">spq_map</span> <span class="o">=</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">spq_mapping</span><span class="p">;</span>
	<span class="n">func_init</span><span class="p">.</span><span class="n">spq_prod</span> <span class="o">=</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">spq_prod_idx</span><span class="p">;</span>

	<span class="n">bnx2x_func_init</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">func_init</span><span class="p">);</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">cmng</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">cmng_struct_per_port</span><span class="p">));</span>

	<span class="cm">/*</span>
<span class="cm">	 * Congestion management values depend on the link rate</span>
<span class="cm">	 * There is no active link so initial link rate is set to 10 Gbps.</span>
<span class="cm">	 * When the link comes up The congestion management values are</span>
<span class="cm">	 * re-calculated according to the actual link rate.</span>
<span class="cm">	 */</span>
	<span class="n">bp</span><span class="o">-&gt;</span><span class="n">link_vars</span><span class="p">.</span><span class="n">line_speed</span> <span class="o">=</span> <span class="n">SPEED_10000</span><span class="p">;</span>
	<span class="n">bnx2x_cmng_fns_init</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span> <span class="n">bnx2x_get_cmng_fns_mode</span><span class="p">(</span><span class="n">bp</span><span class="p">));</span>

	<span class="cm">/* Only the PMF sets the HW */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">pmf</span><span class="p">)</span>
		<span class="n">storm_memset_cmng</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">cmng</span><span class="p">,</span> <span class="n">BP_PORT</span><span class="p">(</span><span class="n">bp</span><span class="p">));</span>

	<span class="cm">/* init Event Queue */</span>
	<span class="n">eq_data</span><span class="p">.</span><span class="n">base_addr</span><span class="p">.</span><span class="n">hi</span> <span class="o">=</span> <span class="n">U64_HI</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">eq_mapping</span><span class="p">);</span>
	<span class="n">eq_data</span><span class="p">.</span><span class="n">base_addr</span><span class="p">.</span><span class="n">lo</span> <span class="o">=</span> <span class="n">U64_LO</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">eq_mapping</span><span class="p">);</span>
	<span class="n">eq_data</span><span class="p">.</span><span class="n">producer</span> <span class="o">=</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">eq_prod</span><span class="p">;</span>
	<span class="n">eq_data</span><span class="p">.</span><span class="n">index_id</span> <span class="o">=</span> <span class="n">HC_SP_INDEX_EQ_CONS</span><span class="p">;</span>
	<span class="n">eq_data</span><span class="p">.</span><span class="n">sb_id</span> <span class="o">=</span> <span class="n">DEF_SB_ID</span><span class="p">;</span>
	<span class="n">storm_memset_eq_data</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">eq_data</span><span class="p">,</span> <span class="n">BP_FUNC</span><span class="p">(</span><span class="n">bp</span><span class="p">));</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_e1h_disable</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">port</span> <span class="o">=</span> <span class="n">BP_PORT</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>

	<span class="n">bnx2x_tx_disable</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>

	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">NIG_REG_LLH0_FUNC_EN</span> <span class="o">+</span> <span class="n">port</span><span class="o">*</span><span class="mi">8</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_e1h_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">port</span> <span class="o">=</span> <span class="n">BP_PORT</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>

	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">NIG_REG_LLH0_FUNC_EN</span> <span class="o">+</span> <span class="n">port</span><span class="o">*</span><span class="mi">8</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* Tx queue should be only reenabled */</span>
	<span class="n">netif_tx_wake_all_queues</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Should not call netif_carrier_on since it will be called if the link</span>
<span class="cm">	 * is up when checking for link state</span>
<span class="cm">	 */</span>
<span class="p">}</span>

<span class="cp">#define DRV_INFO_ETH_STAT_NUM_MACS_REQUIRED 3</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_drv_info_ether_stat</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">eth_stats_info</span> <span class="o">*</span><span class="n">ether_stat</span> <span class="o">=</span>
		<span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">slowpath</span><span class="o">-&gt;</span><span class="n">drv_info_to_mcp</span><span class="p">.</span><span class="n">ether_stat</span><span class="p">;</span>

	<span class="cm">/* leave last char as NULL */</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">ether_stat</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">,</span> <span class="n">DRV_MODULE_VERSION</span><span class="p">,</span>
	       <span class="n">ETH_STAT_INFO_VERSION_LEN</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">bp</span><span class="o">-&gt;</span><span class="n">fp</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">mac_obj</span><span class="p">.</span><span class="n">get_n_elements</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">fp</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">mac_obj</span><span class="p">,</span>
					 <span class="n">DRV_INFO_ETH_STAT_NUM_MACS_REQUIRED</span><span class="p">,</span>
					 <span class="n">ether_stat</span><span class="o">-&gt;</span><span class="n">mac_local</span><span class="p">);</span>

	<span class="n">ether_stat</span><span class="o">-&gt;</span><span class="n">mtu_size</span> <span class="o">=</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mtu</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">NETIF_F_RXCSUM</span><span class="p">)</span>
		<span class="n">ether_stat</span><span class="o">-&gt;</span><span class="n">feature_flags</span> <span class="o">|=</span> <span class="n">FEATURE_ETH_CHKSUM_OFFLOAD_MASK</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">NETIF_F_TSO</span><span class="p">)</span>
		<span class="n">ether_stat</span><span class="o">-&gt;</span><span class="n">feature_flags</span> <span class="o">|=</span> <span class="n">FEATURE_ETH_LSO_MASK</span><span class="p">;</span>
	<span class="n">ether_stat</span><span class="o">-&gt;</span><span class="n">feature_flags</span> <span class="o">|=</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">.</span><span class="n">boot_mode</span><span class="p">;</span>

	<span class="n">ether_stat</span><span class="o">-&gt;</span><span class="n">promiscuous_mode</span> <span class="o">=</span> <span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_PROMISC</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ether_stat</span><span class="o">-&gt;</span><span class="n">txq_size</span> <span class="o">=</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">tx_ring_size</span><span class="p">;</span>
	<span class="n">ether_stat</span><span class="o">-&gt;</span><span class="n">rxq_size</span> <span class="o">=</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">rx_ring_size</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_drv_info_fcoe_stat</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef BCM_CNIC</span>
	<span class="k">struct</span> <span class="n">bnx2x_dcbx_app_params</span> <span class="o">*</span><span class="n">app</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">dcbx_port_params</span><span class="p">.</span><span class="n">app</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fcoe_stats_info</span> <span class="o">*</span><span class="n">fcoe_stat</span> <span class="o">=</span>
		<span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">slowpath</span><span class="o">-&gt;</span><span class="n">drv_info_to_mcp</span><span class="p">.</span><span class="n">fcoe_stat</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">fcoe_stat</span><span class="o">-&gt;</span><span class="n">mac_local</span><span class="p">,</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">fip_mac</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>

	<span class="n">fcoe_stat</span><span class="o">-&gt;</span><span class="n">qos_priority</span> <span class="o">=</span>
		<span class="n">app</span><span class="o">-&gt;</span><span class="n">traffic_type_priority</span><span class="p">[</span><span class="n">LLFC_TRAFFIC_TYPE_FCOE</span><span class="p">];</span>

	<span class="cm">/* insert FCoE stats from ramrod response */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">NO_FCOE</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">tstorm_per_queue_stats</span> <span class="o">*</span><span class="n">fcoe_q_tstorm_stats</span> <span class="o">=</span>
			<span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">fw_stats_data</span><span class="o">-&gt;</span><span class="n">queue_stats</span><span class="p">[</span><span class="n">FCOE_IDX</span><span class="p">].</span>
			<span class="n">tstorm_queue_statistics</span><span class="p">;</span>

		<span class="k">struct</span> <span class="n">xstorm_per_queue_stats</span> <span class="o">*</span><span class="n">fcoe_q_xstorm_stats</span> <span class="o">=</span>
			<span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">fw_stats_data</span><span class="o">-&gt;</span><span class="n">queue_stats</span><span class="p">[</span><span class="n">FCOE_IDX</span><span class="p">].</span>
			<span class="n">xstorm_queue_statistics</span><span class="p">;</span>

		<span class="k">struct</span> <span class="n">fcoe_statistics_params</span> <span class="o">*</span><span class="n">fw_fcoe_stat</span> <span class="o">=</span>
			<span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">fw_stats_data</span><span class="o">-&gt;</span><span class="n">fcoe</span><span class="p">;</span>

		<span class="n">ADD_64</span><span class="p">(</span><span class="n">fcoe_stat</span><span class="o">-&gt;</span><span class="n">rx_bytes_hi</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">fcoe_stat</span><span class="o">-&gt;</span><span class="n">rx_bytes_lo</span><span class="p">,</span>
		       <span class="n">fw_fcoe_stat</span><span class="o">-&gt;</span><span class="n">rx_stat0</span><span class="p">.</span><span class="n">fcoe_rx_byte_cnt</span><span class="p">);</span>

		<span class="n">ADD_64</span><span class="p">(</span><span class="n">fcoe_stat</span><span class="o">-&gt;</span><span class="n">rx_bytes_hi</span><span class="p">,</span>
		       <span class="n">fcoe_q_tstorm_stats</span><span class="o">-&gt;</span><span class="n">rcv_ucast_bytes</span><span class="p">.</span><span class="n">hi</span><span class="p">,</span>
		       <span class="n">fcoe_stat</span><span class="o">-&gt;</span><span class="n">rx_bytes_lo</span><span class="p">,</span>
		       <span class="n">fcoe_q_tstorm_stats</span><span class="o">-&gt;</span><span class="n">rcv_ucast_bytes</span><span class="p">.</span><span class="n">lo</span><span class="p">);</span>

		<span class="n">ADD_64</span><span class="p">(</span><span class="n">fcoe_stat</span><span class="o">-&gt;</span><span class="n">rx_bytes_hi</span><span class="p">,</span>
		       <span class="n">fcoe_q_tstorm_stats</span><span class="o">-&gt;</span><span class="n">rcv_bcast_bytes</span><span class="p">.</span><span class="n">hi</span><span class="p">,</span>
		       <span class="n">fcoe_stat</span><span class="o">-&gt;</span><span class="n">rx_bytes_lo</span><span class="p">,</span>
		       <span class="n">fcoe_q_tstorm_stats</span><span class="o">-&gt;</span><span class="n">rcv_bcast_bytes</span><span class="p">.</span><span class="n">lo</span><span class="p">);</span>

		<span class="n">ADD_64</span><span class="p">(</span><span class="n">fcoe_stat</span><span class="o">-&gt;</span><span class="n">rx_bytes_hi</span><span class="p">,</span>
		       <span class="n">fcoe_q_tstorm_stats</span><span class="o">-&gt;</span><span class="n">rcv_mcast_bytes</span><span class="p">.</span><span class="n">hi</span><span class="p">,</span>
		       <span class="n">fcoe_stat</span><span class="o">-&gt;</span><span class="n">rx_bytes_lo</span><span class="p">,</span>
		       <span class="n">fcoe_q_tstorm_stats</span><span class="o">-&gt;</span><span class="n">rcv_mcast_bytes</span><span class="p">.</span><span class="n">lo</span><span class="p">);</span>

		<span class="n">ADD_64</span><span class="p">(</span><span class="n">fcoe_stat</span><span class="o">-&gt;</span><span class="n">rx_frames_hi</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">fcoe_stat</span><span class="o">-&gt;</span><span class="n">rx_frames_lo</span><span class="p">,</span>
		       <span class="n">fw_fcoe_stat</span><span class="o">-&gt;</span><span class="n">rx_stat0</span><span class="p">.</span><span class="n">fcoe_rx_pkt_cnt</span><span class="p">);</span>

		<span class="n">ADD_64</span><span class="p">(</span><span class="n">fcoe_stat</span><span class="o">-&gt;</span><span class="n">rx_frames_hi</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">fcoe_stat</span><span class="o">-&gt;</span><span class="n">rx_frames_lo</span><span class="p">,</span>
		       <span class="n">fcoe_q_tstorm_stats</span><span class="o">-&gt;</span><span class="n">rcv_ucast_pkts</span><span class="p">);</span>

		<span class="n">ADD_64</span><span class="p">(</span><span class="n">fcoe_stat</span><span class="o">-&gt;</span><span class="n">rx_frames_hi</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">fcoe_stat</span><span class="o">-&gt;</span><span class="n">rx_frames_lo</span><span class="p">,</span>
		       <span class="n">fcoe_q_tstorm_stats</span><span class="o">-&gt;</span><span class="n">rcv_bcast_pkts</span><span class="p">);</span>

		<span class="n">ADD_64</span><span class="p">(</span><span class="n">fcoe_stat</span><span class="o">-&gt;</span><span class="n">rx_frames_hi</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">fcoe_stat</span><span class="o">-&gt;</span><span class="n">rx_frames_lo</span><span class="p">,</span>
		       <span class="n">fcoe_q_tstorm_stats</span><span class="o">-&gt;</span><span class="n">rcv_mcast_pkts</span><span class="p">);</span>

		<span class="n">ADD_64</span><span class="p">(</span><span class="n">fcoe_stat</span><span class="o">-&gt;</span><span class="n">tx_bytes_hi</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">fcoe_stat</span><span class="o">-&gt;</span><span class="n">tx_bytes_lo</span><span class="p">,</span>
		       <span class="n">fw_fcoe_stat</span><span class="o">-&gt;</span><span class="n">tx_stat</span><span class="p">.</span><span class="n">fcoe_tx_byte_cnt</span><span class="p">);</span>

		<span class="n">ADD_64</span><span class="p">(</span><span class="n">fcoe_stat</span><span class="o">-&gt;</span><span class="n">tx_bytes_hi</span><span class="p">,</span>
		       <span class="n">fcoe_q_xstorm_stats</span><span class="o">-&gt;</span><span class="n">ucast_bytes_sent</span><span class="p">.</span><span class="n">hi</span><span class="p">,</span>
		       <span class="n">fcoe_stat</span><span class="o">-&gt;</span><span class="n">tx_bytes_lo</span><span class="p">,</span>
		       <span class="n">fcoe_q_xstorm_stats</span><span class="o">-&gt;</span><span class="n">ucast_bytes_sent</span><span class="p">.</span><span class="n">lo</span><span class="p">);</span>

		<span class="n">ADD_64</span><span class="p">(</span><span class="n">fcoe_stat</span><span class="o">-&gt;</span><span class="n">tx_bytes_hi</span><span class="p">,</span>
		       <span class="n">fcoe_q_xstorm_stats</span><span class="o">-&gt;</span><span class="n">bcast_bytes_sent</span><span class="p">.</span><span class="n">hi</span><span class="p">,</span>
		       <span class="n">fcoe_stat</span><span class="o">-&gt;</span><span class="n">tx_bytes_lo</span><span class="p">,</span>
		       <span class="n">fcoe_q_xstorm_stats</span><span class="o">-&gt;</span><span class="n">bcast_bytes_sent</span><span class="p">.</span><span class="n">lo</span><span class="p">);</span>

		<span class="n">ADD_64</span><span class="p">(</span><span class="n">fcoe_stat</span><span class="o">-&gt;</span><span class="n">tx_bytes_hi</span><span class="p">,</span>
		       <span class="n">fcoe_q_xstorm_stats</span><span class="o">-&gt;</span><span class="n">mcast_bytes_sent</span><span class="p">.</span><span class="n">hi</span><span class="p">,</span>
		       <span class="n">fcoe_stat</span><span class="o">-&gt;</span><span class="n">tx_bytes_lo</span><span class="p">,</span>
		       <span class="n">fcoe_q_xstorm_stats</span><span class="o">-&gt;</span><span class="n">mcast_bytes_sent</span><span class="p">.</span><span class="n">lo</span><span class="p">);</span>

		<span class="n">ADD_64</span><span class="p">(</span><span class="n">fcoe_stat</span><span class="o">-&gt;</span><span class="n">tx_frames_hi</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">fcoe_stat</span><span class="o">-&gt;</span><span class="n">tx_frames_lo</span><span class="p">,</span>
		       <span class="n">fw_fcoe_stat</span><span class="o">-&gt;</span><span class="n">tx_stat</span><span class="p">.</span><span class="n">fcoe_tx_pkt_cnt</span><span class="p">);</span>

		<span class="n">ADD_64</span><span class="p">(</span><span class="n">fcoe_stat</span><span class="o">-&gt;</span><span class="n">tx_frames_hi</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">fcoe_stat</span><span class="o">-&gt;</span><span class="n">tx_frames_lo</span><span class="p">,</span>
		       <span class="n">fcoe_q_xstorm_stats</span><span class="o">-&gt;</span><span class="n">ucast_pkts_sent</span><span class="p">);</span>

		<span class="n">ADD_64</span><span class="p">(</span><span class="n">fcoe_stat</span><span class="o">-&gt;</span><span class="n">tx_frames_hi</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">fcoe_stat</span><span class="o">-&gt;</span><span class="n">tx_frames_lo</span><span class="p">,</span>
		       <span class="n">fcoe_q_xstorm_stats</span><span class="o">-&gt;</span><span class="n">bcast_pkts_sent</span><span class="p">);</span>

		<span class="n">ADD_64</span><span class="p">(</span><span class="n">fcoe_stat</span><span class="o">-&gt;</span><span class="n">tx_frames_hi</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">fcoe_stat</span><span class="o">-&gt;</span><span class="n">tx_frames_lo</span><span class="p">,</span>
		       <span class="n">fcoe_q_xstorm_stats</span><span class="o">-&gt;</span><span class="n">mcast_pkts_sent</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* ask L5 driver to add data to the struct */</span>
	<span class="n">bnx2x_cnic_notify</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">CNIC_CTL_FCOE_STATS_GET_CMD</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_drv_info_iscsi_stat</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef BCM_CNIC</span>
	<span class="k">struct</span> <span class="n">bnx2x_dcbx_app_params</span> <span class="o">*</span><span class="n">app</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">dcbx_port_params</span><span class="p">.</span><span class="n">app</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iscsi_stats_info</span> <span class="o">*</span><span class="n">iscsi_stat</span> <span class="o">=</span>
		<span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">slowpath</span><span class="o">-&gt;</span><span class="n">drv_info_to_mcp</span><span class="p">.</span><span class="n">iscsi_stat</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">iscsi_stat</span><span class="o">-&gt;</span><span class="n">mac_local</span><span class="p">,</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">cnic_eth_dev</span><span class="p">.</span><span class="n">iscsi_mac</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>

	<span class="n">iscsi_stat</span><span class="o">-&gt;</span><span class="n">qos_priority</span> <span class="o">=</span>
		<span class="n">app</span><span class="o">-&gt;</span><span class="n">traffic_type_priority</span><span class="p">[</span><span class="n">LLFC_TRAFFIC_TYPE_ISCSI</span><span class="p">];</span>

	<span class="cm">/* ask L5 driver to add data to the struct */</span>
	<span class="n">bnx2x_cnic_notify</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">CNIC_CTL_ISCSI_STATS_GET_CMD</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="cm">/* called due to MCP event (on pmf):</span>
<span class="cm"> *	reread new bandwidth configuration</span>
<span class="cm"> *	configure FW</span>
<span class="cm"> *	notify others function about the change</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_config_mf_bw</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">link_vars</span><span class="p">.</span><span class="n">link_up</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bnx2x_cmng_fns_init</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span> <span class="n">CMNG_FNS_MINMAX</span><span class="p">);</span>
		<span class="n">bnx2x_link_sync_notify</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">storm_memset_cmng</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">cmng</span><span class="p">,</span> <span class="n">BP_PORT</span><span class="p">(</span><span class="n">bp</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_set_mf_bw</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bnx2x_config_mf_bw</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
	<span class="n">bnx2x_fw_command</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">DRV_MSG_CODE_SET_MF_BW_ACK</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_handle_drv_info_req</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">enum</span> <span class="n">drv_info_opcode</span> <span class="n">op_code</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">drv_info_ctl</span> <span class="o">=</span> <span class="n">SHMEM2_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">drv_info_control</span><span class="p">);</span>

	<span class="cm">/* if drv_info version supported by MFW doesn&#39;t match - send NACK */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">drv_info_ctl</span> <span class="o">&amp;</span> <span class="n">DRV_INFO_CONTROL_VER_MASK</span><span class="p">)</span> <span class="o">!=</span> <span class="n">DRV_INFO_CUR_VER</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bnx2x_fw_command</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">DRV_MSG_CODE_DRV_INFO_NACK</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">op_code</span> <span class="o">=</span> <span class="p">(</span><span class="n">drv_info_ctl</span> <span class="o">&amp;</span> <span class="n">DRV_INFO_CONTROL_OP_CODE_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span>
		  <span class="n">DRV_INFO_CONTROL_OP_CODE_SHIFT</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">slowpath</span><span class="o">-&gt;</span><span class="n">drv_info_to_mcp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
	       <span class="k">sizeof</span><span class="p">(</span><span class="k">union</span> <span class="n">drv_info_to_mcp</span><span class="p">));</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">op_code</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ETH_STATS_OPCODE</span>:
		<span class="n">bnx2x_drv_info_ether_stat</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FCOE_STATS_OPCODE</span>:
		<span class="n">bnx2x_drv_info_fcoe_stat</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ISCSI_STATS_OPCODE</span>:
		<span class="n">bnx2x_drv_info_iscsi_stat</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="cm">/* if op code isn&#39;t supported - send NACK */</span>
		<span class="n">bnx2x_fw_command</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">DRV_MSG_CODE_DRV_INFO_NACK</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* if we got drv_info attn from MFW then these fields are defined in</span>
<span class="cm">	 * shmem2 for sure</span>
<span class="cm">	 */</span>
	<span class="n">SHMEM2_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">drv_info_host_addr_lo</span><span class="p">,</span>
		<span class="n">U64_LO</span><span class="p">(</span><span class="n">bnx2x_sp_mapping</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">drv_info_to_mcp</span><span class="p">)));</span>
	<span class="n">SHMEM2_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">drv_info_host_addr_hi</span><span class="p">,</span>
		<span class="n">U64_HI</span><span class="p">(</span><span class="n">bnx2x_sp_mapping</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">drv_info_to_mcp</span><span class="p">)));</span>

	<span class="n">bnx2x_fw_command</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">DRV_MSG_CODE_DRV_INFO_ACK</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_dcc_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">,</span> <span class="n">u32</span> <span class="n">dcc_event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DP</span><span class="p">(</span><span class="n">BNX2X_MSG_MCP</span><span class="p">,</span> <span class="s">&quot;dcc_event 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dcc_event</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dcc_event</span> <span class="o">&amp;</span> <span class="n">DRV_STATUS_DCC_DISABLE_ENABLE_PF</span><span class="p">)</span> <span class="p">{</span>

		<span class="cm">/*</span>
<span class="cm">		 * This is the only place besides the function initialization</span>
<span class="cm">		 * where the bp-&gt;flags can change so it is done without any</span>
<span class="cm">		 * locks</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">mf_config</span><span class="p">[</span><span class="n">BP_VN</span><span class="p">(</span><span class="n">bp</span><span class="p">)]</span> <span class="o">&amp;</span> <span class="n">FUNC_MF_CFG_FUNC_DISABLED</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DP</span><span class="p">(</span><span class="n">BNX2X_MSG_MCP</span><span class="p">,</span> <span class="s">&quot;mf_cfg function disabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">bp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">MF_FUNC_DIS</span><span class="p">;</span>

			<span class="n">bnx2x_e1h_disable</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">DP</span><span class="p">(</span><span class="n">BNX2X_MSG_MCP</span><span class="p">,</span> <span class="s">&quot;mf_cfg function enabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">bp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MF_FUNC_DIS</span><span class="p">;</span>

			<span class="n">bnx2x_e1h_enable</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">dcc_event</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">DRV_STATUS_DCC_DISABLE_ENABLE_PF</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dcc_event</span> <span class="o">&amp;</span> <span class="n">DRV_STATUS_DCC_BANDWIDTH_ALLOCATION</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bnx2x_config_mf_bw</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
		<span class="n">dcc_event</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">DRV_STATUS_DCC_BANDWIDTH_ALLOCATION</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Report results to MCP */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dcc_event</span><span class="p">)</span>
		<span class="n">bnx2x_fw_command</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">DRV_MSG_CODE_DCC_FAILURE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">bnx2x_fw_command</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">DRV_MSG_CODE_DCC_OK</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* must be called under the spq lock */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">eth_spe</span> <span class="o">*</span><span class="nf">bnx2x_sp_get_next</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">eth_spe</span> <span class="o">*</span><span class="n">next_spe</span> <span class="o">=</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">spq_prod_bd</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">spq_prod_bd</span> <span class="o">==</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">spq_last_bd</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bp</span><span class="o">-&gt;</span><span class="n">spq_prod_bd</span> <span class="o">=</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">spq</span><span class="p">;</span>
		<span class="n">bp</span><span class="o">-&gt;</span><span class="n">spq_prod_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">DP</span><span class="p">(</span><span class="n">BNX2X_MSG_SP</span><span class="p">,</span> <span class="s">&quot;end of spq</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">bp</span><span class="o">-&gt;</span><span class="n">spq_prod_bd</span><span class="o">++</span><span class="p">;</span>
		<span class="n">bp</span><span class="o">-&gt;</span><span class="n">spq_prod_idx</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">next_spe</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* must be called under the spq lock */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_sp_prod_update</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">func</span> <span class="o">=</span> <span class="n">BP_FUNC</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Make sure that BD data is updated before writing the producer:</span>
<span class="cm">	 * BD data is written to the memory, the producer is read from the</span>
<span class="cm">	 * memory, thus we need a full memory barrier to ensure the ordering.</span>
<span class="cm">	 */</span>
	<span class="n">mb</span><span class="p">();</span>

	<span class="n">REG_WR16</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">BAR_XSTRORM_INTMEM</span> <span class="o">+</span> <span class="n">XSTORM_SPQ_PROD_OFFSET</span><span class="p">(</span><span class="n">func</span><span class="p">),</span>
		 <span class="n">bp</span><span class="o">-&gt;</span><span class="n">spq_prod_idx</span><span class="p">);</span>
	<span class="n">mmiowb</span><span class="p">();</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * bnx2x_is_contextless_ramrod - check if the current command ends on EQ</span>
<span class="cm"> *</span>
<span class="cm"> * @cmd:	command to check</span>
<span class="cm"> * @cmd_type:	command type</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">bool</span> <span class="nf">bnx2x_is_contextless_ramrod</span><span class="p">(</span><span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cmd_type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">cmd_type</span> <span class="o">==</span> <span class="n">NONE_CONNECTION_TYPE</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">RAMROD_CMD_ID_ETH_FORWARD_SETUP</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">RAMROD_CMD_ID_ETH_CLASSIFICATION_RULES</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">RAMROD_CMD_ID_ETH_FILTER_RULES</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">RAMROD_CMD_ID_ETH_MULTICAST_RULES</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">RAMROD_CMD_ID_ETH_SET_MAC</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">RAMROD_CMD_ID_ETH_RSS_UPDATE</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * bnx2x_sp_post - place a single command on an SP ring</span>
<span class="cm"> *</span>
<span class="cm"> * @bp:		driver handle</span>
<span class="cm"> * @command:	command to place (e.g. SETUP, FILTER_RULES, etc.)</span>
<span class="cm"> * @cid:	SW CID the command is related to</span>
<span class="cm"> * @data_hi:	command private data address (high 32 bits)</span>
<span class="cm"> * @data_lo:	command private data address (low 32 bits)</span>
<span class="cm"> * @cmd_type:	command type (e.g. NONE, ETH)</span>
<span class="cm"> *</span>
<span class="cm"> * SP data is handled as if it&#39;s always an address pair, thus data fields are</span>
<span class="cm"> * not swapped to little endian in upper functions. Instead this function swaps</span>
<span class="cm"> * data as if it&#39;s two u32 fields.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">bnx2x_sp_post</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">command</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cid</span><span class="p">,</span>
		  <span class="n">u32</span> <span class="n">data_hi</span><span class="p">,</span> <span class="n">u32</span> <span class="n">data_lo</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cmd_type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">eth_spe</span> <span class="o">*</span><span class="n">spe</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">type</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">common</span> <span class="o">=</span> <span class="n">bnx2x_is_contextless_ramrod</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="n">cmd_type</span><span class="p">);</span>

<span class="cp">#ifdef BNX2X_STOP_ON_ERROR</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">panic</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">BNX2X_ERR</span><span class="p">(</span><span class="s">&quot;Can&#39;t post SP when there is panic</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">spq_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">common</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">eq_spq_left</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">BNX2X_ERR</span><span class="p">(</span><span class="s">&quot;BUG! EQ ring full!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">spq_lock</span><span class="p">);</span>
			<span class="n">bnx2x_panic</span><span class="p">();</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">cq_spq_left</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">BNX2X_ERR</span><span class="p">(</span><span class="s">&quot;BUG! SPQ ring full!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">spq_lock</span><span class="p">);</span>
			<span class="n">bnx2x_panic</span><span class="p">();</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spe</span> <span class="o">=</span> <span class="n">bnx2x_sp_get_next</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>

	<span class="cm">/* CID needs port number to be encoded int it */</span>
	<span class="n">spe</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">conn_and_cmd_data</span> <span class="o">=</span>
			<span class="n">cpu_to_le32</span><span class="p">((</span><span class="n">command</span> <span class="o">&lt;&lt;</span> <span class="n">SPE_HDR_CMD_ID_SHIFT</span><span class="p">)</span> <span class="o">|</span>
				    <span class="n">HW_CID</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">cid</span><span class="p">));</span>

	<span class="n">type</span> <span class="o">=</span> <span class="p">(</span><span class="n">cmd_type</span> <span class="o">&lt;&lt;</span> <span class="n">SPE_HDR_CONN_TYPE_SHIFT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">SPE_HDR_CONN_TYPE</span><span class="p">;</span>

	<span class="n">type</span> <span class="o">|=</span> <span class="p">((</span><span class="n">BP_FUNC</span><span class="p">(</span><span class="n">bp</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">SPE_HDR_FUNCTION_ID_SHIFT</span><span class="p">)</span> <span class="o">&amp;</span>
		 <span class="n">SPE_HDR_FUNCTION_ID</span><span class="p">);</span>

	<span class="n">spe</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">type</span><span class="p">);</span>

	<span class="n">spe</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">update_data_addr</span><span class="p">.</span><span class="n">hi</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">data_hi</span><span class="p">);</span>
	<span class="n">spe</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">update_data_addr</span><span class="p">.</span><span class="n">lo</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">data_lo</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * It&#39;s ok if the actual decrement is issued towards the memory</span>
<span class="cm">	 * somewhere between the spin_lock and spin_unlock. Thus no</span>
<span class="cm">	 * more explict memory barrier is needed.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">common</span><span class="p">)</span>
		<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">eq_spq_left</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">cq_spq_left</span><span class="p">);</span>


	<span class="n">DP</span><span class="p">(</span><span class="n">BNX2X_MSG_SP</span><span class="p">,</span>
	   <span class="s">&quot;SPQE[%x] (%x:%x)  (cmd, common?) (%d,%d)  hw_cid %x  data (%x:%x) type(0x%x) left (CQ, EQ) (%x,%x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	   <span class="n">bp</span><span class="o">-&gt;</span><span class="n">spq_prod_idx</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">U64_HI</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">spq_mapping</span><span class="p">),</span>
	   <span class="p">(</span><span class="n">u32</span><span class="p">)(</span><span class="n">U64_LO</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">spq_mapping</span><span class="p">)</span> <span class="o">+</span>
	   <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">spq_prod_bd</span> <span class="o">-</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">spq</span><span class="p">),</span> <span class="n">command</span><span class="p">,</span> <span class="n">common</span><span class="p">,</span>
	   <span class="n">HW_CID</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">cid</span><span class="p">),</span> <span class="n">data_hi</span><span class="p">,</span> <span class="n">data_lo</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span>
	   <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">cq_spq_left</span><span class="p">),</span> <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">eq_spq_left</span><span class="p">));</span>

	<span class="n">bnx2x_sp_prod_update</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">spq_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* acquire split MCP access lock register */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">bnx2x_acquire_alr</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">j</span><span class="p">,</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">might_sleep</span><span class="p">();</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">1000</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1UL</span> <span class="o">&lt;&lt;</span> <span class="mi">31</span><span class="p">);</span>
		<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">GRCBASE_MCP</span> <span class="o">+</span> <span class="mh">0x9c</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">GRCBASE_MCP</span> <span class="o">+</span> <span class="mh">0x9c</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1L</span> <span class="o">&lt;&lt;</span> <span class="mi">31</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">msleep</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1L</span> <span class="o">&lt;&lt;</span> <span class="mi">31</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">BNX2X_ERR</span><span class="p">(</span><span class="s">&quot;Cannot acquire MCP access lock register</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* release split MCP access lock register */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_release_alr</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">GRCBASE_MCP</span> <span class="o">+</span> <span class="mh">0x9c</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#define BNX2X_DEF_SB_ATT_IDX	0x0001</span>
<span class="cp">#define BNX2X_DEF_SB_IDX	0x0002</span>

<span class="k">static</span> <span class="n">u16</span> <span class="nf">bnx2x_update_dsb_idx</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">host_sp_status_block</span> <span class="o">*</span><span class="n">def_sb</span> <span class="o">=</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">def_status_blk</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">barrier</span><span class="p">();</span> <span class="cm">/* status block is written to by the chip */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">def_att_idx</span> <span class="o">!=</span> <span class="n">def_sb</span><span class="o">-&gt;</span><span class="n">atten_status_block</span><span class="p">.</span><span class="n">attn_bits_index</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bp</span><span class="o">-&gt;</span><span class="n">def_att_idx</span> <span class="o">=</span> <span class="n">def_sb</span><span class="o">-&gt;</span><span class="n">atten_status_block</span><span class="p">.</span><span class="n">attn_bits_index</span><span class="p">;</span>
		<span class="n">rc</span> <span class="o">|=</span> <span class="n">BNX2X_DEF_SB_ATT_IDX</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">def_idx</span> <span class="o">!=</span> <span class="n">def_sb</span><span class="o">-&gt;</span><span class="n">sp_sb</span><span class="p">.</span><span class="n">running_index</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bp</span><span class="o">-&gt;</span><span class="n">def_idx</span> <span class="o">=</span> <span class="n">def_sb</span><span class="o">-&gt;</span><span class="n">sp_sb</span><span class="p">.</span><span class="n">running_index</span><span class="p">;</span>
		<span class="n">rc</span> <span class="o">|=</span> <span class="n">BNX2X_DEF_SB_IDX</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Do not reorder: indecies reading should complete before handling */</span>
	<span class="n">barrier</span><span class="p">();</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * slow path service functions</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_attn_int_asserted</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">,</span> <span class="n">u32</span> <span class="n">asserted</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">port</span> <span class="o">=</span> <span class="n">BP_PORT</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">aeu_addr</span> <span class="o">=</span> <span class="n">port</span> <span class="o">?</span> <span class="n">MISC_REG_AEU_MASK_ATTN_FUNC_1</span> <span class="o">:</span>
			      <span class="n">MISC_REG_AEU_MASK_ATTN_FUNC_0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">nig_int_mask_addr</span> <span class="o">=</span> <span class="n">port</span> <span class="o">?</span> <span class="n">NIG_REG_MASK_INTERRUPT_PORT1</span> <span class="o">:</span>
				       <span class="n">NIG_REG_MASK_INTERRUPT_PORT0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">aeu_mask</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">nig_mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">reg_addr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">attn_state</span> <span class="o">&amp;</span> <span class="n">asserted</span><span class="p">)</span>
		<span class="n">BNX2X_ERR</span><span class="p">(</span><span class="s">&quot;IGU ERROR</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">bnx2x_acquire_hw_lock</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">HW_LOCK_RESOURCE_PORT0_ATT_MASK</span> <span class="o">+</span> <span class="n">port</span><span class="p">);</span>
	<span class="n">aeu_mask</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">aeu_addr</span><span class="p">);</span>

	<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_HW</span><span class="p">,</span> <span class="s">&quot;aeu_mask %x  newly asserted %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	   <span class="n">aeu_mask</span><span class="p">,</span> <span class="n">asserted</span><span class="p">);</span>
	<span class="n">aeu_mask</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">asserted</span> <span class="o">&amp;</span> <span class="mh">0x3ff</span><span class="p">);</span>
	<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_HW</span><span class="p">,</span> <span class="s">&quot;new mask %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">aeu_mask</span><span class="p">);</span>

	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">aeu_addr</span><span class="p">,</span> <span class="n">aeu_mask</span><span class="p">);</span>
	<span class="n">bnx2x_release_hw_lock</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">HW_LOCK_RESOURCE_PORT0_ATT_MASK</span> <span class="o">+</span> <span class="n">port</span><span class="p">);</span>

	<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_HW</span><span class="p">,</span> <span class="s">&quot;attn_state %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">attn_state</span><span class="p">);</span>
	<span class="n">bp</span><span class="o">-&gt;</span><span class="n">attn_state</span> <span class="o">|=</span> <span class="n">asserted</span><span class="p">;</span>
	<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_HW</span><span class="p">,</span> <span class="s">&quot;new state %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">attn_state</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">asserted</span> <span class="o">&amp;</span> <span class="n">ATTN_HARD_WIRED_MASK</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">asserted</span> <span class="o">&amp;</span> <span class="n">ATTN_NIG_FOR_FUNC</span><span class="p">)</span> <span class="p">{</span>

			<span class="n">bnx2x_acquire_phy_lock</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>

			<span class="cm">/* save nig interrupt mask */</span>
			<span class="n">nig_mask</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">nig_int_mask_addr</span><span class="p">);</span>

			<span class="cm">/* If nig_mask is not set, no need to call the update</span>
<span class="cm">			 * function.</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">nig_mask</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">nig_int_mask_addr</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

				<span class="n">bnx2x_link_attn</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="cm">/* handle unicore attn? */</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">asserted</span> <span class="o">&amp;</span> <span class="n">ATTN_SW_TIMER_4_FUNC</span><span class="p">)</span>
			<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_HW</span><span class="p">,</span> <span class="s">&quot;ATTN_SW_TIMER_4_FUNC!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">asserted</span> <span class="o">&amp;</span> <span class="n">GPIO_2_FUNC</span><span class="p">)</span>
			<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_HW</span><span class="p">,</span> <span class="s">&quot;GPIO_2_FUNC!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">asserted</span> <span class="o">&amp;</span> <span class="n">GPIO_3_FUNC</span><span class="p">)</span>
			<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_HW</span><span class="p">,</span> <span class="s">&quot;GPIO_3_FUNC!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">asserted</span> <span class="o">&amp;</span> <span class="n">GPIO_4_FUNC</span><span class="p">)</span>
			<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_HW</span><span class="p">,</span> <span class="s">&quot;GPIO_4_FUNC!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">port</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">asserted</span> <span class="o">&amp;</span> <span class="n">ATTN_GENERAL_ATTN_1</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_HW</span><span class="p">,</span> <span class="s">&quot;ATTN_GENERAL_ATTN_1!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">MISC_REG_AEU_GENERAL_ATTN_1</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">asserted</span> <span class="o">&amp;</span> <span class="n">ATTN_GENERAL_ATTN_2</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_HW</span><span class="p">,</span> <span class="s">&quot;ATTN_GENERAL_ATTN_2!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">MISC_REG_AEU_GENERAL_ATTN_2</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">asserted</span> <span class="o">&amp;</span> <span class="n">ATTN_GENERAL_ATTN_3</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_HW</span><span class="p">,</span> <span class="s">&quot;ATTN_GENERAL_ATTN_3!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">MISC_REG_AEU_GENERAL_ATTN_3</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">asserted</span> <span class="o">&amp;</span> <span class="n">ATTN_GENERAL_ATTN_4</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_HW</span><span class="p">,</span> <span class="s">&quot;ATTN_GENERAL_ATTN_4!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">MISC_REG_AEU_GENERAL_ATTN_4</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">asserted</span> <span class="o">&amp;</span> <span class="n">ATTN_GENERAL_ATTN_5</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_HW</span><span class="p">,</span> <span class="s">&quot;ATTN_GENERAL_ATTN_5!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">MISC_REG_AEU_GENERAL_ATTN_5</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">asserted</span> <span class="o">&amp;</span> <span class="n">ATTN_GENERAL_ATTN_6</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_HW</span><span class="p">,</span> <span class="s">&quot;ATTN_GENERAL_ATTN_6!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">MISC_REG_AEU_GENERAL_ATTN_6</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>

	<span class="p">}</span> <span class="cm">/* if hardwired */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">.</span><span class="n">int_block</span> <span class="o">==</span> <span class="n">INT_BLOCK_HC</span><span class="p">)</span>
		<span class="n">reg_addr</span> <span class="o">=</span> <span class="p">(</span><span class="n">HC_REG_COMMAND_REG</span> <span class="o">+</span> <span class="n">port</span><span class="o">*</span><span class="mi">32</span> <span class="o">+</span>
			    <span class="n">COMMAND_REG_ATTN_BITS_SET</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">reg_addr</span> <span class="o">=</span> <span class="p">(</span><span class="n">BAR_IGU_INTMEM</span> <span class="o">+</span> <span class="n">IGU_CMD_ATTN_BIT_SET_UPPER</span><span class="o">*</span><span class="mi">8</span><span class="p">);</span>

	<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_HW</span><span class="p">,</span> <span class="s">&quot;about to mask 0x%08x at %s addr 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">asserted</span><span class="p">,</span>
	   <span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">.</span><span class="n">int_block</span> <span class="o">==</span> <span class="n">INT_BLOCK_HC</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;HC&quot;</span> <span class="o">:</span> <span class="s">&quot;IGU&quot;</span><span class="p">,</span> <span class="n">reg_addr</span><span class="p">);</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">reg_addr</span><span class="p">,</span> <span class="n">asserted</span><span class="p">);</span>

	<span class="cm">/* now set back the mask */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">asserted</span> <span class="o">&amp;</span> <span class="n">ATTN_NIG_FOR_FUNC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">nig_int_mask_addr</span><span class="p">,</span> <span class="n">nig_mask</span><span class="p">);</span>
		<span class="n">bnx2x_release_phy_lock</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_fan_failure</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">port</span> <span class="o">=</span> <span class="n">BP_PORT</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">ext_phy_config</span><span class="p">;</span>
	<span class="cm">/* mark the failure */</span>
	<span class="n">ext_phy_config</span> <span class="o">=</span>
		<span class="n">SHMEM_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span>
			 <span class="n">dev_info</span><span class="p">.</span><span class="n">port_hw_config</span><span class="p">[</span><span class="n">port</span><span class="p">].</span><span class="n">external_phy_config</span><span class="p">);</span>

	<span class="n">ext_phy_config</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PORT_HW_CFG_XGXS_EXT_PHY_TYPE_MASK</span><span class="p">;</span>
	<span class="n">ext_phy_config</span> <span class="o">|=</span> <span class="n">PORT_HW_CFG_XGXS_EXT_PHY_TYPE_FAILURE</span><span class="p">;</span>
	<span class="n">SHMEM_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">dev_info</span><span class="p">.</span><span class="n">port_hw_config</span><span class="p">[</span><span class="n">port</span><span class="p">].</span><span class="n">external_phy_config</span><span class="p">,</span>
		 <span class="n">ext_phy_config</span><span class="p">);</span>

	<span class="cm">/* log the failure */</span>
	<span class="n">netdev_err</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Fan Failure on Network Controller has caused the driver to shutdown the card to prevent permanent damage.</span><span class="se">\n</span><span class="s">&quot;</span>
			    <span class="s">&quot;Please contact OEM Support for assistance</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Scheudle device reset (unload)</span>
<span class="cm">	 * This is due to some boards consuming sufficient power when driver is</span>
<span class="cm">	 * up to overheat if fan fails.</span>
<span class="cm">	 */</span>
	<span class="n">smp_mb__before_clear_bit</span><span class="p">();</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">BNX2X_SP_RTNL_FAN_FAILURE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">sp_rtnl_state</span><span class="p">);</span>
	<span class="n">smp_mb__after_clear_bit</span><span class="p">();</span>
	<span class="n">schedule_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">sp_rtnl_task</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_attn_int_deasserted0</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">,</span> <span class="n">u32</span> <span class="n">attn</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">port</span> <span class="o">=</span> <span class="n">BP_PORT</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">reg_offset</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">reg_offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">port</span> <span class="o">?</span> <span class="n">MISC_REG_AEU_ENABLE1_FUNC_1_OUT_0</span> <span class="o">:</span>
			     <span class="n">MISC_REG_AEU_ENABLE1_FUNC_0_OUT_0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">attn</span> <span class="o">&amp;</span> <span class="n">AEU_INPUTS_ATTN_BITS_SPIO5</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">val</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">reg_offset</span><span class="p">);</span>
		<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">AEU_INPUTS_ATTN_BITS_SPIO5</span><span class="p">;</span>
		<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">reg_offset</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

		<span class="n">BNX2X_ERR</span><span class="p">(</span><span class="s">&quot;SPIO5 hw attention</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="cm">/* Fan failure attention */</span>
		<span class="n">bnx2x_hw_reset_phy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">link_params</span><span class="p">);</span>
		<span class="n">bnx2x_fan_failure</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">attn</span> <span class="o">&amp;</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">link_vars</span><span class="p">.</span><span class="n">aeu_int_mask</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">pmf</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bnx2x_acquire_phy_lock</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
		<span class="n">bnx2x_handle_module_detect_int</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">link_params</span><span class="p">);</span>
		<span class="n">bnx2x_release_phy_lock</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">attn</span> <span class="o">&amp;</span> <span class="n">HW_INTERRUT_ASSERT_SET_0</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">val</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">reg_offset</span><span class="p">);</span>
		<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">attn</span> <span class="o">&amp;</span> <span class="n">HW_INTERRUT_ASSERT_SET_0</span><span class="p">);</span>
		<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">reg_offset</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

		<span class="n">BNX2X_ERR</span><span class="p">(</span><span class="s">&quot;FATAL HW block attention set0 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="p">(</span><span class="n">u32</span><span class="p">)(</span><span class="n">attn</span> <span class="o">&amp;</span> <span class="n">HW_INTERRUT_ASSERT_SET_0</span><span class="p">));</span>
		<span class="n">bnx2x_panic</span><span class="p">();</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_attn_int_deasserted1</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">,</span> <span class="n">u32</span> <span class="n">attn</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">attn</span> <span class="o">&amp;</span> <span class="n">AEU_INPUTS_ATTN_BITS_DOORBELLQ_HW_INTERRUPT</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">val</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">DORQ_REG_DORQ_INT_STS_CLR</span><span class="p">);</span>
		<span class="n">BNX2X_ERR</span><span class="p">(</span><span class="s">&quot;DB hw attention 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
		<span class="cm">/* DORQ discard attention */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0x2</span><span class="p">)</span>
			<span class="n">BNX2X_ERR</span><span class="p">(</span><span class="s">&quot;FATAL error from DORQ</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">attn</span> <span class="o">&amp;</span> <span class="n">HW_INTERRUT_ASSERT_SET_1</span><span class="p">)</span> <span class="p">{</span>

		<span class="kt">int</span> <span class="n">port</span> <span class="o">=</span> <span class="n">BP_PORT</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
		<span class="kt">int</span> <span class="n">reg_offset</span><span class="p">;</span>

		<span class="n">reg_offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">port</span> <span class="o">?</span> <span class="n">MISC_REG_AEU_ENABLE1_FUNC_1_OUT_1</span> <span class="o">:</span>
				     <span class="n">MISC_REG_AEU_ENABLE1_FUNC_0_OUT_1</span><span class="p">);</span>

		<span class="n">val</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">reg_offset</span><span class="p">);</span>
		<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">attn</span> <span class="o">&amp;</span> <span class="n">HW_INTERRUT_ASSERT_SET_1</span><span class="p">);</span>
		<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">reg_offset</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

		<span class="n">BNX2X_ERR</span><span class="p">(</span><span class="s">&quot;FATAL HW block attention set1 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="p">(</span><span class="n">u32</span><span class="p">)(</span><span class="n">attn</span> <span class="o">&amp;</span> <span class="n">HW_INTERRUT_ASSERT_SET_1</span><span class="p">));</span>
		<span class="n">bnx2x_panic</span><span class="p">();</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_attn_int_deasserted2</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">,</span> <span class="n">u32</span> <span class="n">attn</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">attn</span> <span class="o">&amp;</span> <span class="n">AEU_INPUTS_ATTN_BITS_CFC_HW_INTERRUPT</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">val</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">CFC_REG_CFC_INT_STS_CLR</span><span class="p">);</span>
		<span class="n">BNX2X_ERR</span><span class="p">(</span><span class="s">&quot;CFC hw attention 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
		<span class="cm">/* CFC error attention */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0x2</span><span class="p">)</span>
			<span class="n">BNX2X_ERR</span><span class="p">(</span><span class="s">&quot;FATAL error from CFC</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">attn</span> <span class="o">&amp;</span> <span class="n">AEU_INPUTS_ATTN_BITS_PXP_HW_INTERRUPT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">PXP_REG_PXP_INT_STS_CLR_0</span><span class="p">);</span>
		<span class="n">BNX2X_ERR</span><span class="p">(</span><span class="s">&quot;PXP hw attention-0 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
		<span class="cm">/* RQ_USDMDP_FIFO_OVERFLOW */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0x18000</span><span class="p">)</span>
			<span class="n">BNX2X_ERR</span><span class="p">(</span><span class="s">&quot;FATAL error from PXP</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CHIP_IS_E1x</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">val</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">PXP_REG_PXP_INT_STS_CLR_1</span><span class="p">);</span>
			<span class="n">BNX2X_ERR</span><span class="p">(</span><span class="s">&quot;PXP hw attention-1 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">attn</span> <span class="o">&amp;</span> <span class="n">HW_INTERRUT_ASSERT_SET_2</span><span class="p">)</span> <span class="p">{</span>

		<span class="kt">int</span> <span class="n">port</span> <span class="o">=</span> <span class="n">BP_PORT</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
		<span class="kt">int</span> <span class="n">reg_offset</span><span class="p">;</span>

		<span class="n">reg_offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">port</span> <span class="o">?</span> <span class="n">MISC_REG_AEU_ENABLE1_FUNC_1_OUT_2</span> <span class="o">:</span>
				     <span class="n">MISC_REG_AEU_ENABLE1_FUNC_0_OUT_2</span><span class="p">);</span>

		<span class="n">val</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">reg_offset</span><span class="p">);</span>
		<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">attn</span> <span class="o">&amp;</span> <span class="n">HW_INTERRUT_ASSERT_SET_2</span><span class="p">);</span>
		<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">reg_offset</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

		<span class="n">BNX2X_ERR</span><span class="p">(</span><span class="s">&quot;FATAL HW block attention set2 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="p">(</span><span class="n">u32</span><span class="p">)(</span><span class="n">attn</span> <span class="o">&amp;</span> <span class="n">HW_INTERRUT_ASSERT_SET_2</span><span class="p">));</span>
		<span class="n">bnx2x_panic</span><span class="p">();</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_attn_int_deasserted3</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">,</span> <span class="n">u32</span> <span class="n">attn</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">attn</span> <span class="o">&amp;</span> <span class="n">EVEREST_GEN_ATTN_IN_USE_MASK</span><span class="p">)</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">attn</span> <span class="o">&amp;</span> <span class="n">BNX2X_PMF_LINK_ASSERT</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">func</span> <span class="o">=</span> <span class="n">BP_FUNC</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>

			<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">MISC_REG_AEU_GENERAL_ATTN_12</span> <span class="o">+</span> <span class="n">func</span><span class="o">*</span><span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">bnx2x_read_mf_cfg</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
			<span class="n">bp</span><span class="o">-&gt;</span><span class="n">mf_config</span><span class="p">[</span><span class="n">BP_VN</span><span class="p">(</span><span class="n">bp</span><span class="p">)]</span> <span class="o">=</span> <span class="n">MF_CFG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span>
					<span class="n">func_mf_config</span><span class="p">[</span><span class="n">BP_ABS_FUNC</span><span class="p">(</span><span class="n">bp</span><span class="p">)].</span><span class="n">config</span><span class="p">);</span>
			<span class="n">val</span> <span class="o">=</span> <span class="n">SHMEM_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span>
				       <span class="n">func_mb</span><span class="p">[</span><span class="n">BP_FW_MB_IDX</span><span class="p">(</span><span class="n">bp</span><span class="p">)].</span><span class="n">drv_status</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">DRV_STATUS_DCC_EVENT_MASK</span><span class="p">)</span>
				<span class="n">bnx2x_dcc_event</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span>
					    <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">DRV_STATUS_DCC_EVENT_MASK</span><span class="p">));</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">DRV_STATUS_SET_MF_BW</span><span class="p">)</span>
				<span class="n">bnx2x_set_mf_bw</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">DRV_STATUS_DRV_INFO_REQ</span><span class="p">)</span>
				<span class="n">bnx2x_handle_drv_info_req</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">pmf</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">DRV_STATUS_PMF</span><span class="p">))</span>
				<span class="n">bnx2x_pmf_update</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">pmf</span> <span class="o">&amp;&amp;</span>
			    <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">DRV_STATUS_DCBX_NEGOTIATION_RESULTS</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
				<span class="n">bp</span><span class="o">-&gt;</span><span class="n">dcbx_enabled</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="cm">/* start dcbx state machine */</span>
				<span class="n">bnx2x_dcbx_set_params</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span>
					<span class="n">BNX2X_DCBX_STATE_NEG_RECEIVED</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">DRV_STATUS_AFEX_EVENT_MASK</span><span class="p">)</span>
				<span class="n">bnx2x_handle_afex_cmd</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span>
					<span class="n">val</span> <span class="o">&amp;</span> <span class="n">DRV_STATUS_AFEX_EVENT_MASK</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">link_vars</span><span class="p">.</span><span class="n">periodic_flags</span> <span class="o">&amp;</span>
			    <span class="n">PERIODIC_FLAGS_LINK_EVENT</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/*  sync with link */</span>
				<span class="n">bnx2x_acquire_phy_lock</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
				<span class="n">bp</span><span class="o">-&gt;</span><span class="n">link_vars</span><span class="p">.</span><span class="n">periodic_flags</span> <span class="o">&amp;=</span>
					<span class="o">~</span><span class="n">PERIODIC_FLAGS_LINK_EVENT</span><span class="p">;</span>
				<span class="n">bnx2x_release_phy_lock</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">IS_MF</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span>
					<span class="n">bnx2x_link_sync_notify</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
				<span class="n">bnx2x_link_report</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="cm">/* Always call it here: bnx2x_link_report() will</span>
<span class="cm">			 * prevent the link indication duplication.</span>
<span class="cm">			 */</span>
			<span class="n">bnx2x__link_status_update</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">attn</span> <span class="o">&amp;</span> <span class="n">BNX2X_MC_ASSERT_BITS</span><span class="p">)</span> <span class="p">{</span>

			<span class="n">BNX2X_ERR</span><span class="p">(</span><span class="s">&quot;MC assert!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">bnx2x_mc_assert</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
			<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">MISC_REG_AEU_GENERAL_ATTN_10</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">MISC_REG_AEU_GENERAL_ATTN_9</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">MISC_REG_AEU_GENERAL_ATTN_8</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">MISC_REG_AEU_GENERAL_ATTN_7</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">bnx2x_panic</span><span class="p">();</span>

		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">attn</span> <span class="o">&amp;</span> <span class="n">BNX2X_MCP_ASSERT</span><span class="p">)</span> <span class="p">{</span>

			<span class="n">BNX2X_ERR</span><span class="p">(</span><span class="s">&quot;MCP assert!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">MISC_REG_AEU_GENERAL_ATTN_11</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">bnx2x_fw_dump</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>

		<span class="p">}</span> <span class="k">else</span>
			<span class="n">BNX2X_ERR</span><span class="p">(</span><span class="s">&quot;Unknown HW assert! (attn 0x%x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">attn</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">attn</span> <span class="o">&amp;</span> <span class="n">EVEREST_LATCHED_ATTN_IN_USE_MASK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BNX2X_ERR</span><span class="p">(</span><span class="s">&quot;LATCHED attention 0x%08x (masked)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">attn</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">attn</span> <span class="o">&amp;</span> <span class="n">BNX2X_GRC_TIMEOUT</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">val</span> <span class="o">=</span> <span class="n">CHIP_IS_E1</span><span class="p">(</span><span class="n">bp</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span>
					<span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">MISC_REG_GRC_TIMEOUT_ATTN</span><span class="p">);</span>
			<span class="n">BNX2X_ERR</span><span class="p">(</span><span class="s">&quot;GRC time-out 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">attn</span> <span class="o">&amp;</span> <span class="n">BNX2X_GRC_RSV</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">val</span> <span class="o">=</span> <span class="n">CHIP_IS_E1</span><span class="p">(</span><span class="n">bp</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span>
					<span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">MISC_REG_GRC_RSV_ATTN</span><span class="p">);</span>
			<span class="n">BNX2X_ERR</span><span class="p">(</span><span class="s">&quot;GRC reserved 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">MISC_REG_AEU_CLR_LATCH_SIGNAL</span><span class="p">,</span> <span class="mh">0x7ff</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Bits map:</span>
<span class="cm"> * 0-7   - Engine0 load counter.</span>
<span class="cm"> * 8-15  - Engine1 load counter.</span>
<span class="cm"> * 16    - Engine0 RESET_IN_PROGRESS bit.</span>
<span class="cm"> * 17    - Engine1 RESET_IN_PROGRESS bit.</span>
<span class="cm"> * 18    - Engine0 ONE_IS_LOADED. Set when there is at least one active function</span>
<span class="cm"> *         on the engine</span>
<span class="cm"> * 19    - Engine1 ONE_IS_LOADED.</span>
<span class="cm"> * 20    - Chip reset flow bit. When set none-leader must wait for both engines</span>
<span class="cm"> *         leader to complete (check for both RESET_IN_PROGRESS bits and not for</span>
<span class="cm"> *         just the one belonging to its engine).</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="cp">#define BNX2X_RECOVERY_GLOB_REG		MISC_REG_GENERIC_POR_1</span>

<span class="cp">#define BNX2X_PATH0_LOAD_CNT_MASK	0x000000ff</span>
<span class="cp">#define BNX2X_PATH0_LOAD_CNT_SHIFT	0</span>
<span class="cp">#define BNX2X_PATH1_LOAD_CNT_MASK	0x0000ff00</span>
<span class="cp">#define BNX2X_PATH1_LOAD_CNT_SHIFT	8</span>
<span class="cp">#define BNX2X_PATH0_RST_IN_PROG_BIT	0x00010000</span>
<span class="cp">#define BNX2X_PATH1_RST_IN_PROG_BIT	0x00020000</span>
<span class="cp">#define BNX2X_GLOBAL_RESET_BIT		0x00040000</span>

<span class="cm">/*</span>
<span class="cm"> * Set the GLOBAL_RESET bit.</span>
<span class="cm"> *</span>
<span class="cm"> * Should be run under rtnl lock</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">bnx2x_set_reset_global</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>
	<span class="n">bnx2x_acquire_hw_lock</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">HW_LOCK_RESOURCE_RECOVERY_REG</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">BNX2X_RECOVERY_GLOB_REG</span><span class="p">);</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">BNX2X_RECOVERY_GLOB_REG</span><span class="p">,</span> <span class="n">val</span> <span class="o">|</span> <span class="n">BNX2X_GLOBAL_RESET_BIT</span><span class="p">);</span>
	<span class="n">bnx2x_release_hw_lock</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">HW_LOCK_RESOURCE_RECOVERY_REG</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Clear the GLOBAL_RESET bit.</span>
<span class="cm"> *</span>
<span class="cm"> * Should be run under rtnl lock</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_clear_reset_global</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>
	<span class="n">bnx2x_acquire_hw_lock</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">HW_LOCK_RESOURCE_RECOVERY_REG</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">BNX2X_RECOVERY_GLOB_REG</span><span class="p">);</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">BNX2X_RECOVERY_GLOB_REG</span><span class="p">,</span> <span class="n">val</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="n">BNX2X_GLOBAL_RESET_BIT</span><span class="p">));</span>
	<span class="n">bnx2x_release_hw_lock</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">HW_LOCK_RESOURCE_RECOVERY_REG</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Checks the GLOBAL_RESET bit.</span>
<span class="cm"> *</span>
<span class="cm"> * should be run under rtnl lock</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">bool</span> <span class="nf">bnx2x_reset_is_global</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">val</span>	<span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">BNX2X_RECOVERY_GLOB_REG</span><span class="p">);</span>

	<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_HW</span><span class="p">,</span> <span class="s">&quot;GEN_REG_VAL=0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">BNX2X_GLOBAL_RESET_BIT</span><span class="p">)</span> <span class="o">?</span> <span class="nb">true</span> <span class="o">:</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Clear RESET_IN_PROGRESS bit for the current engine.</span>
<span class="cm"> *</span>
<span class="cm"> * Should be run under rtnl lock</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_set_reset_done</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">bit</span> <span class="o">=</span> <span class="n">BP_PATH</span><span class="p">(</span><span class="n">bp</span><span class="p">)</span> <span class="o">?</span>
		<span class="n">BNX2X_PATH1_RST_IN_PROG_BIT</span> <span class="o">:</span> <span class="n">BNX2X_PATH0_RST_IN_PROG_BIT</span><span class="p">;</span>
	<span class="n">bnx2x_acquire_hw_lock</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">HW_LOCK_RESOURCE_RECOVERY_REG</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">BNX2X_RECOVERY_GLOB_REG</span><span class="p">);</span>

	<span class="cm">/* Clear the bit */</span>
	<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">bit</span><span class="p">;</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">BNX2X_RECOVERY_GLOB_REG</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

	<span class="n">bnx2x_release_hw_lock</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">HW_LOCK_RESOURCE_RECOVERY_REG</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Set RESET_IN_PROGRESS for the current engine.</span>
<span class="cm"> *</span>
<span class="cm"> * should be run under rtnl lock</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">bnx2x_set_reset_in_progress</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">bit</span> <span class="o">=</span> <span class="n">BP_PATH</span><span class="p">(</span><span class="n">bp</span><span class="p">)</span> <span class="o">?</span>
		<span class="n">BNX2X_PATH1_RST_IN_PROG_BIT</span> <span class="o">:</span> <span class="n">BNX2X_PATH0_RST_IN_PROG_BIT</span><span class="p">;</span>
	<span class="n">bnx2x_acquire_hw_lock</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">HW_LOCK_RESOURCE_RECOVERY_REG</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">BNX2X_RECOVERY_GLOB_REG</span><span class="p">);</span>

	<span class="cm">/* Set the bit */</span>
	<span class="n">val</span> <span class="o">|=</span> <span class="n">bit</span><span class="p">;</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">BNX2X_RECOVERY_GLOB_REG</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="n">bnx2x_release_hw_lock</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">HW_LOCK_RESOURCE_RECOVERY_REG</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Checks the RESET_IN_PROGRESS bit for the given engine.</span>
<span class="cm"> * should be run under rtnl lock</span>
<span class="cm"> */</span>
<span class="n">bool</span> <span class="nf">bnx2x_reset_is_done</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">engine</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">val</span>	<span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">BNX2X_RECOVERY_GLOB_REG</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">bit</span> <span class="o">=</span> <span class="n">engine</span> <span class="o">?</span>
		<span class="n">BNX2X_PATH1_RST_IN_PROG_BIT</span> <span class="o">:</span> <span class="n">BNX2X_PATH0_RST_IN_PROG_BIT</span><span class="p">;</span>

	<span class="cm">/* return false if bit is set */</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">bit</span><span class="p">)</span> <span class="o">?</span> <span class="nb">false</span> <span class="o">:</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * set pf load for the current pf.</span>
<span class="cm"> *</span>
<span class="cm"> * should be run under rtnl lock</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">bnx2x_set_pf_load</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">val1</span><span class="p">,</span> <span class="n">val</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">mask</span> <span class="o">=</span> <span class="n">BP_PATH</span><span class="p">(</span><span class="n">bp</span><span class="p">)</span> <span class="o">?</span> <span class="n">BNX2X_PATH1_LOAD_CNT_MASK</span> <span class="o">:</span>
			     <span class="n">BNX2X_PATH0_LOAD_CNT_MASK</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">shift</span> <span class="o">=</span> <span class="n">BP_PATH</span><span class="p">(</span><span class="n">bp</span><span class="p">)</span> <span class="o">?</span> <span class="n">BNX2X_PATH1_LOAD_CNT_SHIFT</span> <span class="o">:</span>
			     <span class="n">BNX2X_PATH0_LOAD_CNT_SHIFT</span><span class="p">;</span>

	<span class="n">bnx2x_acquire_hw_lock</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">HW_LOCK_RESOURCE_RECOVERY_REG</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">BNX2X_RECOVERY_GLOB_REG</span><span class="p">);</span>

	<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_IFUP</span><span class="p">,</span> <span class="s">&quot;Old GEN_REG_VAL=0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

	<span class="cm">/* get the current counter value */</span>
	<span class="n">val1</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">shift</span><span class="p">;</span>

	<span class="cm">/* set bit of that PF */</span>
	<span class="n">val1</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">pf_num</span><span class="p">);</span>

	<span class="cm">/* clear the old value */</span>
	<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">mask</span><span class="p">;</span>

	<span class="cm">/* set the new one */</span>
	<span class="n">val</span> <span class="o">|=</span> <span class="p">((</span><span class="n">val1</span> <span class="o">&lt;&lt;</span> <span class="n">shift</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">);</span>

	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">BNX2X_RECOVERY_GLOB_REG</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="n">bnx2x_release_hw_lock</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">HW_LOCK_RESOURCE_RECOVERY_REG</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * bnx2x_clear_pf_load - clear pf load mark</span>
<span class="cm"> *</span>
<span class="cm"> * @bp:		driver handle</span>
<span class="cm"> *</span>
<span class="cm"> * Should be run under rtnl lock.</span>
<span class="cm"> * Decrements the load counter for the current engine. Returns</span>
<span class="cm"> * whether other functions are still loaded</span>
<span class="cm"> */</span>
<span class="n">bool</span> <span class="nf">bnx2x_clear_pf_load</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">val1</span><span class="p">,</span> <span class="n">val</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">mask</span> <span class="o">=</span> <span class="n">BP_PATH</span><span class="p">(</span><span class="n">bp</span><span class="p">)</span> <span class="o">?</span> <span class="n">BNX2X_PATH1_LOAD_CNT_MASK</span> <span class="o">:</span>
			     <span class="n">BNX2X_PATH0_LOAD_CNT_MASK</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">shift</span> <span class="o">=</span> <span class="n">BP_PATH</span><span class="p">(</span><span class="n">bp</span><span class="p">)</span> <span class="o">?</span> <span class="n">BNX2X_PATH1_LOAD_CNT_SHIFT</span> <span class="o">:</span>
			     <span class="n">BNX2X_PATH0_LOAD_CNT_SHIFT</span><span class="p">;</span>

	<span class="n">bnx2x_acquire_hw_lock</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">HW_LOCK_RESOURCE_RECOVERY_REG</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">BNX2X_RECOVERY_GLOB_REG</span><span class="p">);</span>
	<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_IFDOWN</span><span class="p">,</span> <span class="s">&quot;Old GEN_REG_VAL=0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

	<span class="cm">/* get the current counter value */</span>
	<span class="n">val1</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">shift</span><span class="p">;</span>

	<span class="cm">/* clear bit of that PF */</span>
	<span class="n">val1</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">pf_num</span><span class="p">);</span>

	<span class="cm">/* clear the old value */</span>
	<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">mask</span><span class="p">;</span>

	<span class="cm">/* set the new one */</span>
	<span class="n">val</span> <span class="o">|=</span> <span class="p">((</span><span class="n">val1</span> <span class="o">&lt;&lt;</span> <span class="n">shift</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">);</span>

	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">BNX2X_RECOVERY_GLOB_REG</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="n">bnx2x_release_hw_lock</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">HW_LOCK_RESOURCE_RECOVERY_REG</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">val1</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Read the load status for the current engine.</span>
<span class="cm"> *</span>
<span class="cm"> * should be run under rtnl lock</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">bool</span> <span class="nf">bnx2x_get_load_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">engine</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">engine</span> <span class="o">?</span> <span class="n">BNX2X_PATH1_LOAD_CNT_MASK</span> <span class="o">:</span>
			     <span class="n">BNX2X_PATH0_LOAD_CNT_MASK</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">shift</span> <span class="o">=</span> <span class="p">(</span><span class="n">engine</span> <span class="o">?</span> <span class="n">BNX2X_PATH1_LOAD_CNT_SHIFT</span> <span class="o">:</span>
			     <span class="n">BNX2X_PATH0_LOAD_CNT_SHIFT</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">val</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">BNX2X_RECOVERY_GLOB_REG</span><span class="p">);</span>

	<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_HW</span> <span class="o">|</span> <span class="n">NETIF_MSG_IFUP</span><span class="p">,</span> <span class="s">&quot;GLOB_REG=0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

	<span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">shift</span><span class="p">;</span>

	<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_HW</span> <span class="o">|</span> <span class="n">NETIF_MSG_IFUP</span><span class="p">,</span> <span class="s">&quot;load mask for engine %d = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	   <span class="n">engine</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">val</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Reset the load status for the current engine.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_clear_load_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">BP_PATH</span><span class="p">(</span><span class="n">bp</span><span class="p">)</span> <span class="o">?</span> <span class="n">BNX2X_PATH1_LOAD_CNT_MASK</span> <span class="o">:</span>
		    <span class="n">BNX2X_PATH0_LOAD_CNT_MASK</span><span class="p">);</span>
	<span class="n">bnx2x_acquire_hw_lock</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">HW_LOCK_RESOURCE_RECOVERY_REG</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">BNX2X_RECOVERY_GLOB_REG</span><span class="p">);</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">BNX2X_RECOVERY_GLOB_REG</span><span class="p">,</span> <span class="n">val</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="n">mask</span><span class="p">));</span>
	<span class="n">bnx2x_release_hw_lock</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">HW_LOCK_RESOURCE_RECOVERY_REG</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">_print_next_block</span><span class="p">(</span><span class="kt">int</span> <span class="n">idx</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">blk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pr_cont</span><span class="p">(</span><span class="s">&quot;%s%s&quot;</span><span class="p">,</span> <span class="n">idx</span> <span class="o">?</span> <span class="s">&quot;, &quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="n">blk</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bnx2x_check_blocks_with_parity0</span><span class="p">(</span><span class="n">u32</span> <span class="n">sig</span><span class="p">,</span> <span class="kt">int</span> <span class="n">par_num</span><span class="p">,</span>
					   <span class="n">bool</span> <span class="n">print</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">cur_bit</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">sig</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cur_bit</span> <span class="o">=</span> <span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="mh">0x1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sig</span> <span class="o">&amp;</span> <span class="n">cur_bit</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">cur_bit</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">AEU_INPUTS_ATTN_BITS_BRB_PARITY_ERROR</span>:
				<span class="k">if</span> <span class="p">(</span><span class="n">print</span><span class="p">)</span>
					<span class="n">_print_next_block</span><span class="p">(</span><span class="n">par_num</span><span class="o">++</span><span class="p">,</span> <span class="s">&quot;BRB&quot;</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">AEU_INPUTS_ATTN_BITS_PARSER_PARITY_ERROR</span>:
				<span class="k">if</span> <span class="p">(</span><span class="n">print</span><span class="p">)</span>
					<span class="n">_print_next_block</span><span class="p">(</span><span class="n">par_num</span><span class="o">++</span><span class="p">,</span> <span class="s">&quot;PARSER&quot;</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">AEU_INPUTS_ATTN_BITS_TSDM_PARITY_ERROR</span>:
				<span class="k">if</span> <span class="p">(</span><span class="n">print</span><span class="p">)</span>
					<span class="n">_print_next_block</span><span class="p">(</span><span class="n">par_num</span><span class="o">++</span><span class="p">,</span> <span class="s">&quot;TSDM&quot;</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">AEU_INPUTS_ATTN_BITS_SEARCHER_PARITY_ERROR</span>:
				<span class="k">if</span> <span class="p">(</span><span class="n">print</span><span class="p">)</span>
					<span class="n">_print_next_block</span><span class="p">(</span><span class="n">par_num</span><span class="o">++</span><span class="p">,</span>
							  <span class="s">&quot;SEARCHER&quot;</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">AEU_INPUTS_ATTN_BITS_TCM_PARITY_ERROR</span>:
				<span class="k">if</span> <span class="p">(</span><span class="n">print</span><span class="p">)</span>
					<span class="n">_print_next_block</span><span class="p">(</span><span class="n">par_num</span><span class="o">++</span><span class="p">,</span> <span class="s">&quot;TCM&quot;</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">AEU_INPUTS_ATTN_BITS_TSEMI_PARITY_ERROR</span>:
				<span class="k">if</span> <span class="p">(</span><span class="n">print</span><span class="p">)</span>
					<span class="n">_print_next_block</span><span class="p">(</span><span class="n">par_num</span><span class="o">++</span><span class="p">,</span> <span class="s">&quot;TSEMI&quot;</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">AEU_INPUTS_ATTN_BITS_PBCLIENT_PARITY_ERROR</span>:
				<span class="k">if</span> <span class="p">(</span><span class="n">print</span><span class="p">)</span>
					<span class="n">_print_next_block</span><span class="p">(</span><span class="n">par_num</span><span class="o">++</span><span class="p">,</span> <span class="s">&quot;XPB&quot;</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="cm">/* Clear the bit */</span>
			<span class="n">sig</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">cur_bit</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">par_num</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bnx2x_check_blocks_with_parity1</span><span class="p">(</span><span class="n">u32</span> <span class="n">sig</span><span class="p">,</span> <span class="kt">int</span> <span class="n">par_num</span><span class="p">,</span>
					   <span class="n">bool</span> <span class="o">*</span><span class="n">global</span><span class="p">,</span> <span class="n">bool</span> <span class="n">print</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">cur_bit</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">sig</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cur_bit</span> <span class="o">=</span> <span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="mh">0x1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sig</span> <span class="o">&amp;</span> <span class="n">cur_bit</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">cur_bit</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">AEU_INPUTS_ATTN_BITS_PBF_PARITY_ERROR</span>:
				<span class="k">if</span> <span class="p">(</span><span class="n">print</span><span class="p">)</span>
					<span class="n">_print_next_block</span><span class="p">(</span><span class="n">par_num</span><span class="o">++</span><span class="p">,</span> <span class="s">&quot;PBF&quot;</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">AEU_INPUTS_ATTN_BITS_QM_PARITY_ERROR</span>:
				<span class="k">if</span> <span class="p">(</span><span class="n">print</span><span class="p">)</span>
					<span class="n">_print_next_block</span><span class="p">(</span><span class="n">par_num</span><span class="o">++</span><span class="p">,</span> <span class="s">&quot;QM&quot;</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">AEU_INPUTS_ATTN_BITS_TIMERS_PARITY_ERROR</span>:
				<span class="k">if</span> <span class="p">(</span><span class="n">print</span><span class="p">)</span>
					<span class="n">_print_next_block</span><span class="p">(</span><span class="n">par_num</span><span class="o">++</span><span class="p">,</span> <span class="s">&quot;TM&quot;</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">AEU_INPUTS_ATTN_BITS_XSDM_PARITY_ERROR</span>:
				<span class="k">if</span> <span class="p">(</span><span class="n">print</span><span class="p">)</span>
					<span class="n">_print_next_block</span><span class="p">(</span><span class="n">par_num</span><span class="o">++</span><span class="p">,</span> <span class="s">&quot;XSDM&quot;</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">AEU_INPUTS_ATTN_BITS_XCM_PARITY_ERROR</span>:
				<span class="k">if</span> <span class="p">(</span><span class="n">print</span><span class="p">)</span>
					<span class="n">_print_next_block</span><span class="p">(</span><span class="n">par_num</span><span class="o">++</span><span class="p">,</span> <span class="s">&quot;XCM&quot;</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">AEU_INPUTS_ATTN_BITS_XSEMI_PARITY_ERROR</span>:
				<span class="k">if</span> <span class="p">(</span><span class="n">print</span><span class="p">)</span>
					<span class="n">_print_next_block</span><span class="p">(</span><span class="n">par_num</span><span class="o">++</span><span class="p">,</span> <span class="s">&quot;XSEMI&quot;</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">AEU_INPUTS_ATTN_BITS_DOORBELLQ_PARITY_ERROR</span>:
				<span class="k">if</span> <span class="p">(</span><span class="n">print</span><span class="p">)</span>
					<span class="n">_print_next_block</span><span class="p">(</span><span class="n">par_num</span><span class="o">++</span><span class="p">,</span>
							  <span class="s">&quot;DOORBELLQ&quot;</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">AEU_INPUTS_ATTN_BITS_NIG_PARITY_ERROR</span>:
				<span class="k">if</span> <span class="p">(</span><span class="n">print</span><span class="p">)</span>
					<span class="n">_print_next_block</span><span class="p">(</span><span class="n">par_num</span><span class="o">++</span><span class="p">,</span> <span class="s">&quot;NIG&quot;</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">AEU_INPUTS_ATTN_BITS_VAUX_PCI_CORE_PARITY_ERROR</span>:
				<span class="k">if</span> <span class="p">(</span><span class="n">print</span><span class="p">)</span>
					<span class="n">_print_next_block</span><span class="p">(</span><span class="n">par_num</span><span class="o">++</span><span class="p">,</span>
							  <span class="s">&quot;VAUX PCI CORE&quot;</span><span class="p">);</span>
				<span class="o">*</span><span class="n">global</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">AEU_INPUTS_ATTN_BITS_DEBUG_PARITY_ERROR</span>:
				<span class="k">if</span> <span class="p">(</span><span class="n">print</span><span class="p">)</span>
					<span class="n">_print_next_block</span><span class="p">(</span><span class="n">par_num</span><span class="o">++</span><span class="p">,</span> <span class="s">&quot;DEBUG&quot;</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">AEU_INPUTS_ATTN_BITS_USDM_PARITY_ERROR</span>:
				<span class="k">if</span> <span class="p">(</span><span class="n">print</span><span class="p">)</span>
					<span class="n">_print_next_block</span><span class="p">(</span><span class="n">par_num</span><span class="o">++</span><span class="p">,</span> <span class="s">&quot;USDM&quot;</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">AEU_INPUTS_ATTN_BITS_UCM_PARITY_ERROR</span>:
				<span class="k">if</span> <span class="p">(</span><span class="n">print</span><span class="p">)</span>
					<span class="n">_print_next_block</span><span class="p">(</span><span class="n">par_num</span><span class="o">++</span><span class="p">,</span> <span class="s">&quot;UCM&quot;</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">AEU_INPUTS_ATTN_BITS_USEMI_PARITY_ERROR</span>:
				<span class="k">if</span> <span class="p">(</span><span class="n">print</span><span class="p">)</span>
					<span class="n">_print_next_block</span><span class="p">(</span><span class="n">par_num</span><span class="o">++</span><span class="p">,</span> <span class="s">&quot;USEMI&quot;</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">AEU_INPUTS_ATTN_BITS_UPB_PARITY_ERROR</span>:
				<span class="k">if</span> <span class="p">(</span><span class="n">print</span><span class="p">)</span>
					<span class="n">_print_next_block</span><span class="p">(</span><span class="n">par_num</span><span class="o">++</span><span class="p">,</span> <span class="s">&quot;UPB&quot;</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">AEU_INPUTS_ATTN_BITS_CSDM_PARITY_ERROR</span>:
				<span class="k">if</span> <span class="p">(</span><span class="n">print</span><span class="p">)</span>
					<span class="n">_print_next_block</span><span class="p">(</span><span class="n">par_num</span><span class="o">++</span><span class="p">,</span> <span class="s">&quot;CSDM&quot;</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">AEU_INPUTS_ATTN_BITS_CCM_PARITY_ERROR</span>:
				<span class="k">if</span> <span class="p">(</span><span class="n">print</span><span class="p">)</span>
					<span class="n">_print_next_block</span><span class="p">(</span><span class="n">par_num</span><span class="o">++</span><span class="p">,</span> <span class="s">&quot;CCM&quot;</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="cm">/* Clear the bit */</span>
			<span class="n">sig</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">cur_bit</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">par_num</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bnx2x_check_blocks_with_parity2</span><span class="p">(</span><span class="n">u32</span> <span class="n">sig</span><span class="p">,</span> <span class="kt">int</span> <span class="n">par_num</span><span class="p">,</span>
					   <span class="n">bool</span> <span class="n">print</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">cur_bit</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">sig</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cur_bit</span> <span class="o">=</span> <span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="mh">0x1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sig</span> <span class="o">&amp;</span> <span class="n">cur_bit</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">cur_bit</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">AEU_INPUTS_ATTN_BITS_CSEMI_PARITY_ERROR</span>:
				<span class="k">if</span> <span class="p">(</span><span class="n">print</span><span class="p">)</span>
					<span class="n">_print_next_block</span><span class="p">(</span><span class="n">par_num</span><span class="o">++</span><span class="p">,</span> <span class="s">&quot;CSEMI&quot;</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">AEU_INPUTS_ATTN_BITS_PXP_PARITY_ERROR</span>:
				<span class="k">if</span> <span class="p">(</span><span class="n">print</span><span class="p">)</span>
					<span class="n">_print_next_block</span><span class="p">(</span><span class="n">par_num</span><span class="o">++</span><span class="p">,</span> <span class="s">&quot;PXP&quot;</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">AEU_IN_ATTN_BITS_PXPPCICLOCKCLIENT_PARITY_ERROR</span>:
				<span class="k">if</span> <span class="p">(</span><span class="n">print</span><span class="p">)</span>
					<span class="n">_print_next_block</span><span class="p">(</span><span class="n">par_num</span><span class="o">++</span><span class="p">,</span>
					<span class="s">&quot;PXPPCICLOCKCLIENT&quot;</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">AEU_INPUTS_ATTN_BITS_CFC_PARITY_ERROR</span>:
				<span class="k">if</span> <span class="p">(</span><span class="n">print</span><span class="p">)</span>
					<span class="n">_print_next_block</span><span class="p">(</span><span class="n">par_num</span><span class="o">++</span><span class="p">,</span> <span class="s">&quot;CFC&quot;</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">AEU_INPUTS_ATTN_BITS_CDU_PARITY_ERROR</span>:
				<span class="k">if</span> <span class="p">(</span><span class="n">print</span><span class="p">)</span>
					<span class="n">_print_next_block</span><span class="p">(</span><span class="n">par_num</span><span class="o">++</span><span class="p">,</span> <span class="s">&quot;CDU&quot;</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">AEU_INPUTS_ATTN_BITS_DMAE_PARITY_ERROR</span>:
				<span class="k">if</span> <span class="p">(</span><span class="n">print</span><span class="p">)</span>
					<span class="n">_print_next_block</span><span class="p">(</span><span class="n">par_num</span><span class="o">++</span><span class="p">,</span> <span class="s">&quot;DMAE&quot;</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">AEU_INPUTS_ATTN_BITS_IGU_PARITY_ERROR</span>:
				<span class="k">if</span> <span class="p">(</span><span class="n">print</span><span class="p">)</span>
					<span class="n">_print_next_block</span><span class="p">(</span><span class="n">par_num</span><span class="o">++</span><span class="p">,</span> <span class="s">&quot;IGU&quot;</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">AEU_INPUTS_ATTN_BITS_MISC_PARITY_ERROR</span>:
				<span class="k">if</span> <span class="p">(</span><span class="n">print</span><span class="p">)</span>
					<span class="n">_print_next_block</span><span class="p">(</span><span class="n">par_num</span><span class="o">++</span><span class="p">,</span> <span class="s">&quot;MISC&quot;</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="cm">/* Clear the bit */</span>
			<span class="n">sig</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">cur_bit</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">par_num</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bnx2x_check_blocks_with_parity3</span><span class="p">(</span><span class="n">u32</span> <span class="n">sig</span><span class="p">,</span> <span class="kt">int</span> <span class="n">par_num</span><span class="p">,</span>
					   <span class="n">bool</span> <span class="o">*</span><span class="n">global</span><span class="p">,</span> <span class="n">bool</span> <span class="n">print</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">cur_bit</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">sig</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cur_bit</span> <span class="o">=</span> <span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="mh">0x1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sig</span> <span class="o">&amp;</span> <span class="n">cur_bit</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">cur_bit</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">AEU_INPUTS_ATTN_BITS_MCP_LATCHED_ROM_PARITY</span>:
				<span class="k">if</span> <span class="p">(</span><span class="n">print</span><span class="p">)</span>
					<span class="n">_print_next_block</span><span class="p">(</span><span class="n">par_num</span><span class="o">++</span><span class="p">,</span> <span class="s">&quot;MCP ROM&quot;</span><span class="p">);</span>
				<span class="o">*</span><span class="n">global</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">AEU_INPUTS_ATTN_BITS_MCP_LATCHED_UMP_RX_PARITY</span>:
				<span class="k">if</span> <span class="p">(</span><span class="n">print</span><span class="p">)</span>
					<span class="n">_print_next_block</span><span class="p">(</span><span class="n">par_num</span><span class="o">++</span><span class="p">,</span>
							  <span class="s">&quot;MCP UMP RX&quot;</span><span class="p">);</span>
				<span class="o">*</span><span class="n">global</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">AEU_INPUTS_ATTN_BITS_MCP_LATCHED_UMP_TX_PARITY</span>:
				<span class="k">if</span> <span class="p">(</span><span class="n">print</span><span class="p">)</span>
					<span class="n">_print_next_block</span><span class="p">(</span><span class="n">par_num</span><span class="o">++</span><span class="p">,</span>
							  <span class="s">&quot;MCP UMP TX&quot;</span><span class="p">);</span>
				<span class="o">*</span><span class="n">global</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">AEU_INPUTS_ATTN_BITS_MCP_LATCHED_SCPAD_PARITY</span>:
				<span class="k">if</span> <span class="p">(</span><span class="n">print</span><span class="p">)</span>
					<span class="n">_print_next_block</span><span class="p">(</span><span class="n">par_num</span><span class="o">++</span><span class="p">,</span>
							  <span class="s">&quot;MCP SCPAD&quot;</span><span class="p">);</span>
				<span class="o">*</span><span class="n">global</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="cm">/* Clear the bit */</span>
			<span class="n">sig</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">cur_bit</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">par_num</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bnx2x_check_blocks_with_parity4</span><span class="p">(</span><span class="n">u32</span> <span class="n">sig</span><span class="p">,</span> <span class="kt">int</span> <span class="n">par_num</span><span class="p">,</span>
					   <span class="n">bool</span> <span class="n">print</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">cur_bit</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">sig</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cur_bit</span> <span class="o">=</span> <span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="mh">0x1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sig</span> <span class="o">&amp;</span> <span class="n">cur_bit</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">cur_bit</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">AEU_INPUTS_ATTN_BITS_PGLUE_PARITY_ERROR</span>:
				<span class="k">if</span> <span class="p">(</span><span class="n">print</span><span class="p">)</span>
					<span class="n">_print_next_block</span><span class="p">(</span><span class="n">par_num</span><span class="o">++</span><span class="p">,</span> <span class="s">&quot;PGLUE_B&quot;</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">AEU_INPUTS_ATTN_BITS_ATC_PARITY_ERROR</span>:
				<span class="k">if</span> <span class="p">(</span><span class="n">print</span><span class="p">)</span>
					<span class="n">_print_next_block</span><span class="p">(</span><span class="n">par_num</span><span class="o">++</span><span class="p">,</span> <span class="s">&quot;ATC&quot;</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="cm">/* Clear the bit */</span>
			<span class="n">sig</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">cur_bit</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">par_num</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">bnx2x_parity_attn</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">,</span> <span class="n">bool</span> <span class="o">*</span><span class="n">global</span><span class="p">,</span> <span class="n">bool</span> <span class="n">print</span><span class="p">,</span>
			      <span class="n">u32</span> <span class="o">*</span><span class="n">sig</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">sig</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">HW_PRTY_ASSERT_SET_0</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">sig</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">HW_PRTY_ASSERT_SET_1</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">sig</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">HW_PRTY_ASSERT_SET_2</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">sig</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">HW_PRTY_ASSERT_SET_3</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">sig</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">HW_PRTY_ASSERT_SET_4</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">par_num</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_HW</span><span class="p">,</span> <span class="s">&quot;Was parity error: HW block parity attention:</span><span class="se">\n</span><span class="s">&quot;</span>
				 <span class="s">&quot;[0]:0x%08x [1]:0x%08x [2]:0x%08x [3]:0x%08x [4]:0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">sig</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">HW_PRTY_ASSERT_SET_0</span><span class="p">,</span>
			  <span class="n">sig</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">HW_PRTY_ASSERT_SET_1</span><span class="p">,</span>
			  <span class="n">sig</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">HW_PRTY_ASSERT_SET_2</span><span class="p">,</span>
			  <span class="n">sig</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">HW_PRTY_ASSERT_SET_3</span><span class="p">,</span>
			  <span class="n">sig</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">HW_PRTY_ASSERT_SET_4</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">print</span><span class="p">)</span>
			<span class="n">netdev_err</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				   <span class="s">&quot;Parity errors detected in blocks: &quot;</span><span class="p">);</span>
		<span class="n">par_num</span> <span class="o">=</span> <span class="n">bnx2x_check_blocks_with_parity0</span><span class="p">(</span>
			<span class="n">sig</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">HW_PRTY_ASSERT_SET_0</span><span class="p">,</span> <span class="n">par_num</span><span class="p">,</span> <span class="n">print</span><span class="p">);</span>
		<span class="n">par_num</span> <span class="o">=</span> <span class="n">bnx2x_check_blocks_with_parity1</span><span class="p">(</span>
			<span class="n">sig</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">HW_PRTY_ASSERT_SET_1</span><span class="p">,</span> <span class="n">par_num</span><span class="p">,</span> <span class="n">global</span><span class="p">,</span> <span class="n">print</span><span class="p">);</span>
		<span class="n">par_num</span> <span class="o">=</span> <span class="n">bnx2x_check_blocks_with_parity2</span><span class="p">(</span>
			<span class="n">sig</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">HW_PRTY_ASSERT_SET_2</span><span class="p">,</span> <span class="n">par_num</span><span class="p">,</span> <span class="n">print</span><span class="p">);</span>
		<span class="n">par_num</span> <span class="o">=</span> <span class="n">bnx2x_check_blocks_with_parity3</span><span class="p">(</span>
			<span class="n">sig</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">HW_PRTY_ASSERT_SET_3</span><span class="p">,</span> <span class="n">par_num</span><span class="p">,</span> <span class="n">global</span><span class="p">,</span> <span class="n">print</span><span class="p">);</span>
		<span class="n">par_num</span> <span class="o">=</span> <span class="n">bnx2x_check_blocks_with_parity4</span><span class="p">(</span>
			<span class="n">sig</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">HW_PRTY_ASSERT_SET_4</span><span class="p">,</span> <span class="n">par_num</span><span class="p">,</span> <span class="n">print</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">print</span><span class="p">)</span>
			<span class="n">pr_cont</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * bnx2x_chk_parity_attn - checks for parity attentions.</span>
<span class="cm"> *</span>
<span class="cm"> * @bp:		driver handle</span>
<span class="cm"> * @global:	true if there was a global attention</span>
<span class="cm"> * @print:	show parity attention in syslog</span>
<span class="cm"> */</span>
<span class="n">bool</span> <span class="nf">bnx2x_chk_parity_attn</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">,</span> <span class="n">bool</span> <span class="o">*</span><span class="n">global</span><span class="p">,</span> <span class="n">bool</span> <span class="n">print</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">attn_route</span> <span class="n">attn</span> <span class="o">=</span> <span class="p">{</span> <span class="p">{</span><span class="mi">0</span><span class="p">}</span> <span class="p">};</span>
	<span class="kt">int</span> <span class="n">port</span> <span class="o">=</span> <span class="n">BP_PORT</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>

	<span class="n">attn</span><span class="p">.</span><span class="n">sig</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span>
		<span class="n">MISC_REG_AEU_AFTER_INVERT_1_FUNC_0</span> <span class="o">+</span>
			     <span class="n">port</span><span class="o">*</span><span class="mi">4</span><span class="p">);</span>
	<span class="n">attn</span><span class="p">.</span><span class="n">sig</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span>
		<span class="n">MISC_REG_AEU_AFTER_INVERT_2_FUNC_0</span> <span class="o">+</span>
			     <span class="n">port</span><span class="o">*</span><span class="mi">4</span><span class="p">);</span>
	<span class="n">attn</span><span class="p">.</span><span class="n">sig</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span>
		<span class="n">MISC_REG_AEU_AFTER_INVERT_3_FUNC_0</span> <span class="o">+</span>
			     <span class="n">port</span><span class="o">*</span><span class="mi">4</span><span class="p">);</span>
	<span class="n">attn</span><span class="p">.</span><span class="n">sig</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span>
		<span class="n">MISC_REG_AEU_AFTER_INVERT_4_FUNC_0</span> <span class="o">+</span>
			     <span class="n">port</span><span class="o">*</span><span class="mi">4</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CHIP_IS_E1x</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span>
		<span class="n">attn</span><span class="p">.</span><span class="n">sig</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span>
			<span class="n">MISC_REG_AEU_AFTER_INVERT_5_FUNC_0</span> <span class="o">+</span>
				     <span class="n">port</span><span class="o">*</span><span class="mi">4</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">bnx2x_parity_attn</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">global</span><span class="p">,</span> <span class="n">print</span><span class="p">,</span> <span class="n">attn</span><span class="p">.</span><span class="n">sig</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_attn_int_deasserted4</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">,</span> <span class="n">u32</span> <span class="n">attn</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">attn</span> <span class="o">&amp;</span> <span class="n">AEU_INPUTS_ATTN_BITS_PGLUE_HW_INTERRUPT</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">val</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">PGLUE_B_REG_PGLUE_B_INT_STS_CLR</span><span class="p">);</span>
		<span class="n">BNX2X_ERR</span><span class="p">(</span><span class="s">&quot;PGLUE hw attention 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">PGLUE_B_PGLUE_B_INT_STS_REG_ADDRESS_ERROR</span><span class="p">)</span>
			<span class="n">BNX2X_ERR</span><span class="p">(</span><span class="s">&quot;PGLUE_B_PGLUE_B_INT_STS_REG_ADDRESS_ERROR</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">PGLUE_B_PGLUE_B_INT_STS_REG_INCORRECT_RCV_BEHAVIOR</span><span class="p">)</span>
			<span class="n">BNX2X_ERR</span><span class="p">(</span><span class="s">&quot;PGLUE_B_PGLUE_B_INT_STS_REG_INCORRECT_RCV_BEHAVIOR</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">PGLUE_B_PGLUE_B_INT_STS_REG_WAS_ERROR_ATTN</span><span class="p">)</span>
			<span class="n">BNX2X_ERR</span><span class="p">(</span><span class="s">&quot;PGLUE_B_PGLUE_B_INT_STS_REG_WAS_ERROR_ATTN</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">PGLUE_B_PGLUE_B_INT_STS_REG_VF_LENGTH_VIOLATION_ATTN</span><span class="p">)</span>
			<span class="n">BNX2X_ERR</span><span class="p">(</span><span class="s">&quot;PGLUE_B_PGLUE_B_INT_STS_REG_VF_LENGTH_VIOLATION_ATTN</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span>
		    <span class="n">PGLUE_B_PGLUE_B_INT_STS_REG_VF_GRC_SPACE_VIOLATION_ATTN</span><span class="p">)</span>
			<span class="n">BNX2X_ERR</span><span class="p">(</span><span class="s">&quot;PGLUE_B_PGLUE_B_INT_STS_REG_VF_GRC_SPACE_VIOLATION_ATTN</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span>
		    <span class="n">PGLUE_B_PGLUE_B_INT_STS_REG_VF_MSIX_BAR_VIOLATION_ATTN</span><span class="p">)</span>
			<span class="n">BNX2X_ERR</span><span class="p">(</span><span class="s">&quot;PGLUE_B_PGLUE_B_INT_STS_REG_VF_MSIX_BAR_VIOLATION_ATTN</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">PGLUE_B_PGLUE_B_INT_STS_REG_TCPL_ERROR_ATTN</span><span class="p">)</span>
			<span class="n">BNX2X_ERR</span><span class="p">(</span><span class="s">&quot;PGLUE_B_PGLUE_B_INT_STS_REG_TCPL_ERROR_ATTN</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">PGLUE_B_PGLUE_B_INT_STS_REG_TCPL_IN_TWO_RCBS_ATTN</span><span class="p">)</span>
			<span class="n">BNX2X_ERR</span><span class="p">(</span><span class="s">&quot;PGLUE_B_PGLUE_B_INT_STS_REG_TCPL_IN_TWO_RCBS_ATTN</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">PGLUE_B_PGLUE_B_INT_STS_REG_CSSNOOP_FIFO_OVERFLOW</span><span class="p">)</span>
			<span class="n">BNX2X_ERR</span><span class="p">(</span><span class="s">&quot;PGLUE_B_PGLUE_B_INT_STS_REG_CSSNOOP_FIFO_OVERFLOW</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">attn</span> <span class="o">&amp;</span> <span class="n">AEU_INPUTS_ATTN_BITS_ATC_HW_INTERRUPT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">ATC_REG_ATC_INT_STS_CLR</span><span class="p">);</span>
		<span class="n">BNX2X_ERR</span><span class="p">(</span><span class="s">&quot;ATC hw attention 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">ATC_ATC_INT_STS_REG_ADDRESS_ERROR</span><span class="p">)</span>
			<span class="n">BNX2X_ERR</span><span class="p">(</span><span class="s">&quot;ATC_ATC_INT_STS_REG_ADDRESS_ERROR</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">ATC_ATC_INT_STS_REG_ATC_TCPL_TO_NOT_PEND</span><span class="p">)</span>
			<span class="n">BNX2X_ERR</span><span class="p">(</span><span class="s">&quot;ATC_ATC_INT_STS_REG_ATC_TCPL_TO_NOT_PEND</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">ATC_ATC_INT_STS_REG_ATC_GPA_MULTIPLE_HITS</span><span class="p">)</span>
			<span class="n">BNX2X_ERR</span><span class="p">(</span><span class="s">&quot;ATC_ATC_INT_STS_REG_ATC_GPA_MULTIPLE_HITS</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">ATC_ATC_INT_STS_REG_ATC_RCPL_TO_EMPTY_CNT</span><span class="p">)</span>
			<span class="n">BNX2X_ERR</span><span class="p">(</span><span class="s">&quot;ATC_ATC_INT_STS_REG_ATC_RCPL_TO_EMPTY_CNT</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">ATC_ATC_INT_STS_REG_ATC_TCPL_ERROR</span><span class="p">)</span>
			<span class="n">BNX2X_ERR</span><span class="p">(</span><span class="s">&quot;ATC_ATC_INT_STS_REG_ATC_TCPL_ERROR</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">ATC_ATC_INT_STS_REG_ATC_IREQ_LESS_THAN_STU</span><span class="p">)</span>
			<span class="n">BNX2X_ERR</span><span class="p">(</span><span class="s">&quot;ATC_ATC_INT_STS_REG_ATC_IREQ_LESS_THAN_STU</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">attn</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">AEU_INPUTS_ATTN_BITS_PGLUE_PARITY_ERROR</span> <span class="o">|</span>
		    <span class="n">AEU_INPUTS_ATTN_BITS_ATC_PARITY_ERROR</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">BNX2X_ERR</span><span class="p">(</span><span class="s">&quot;FATAL parity attention set4 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">u32</span><span class="p">)(</span><span class="n">attn</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">AEU_INPUTS_ATTN_BITS_PGLUE_PARITY_ERROR</span> <span class="o">|</span>
		    <span class="n">AEU_INPUTS_ATTN_BITS_ATC_PARITY_ERROR</span><span class="p">)));</span>
	<span class="p">}</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_attn_int_deasserted</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">,</span> <span class="n">u32</span> <span class="n">deasserted</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">attn_route</span> <span class="n">attn</span><span class="p">,</span> <span class="o">*</span><span class="n">group_mask</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">port</span> <span class="o">=</span> <span class="n">BP_PORT</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">index</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">reg_addr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">aeu_mask</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">global</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="cm">/* need to take HW lock because MCP or other port might also</span>
<span class="cm">	   try to handle this event */</span>
	<span class="n">bnx2x_acquire_alr</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bnx2x_chk_parity_attn</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">global</span><span class="p">,</span> <span class="nb">true</span><span class="p">))</span> <span class="p">{</span>
<span class="cp">#ifndef BNX2X_STOP_ON_ERROR</span>
		<span class="n">bp</span><span class="o">-&gt;</span><span class="n">recovery_state</span> <span class="o">=</span> <span class="n">BNX2X_RECOVERY_INIT</span><span class="p">;</span>
		<span class="n">schedule_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">sp_rtnl_task</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="cm">/* Disable HW interrupts */</span>
		<span class="n">bnx2x_int_disable</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
		<span class="cm">/* In case of parity errors don&#39;t handle attentions so that</span>
<span class="cm">		 * other function would &quot;see&quot; parity errors.</span>
<span class="cm">		 */</span>
<span class="cp">#else</span>
		<span class="n">bnx2x_panic</span><span class="p">();</span>
<span class="cp">#endif</span>
		<span class="n">bnx2x_release_alr</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">attn</span><span class="p">.</span><span class="n">sig</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">MISC_REG_AEU_AFTER_INVERT_1_FUNC_0</span> <span class="o">+</span> <span class="n">port</span><span class="o">*</span><span class="mi">4</span><span class="p">);</span>
	<span class="n">attn</span><span class="p">.</span><span class="n">sig</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">MISC_REG_AEU_AFTER_INVERT_2_FUNC_0</span> <span class="o">+</span> <span class="n">port</span><span class="o">*</span><span class="mi">4</span><span class="p">);</span>
	<span class="n">attn</span><span class="p">.</span><span class="n">sig</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">MISC_REG_AEU_AFTER_INVERT_3_FUNC_0</span> <span class="o">+</span> <span class="n">port</span><span class="o">*</span><span class="mi">4</span><span class="p">);</span>
	<span class="n">attn</span><span class="p">.</span><span class="n">sig</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">MISC_REG_AEU_AFTER_INVERT_4_FUNC_0</span> <span class="o">+</span> <span class="n">port</span><span class="o">*</span><span class="mi">4</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CHIP_IS_E1x</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span>
		<span class="n">attn</span><span class="p">.</span><span class="n">sig</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span>
		      <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">MISC_REG_AEU_AFTER_INVERT_5_FUNC_0</span> <span class="o">+</span> <span class="n">port</span><span class="o">*</span><span class="mi">4</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">attn</span><span class="p">.</span><span class="n">sig</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_HW</span><span class="p">,</span> <span class="s">&quot;attn: %08x %08x %08x %08x %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	   <span class="n">attn</span><span class="p">.</span><span class="n">sig</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">attn</span><span class="p">.</span><span class="n">sig</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">attn</span><span class="p">.</span><span class="n">sig</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">attn</span><span class="p">.</span><span class="n">sig</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">attn</span><span class="p">.</span><span class="n">sig</span><span class="p">[</span><span class="mi">4</span><span class="p">]);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">index</span> <span class="o">&lt;</span> <span class="n">MAX_DYNAMIC_ATTN_GRPS</span><span class="p">;</span> <span class="n">index</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">deasserted</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">index</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">group_mask</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">attn_group</span><span class="p">[</span><span class="n">index</span><span class="p">];</span>

			<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_HW</span><span class="p">,</span> <span class="s">&quot;group[%d]: %08x %08x %08x %08x %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">index</span><span class="p">,</span>
			   <span class="n">group_mask</span><span class="o">-&gt;</span><span class="n">sig</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">group_mask</span><span class="o">-&gt;</span><span class="n">sig</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
			   <span class="n">group_mask</span><span class="o">-&gt;</span><span class="n">sig</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">group_mask</span><span class="o">-&gt;</span><span class="n">sig</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
			   <span class="n">group_mask</span><span class="o">-&gt;</span><span class="n">sig</span><span class="p">[</span><span class="mi">4</span><span class="p">]);</span>

			<span class="n">bnx2x_attn_int_deasserted4</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span>
					<span class="n">attn</span><span class="p">.</span><span class="n">sig</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">group_mask</span><span class="o">-&gt;</span><span class="n">sig</span><span class="p">[</span><span class="mi">4</span><span class="p">]);</span>
			<span class="n">bnx2x_attn_int_deasserted3</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span>
					<span class="n">attn</span><span class="p">.</span><span class="n">sig</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">group_mask</span><span class="o">-&gt;</span><span class="n">sig</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
			<span class="n">bnx2x_attn_int_deasserted1</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span>
					<span class="n">attn</span><span class="p">.</span><span class="n">sig</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">group_mask</span><span class="o">-&gt;</span><span class="n">sig</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
			<span class="n">bnx2x_attn_int_deasserted2</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span>
					<span class="n">attn</span><span class="p">.</span><span class="n">sig</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">group_mask</span><span class="o">-&gt;</span><span class="n">sig</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
			<span class="n">bnx2x_attn_int_deasserted0</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span>
					<span class="n">attn</span><span class="p">.</span><span class="n">sig</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">group_mask</span><span class="o">-&gt;</span><span class="n">sig</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">bnx2x_release_alr</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">.</span><span class="n">int_block</span> <span class="o">==</span> <span class="n">INT_BLOCK_HC</span><span class="p">)</span>
		<span class="n">reg_addr</span> <span class="o">=</span> <span class="p">(</span><span class="n">HC_REG_COMMAND_REG</span> <span class="o">+</span> <span class="n">port</span><span class="o">*</span><span class="mi">32</span> <span class="o">+</span>
			    <span class="n">COMMAND_REG_ATTN_BITS_CLR</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">reg_addr</span> <span class="o">=</span> <span class="p">(</span><span class="n">BAR_IGU_INTMEM</span> <span class="o">+</span> <span class="n">IGU_CMD_ATTN_BIT_CLR_UPPER</span><span class="o">*</span><span class="mi">8</span><span class="p">);</span>

	<span class="n">val</span> <span class="o">=</span> <span class="o">~</span><span class="n">deasserted</span><span class="p">;</span>
	<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_HW</span><span class="p">,</span> <span class="s">&quot;about to mask 0x%08x at %s addr 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span>
	   <span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">.</span><span class="n">int_block</span> <span class="o">==</span> <span class="n">INT_BLOCK_HC</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;HC&quot;</span> <span class="o">:</span> <span class="s">&quot;IGU&quot;</span><span class="p">,</span> <span class="n">reg_addr</span><span class="p">);</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">reg_addr</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">~</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">attn_state</span> <span class="o">&amp;</span> <span class="n">deasserted</span><span class="p">)</span>
		<span class="n">BNX2X_ERR</span><span class="p">(</span><span class="s">&quot;IGU ERROR</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">reg_addr</span> <span class="o">=</span> <span class="n">port</span> <span class="o">?</span> <span class="n">MISC_REG_AEU_MASK_ATTN_FUNC_1</span> <span class="o">:</span>
			  <span class="n">MISC_REG_AEU_MASK_ATTN_FUNC_0</span><span class="p">;</span>

	<span class="n">bnx2x_acquire_hw_lock</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">HW_LOCK_RESOURCE_PORT0_ATT_MASK</span> <span class="o">+</span> <span class="n">port</span><span class="p">);</span>
	<span class="n">aeu_mask</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">reg_addr</span><span class="p">);</span>

	<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_HW</span><span class="p">,</span> <span class="s">&quot;aeu_mask %x  newly deasserted %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	   <span class="n">aeu_mask</span><span class="p">,</span> <span class="n">deasserted</span><span class="p">);</span>
	<span class="n">aeu_mask</span> <span class="o">|=</span> <span class="p">(</span><span class="n">deasserted</span> <span class="o">&amp;</span> <span class="mh">0x3ff</span><span class="p">);</span>
	<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_HW</span><span class="p">,</span> <span class="s">&quot;new mask %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">aeu_mask</span><span class="p">);</span>

	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">reg_addr</span><span class="p">,</span> <span class="n">aeu_mask</span><span class="p">);</span>
	<span class="n">bnx2x_release_hw_lock</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">HW_LOCK_RESOURCE_PORT0_ATT_MASK</span> <span class="o">+</span> <span class="n">port</span><span class="p">);</span>

	<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_HW</span><span class="p">,</span> <span class="s">&quot;attn_state %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">attn_state</span><span class="p">);</span>
	<span class="n">bp</span><span class="o">-&gt;</span><span class="n">attn_state</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">deasserted</span><span class="p">;</span>
	<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_HW</span><span class="p">,</span> <span class="s">&quot;new state %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">attn_state</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_attn_int</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* read local copy of bits */</span>
	<span class="n">u32</span> <span class="n">attn_bits</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">def_status_blk</span><span class="o">-&gt;</span><span class="n">atten_status_block</span><span class="p">.</span>
								<span class="n">attn_bits</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">attn_ack</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">def_status_blk</span><span class="o">-&gt;</span><span class="n">atten_status_block</span><span class="p">.</span>
								<span class="n">attn_bits_ack</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">attn_state</span> <span class="o">=</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">attn_state</span><span class="p">;</span>

	<span class="cm">/* look for changed bits */</span>
	<span class="n">u32</span> <span class="n">asserted</span>   <span class="o">=</span>  <span class="n">attn_bits</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">attn_ack</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">attn_state</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">deasserted</span> <span class="o">=</span> <span class="o">~</span><span class="n">attn_bits</span> <span class="o">&amp;</span>  <span class="n">attn_ack</span> <span class="o">&amp;</span>  <span class="n">attn_state</span><span class="p">;</span>

	<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_HW</span><span class="p">,</span>
	   <span class="s">&quot;attn_bits %x  attn_ack %x  asserted %x  deasserted %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	   <span class="n">attn_bits</span><span class="p">,</span> <span class="n">attn_ack</span><span class="p">,</span> <span class="n">asserted</span><span class="p">,</span> <span class="n">deasserted</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">~</span><span class="p">(</span><span class="n">attn_bits</span> <span class="o">^</span> <span class="n">attn_ack</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">attn_bits</span> <span class="o">^</span> <span class="n">attn_state</span><span class="p">))</span>
		<span class="n">BNX2X_ERR</span><span class="p">(</span><span class="s">&quot;BAD attention state</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* handle bits that were raised */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">asserted</span><span class="p">)</span>
		<span class="n">bnx2x_attn_int_asserted</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">asserted</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">deasserted</span><span class="p">)</span>
		<span class="n">bnx2x_attn_int_deasserted</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">deasserted</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">bnx2x_igu_ack_sb</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">,</span> <span class="n">u8</span> <span class="n">igu_sb_id</span><span class="p">,</span> <span class="n">u8</span> <span class="n">segment</span><span class="p">,</span>
		      <span class="n">u16</span> <span class="n">index</span><span class="p">,</span> <span class="n">u8</span> <span class="n">op</span><span class="p">,</span> <span class="n">u8</span> <span class="n">update</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">igu_addr</span> <span class="o">=</span> <span class="n">BAR_IGU_INTMEM</span> <span class="o">+</span> <span class="p">(</span><span class="n">IGU_CMD_INT_ACK_BASE</span> <span class="o">+</span> <span class="n">igu_sb_id</span><span class="p">)</span><span class="o">*</span><span class="mi">8</span><span class="p">;</span>

	<span class="n">bnx2x_igu_ack_sb_gen</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">igu_sb_id</span><span class="p">,</span> <span class="n">segment</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">op</span><span class="p">,</span> <span class="n">update</span><span class="p">,</span>
			     <span class="n">igu_addr</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_update_eq_prod</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">,</span> <span class="n">u16</span> <span class="n">prod</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* No memory barriers */</span>
	<span class="n">storm_memset_eq_prod</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">prod</span><span class="p">,</span> <span class="n">BP_FUNC</span><span class="p">(</span><span class="n">bp</span><span class="p">));</span>
	<span class="n">mmiowb</span><span class="p">();</span> <span class="cm">/* keep prod updates ordered */</span>
<span class="p">}</span>

<span class="cp">#ifdef BCM_CNIC</span>
<span class="k">static</span> <span class="kt">int</span>  <span class="nf">bnx2x_cnic_handle_cfc_del</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">,</span> <span class="n">u32</span> <span class="n">cid</span><span class="p">,</span>
				      <span class="k">union</span> <span class="n">event_ring_elem</span> <span class="o">*</span><span class="n">elem</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">err</span> <span class="o">=</span> <span class="n">elem</span><span class="o">-&gt;</span><span class="n">message</span><span class="p">.</span><span class="n">error</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">cnic_eth_dev</span><span class="p">.</span><span class="n">starting_cid</span>  <span class="o">||</span>
	    <span class="p">(</span><span class="n">cid</span> <span class="o">&lt;</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">cnic_eth_dev</span><span class="p">.</span><span class="n">starting_cid</span> <span class="o">&amp;&amp;</span>
	    <span class="n">cid</span> <span class="o">!=</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">cnic_eth_dev</span><span class="p">.</span><span class="n">iscsi_l2_cid</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">DP</span><span class="p">(</span><span class="n">BNX2X_MSG_SP</span><span class="p">,</span> <span class="s">&quot;got delete ramrod for CNIC CID %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cid</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">err</span><span class="p">))</span> <span class="p">{</span>

		<span class="n">BNX2X_ERR</span><span class="p">(</span><span class="s">&quot;got delete ramrod for CNIC CID %d with error!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">cid</span><span class="p">);</span>
		<span class="n">bnx2x_panic_dump</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">bnx2x_cnic_cfc_comp</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">cid</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_handle_mcast_eqe</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2x_mcast_ramrod_params</span> <span class="n">rparam</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rparam</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">rparam</span><span class="p">));</span>

	<span class="n">rparam</span><span class="p">.</span><span class="n">mcast_obj</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">mcast_obj</span><span class="p">;</span>

	<span class="n">netif_addr_lock_bh</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* Clear pending state for the last command */</span>
	<span class="n">bp</span><span class="o">-&gt;</span><span class="n">mcast_obj</span><span class="p">.</span><span class="n">raw</span><span class="p">.</span><span class="n">clear_pending</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">mcast_obj</span><span class="p">.</span><span class="n">raw</span><span class="p">);</span>

	<span class="cm">/* If there are pending mcast commands - send them */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">mcast_obj</span><span class="p">.</span><span class="n">check_pending</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">mcast_obj</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">bnx2x_config_mcast</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rparam</span><span class="p">,</span> <span class="n">BNX2X_MCAST_CMD_CONT</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">BNX2X_ERR</span><span class="p">(</span><span class="s">&quot;Failed to send pending mcast commands: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				  <span class="n">rc</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">netif_addr_unlock_bh</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_handle_classification_eqe</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">,</span>
					    <span class="k">union</span> <span class="n">event_ring_elem</span> <span class="o">*</span><span class="n">elem</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ramrod_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">cid</span> <span class="o">=</span> <span class="n">elem</span><span class="o">-&gt;</span><span class="n">message</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">eth_event</span><span class="p">.</span><span class="n">echo</span> <span class="o">&amp;</span> <span class="n">BNX2X_SWCID_MASK</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bnx2x_vlan_mac_obj</span> <span class="o">*</span><span class="n">vlan_mac_obj</span><span class="p">;</span>

	<span class="cm">/* Always push next commands out, don&#39;t wait here */</span>
	<span class="n">__set_bit</span><span class="p">(</span><span class="n">RAMROD_CONT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ramrod_flags</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">elem</span><span class="o">-&gt;</span><span class="n">message</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">eth_event</span><span class="p">.</span><span class="n">echo</span> <span class="o">&gt;&gt;</span> <span class="n">BNX2X_SWCID_SHIFT</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">BNX2X_FILTER_MAC_PENDING</span>:
		<span class="n">DP</span><span class="p">(</span><span class="n">BNX2X_MSG_SP</span><span class="p">,</span> <span class="s">&quot;Got SETUP_MAC completions</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#ifdef BCM_CNIC</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cid</span> <span class="o">==</span> <span class="n">BNX2X_ISCSI_ETH_CID</span><span class="p">)</span>
			<span class="n">vlan_mac_obj</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">iscsi_l2_mac_obj</span><span class="p">;</span>
		<span class="k">else</span>
<span class="cp">#endif</span>
			<span class="n">vlan_mac_obj</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">fp</span><span class="p">[</span><span class="n">cid</span><span class="p">].</span><span class="n">mac_obj</span><span class="p">;</span>

		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">BNX2X_FILTER_MCAST_PENDING</span>:
		<span class="n">DP</span><span class="p">(</span><span class="n">BNX2X_MSG_SP</span><span class="p">,</span> <span class="s">&quot;Got SETUP_MCAST completions</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="cm">/* This is only relevant for 57710 where multicast MACs are</span>
<span class="cm">		 * configured as unicast MACs using the same ramrod.</span>
<span class="cm">		 */</span>
		<span class="n">bnx2x_handle_mcast_eqe</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">BNX2X_ERR</span><span class="p">(</span><span class="s">&quot;Unsupported classification command: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">elem</span><span class="o">-&gt;</span><span class="n">message</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">eth_event</span><span class="p">.</span><span class="n">echo</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">vlan_mac_obj</span><span class="o">-&gt;</span><span class="n">complete</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">vlan_mac_obj</span><span class="p">,</span> <span class="n">elem</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ramrod_flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">BNX2X_ERR</span><span class="p">(</span><span class="s">&quot;Failed to schedule new commands: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">DP</span><span class="p">(</span><span class="n">BNX2X_MSG_SP</span><span class="p">,</span> <span class="s">&quot;Scheduled next pending commands...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

<span class="p">}</span>

<span class="cp">#ifdef BCM_CNIC</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">bnx2x_set_iscsi_eth_rx_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">,</span> <span class="n">bool</span> <span class="n">start</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_handle_rx_mode_eqe</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">netif_addr_lock_bh</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">clear_bit</span><span class="p">(</span><span class="n">BNX2X_FILTER_RX_MODE_PENDING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">sp_state</span><span class="p">);</span>

	<span class="cm">/* Send rx_mode command again if was requested */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">BNX2X_FILTER_RX_MODE_SCHED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">sp_state</span><span class="p">))</span>
		<span class="n">bnx2x_set_storm_rx_mode</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
<span class="cp">#ifdef BCM_CNIC</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">BNX2X_FILTER_ISCSI_ETH_START_SCHED</span><span class="p">,</span>
				    <span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">sp_state</span><span class="p">))</span>
		<span class="n">bnx2x_set_iscsi_eth_rx_mode</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">BNX2X_FILTER_ISCSI_ETH_STOP_SCHED</span><span class="p">,</span>
				    <span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">sp_state</span><span class="p">))</span>
		<span class="n">bnx2x_set_iscsi_eth_rx_mode</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="n">netif_addr_unlock_bh</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_after_afex_vif_lists</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">,</span>
					      <span class="k">union</span> <span class="n">event_ring_elem</span> <span class="o">*</span><span class="n">elem</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">elem</span><span class="o">-&gt;</span><span class="n">message</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">vif_list_event</span><span class="p">.</span><span class="n">echo</span> <span class="o">==</span> <span class="n">VIF_LIST_RULE_GET</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DP</span><span class="p">(</span><span class="n">BNX2X_MSG_SP</span><span class="p">,</span>
		   <span class="s">&quot;afex: ramrod completed VIF LIST_GET, addrs 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">elem</span><span class="o">-&gt;</span><span class="n">message</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">vif_list_event</span><span class="p">.</span><span class="n">func_bit_map</span><span class="p">);</span>
		<span class="n">bnx2x_fw_command</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">DRV_MSG_CODE_AFEX_LISTGET_ACK</span><span class="p">,</span>
			<span class="n">elem</span><span class="o">-&gt;</span><span class="n">message</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">vif_list_event</span><span class="p">.</span><span class="n">func_bit_map</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">elem</span><span class="o">-&gt;</span><span class="n">message</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">vif_list_event</span><span class="p">.</span><span class="n">echo</span> <span class="o">==</span>
		   <span class="n">VIF_LIST_RULE_SET</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DP</span><span class="p">(</span><span class="n">BNX2X_MSG_SP</span><span class="p">,</span> <span class="s">&quot;afex: ramrod completed VIF LIST_SET</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">bnx2x_fw_command</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">DRV_MSG_CODE_AFEX_LISTSET_ACK</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* called with rtnl_lock */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_after_function_update</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">q</span><span class="p">,</span> <span class="n">rc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bnx2x_fastpath</span> <span class="o">*</span><span class="n">fp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bnx2x_queue_state_params</span> <span class="n">queue_params</span> <span class="o">=</span> <span class="p">{</span><span class="nb">NULL</span><span class="p">};</span>
	<span class="k">struct</span> <span class="n">bnx2x_queue_update_params</span> <span class="o">*</span><span class="n">q_update_params</span> <span class="o">=</span>
		<span class="o">&amp;</span><span class="n">queue_params</span><span class="p">.</span><span class="n">params</span><span class="p">.</span><span class="n">update</span><span class="p">;</span>

	<span class="cm">/* Send Q update command with afex vlan removal values	for all Qs */</span>
	<span class="n">queue_params</span><span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">BNX2X_Q_CMD_UPDATE</span><span class="p">;</span>

	<span class="cm">/* set silent vlan removal values according to vlan mode */</span>
	<span class="n">__set_bit</span><span class="p">(</span><span class="n">BNX2X_Q_UPDATE_SILENT_VLAN_REM_CHNG</span><span class="p">,</span>
		  <span class="o">&amp;</span><span class="n">q_update_params</span><span class="o">-&gt;</span><span class="n">update_flags</span><span class="p">);</span>
	<span class="n">__set_bit</span><span class="p">(</span><span class="n">BNX2X_Q_UPDATE_SILENT_VLAN_REM</span><span class="p">,</span>
		  <span class="o">&amp;</span><span class="n">q_update_params</span><span class="o">-&gt;</span><span class="n">update_flags</span><span class="p">);</span>
	<span class="n">__set_bit</span><span class="p">(</span><span class="n">RAMROD_COMP_WAIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">queue_params</span><span class="p">.</span><span class="n">ramrod_flags</span><span class="p">);</span>

	<span class="cm">/* in access mode mark mask and value are 0 to strip all vlans */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">afex_vlan_mode</span> <span class="o">==</span> <span class="n">FUNC_MF_CFG_AFEX_VLAN_ACCESS_MODE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">q_update_params</span><span class="o">-&gt;</span><span class="n">silent_removal_value</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">q_update_params</span><span class="o">-&gt;</span><span class="n">silent_removal_mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">q_update_params</span><span class="o">-&gt;</span><span class="n">silent_removal_value</span> <span class="o">=</span>
			<span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">afex_def_vlan_tag</span> <span class="o">&amp;</span> <span class="n">VLAN_VID_MASK</span><span class="p">);</span>
		<span class="n">q_update_params</span><span class="o">-&gt;</span><span class="n">silent_removal_mask</span> <span class="o">=</span> <span class="n">VLAN_VID_MASK</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">for_each_eth_queue</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">q</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Set the appropriate Queue object */</span>
		<span class="n">fp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">fp</span><span class="p">[</span><span class="n">q</span><span class="p">];</span>
		<span class="n">queue_params</span><span class="p">.</span><span class="n">q_obj</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">q_obj</span><span class="p">;</span>

		<span class="cm">/* send the ramrod */</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">bnx2x_queue_state_change</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">queue_params</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">BNX2X_ERR</span><span class="p">(</span><span class="s">&quot;Failed to config silent vlan rem for Q %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				  <span class="n">q</span><span class="p">);</span>
	<span class="p">}</span>

<span class="cp">#ifdef BCM_CNIC</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">NO_FCOE</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">fp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">fp</span><span class="p">[</span><span class="n">FCOE_IDX</span><span class="p">];</span>
		<span class="n">queue_params</span><span class="p">.</span><span class="n">q_obj</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">q_obj</span><span class="p">;</span>

		<span class="cm">/* clear pending completion bit */</span>
		<span class="n">__clear_bit</span><span class="p">(</span><span class="n">RAMROD_COMP_WAIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">queue_params</span><span class="p">.</span><span class="n">ramrod_flags</span><span class="p">);</span>

		<span class="cm">/* mark latest Q bit */</span>
		<span class="n">smp_mb__before_clear_bit</span><span class="p">();</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">BNX2X_AFEX_FCOE_Q_UPDATE_PENDING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">sp_state</span><span class="p">);</span>
		<span class="n">smp_mb__after_clear_bit</span><span class="p">();</span>

		<span class="cm">/* send Q update ramrod for FCoE Q */</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">bnx2x_queue_state_change</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">queue_params</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">BNX2X_ERR</span><span class="p">(</span><span class="s">&quot;Failed to config silent vlan rem for Q %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				  <span class="n">q</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* If no FCoE ring - ACK MCP now */</span>
		<span class="n">bnx2x_link_report</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
		<span class="n">bnx2x_fw_command</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">DRV_MSG_CODE_AFEX_VIFSET_ACK</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#else</span>
	<span class="cm">/* If no FCoE ring - ACK MCP now */</span>
	<span class="n">bnx2x_link_report</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
	<span class="n">bnx2x_fw_command</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">DRV_MSG_CODE_AFEX_VIFSET_ACK</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="cp">#endif </span><span class="cm">/* BCM_CNIC */</span><span class="cp"></span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">bnx2x_queue_sp_obj</span> <span class="o">*</span><span class="nf">bnx2x_cid_to_q_obj</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">,</span> <span class="n">u32</span> <span class="n">cid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DP</span><span class="p">(</span><span class="n">BNX2X_MSG_SP</span><span class="p">,</span> <span class="s">&quot;retrieving fp from cid %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cid</span><span class="p">);</span>
<span class="cp">#ifdef BCM_CNIC</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cid</span> <span class="o">==</span> <span class="n">BNX2X_FCOE_ETH_CID</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">&amp;</span><span class="n">bnx2x_fcoe</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">q_obj</span><span class="p">);</span>
	<span class="k">else</span>
<span class="cp">#endif</span>
		<span class="k">return</span> <span class="o">&amp;</span><span class="n">bnx2x_fp</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">CID_TO_FP</span><span class="p">(</span><span class="n">cid</span><span class="p">),</span> <span class="n">q_obj</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_eq_int</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">hw_cons</span><span class="p">,</span> <span class="n">sw_cons</span><span class="p">,</span> <span class="n">sw_prod</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">event_ring_elem</span> <span class="o">*</span><span class="n">elem</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">cid</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">opcode</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">spqe_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bnx2x_queue_sp_obj</span> <span class="o">*</span><span class="n">q_obj</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bnx2x_func_sp_obj</span> <span class="o">*</span><span class="n">f_obj</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">func_obj</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bnx2x_raw_obj</span> <span class="o">*</span><span class="n">rss_raw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">rss_conf_obj</span><span class="p">.</span><span class="n">raw</span><span class="p">;</span>

	<span class="n">hw_cons</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="o">*</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">eq_cons_sb</span><span class="p">);</span>

	<span class="cm">/* The hw_cos range is 1-255, 257 - the sw_cons range is 0-254, 256.</span>
<span class="cm">	 * when we get the the next-page we nned to adjust so the loop</span>
<span class="cm">	 * condition below will be met. The next element is the size of a</span>
<span class="cm">	 * regular element and hence incrementing by 1</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">hw_cons</span> <span class="o">&amp;</span> <span class="n">EQ_DESC_MAX_PAGE</span><span class="p">)</span> <span class="o">==</span> <span class="n">EQ_DESC_MAX_PAGE</span><span class="p">)</span>
		<span class="n">hw_cons</span><span class="o">++</span><span class="p">;</span>

	<span class="cm">/* This function may never run in parallel with itself for a</span>
<span class="cm">	 * specific bp, thus there is no need in &quot;paired&quot; read memory</span>
<span class="cm">	 * barrier here.</span>
<span class="cm">	 */</span>
	<span class="n">sw_cons</span> <span class="o">=</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">eq_cons</span><span class="p">;</span>
	<span class="n">sw_prod</span> <span class="o">=</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">eq_prod</span><span class="p">;</span>

	<span class="n">DP</span><span class="p">(</span><span class="n">BNX2X_MSG_SP</span><span class="p">,</span> <span class="s">&quot;EQ:  hw_cons %u  sw_cons %u bp-&gt;eq_spq_left %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">hw_cons</span><span class="p">,</span> <span class="n">sw_cons</span><span class="p">,</span> <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">eq_spq_left</span><span class="p">));</span>

	<span class="k">for</span> <span class="p">(;</span> <span class="n">sw_cons</span> <span class="o">!=</span> <span class="n">hw_cons</span><span class="p">;</span>
	      <span class="n">sw_prod</span> <span class="o">=</span> <span class="n">NEXT_EQ_IDX</span><span class="p">(</span><span class="n">sw_prod</span><span class="p">),</span> <span class="n">sw_cons</span> <span class="o">=</span> <span class="n">NEXT_EQ_IDX</span><span class="p">(</span><span class="n">sw_cons</span><span class="p">))</span> <span class="p">{</span>


		<span class="n">elem</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">eq_ring</span><span class="p">[</span><span class="n">EQ_DESC</span><span class="p">(</span><span class="n">sw_cons</span><span class="p">)];</span>

		<span class="n">cid</span> <span class="o">=</span> <span class="n">SW_CID</span><span class="p">(</span><span class="n">elem</span><span class="o">-&gt;</span><span class="n">message</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">cfc_del_event</span><span class="p">.</span><span class="n">cid</span><span class="p">);</span>
		<span class="n">opcode</span> <span class="o">=</span> <span class="n">elem</span><span class="o">-&gt;</span><span class="n">message</span><span class="p">.</span><span class="n">opcode</span><span class="p">;</span>


		<span class="cm">/* handle eq element */</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">opcode</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">EVENT_RING_OPCODE_STAT_QUERY</span>:
			<span class="n">DP</span><span class="p">(</span><span class="n">BNX2X_MSG_SP</span> <span class="o">|</span> <span class="n">BNX2X_MSG_STATS</span><span class="p">,</span>
			   <span class="s">&quot;got statistics comp event %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">bp</span><span class="o">-&gt;</span><span class="n">stats_comp</span><span class="o">++</span><span class="p">);</span>
			<span class="cm">/* nothing to do with stats comp */</span>
			<span class="k">goto</span> <span class="n">next_spqe</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">EVENT_RING_OPCODE_CFC_DEL</span>:
			<span class="cm">/* handle according to cid range */</span>
			<span class="cm">/*</span>
<span class="cm">			 * we may want to verify here that the bp state is</span>
<span class="cm">			 * HALTING</span>
<span class="cm">			 */</span>
			<span class="n">DP</span><span class="p">(</span><span class="n">BNX2X_MSG_SP</span><span class="p">,</span>
			   <span class="s">&quot;got delete ramrod for MULTI[%d]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cid</span><span class="p">);</span>
<span class="cp">#ifdef BCM_CNIC</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bnx2x_cnic_handle_cfc_del</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">cid</span><span class="p">,</span> <span class="n">elem</span><span class="p">))</span>
				<span class="k">goto</span> <span class="n">next_spqe</span><span class="p">;</span>
<span class="cp">#endif</span>
			<span class="n">q_obj</span> <span class="o">=</span> <span class="n">bnx2x_cid_to_q_obj</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">cid</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">q_obj</span><span class="o">-&gt;</span><span class="n">complete_cmd</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">q_obj</span><span class="p">,</span> <span class="n">BNX2X_Q_CMD_CFC_DEL</span><span class="p">))</span>
				<span class="k">break</span><span class="p">;</span>



			<span class="k">goto</span> <span class="n">next_spqe</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">EVENT_RING_OPCODE_STOP_TRAFFIC</span>:
			<span class="n">DP</span><span class="p">(</span><span class="n">BNX2X_MSG_SP</span> <span class="o">|</span> <span class="n">BNX2X_MSG_DCB</span><span class="p">,</span> <span class="s">&quot;got STOP TRAFFIC</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">f_obj</span><span class="o">-&gt;</span><span class="n">complete_cmd</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">f_obj</span><span class="p">,</span>
						<span class="n">BNX2X_F_CMD_TX_STOP</span><span class="p">))</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">bnx2x_dcbx_set_params</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">BNX2X_DCBX_STATE_TX_PAUSED</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">next_spqe</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">EVENT_RING_OPCODE_START_TRAFFIC</span>:
			<span class="n">DP</span><span class="p">(</span><span class="n">BNX2X_MSG_SP</span> <span class="o">|</span> <span class="n">BNX2X_MSG_DCB</span><span class="p">,</span> <span class="s">&quot;got START TRAFFIC</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">f_obj</span><span class="o">-&gt;</span><span class="n">complete_cmd</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">f_obj</span><span class="p">,</span>
						<span class="n">BNX2X_F_CMD_TX_START</span><span class="p">))</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">bnx2x_dcbx_set_params</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">BNX2X_DCBX_STATE_TX_RELEASED</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">next_spqe</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">EVENT_RING_OPCODE_FUNCTION_UPDATE</span>:
			<span class="n">DP</span><span class="p">(</span><span class="n">BNX2X_MSG_SP</span> <span class="o">|</span> <span class="n">BNX2X_MSG_MCP</span><span class="p">,</span>
			   <span class="s">&quot;AFEX: ramrod completed FUNCTION_UPDATE</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">f_obj</span><span class="o">-&gt;</span><span class="n">complete_cmd</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">f_obj</span><span class="p">,</span> <span class="n">BNX2X_F_CMD_AFEX_UPDATE</span><span class="p">);</span>

			<span class="cm">/* We will perform the Queues update from sp_rtnl task</span>
<span class="cm">			 * as all Queue SP operations should run under</span>
<span class="cm">			 * rtnl_lock.</span>
<span class="cm">			 */</span>
			<span class="n">smp_mb__before_clear_bit</span><span class="p">();</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">BNX2X_SP_RTNL_AFEX_F_UPDATE</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">sp_rtnl_state</span><span class="p">);</span>
			<span class="n">smp_mb__after_clear_bit</span><span class="p">();</span>

			<span class="n">schedule_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">sp_rtnl_task</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">next_spqe</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">EVENT_RING_OPCODE_AFEX_VIF_LISTS</span>:
			<span class="n">f_obj</span><span class="o">-&gt;</span><span class="n">complete_cmd</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">f_obj</span><span class="p">,</span>
					    <span class="n">BNX2X_F_CMD_AFEX_VIFLISTS</span><span class="p">);</span>
			<span class="n">bnx2x_after_afex_vif_lists</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">elem</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">next_spqe</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">EVENT_RING_OPCODE_FUNCTION_START</span>:
			<span class="n">DP</span><span class="p">(</span><span class="n">BNX2X_MSG_SP</span> <span class="o">|</span> <span class="n">NETIF_MSG_IFUP</span><span class="p">,</span>
			   <span class="s">&quot;got FUNC_START ramrod</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">f_obj</span><span class="o">-&gt;</span><span class="n">complete_cmd</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">f_obj</span><span class="p">,</span> <span class="n">BNX2X_F_CMD_START</span><span class="p">))</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="k">goto</span> <span class="n">next_spqe</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">EVENT_RING_OPCODE_FUNCTION_STOP</span>:
			<span class="n">DP</span><span class="p">(</span><span class="n">BNX2X_MSG_SP</span> <span class="o">|</span> <span class="n">NETIF_MSG_IFUP</span><span class="p">,</span>
			   <span class="s">&quot;got FUNC_STOP ramrod</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">f_obj</span><span class="o">-&gt;</span><span class="n">complete_cmd</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">f_obj</span><span class="p">,</span> <span class="n">BNX2X_F_CMD_STOP</span><span class="p">))</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="k">goto</span> <span class="n">next_spqe</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">opcode</span> <span class="o">|</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="p">(</span><span class="n">EVENT_RING_OPCODE_RSS_UPDATE_RULES</span> <span class="o">|</span>
		      <span class="n">BNX2X_STATE_OPEN</span><span class="p">)</span><span class="o">:</span>
		<span class="k">case</span> <span class="p">(</span><span class="n">EVENT_RING_OPCODE_RSS_UPDATE_RULES</span> <span class="o">|</span>
		      <span class="n">BNX2X_STATE_OPENING_WAIT4_PORT</span><span class="p">)</span><span class="o">:</span>
			<span class="n">cid</span> <span class="o">=</span> <span class="n">elem</span><span class="o">-&gt;</span><span class="n">message</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">eth_event</span><span class="p">.</span><span class="n">echo</span> <span class="o">&amp;</span>
				<span class="n">BNX2X_SWCID_MASK</span><span class="p">;</span>
			<span class="n">DP</span><span class="p">(</span><span class="n">BNX2X_MSG_SP</span><span class="p">,</span> <span class="s">&quot;got RSS_UPDATE ramrod. CID %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">cid</span><span class="p">);</span>
			<span class="n">rss_raw</span><span class="o">-&gt;</span><span class="n">clear_pending</span><span class="p">(</span><span class="n">rss_raw</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="p">(</span><span class="n">EVENT_RING_OPCODE_SET_MAC</span> <span class="o">|</span> <span class="n">BNX2X_STATE_OPEN</span><span class="p">)</span>:
		<span class="k">case</span> <span class="p">(</span><span class="n">EVENT_RING_OPCODE_SET_MAC</span> <span class="o">|</span> <span class="n">BNX2X_STATE_DIAG</span><span class="p">)</span>:
		<span class="k">case</span> <span class="p">(</span><span class="n">EVENT_RING_OPCODE_SET_MAC</span> <span class="o">|</span>
		      <span class="n">BNX2X_STATE_CLOSING_WAIT4_HALT</span><span class="p">)</span><span class="o">:</span>
		<span class="k">case</span> <span class="p">(</span><span class="n">EVENT_RING_OPCODE_CLASSIFICATION_RULES</span> <span class="o">|</span>
		      <span class="n">BNX2X_STATE_OPEN</span><span class="p">)</span><span class="o">:</span>
		<span class="k">case</span> <span class="p">(</span><span class="n">EVENT_RING_OPCODE_CLASSIFICATION_RULES</span> <span class="o">|</span>
		      <span class="n">BNX2X_STATE_DIAG</span><span class="p">)</span><span class="o">:</span>
		<span class="k">case</span> <span class="p">(</span><span class="n">EVENT_RING_OPCODE_CLASSIFICATION_RULES</span> <span class="o">|</span>
		      <span class="n">BNX2X_STATE_CLOSING_WAIT4_HALT</span><span class="p">)</span><span class="o">:</span>
			<span class="n">DP</span><span class="p">(</span><span class="n">BNX2X_MSG_SP</span><span class="p">,</span> <span class="s">&quot;got (un)set mac ramrod</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">bnx2x_handle_classification_eqe</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">elem</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="p">(</span><span class="n">EVENT_RING_OPCODE_MULTICAST_RULES</span> <span class="o">|</span>
		      <span class="n">BNX2X_STATE_OPEN</span><span class="p">)</span><span class="o">:</span>
		<span class="k">case</span> <span class="p">(</span><span class="n">EVENT_RING_OPCODE_MULTICAST_RULES</span> <span class="o">|</span>
		      <span class="n">BNX2X_STATE_DIAG</span><span class="p">)</span><span class="o">:</span>
		<span class="k">case</span> <span class="p">(</span><span class="n">EVENT_RING_OPCODE_MULTICAST_RULES</span> <span class="o">|</span>
		      <span class="n">BNX2X_STATE_CLOSING_WAIT4_HALT</span><span class="p">)</span><span class="o">:</span>
			<span class="n">DP</span><span class="p">(</span><span class="n">BNX2X_MSG_SP</span><span class="p">,</span> <span class="s">&quot;got mcast ramrod</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">bnx2x_handle_mcast_eqe</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="p">(</span><span class="n">EVENT_RING_OPCODE_FILTERS_RULES</span> <span class="o">|</span>
		      <span class="n">BNX2X_STATE_OPEN</span><span class="p">)</span><span class="o">:</span>
		<span class="k">case</span> <span class="p">(</span><span class="n">EVENT_RING_OPCODE_FILTERS_RULES</span> <span class="o">|</span>
		      <span class="n">BNX2X_STATE_DIAG</span><span class="p">)</span><span class="o">:</span>
		<span class="k">case</span> <span class="p">(</span><span class="n">EVENT_RING_OPCODE_FILTERS_RULES</span> <span class="o">|</span>
		      <span class="n">BNX2X_STATE_CLOSING_WAIT4_HALT</span><span class="p">)</span><span class="o">:</span>
			<span class="n">DP</span><span class="p">(</span><span class="n">BNX2X_MSG_SP</span><span class="p">,</span> <span class="s">&quot;got rx_mode ramrod</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">bnx2x_handle_rx_mode_eqe</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="cm">/* unknown event log error and continue */</span>
			<span class="n">BNX2X_ERR</span><span class="p">(</span><span class="s">&quot;Unknown EQ event %d, bp-&gt;state 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				  <span class="n">elem</span><span class="o">-&gt;</span><span class="n">message</span><span class="p">.</span><span class="n">opcode</span><span class="p">,</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
		<span class="p">}</span>
<span class="nl">next_spqe:</span>
		<span class="n">spqe_cnt</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span> <span class="cm">/* for */</span>

	<span class="n">smp_mb__before_atomic_inc</span><span class="p">();</span>
	<span class="n">atomic_add</span><span class="p">(</span><span class="n">spqe_cnt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">eq_spq_left</span><span class="p">);</span>

	<span class="n">bp</span><span class="o">-&gt;</span><span class="n">eq_cons</span> <span class="o">=</span> <span class="n">sw_cons</span><span class="p">;</span>
	<span class="n">bp</span><span class="o">-&gt;</span><span class="n">eq_prod</span> <span class="o">=</span> <span class="n">sw_prod</span><span class="p">;</span>
	<span class="cm">/* Make sure that above mem writes were issued towards the memory */</span>
	<span class="n">smp_wmb</span><span class="p">();</span>

	<span class="cm">/* update producer */</span>
	<span class="n">bnx2x_update_eq_prod</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">eq_prod</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_sp_task</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bnx2x</span><span class="p">,</span> <span class="n">sp_task</span><span class="p">.</span><span class="n">work</span><span class="p">);</span>
	<span class="n">u16</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">bnx2x_update_dsb_idx</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
<span class="cm">/*	if (status == 0)				     */</span>
<span class="cm">/*		BNX2X_ERR(&quot;spurious slowpath interrupt!\n&quot;); */</span>

	<span class="n">DP</span><span class="p">(</span><span class="n">BNX2X_MSG_SP</span><span class="p">,</span> <span class="s">&quot;got a slowpath interrupt (status 0x%x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>

	<span class="cm">/* HW attentions */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">BNX2X_DEF_SB_ATT_IDX</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bnx2x_attn_int</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">BNX2X_DEF_SB_ATT_IDX</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* SP events: STAT_QUERY and others */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">BNX2X_DEF_SB_IDX</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifdef BCM_CNIC</span>
		<span class="k">struct</span> <span class="n">bnx2x_fastpath</span> <span class="o">*</span><span class="n">fp</span> <span class="o">=</span> <span class="n">bnx2x_fcoe_fp</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="n">NO_FCOE</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
			<span class="p">(</span><span class="n">bnx2x_has_rx_work</span><span class="p">(</span><span class="n">fp</span><span class="p">)</span> <span class="o">||</span> <span class="n">bnx2x_has_tx_work</span><span class="p">(</span><span class="n">fp</span><span class="p">)))</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * Prevent local bottom-halves from running as</span>
<span class="cm">			 * we are going to change the local NAPI list.</span>
<span class="cm">			 */</span>
			<span class="n">local_bh_disable</span><span class="p">();</span>
			<span class="n">napi_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bnx2x_fcoe</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">napi</span><span class="p">));</span>
			<span class="n">local_bh_enable</span><span class="p">();</span>
		<span class="p">}</span>
<span class="cp">#endif</span>
		<span class="cm">/* Handle EQ completions */</span>
		<span class="n">bnx2x_eq_int</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>

		<span class="n">bnx2x_ack_sb</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">igu_dsb_id</span><span class="p">,</span> <span class="n">USTORM_ID</span><span class="p">,</span>
			<span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">def_idx</span><span class="p">),</span> <span class="n">IGU_INT_NOP</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

		<span class="n">status</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">BNX2X_DEF_SB_IDX</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">status</span><span class="p">))</span>
		<span class="n">DP</span><span class="p">(</span><span class="n">BNX2X_MSG_SP</span><span class="p">,</span> <span class="s">&quot;got an unknown interrupt! (status 0x%x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">status</span><span class="p">);</span>

	<span class="n">bnx2x_ack_sb</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">igu_dsb_id</span><span class="p">,</span> <span class="n">ATTENTION_ID</span><span class="p">,</span>
	     <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">def_att_idx</span><span class="p">),</span> <span class="n">IGU_INT_ENABLE</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* afex - poll to check if VIFSET_ACK should be sent to MFW */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">BNX2X_AFEX_PENDING_VIFSET_MCP_ACK</span><span class="p">,</span>
			       <span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">sp_state</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">bnx2x_link_report</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
		<span class="n">bnx2x_fw_command</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">DRV_MSG_CODE_AFEX_VIFSET_ACK</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="n">irqreturn_t</span> <span class="nf">bnx2x_msix_sp_int</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_instance</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev_instance</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">bnx2x_ack_sb</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">igu_dsb_id</span><span class="p">,</span> <span class="n">USTORM_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
		     <span class="n">IGU_INT_DISABLE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

<span class="cp">#ifdef BNX2X_STOP_ON_ERROR</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">panic</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef BCM_CNIC</span>
	<span class="p">{</span>
		<span class="k">struct</span> <span class="n">cnic_ops</span> <span class="o">*</span><span class="n">c_ops</span><span class="p">;</span>

		<span class="n">rcu_read_lock</span><span class="p">();</span>
		<span class="n">c_ops</span> <span class="o">=</span> <span class="n">rcu_dereference</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">cnic_ops</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">c_ops</span><span class="p">)</span>
			<span class="n">c_ops</span><span class="o">-&gt;</span><span class="n">cnic_handler</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">cnic_data</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="n">rcu_read_unlock</span><span class="p">();</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="n">queue_delayed_work</span><span class="p">(</span><span class="n">bnx2x_wq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">sp_task</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* end of slow path */</span>


<span class="kt">void</span> <span class="nf">bnx2x_drv_pulse</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">SHMEM_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">func_mb</span><span class="p">[</span><span class="n">BP_FW_MB_IDX</span><span class="p">(</span><span class="n">bp</span><span class="p">)].</span><span class="n">drv_pulse_mb</span><span class="p">,</span>
		 <span class="n">bp</span><span class="o">-&gt;</span><span class="n">fw_drv_pulse_wr_seq</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_timer</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="p">)</span> <span class="n">data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">netif_running</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">BP_NOMCP</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">mb_idx</span> <span class="o">=</span> <span class="n">BP_FW_MB_IDX</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
		<span class="n">u32</span> <span class="n">drv_pulse</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">mcp_pulse</span><span class="p">;</span>

		<span class="o">++</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">fw_drv_pulse_wr_seq</span><span class="p">;</span>
		<span class="n">bp</span><span class="o">-&gt;</span><span class="n">fw_drv_pulse_wr_seq</span> <span class="o">&amp;=</span> <span class="n">DRV_PULSE_SEQ_MASK</span><span class="p">;</span>
		<span class="cm">/* TBD - add SYSTEM_TIME */</span>
		<span class="n">drv_pulse</span> <span class="o">=</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">fw_drv_pulse_wr_seq</span><span class="p">;</span>
		<span class="n">bnx2x_drv_pulse</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>

		<span class="n">mcp_pulse</span> <span class="o">=</span> <span class="p">(</span><span class="n">SHMEM_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">func_mb</span><span class="p">[</span><span class="n">mb_idx</span><span class="p">].</span><span class="n">mcp_pulse_mb</span><span class="p">)</span> <span class="o">&amp;</span>
			     <span class="n">MCP_PULSE_SEQ_MASK</span><span class="p">);</span>
		<span class="cm">/* The delta between driver pulse and mcp response</span>
<span class="cm">		 * should be 1 (before mcp response) or 0 (after mcp response)</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">drv_pulse</span> <span class="o">!=</span> <span class="n">mcp_pulse</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">drv_pulse</span> <span class="o">!=</span> <span class="p">((</span><span class="n">mcp_pulse</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">MCP_PULSE_SEQ_MASK</span><span class="p">)))</span> <span class="p">{</span>
			<span class="cm">/* someone lost a heartbeat... */</span>
			<span class="n">BNX2X_ERR</span><span class="p">(</span><span class="s">&quot;drv_pulse (0x%x) != mcp_pulse (0x%x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				  <span class="n">drv_pulse</span><span class="p">,</span> <span class="n">mcp_pulse</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">BNX2X_STATE_OPEN</span><span class="p">)</span>
		<span class="n">bnx2x_stats_handle</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">STATS_EVENT_UPDATE</span><span class="p">);</span>

	<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">current_interval</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* end of Statistics */</span>

<span class="cm">/* nic init */</span>

<span class="cm">/*</span>
<span class="cm"> * nic init service functions</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_fill</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">,</span> <span class="n">u32</span> <span class="n">addr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">fill</span><span class="p">,</span> <span class="n">u32</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">len</span><span class="o">%</span><span class="mi">4</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">addr</span><span class="o">%</span><span class="mi">4</span><span class="p">))</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">)</span>
			<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">addr</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="n">fill</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">REG_WR8</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">addr</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="n">fill</span><span class="p">);</span>

<span class="p">}</span>

<span class="cm">/* helper: writes FP SP data to FW - data_size in dwords */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_wr_fp_sb_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">,</span>
				<span class="kt">int</span> <span class="n">fw_sb_id</span><span class="p">,</span>
				<span class="n">u32</span> <span class="o">*</span><span class="n">sb_data_p</span><span class="p">,</span>
				<span class="n">u32</span> <span class="n">data_size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">index</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">index</span> <span class="o">&lt;</span> <span class="n">data_size</span><span class="p">;</span> <span class="n">index</span><span class="o">++</span><span class="p">)</span>
		<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">BAR_CSTRORM_INTMEM</span> <span class="o">+</span>
			<span class="n">CSTORM_STATUS_BLOCK_DATA_OFFSET</span><span class="p">(</span><span class="n">fw_sb_id</span><span class="p">)</span> <span class="o">+</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="o">*</span><span class="n">index</span><span class="p">,</span>
			<span class="o">*</span><span class="p">(</span><span class="n">sb_data_p</span> <span class="o">+</span> <span class="n">index</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_zero_fp_sb</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">fw_sb_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">sb_data_p</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">data_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hc_status_block_data_e2</span> <span class="n">sb_data_e2</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hc_status_block_data_e1x</span> <span class="n">sb_data_e1x</span><span class="p">;</span>

	<span class="cm">/* disable the function first */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CHIP_IS_E1x</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sb_data_e2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">hc_status_block_data_e2</span><span class="p">));</span>
		<span class="n">sb_data_e2</span><span class="p">.</span><span class="n">common</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">SB_DISABLED</span><span class="p">;</span>
		<span class="n">sb_data_e2</span><span class="p">.</span><span class="n">common</span><span class="p">.</span><span class="n">p_func</span><span class="p">.</span><span class="n">vf_valid</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">sb_data_p</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">sb_data_e2</span><span class="p">;</span>
		<span class="n">data_size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">hc_status_block_data_e2</span><span class="p">)</span><span class="o">/</span><span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sb_data_e1x</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
		       <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">hc_status_block_data_e1x</span><span class="p">));</span>
		<span class="n">sb_data_e1x</span><span class="p">.</span><span class="n">common</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">SB_DISABLED</span><span class="p">;</span>
		<span class="n">sb_data_e1x</span><span class="p">.</span><span class="n">common</span><span class="p">.</span><span class="n">p_func</span><span class="p">.</span><span class="n">vf_valid</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">sb_data_p</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">sb_data_e1x</span><span class="p">;</span>
		<span class="n">data_size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">hc_status_block_data_e1x</span><span class="p">)</span><span class="o">/</span><span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">bnx2x_wr_fp_sb_data</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">fw_sb_id</span><span class="p">,</span> <span class="n">sb_data_p</span><span class="p">,</span> <span class="n">data_size</span><span class="p">);</span>

	<span class="n">bnx2x_fill</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">BAR_CSTRORM_INTMEM</span> <span class="o">+</span>
			<span class="n">CSTORM_STATUS_BLOCK_OFFSET</span><span class="p">(</span><span class="n">fw_sb_id</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span>
			<span class="n">CSTORM_STATUS_BLOCK_SIZE</span><span class="p">);</span>
	<span class="n">bnx2x_fill</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">BAR_CSTRORM_INTMEM</span> <span class="o">+</span>
			<span class="n">CSTORM_SYNC_BLOCK_OFFSET</span><span class="p">(</span><span class="n">fw_sb_id</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span>
			<span class="n">CSTORM_SYNC_BLOCK_SIZE</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* helper:  writes SP SB data to FW */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_wr_sp_sb_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">hc_sp_status_block_data</span> <span class="o">*</span><span class="n">sp_sb_data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">func</span> <span class="o">=</span> <span class="n">BP_FUNC</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">hc_sp_status_block_data</span><span class="p">)</span><span class="o">/</span><span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">BAR_CSTRORM_INTMEM</span> <span class="o">+</span>
			<span class="n">CSTORM_SP_STATUS_BLOCK_DATA_OFFSET</span><span class="p">(</span><span class="n">func</span><span class="p">)</span> <span class="o">+</span>
			<span class="n">i</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">),</span>
			<span class="o">*</span><span class="p">((</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="n">sp_sb_data</span> <span class="o">+</span> <span class="n">i</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_zero_sp_sb</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">func</span> <span class="o">=</span> <span class="n">BP_FUNC</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">hc_sp_status_block_data</span> <span class="n">sp_sb_data</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sp_sb_data</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">hc_sp_status_block_data</span><span class="p">));</span>

	<span class="n">sp_sb_data</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">SB_DISABLED</span><span class="p">;</span>
	<span class="n">sp_sb_data</span><span class="p">.</span><span class="n">p_func</span><span class="p">.</span><span class="n">vf_valid</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">bnx2x_wr_sp_sb_data</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sp_sb_data</span><span class="p">);</span>

	<span class="n">bnx2x_fill</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">BAR_CSTRORM_INTMEM</span> <span class="o">+</span>
			<span class="n">CSTORM_SP_STATUS_BLOCK_OFFSET</span><span class="p">(</span><span class="n">func</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span>
			<span class="n">CSTORM_SP_STATUS_BLOCK_SIZE</span><span class="p">);</span>
	<span class="n">bnx2x_fill</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">BAR_CSTRORM_INTMEM</span> <span class="o">+</span>
			<span class="n">CSTORM_SP_SYNC_BLOCK_OFFSET</span><span class="p">(</span><span class="n">func</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span>
			<span class="n">CSTORM_SP_SYNC_BLOCK_SIZE</span><span class="p">);</span>

<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_setup_ndsb_state_machine</span><span class="p">(</span><span class="k">struct</span> <span class="n">hc_status_block_sm</span> <span class="o">*</span><span class="n">hc_sm</span><span class="p">,</span>
					   <span class="kt">int</span> <span class="n">igu_sb_id</span><span class="p">,</span> <span class="kt">int</span> <span class="n">igu_seg_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">hc_sm</span><span class="o">-&gt;</span><span class="n">igu_sb_id</span> <span class="o">=</span> <span class="n">igu_sb_id</span><span class="p">;</span>
	<span class="n">hc_sm</span><span class="o">-&gt;</span><span class="n">igu_seg_id</span> <span class="o">=</span> <span class="n">igu_seg_id</span><span class="p">;</span>
	<span class="n">hc_sm</span><span class="o">-&gt;</span><span class="n">timer_value</span> <span class="o">=</span> <span class="mh">0xFF</span><span class="p">;</span>
	<span class="n">hc_sm</span><span class="o">-&gt;</span><span class="n">time_to_expire</span> <span class="o">=</span> <span class="mh">0xFFFFFFFF</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* allocates state machine ids. */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_map_sb_state_machines</span><span class="p">(</span><span class="k">struct</span> <span class="n">hc_index_data</span> <span class="o">*</span><span class="n">index_data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* zero out state machine indices */</span>
	<span class="cm">/* rx indices */</span>
	<span class="n">index_data</span><span class="p">[</span><span class="n">HC_INDEX_ETH_RX_CQ_CONS</span><span class="p">].</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">HC_INDEX_DATA_SM_ID</span><span class="p">;</span>

	<span class="cm">/* tx indices */</span>
	<span class="n">index_data</span><span class="p">[</span><span class="n">HC_INDEX_OOO_TX_CQ_CONS</span><span class="p">].</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">HC_INDEX_DATA_SM_ID</span><span class="p">;</span>
	<span class="n">index_data</span><span class="p">[</span><span class="n">HC_INDEX_ETH_TX_CQ_CONS_COS0</span><span class="p">].</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">HC_INDEX_DATA_SM_ID</span><span class="p">;</span>
	<span class="n">index_data</span><span class="p">[</span><span class="n">HC_INDEX_ETH_TX_CQ_CONS_COS1</span><span class="p">].</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">HC_INDEX_DATA_SM_ID</span><span class="p">;</span>
	<span class="n">index_data</span><span class="p">[</span><span class="n">HC_INDEX_ETH_TX_CQ_CONS_COS2</span><span class="p">].</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">HC_INDEX_DATA_SM_ID</span><span class="p">;</span>

	<span class="cm">/* map indices */</span>
	<span class="cm">/* rx indices */</span>
	<span class="n">index_data</span><span class="p">[</span><span class="n">HC_INDEX_ETH_RX_CQ_CONS</span><span class="p">].</span><span class="n">flags</span> <span class="o">|=</span>
		<span class="n">SM_RX_ID</span> <span class="o">&lt;&lt;</span> <span class="n">HC_INDEX_DATA_SM_ID_SHIFT</span><span class="p">;</span>

	<span class="cm">/* tx indices */</span>
	<span class="n">index_data</span><span class="p">[</span><span class="n">HC_INDEX_OOO_TX_CQ_CONS</span><span class="p">].</span><span class="n">flags</span> <span class="o">|=</span>
		<span class="n">SM_TX_ID</span> <span class="o">&lt;&lt;</span> <span class="n">HC_INDEX_DATA_SM_ID_SHIFT</span><span class="p">;</span>
	<span class="n">index_data</span><span class="p">[</span><span class="n">HC_INDEX_ETH_TX_CQ_CONS_COS0</span><span class="p">].</span><span class="n">flags</span> <span class="o">|=</span>
		<span class="n">SM_TX_ID</span> <span class="o">&lt;&lt;</span> <span class="n">HC_INDEX_DATA_SM_ID_SHIFT</span><span class="p">;</span>
	<span class="n">index_data</span><span class="p">[</span><span class="n">HC_INDEX_ETH_TX_CQ_CONS_COS1</span><span class="p">].</span><span class="n">flags</span> <span class="o">|=</span>
		<span class="n">SM_TX_ID</span> <span class="o">&lt;&lt;</span> <span class="n">HC_INDEX_DATA_SM_ID_SHIFT</span><span class="p">;</span>
	<span class="n">index_data</span><span class="p">[</span><span class="n">HC_INDEX_ETH_TX_CQ_CONS_COS2</span><span class="p">].</span><span class="n">flags</span> <span class="o">|=</span>
		<span class="n">SM_TX_ID</span> <span class="o">&lt;&lt;</span> <span class="n">HC_INDEX_DATA_SM_ID_SHIFT</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_init_sb</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">,</span> <span class="n">dma_addr_t</span> <span class="n">mapping</span><span class="p">,</span> <span class="kt">int</span> <span class="n">vfid</span><span class="p">,</span>
			  <span class="n">u8</span> <span class="n">vf_valid</span><span class="p">,</span> <span class="kt">int</span> <span class="n">fw_sb_id</span><span class="p">,</span> <span class="kt">int</span> <span class="n">igu_sb_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">igu_seg_id</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">hc_status_block_data_e2</span> <span class="n">sb_data_e2</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hc_status_block_data_e1x</span> <span class="n">sb_data_e1x</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hc_status_block_sm</span>  <span class="o">*</span><span class="n">hc_sm_p</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">data_size</span><span class="p">;</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">sb_data_p</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">CHIP_INT_MODE_IS_BC</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span>
		<span class="n">igu_seg_id</span> <span class="o">=</span> <span class="n">HC_SEG_ACCESS_NORM</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">igu_seg_id</span> <span class="o">=</span> <span class="n">IGU_SEG_ACCESS_NORM</span><span class="p">;</span>

	<span class="n">bnx2x_zero_fp_sb</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">fw_sb_id</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CHIP_IS_E1x</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sb_data_e2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">hc_status_block_data_e2</span><span class="p">));</span>
		<span class="n">sb_data_e2</span><span class="p">.</span><span class="n">common</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">SB_ENABLED</span><span class="p">;</span>
		<span class="n">sb_data_e2</span><span class="p">.</span><span class="n">common</span><span class="p">.</span><span class="n">p_func</span><span class="p">.</span><span class="n">pf_id</span> <span class="o">=</span> <span class="n">BP_FUNC</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
		<span class="n">sb_data_e2</span><span class="p">.</span><span class="n">common</span><span class="p">.</span><span class="n">p_func</span><span class="p">.</span><span class="n">vf_id</span> <span class="o">=</span> <span class="n">vfid</span><span class="p">;</span>
		<span class="n">sb_data_e2</span><span class="p">.</span><span class="n">common</span><span class="p">.</span><span class="n">p_func</span><span class="p">.</span><span class="n">vf_valid</span> <span class="o">=</span> <span class="n">vf_valid</span><span class="p">;</span>
		<span class="n">sb_data_e2</span><span class="p">.</span><span class="n">common</span><span class="p">.</span><span class="n">p_func</span><span class="p">.</span><span class="n">vnic_id</span> <span class="o">=</span> <span class="n">BP_VN</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
		<span class="n">sb_data_e2</span><span class="p">.</span><span class="n">common</span><span class="p">.</span><span class="n">same_igu_sb_1b</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">sb_data_e2</span><span class="p">.</span><span class="n">common</span><span class="p">.</span><span class="n">host_sb_addr</span><span class="p">.</span><span class="n">hi</span> <span class="o">=</span> <span class="n">U64_HI</span><span class="p">(</span><span class="n">mapping</span><span class="p">);</span>
		<span class="n">sb_data_e2</span><span class="p">.</span><span class="n">common</span><span class="p">.</span><span class="n">host_sb_addr</span><span class="p">.</span><span class="n">lo</span> <span class="o">=</span> <span class="n">U64_LO</span><span class="p">(</span><span class="n">mapping</span><span class="p">);</span>
		<span class="n">hc_sm_p</span> <span class="o">=</span> <span class="n">sb_data_e2</span><span class="p">.</span><span class="n">common</span><span class="p">.</span><span class="n">state_machine</span><span class="p">;</span>
		<span class="n">sb_data_p</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">sb_data_e2</span><span class="p">;</span>
		<span class="n">data_size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">hc_status_block_data_e2</span><span class="p">)</span><span class="o">/</span><span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">);</span>
		<span class="n">bnx2x_map_sb_state_machines</span><span class="p">(</span><span class="n">sb_data_e2</span><span class="p">.</span><span class="n">index_data</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sb_data_e1x</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
		       <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">hc_status_block_data_e1x</span><span class="p">));</span>
		<span class="n">sb_data_e1x</span><span class="p">.</span><span class="n">common</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">SB_ENABLED</span><span class="p">;</span>
		<span class="n">sb_data_e1x</span><span class="p">.</span><span class="n">common</span><span class="p">.</span><span class="n">p_func</span><span class="p">.</span><span class="n">pf_id</span> <span class="o">=</span> <span class="n">BP_FUNC</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
		<span class="n">sb_data_e1x</span><span class="p">.</span><span class="n">common</span><span class="p">.</span><span class="n">p_func</span><span class="p">.</span><span class="n">vf_id</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="n">sb_data_e1x</span><span class="p">.</span><span class="n">common</span><span class="p">.</span><span class="n">p_func</span><span class="p">.</span><span class="n">vf_valid</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">sb_data_e1x</span><span class="p">.</span><span class="n">common</span><span class="p">.</span><span class="n">p_func</span><span class="p">.</span><span class="n">vnic_id</span> <span class="o">=</span> <span class="n">BP_VN</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
		<span class="n">sb_data_e1x</span><span class="p">.</span><span class="n">common</span><span class="p">.</span><span class="n">same_igu_sb_1b</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">sb_data_e1x</span><span class="p">.</span><span class="n">common</span><span class="p">.</span><span class="n">host_sb_addr</span><span class="p">.</span><span class="n">hi</span> <span class="o">=</span> <span class="n">U64_HI</span><span class="p">(</span><span class="n">mapping</span><span class="p">);</span>
		<span class="n">sb_data_e1x</span><span class="p">.</span><span class="n">common</span><span class="p">.</span><span class="n">host_sb_addr</span><span class="p">.</span><span class="n">lo</span> <span class="o">=</span> <span class="n">U64_LO</span><span class="p">(</span><span class="n">mapping</span><span class="p">);</span>
		<span class="n">hc_sm_p</span> <span class="o">=</span> <span class="n">sb_data_e1x</span><span class="p">.</span><span class="n">common</span><span class="p">.</span><span class="n">state_machine</span><span class="p">;</span>
		<span class="n">sb_data_p</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">sb_data_e1x</span><span class="p">;</span>
		<span class="n">data_size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">hc_status_block_data_e1x</span><span class="p">)</span><span class="o">/</span><span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">);</span>
		<span class="n">bnx2x_map_sb_state_machines</span><span class="p">(</span><span class="n">sb_data_e1x</span><span class="p">.</span><span class="n">index_data</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">bnx2x_setup_ndsb_state_machine</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hc_sm_p</span><span class="p">[</span><span class="n">SM_RX_ID</span><span class="p">],</span>
				       <span class="n">igu_sb_id</span><span class="p">,</span> <span class="n">igu_seg_id</span><span class="p">);</span>
	<span class="n">bnx2x_setup_ndsb_state_machine</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hc_sm_p</span><span class="p">[</span><span class="n">SM_TX_ID</span><span class="p">],</span>
				       <span class="n">igu_sb_id</span><span class="p">,</span> <span class="n">igu_seg_id</span><span class="p">);</span>

	<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_IFUP</span><span class="p">,</span> <span class="s">&quot;Init FW SB %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fw_sb_id</span><span class="p">);</span>

	<span class="cm">/* write indecies to HW */</span>
	<span class="n">bnx2x_wr_fp_sb_data</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">fw_sb_id</span><span class="p">,</span> <span class="n">sb_data_p</span><span class="p">,</span> <span class="n">data_size</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_update_coalesce_sb</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">,</span> <span class="n">u8</span> <span class="n">fw_sb_id</span><span class="p">,</span>
				     <span class="n">u16</span> <span class="n">tx_usec</span><span class="p">,</span> <span class="n">u16</span> <span class="n">rx_usec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bnx2x_update_coalesce_sb_index</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">fw_sb_id</span><span class="p">,</span> <span class="n">HC_INDEX_ETH_RX_CQ_CONS</span><span class="p">,</span>
				    <span class="nb">false</span><span class="p">,</span> <span class="n">rx_usec</span><span class="p">);</span>
	<span class="n">bnx2x_update_coalesce_sb_index</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">fw_sb_id</span><span class="p">,</span>
				       <span class="n">HC_INDEX_ETH_TX_CQ_CONS_COS0</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span>
				       <span class="n">tx_usec</span><span class="p">);</span>
	<span class="n">bnx2x_update_coalesce_sb_index</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">fw_sb_id</span><span class="p">,</span>
				       <span class="n">HC_INDEX_ETH_TX_CQ_CONS_COS1</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span>
				       <span class="n">tx_usec</span><span class="p">);</span>
	<span class="n">bnx2x_update_coalesce_sb_index</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">fw_sb_id</span><span class="p">,</span>
				       <span class="n">HC_INDEX_ETH_TX_CQ_CONS_COS2</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span>
				       <span class="n">tx_usec</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_init_def_sb</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">host_sp_status_block</span> <span class="o">*</span><span class="n">def_sb</span> <span class="o">=</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">def_status_blk</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">mapping</span> <span class="o">=</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">def_status_blk_mapping</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">igu_sp_sb_index</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">igu_seg_id</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">port</span> <span class="o">=</span> <span class="n">BP_PORT</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">func</span> <span class="o">=</span> <span class="n">BP_FUNC</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">reg_offset</span><span class="p">,</span> <span class="n">reg_offset_en5</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">section</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">index</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hc_sp_status_block_data</span> <span class="n">sp_sb_data</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sp_sb_data</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">hc_sp_status_block_data</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">CHIP_INT_MODE_IS_BC</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">igu_sp_sb_index</span> <span class="o">=</span> <span class="n">DEF_SB_IGU_ID</span><span class="p">;</span>
		<span class="n">igu_seg_id</span> <span class="o">=</span> <span class="n">HC_SEG_ACCESS_DEF</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">igu_sp_sb_index</span> <span class="o">=</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">igu_dsb_id</span><span class="p">;</span>
		<span class="n">igu_seg_id</span> <span class="o">=</span> <span class="n">IGU_SEG_ACCESS_DEF</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* ATTN */</span>
	<span class="n">section</span> <span class="o">=</span> <span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="n">mapping</span><span class="p">)</span> <span class="o">+</span> <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">host_sp_status_block</span><span class="p">,</span>
					    <span class="n">atten_status_block</span><span class="p">);</span>
	<span class="n">def_sb</span><span class="o">-&gt;</span><span class="n">atten_status_block</span><span class="p">.</span><span class="n">status_block_id</span> <span class="o">=</span> <span class="n">igu_sp_sb_index</span><span class="p">;</span>

	<span class="n">bp</span><span class="o">-&gt;</span><span class="n">attn_state</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">reg_offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">port</span> <span class="o">?</span> <span class="n">MISC_REG_AEU_ENABLE1_FUNC_1_OUT_0</span> <span class="o">:</span>
			     <span class="n">MISC_REG_AEU_ENABLE1_FUNC_0_OUT_0</span><span class="p">);</span>
	<span class="n">reg_offset_en5</span> <span class="o">=</span> <span class="p">(</span><span class="n">port</span> <span class="o">?</span> <span class="n">MISC_REG_AEU_ENABLE5_FUNC_1_OUT_0</span> <span class="o">:</span>
				 <span class="n">MISC_REG_AEU_ENABLE5_FUNC_0_OUT_0</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">index</span> <span class="o">&lt;</span> <span class="n">MAX_DYNAMIC_ATTN_GRPS</span><span class="p">;</span> <span class="n">index</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">sindex</span><span class="p">;</span>
		<span class="cm">/* take care of sig[0]..sig[4] */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">sindex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">sindex</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">sindex</span><span class="o">++</span><span class="p">)</span>
			<span class="n">bp</span><span class="o">-&gt;</span><span class="n">attn_group</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">sig</span><span class="p">[</span><span class="n">sindex</span><span class="p">]</span> <span class="o">=</span>
			   <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">reg_offset</span> <span class="o">+</span> <span class="n">sindex</span><span class="o">*</span><span class="mh">0x4</span> <span class="o">+</span> <span class="mh">0x10</span><span class="o">*</span><span class="n">index</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CHIP_IS_E1x</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span>
			<span class="cm">/*</span>
<span class="cm">			 * enable5 is separate from the rest of the registers,</span>
<span class="cm">			 * and therefore the address skip is 4</span>
<span class="cm">			 * and not 16 between the different groups</span>
<span class="cm">			 */</span>
			<span class="n">bp</span><span class="o">-&gt;</span><span class="n">attn_group</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">sig</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span>
					<span class="n">reg_offset_en5</span> <span class="o">+</span> <span class="mh">0x4</span><span class="o">*</span><span class="n">index</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">bp</span><span class="o">-&gt;</span><span class="n">attn_group</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">sig</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">.</span><span class="n">int_block</span> <span class="o">==</span> <span class="n">INT_BLOCK_HC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">reg_offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">port</span> <span class="o">?</span> <span class="n">HC_REG_ATTN_MSG1_ADDR_L</span> <span class="o">:</span>
				     <span class="n">HC_REG_ATTN_MSG0_ADDR_L</span><span class="p">);</span>

		<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">reg_offset</span><span class="p">,</span> <span class="n">U64_LO</span><span class="p">(</span><span class="n">section</span><span class="p">));</span>
		<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">reg_offset</span> <span class="o">+</span> <span class="mi">4</span><span class="p">,</span> <span class="n">U64_HI</span><span class="p">(</span><span class="n">section</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CHIP_IS_E1x</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">IGU_REG_ATTN_MSG_ADDR_L</span><span class="p">,</span> <span class="n">U64_LO</span><span class="p">(</span><span class="n">section</span><span class="p">));</span>
		<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">IGU_REG_ATTN_MSG_ADDR_H</span><span class="p">,</span> <span class="n">U64_HI</span><span class="p">(</span><span class="n">section</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="n">section</span> <span class="o">=</span> <span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="n">mapping</span><span class="p">)</span> <span class="o">+</span> <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">host_sp_status_block</span><span class="p">,</span>
					    <span class="n">sp_sb</span><span class="p">);</span>

	<span class="n">bnx2x_zero_sp_sb</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>

	<span class="n">sp_sb_data</span><span class="p">.</span><span class="n">state</span>		<span class="o">=</span> <span class="n">SB_ENABLED</span><span class="p">;</span>
	<span class="n">sp_sb_data</span><span class="p">.</span><span class="n">host_sb_addr</span><span class="p">.</span><span class="n">lo</span>	<span class="o">=</span> <span class="n">U64_LO</span><span class="p">(</span><span class="n">section</span><span class="p">);</span>
	<span class="n">sp_sb_data</span><span class="p">.</span><span class="n">host_sb_addr</span><span class="p">.</span><span class="n">hi</span>	<span class="o">=</span> <span class="n">U64_HI</span><span class="p">(</span><span class="n">section</span><span class="p">);</span>
	<span class="n">sp_sb_data</span><span class="p">.</span><span class="n">igu_sb_id</span>		<span class="o">=</span> <span class="n">igu_sp_sb_index</span><span class="p">;</span>
	<span class="n">sp_sb_data</span><span class="p">.</span><span class="n">igu_seg_id</span>		<span class="o">=</span> <span class="n">igu_seg_id</span><span class="p">;</span>
	<span class="n">sp_sb_data</span><span class="p">.</span><span class="n">p_func</span><span class="p">.</span><span class="n">pf_id</span>		<span class="o">=</span> <span class="n">func</span><span class="p">;</span>
	<span class="n">sp_sb_data</span><span class="p">.</span><span class="n">p_func</span><span class="p">.</span><span class="n">vnic_id</span>	<span class="o">=</span> <span class="n">BP_VN</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
	<span class="n">sp_sb_data</span><span class="p">.</span><span class="n">p_func</span><span class="p">.</span><span class="n">vf_id</span>		<span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>

	<span class="n">bnx2x_wr_sp_sb_data</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sp_sb_data</span><span class="p">);</span>

	<span class="n">bnx2x_ack_sb</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">igu_dsb_id</span><span class="p">,</span> <span class="n">USTORM_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">IGU_INT_ENABLE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">bnx2x_update_coalesce</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">for_each_eth_queue</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
		<span class="n">bnx2x_update_coalesce_sb</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">fp</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">fw_sb_id</span><span class="p">,</span>
					 <span class="n">bp</span><span class="o">-&gt;</span><span class="n">tx_ticks</span><span class="p">,</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">rx_ticks</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_init_sp_ring</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">spq_lock</span><span class="p">);</span>
	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">cq_spq_left</span><span class="p">,</span> <span class="n">MAX_SPQ_PENDING</span><span class="p">);</span>

	<span class="n">bp</span><span class="o">-&gt;</span><span class="n">spq_prod_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">bp</span><span class="o">-&gt;</span><span class="n">dsb_sp_prod</span> <span class="o">=</span> <span class="n">BNX2X_SP_DSB_INDEX</span><span class="p">;</span>
	<span class="n">bp</span><span class="o">-&gt;</span><span class="n">spq_prod_bd</span> <span class="o">=</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">spq</span><span class="p">;</span>
	<span class="n">bp</span><span class="o">-&gt;</span><span class="n">spq_last_bd</span> <span class="o">=</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">spq_prod_bd</span> <span class="o">+</span> <span class="n">MAX_SP_DESC_CNT</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_init_eq_ring</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">NUM_EQ_PAGES</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">union</span> <span class="n">event_ring_elem</span> <span class="o">*</span><span class="n">elem</span> <span class="o">=</span>
			<span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">eq_ring</span><span class="p">[</span><span class="n">EQ_DESC_CNT_PAGE</span> <span class="o">*</span> <span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>

		<span class="n">elem</span><span class="o">-&gt;</span><span class="n">next_page</span><span class="p">.</span><span class="n">addr</span><span class="p">.</span><span class="n">hi</span> <span class="o">=</span>
			<span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">U64_HI</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">eq_mapping</span> <span class="o">+</span>
				   <span class="n">BCM_PAGE_SIZE</span> <span class="o">*</span> <span class="p">(</span><span class="n">i</span> <span class="o">%</span> <span class="n">NUM_EQ_PAGES</span><span class="p">)));</span>
		<span class="n">elem</span><span class="o">-&gt;</span><span class="n">next_page</span><span class="p">.</span><span class="n">addr</span><span class="p">.</span><span class="n">lo</span> <span class="o">=</span>
			<span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">U64_LO</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">eq_mapping</span> <span class="o">+</span>
				   <span class="n">BCM_PAGE_SIZE</span><span class="o">*</span><span class="p">(</span><span class="n">i</span> <span class="o">%</span> <span class="n">NUM_EQ_PAGES</span><span class="p">)));</span>
	<span class="p">}</span>
	<span class="n">bp</span><span class="o">-&gt;</span><span class="n">eq_cons</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">bp</span><span class="o">-&gt;</span><span class="n">eq_prod</span> <span class="o">=</span> <span class="n">NUM_EQ_DESC</span><span class="p">;</span>
	<span class="n">bp</span><span class="o">-&gt;</span><span class="n">eq_cons_sb</span> <span class="o">=</span> <span class="n">BNX2X_EQ_INDEX</span><span class="p">;</span>
	<span class="cm">/* we want a warning message before it gets rought... */</span>
	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">eq_spq_left</span><span class="p">,</span>
		<span class="n">min_t</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="n">MAX_SP_DESC_CNT</span> <span class="o">-</span> <span class="n">MAX_SPQ_PENDING</span><span class="p">,</span> <span class="n">NUM_EQ_DESC</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/* called with netif_addr_lock_bh() */</span>
<span class="kt">void</span> <span class="nf">bnx2x_set_q_rx_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">,</span> <span class="n">u8</span> <span class="n">cl_id</span><span class="p">,</span>
			 <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">rx_mode_flags</span><span class="p">,</span>
			 <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">rx_accept_flags</span><span class="p">,</span>
			 <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">tx_accept_flags</span><span class="p">,</span>
			 <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ramrod_flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2x_rx_mode_ramrod_params</span> <span class="n">ramrod_param</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ramrod_param</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ramrod_param</span><span class="p">));</span>

	<span class="cm">/* Prepare ramrod parameters */</span>
	<span class="n">ramrod_param</span><span class="p">.</span><span class="n">cid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ramrod_param</span><span class="p">.</span><span class="n">cl_id</span> <span class="o">=</span> <span class="n">cl_id</span><span class="p">;</span>
	<span class="n">ramrod_param</span><span class="p">.</span><span class="n">rx_mode_obj</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">rx_mode_obj</span><span class="p">;</span>
	<span class="n">ramrod_param</span><span class="p">.</span><span class="n">func_id</span> <span class="o">=</span> <span class="n">BP_FUNC</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>

	<span class="n">ramrod_param</span><span class="p">.</span><span class="n">pstate</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">sp_state</span><span class="p">;</span>
	<span class="n">ramrod_param</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">BNX2X_FILTER_RX_MODE_PENDING</span><span class="p">;</span>

	<span class="n">ramrod_param</span><span class="p">.</span><span class="n">rdata</span> <span class="o">=</span> <span class="n">bnx2x_sp</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">rx_mode_rdata</span><span class="p">);</span>
	<span class="n">ramrod_param</span><span class="p">.</span><span class="n">rdata_mapping</span> <span class="o">=</span> <span class="n">bnx2x_sp_mapping</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">rx_mode_rdata</span><span class="p">);</span>

	<span class="n">set_bit</span><span class="p">(</span><span class="n">BNX2X_FILTER_RX_MODE_PENDING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">sp_state</span><span class="p">);</span>

	<span class="n">ramrod_param</span><span class="p">.</span><span class="n">ramrod_flags</span> <span class="o">=</span> <span class="n">ramrod_flags</span><span class="p">;</span>
	<span class="n">ramrod_param</span><span class="p">.</span><span class="n">rx_mode_flags</span> <span class="o">=</span> <span class="n">rx_mode_flags</span><span class="p">;</span>

	<span class="n">ramrod_param</span><span class="p">.</span><span class="n">rx_accept_flags</span> <span class="o">=</span> <span class="n">rx_accept_flags</span><span class="p">;</span>
	<span class="n">ramrod_param</span><span class="p">.</span><span class="n">tx_accept_flags</span> <span class="o">=</span> <span class="n">tx_accept_flags</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">bnx2x_config_rx_mode</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ramrod_param</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BNX2X_ERR</span><span class="p">(</span><span class="s">&quot;Set rx_mode %d failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">rx_mode</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* called with netif_addr_lock_bh() */</span>
<span class="kt">void</span> <span class="nf">bnx2x_set_storm_rx_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">rx_mode_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ramrod_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">rx_accept_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">tx_accept_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="cp">#ifdef BCM_CNIC</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">NO_FCOE</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span>

		<span class="cm">/* Configure rx_mode of FCoE Queue */</span>
		<span class="n">__set_bit</span><span class="p">(</span><span class="n">BNX2X_RX_MODE_FCOE_ETH</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rx_mode_flags</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">rx_mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">BNX2X_RX_MODE_NONE</span>:
		<span class="cm">/*</span>
<span class="cm">		 * &#39;drop all&#39; supersedes any accept flags that may have been</span>
<span class="cm">		 * passed to the function.</span>
<span class="cm">		 */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">BNX2X_RX_MODE_NORMAL</span>:
		<span class="n">__set_bit</span><span class="p">(</span><span class="n">BNX2X_ACCEPT_UNICAST</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rx_accept_flags</span><span class="p">);</span>
		<span class="n">__set_bit</span><span class="p">(</span><span class="n">BNX2X_ACCEPT_MULTICAST</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rx_accept_flags</span><span class="p">);</span>
		<span class="n">__set_bit</span><span class="p">(</span><span class="n">BNX2X_ACCEPT_BROADCAST</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rx_accept_flags</span><span class="p">);</span>

		<span class="cm">/* internal switching mode */</span>
		<span class="n">__set_bit</span><span class="p">(</span><span class="n">BNX2X_ACCEPT_UNICAST</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tx_accept_flags</span><span class="p">);</span>
		<span class="n">__set_bit</span><span class="p">(</span><span class="n">BNX2X_ACCEPT_MULTICAST</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tx_accept_flags</span><span class="p">);</span>
		<span class="n">__set_bit</span><span class="p">(</span><span class="n">BNX2X_ACCEPT_BROADCAST</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tx_accept_flags</span><span class="p">);</span>

		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">BNX2X_RX_MODE_ALLMULTI</span>:
		<span class="n">__set_bit</span><span class="p">(</span><span class="n">BNX2X_ACCEPT_UNICAST</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rx_accept_flags</span><span class="p">);</span>
		<span class="n">__set_bit</span><span class="p">(</span><span class="n">BNX2X_ACCEPT_ALL_MULTICAST</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rx_accept_flags</span><span class="p">);</span>
		<span class="n">__set_bit</span><span class="p">(</span><span class="n">BNX2X_ACCEPT_BROADCAST</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rx_accept_flags</span><span class="p">);</span>

		<span class="cm">/* internal switching mode */</span>
		<span class="n">__set_bit</span><span class="p">(</span><span class="n">BNX2X_ACCEPT_UNICAST</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tx_accept_flags</span><span class="p">);</span>
		<span class="n">__set_bit</span><span class="p">(</span><span class="n">BNX2X_ACCEPT_ALL_MULTICAST</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tx_accept_flags</span><span class="p">);</span>
		<span class="n">__set_bit</span><span class="p">(</span><span class="n">BNX2X_ACCEPT_BROADCAST</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tx_accept_flags</span><span class="p">);</span>

		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">BNX2X_RX_MODE_PROMISC</span>:
		<span class="cm">/* According to deffinition of SI mode, iface in promisc mode</span>
<span class="cm">		 * should receive matched and unmatched (in resolution of port)</span>
<span class="cm">		 * unicast packets.</span>
<span class="cm">		 */</span>
		<span class="n">__set_bit</span><span class="p">(</span><span class="n">BNX2X_ACCEPT_UNMATCHED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rx_accept_flags</span><span class="p">);</span>
		<span class="n">__set_bit</span><span class="p">(</span><span class="n">BNX2X_ACCEPT_UNICAST</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rx_accept_flags</span><span class="p">);</span>
		<span class="n">__set_bit</span><span class="p">(</span><span class="n">BNX2X_ACCEPT_ALL_MULTICAST</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rx_accept_flags</span><span class="p">);</span>
		<span class="n">__set_bit</span><span class="p">(</span><span class="n">BNX2X_ACCEPT_BROADCAST</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rx_accept_flags</span><span class="p">);</span>

		<span class="cm">/* internal switching mode */</span>
		<span class="n">__set_bit</span><span class="p">(</span><span class="n">BNX2X_ACCEPT_ALL_MULTICAST</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tx_accept_flags</span><span class="p">);</span>
		<span class="n">__set_bit</span><span class="p">(</span><span class="n">BNX2X_ACCEPT_BROADCAST</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tx_accept_flags</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">IS_MF_SI</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span>
			<span class="n">__set_bit</span><span class="p">(</span><span class="n">BNX2X_ACCEPT_ALL_UNICAST</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tx_accept_flags</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">__set_bit</span><span class="p">(</span><span class="n">BNX2X_ACCEPT_UNICAST</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tx_accept_flags</span><span class="p">);</span>

		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">BNX2X_ERR</span><span class="p">(</span><span class="s">&quot;Unknown rx_mode: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">rx_mode</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">rx_mode</span> <span class="o">!=</span> <span class="n">BNX2X_RX_MODE_NONE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">__set_bit</span><span class="p">(</span><span class="n">BNX2X_ACCEPT_ANY_VLAN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rx_accept_flags</span><span class="p">);</span>
		<span class="n">__set_bit</span><span class="p">(</span><span class="n">BNX2X_ACCEPT_ANY_VLAN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tx_accept_flags</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">__set_bit</span><span class="p">(</span><span class="n">RAMROD_RX</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ramrod_flags</span><span class="p">);</span>
	<span class="n">__set_bit</span><span class="p">(</span><span class="n">RAMROD_TX</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ramrod_flags</span><span class="p">);</span>

	<span class="n">bnx2x_set_q_rx_mode</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">cl_id</span><span class="p">,</span> <span class="n">rx_mode_flags</span><span class="p">,</span> <span class="n">rx_accept_flags</span><span class="p">,</span>
			    <span class="n">tx_accept_flags</span><span class="p">,</span> <span class="n">ramrod_flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_init_internal_common</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_MF_SI</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span>
		<span class="cm">/*</span>
<span class="cm">		 * In switch independent mode, the TSTORM needs to accept</span>
<span class="cm">		 * packets that failed classification, since approximate match</span>
<span class="cm">		 * mac addresses aren&#39;t written to NIG LLH</span>
<span class="cm">		 */</span>
		<span class="n">REG_WR8</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">BAR_TSTRORM_INTMEM</span> <span class="o">+</span>
			    <span class="n">TSTORM_ACCEPT_CLASSIFY_FAILED_OFFSET</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CHIP_IS_E1</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span> <span class="cm">/* 57710 doesn&#39;t support MF */</span>
		<span class="n">REG_WR8</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">BAR_TSTRORM_INTMEM</span> <span class="o">+</span>
			    <span class="n">TSTORM_ACCEPT_CLASSIFY_FAILED_OFFSET</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* Zero this manually as its initialization is</span>
<span class="cm">	   currently missing in the initTool */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">USTORM_AGG_DATA_SIZE</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">BAR_USTRORM_INTMEM</span> <span class="o">+</span>
		       <span class="n">USTORM_AGG_DATA_OFFSET</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CHIP_IS_E1x</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">REG_WR8</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">BAR_CSTRORM_INTMEM</span> <span class="o">+</span> <span class="n">CSTORM_IGU_MODE_OFFSET</span><span class="p">,</span>
			<span class="n">CHIP_INT_MODE_IS_BC</span><span class="p">(</span><span class="n">bp</span><span class="p">)</span> <span class="o">?</span>
			<span class="n">HC_IGU_BC_MODE</span> <span class="o">:</span> <span class="n">HC_IGU_NBC_MODE</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_init_internal</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">,</span> <span class="n">u32</span> <span class="n">load_code</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">load_code</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">FW_MSG_CODE_DRV_LOAD_COMMON</span>:
	<span class="k">case</span> <span class="n">FW_MSG_CODE_DRV_LOAD_COMMON_CHIP</span>:
		<span class="n">bnx2x_init_internal_common</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
		<span class="cm">/* no break */</span>

	<span class="k">case</span> <span class="n">FW_MSG_CODE_DRV_LOAD_PORT</span>:
		<span class="cm">/* nothing to do */</span>
		<span class="cm">/* no break */</span>

	<span class="k">case</span> <span class="n">FW_MSG_CODE_DRV_LOAD_FUNCTION</span>:
		<span class="cm">/* internal memory per function is</span>
<span class="cm">		   initialized inside bnx2x_pf_init */</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">BNX2X_ERR</span><span class="p">(</span><span class="s">&quot;Unknown load_code (0x%x) from MCP</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">load_code</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u8</span> <span class="nf">bnx2x_fp_igu_sb_id</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x_fastpath</span> <span class="o">*</span><span class="n">fp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">igu_base_sb</span> <span class="o">+</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">+</span> <span class="n">CNIC_PRESENT</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u8</span> <span class="nf">bnx2x_fp_fw_sb_id</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x_fastpath</span> <span class="o">*</span><span class="n">fp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">base_fw_ndsb</span> <span class="o">+</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">+</span> <span class="n">CNIC_PRESENT</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u8</span> <span class="nf">bnx2x_fp_cl_id</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x_fastpath</span> <span class="o">*</span><span class="n">fp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">CHIP_IS_E1x</span><span class="p">(</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">bp</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">BP_L_ID</span><span class="p">(</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">bp</span><span class="p">)</span> <span class="o">+</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>
	<span class="k">else</span>	<span class="cm">/* We want Client ID to be the same as IGU SB ID for 57712 */</span>
		<span class="k">return</span> <span class="n">bnx2x_fp_igu_sb_id</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_init_eth_fp</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">fp_idx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2x_fastpath</span> <span class="o">*</span><span class="n">fp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">fp</span><span class="p">[</span><span class="n">fp_idx</span><span class="p">];</span>
	<span class="n">u8</span> <span class="n">cos</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">q_type</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">cids</span><span class="p">[</span><span class="n">BNX2X_MULTI_TX_COS</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span> <span class="p">};</span>
	<span class="n">fp</span><span class="o">-&gt;</span><span class="n">rx_queue</span> <span class="o">=</span> <span class="n">fp_idx</span><span class="p">;</span>
	<span class="n">fp</span><span class="o">-&gt;</span><span class="n">cid</span> <span class="o">=</span> <span class="n">fp_idx</span><span class="p">;</span>
	<span class="n">fp</span><span class="o">-&gt;</span><span class="n">cl_id</span> <span class="o">=</span> <span class="n">bnx2x_fp_cl_id</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
	<span class="n">fp</span><span class="o">-&gt;</span><span class="n">fw_sb_id</span> <span class="o">=</span> <span class="n">bnx2x_fp_fw_sb_id</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
	<span class="n">fp</span><span class="o">-&gt;</span><span class="n">igu_sb_id</span> <span class="o">=</span> <span class="n">bnx2x_fp_igu_sb_id</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
	<span class="cm">/* qZone id equals to FW (per path) client id */</span>
	<span class="n">fp</span><span class="o">-&gt;</span><span class="n">cl_qzone_id</span>  <span class="o">=</span> <span class="n">bnx2x_fp_qzone_id</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>

	<span class="cm">/* init shortcut */</span>
	<span class="n">fp</span><span class="o">-&gt;</span><span class="n">ustorm_rx_prods_offset</span> <span class="o">=</span> <span class="n">bnx2x_rx_ustorm_prods_offset</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>

	<span class="cm">/* Setup SB indicies */</span>
	<span class="n">fp</span><span class="o">-&gt;</span><span class="n">rx_cons_sb</span> <span class="o">=</span> <span class="n">BNX2X_RX_SB_INDEX</span><span class="p">;</span>

	<span class="cm">/* Configure Queue State object */</span>
	<span class="n">__set_bit</span><span class="p">(</span><span class="n">BNX2X_Q_TYPE_HAS_RX</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">q_type</span><span class="p">);</span>
	<span class="n">__set_bit</span><span class="p">(</span><span class="n">BNX2X_Q_TYPE_HAS_TX</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">q_type</span><span class="p">);</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">max_cos</span> <span class="o">&gt;</span> <span class="n">BNX2X_MULTI_TX_COS</span><span class="p">);</span>

	<span class="cm">/* init tx data */</span>
	<span class="n">for_each_cos_in_tx_queue</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">cos</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bnx2x_init_txdata</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">txdata</span><span class="p">[</span><span class="n">cos</span><span class="p">],</span>
				  <span class="n">CID_COS_TO_TX_ONLY_CID</span><span class="p">(</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">cid</span><span class="p">,</span> <span class="n">cos</span><span class="p">),</span>
				  <span class="n">FP_COS_TO_TXQ</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">cos</span><span class="p">),</span>
				  <span class="n">BNX2X_TX_SB_INDEX_BASE</span> <span class="o">+</span> <span class="n">cos</span><span class="p">);</span>
		<span class="n">cids</span><span class="p">[</span><span class="n">cos</span><span class="p">]</span> <span class="o">=</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">txdata</span><span class="p">[</span><span class="n">cos</span><span class="p">].</span><span class="n">cid</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">bnx2x_init_queue_obj</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">q_obj</span><span class="p">,</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">cl_id</span><span class="p">,</span> <span class="n">cids</span><span class="p">,</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">max_cos</span><span class="p">,</span>
			     <span class="n">BP_FUNC</span><span class="p">(</span><span class="n">bp</span><span class="p">),</span> <span class="n">bnx2x_sp</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">q_rdata</span><span class="p">),</span>
			     <span class="n">bnx2x_sp_mapping</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">q_rdata</span><span class="p">),</span> <span class="n">q_type</span><span class="p">);</span>

	<span class="cm">/**</span>
<span class="cm">	 * Configure classification DBs: Always enable Tx switching</span>
<span class="cm">	 */</span>
	<span class="n">bnx2x_init_vlan_mac_fp_objs</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">BNX2X_OBJ_TYPE_RX_TX</span><span class="p">);</span>

	<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_IFUP</span><span class="p">,</span> <span class="s">&quot;queue[%d]:  bnx2x_init_sb(%p,%p)  cl_id %d  fw_sb %d  igu_sb %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">fp_idx</span><span class="p">,</span> <span class="n">bp</span><span class="p">,</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">status_blk</span><span class="p">.</span><span class="n">e2_sb</span><span class="p">,</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">cl_id</span><span class="p">,</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">fw_sb_id</span><span class="p">,</span>
		   <span class="n">fp</span><span class="o">-&gt;</span><span class="n">igu_sb_id</span><span class="p">);</span>
	<span class="n">bnx2x_init_sb</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">status_blk_mapping</span><span class="p">,</span> <span class="n">BNX2X_VF_ID_INVALID</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span>
		      <span class="n">fp</span><span class="o">-&gt;</span><span class="n">fw_sb_id</span><span class="p">,</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">igu_sb_id</span><span class="p">);</span>

	<span class="n">bnx2x_update_fpsb_idx</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_init_tx_ring_one</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x_fp_txdata</span> <span class="o">*</span><span class="n">txdata</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">NUM_TX_RINGS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">eth_tx_next_bd</span> <span class="o">*</span><span class="n">tx_next_bd</span> <span class="o">=</span>
			<span class="o">&amp;</span><span class="n">txdata</span><span class="o">-&gt;</span><span class="n">tx_desc_ring</span><span class="p">[</span><span class="n">TX_DESC_CNT</span> <span class="o">*</span> <span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">].</span><span class="n">next_bd</span><span class="p">;</span>

		<span class="n">tx_next_bd</span><span class="o">-&gt;</span><span class="n">addr_hi</span> <span class="o">=</span>
			<span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">U64_HI</span><span class="p">(</span><span class="n">txdata</span><span class="o">-&gt;</span><span class="n">tx_desc_mapping</span> <span class="o">+</span>
				    <span class="n">BCM_PAGE_SIZE</span><span class="o">*</span><span class="p">(</span><span class="n">i</span> <span class="o">%</span> <span class="n">NUM_TX_RINGS</span><span class="p">)));</span>
		<span class="n">tx_next_bd</span><span class="o">-&gt;</span><span class="n">addr_lo</span> <span class="o">=</span>
			<span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">U64_LO</span><span class="p">(</span><span class="n">txdata</span><span class="o">-&gt;</span><span class="n">tx_desc_mapping</span> <span class="o">+</span>
				    <span class="n">BCM_PAGE_SIZE</span><span class="o">*</span><span class="p">(</span><span class="n">i</span> <span class="o">%</span> <span class="n">NUM_TX_RINGS</span><span class="p">)));</span>
	<span class="p">}</span>

	<span class="n">SET_FLAG</span><span class="p">(</span><span class="n">txdata</span><span class="o">-&gt;</span><span class="n">tx_db</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">header</span><span class="p">.</span><span class="n">header</span><span class="p">,</span> <span class="n">DOORBELL_HDR_DB_TYPE</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">txdata</span><span class="o">-&gt;</span><span class="n">tx_db</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">zero_fill1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">txdata</span><span class="o">-&gt;</span><span class="n">tx_db</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">prod</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">txdata</span><span class="o">-&gt;</span><span class="n">tx_pkt_prod</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">txdata</span><span class="o">-&gt;</span><span class="n">tx_pkt_cons</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">txdata</span><span class="o">-&gt;</span><span class="n">tx_bd_prod</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">txdata</span><span class="o">-&gt;</span><span class="n">tx_bd_cons</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">txdata</span><span class="o">-&gt;</span><span class="n">tx_pkt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_init_tx_rings</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">cos</span><span class="p">;</span>

	<span class="n">for_each_tx_queue</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
		<span class="n">for_each_cos_in_tx_queue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">fp</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">cos</span><span class="p">)</span>
			<span class="n">bnx2x_init_tx_ring_one</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">fp</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">txdata</span><span class="p">[</span><span class="n">cos</span><span class="p">]);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">bnx2x_nic_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">,</span> <span class="n">u32</span> <span class="n">load_code</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">for_each_eth_queue</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
		<span class="n">bnx2x_init_eth_fp</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
<span class="cp">#ifdef BCM_CNIC</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">NO_FCOE</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span>
		<span class="n">bnx2x_init_fcoe_fp</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>

	<span class="n">bnx2x_init_sb</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">cnic_sb_mapping</span><span class="p">,</span>
		      <span class="n">BNX2X_VF_ID_INVALID</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span>
		      <span class="n">bnx2x_cnic_fw_sb_id</span><span class="p">(</span><span class="n">bp</span><span class="p">),</span> <span class="n">bnx2x_cnic_igu_sb_id</span><span class="p">(</span><span class="n">bp</span><span class="p">));</span>

<span class="cp">#endif</span>

	<span class="cm">/* Initialize MOD_ABS interrupts */</span>
	<span class="n">bnx2x_init_mod_abs_int</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">link_vars</span><span class="p">,</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">.</span><span class="n">chip_id</span><span class="p">,</span>
			       <span class="n">bp</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">.</span><span class="n">shmem_base</span><span class="p">,</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">.</span><span class="n">shmem2_base</span><span class="p">,</span>
			       <span class="n">BP_PORT</span><span class="p">(</span><span class="n">bp</span><span class="p">));</span>
	<span class="cm">/* ensure status block indices were read */</span>
	<span class="n">rmb</span><span class="p">();</span>

	<span class="n">bnx2x_init_def_sb</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
	<span class="n">bnx2x_update_dsb_idx</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
	<span class="n">bnx2x_init_rx_rings</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
	<span class="n">bnx2x_init_tx_rings</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
	<span class="n">bnx2x_init_sp_ring</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
	<span class="n">bnx2x_init_eq_ring</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
	<span class="n">bnx2x_init_internal</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">load_code</span><span class="p">);</span>
	<span class="n">bnx2x_pf_init</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
	<span class="n">bnx2x_stats_init</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>

	<span class="cm">/* flush all before enabling interrupts */</span>
	<span class="n">mb</span><span class="p">();</span>
	<span class="n">mmiowb</span><span class="p">();</span>

	<span class="n">bnx2x_int_enable</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>

	<span class="cm">/* Check for SPIO5 */</span>
	<span class="n">bnx2x_attn_int_deasserted0</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span>
		<span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">MISC_REG_AEU_AFTER_INVERT_1_FUNC_0</span> <span class="o">+</span> <span class="n">BP_PORT</span><span class="p">(</span><span class="n">bp</span><span class="p">)</span><span class="o">*</span><span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span>
				   <span class="n">AEU_INPUTS_ATTN_BITS_SPIO5</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* end of nic init */</span>

<span class="cm">/*</span>
<span class="cm"> * gzip service functions</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bnx2x_gunzip_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bp</span><span class="o">-&gt;</span><span class="n">gunzip_buf</span> <span class="o">=</span> <span class="n">dma_alloc_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">FW_BUF_SIZE</span><span class="p">,</span>
					    <span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">gunzip_mapping</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">gunzip_buf</span>  <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">gunzip_nomem1</span><span class="p">;</span>

	<span class="n">bp</span><span class="o">-&gt;</span><span class="n">strm</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">strm</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">strm</span>  <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">gunzip_nomem2</span><span class="p">;</span>

	<span class="n">bp</span><span class="o">-&gt;</span><span class="n">strm</span><span class="o">-&gt;</span><span class="n">workspace</span> <span class="o">=</span> <span class="n">vmalloc</span><span class="p">(</span><span class="n">zlib_inflate_workspacesize</span><span class="p">());</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">strm</span><span class="o">-&gt;</span><span class="n">workspace</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">gunzip_nomem3</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">gunzip_nomem3:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">strm</span><span class="p">);</span>
	<span class="n">bp</span><span class="o">-&gt;</span><span class="n">strm</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

<span class="nl">gunzip_nomem2:</span>
	<span class="n">dma_free_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">FW_BUF_SIZE</span><span class="p">,</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">gunzip_buf</span><span class="p">,</span>
			  <span class="n">bp</span><span class="o">-&gt;</span><span class="n">gunzip_mapping</span><span class="p">);</span>
	<span class="n">bp</span><span class="o">-&gt;</span><span class="n">gunzip_buf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

<span class="nl">gunzip_nomem1:</span>
	<span class="n">BNX2X_ERR</span><span class="p">(</span><span class="s">&quot;Cannot allocate firmware buffer for un-compression</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_gunzip_end</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">strm</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vfree</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">strm</span><span class="o">-&gt;</span><span class="n">workspace</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">strm</span><span class="p">);</span>
		<span class="n">bp</span><span class="o">-&gt;</span><span class="n">strm</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">gunzip_buf</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dma_free_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">FW_BUF_SIZE</span><span class="p">,</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">gunzip_buf</span><span class="p">,</span>
				  <span class="n">bp</span><span class="o">-&gt;</span><span class="n">gunzip_mapping</span><span class="p">);</span>
		<span class="n">bp</span><span class="o">-&gt;</span><span class="n">gunzip_buf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bnx2x_gunzip</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">,</span> <span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">zbuf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">n</span><span class="p">,</span> <span class="n">rc</span><span class="p">;</span>

	<span class="cm">/* check gzip header */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">zbuf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mh">0x1f</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">zbuf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="mh">0x8b</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">zbuf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">!=</span> <span class="n">Z_DEFLATED</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">BNX2X_ERR</span><span class="p">(</span><span class="s">&quot;Bad gzip header</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">n</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>

<span class="cp">#define FNAME				0x8</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">zbuf</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">FNAME</span><span class="p">)</span>
		<span class="k">while</span> <span class="p">((</span><span class="n">zbuf</span><span class="p">[</span><span class="n">n</span><span class="o">++</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">n</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">));</span>

	<span class="n">bp</span><span class="o">-&gt;</span><span class="n">strm</span><span class="o">-&gt;</span><span class="n">next_in</span> <span class="o">=</span> <span class="p">(</span><span class="n">typeof</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">strm</span><span class="o">-&gt;</span><span class="n">next_in</span><span class="p">))</span><span class="n">zbuf</span> <span class="o">+</span> <span class="n">n</span><span class="p">;</span>
	<span class="n">bp</span><span class="o">-&gt;</span><span class="n">strm</span><span class="o">-&gt;</span><span class="n">avail_in</span> <span class="o">=</span> <span class="n">len</span> <span class="o">-</span> <span class="n">n</span><span class="p">;</span>
	<span class="n">bp</span><span class="o">-&gt;</span><span class="n">strm</span><span class="o">-&gt;</span><span class="n">next_out</span> <span class="o">=</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">gunzip_buf</span><span class="p">;</span>
	<span class="n">bp</span><span class="o">-&gt;</span><span class="n">strm</span><span class="o">-&gt;</span><span class="n">avail_out</span> <span class="o">=</span> <span class="n">FW_BUF_SIZE</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">zlib_inflateInit2</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">strm</span><span class="p">,</span> <span class="o">-</span><span class="n">MAX_WBITS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="n">Z_OK</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">zlib_inflate</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">strm</span><span class="p">,</span> <span class="n">Z_FINISH</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">rc</span> <span class="o">!=</span> <span class="n">Z_OK</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="n">Z_STREAM_END</span><span class="p">))</span>
		<span class="n">netdev_err</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Firmware decompression error: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">bp</span><span class="o">-&gt;</span><span class="n">strm</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">);</span>

	<span class="n">bp</span><span class="o">-&gt;</span><span class="n">gunzip_outlen</span> <span class="o">=</span> <span class="p">(</span><span class="n">FW_BUF_SIZE</span> <span class="o">-</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">strm</span><span class="o">-&gt;</span><span class="n">avail_out</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">gunzip_outlen</span> <span class="o">&amp;</span> <span class="mh">0x3</span><span class="p">)</span>
		<span class="n">netdev_err</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			   <span class="s">&quot;Firmware decompression error: gunzip_outlen (%d) not aligned</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">bp</span><span class="o">-&gt;</span><span class="n">gunzip_outlen</span><span class="p">);</span>
	<span class="n">bp</span><span class="o">-&gt;</span><span class="n">gunzip_outlen</span> <span class="o">&gt;&gt;=</span> <span class="mi">2</span><span class="p">;</span>

	<span class="n">zlib_inflateEnd</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">strm</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="n">Z_STREAM_END</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* nic load/unload */</span>

<span class="cm">/*</span>
<span class="cm"> * General service functions</span>
<span class="cm"> */</span>

<span class="cm">/* send a NIG loopback debug packet */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_lb_pckt</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">wb_write</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>

	<span class="cm">/* Ethernet source and destination addresses */</span>
	<span class="n">wb_write</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x55555555</span><span class="p">;</span>
	<span class="n">wb_write</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x55555555</span><span class="p">;</span>
	<span class="n">wb_write</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x20</span><span class="p">;</span>		<span class="cm">/* SOP */</span>
	<span class="n">REG_WR_DMAE</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">NIG_REG_DEBUG_PACKET_LB</span><span class="p">,</span> <span class="n">wb_write</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>

	<span class="cm">/* NON-IP protocol */</span>
	<span class="n">wb_write</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x09000000</span><span class="p">;</span>
	<span class="n">wb_write</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x55555555</span><span class="p">;</span>
	<span class="n">wb_write</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x10</span><span class="p">;</span>		<span class="cm">/* EOP, eop_bvalid = 0 */</span>
	<span class="n">REG_WR_DMAE</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">NIG_REG_DEBUG_PACKET_LB</span><span class="p">,</span> <span class="n">wb_write</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* some of the internal memories</span>
<span class="cm"> * are not directly readable from the driver</span>
<span class="cm"> * to test them we send debug packets</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">bnx2x_int_mem_test</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">factor</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">count</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">CHIP_REV_IS_FPGA</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span>
		<span class="n">factor</span> <span class="o">=</span> <span class="mi">120</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">CHIP_REV_IS_EMUL</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span>
		<span class="n">factor</span> <span class="o">=</span> <span class="mi">200</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">factor</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* Disable inputs of parser neighbor blocks */</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">TSDM_REG_ENABLE_IN1</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">TCM_REG_PRS_IFEN</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">CFC_REG_DEBUG0</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">);</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">NIG_REG_PRS_REQ_IN_EN</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>

	<span class="cm">/*  Write 0 to parser credits for CFC search request */</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">PRS_REG_CFC_SEARCH_INITIAL_CREDIT</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>

	<span class="cm">/* send Ethernet packet */</span>
	<span class="n">bnx2x_lb_pckt</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>

	<span class="cm">/* TODO do i reset NIG statistic? */</span>
	<span class="cm">/* Wait until NIG register shows 1 packet of size 0x10 */</span>
	<span class="n">count</span> <span class="o">=</span> <span class="mi">1000</span> <span class="o">*</span> <span class="n">factor</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">count</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">bnx2x_read_dmae</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">NIG_REG_STAT2_BRB_OCTET</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
		<span class="n">val</span> <span class="o">=</span> <span class="o">*</span><span class="n">bnx2x_sp</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">wb_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">==</span> <span class="mh">0x10</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">msleep</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
		<span class="n">count</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">!=</span> <span class="mh">0x10</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BNX2X_ERR</span><span class="p">(</span><span class="s">&quot;NIG timeout  val = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Wait until PRS register shows 1 packet */</span>
	<span class="n">count</span> <span class="o">=</span> <span class="mi">1000</span> <span class="o">*</span> <span class="n">factor</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">count</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">PRS_REG_NUM_OF_PACKETS</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">msleep</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
		<span class="n">count</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">!=</span> <span class="mh">0x1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BNX2X_ERR</span><span class="p">(</span><span class="s">&quot;PRS timeout val = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Reset and init BRB, PRS */</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">GRCBASE_MISC</span> <span class="o">+</span> <span class="n">MISC_REGISTERS_RESET_REG_1_CLEAR</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">);</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">50</span><span class="p">);</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">GRCBASE_MISC</span> <span class="o">+</span> <span class="n">MISC_REGISTERS_RESET_REG_1_SET</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">);</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">50</span><span class="p">);</span>
	<span class="n">bnx2x_init_block</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">BLOCK_BRB1</span><span class="p">,</span> <span class="n">PHASE_COMMON</span><span class="p">);</span>
	<span class="n">bnx2x_init_block</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">BLOCK_PRS</span><span class="p">,</span> <span class="n">PHASE_COMMON</span><span class="p">);</span>

	<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_HW</span><span class="p">,</span> <span class="s">&quot;part2</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* Disable inputs of parser neighbor blocks */</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">TSDM_REG_ENABLE_IN1</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">TCM_REG_PRS_IFEN</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">CFC_REG_DEBUG0</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">);</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">NIG_REG_PRS_REQ_IN_EN</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>

	<span class="cm">/* Write 0 to parser credits for CFC search request */</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">PRS_REG_CFC_SEARCH_INITIAL_CREDIT</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>

	<span class="cm">/* send 10 Ethernet packets */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">bnx2x_lb_pckt</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>

	<span class="cm">/* Wait until NIG register shows 10 + 1</span>
<span class="cm">	   packets of size 11*0x10 = 0xb0 */</span>
	<span class="n">count</span> <span class="o">=</span> <span class="mi">1000</span> <span class="o">*</span> <span class="n">factor</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">count</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">bnx2x_read_dmae</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">NIG_REG_STAT2_BRB_OCTET</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
		<span class="n">val</span> <span class="o">=</span> <span class="o">*</span><span class="n">bnx2x_sp</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">wb_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">==</span> <span class="mh">0xb0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">msleep</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
		<span class="n">count</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">!=</span> <span class="mh">0xb0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BNX2X_ERR</span><span class="p">(</span><span class="s">&quot;NIG timeout  val = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">3</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Wait until PRS register shows 2 packets */</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">PRS_REG_NUM_OF_PACKETS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">)</span>
		<span class="n">BNX2X_ERR</span><span class="p">(</span><span class="s">&quot;PRS timeout  val = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

	<span class="cm">/* Write 1 to parser credits for CFC search request */</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">PRS_REG_CFC_SEARCH_INITIAL_CREDIT</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">);</span>

	<span class="cm">/* Wait until PRS register shows 3 packets */</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">10</span> <span class="o">*</span> <span class="n">factor</span><span class="p">);</span>
	<span class="cm">/* Wait until NIG register shows 1 packet of size 0x10 */</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">PRS_REG_NUM_OF_PACKETS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">)</span>
		<span class="n">BNX2X_ERR</span><span class="p">(</span><span class="s">&quot;PRS timeout  val = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

	<span class="cm">/* clear NIG EOP FIFO */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">11</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">NIG_REG_INGRESS_EOP_LB_FIFO</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">NIG_REG_INGRESS_EOP_LB_EMPTY</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BNX2X_ERR</span><span class="p">(</span><span class="s">&quot;clear of NIG failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">4</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Reset and init BRB, PRS, NIG */</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">GRCBASE_MISC</span> <span class="o">+</span> <span class="n">MISC_REGISTERS_RESET_REG_1_CLEAR</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">);</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">50</span><span class="p">);</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">GRCBASE_MISC</span> <span class="o">+</span> <span class="n">MISC_REGISTERS_RESET_REG_1_SET</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">);</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">50</span><span class="p">);</span>
	<span class="n">bnx2x_init_block</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">BLOCK_BRB1</span><span class="p">,</span> <span class="n">PHASE_COMMON</span><span class="p">);</span>
	<span class="n">bnx2x_init_block</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">BLOCK_PRS</span><span class="p">,</span> <span class="n">PHASE_COMMON</span><span class="p">);</span>
<span class="cp">#ifndef BCM_CNIC</span>
	<span class="cm">/* set NIC mode */</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">PRS_REG_NIC_MODE</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="cm">/* Enable inputs of parser neighbor blocks */</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">TSDM_REG_ENABLE_IN1</span><span class="p">,</span> <span class="mh">0x7fffffff</span><span class="p">);</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">TCM_REG_PRS_IFEN</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">);</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">CFC_REG_DEBUG0</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">NIG_REG_PRS_REQ_IN_EN</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">);</span>

	<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_HW</span><span class="p">,</span> <span class="s">&quot;done</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* OK */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_enable_blocks_attention</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">PXP_REG_PXP_INT_MASK_0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CHIP_IS_E1x</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span>
		<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">PXP_REG_PXP_INT_MASK_1</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">PXP_REG_PXP_INT_MASK_1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">DORQ_REG_DORQ_INT_MASK</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">CFC_REG_CFC_INT_MASK</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * mask read length error interrupts in brb for parser</span>
<span class="cm">	 * (parsing unit and &#39;checksum and crc&#39; unit)</span>
<span class="cm">	 * these errors are legal (PU reads fixed length and CAC can cause</span>
<span class="cm">	 * read length error on truncated packets)</span>
<span class="cm">	 */</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">BRB1_REG_BRB1_INT_MASK</span><span class="p">,</span> <span class="mh">0xFC00</span><span class="p">);</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">QM_REG_QM_INT_MASK</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">TM_REG_TM_INT_MASK</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">XSDM_REG_XSDM_INT_MASK_0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">XSDM_REG_XSDM_INT_MASK_1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">XCM_REG_XCM_INT_MASK</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="cm">/*	REG_WR(bp, XSEM_REG_XSEM_INT_MASK_0, 0); */</span>
<span class="cm">/*	REG_WR(bp, XSEM_REG_XSEM_INT_MASK_1, 0); */</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">USDM_REG_USDM_INT_MASK_0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">USDM_REG_USDM_INT_MASK_1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">UCM_REG_UCM_INT_MASK</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="cm">/*	REG_WR(bp, USEM_REG_USEM_INT_MASK_0, 0); */</span>
<span class="cm">/*	REG_WR(bp, USEM_REG_USEM_INT_MASK_1, 0); */</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">GRCBASE_UPB</span> <span class="o">+</span> <span class="n">PB_REG_PB_INT_MASK</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">CSDM_REG_CSDM_INT_MASK_0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">CSDM_REG_CSDM_INT_MASK_1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">CCM_REG_CCM_INT_MASK</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="cm">/*	REG_WR(bp, CSEM_REG_CSEM_INT_MASK_0, 0); */</span>
<span class="cm">/*	REG_WR(bp, CSEM_REG_CSEM_INT_MASK_1, 0); */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">CHIP_REV_IS_FPGA</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span>
		<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">PXP2_REG_PXP2_INT_MASK_0</span><span class="p">,</span> <span class="mh">0x580000</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CHIP_IS_E1x</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span>
		<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">PXP2_REG_PXP2_INT_MASK_0</span><span class="p">,</span>
			   <span class="p">(</span><span class="n">PXP2_PXP2_INT_MASK_0_REG_PGL_CPL_OF</span>
				<span class="o">|</span> <span class="n">PXP2_PXP2_INT_MASK_0_REG_PGL_CPL_AFT</span>
				<span class="o">|</span> <span class="n">PXP2_PXP2_INT_MASK_0_REG_PGL_PCIE_ATTN</span>
				<span class="o">|</span> <span class="n">PXP2_PXP2_INT_MASK_0_REG_PGL_READ_BLOCKED</span>
				<span class="o">|</span> <span class="n">PXP2_PXP2_INT_MASK_0_REG_PGL_WRITE_BLOCKED</span><span class="p">));</span>
	<span class="k">else</span>
		<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">PXP2_REG_PXP2_INT_MASK_0</span><span class="p">,</span> <span class="mh">0x480000</span><span class="p">);</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">TSDM_REG_TSDM_INT_MASK_0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">TSDM_REG_TSDM_INT_MASK_1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">TCM_REG_TCM_INT_MASK</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="cm">/*	REG_WR(bp, TSEM_REG_TSEM_INT_MASK_0, 0); */</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CHIP_IS_E1x</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span>
		<span class="cm">/* enable VFC attentions: bits 11 and 12, bits 31:13 reserved */</span>
		<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">TSEM_REG_TSEM_INT_MASK_1</span><span class="p">,</span> <span class="mh">0x07ff</span><span class="p">);</span>

	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">CDU_REG_CDU_INT_MASK</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">DMAE_REG_DMAE_INT_MASK</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="cm">/*	REG_WR(bp, MISC_REG_MISC_INT_MASK, 0); */</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">PBF_REG_PBF_INT_MASK</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">);</span>		<span class="cm">/* bit 3,4 masked */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_reset_common</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">val</span> <span class="o">=</span> <span class="mh">0x1400</span><span class="p">;</span>

	<span class="cm">/* reset_common */</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">GRCBASE_MISC</span> <span class="o">+</span> <span class="n">MISC_REGISTERS_RESET_REG_1_CLEAR</span><span class="p">,</span>
	       <span class="mh">0xd3ffff7f</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">CHIP_IS_E3</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">MISC_REGISTERS_RESET_REG_2_MSTAT0</span><span class="p">;</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">MISC_REGISTERS_RESET_REG_2_MSTAT1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">GRCBASE_MISC</span> <span class="o">+</span> <span class="n">MISC_REGISTERS_RESET_REG_2_CLEAR</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_setup_dmae</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bp</span><span class="o">-&gt;</span><span class="n">dmae_ready</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">dmae_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_init_pxp</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">devctl</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">r_order</span><span class="p">,</span> <span class="n">w_order</span><span class="p">;</span>

	<span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span>
			     <span class="n">pci_pcie_cap</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">)</span> <span class="o">+</span> <span class="n">PCI_EXP_DEVCTL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">devctl</span><span class="p">);</span>
	<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_HW</span><span class="p">,</span> <span class="s">&quot;read 0x%x from devctl</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">devctl</span><span class="p">);</span>
	<span class="n">w_order</span> <span class="o">=</span> <span class="p">((</span><span class="n">devctl</span> <span class="o">&amp;</span> <span class="n">PCI_EXP_DEVCTL_PAYLOAD</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">mrrs</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="n">r_order</span> <span class="o">=</span> <span class="p">((</span><span class="n">devctl</span> <span class="o">&amp;</span> <span class="n">PCI_EXP_DEVCTL_READRQ</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_HW</span><span class="p">,</span> <span class="s">&quot;force read order to %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">mrrs</span><span class="p">);</span>
		<span class="n">r_order</span> <span class="o">=</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">mrrs</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">bnx2x_init_pxp_arb</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">r_order</span><span class="p">,</span> <span class="n">w_order</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_setup_fan_failure_detection</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">is_required</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">port</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">BP_NOMCP</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">is_required</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">SHMEM_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">dev_info</span><span class="p">.</span><span class="n">shared_hw_config</span><span class="p">.</span><span class="n">config2</span><span class="p">)</span> <span class="o">&amp;</span>
	      <span class="n">SHARED_HW_CFG_FAN_FAILURE_MASK</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">==</span> <span class="n">SHARED_HW_CFG_FAN_FAILURE_ENABLED</span><span class="p">)</span>
		<span class="n">is_required</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * The fan failure mechanism is usually related to the PHY type since</span>
<span class="cm">	 * the power consumption of the board is affected by the PHY. Currently,</span>
<span class="cm">	 * fan is required for most designs with SFX7101, BCM8727 and BCM8481.</span>
<span class="cm">	 */</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">==</span> <span class="n">SHARED_HW_CFG_FAN_FAILURE_PHY_TYPE</span><span class="p">)</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">port</span> <span class="o">=</span> <span class="n">PORT_0</span><span class="p">;</span> <span class="n">port</span> <span class="o">&lt;</span> <span class="n">PORT_MAX</span><span class="p">;</span> <span class="n">port</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">is_required</span> <span class="o">|=</span>
				<span class="n">bnx2x_fan_failure_det_req</span><span class="p">(</span>
					<span class="n">bp</span><span class="p">,</span>
					<span class="n">bp</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">.</span><span class="n">shmem_base</span><span class="p">,</span>
					<span class="n">bp</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">.</span><span class="n">shmem2_base</span><span class="p">,</span>
					<span class="n">port</span><span class="p">);</span>
		<span class="p">}</span>

	<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_HW</span><span class="p">,</span> <span class="s">&quot;fan detection setting: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">is_required</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_required</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* Fan failure is indicated by SPIO 5 */</span>
	<span class="n">bnx2x_set_spio</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">MISC_REGISTERS_SPIO_5</span><span class="p">,</span>
		       <span class="n">MISC_REGISTERS_SPIO_INPUT_HI_Z</span><span class="p">);</span>

	<span class="cm">/* set to active low mode */</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">MISC_REG_SPIO_INT</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">|=</span> <span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">MISC_REGISTERS_SPIO_5</span><span class="p">)</span> <span class="o">&lt;&lt;</span>
					<span class="n">MISC_REGISTERS_SPIO_INT_OLD_SET_POS</span><span class="p">);</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">MISC_REG_SPIO_INT</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

	<span class="cm">/* enable interrupt to signal the IGU */</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">MISC_REG_SPIO_EVENT_EN</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">MISC_REGISTERS_SPIO_5</span><span class="p">);</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">MISC_REG_SPIO_EVENT_EN</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_pretend_func</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">,</span> <span class="n">u8</span> <span class="n">pretend_func_num</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">CHIP_IS_E1</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">CHIP_IS_E1H</span><span class="p">(</span><span class="n">bp</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">pretend_func_num</span> <span class="o">&gt;=</span> <span class="n">E1H_FUNC_MAX</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">BP_ABS_FUNC</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="n">offset</span> <span class="o">=</span> <span class="n">PXP2_REG_PGL_PRETEND_FUNC_F0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">offset</span> <span class="o">=</span> <span class="n">PXP2_REG_PGL_PRETEND_FUNC_F1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="n">offset</span> <span class="o">=</span> <span class="n">PXP2_REG_PGL_PRETEND_FUNC_F2</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">3</span>:
		<span class="n">offset</span> <span class="o">=</span> <span class="n">PXP2_REG_PGL_PRETEND_FUNC_F3</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">4</span>:
		<span class="n">offset</span> <span class="o">=</span> <span class="n">PXP2_REG_PGL_PRETEND_FUNC_F4</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">5</span>:
		<span class="n">offset</span> <span class="o">=</span> <span class="n">PXP2_REG_PGL_PRETEND_FUNC_F5</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">6</span>:
		<span class="n">offset</span> <span class="o">=</span> <span class="n">PXP2_REG_PGL_PRETEND_FUNC_F6</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">7</span>:
		<span class="n">offset</span> <span class="o">=</span> <span class="n">PXP2_REG_PGL_PRETEND_FUNC_F7</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">pretend_func_num</span><span class="p">);</span>
	<span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">offset</span><span class="p">);</span>
	<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_HW</span><span class="p">,</span> <span class="s">&quot;Pretending to func %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pretend_func_num</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">bnx2x_pf_disable</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">val</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">IGU_REG_PF_CONFIGURATION</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">IGU_PF_CONF_FUNC_EN</span><span class="p">;</span>

	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">IGU_REG_PF_CONFIGURATION</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">PGLUE_B_REG_INTERNAL_PFID_ENABLE_MASTER</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">CFC_REG_WEAK_ENABLE_PF</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x__common_init_phy</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">shmem_base</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">shmem2_base</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="n">shmem_base</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span>  <span class="n">bp</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">.</span><span class="n">shmem_base</span><span class="p">;</span>
	<span class="n">shmem2_base</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">.</span><span class="n">shmem2_base</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CHIP_IS_E1x</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">shmem_base</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span>
			<span class="n">SHMEM2_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">other_shmem_base_addr</span><span class="p">);</span>
		<span class="n">shmem2_base</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span>
			<span class="n">SHMEM2_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">other_shmem2_base_addr</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">bnx2x_acquire_phy_lock</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
	<span class="n">bnx2x_common_init_phy</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">shmem_base</span><span class="p">,</span> <span class="n">shmem2_base</span><span class="p">,</span>
			      <span class="n">bp</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">.</span><span class="n">chip_id</span><span class="p">);</span>
	<span class="n">bnx2x_release_phy_lock</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * bnx2x_init_hw_common - initialize the HW at the COMMON phase.</span>
<span class="cm"> *</span>
<span class="cm"> * @bp:		driver handle</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">bnx2x_init_hw_common</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_HW</span><span class="p">,</span> <span class="s">&quot;starting common init  func %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">BP_ABS_FUNC</span><span class="p">(</span><span class="n">bp</span><span class="p">));</span>

	<span class="cm">/*</span>
<span class="cm">	 * take the UNDI lock to protect undi_unload flow from accessing</span>
<span class="cm">	 * registers while we&#39;re resetting the chip</span>
<span class="cm">	 */</span>
	<span class="n">bnx2x_acquire_hw_lock</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">HW_LOCK_RESOURCE_RESET</span><span class="p">);</span>

	<span class="n">bnx2x_reset_common</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">GRCBASE_MISC</span> <span class="o">+</span> <span class="n">MISC_REGISTERS_RESET_REG_1_SET</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">);</span>

	<span class="n">val</span> <span class="o">=</span> <span class="mh">0xfffc</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">CHIP_IS_E3</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">MISC_REGISTERS_RESET_REG_2_MSTAT0</span><span class="p">;</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">MISC_REGISTERS_RESET_REG_2_MSTAT1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">GRCBASE_MISC</span> <span class="o">+</span> <span class="n">MISC_REGISTERS_RESET_REG_2_SET</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

	<span class="n">bnx2x_release_hw_lock</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">HW_LOCK_RESOURCE_RESET</span><span class="p">);</span>

	<span class="n">bnx2x_init_block</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">BLOCK_MISC</span><span class="p">,</span> <span class="n">PHASE_COMMON</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CHIP_IS_E1x</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="n">abs_func_id</span><span class="p">;</span>

		<span class="cm">/**</span>
<span class="cm">		 * 4-port mode or 2-port mode we need to turn of master-enable</span>
<span class="cm">		 * for everyone, after that, turn it back on for self.</span>
<span class="cm">		 * so, we disregard multi-function or not, and always disable</span>
<span class="cm">		 * for all functions on the given path, this means 0,2,4,6 for</span>
<span class="cm">		 * path 0 and 1,3,5,7 for path 1</span>
<span class="cm">		 */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">abs_func_id</span> <span class="o">=</span> <span class="n">BP_PATH</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
		     <span class="n">abs_func_id</span> <span class="o">&lt;</span> <span class="n">E2_FUNC_MAX</span><span class="o">*</span><span class="mi">2</span><span class="p">;</span> <span class="n">abs_func_id</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">abs_func_id</span> <span class="o">==</span> <span class="n">BP_ABS_FUNC</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span>
				    <span class="n">PGLUE_B_REG_INTERNAL_PFID_ENABLE_MASTER</span><span class="p">,</span>
				    <span class="mi">1</span><span class="p">);</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">bnx2x_pretend_func</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">abs_func_id</span><span class="p">);</span>
			<span class="cm">/* clear pf enable */</span>
			<span class="n">bnx2x_pf_disable</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
			<span class="n">bnx2x_pretend_func</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">BP_ABS_FUNC</span><span class="p">(</span><span class="n">bp</span><span class="p">));</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">bnx2x_init_block</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">BLOCK_PXP</span><span class="p">,</span> <span class="n">PHASE_COMMON</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">CHIP_IS_E1</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* enable HW interrupt from PXP on USDM overflow</span>
<span class="cm">		   bit 16 on INT_MASK_0 */</span>
		<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">PXP_REG_PXP_INT_MASK_0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">bnx2x_init_block</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">BLOCK_PXP2</span><span class="p">,</span> <span class="n">PHASE_COMMON</span><span class="p">);</span>
	<span class="n">bnx2x_init_pxp</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>

<span class="cp">#ifdef __BIG_ENDIAN</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">PXP2_REG_RQ_QM_ENDIAN_M</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">PXP2_REG_RQ_TM_ENDIAN_M</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">PXP2_REG_RQ_SRC_ENDIAN_M</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">PXP2_REG_RQ_CDU_ENDIAN_M</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">PXP2_REG_RQ_DBG_ENDIAN_M</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="cm">/* make sure this value is 0 */</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">PXP2_REG_RQ_HC_ENDIAN_M</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

<span class="cm">/*	REG_WR(bp, PXP2_REG_RD_PBF_SWAP_MODE, 1); */</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">PXP2_REG_RD_QM_SWAP_MODE</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">PXP2_REG_RD_TM_SWAP_MODE</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">PXP2_REG_RD_SRC_SWAP_MODE</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">PXP2_REG_RD_CDURD_SWAP_MODE</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="n">bnx2x_ilt_init_page_size</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">INITOP_SET</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">CHIP_REV_IS_FPGA</span><span class="p">(</span><span class="n">bp</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">CHIP_IS_E1H</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span>
		<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">PXP2_REG_PGL_TAGS_LIMIT</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">);</span>

	<span class="cm">/* let the HW do it&#39;s magic ... */</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
	<span class="cm">/* finish PXP init */</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">PXP2_REG_RQ_CFG_DONE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BNX2X_ERR</span><span class="p">(</span><span class="s">&quot;PXP2 CFG failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">PXP2_REG_RD_INIT_DONE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BNX2X_ERR</span><span class="p">(</span><span class="s">&quot;PXP2 RD_INIT failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Timers bug workaround E2 only. We need to set the entire ILT to</span>
<span class="cm">	 * have entries with value &quot;0&quot; and valid bit on.</span>
<span class="cm">	 * This needs to be done by the first PF that is loaded in a path</span>
<span class="cm">	 * (i.e. common phase)</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CHIP_IS_E1x</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span> <span class="p">{</span>
<span class="cm">/* In E2 there is a bug in the timers block that can cause function 6 / 7</span>
<span class="cm"> * (i.e. vnic3) to start even if it is marked as &quot;scan-off&quot;.</span>
<span class="cm"> * This occurs when a different function (func2,3) is being marked</span>
<span class="cm"> * as &quot;scan-off&quot;. Real-life scenario for example: if a driver is being</span>
<span class="cm"> * load-unloaded while func6,7 are down. This will cause the timer to access</span>
<span class="cm"> * the ilt, translate to a logical address and send a request to read/write.</span>
<span class="cm"> * Since the ilt for the function that is down is not valid, this will cause</span>
<span class="cm"> * a translation error which is unrecoverable.</span>
<span class="cm"> * The Workaround is intended to make sure that when this happens nothing fatal</span>
<span class="cm"> * will occur. The workaround:</span>
<span class="cm"> *	1.  First PF driver which loads on a path will:</span>
<span class="cm"> *		a.  After taking the chip out of reset, by using pretend,</span>
<span class="cm"> *		    it will write &quot;0&quot; to the following registers of</span>
<span class="cm"> *		    the other vnics.</span>
<span class="cm"> *		    REG_WR(pdev, PGLUE_B_REG_INTERNAL_PFID_ENABLE_MASTER, 0);</span>
<span class="cm"> *		    REG_WR(pdev, CFC_REG_WEAK_ENABLE_PF,0);</span>
<span class="cm"> *		    REG_WR(pdev, CFC_REG_STRONG_ENABLE_PF,0);</span>
<span class="cm"> *		    And for itself it will write &#39;1&#39; to</span>
<span class="cm"> *		    PGLUE_B_REG_INTERNAL_PFID_ENABLE_MASTER to enable</span>
<span class="cm"> *		    dmae-operations (writing to pram for example.)</span>
<span class="cm"> *		    note: can be done for only function 6,7 but cleaner this</span>
<span class="cm"> *			  way.</span>
<span class="cm"> *		b.  Write zero+valid to the entire ILT.</span>
<span class="cm"> *		c.  Init the first_timers_ilt_entry, last_timers_ilt_entry of</span>
<span class="cm"> *		    VNIC3 (of that port). The range allocated will be the</span>
<span class="cm"> *		    entire ILT. This is needed to prevent  ILT range error.</span>
<span class="cm"> *	2.  Any PF driver load flow:</span>
<span class="cm"> *		a.  ILT update with the physical addresses of the allocated</span>
<span class="cm"> *		    logical pages.</span>
<span class="cm"> *		b.  Wait 20msec. - note that this timeout is needed to make</span>
<span class="cm"> *		    sure there are no requests in one of the PXP internal</span>
<span class="cm"> *		    queues with &quot;old&quot; ILT addresses.</span>
<span class="cm"> *		c.  PF enable in the PGLC.</span>
<span class="cm"> *		d.  Clear the was_error of the PF in the PGLC. (could have</span>
<span class="cm"> *		    occured while driver was down)</span>
<span class="cm"> *		e.  PF enable in the CFC (WEAK + STRONG)</span>
<span class="cm"> *		f.  Timers scan enable</span>
<span class="cm"> *	3.  PF driver unload flow:</span>
<span class="cm"> *		a.  Clear the Timers scan_en.</span>
<span class="cm"> *		b.  Polling for scan_on=0 for that PF.</span>
<span class="cm"> *		c.  Clear the PF enable bit in the PXP.</span>
<span class="cm"> *		d.  Clear the PF enable in the CFC (WEAK + STRONG)</span>
<span class="cm"> *		e.  Write zero+valid to all ILT entries (The valid bit must</span>
<span class="cm"> *		    stay set)</span>
<span class="cm"> *		f.  If this is VNIC 3 of a port then also init</span>
<span class="cm"> *		    first_timers_ilt_entry to zero and last_timers_ilt_entry</span>
<span class="cm"> *		    to the last enrty in the ILT.</span>
<span class="cm"> *</span>
<span class="cm"> *	Notes:</span>
<span class="cm"> *	Currently the PF error in the PGLC is non recoverable.</span>
<span class="cm"> *	In the future the there will be a recovery routine for this error.</span>
<span class="cm"> *	Currently attention is masked.</span>
<span class="cm"> *	Having an MCP lock on the load/unload process does not guarantee that</span>
<span class="cm"> *	there is no Timer disable during Func6/7 enable. This is because the</span>
<span class="cm"> *	Timers scan is currently being cleared by the MCP on FLR.</span>
<span class="cm"> *	Step 2.d can be done only for PF6/7 and the driver can also check if</span>
<span class="cm"> *	there is error before clearing it. But the flow above is simpler and</span>
<span class="cm"> *	more general.</span>
<span class="cm"> *	All ILT entries are written by zero+valid and not just PF6/7</span>
<span class="cm"> *	ILT entries since in the future the ILT entries allocation for</span>
<span class="cm"> *	PF-s might be dynamic.</span>
<span class="cm"> */</span>
		<span class="k">struct</span> <span class="n">ilt_client_info</span> <span class="n">ilt_cli</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">bnx2x_ilt</span> <span class="n">ilt</span><span class="p">;</span>
		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ilt_cli</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ilt_client_info</span><span class="p">));</span>
		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ilt</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x_ilt</span><span class="p">));</span>

		<span class="cm">/* initialize dummy TM client */</span>
		<span class="n">ilt_cli</span><span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ilt_cli</span><span class="p">.</span><span class="n">end</span> <span class="o">=</span> <span class="n">ILT_NUM_PAGE_ENTRIES</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">ilt_cli</span><span class="p">.</span><span class="n">client_num</span> <span class="o">=</span> <span class="n">ILT_CLIENT_TM</span><span class="p">;</span>

		<span class="cm">/* Step 1: set zeroes to all ilt page entries with valid bit on</span>
<span class="cm">		 * Step 2: set the timers first/last ilt entry to point</span>
<span class="cm">		 * to the entire range to prevent ILT range error for 3rd/4th</span>
<span class="cm">		 * vnic	(this code assumes existance of the vnic)</span>
<span class="cm">		 *</span>
<span class="cm">		 * both steps performed by call to bnx2x_ilt_client_init_op()</span>
<span class="cm">		 * with dummy TM client</span>
<span class="cm">		 *</span>
<span class="cm">		 * we must use pretend since PXP2_REG_RQ_##blk##_FIRST_ILT</span>
<span class="cm">		 * and his brother are split registers</span>
<span class="cm">		 */</span>
		<span class="n">bnx2x_pretend_func</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="p">(</span><span class="n">BP_PATH</span><span class="p">(</span><span class="n">bp</span><span class="p">)</span> <span class="o">+</span> <span class="mi">6</span><span class="p">));</span>
		<span class="n">bnx2x_ilt_client_init_op_ilt</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ilt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ilt_cli</span><span class="p">,</span> <span class="n">INITOP_CLEAR</span><span class="p">);</span>
		<span class="n">bnx2x_pretend_func</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">BP_ABS_FUNC</span><span class="p">(</span><span class="n">bp</span><span class="p">));</span>

		<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">PXP2_REG_RQ_DRAM_ALIGN</span><span class="p">,</span> <span class="n">BNX2X_PXP_DRAM_ALIGN</span><span class="p">);</span>
		<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">PXP2_REG_RQ_DRAM_ALIGN_RD</span><span class="p">,</span> <span class="n">BNX2X_PXP_DRAM_ALIGN</span><span class="p">);</span>
		<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">PXP2_REG_RQ_DRAM_ALIGN_SEL</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>


	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">PXP2_REG_RQ_DISABLE_INPUTS</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">PXP2_REG_RD_DISABLE_INPUTS</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CHIP_IS_E1x</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">factor</span> <span class="o">=</span> <span class="n">CHIP_REV_IS_EMUL</span><span class="p">(</span><span class="n">bp</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1000</span> <span class="o">:</span>
				<span class="p">(</span><span class="n">CHIP_REV_IS_FPGA</span><span class="p">(</span><span class="n">bp</span><span class="p">)</span> <span class="o">?</span> <span class="mi">400</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">bnx2x_init_block</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">BLOCK_PGLUE_B</span><span class="p">,</span> <span class="n">PHASE_COMMON</span><span class="p">);</span>

		<span class="n">bnx2x_init_block</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">BLOCK_ATC</span><span class="p">,</span> <span class="n">PHASE_COMMON</span><span class="p">);</span>

		<span class="cm">/* let the HW do it&#39;s magic ... */</span>
		<span class="k">do</span> <span class="p">{</span>
			<span class="n">msleep</span><span class="p">(</span><span class="mi">200</span><span class="p">);</span>
			<span class="n">val</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">ATC_REG_ATC_INIT_DONE</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">factor</span><span class="o">--</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">val</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">));</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">BNX2X_ERR</span><span class="p">(</span><span class="s">&quot;ATC_INIT failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">bnx2x_init_block</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">BLOCK_DMAE</span><span class="p">,</span> <span class="n">PHASE_COMMON</span><span class="p">);</span>

	<span class="cm">/* clean the DMAE memory */</span>
	<span class="n">bp</span><span class="o">-&gt;</span><span class="n">dmae_ready</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">bnx2x_init_fill</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">TSEM_REG_PRAM</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">bnx2x_init_block</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">BLOCK_TCM</span><span class="p">,</span> <span class="n">PHASE_COMMON</span><span class="p">);</span>

	<span class="n">bnx2x_init_block</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">BLOCK_UCM</span><span class="p">,</span> <span class="n">PHASE_COMMON</span><span class="p">);</span>

	<span class="n">bnx2x_init_block</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">BLOCK_CCM</span><span class="p">,</span> <span class="n">PHASE_COMMON</span><span class="p">);</span>

	<span class="n">bnx2x_init_block</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">BLOCK_XCM</span><span class="p">,</span> <span class="n">PHASE_COMMON</span><span class="p">);</span>

	<span class="n">bnx2x_read_dmae</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">XSEM_REG_PASSIVE_BUFFER</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
	<span class="n">bnx2x_read_dmae</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">CSEM_REG_PASSIVE_BUFFER</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
	<span class="n">bnx2x_read_dmae</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">TSEM_REG_PASSIVE_BUFFER</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
	<span class="n">bnx2x_read_dmae</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">USEM_REG_PASSIVE_BUFFER</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>

	<span class="n">bnx2x_init_block</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">BLOCK_QM</span><span class="p">,</span> <span class="n">PHASE_COMMON</span><span class="p">);</span>


	<span class="cm">/* QM queues pointers table */</span>
	<span class="n">bnx2x_qm_init_ptr_table</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">qm_cid_count</span><span class="p">,</span> <span class="n">INITOP_SET</span><span class="p">);</span>

	<span class="cm">/* soft reset pulse */</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">QM_REG_SOFT_RESET</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">QM_REG_SOFT_RESET</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

<span class="cp">#ifdef BCM_CNIC</span>
	<span class="n">bnx2x_init_block</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">BLOCK_TM</span><span class="p">,</span> <span class="n">PHASE_COMMON</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="n">bnx2x_init_block</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">BLOCK_DORQ</span><span class="p">,</span> <span class="n">PHASE_COMMON</span><span class="p">);</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">DORQ_REG_DPM_CID_OFST</span><span class="p">,</span> <span class="n">BNX2X_DB_SHIFT</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CHIP_REV_IS_SLOW</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span>
		<span class="cm">/* enable hw interrupt from doorbell Q */</span>
		<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">DORQ_REG_DORQ_INT_MASK</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">bnx2x_init_block</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">BLOCK_BRB1</span><span class="p">,</span> <span class="n">PHASE_COMMON</span><span class="p">);</span>

	<span class="n">bnx2x_init_block</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">BLOCK_PRS</span><span class="p">,</span> <span class="n">PHASE_COMMON</span><span class="p">);</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">PRS_REG_A_PRSU_20</span><span class="p">,</span> <span class="mh">0xf</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CHIP_IS_E1</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span>
		<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">PRS_REG_E1HOV_MODE</span><span class="p">,</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">path_has_ovlan</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CHIP_IS_E1x</span><span class="p">(</span><span class="n">bp</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">CHIP_IS_E3B0</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_MF_AFEX</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* configure that VNTag and VLAN headers must be</span>
<span class="cm">			 * received in afex mode</span>
<span class="cm">			 */</span>
			<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">PRS_REG_HDRS_AFTER_BASIC</span><span class="p">,</span> <span class="mh">0xE</span><span class="p">);</span>
			<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">PRS_REG_MUST_HAVE_HDRS</span><span class="p">,</span> <span class="mh">0xA</span><span class="p">);</span>
			<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">PRS_REG_HDRS_AFTER_TAG_0</span><span class="p">,</span> <span class="mh">0x6</span><span class="p">);</span>
			<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">PRS_REG_TAG_ETHERTYPE_0</span><span class="p">,</span> <span class="mh">0x8926</span><span class="p">);</span>
			<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">PRS_REG_TAG_LEN_0</span><span class="p">,</span> <span class="mh">0x4</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* Bit-map indicating which L2 hdrs may appear</span>
<span class="cm">			 * after the basic Ethernet header</span>
<span class="cm">			 */</span>
			<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">PRS_REG_HDRS_AFTER_BASIC</span><span class="p">,</span>
			       <span class="n">bp</span><span class="o">-&gt;</span><span class="n">path_has_ovlan</span> <span class="o">?</span> <span class="mi">7</span> <span class="o">:</span> <span class="mi">6</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">bnx2x_init_block</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">BLOCK_TSDM</span><span class="p">,</span> <span class="n">PHASE_COMMON</span><span class="p">);</span>
	<span class="n">bnx2x_init_block</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">BLOCK_CSDM</span><span class="p">,</span> <span class="n">PHASE_COMMON</span><span class="p">);</span>
	<span class="n">bnx2x_init_block</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">BLOCK_USDM</span><span class="p">,</span> <span class="n">PHASE_COMMON</span><span class="p">);</span>
	<span class="n">bnx2x_init_block</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">BLOCK_XSDM</span><span class="p">,</span> <span class="n">PHASE_COMMON</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CHIP_IS_E1x</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* reset VFC memories */</span>
		<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">TSEM_REG_FAST_MEMORY</span> <span class="o">+</span> <span class="n">VFC_REG_MEMORIES_RST</span><span class="p">,</span>
			   <span class="n">VFC_MEMORIES_RST_REG_CAM_RST</span> <span class="o">|</span>
			   <span class="n">VFC_MEMORIES_RST_REG_RAM_RST</span><span class="p">);</span>
		<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">XSEM_REG_FAST_MEMORY</span> <span class="o">+</span> <span class="n">VFC_REG_MEMORIES_RST</span><span class="p">,</span>
			   <span class="n">VFC_MEMORIES_RST_REG_CAM_RST</span> <span class="o">|</span>
			   <span class="n">VFC_MEMORIES_RST_REG_RAM_RST</span><span class="p">);</span>

		<span class="n">msleep</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">bnx2x_init_block</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">BLOCK_TSEM</span><span class="p">,</span> <span class="n">PHASE_COMMON</span><span class="p">);</span>
	<span class="n">bnx2x_init_block</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">BLOCK_USEM</span><span class="p">,</span> <span class="n">PHASE_COMMON</span><span class="p">);</span>
	<span class="n">bnx2x_init_block</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">BLOCK_CSEM</span><span class="p">,</span> <span class="n">PHASE_COMMON</span><span class="p">);</span>
	<span class="n">bnx2x_init_block</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">BLOCK_XSEM</span><span class="p">,</span> <span class="n">PHASE_COMMON</span><span class="p">);</span>

	<span class="cm">/* sync semi rtc */</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">GRCBASE_MISC</span> <span class="o">+</span> <span class="n">MISC_REGISTERS_RESET_REG_1_CLEAR</span><span class="p">,</span>
	       <span class="mh">0x80000000</span><span class="p">);</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">GRCBASE_MISC</span> <span class="o">+</span> <span class="n">MISC_REGISTERS_RESET_REG_1_SET</span><span class="p">,</span>
	       <span class="mh">0x80000000</span><span class="p">);</span>

	<span class="n">bnx2x_init_block</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">BLOCK_UPB</span><span class="p">,</span> <span class="n">PHASE_COMMON</span><span class="p">);</span>
	<span class="n">bnx2x_init_block</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">BLOCK_XPB</span><span class="p">,</span> <span class="n">PHASE_COMMON</span><span class="p">);</span>
	<span class="n">bnx2x_init_block</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">BLOCK_PBF</span><span class="p">,</span> <span class="n">PHASE_COMMON</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CHIP_IS_E1x</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_MF_AFEX</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* configure that VNTag and VLAN headers must be</span>
<span class="cm">			 * sent in afex mode</span>
<span class="cm">			 */</span>
			<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">PBF_REG_HDRS_AFTER_BASIC</span><span class="p">,</span> <span class="mh">0xE</span><span class="p">);</span>
			<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">PBF_REG_MUST_HAVE_HDRS</span><span class="p">,</span> <span class="mh">0xA</span><span class="p">);</span>
			<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">PBF_REG_HDRS_AFTER_TAG_0</span><span class="p">,</span> <span class="mh">0x6</span><span class="p">);</span>
			<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">PBF_REG_TAG_ETHERTYPE_0</span><span class="p">,</span> <span class="mh">0x8926</span><span class="p">);</span>
			<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">PBF_REG_TAG_LEN_0</span><span class="p">,</span> <span class="mh">0x4</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">PBF_REG_HDRS_AFTER_BASIC</span><span class="p">,</span>
			       <span class="n">bp</span><span class="o">-&gt;</span><span class="n">path_has_ovlan</span> <span class="o">?</span> <span class="mi">7</span> <span class="o">:</span> <span class="mi">6</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">SRC_REG_SOFT_RST</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">bnx2x_init_block</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">BLOCK_SRC</span><span class="p">,</span> <span class="n">PHASE_COMMON</span><span class="p">);</span>

<span class="cp">#ifdef BCM_CNIC</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">SRC_REG_KEYSEARCH_0</span><span class="p">,</span> <span class="mh">0x63285672</span><span class="p">);</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">SRC_REG_KEYSEARCH_1</span><span class="p">,</span> <span class="mh">0x24b8f2cc</span><span class="p">);</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">SRC_REG_KEYSEARCH_2</span><span class="p">,</span> <span class="mh">0x223aef9b</span><span class="p">);</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">SRC_REG_KEYSEARCH_3</span><span class="p">,</span> <span class="mh">0x26001e3a</span><span class="p">);</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">SRC_REG_KEYSEARCH_4</span><span class="p">,</span> <span class="mh">0x7ae91116</span><span class="p">);</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">SRC_REG_KEYSEARCH_5</span><span class="p">,</span> <span class="mh">0x5ce5230b</span><span class="p">);</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">SRC_REG_KEYSEARCH_6</span><span class="p">,</span> <span class="mh">0x298d8adf</span><span class="p">);</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">SRC_REG_KEYSEARCH_7</span><span class="p">,</span> <span class="mh">0x6eb0ff09</span><span class="p">);</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">SRC_REG_KEYSEARCH_8</span><span class="p">,</span> <span class="mh">0x1830f82f</span><span class="p">);</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">SRC_REG_KEYSEARCH_9</span><span class="p">,</span> <span class="mh">0x01e46be7</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">SRC_REG_SOFT_RST</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">union</span> <span class="n">cdu_context</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1024</span><span class="p">)</span>
		<span class="cm">/* we currently assume that a context is 1024 bytes */</span>
		<span class="n">dev_alert</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			  <span class="s">&quot;please adjust the size of cdu_context(%ld)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="k">sizeof</span><span class="p">(</span><span class="k">union</span> <span class="n">cdu_context</span><span class="p">));</span>

	<span class="n">bnx2x_init_block</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">BLOCK_CDU</span><span class="p">,</span> <span class="n">PHASE_COMMON</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="mi">4</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1024</span><span class="p">;</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">CDU_REG_CDU_GLOBAL_PARAMS</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

	<span class="n">bnx2x_init_block</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">BLOCK_CFC</span><span class="p">,</span> <span class="n">PHASE_COMMON</span><span class="p">);</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">CFC_REG_INIT_REG</span><span class="p">,</span> <span class="mh">0x7FF</span><span class="p">);</span>
	<span class="cm">/* enable context validation interrupt from CFC */</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">CFC_REG_CFC_INT_MASK</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* set the thresholds to prevent CFC/CDU race */</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">CFC_REG_DEBUG0</span><span class="p">,</span> <span class="mh">0x20020000</span><span class="p">);</span>

	<span class="n">bnx2x_init_block</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">BLOCK_HC</span><span class="p">,</span> <span class="n">PHASE_COMMON</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CHIP_IS_E1x</span><span class="p">(</span><span class="n">bp</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">BP_NOMCP</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span>
		<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">IGU_REG_RESET_MEMORIES</span><span class="p">,</span> <span class="mh">0x36</span><span class="p">);</span>

	<span class="n">bnx2x_init_block</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">BLOCK_IGU</span><span class="p">,</span> <span class="n">PHASE_COMMON</span><span class="p">);</span>
	<span class="n">bnx2x_init_block</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">BLOCK_MISC_AEU</span><span class="p">,</span> <span class="n">PHASE_COMMON</span><span class="p">);</span>

	<span class="cm">/* Reset PCIE errors for debug */</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="mh">0x2814</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">);</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="mh">0x3820</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CHIP_IS_E1x</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">PCICFG_OFFSET</span> <span class="o">+</span> <span class="n">PXPCS_TL_CONTROL_5</span><span class="p">,</span>
			   <span class="p">(</span><span class="n">PXPCS_TL_CONTROL_5_ERR_UNSPPORT1</span> <span class="o">|</span>
				<span class="n">PXPCS_TL_CONTROL_5_ERR_UNSPPORT</span><span class="p">));</span>
		<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">PCICFG_OFFSET</span> <span class="o">+</span> <span class="n">PXPCS_TL_FUNC345_STAT</span><span class="p">,</span>
			   <span class="p">(</span><span class="n">PXPCS_TL_FUNC345_STAT_ERR_UNSPPORT4</span> <span class="o">|</span>
				<span class="n">PXPCS_TL_FUNC345_STAT_ERR_UNSPPORT3</span> <span class="o">|</span>
				<span class="n">PXPCS_TL_FUNC345_STAT_ERR_UNSPPORT2</span><span class="p">));</span>
		<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">PCICFG_OFFSET</span> <span class="o">+</span> <span class="n">PXPCS_TL_FUNC678_STAT</span><span class="p">,</span>
			   <span class="p">(</span><span class="n">PXPCS_TL_FUNC678_STAT_ERR_UNSPPORT7</span> <span class="o">|</span>
				<span class="n">PXPCS_TL_FUNC678_STAT_ERR_UNSPPORT6</span> <span class="o">|</span>
				<span class="n">PXPCS_TL_FUNC678_STAT_ERR_UNSPPORT5</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="n">bnx2x_init_block</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">BLOCK_NIG</span><span class="p">,</span> <span class="n">PHASE_COMMON</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CHIP_IS_E1</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* in E3 this done in per-port section */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CHIP_IS_E3</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span>
			<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">NIG_REG_LLH_MF_MODE</span><span class="p">,</span> <span class="n">IS_MF</span><span class="p">(</span><span class="n">bp</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">CHIP_IS_E1H</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span>
		<span class="cm">/* not applicable for E2 (and above ...) */</span>
		<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">NIG_REG_LLH_E1HOV_MODE</span><span class="p">,</span> <span class="n">IS_MF_SD</span><span class="p">(</span><span class="n">bp</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">CHIP_REV_IS_SLOW</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">200</span><span class="p">);</span>

	<span class="cm">/* finish CFC init */</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">reg_poll</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">CFC_REG_LL_INIT_DONE</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BNX2X_ERR</span><span class="p">(</span><span class="s">&quot;CFC LL_INIT failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">reg_poll</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">CFC_REG_AC_INIT_DONE</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BNX2X_ERR</span><span class="p">(</span><span class="s">&quot;CFC AC_INIT failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">reg_poll</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">CFC_REG_CAM_INIT_DONE</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BNX2X_ERR</span><span class="p">(</span><span class="s">&quot;CFC CAM_INIT failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">CFC_REG_DEBUG0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">CHIP_IS_E1</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* read NIG statistic</span>
<span class="cm">		   to see if this is our first up since powerup */</span>
		<span class="n">bnx2x_read_dmae</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">NIG_REG_STAT2_BRB_OCTET</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
		<span class="n">val</span> <span class="o">=</span> <span class="o">*</span><span class="n">bnx2x_sp</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">wb_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>

		<span class="cm">/* do internal memory self test */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">val</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">bnx2x_int_mem_test</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">BNX2X_ERR</span><span class="p">(</span><span class="s">&quot;internal mem self test failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">bnx2x_setup_fan_failure_detection</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>

	<span class="cm">/* clear PXP2 attentions */</span>
	<span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">PXP2_REG_PXP2_INT_STS_CLR_0</span><span class="p">);</span>

	<span class="n">bnx2x_enable_blocks_attention</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
	<span class="n">bnx2x_enable_blocks_parity</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">BP_NOMCP</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">CHIP_IS_E1x</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span>
			<span class="n">bnx2x__common_init_phy</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">BNX2X_ERR</span><span class="p">(</span><span class="s">&quot;Bootcode is missing - can not initialize link</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * bnx2x_init_hw_common_chip - init HW at the COMMON_CHIP phase.</span>
<span class="cm"> *</span>
<span class="cm"> * @bp:		driver handle</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">bnx2x_init_hw_common_chip</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="n">bnx2x_init_hw_common</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="cm">/* In E2 2-PORT mode, same ext phy is used for the two paths */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">BP_NOMCP</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span>
		<span class="n">bnx2x__common_init_phy</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bnx2x_init_hw_port</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">port</span> <span class="o">=</span> <span class="n">BP_PORT</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">init_phase</span> <span class="o">=</span> <span class="n">port</span> <span class="o">?</span> <span class="n">PHASE_PORT1</span> <span class="o">:</span> <span class="n">PHASE_PORT0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">low</span><span class="p">,</span> <span class="n">high</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">bnx2x__link_reset</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>

	<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_HW</span><span class="p">,</span> <span class="s">&quot;starting port init  port %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>

	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">NIG_REG_MASK_INTERRUPT_PORT0</span> <span class="o">+</span> <span class="n">port</span><span class="o">*</span><span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">bnx2x_init_block</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">BLOCK_MISC</span><span class="p">,</span> <span class="n">init_phase</span><span class="p">);</span>
	<span class="n">bnx2x_init_block</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">BLOCK_PXP</span><span class="p">,</span> <span class="n">init_phase</span><span class="p">);</span>
	<span class="n">bnx2x_init_block</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">BLOCK_PXP2</span><span class="p">,</span> <span class="n">init_phase</span><span class="p">);</span>

	<span class="cm">/* Timers bug workaround: disables the pf_master bit in pglue at</span>
<span class="cm">	 * common phase, we need to enable it here before any dmae access are</span>
<span class="cm">	 * attempted. Therefore we manually added the enable-master to the</span>
<span class="cm">	 * port phase (it also happens in the function phase)</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CHIP_IS_E1x</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span>
		<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">PGLUE_B_REG_INTERNAL_PFID_ENABLE_MASTER</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">bnx2x_init_block</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">BLOCK_ATC</span><span class="p">,</span> <span class="n">init_phase</span><span class="p">);</span>
	<span class="n">bnx2x_init_block</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">BLOCK_DMAE</span><span class="p">,</span> <span class="n">init_phase</span><span class="p">);</span>
	<span class="n">bnx2x_init_block</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">BLOCK_PGLUE_B</span><span class="p">,</span> <span class="n">init_phase</span><span class="p">);</span>
	<span class="n">bnx2x_init_block</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">BLOCK_QM</span><span class="p">,</span> <span class="n">init_phase</span><span class="p">);</span>

	<span class="n">bnx2x_init_block</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">BLOCK_TCM</span><span class="p">,</span> <span class="n">init_phase</span><span class="p">);</span>
	<span class="n">bnx2x_init_block</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">BLOCK_UCM</span><span class="p">,</span> <span class="n">init_phase</span><span class="p">);</span>
	<span class="n">bnx2x_init_block</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">BLOCK_CCM</span><span class="p">,</span> <span class="n">init_phase</span><span class="p">);</span>
	<span class="n">bnx2x_init_block</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">BLOCK_XCM</span><span class="p">,</span> <span class="n">init_phase</span><span class="p">);</span>

	<span class="cm">/* QM cid (connection) count */</span>
	<span class="n">bnx2x_qm_init_cid_count</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">qm_cid_count</span><span class="p">,</span> <span class="n">INITOP_SET</span><span class="p">);</span>

<span class="cp">#ifdef BCM_CNIC</span>
	<span class="n">bnx2x_init_block</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">BLOCK_TM</span><span class="p">,</span> <span class="n">init_phase</span><span class="p">);</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">TM_REG_LIN0_SCAN_TIME</span> <span class="o">+</span> <span class="n">port</span><span class="o">*</span><span class="mi">4</span><span class="p">,</span> <span class="mi">20</span><span class="p">);</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">TM_REG_LIN0_MAX_ACTIVE_CID</span> <span class="o">+</span> <span class="n">port</span><span class="o">*</span><span class="mi">4</span><span class="p">,</span> <span class="mi">31</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="n">bnx2x_init_block</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">BLOCK_DORQ</span><span class="p">,</span> <span class="n">init_phase</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">CHIP_IS_E1</span><span class="p">(</span><span class="n">bp</span><span class="p">)</span> <span class="o">||</span> <span class="n">CHIP_IS_E1H</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">bnx2x_init_block</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">BLOCK_BRB1</span><span class="p">,</span> <span class="n">init_phase</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">IS_MF</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span>
			<span class="n">low</span> <span class="o">=</span> <span class="p">((</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ONE_PORT_FLAG</span><span class="p">)</span> <span class="o">?</span> <span class="mi">160</span> <span class="o">:</span> <span class="mi">246</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mtu</span> <span class="o">&gt;</span> <span class="mi">4096</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ONE_PORT_FLAG</span><span class="p">)</span>
				<span class="n">low</span> <span class="o">=</span> <span class="mi">160</span><span class="p">;</span>
			<span class="k">else</span> <span class="p">{</span>
				<span class="n">val</span> <span class="o">=</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mtu</span><span class="p">;</span>
				<span class="cm">/* (24*1024 + val*4)/256 */</span>
				<span class="n">low</span> <span class="o">=</span> <span class="mi">96</span> <span class="o">+</span> <span class="p">(</span><span class="n">val</span><span class="o">/</span><span class="mi">64</span><span class="p">)</span> <span class="o">+</span>
						<span class="p">((</span><span class="n">val</span> <span class="o">%</span> <span class="mi">64</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">low</span> <span class="o">=</span> <span class="p">((</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ONE_PORT_FLAG</span><span class="p">)</span> <span class="o">?</span> <span class="mi">80</span> <span class="o">:</span> <span class="mi">160</span><span class="p">);</span>
		<span class="n">high</span> <span class="o">=</span> <span class="n">low</span> <span class="o">+</span> <span class="mi">56</span><span class="p">;</span>	<span class="cm">/* 14*1024/256 */</span>
		<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">BRB1_REG_PAUSE_LOW_THRESHOLD_0</span> <span class="o">+</span> <span class="n">port</span><span class="o">*</span><span class="mi">4</span><span class="p">,</span> <span class="n">low</span><span class="p">);</span>
		<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">BRB1_REG_PAUSE_HIGH_THRESHOLD_0</span> <span class="o">+</span> <span class="n">port</span><span class="o">*</span><span class="mi">4</span><span class="p">,</span> <span class="n">high</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">CHIP_MODE_IS_4_PORT</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span>
		<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="p">(</span><span class="n">BP_PORT</span><span class="p">(</span><span class="n">bp</span><span class="p">)</span> <span class="o">?</span>
			    <span class="n">BRB1_REG_MAC_GUARANTIED_1</span> <span class="o">:</span>
			    <span class="n">BRB1_REG_MAC_GUARANTIED_0</span><span class="p">),</span> <span class="mi">40</span><span class="p">);</span>


	<span class="n">bnx2x_init_block</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">BLOCK_PRS</span><span class="p">,</span> <span class="n">init_phase</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">CHIP_IS_E3B0</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_MF_AFEX</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* configure headers for AFEX mode */</span>
			<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">BP_PORT</span><span class="p">(</span><span class="n">bp</span><span class="p">)</span> <span class="o">?</span>
			       <span class="n">PRS_REG_HDRS_AFTER_BASIC_PORT_1</span> <span class="o">:</span>
			       <span class="n">PRS_REG_HDRS_AFTER_BASIC_PORT_0</span><span class="p">,</span> <span class="mh">0xE</span><span class="p">);</span>
			<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">BP_PORT</span><span class="p">(</span><span class="n">bp</span><span class="p">)</span> <span class="o">?</span>
			       <span class="n">PRS_REG_HDRS_AFTER_TAG_0_PORT_1</span> <span class="o">:</span>
			       <span class="n">PRS_REG_HDRS_AFTER_TAG_0_PORT_0</span><span class="p">,</span> <span class="mh">0x6</span><span class="p">);</span>
			<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">BP_PORT</span><span class="p">(</span><span class="n">bp</span><span class="p">)</span> <span class="o">?</span>
			       <span class="n">PRS_REG_MUST_HAVE_HDRS_PORT_1</span> <span class="o">:</span>
			       <span class="n">PRS_REG_MUST_HAVE_HDRS_PORT_0</span><span class="p">,</span> <span class="mh">0xA</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* Ovlan exists only if we are in multi-function +</span>
<span class="cm">			 * switch-dependent mode, in switch-independent there</span>
<span class="cm">			 * is no ovlan headers</span>
<span class="cm">			 */</span>
			<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">BP_PORT</span><span class="p">(</span><span class="n">bp</span><span class="p">)</span> <span class="o">?</span>
			       <span class="n">PRS_REG_HDRS_AFTER_BASIC_PORT_1</span> <span class="o">:</span>
			       <span class="n">PRS_REG_HDRS_AFTER_BASIC_PORT_0</span><span class="p">,</span>
			       <span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">path_has_ovlan</span> <span class="o">?</span> <span class="mi">7</span> <span class="o">:</span> <span class="mi">6</span><span class="p">));</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">bnx2x_init_block</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">BLOCK_TSDM</span><span class="p">,</span> <span class="n">init_phase</span><span class="p">);</span>
	<span class="n">bnx2x_init_block</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">BLOCK_CSDM</span><span class="p">,</span> <span class="n">init_phase</span><span class="p">);</span>
	<span class="n">bnx2x_init_block</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">BLOCK_USDM</span><span class="p">,</span> <span class="n">init_phase</span><span class="p">);</span>
	<span class="n">bnx2x_init_block</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">BLOCK_XSDM</span><span class="p">,</span> <span class="n">init_phase</span><span class="p">);</span>

	<span class="n">bnx2x_init_block</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">BLOCK_TSEM</span><span class="p">,</span> <span class="n">init_phase</span><span class="p">);</span>
	<span class="n">bnx2x_init_block</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">BLOCK_USEM</span><span class="p">,</span> <span class="n">init_phase</span><span class="p">);</span>
	<span class="n">bnx2x_init_block</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">BLOCK_CSEM</span><span class="p">,</span> <span class="n">init_phase</span><span class="p">);</span>
	<span class="n">bnx2x_init_block</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">BLOCK_XSEM</span><span class="p">,</span> <span class="n">init_phase</span><span class="p">);</span>

	<span class="n">bnx2x_init_block</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">BLOCK_UPB</span><span class="p">,</span> <span class="n">init_phase</span><span class="p">);</span>
	<span class="n">bnx2x_init_block</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">BLOCK_XPB</span><span class="p">,</span> <span class="n">init_phase</span><span class="p">);</span>

	<span class="n">bnx2x_init_block</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">BLOCK_PBF</span><span class="p">,</span> <span class="n">init_phase</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">CHIP_IS_E1x</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* configure PBF to work without PAUSE mtu 9000 */</span>
		<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">PBF_REG_P0_PAUSE_ENABLE</span> <span class="o">+</span> <span class="n">port</span><span class="o">*</span><span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="cm">/* update threshold */</span>
		<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">PBF_REG_P0_ARB_THRSH</span> <span class="o">+</span> <span class="n">port</span><span class="o">*</span><span class="mi">4</span><span class="p">,</span> <span class="p">(</span><span class="mi">9040</span><span class="o">/</span><span class="mi">16</span><span class="p">));</span>
		<span class="cm">/* update init credit */</span>
		<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">PBF_REG_P0_INIT_CRD</span> <span class="o">+</span> <span class="n">port</span><span class="o">*</span><span class="mi">4</span><span class="p">,</span> <span class="p">(</span><span class="mi">9040</span><span class="o">/</span><span class="mi">16</span><span class="p">)</span> <span class="o">+</span> <span class="mi">553</span> <span class="o">-</span> <span class="mi">22</span><span class="p">);</span>

		<span class="cm">/* probe changes */</span>
		<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">PBF_REG_INIT_P0</span> <span class="o">+</span> <span class="n">port</span><span class="o">*</span><span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">50</span><span class="p">);</span>
		<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">PBF_REG_INIT_P0</span> <span class="o">+</span> <span class="n">port</span><span class="o">*</span><span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

<span class="cp">#ifdef BCM_CNIC</span>
	<span class="n">bnx2x_init_block</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">BLOCK_SRC</span><span class="p">,</span> <span class="n">init_phase</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">bnx2x_init_block</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">BLOCK_CDU</span><span class="p">,</span> <span class="n">init_phase</span><span class="p">);</span>
	<span class="n">bnx2x_init_block</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">BLOCK_CFC</span><span class="p">,</span> <span class="n">init_phase</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">CHIP_IS_E1</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">HC_REG_LEADING_EDGE_0</span> <span class="o">+</span> <span class="n">port</span><span class="o">*</span><span class="mi">8</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">HC_REG_TRAILING_EDGE_0</span> <span class="o">+</span> <span class="n">port</span><span class="o">*</span><span class="mi">8</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">bnx2x_init_block</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">BLOCK_HC</span><span class="p">,</span> <span class="n">init_phase</span><span class="p">);</span>

	<span class="n">bnx2x_init_block</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">BLOCK_IGU</span><span class="p">,</span> <span class="n">init_phase</span><span class="p">);</span>

	<span class="n">bnx2x_init_block</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">BLOCK_MISC_AEU</span><span class="p">,</span> <span class="n">init_phase</span><span class="p">);</span>
	<span class="cm">/* init aeu_mask_attn_func_0/1:</span>
<span class="cm">	 *  - SF mode: bits 3-7 are masked. only bits 0-2 are in use</span>
<span class="cm">	 *  - MF mode: bit 3 is masked. bits 0-2 are in use as in SF</span>
<span class="cm">	 *             bits 4-7 are used for &quot;per vn group attention&quot; */</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">IS_MF</span><span class="p">(</span><span class="n">bp</span><span class="p">)</span> <span class="o">?</span> <span class="mh">0xF7</span> <span class="o">:</span> <span class="mh">0x7</span><span class="p">;</span>
	<span class="cm">/* Enable DCBX attention for all but E1 */</span>
	<span class="n">val</span> <span class="o">|=</span> <span class="n">CHIP_IS_E1</span><span class="p">(</span><span class="n">bp</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mh">0x10</span><span class="p">;</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">MISC_REG_AEU_MASK_ATTN_FUNC_0</span> <span class="o">+</span> <span class="n">port</span><span class="o">*</span><span class="mi">4</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

	<span class="n">bnx2x_init_block</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">BLOCK_NIG</span><span class="p">,</span> <span class="n">init_phase</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CHIP_IS_E1x</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Bit-map indicating which L2 hdrs may appear after the</span>
<span class="cm">		 * basic Ethernet header</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_MF_AFEX</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span>
			<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">BP_PORT</span><span class="p">(</span><span class="n">bp</span><span class="p">)</span> <span class="o">?</span>
			       <span class="n">NIG_REG_P1_HDRS_AFTER_BASIC</span> <span class="o">:</span>
			       <span class="n">NIG_REG_P0_HDRS_AFTER_BASIC</span><span class="p">,</span> <span class="mh">0xE</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">BP_PORT</span><span class="p">(</span><span class="n">bp</span><span class="p">)</span> <span class="o">?</span>
			       <span class="n">NIG_REG_P1_HDRS_AFTER_BASIC</span> <span class="o">:</span>
			       <span class="n">NIG_REG_P0_HDRS_AFTER_BASIC</span><span class="p">,</span>
			       <span class="n">IS_MF_SD</span><span class="p">(</span><span class="n">bp</span><span class="p">)</span> <span class="o">?</span> <span class="mi">7</span> <span class="o">:</span> <span class="mi">6</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">CHIP_IS_E3</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span>
			<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">BP_PORT</span><span class="p">(</span><span class="n">bp</span><span class="p">)</span> <span class="o">?</span>
				   <span class="n">NIG_REG_LLH1_MF_MODE</span> <span class="o">:</span>
				   <span class="n">NIG_REG_LLH_MF_MODE</span><span class="p">,</span> <span class="n">IS_MF</span><span class="p">(</span><span class="n">bp</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CHIP_IS_E3</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span>
		<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">NIG_REG_XGXS_SERDES0_MODE_SEL</span> <span class="o">+</span> <span class="n">port</span><span class="o">*</span><span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CHIP_IS_E1</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* 0x2 disable mf_ov, 0x1 enable */</span>
		<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">NIG_REG_LLH0_BRB1_DRV_MASK_MF</span> <span class="o">+</span> <span class="n">port</span><span class="o">*</span><span class="mi">4</span><span class="p">,</span>
		       <span class="p">(</span><span class="n">IS_MF_SD</span><span class="p">(</span><span class="n">bp</span><span class="p">)</span> <span class="o">?</span> <span class="mh">0x1</span> <span class="o">:</span> <span class="mh">0x2</span><span class="p">));</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CHIP_IS_E1x</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">mf_mode</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">MULTI_FUNCTION_SD</span>:
				<span class="n">val</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">MULTI_FUNCTION_SI</span>:
			<span class="k">case</span> <span class="n">MULTI_FUNCTION_AFEX</span>:
				<span class="n">val</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="p">(</span><span class="n">BP_PORT</span><span class="p">(</span><span class="n">bp</span><span class="p">)</span> <span class="o">?</span> <span class="n">NIG_REG_LLH1_CLS_TYPE</span> <span class="o">:</span>
						  <span class="n">NIG_REG_LLH0_CLS_TYPE</span><span class="p">),</span> <span class="n">val</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="p">{</span>
			<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">NIG_REG_LLFC_ENABLE_0</span> <span class="o">+</span> <span class="n">port</span><span class="o">*</span><span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">NIG_REG_LLFC_OUT_EN_0</span> <span class="o">+</span> <span class="n">port</span><span class="o">*</span><span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">NIG_REG_PAUSE_ENABLE_0</span> <span class="o">+</span> <span class="n">port</span><span class="o">*</span><span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>


	<span class="cm">/* If SPIO5 is set to generate interrupts, enable it for this port */</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">MISC_REG_SPIO_EVENT_EN</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">MISC_REGISTERS_SPIO_5</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">reg_addr</span> <span class="o">=</span> <span class="p">(</span><span class="n">port</span> <span class="o">?</span> <span class="n">MISC_REG_AEU_ENABLE1_FUNC_1_OUT_0</span> <span class="o">:</span>
				       <span class="n">MISC_REG_AEU_ENABLE1_FUNC_0_OUT_0</span><span class="p">);</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">reg_addr</span><span class="p">);</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">AEU_INPUTS_ATTN_BITS_SPIO5</span><span class="p">;</span>
		<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">reg_addr</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_ilt_wr</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">,</span> <span class="n">u32</span> <span class="n">index</span><span class="p">,</span> <span class="n">dma_addr_t</span> <span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">reg</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">wb_write</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">CHIP_IS_E1</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="n">PXP2_REG_RQ_ONCHIP_AT</span> <span class="o">+</span> <span class="n">index</span><span class="o">*</span><span class="mi">8</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="n">PXP2_REG_RQ_ONCHIP_AT_B0</span> <span class="o">+</span> <span class="n">index</span><span class="o">*</span><span class="mi">8</span><span class="p">;</span>

	<span class="n">wb_write</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">ONCHIP_ADDR1</span><span class="p">(</span><span class="n">addr</span><span class="p">);</span>
	<span class="n">wb_write</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">ONCHIP_ADDR2</span><span class="p">(</span><span class="n">addr</span><span class="p">);</span>
	<span class="n">REG_WR_DMAE</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">wb_write</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_igu_clear_sb_gen</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">,</span> <span class="n">u8</span> <span class="n">func</span><span class="p">,</span>
				   <span class="n">u8</span> <span class="n">idu_sb_id</span><span class="p">,</span> <span class="n">bool</span> <span class="n">is_Pf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">data</span><span class="p">,</span> <span class="n">ctl</span><span class="p">,</span> <span class="n">cnt</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">igu_addr_data</span> <span class="o">=</span> <span class="n">IGU_REG_COMMAND_REG_32LSB_DATA</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">igu_addr_ctl</span> <span class="o">=</span> <span class="n">IGU_REG_COMMAND_REG_CTRL</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">igu_addr_ack</span> <span class="o">=</span> <span class="n">IGU_REG_CSTORM_TYPE_0_SB_CLEANUP</span> <span class="o">+</span> <span class="p">(</span><span class="n">idu_sb_id</span><span class="o">/</span><span class="mi">32</span><span class="p">)</span><span class="o">*</span><span class="mi">4</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">sb_bit</span> <span class="o">=</span>  <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">idu_sb_id</span><span class="o">%</span><span class="mi">32</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">func_encode</span> <span class="o">=</span> <span class="n">func</span> <span class="o">|</span> <span class="p">(</span><span class="n">is_Pf</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">IGU_FID_ENCODE_IS_PF_SHIFT</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">addr_encode</span> <span class="o">=</span> <span class="n">IGU_CMD_E2_PROD_UPD_BASE</span> <span class="o">+</span> <span class="n">idu_sb_id</span><span class="p">;</span>

	<span class="cm">/* Not supported in BC mode */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">CHIP_INT_MODE_IS_BC</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="n">IGU_USE_REGISTER_cstorm_type_0_sb_cleanup</span>
			<span class="o">&lt;&lt;</span> <span class="n">IGU_REGULAR_CLEANUP_TYPE_SHIFT</span><span class="p">)</span>	<span class="o">|</span>
		<span class="n">IGU_REGULAR_CLEANUP_SET</span>				<span class="o">|</span>
		<span class="n">IGU_REGULAR_BCLEANUP</span><span class="p">;</span>

	<span class="n">ctl</span> <span class="o">=</span> <span class="n">addr_encode</span> <span class="o">&lt;&lt;</span> <span class="n">IGU_CTRL_REG_ADDRESS_SHIFT</span>		<span class="o">|</span>
	      <span class="n">func_encode</span> <span class="o">&lt;&lt;</span> <span class="n">IGU_CTRL_REG_FID_SHIFT</span>		<span class="o">|</span>
	      <span class="n">IGU_CTRL_CMD_TYPE_WR</span> <span class="o">&lt;&lt;</span> <span class="n">IGU_CTRL_REG_TYPE_SHIFT</span><span class="p">;</span>

	<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_HW</span><span class="p">,</span> <span class="s">&quot;write 0x%08x to IGU(via GRC) addr 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">data</span><span class="p">,</span> <span class="n">igu_addr_data</span><span class="p">);</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">igu_addr_data</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
	<span class="n">mmiowb</span><span class="p">();</span>
	<span class="n">barrier</span><span class="p">();</span>
	<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_HW</span><span class="p">,</span> <span class="s">&quot;write 0x%08x to IGU(via GRC) addr 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">ctl</span><span class="p">,</span> <span class="n">igu_addr_ctl</span><span class="p">);</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">igu_addr_ctl</span><span class="p">,</span> <span class="n">ctl</span><span class="p">);</span>
	<span class="n">mmiowb</span><span class="p">();</span>
	<span class="n">barrier</span><span class="p">();</span>

	<span class="cm">/* wait for clean up to finish */</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">igu_addr_ack</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">sb_bit</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">--</span><span class="n">cnt</span><span class="p">)</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>


	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">igu_addr_ack</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">sb_bit</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_HW</span><span class="p">,</span>
		   <span class="s">&quot;Unable to finish IGU cleanup: idu_sb_id %d offset %d bit %d (cnt %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">idu_sb_id</span><span class="p">,</span> <span class="n">idu_sb_id</span><span class="o">/</span><span class="mi">32</span><span class="p">,</span> <span class="n">idu_sb_id</span><span class="o">%</span><span class="mi">32</span><span class="p">,</span> <span class="n">cnt</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_igu_clear_sb</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">,</span> <span class="n">u8</span> <span class="n">idu_sb_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bnx2x_igu_clear_sb_gen</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">BP_FUNC</span><span class="p">(</span><span class="n">bp</span><span class="p">),</span> <span class="n">idu_sb_id</span><span class="p">,</span> <span class="nb">true</span> <span class="cm">/*PF*/</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_clear_func_ilt</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">,</span> <span class="n">u32</span> <span class="n">func</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">i</span><span class="p">,</span> <span class="n">base</span> <span class="o">=</span> <span class="n">FUNC_ILT_BASE</span><span class="p">(</span><span class="n">func</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">base</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">base</span> <span class="o">+</span> <span class="n">ILT_PER_FUNC</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">bnx2x_ilt_wr</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bnx2x_init_hw_func</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">port</span> <span class="o">=</span> <span class="n">BP_PORT</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">func</span> <span class="o">=</span> <span class="n">BP_FUNC</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">init_phase</span> <span class="o">=</span> <span class="n">PHASE_PF0</span> <span class="o">+</span> <span class="n">func</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bnx2x_ilt</span> <span class="o">*</span><span class="n">ilt</span> <span class="o">=</span> <span class="n">BP_ILT</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
	<span class="n">u16</span> <span class="n">cdu_ilt_start</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">addr</span><span class="p">,</span> <span class="n">val</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">main_mem_base</span><span class="p">,</span> <span class="n">main_mem_size</span><span class="p">,</span> <span class="n">main_mem_prty_clr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">main_mem_width</span><span class="p">,</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_HW</span><span class="p">,</span> <span class="s">&quot;starting func init  func %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">func</span><span class="p">);</span>

	<span class="cm">/* FLR cleanup - hmmm */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CHIP_IS_E1x</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">bnx2x_pf_flr_clnup</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* set MSI reconfigure capability */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">.</span><span class="n">int_block</span> <span class="o">==</span> <span class="n">INT_BLOCK_HC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">addr</span> <span class="o">=</span> <span class="p">(</span><span class="n">port</span> <span class="o">?</span> <span class="n">HC_REG_CONFIG_1</span> <span class="o">:</span> <span class="n">HC_REG_CONFIG_0</span><span class="p">);</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">HC_CONFIG_0_REG_MSI_ATTN_EN_0</span><span class="p">;</span>
		<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">bnx2x_init_block</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">BLOCK_PXP</span><span class="p">,</span> <span class="n">init_phase</span><span class="p">);</span>
	<span class="n">bnx2x_init_block</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">BLOCK_PXP2</span><span class="p">,</span> <span class="n">init_phase</span><span class="p">);</span>

	<span class="n">ilt</span> <span class="o">=</span> <span class="n">BP_ILT</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
	<span class="n">cdu_ilt_start</span> <span class="o">=</span> <span class="n">ilt</span><span class="o">-&gt;</span><span class="n">clients</span><span class="p">[</span><span class="n">ILT_CLIENT_CDU</span><span class="p">].</span><span class="n">start</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">L2_ILT_LINES</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ilt</span><span class="o">-&gt;</span><span class="n">lines</span><span class="p">[</span><span class="n">cdu_ilt_start</span> <span class="o">+</span> <span class="n">i</span><span class="p">].</span><span class="n">page</span> <span class="o">=</span>
			<span class="n">bp</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">.</span><span class="n">vcxt</span> <span class="o">+</span> <span class="p">(</span><span class="n">ILT_PAGE_CIDS</span> <span class="o">*</span> <span class="n">i</span><span class="p">);</span>
		<span class="n">ilt</span><span class="o">-&gt;</span><span class="n">lines</span><span class="p">[</span><span class="n">cdu_ilt_start</span> <span class="o">+</span> <span class="n">i</span><span class="p">].</span><span class="n">page_mapping</span> <span class="o">=</span>
			<span class="n">bp</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">.</span><span class="n">cxt_mapping</span> <span class="o">+</span> <span class="p">(</span><span class="n">CDU_ILT_PAGE_SZ</span> <span class="o">*</span> <span class="n">i</span><span class="p">);</span>
		<span class="cm">/* cdu ilt pages are allocated manually so there&#39;s no need to</span>
<span class="cm">		set the size */</span>
	<span class="p">}</span>
	<span class="n">bnx2x_ilt_init_op</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">INITOP_SET</span><span class="p">);</span>

<span class="cp">#ifdef BCM_CNIC</span>
	<span class="n">bnx2x_src_init_t2</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">t2</span><span class="p">,</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">t2_mapping</span><span class="p">,</span> <span class="n">SRC_CONN_NUM</span><span class="p">);</span>

	<span class="cm">/* T1 hash bits value determines the T1 number of entries */</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">SRC_REG_NUMBER_HASH_BITS0</span> <span class="o">+</span> <span class="n">port</span><span class="o">*</span><span class="mi">4</span><span class="p">,</span> <span class="n">SRC_HASH_BITS</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="cp">#ifndef BCM_CNIC</span>
	<span class="cm">/* set NIC mode */</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">PRS_REG_NIC_MODE</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="cp">#endif  </span><span class="cm">/* BCM_CNIC */</span><span class="cp"></span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CHIP_IS_E1x</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">pf_conf</span> <span class="o">=</span> <span class="n">IGU_PF_CONF_FUNC_EN</span><span class="p">;</span>

		<span class="cm">/* Turn on a single ISR mode in IGU if driver is going to use</span>
<span class="cm">		 * INT#x or MSI</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">USING_MSIX_FLAG</span><span class="p">))</span>
			<span class="n">pf_conf</span> <span class="o">|=</span> <span class="n">IGU_PF_CONF_SINGLE_ISR_EN</span><span class="p">;</span>
		<span class="cm">/*</span>
<span class="cm">		 * Timers workaround bug: function init part.</span>
<span class="cm">		 * Need to wait 20msec after initializing ILT,</span>
<span class="cm">		 * needed to make sure there are no requests in</span>
<span class="cm">		 * one of the PXP internal queues with &quot;old&quot; ILT addresses</span>
<span class="cm">		 */</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>
		<span class="cm">/*</span>
<span class="cm">		 * Master enable - Due to WB DMAE writes performed before this</span>
<span class="cm">		 * register is re-initialized as part of the regular function</span>
<span class="cm">		 * init</span>
<span class="cm">		 */</span>
		<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">PGLUE_B_REG_INTERNAL_PFID_ENABLE_MASTER</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="cm">/* Enable the function in IGU */</span>
		<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">IGU_REG_PF_CONFIGURATION</span><span class="p">,</span> <span class="n">pf_conf</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">bp</span><span class="o">-&gt;</span><span class="n">dmae_ready</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">bnx2x_init_block</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">BLOCK_PGLUE_B</span><span class="p">,</span> <span class="n">init_phase</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CHIP_IS_E1x</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span>
		<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">PGLUE_B_REG_WAS_ERROR_PF_7_0_CLR</span><span class="p">,</span> <span class="n">func</span><span class="p">);</span>

	<span class="n">bnx2x_init_block</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">BLOCK_ATC</span><span class="p">,</span> <span class="n">init_phase</span><span class="p">);</span>
	<span class="n">bnx2x_init_block</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">BLOCK_DMAE</span><span class="p">,</span> <span class="n">init_phase</span><span class="p">);</span>
	<span class="n">bnx2x_init_block</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">BLOCK_NIG</span><span class="p">,</span> <span class="n">init_phase</span><span class="p">);</span>
	<span class="n">bnx2x_init_block</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">BLOCK_SRC</span><span class="p">,</span> <span class="n">init_phase</span><span class="p">);</span>
	<span class="n">bnx2x_init_block</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">BLOCK_MISC</span><span class="p">,</span> <span class="n">init_phase</span><span class="p">);</span>
	<span class="n">bnx2x_init_block</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">BLOCK_TCM</span><span class="p">,</span> <span class="n">init_phase</span><span class="p">);</span>
	<span class="n">bnx2x_init_block</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">BLOCK_UCM</span><span class="p">,</span> <span class="n">init_phase</span><span class="p">);</span>
	<span class="n">bnx2x_init_block</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">BLOCK_CCM</span><span class="p">,</span> <span class="n">init_phase</span><span class="p">);</span>
	<span class="n">bnx2x_init_block</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">BLOCK_XCM</span><span class="p">,</span> <span class="n">init_phase</span><span class="p">);</span>
	<span class="n">bnx2x_init_block</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">BLOCK_TSEM</span><span class="p">,</span> <span class="n">init_phase</span><span class="p">);</span>
	<span class="n">bnx2x_init_block</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">BLOCK_USEM</span><span class="p">,</span> <span class="n">init_phase</span><span class="p">);</span>
	<span class="n">bnx2x_init_block</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">BLOCK_CSEM</span><span class="p">,</span> <span class="n">init_phase</span><span class="p">);</span>
	<span class="n">bnx2x_init_block</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">BLOCK_XSEM</span><span class="p">,</span> <span class="n">init_phase</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CHIP_IS_E1x</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span>
		<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">QM_REG_PF_EN</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CHIP_IS_E1x</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">TSEM_REG_VFPF_ERR_NUM</span><span class="p">,</span> <span class="n">BNX2X_MAX_NUM_OF_VFS</span> <span class="o">+</span> <span class="n">func</span><span class="p">);</span>
		<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">USEM_REG_VFPF_ERR_NUM</span><span class="p">,</span> <span class="n">BNX2X_MAX_NUM_OF_VFS</span> <span class="o">+</span> <span class="n">func</span><span class="p">);</span>
		<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">CSEM_REG_VFPF_ERR_NUM</span><span class="p">,</span> <span class="n">BNX2X_MAX_NUM_OF_VFS</span> <span class="o">+</span> <span class="n">func</span><span class="p">);</span>
		<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">XSEM_REG_VFPF_ERR_NUM</span><span class="p">,</span> <span class="n">BNX2X_MAX_NUM_OF_VFS</span> <span class="o">+</span> <span class="n">func</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">bnx2x_init_block</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">BLOCK_QM</span><span class="p">,</span> <span class="n">init_phase</span><span class="p">);</span>

	<span class="n">bnx2x_init_block</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">BLOCK_TM</span><span class="p">,</span> <span class="n">init_phase</span><span class="p">);</span>
	<span class="n">bnx2x_init_block</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">BLOCK_DORQ</span><span class="p">,</span> <span class="n">init_phase</span><span class="p">);</span>
	<span class="n">bnx2x_init_block</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">BLOCK_BRB1</span><span class="p">,</span> <span class="n">init_phase</span><span class="p">);</span>
	<span class="n">bnx2x_init_block</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">BLOCK_PRS</span><span class="p">,</span> <span class="n">init_phase</span><span class="p">);</span>
	<span class="n">bnx2x_init_block</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">BLOCK_TSDM</span><span class="p">,</span> <span class="n">init_phase</span><span class="p">);</span>
	<span class="n">bnx2x_init_block</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">BLOCK_CSDM</span><span class="p">,</span> <span class="n">init_phase</span><span class="p">);</span>
	<span class="n">bnx2x_init_block</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">BLOCK_USDM</span><span class="p">,</span> <span class="n">init_phase</span><span class="p">);</span>
	<span class="n">bnx2x_init_block</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">BLOCK_XSDM</span><span class="p">,</span> <span class="n">init_phase</span><span class="p">);</span>
	<span class="n">bnx2x_init_block</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">BLOCK_UPB</span><span class="p">,</span> <span class="n">init_phase</span><span class="p">);</span>
	<span class="n">bnx2x_init_block</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">BLOCK_XPB</span><span class="p">,</span> <span class="n">init_phase</span><span class="p">);</span>
	<span class="n">bnx2x_init_block</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">BLOCK_PBF</span><span class="p">,</span> <span class="n">init_phase</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CHIP_IS_E1x</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span>
		<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">PBF_REG_DISABLE_PF</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">bnx2x_init_block</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">BLOCK_CDU</span><span class="p">,</span> <span class="n">init_phase</span><span class="p">);</span>

	<span class="n">bnx2x_init_block</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">BLOCK_CFC</span><span class="p">,</span> <span class="n">init_phase</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CHIP_IS_E1x</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span>
		<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">CFC_REG_WEAK_ENABLE_PF</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_MF</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">NIG_REG_LLH0_FUNC_EN</span> <span class="o">+</span> <span class="n">port</span><span class="o">*</span><span class="mi">8</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">NIG_REG_LLH0_FUNC_VLAN_ID</span> <span class="o">+</span> <span class="n">port</span><span class="o">*</span><span class="mi">8</span><span class="p">,</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">mf_ov</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">bnx2x_init_block</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">BLOCK_MISC_AEU</span><span class="p">,</span> <span class="n">init_phase</span><span class="p">);</span>

	<span class="cm">/* HC init per function */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">.</span><span class="n">int_block</span> <span class="o">==</span> <span class="n">INT_BLOCK_HC</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">CHIP_IS_E1H</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">MISC_REG_AEU_GENERAL_ATTN_12</span> <span class="o">+</span> <span class="n">func</span><span class="o">*</span><span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

			<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">HC_REG_LEADING_EDGE_0</span> <span class="o">+</span> <span class="n">port</span><span class="o">*</span><span class="mi">8</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">HC_REG_TRAILING_EDGE_0</span> <span class="o">+</span> <span class="n">port</span><span class="o">*</span><span class="mi">8</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">bnx2x_init_block</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">BLOCK_HC</span><span class="p">,</span> <span class="n">init_phase</span><span class="p">);</span>

	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">num_segs</span><span class="p">,</span> <span class="n">sb_idx</span><span class="p">,</span> <span class="n">prod_offset</span><span class="p">;</span>

		<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">MISC_REG_AEU_GENERAL_ATTN_12</span> <span class="o">+</span> <span class="n">func</span><span class="o">*</span><span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CHIP_IS_E1x</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">IGU_REG_LEADING_EDGE_LATCH</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">IGU_REG_TRAILING_EDGE_LATCH</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">bnx2x_init_block</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">BLOCK_IGU</span><span class="p">,</span> <span class="n">init_phase</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CHIP_IS_E1x</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">dsb_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="cm">/**</span>
<span class="cm">			 * Producer memory:</span>
<span class="cm">			 * E2 mode: address 0-135 match to the mapping memory;</span>
<span class="cm">			 * 136 - PF0 default prod; 137 - PF1 default prod;</span>
<span class="cm">			 * 138 - PF2 default prod; 139 - PF3 default prod;</span>
<span class="cm">			 * 140 - PF0 attn prod;    141 - PF1 attn prod;</span>
<span class="cm">			 * 142 - PF2 attn prod;    143 - PF3 attn prod;</span>
<span class="cm">			 * 144-147 reserved.</span>
<span class="cm">			 *</span>
<span class="cm">			 * E1.5 mode - In backward compatible mode;</span>
<span class="cm">			 * for non default SB; each even line in the memory</span>
<span class="cm">			 * holds the U producer and each odd line hold</span>
<span class="cm">			 * the C producer. The first 128 producers are for</span>
<span class="cm">			 * NDSB (PF0 - 0-31; PF1 - 32-63 and so on). The last 20</span>
<span class="cm">			 * producers are for the DSB for each PF.</span>
<span class="cm">			 * Each PF has five segments: (the order inside each</span>
<span class="cm">			 * segment is PF0; PF1; PF2; PF3) - 128-131 U prods;</span>
<span class="cm">			 * 132-135 C prods; 136-139 X prods; 140-143 T prods;</span>
<span class="cm">			 * 144-147 attn prods;</span>
<span class="cm">			 */</span>
			<span class="cm">/* non-default-status-blocks */</span>
			<span class="n">num_segs</span> <span class="o">=</span> <span class="n">CHIP_INT_MODE_IS_BC</span><span class="p">(</span><span class="n">bp</span><span class="p">)</span> <span class="o">?</span>
				<span class="n">IGU_BC_NDSB_NUM_SEGS</span> <span class="o">:</span> <span class="n">IGU_NORM_NDSB_NUM_SEGS</span><span class="p">;</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">sb_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">sb_idx</span> <span class="o">&lt;</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">igu_sb_cnt</span><span class="p">;</span> <span class="n">sb_idx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">prod_offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">igu_base_sb</span> <span class="o">+</span> <span class="n">sb_idx</span><span class="p">)</span> <span class="o">*</span>
					<span class="n">num_segs</span><span class="p">;</span>

				<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num_segs</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">addr</span> <span class="o">=</span> <span class="n">IGU_REG_PROD_CONS_MEMORY</span> <span class="o">+</span>
							<span class="p">(</span><span class="n">prod_offset</span> <span class="o">+</span> <span class="n">i</span><span class="p">)</span> <span class="o">*</span> <span class="mi">4</span><span class="p">;</span>
					<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
				<span class="p">}</span>
				<span class="cm">/* send consumer update with value 0 */</span>
				<span class="n">bnx2x_ack_sb</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">igu_base_sb</span> <span class="o">+</span> <span class="n">sb_idx</span><span class="p">,</span>
					     <span class="n">USTORM_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">IGU_INT_NOP</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
				<span class="n">bnx2x_igu_clear_sb</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span>
						   <span class="n">bp</span><span class="o">-&gt;</span><span class="n">igu_base_sb</span> <span class="o">+</span> <span class="n">sb_idx</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="cm">/* default-status-blocks */</span>
			<span class="n">num_segs</span> <span class="o">=</span> <span class="n">CHIP_INT_MODE_IS_BC</span><span class="p">(</span><span class="n">bp</span><span class="p">)</span> <span class="o">?</span>
				<span class="n">IGU_BC_DSB_NUM_SEGS</span> <span class="o">:</span> <span class="n">IGU_NORM_DSB_NUM_SEGS</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">CHIP_MODE_IS_4_PORT</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span>
				<span class="n">dsb_idx</span> <span class="o">=</span> <span class="n">BP_FUNC</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">dsb_idx</span> <span class="o">=</span> <span class="n">BP_VN</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>

			<span class="n">prod_offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">CHIP_INT_MODE_IS_BC</span><span class="p">(</span><span class="n">bp</span><span class="p">)</span> <span class="o">?</span>
				       <span class="n">IGU_BC_BASE_DSB_PROD</span> <span class="o">+</span> <span class="n">dsb_idx</span> <span class="o">:</span>
				       <span class="n">IGU_NORM_BASE_DSB_PROD</span> <span class="o">+</span> <span class="n">dsb_idx</span><span class="p">);</span>

			<span class="cm">/*</span>
<span class="cm">			 * igu prods come in chunks of E1HVN_MAX (4) -</span>
<span class="cm">			 * does not matters what is the current chip mode</span>
<span class="cm">			 */</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">num_segs</span> <span class="o">*</span> <span class="n">E1HVN_MAX</span><span class="p">);</span>
			     <span class="n">i</span> <span class="o">+=</span> <span class="n">E1HVN_MAX</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">addr</span> <span class="o">=</span> <span class="n">IGU_REG_PROD_CONS_MEMORY</span> <span class="o">+</span>
							<span class="p">(</span><span class="n">prod_offset</span> <span class="o">+</span> <span class="n">i</span><span class="p">)</span><span class="o">*</span><span class="mi">4</span><span class="p">;</span>
				<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="cm">/* send consumer update with 0 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">CHIP_INT_MODE_IS_BC</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">bnx2x_ack_sb</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">igu_dsb_id</span><span class="p">,</span>
					     <span class="n">USTORM_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">IGU_INT_NOP</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
				<span class="n">bnx2x_ack_sb</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">igu_dsb_id</span><span class="p">,</span>
					     <span class="n">CSTORM_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">IGU_INT_NOP</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
				<span class="n">bnx2x_ack_sb</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">igu_dsb_id</span><span class="p">,</span>
					     <span class="n">XSTORM_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">IGU_INT_NOP</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
				<span class="n">bnx2x_ack_sb</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">igu_dsb_id</span><span class="p">,</span>
					     <span class="n">TSTORM_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">IGU_INT_NOP</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
				<span class="n">bnx2x_ack_sb</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">igu_dsb_id</span><span class="p">,</span>
					     <span class="n">ATTENTION_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">IGU_INT_NOP</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">bnx2x_ack_sb</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">igu_dsb_id</span><span class="p">,</span>
					     <span class="n">USTORM_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">IGU_INT_NOP</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
				<span class="n">bnx2x_ack_sb</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">igu_dsb_id</span><span class="p">,</span>
					     <span class="n">ATTENTION_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">IGU_INT_NOP</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">bnx2x_igu_clear_sb</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">igu_dsb_id</span><span class="p">);</span>

			<span class="cm">/* !!! these should become driver const once</span>
<span class="cm">			   rf-tool supports split-68 const */</span>
			<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">IGU_REG_SB_INT_BEFORE_MASK_LSB</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">IGU_REG_SB_INT_BEFORE_MASK_MSB</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">IGU_REG_SB_MASK_LSB</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">IGU_REG_SB_MASK_MSB</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">IGU_REG_PBA_STATUS_LSB</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">IGU_REG_PBA_STATUS_MSB</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Reset PCIE errors for debug */</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="mh">0x2114</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">);</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="mh">0x2120</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">CHIP_IS_E1x</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">main_mem_size</span> <span class="o">=</span> <span class="n">HC_REG_MAIN_MEMORY_SIZE</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span> <span class="cm">/*dwords*/</span>
		<span class="n">main_mem_base</span> <span class="o">=</span> <span class="n">HC_REG_MAIN_MEMORY</span> <span class="o">+</span>
				<span class="n">BP_PORT</span><span class="p">(</span><span class="n">bp</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">main_mem_size</span> <span class="o">*</span> <span class="mi">4</span><span class="p">);</span>
		<span class="n">main_mem_prty_clr</span> <span class="o">=</span> <span class="n">HC_REG_HC_PRTY_STS_CLR</span><span class="p">;</span>
		<span class="n">main_mem_width</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>

		<span class="n">val</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">main_mem_prty_clr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">val</span><span class="p">)</span>
			<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_HW</span><span class="p">,</span>
			   <span class="s">&quot;Hmmm... Parity errors in HC block during function init (0x%x)!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">val</span><span class="p">);</span>

		<span class="cm">/* Clear &quot;false&quot; parity errors in MSI-X table */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">main_mem_base</span><span class="p">;</span>
		     <span class="n">i</span> <span class="o">&lt;</span> <span class="n">main_mem_base</span> <span class="o">+</span> <span class="n">main_mem_size</span> <span class="o">*</span> <span class="mi">4</span><span class="p">;</span>
		     <span class="n">i</span> <span class="o">+=</span> <span class="n">main_mem_width</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">bnx2x_read_dmae</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">main_mem_width</span> <span class="o">/</span> <span class="mi">4</span><span class="p">);</span>
			<span class="n">bnx2x_write_dmae</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">bnx2x_sp_mapping</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">wb_data</span><span class="p">),</span>
					 <span class="n">i</span><span class="p">,</span> <span class="n">main_mem_width</span> <span class="o">/</span> <span class="mi">4</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="cm">/* Clear HC parity attention */</span>
		<span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">main_mem_prty_clr</span><span class="p">);</span>
	<span class="p">}</span>

<span class="cp">#ifdef BNX2X_STOP_ON_ERROR</span>
	<span class="cm">/* Enable STORMs SP logging */</span>
	<span class="n">REG_WR8</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">BAR_USTRORM_INTMEM</span> <span class="o">+</span>
	       <span class="n">USTORM_RECORD_SLOW_PATH_OFFSET</span><span class="p">(</span><span class="n">BP_FUNC</span><span class="p">(</span><span class="n">bp</span><span class="p">)),</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">REG_WR8</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">BAR_TSTRORM_INTMEM</span> <span class="o">+</span>
	       <span class="n">TSTORM_RECORD_SLOW_PATH_OFFSET</span><span class="p">(</span><span class="n">BP_FUNC</span><span class="p">(</span><span class="n">bp</span><span class="p">)),</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">REG_WR8</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">BAR_CSTRORM_INTMEM</span> <span class="o">+</span>
	       <span class="n">CSTORM_RECORD_SLOW_PATH_OFFSET</span><span class="p">(</span><span class="n">BP_FUNC</span><span class="p">(</span><span class="n">bp</span><span class="p">)),</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">REG_WR8</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">BAR_XSTRORM_INTMEM</span> <span class="o">+</span>
	       <span class="n">XSTORM_RECORD_SLOW_PATH_OFFSET</span><span class="p">(</span><span class="n">BP_FUNC</span><span class="p">(</span><span class="n">bp</span><span class="p">)),</span> <span class="mi">1</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="n">bnx2x_phy_probe</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">link_params</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="kt">void</span> <span class="nf">bnx2x_free_mem</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* fastpath */</span>
	<span class="n">bnx2x_free_fp_mem</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
	<span class="cm">/* end of fastpath */</span>

	<span class="n">BNX2X_PCI_FREE</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">def_status_blk</span><span class="p">,</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">def_status_blk_mapping</span><span class="p">,</span>
		       <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">host_sp_status_block</span><span class="p">));</span>

	<span class="n">BNX2X_PCI_FREE</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">fw_stats</span><span class="p">,</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">fw_stats_mapping</span><span class="p">,</span>
		       <span class="n">bp</span><span class="o">-&gt;</span><span class="n">fw_stats_data_sz</span> <span class="o">+</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">fw_stats_req_sz</span><span class="p">);</span>

	<span class="n">BNX2X_PCI_FREE</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">slowpath</span><span class="p">,</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">slowpath_mapping</span><span class="p">,</span>
		       <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x_slowpath</span><span class="p">));</span>

	<span class="n">BNX2X_PCI_FREE</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">.</span><span class="n">vcxt</span><span class="p">,</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">.</span><span class="n">cxt_mapping</span><span class="p">,</span>
		       <span class="n">bp</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">.</span><span class="n">size</span><span class="p">);</span>

	<span class="n">bnx2x_ilt_mem_op</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">ILT_MEMOP_FREE</span><span class="p">);</span>

	<span class="n">BNX2X_FREE</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">ilt</span><span class="o">-&gt;</span><span class="n">lines</span><span class="p">);</span>

<span class="cp">#ifdef BCM_CNIC</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CHIP_IS_E1x</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span>
		<span class="n">BNX2X_PCI_FREE</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">cnic_sb</span><span class="p">.</span><span class="n">e2_sb</span><span class="p">,</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">cnic_sb_mapping</span><span class="p">,</span>
			       <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">host_hc_status_block_e2</span><span class="p">));</span>
	<span class="k">else</span>
		<span class="n">BNX2X_PCI_FREE</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">cnic_sb</span><span class="p">.</span><span class="n">e1x_sb</span><span class="p">,</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">cnic_sb_mapping</span><span class="p">,</span>
			       <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">host_hc_status_block_e1x</span><span class="p">));</span>

	<span class="n">BNX2X_PCI_FREE</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">t2</span><span class="p">,</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">t2_mapping</span><span class="p">,</span> <span class="n">SRC_T2_SZ</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="n">BNX2X_PCI_FREE</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">spq</span><span class="p">,</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">spq_mapping</span><span class="p">,</span> <span class="n">BCM_PAGE_SIZE</span><span class="p">);</span>

	<span class="n">BNX2X_PCI_FREE</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">eq_ring</span><span class="p">,</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">eq_mapping</span><span class="p">,</span>
		       <span class="n">BCM_PAGE_SIZE</span> <span class="o">*</span> <span class="n">NUM_EQ_PAGES</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bnx2x_alloc_fw_stats_mem</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">num_groups</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">is_fcoe_stats</span> <span class="o">=</span> <span class="n">NO_FCOE</span><span class="p">(</span><span class="n">bp</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* number of queues for statistics is number of eth queues + FCoE */</span>
	<span class="n">u8</span> <span class="n">num_queue_stats</span> <span class="o">=</span> <span class="n">BNX2X_NUM_ETH_QUEUES</span><span class="p">(</span><span class="n">bp</span><span class="p">)</span> <span class="o">+</span> <span class="n">is_fcoe_stats</span><span class="p">;</span>

	<span class="cm">/* Total number of FW statistics requests =</span>
<span class="cm">	 * 1 for port stats + 1 for PF stats + potential 1 for FCoE stats +</span>
<span class="cm">	 * num of queues</span>
<span class="cm">	 */</span>
	<span class="n">bp</span><span class="o">-&gt;</span><span class="n">fw_stats_num</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">is_fcoe_stats</span> <span class="o">+</span> <span class="n">num_queue_stats</span><span class="p">;</span>


	<span class="cm">/* Request is built from stats_query_header and an array of</span>
<span class="cm">	 * stats_query_cmd_group each of which contains</span>
<span class="cm">	 * STATS_QUERY_CMD_COUNT rules. The real number or requests is</span>
<span class="cm">	 * configured in the stats_query_header.</span>
<span class="cm">	 */</span>
	<span class="n">num_groups</span> <span class="o">=</span> <span class="p">((</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">fw_stats_num</span><span class="p">)</span> <span class="o">/</span> <span class="n">STATS_QUERY_CMD_COUNT</span><span class="p">)</span> <span class="o">+</span>
		     <span class="p">(((</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">fw_stats_num</span><span class="p">)</span> <span class="o">%</span> <span class="n">STATS_QUERY_CMD_COUNT</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">bp</span><span class="o">-&gt;</span><span class="n">fw_stats_req_sz</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">stats_query_header</span><span class="p">)</span> <span class="o">+</span>
			<span class="n">num_groups</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">stats_query_cmd_group</span><span class="p">);</span>

	<span class="cm">/* Data for statistics requests + stats_conter</span>
<span class="cm">	 *</span>
<span class="cm">	 * stats_counter holds per-STORM counters that are incremented</span>
<span class="cm">	 * when STORM has finished with the current request.</span>
<span class="cm">	 *</span>
<span class="cm">	 * memory for FCoE offloaded statistics are counted anyway,</span>
<span class="cm">	 * even if they will not be sent.</span>
<span class="cm">	 */</span>
	<span class="n">bp</span><span class="o">-&gt;</span><span class="n">fw_stats_data_sz</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">per_port_stats</span><span class="p">)</span> <span class="o">+</span>
		<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">per_pf_stats</span><span class="p">)</span> <span class="o">+</span>
		<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fcoe_statistics_params</span><span class="p">)</span> <span class="o">+</span>
		<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">per_queue_stats</span><span class="p">)</span> <span class="o">*</span> <span class="n">num_queue_stats</span> <span class="o">+</span>
		<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">stats_counter</span><span class="p">);</span>

	<span class="n">BNX2X_PCI_ALLOC</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">fw_stats</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">fw_stats_mapping</span><span class="p">,</span>
			<span class="n">bp</span><span class="o">-&gt;</span><span class="n">fw_stats_data_sz</span> <span class="o">+</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">fw_stats_req_sz</span><span class="p">);</span>

	<span class="cm">/* Set shortcuts */</span>
	<span class="n">bp</span><span class="o">-&gt;</span><span class="n">fw_stats_req</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x_fw_stats_req</span> <span class="o">*</span><span class="p">)</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">fw_stats</span><span class="p">;</span>
	<span class="n">bp</span><span class="o">-&gt;</span><span class="n">fw_stats_req_mapping</span> <span class="o">=</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">fw_stats_mapping</span><span class="p">;</span>

	<span class="n">bp</span><span class="o">-&gt;</span><span class="n">fw_stats_data</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x_fw_stats_data</span> <span class="o">*</span><span class="p">)</span>
		<span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">fw_stats</span> <span class="o">+</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">fw_stats_req_sz</span><span class="p">);</span>

	<span class="n">bp</span><span class="o">-&gt;</span><span class="n">fw_stats_data_mapping</span> <span class="o">=</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">fw_stats_mapping</span> <span class="o">+</span>
				   <span class="n">bp</span><span class="o">-&gt;</span><span class="n">fw_stats_req_sz</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">alloc_mem_err:</span>
	<span class="n">BNX2X_PCI_FREE</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">fw_stats</span><span class="p">,</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">fw_stats_mapping</span><span class="p">,</span>
		       <span class="n">bp</span><span class="o">-&gt;</span><span class="n">fw_stats_data_sz</span> <span class="o">+</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">fw_stats_req_sz</span><span class="p">);</span>
	<span class="n">BNX2X_ERR</span><span class="p">(</span><span class="s">&quot;Can&#39;t allocate memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
<span class="p">}</span>


<span class="kt">int</span> <span class="nf">bnx2x_alloc_mem</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef BCM_CNIC</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CHIP_IS_E1x</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span>
		<span class="cm">/* size = the status block + ramrod buffers */</span>
		<span class="n">BNX2X_PCI_ALLOC</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">cnic_sb</span><span class="p">.</span><span class="n">e2_sb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">cnic_sb_mapping</span><span class="p">,</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">host_hc_status_block_e2</span><span class="p">));</span>
	<span class="k">else</span>
		<span class="n">BNX2X_PCI_ALLOC</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">cnic_sb</span><span class="p">.</span><span class="n">e1x_sb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">cnic_sb_mapping</span><span class="p">,</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">host_hc_status_block_e1x</span><span class="p">));</span>

	<span class="cm">/* allocate searcher T2 table */</span>
	<span class="n">BNX2X_PCI_ALLOC</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">t2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">t2_mapping</span><span class="p">,</span> <span class="n">SRC_T2_SZ</span><span class="p">);</span>
<span class="cp">#endif</span>


	<span class="n">BNX2X_PCI_ALLOC</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">def_status_blk</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">def_status_blk_mapping</span><span class="p">,</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">host_sp_status_block</span><span class="p">));</span>

	<span class="n">BNX2X_PCI_ALLOC</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">slowpath</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">slowpath_mapping</span><span class="p">,</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x_slowpath</span><span class="p">));</span>

<span class="cp">#ifdef BCM_CNIC</span>
	<span class="cm">/* write address to which L5 should insert its values */</span>
	<span class="n">bp</span><span class="o">-&gt;</span><span class="n">cnic_eth_dev</span><span class="p">.</span><span class="n">addr_drv_info_to_mcp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">slowpath</span><span class="o">-&gt;</span><span class="n">drv_info_to_mcp</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="cm">/* Allocated memory for FW statistics  */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bnx2x_alloc_fw_stats_mem</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">alloc_mem_err</span><span class="p">;</span>

	<span class="n">bp</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">union</span> <span class="n">cdu_context</span><span class="p">)</span> <span class="o">*</span> <span class="n">BNX2X_L2_CID_COUNT</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>

	<span class="n">BNX2X_PCI_ALLOC</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">.</span><span class="n">vcxt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">.</span><span class="n">cxt_mapping</span><span class="p">,</span>
			<span class="n">bp</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">.</span><span class="n">size</span><span class="p">);</span>

	<span class="n">BNX2X_ALLOC</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">ilt</span><span class="o">-&gt;</span><span class="n">lines</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ilt_line</span><span class="p">)</span> <span class="o">*</span> <span class="n">ILT_MAX_LINES</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bnx2x_ilt_mem_op</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">ILT_MEMOP_ALLOC</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">alloc_mem_err</span><span class="p">;</span>

	<span class="cm">/* Slow path ring */</span>
	<span class="n">BNX2X_PCI_ALLOC</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">spq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">spq_mapping</span><span class="p">,</span> <span class="n">BCM_PAGE_SIZE</span><span class="p">);</span>

	<span class="cm">/* EQ */</span>
	<span class="n">BNX2X_PCI_ALLOC</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">eq_ring</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">eq_mapping</span><span class="p">,</span>
			<span class="n">BCM_PAGE_SIZE</span> <span class="o">*</span> <span class="n">NUM_EQ_PAGES</span><span class="p">);</span>


	<span class="cm">/* fastpath */</span>
	<span class="cm">/* need to be done at the end, since it&#39;s self adjusting to amount</span>
<span class="cm">	 * of memory available for RSS queues</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bnx2x_alloc_fp_mem</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">alloc_mem_err</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">alloc_mem_err:</span>
	<span class="n">bnx2x_free_mem</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
	<span class="n">BNX2X_ERR</span><span class="p">(</span><span class="s">&quot;Can&#39;t allocate memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Init service functions</span>
<span class="cm"> */</span>

<span class="kt">int</span> <span class="nf">bnx2x_set_mac_one</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">mac</span><span class="p">,</span>
		      <span class="k">struct</span> <span class="n">bnx2x_vlan_mac_obj</span> <span class="o">*</span><span class="n">obj</span><span class="p">,</span> <span class="n">bool</span> <span class="n">set</span><span class="p">,</span>
		      <span class="kt">int</span> <span class="n">mac_type</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">ramrod_flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bnx2x_vlan_mac_ramrod_params</span> <span class="n">ramrod_param</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ramrod_param</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ramrod_param</span><span class="p">));</span>

	<span class="cm">/* Fill general parameters */</span>
	<span class="n">ramrod_param</span><span class="p">.</span><span class="n">vlan_mac_obj</span> <span class="o">=</span> <span class="n">obj</span><span class="p">;</span>
	<span class="n">ramrod_param</span><span class="p">.</span><span class="n">ramrod_flags</span> <span class="o">=</span> <span class="o">*</span><span class="n">ramrod_flags</span><span class="p">;</span>

	<span class="cm">/* Fill a user request section if needed */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">RAMROD_CONT</span><span class="p">,</span> <span class="n">ramrod_flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">ramrod_param</span><span class="p">.</span><span class="n">user_req</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">mac</span><span class="p">.</span><span class="n">mac</span><span class="p">,</span> <span class="n">mac</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>

		<span class="n">__set_bit</span><span class="p">(</span><span class="n">mac_type</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ramrod_param</span><span class="p">.</span><span class="n">user_req</span><span class="p">.</span><span class="n">vlan_mac_flags</span><span class="p">);</span>

		<span class="cm">/* Set the command: ADD or DEL */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">set</span><span class="p">)</span>
			<span class="n">ramrod_param</span><span class="p">.</span><span class="n">user_req</span><span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">BNX2X_VLAN_MAC_ADD</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">ramrod_param</span><span class="p">.</span><span class="n">user_req</span><span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">BNX2X_VLAN_MAC_DEL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">bnx2x_config_vlan_mac</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ramrod_param</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">BNX2X_ERR</span><span class="p">(</span><span class="s">&quot;%s MAC failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">set</span> <span class="o">?</span> <span class="s">&quot;Set&quot;</span> <span class="o">:</span> <span class="s">&quot;Del&quot;</span><span class="p">));</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">bnx2x_del_all_macs</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">,</span>
		       <span class="k">struct</span> <span class="n">bnx2x_vlan_mac_obj</span> <span class="o">*</span><span class="n">mac_obj</span><span class="p">,</span>
		       <span class="kt">int</span> <span class="n">mac_type</span><span class="p">,</span> <span class="n">bool</span> <span class="n">wait_for_comp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ramrod_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">vlan_mac_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Wait for completion of requested */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wait_for_comp</span><span class="p">)</span>
		<span class="n">__set_bit</span><span class="p">(</span><span class="n">RAMROD_COMP_WAIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ramrod_flags</span><span class="p">);</span>

	<span class="cm">/* Set the mac type of addresses we want to clear */</span>
	<span class="n">__set_bit</span><span class="p">(</span><span class="n">mac_type</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vlan_mac_flags</span><span class="p">);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">mac_obj</span><span class="o">-&gt;</span><span class="n">delete_all</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">mac_obj</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vlan_mac_flags</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ramrod_flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">BNX2X_ERR</span><span class="p">(</span><span class="s">&quot;Failed to delete MACs: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">bnx2x_set_eth_mac</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">,</span> <span class="n">bool</span> <span class="n">set</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ramrod_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="cp">#ifdef BCM_CNIC</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is_zero_ether_addr</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">IS_MF_STORAGE_SD</span><span class="p">(</span><span class="n">bp</span><span class="p">)</span> <span class="o">||</span> <span class="n">IS_MF_FCOE_AFEX</span><span class="p">(</span><span class="n">bp</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_IFUP</span> <span class="o">|</span> <span class="n">NETIF_MSG_IFDOWN</span><span class="p">,</span>
		   <span class="s">&quot;Ignoring Zero MAC for STORAGE SD mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_IFUP</span><span class="p">,</span> <span class="s">&quot;Adding Eth MAC</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">__set_bit</span><span class="p">(</span><span class="n">RAMROD_COMP_WAIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ramrod_flags</span><span class="p">);</span>
	<span class="cm">/* Eth MAC is set on RSS leading client (fp[0]) */</span>
	<span class="k">return</span> <span class="n">bnx2x_set_mac_one</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">mac_obj</span><span class="p">,</span> <span class="n">set</span><span class="p">,</span>
				 <span class="n">BNX2X_ETH_MAC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ramrod_flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">bnx2x_setup_leading</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">bnx2x_setup_queue</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">fp</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * bnx2x_set_int_mode - configure interrupt mode</span>
<span class="cm"> *</span>
<span class="cm"> * @bp:		driver handle</span>
<span class="cm"> *</span>
<span class="cm"> * In case of MSI-X it will also try to enable MSI-X.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span> <span class="nf">bnx2x_set_int_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">int_mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">INT_MODE_MSI</span>:
		<span class="n">bnx2x_enable_msi</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
		<span class="cm">/* falling through... */</span>
	<span class="k">case</span> <span class="n">INT_MODE_INTx</span>:
		<span class="n">bp</span><span class="o">-&gt;</span><span class="n">num_queues</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">NON_ETH_CONTEXT_USE</span><span class="p">;</span>
		<span class="n">BNX2X_DEV_INFO</span><span class="p">(</span><span class="s">&quot;set number of queues to 1</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="cm">/* Set number of queues for MSI-X mode */</span>
		<span class="n">bnx2x_set_num_queues</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>

		<span class="n">BNX2X_DEV_INFO</span><span class="p">(</span><span class="s">&quot;set number of queues to %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">num_queues</span><span class="p">);</span>

		<span class="cm">/* if we can&#39;t use MSI-X we only need one fp,</span>
<span class="cm">		 * so try to enable MSI-X with the requested number of fp&#39;s</span>
<span class="cm">		 * and fallback to MSI or legacy INTx with one fp</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bnx2x_enable_msix</span><span class="p">(</span><span class="n">bp</span><span class="p">)</span> <span class="o">||</span>
		    <span class="n">bp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">USING_SINGLE_MSIX_FLAG</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* failed to enable multiple MSI-X */</span>
			<span class="n">BNX2X_DEV_INFO</span><span class="p">(</span><span class="s">&quot;Failed to enable multiple MSI-X (%d), set number of queues to %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">bp</span><span class="o">-&gt;</span><span class="n">num_queues</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">NON_ETH_CONTEXT_USE</span><span class="p">);</span>

			<span class="n">bp</span><span class="o">-&gt;</span><span class="n">num_queues</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">NON_ETH_CONTEXT_USE</span><span class="p">;</span>

			<span class="cm">/* Try to enable MSI */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">USING_SINGLE_MSIX_FLAG</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="o">!</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DISABLE_MSI_FLAG</span><span class="p">))</span>
				<span class="n">bnx2x_enable_msi</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* must be called prioir to any HW initializations */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="n">u16</span> <span class="nf">bnx2x_cid_ilt_lines</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">L2_ILT_LINES</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">bnx2x_ilt_set_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ilt_client_info</span> <span class="o">*</span><span class="n">ilt_client</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bnx2x_ilt</span> <span class="o">*</span><span class="n">ilt</span> <span class="o">=</span> <span class="n">BP_ILT</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
	<span class="n">u16</span> <span class="n">line</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ilt</span><span class="o">-&gt;</span><span class="n">start_line</span> <span class="o">=</span> <span class="n">FUNC_ILT_BASE</span><span class="p">(</span><span class="n">BP_FUNC</span><span class="p">(</span><span class="n">bp</span><span class="p">));</span>
	<span class="n">DP</span><span class="p">(</span><span class="n">BNX2X_MSG_SP</span><span class="p">,</span> <span class="s">&quot;ilt starts at line %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ilt</span><span class="o">-&gt;</span><span class="n">start_line</span><span class="p">);</span>

	<span class="cm">/* CDU */</span>
	<span class="n">ilt_client</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ilt</span><span class="o">-&gt;</span><span class="n">clients</span><span class="p">[</span><span class="n">ILT_CLIENT_CDU</span><span class="p">];</span>
	<span class="n">ilt_client</span><span class="o">-&gt;</span><span class="n">client_num</span> <span class="o">=</span> <span class="n">ILT_CLIENT_CDU</span><span class="p">;</span>
	<span class="n">ilt_client</span><span class="o">-&gt;</span><span class="n">page_size</span> <span class="o">=</span> <span class="n">CDU_ILT_PAGE_SZ</span><span class="p">;</span>
	<span class="n">ilt_client</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">ILT_CLIENT_SKIP_MEM</span><span class="p">;</span>
	<span class="n">ilt_client</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">=</span> <span class="n">line</span><span class="p">;</span>
	<span class="n">line</span> <span class="o">+=</span> <span class="n">bnx2x_cid_ilt_lines</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
<span class="cp">#ifdef BCM_CNIC</span>
	<span class="n">line</span> <span class="o">+=</span> <span class="n">CNIC_ILT_LINES</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="n">ilt_client</span><span class="o">-&gt;</span><span class="n">end</span> <span class="o">=</span> <span class="n">line</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_IFUP</span><span class="p">,</span> <span class="s">&quot;ilt client[CDU]: start %d, end %d, psz 0x%x, flags 0x%x, hw psz %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	   <span class="n">ilt_client</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span>
	   <span class="n">ilt_client</span><span class="o">-&gt;</span><span class="n">end</span><span class="p">,</span>
	   <span class="n">ilt_client</span><span class="o">-&gt;</span><span class="n">page_size</span><span class="p">,</span>
	   <span class="n">ilt_client</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">,</span>
	   <span class="n">ilog2</span><span class="p">(</span><span class="n">ilt_client</span><span class="o">-&gt;</span><span class="n">page_size</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">));</span>

	<span class="cm">/* QM */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">QM_INIT</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">qm_cid_count</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ilt_client</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ilt</span><span class="o">-&gt;</span><span class="n">clients</span><span class="p">[</span><span class="n">ILT_CLIENT_QM</span><span class="p">];</span>
		<span class="n">ilt_client</span><span class="o">-&gt;</span><span class="n">client_num</span> <span class="o">=</span> <span class="n">ILT_CLIENT_QM</span><span class="p">;</span>
		<span class="n">ilt_client</span><span class="o">-&gt;</span><span class="n">page_size</span> <span class="o">=</span> <span class="n">QM_ILT_PAGE_SZ</span><span class="p">;</span>
		<span class="n">ilt_client</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ilt_client</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">=</span> <span class="n">line</span><span class="p">;</span>

		<span class="cm">/* 4 bytes for each cid */</span>
		<span class="n">line</span> <span class="o">+=</span> <span class="n">DIV_ROUND_UP</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">qm_cid_count</span> <span class="o">*</span> <span class="n">QM_QUEUES_PER_FUNC</span> <span class="o">*</span> <span class="mi">4</span><span class="p">,</span>
							 <span class="n">QM_ILT_PAGE_SZ</span><span class="p">);</span>

		<span class="n">ilt_client</span><span class="o">-&gt;</span><span class="n">end</span> <span class="o">=</span> <span class="n">line</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

		<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_IFUP</span><span class="p">,</span>
		   <span class="s">&quot;ilt client[QM]: start %d, end %d, psz 0x%x, flags 0x%x, hw psz %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">ilt_client</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span>
		   <span class="n">ilt_client</span><span class="o">-&gt;</span><span class="n">end</span><span class="p">,</span>
		   <span class="n">ilt_client</span><span class="o">-&gt;</span><span class="n">page_size</span><span class="p">,</span>
		   <span class="n">ilt_client</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">,</span>
		   <span class="n">ilog2</span><span class="p">(</span><span class="n">ilt_client</span><span class="o">-&gt;</span><span class="n">page_size</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">));</span>

	<span class="p">}</span>
	<span class="cm">/* SRC */</span>
	<span class="n">ilt_client</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ilt</span><span class="o">-&gt;</span><span class="n">clients</span><span class="p">[</span><span class="n">ILT_CLIENT_SRC</span><span class="p">];</span>
<span class="cp">#ifdef BCM_CNIC</span>
	<span class="n">ilt_client</span><span class="o">-&gt;</span><span class="n">client_num</span> <span class="o">=</span> <span class="n">ILT_CLIENT_SRC</span><span class="p">;</span>
	<span class="n">ilt_client</span><span class="o">-&gt;</span><span class="n">page_size</span> <span class="o">=</span> <span class="n">SRC_ILT_PAGE_SZ</span><span class="p">;</span>
	<span class="n">ilt_client</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ilt_client</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">=</span> <span class="n">line</span><span class="p">;</span>
	<span class="n">line</span> <span class="o">+=</span> <span class="n">SRC_ILT_LINES</span><span class="p">;</span>
	<span class="n">ilt_client</span><span class="o">-&gt;</span><span class="n">end</span> <span class="o">=</span> <span class="n">line</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_IFUP</span><span class="p">,</span>
	   <span class="s">&quot;ilt client[SRC]: start %d, end %d, psz 0x%x, flags 0x%x, hw psz %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	   <span class="n">ilt_client</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span>
	   <span class="n">ilt_client</span><span class="o">-&gt;</span><span class="n">end</span><span class="p">,</span>
	   <span class="n">ilt_client</span><span class="o">-&gt;</span><span class="n">page_size</span><span class="p">,</span>
	   <span class="n">ilt_client</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">,</span>
	   <span class="n">ilog2</span><span class="p">(</span><span class="n">ilt_client</span><span class="o">-&gt;</span><span class="n">page_size</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">));</span>

<span class="cp">#else</span>
	<span class="n">ilt_client</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="p">(</span><span class="n">ILT_CLIENT_SKIP_INIT</span> <span class="o">|</span> <span class="n">ILT_CLIENT_SKIP_MEM</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="cm">/* TM */</span>
	<span class="n">ilt_client</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ilt</span><span class="o">-&gt;</span><span class="n">clients</span><span class="p">[</span><span class="n">ILT_CLIENT_TM</span><span class="p">];</span>
<span class="cp">#ifdef BCM_CNIC</span>
	<span class="n">ilt_client</span><span class="o">-&gt;</span><span class="n">client_num</span> <span class="o">=</span> <span class="n">ILT_CLIENT_TM</span><span class="p">;</span>
	<span class="n">ilt_client</span><span class="o">-&gt;</span><span class="n">page_size</span> <span class="o">=</span> <span class="n">TM_ILT_PAGE_SZ</span><span class="p">;</span>
	<span class="n">ilt_client</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ilt_client</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">=</span> <span class="n">line</span><span class="p">;</span>
	<span class="n">line</span> <span class="o">+=</span> <span class="n">TM_ILT_LINES</span><span class="p">;</span>
	<span class="n">ilt_client</span><span class="o">-&gt;</span><span class="n">end</span> <span class="o">=</span> <span class="n">line</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_IFUP</span><span class="p">,</span>
	   <span class="s">&quot;ilt client[TM]: start %d, end %d, psz 0x%x, flags 0x%x, hw psz %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	   <span class="n">ilt_client</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span>
	   <span class="n">ilt_client</span><span class="o">-&gt;</span><span class="n">end</span><span class="p">,</span>
	   <span class="n">ilt_client</span><span class="o">-&gt;</span><span class="n">page_size</span><span class="p">,</span>
	   <span class="n">ilt_client</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">,</span>
	   <span class="n">ilog2</span><span class="p">(</span><span class="n">ilt_client</span><span class="o">-&gt;</span><span class="n">page_size</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">));</span>

<span class="cp">#else</span>
	<span class="n">ilt_client</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="p">(</span><span class="n">ILT_CLIENT_SKIP_INIT</span> <span class="o">|</span> <span class="n">ILT_CLIENT_SKIP_MEM</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">line</span> <span class="o">&gt;</span> <span class="n">ILT_MAX_LINES</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * bnx2x_pf_q_prep_init - prepare INIT transition parameters</span>
<span class="cm"> *</span>
<span class="cm"> * @bp:			driver handle</span>
<span class="cm"> * @fp:			pointer to fastpath</span>
<span class="cm"> * @init_params:	pointer to parameters structure</span>
<span class="cm"> *</span>
<span class="cm"> * parameters configured:</span>
<span class="cm"> *      - HC configuration</span>
<span class="cm"> *      - Queue&#39;s CDU context</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_pf_q_prep_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">bnx2x_fastpath</span> <span class="o">*</span><span class="n">fp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bnx2x_queue_init_params</span> <span class="o">*</span><span class="n">init_params</span><span class="p">)</span>
<span class="p">{</span>

	<span class="n">u8</span> <span class="n">cos</span><span class="p">;</span>
	<span class="cm">/* FCoE Queue uses Default SB, thus has no HC capabilities */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_FCOE_FP</span><span class="p">(</span><span class="n">fp</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">__set_bit</span><span class="p">(</span><span class="n">BNX2X_Q_FLG_HC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">init_params</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">__set_bit</span><span class="p">(</span><span class="n">BNX2X_Q_FLG_HC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">init_params</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">flags</span><span class="p">);</span>

		<span class="cm">/* If HC is supporterd, enable host coalescing in the transition</span>
<span class="cm">		 * to INIT state.</span>
<span class="cm">		 */</span>
		<span class="n">__set_bit</span><span class="p">(</span><span class="n">BNX2X_Q_FLG_HC_EN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">init_params</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">__set_bit</span><span class="p">(</span><span class="n">BNX2X_Q_FLG_HC_EN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">init_params</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">flags</span><span class="p">);</span>

		<span class="cm">/* HC rate */</span>
		<span class="n">init_params</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">hc_rate</span> <span class="o">=</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">rx_ticks</span> <span class="o">?</span>
			<span class="p">(</span><span class="mi">1000000</span> <span class="o">/</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">rx_ticks</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">init_params</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">hc_rate</span> <span class="o">=</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">tx_ticks</span> <span class="o">?</span>
			<span class="p">(</span><span class="mi">1000000</span> <span class="o">/</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">tx_ticks</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

		<span class="cm">/* FW SB ID */</span>
		<span class="n">init_params</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">fw_sb_id</span> <span class="o">=</span> <span class="n">init_params</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">fw_sb_id</span> <span class="o">=</span>
			<span class="n">fp</span><span class="o">-&gt;</span><span class="n">fw_sb_id</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * CQ index among the SB indices: FCoE clients uses the default</span>
<span class="cm">		 * SB, therefore it&#39;s different.</span>
<span class="cm">		 */</span>
		<span class="n">init_params</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">sb_cq_index</span> <span class="o">=</span> <span class="n">HC_INDEX_ETH_RX_CQ_CONS</span><span class="p">;</span>
		<span class="n">init_params</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">sb_cq_index</span> <span class="o">=</span> <span class="n">HC_INDEX_ETH_FIRST_TX_CQ_CONS</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* set maximum number of COSs supported by this queue */</span>
	<span class="n">init_params</span><span class="o">-&gt;</span><span class="n">max_cos</span> <span class="o">=</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">max_cos</span><span class="p">;</span>

	<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_IFUP</span><span class="p">,</span> <span class="s">&quot;fp: %d setting queue params max cos to: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">fp</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">,</span> <span class="n">init_params</span><span class="o">-&gt;</span><span class="n">max_cos</span><span class="p">);</span>

	<span class="cm">/* set the context pointers queue object */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">cos</span> <span class="o">=</span> <span class="n">FIRST_TX_COS_INDEX</span><span class="p">;</span> <span class="n">cos</span> <span class="o">&lt;</span> <span class="n">init_params</span><span class="o">-&gt;</span><span class="n">max_cos</span><span class="p">;</span> <span class="n">cos</span><span class="o">++</span><span class="p">)</span>
		<span class="n">init_params</span><span class="o">-&gt;</span><span class="n">cxts</span><span class="p">[</span><span class="n">cos</span><span class="p">]</span> <span class="o">=</span>
			<span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">.</span><span class="n">vcxt</span><span class="p">[</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">txdata</span><span class="p">[</span><span class="n">cos</span><span class="p">].</span><span class="n">cid</span><span class="p">].</span><span class="n">eth</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">bnx2x_setup_tx_only</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bnx2x_fastpath</span> <span class="o">*</span><span class="n">fp</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">bnx2x_queue_state_params</span> <span class="o">*</span><span class="n">q_params</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">bnx2x_queue_setup_tx_only_params</span> <span class="o">*</span><span class="n">tx_only_params</span><span class="p">,</span>
			<span class="kt">int</span> <span class="n">tx_index</span><span class="p">,</span> <span class="n">bool</span> <span class="n">leading</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">tx_only_params</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">tx_only_params</span><span class="p">));</span>

	<span class="cm">/* Set the command */</span>
	<span class="n">q_params</span><span class="o">-&gt;</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">BNX2X_Q_CMD_SETUP_TX_ONLY</span><span class="p">;</span>

	<span class="cm">/* Set tx-only QUEUE flags: don&#39;t zero statistics */</span>
	<span class="n">tx_only_params</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">bnx2x_get_common_flags</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">fp</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>

	<span class="cm">/* choose the index of the cid to send the slow path on */</span>
	<span class="n">tx_only_params</span><span class="o">-&gt;</span><span class="n">cid_index</span> <span class="o">=</span> <span class="n">tx_index</span><span class="p">;</span>

	<span class="cm">/* Set general TX_ONLY_SETUP parameters */</span>
	<span class="n">bnx2x_pf_q_prep_general</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">fp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tx_only_params</span><span class="o">-&gt;</span><span class="n">gen_params</span><span class="p">,</span> <span class="n">tx_index</span><span class="p">);</span>

	<span class="cm">/* Set Tx TX_ONLY_SETUP parameters */</span>
	<span class="n">bnx2x_pf_tx_q_prep</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">fp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tx_only_params</span><span class="o">-&gt;</span><span class="n">txq_params</span><span class="p">,</span> <span class="n">tx_index</span><span class="p">);</span>

	<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_IFUP</span><span class="p">,</span>
	   <span class="s">&quot;preparing to send tx-only ramrod for connection: cos %d, primary cid %d, cid %d, client id %d, sp-client id %d, flags %lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	   <span class="n">tx_index</span><span class="p">,</span> <span class="n">q_params</span><span class="o">-&gt;</span><span class="n">q_obj</span><span class="o">-&gt;</span><span class="n">cids</span><span class="p">[</span><span class="n">FIRST_TX_COS_INDEX</span><span class="p">],</span>
	   <span class="n">q_params</span><span class="o">-&gt;</span><span class="n">q_obj</span><span class="o">-&gt;</span><span class="n">cids</span><span class="p">[</span><span class="n">tx_index</span><span class="p">],</span> <span class="n">q_params</span><span class="o">-&gt;</span><span class="n">q_obj</span><span class="o">-&gt;</span><span class="n">cl_id</span><span class="p">,</span>
	   <span class="n">tx_only_params</span><span class="o">-&gt;</span><span class="n">gen_params</span><span class="p">.</span><span class="n">spcl_id</span><span class="p">,</span> <span class="n">tx_only_params</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* send the ramrod */</span>
	<span class="k">return</span> <span class="n">bnx2x_queue_state_change</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">q_params</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * bnx2x_setup_queue - setup queue</span>
<span class="cm"> *</span>
<span class="cm"> * @bp:		driver handle</span>
<span class="cm"> * @fp:		pointer to fastpath</span>
<span class="cm"> * @leading:	is leading</span>
<span class="cm"> *</span>
<span class="cm"> * This function performs 2 steps in a Queue state machine</span>
<span class="cm"> *      actually: 1) RESET-&gt;INIT 2) INIT-&gt;SETUP</span>
<span class="cm"> */</span>

<span class="kt">int</span> <span class="nf">bnx2x_setup_queue</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bnx2x_fastpath</span> <span class="o">*</span><span class="n">fp</span><span class="p">,</span>
		       <span class="n">bool</span> <span class="n">leading</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2x_queue_state_params</span> <span class="n">q_params</span> <span class="o">=</span> <span class="p">{</span><span class="nb">NULL</span><span class="p">};</span>
	<span class="k">struct</span> <span class="n">bnx2x_queue_setup_params</span> <span class="o">*</span><span class="n">setup_params</span> <span class="o">=</span>
						<span class="o">&amp;</span><span class="n">q_params</span><span class="p">.</span><span class="n">params</span><span class="p">.</span><span class="n">setup</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bnx2x_queue_setup_tx_only_params</span> <span class="o">*</span><span class="n">tx_only_params</span> <span class="o">=</span>
						<span class="o">&amp;</span><span class="n">q_params</span><span class="p">.</span><span class="n">params</span><span class="p">.</span><span class="n">tx_only</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">tx_index</span><span class="p">;</span>

	<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_IFUP</span><span class="p">,</span> <span class="s">&quot;setting up queue %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">);</span>

	<span class="cm">/* reset IGU state skip FCoE L2 queue */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_FCOE_FP</span><span class="p">(</span><span class="n">fp</span><span class="p">))</span>
		<span class="n">bnx2x_ack_sb</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">igu_sb_id</span><span class="p">,</span> <span class="n">USTORM_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			     <span class="n">IGU_INT_ENABLE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">q_params</span><span class="p">.</span><span class="n">q_obj</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">q_obj</span><span class="p">;</span>
	<span class="cm">/* We want to wait for completion in this context */</span>
	<span class="n">__set_bit</span><span class="p">(</span><span class="n">RAMROD_COMP_WAIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">q_params</span><span class="p">.</span><span class="n">ramrod_flags</span><span class="p">);</span>

	<span class="cm">/* Prepare the INIT parameters */</span>
	<span class="n">bnx2x_pf_q_prep_init</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">fp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">q_params</span><span class="p">.</span><span class="n">params</span><span class="p">.</span><span class="n">init</span><span class="p">);</span>

	<span class="cm">/* Set the command */</span>
	<span class="n">q_params</span><span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">BNX2X_Q_CMD_INIT</span><span class="p">;</span>

	<span class="cm">/* Change the state to INIT */</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">bnx2x_queue_state_change</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">q_params</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BNX2X_ERR</span><span class="p">(</span><span class="s">&quot;Queue(%d) INIT failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_IFUP</span><span class="p">,</span> <span class="s">&quot;init complete</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>


	<span class="cm">/* Now move the Queue to the SETUP state... */</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">setup_params</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">setup_params</span><span class="p">));</span>

	<span class="cm">/* Set QUEUE flags */</span>
	<span class="n">setup_params</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">bnx2x_get_q_flags</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">fp</span><span class="p">,</span> <span class="n">leading</span><span class="p">);</span>

	<span class="cm">/* Set general SETUP parameters */</span>
	<span class="n">bnx2x_pf_q_prep_general</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">fp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">setup_params</span><span class="o">-&gt;</span><span class="n">gen_params</span><span class="p">,</span>
				<span class="n">FIRST_TX_COS_INDEX</span><span class="p">);</span>

	<span class="n">bnx2x_pf_rx_q_prep</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">fp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">setup_params</span><span class="o">-&gt;</span><span class="n">pause_params</span><span class="p">,</span>
			    <span class="o">&amp;</span><span class="n">setup_params</span><span class="o">-&gt;</span><span class="n">rxq_params</span><span class="p">);</span>

	<span class="n">bnx2x_pf_tx_q_prep</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">fp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">setup_params</span><span class="o">-&gt;</span><span class="n">txq_params</span><span class="p">,</span>
			   <span class="n">FIRST_TX_COS_INDEX</span><span class="p">);</span>

	<span class="cm">/* Set the command */</span>
	<span class="n">q_params</span><span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">BNX2X_Q_CMD_SETUP</span><span class="p">;</span>

	<span class="cm">/* Change the state to SETUP */</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">bnx2x_queue_state_change</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">q_params</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BNX2X_ERR</span><span class="p">(</span><span class="s">&quot;Queue(%d) SETUP failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* loop through the relevant tx-only indices */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">tx_index</span> <span class="o">=</span> <span class="n">FIRST_TX_ONLY_COS_INDEX</span><span class="p">;</span>
	      <span class="n">tx_index</span> <span class="o">&lt;</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">max_cos</span><span class="p">;</span>
	      <span class="n">tx_index</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

		<span class="cm">/* prepare and send tx-only ramrod*/</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">bnx2x_setup_tx_only</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">fp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">q_params</span><span class="p">,</span>
					  <span class="n">tx_only_params</span><span class="p">,</span> <span class="n">tx_index</span><span class="p">,</span> <span class="n">leading</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">BNX2X_ERR</span><span class="p">(</span><span class="s">&quot;Queue(%d.%d) TX_ONLY_SETUP failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				  <span class="n">fp</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">,</span> <span class="n">tx_index</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bnx2x_stop_queue</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">index</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2x_fastpath</span> <span class="o">*</span><span class="n">fp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">fp</span><span class="p">[</span><span class="n">index</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">bnx2x_fp_txdata</span> <span class="o">*</span><span class="n">txdata</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bnx2x_queue_state_params</span> <span class="n">q_params</span> <span class="o">=</span> <span class="p">{</span><span class="nb">NULL</span><span class="p">};</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">,</span> <span class="n">tx_index</span><span class="p">;</span>

	<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_IFDOWN</span><span class="p">,</span> <span class="s">&quot;stopping queue %d cid %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">cid</span><span class="p">);</span>

	<span class="n">q_params</span><span class="p">.</span><span class="n">q_obj</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">q_obj</span><span class="p">;</span>
	<span class="cm">/* We want to wait for completion in this context */</span>
	<span class="n">__set_bit</span><span class="p">(</span><span class="n">RAMROD_COMP_WAIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">q_params</span><span class="p">.</span><span class="n">ramrod_flags</span><span class="p">);</span>


	<span class="cm">/* close tx-only connections */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">tx_index</span> <span class="o">=</span> <span class="n">FIRST_TX_ONLY_COS_INDEX</span><span class="p">;</span>
	     <span class="n">tx_index</span> <span class="o">&lt;</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">max_cos</span><span class="p">;</span>
	     <span class="n">tx_index</span><span class="o">++</span><span class="p">){</span>

		<span class="cm">/* ascertain this is a normal queue*/</span>
		<span class="n">txdata</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">txdata</span><span class="p">[</span><span class="n">tx_index</span><span class="p">];</span>

		<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_IFDOWN</span><span class="p">,</span> <span class="s">&quot;stopping tx-only queue %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
							<span class="n">txdata</span><span class="o">-&gt;</span><span class="n">txq_index</span><span class="p">);</span>

		<span class="cm">/* send halt terminate on tx-only connection */</span>
		<span class="n">q_params</span><span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">BNX2X_Q_CMD_TERMINATE</span><span class="p">;</span>
		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">q_params</span><span class="p">.</span><span class="n">params</span><span class="p">.</span><span class="n">terminate</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
		       <span class="k">sizeof</span><span class="p">(</span><span class="n">q_params</span><span class="p">.</span><span class="n">params</span><span class="p">.</span><span class="n">terminate</span><span class="p">));</span>
		<span class="n">q_params</span><span class="p">.</span><span class="n">params</span><span class="p">.</span><span class="n">terminate</span><span class="p">.</span><span class="n">cid_index</span> <span class="o">=</span> <span class="n">tx_index</span><span class="p">;</span>

		<span class="n">rc</span> <span class="o">=</span> <span class="n">bnx2x_queue_state_change</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">q_params</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

		<span class="cm">/* send halt terminate on tx-only connection */</span>
		<span class="n">q_params</span><span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">BNX2X_Q_CMD_CFC_DEL</span><span class="p">;</span>
		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">q_params</span><span class="p">.</span><span class="n">params</span><span class="p">.</span><span class="n">cfc_del</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
		       <span class="k">sizeof</span><span class="p">(</span><span class="n">q_params</span><span class="p">.</span><span class="n">params</span><span class="p">.</span><span class="n">cfc_del</span><span class="p">));</span>
		<span class="n">q_params</span><span class="p">.</span><span class="n">params</span><span class="p">.</span><span class="n">cfc_del</span><span class="p">.</span><span class="n">cid_index</span> <span class="o">=</span> <span class="n">tx_index</span><span class="p">;</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">bnx2x_queue_state_change</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">q_params</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* Stop the primary connection: */</span>
	<span class="cm">/* ...halt the connection */</span>
	<span class="n">q_params</span><span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">BNX2X_Q_CMD_HALT</span><span class="p">;</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">bnx2x_queue_state_change</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">q_params</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="cm">/* ...terminate the connection */</span>
	<span class="n">q_params</span><span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">BNX2X_Q_CMD_TERMINATE</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">q_params</span><span class="p">.</span><span class="n">params</span><span class="p">.</span><span class="n">terminate</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
	       <span class="k">sizeof</span><span class="p">(</span><span class="n">q_params</span><span class="p">.</span><span class="n">params</span><span class="p">.</span><span class="n">terminate</span><span class="p">));</span>
	<span class="n">q_params</span><span class="p">.</span><span class="n">params</span><span class="p">.</span><span class="n">terminate</span><span class="p">.</span><span class="n">cid_index</span> <span class="o">=</span> <span class="n">FIRST_TX_COS_INDEX</span><span class="p">;</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">bnx2x_queue_state_change</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">q_params</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="cm">/* ...delete cfc entry */</span>
	<span class="n">q_params</span><span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">BNX2X_Q_CMD_CFC_DEL</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">q_params</span><span class="p">.</span><span class="n">params</span><span class="p">.</span><span class="n">cfc_del</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
	       <span class="k">sizeof</span><span class="p">(</span><span class="n">q_params</span><span class="p">.</span><span class="n">params</span><span class="p">.</span><span class="n">cfc_del</span><span class="p">));</span>
	<span class="n">q_params</span><span class="p">.</span><span class="n">params</span><span class="p">.</span><span class="n">cfc_del</span><span class="p">.</span><span class="n">cid_index</span> <span class="o">=</span> <span class="n">FIRST_TX_COS_INDEX</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">bnx2x_queue_state_change</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">q_params</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_reset_func</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">port</span> <span class="o">=</span> <span class="n">BP_PORT</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">func</span> <span class="o">=</span> <span class="n">BP_FUNC</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* Disable the function in the FW */</span>
	<span class="n">REG_WR8</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">BAR_XSTRORM_INTMEM</span> <span class="o">+</span> <span class="n">XSTORM_FUNC_EN_OFFSET</span><span class="p">(</span><span class="n">func</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">REG_WR8</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">BAR_CSTRORM_INTMEM</span> <span class="o">+</span> <span class="n">CSTORM_FUNC_EN_OFFSET</span><span class="p">(</span><span class="n">func</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">REG_WR8</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">BAR_TSTRORM_INTMEM</span> <span class="o">+</span> <span class="n">TSTORM_FUNC_EN_OFFSET</span><span class="p">(</span><span class="n">func</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">REG_WR8</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">BAR_USTRORM_INTMEM</span> <span class="o">+</span> <span class="n">USTORM_FUNC_EN_OFFSET</span><span class="p">(</span><span class="n">func</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* FP SBs */</span>
	<span class="n">for_each_eth_queue</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">bnx2x_fastpath</span> <span class="o">*</span><span class="n">fp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">fp</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">REG_WR8</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">BAR_CSTRORM_INTMEM</span> <span class="o">+</span>
			   <span class="n">CSTORM_STATUS_BLOCK_DATA_STATE_OFFSET</span><span class="p">(</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">fw_sb_id</span><span class="p">),</span>
			   <span class="n">SB_DISABLED</span><span class="p">);</span>
	<span class="p">}</span>

<span class="cp">#ifdef BCM_CNIC</span>
	<span class="cm">/* CNIC SB */</span>
	<span class="n">REG_WR8</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">BAR_CSTRORM_INTMEM</span> <span class="o">+</span>
		<span class="n">CSTORM_STATUS_BLOCK_DATA_STATE_OFFSET</span><span class="p">(</span><span class="n">bnx2x_cnic_fw_sb_id</span><span class="p">(</span><span class="n">bp</span><span class="p">)),</span>
		<span class="n">SB_DISABLED</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="cm">/* SP SB */</span>
	<span class="n">REG_WR8</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">BAR_CSTRORM_INTMEM</span> <span class="o">+</span>
		   <span class="n">CSTORM_SP_STATUS_BLOCK_DATA_STATE_OFFSET</span><span class="p">(</span><span class="n">func</span><span class="p">),</span>
		   <span class="n">SB_DISABLED</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">XSTORM_SPQ_DATA_SIZE</span> <span class="o">/</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">BAR_XSTRORM_INTMEM</span> <span class="o">+</span> <span class="n">XSTORM_SPQ_DATA_OFFSET</span><span class="p">(</span><span class="n">func</span><span class="p">),</span>
		       <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* Configure IGU */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">.</span><span class="n">int_block</span> <span class="o">==</span> <span class="n">INT_BLOCK_HC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">HC_REG_LEADING_EDGE_0</span> <span class="o">+</span> <span class="n">port</span><span class="o">*</span><span class="mi">8</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">HC_REG_TRAILING_EDGE_0</span> <span class="o">+</span> <span class="n">port</span><span class="o">*</span><span class="mi">8</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">IGU_REG_LEADING_EDGE_LATCH</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">IGU_REG_TRAILING_EDGE_LATCH</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

<span class="cp">#ifdef BCM_CNIC</span>
	<span class="cm">/* Disable Timer scan */</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">TM_REG_EN_LINEAR0_TIMER</span> <span class="o">+</span> <span class="n">port</span><span class="o">*</span><span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * Wait for at least 10ms and up to 2 second for the timers scan to</span>
<span class="cm">	 * complete</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">200</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">TM_REG_LIN0_SCAN_ON</span> <span class="o">+</span> <span class="n">port</span><span class="o">*</span><span class="mi">4</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="cm">/* Clear ILT */</span>
	<span class="n">bnx2x_clear_func_ilt</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">func</span><span class="p">);</span>

	<span class="cm">/* Timers workaround bug for E2: if this is vnic-3,</span>
<span class="cm">	 * we need to set the entire ilt range for this timers.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CHIP_IS_E1x</span><span class="p">(</span><span class="n">bp</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">BP_VN</span><span class="p">(</span><span class="n">bp</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ilt_client_info</span> <span class="n">ilt_cli</span><span class="p">;</span>
		<span class="cm">/* use dummy TM client */</span>
		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ilt_cli</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ilt_client_info</span><span class="p">));</span>
		<span class="n">ilt_cli</span><span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ilt_cli</span><span class="p">.</span><span class="n">end</span> <span class="o">=</span> <span class="n">ILT_NUM_PAGE_ENTRIES</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">ilt_cli</span><span class="p">.</span><span class="n">client_num</span> <span class="o">=</span> <span class="n">ILT_CLIENT_TM</span><span class="p">;</span>

		<span class="n">bnx2x_ilt_boundry_init_op</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ilt_cli</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">INITOP_CLEAR</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* this assumes that reset_port() called before reset_func()*/</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CHIP_IS_E1x</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span>
		<span class="n">bnx2x_pf_disable</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>

	<span class="n">bp</span><span class="o">-&gt;</span><span class="n">dmae_ready</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_reset_port</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">port</span> <span class="o">=</span> <span class="n">BP_PORT</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>

	<span class="cm">/* Reset physical Link */</span>
	<span class="n">bnx2x__link_reset</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>

	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">NIG_REG_MASK_INTERRUPT_PORT0</span> <span class="o">+</span> <span class="n">port</span><span class="o">*</span><span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* Do not rcv packets to BRB */</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">NIG_REG_LLH0_BRB1_DRV_MASK</span> <span class="o">+</span> <span class="n">port</span><span class="o">*</span><span class="mi">4</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>
	<span class="cm">/* Do not direct rcv packets that are not for MCP to the BRB */</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="p">(</span><span class="n">port</span> <span class="o">?</span> <span class="n">NIG_REG_LLH1_BRB1_NOT_MCP</span> <span class="o">:</span>
			   <span class="n">NIG_REG_LLH0_BRB1_NOT_MCP</span><span class="p">),</span> <span class="mh">0x0</span><span class="p">);</span>

	<span class="cm">/* Configure AEU */</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">MISC_REG_AEU_MASK_ATTN_FUNC_0</span> <span class="o">+</span> <span class="n">port</span><span class="o">*</span><span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">msleep</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
	<span class="cm">/* Check for BRB port occupancy */</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">BRB1_REG_PORT_NUM_OCC_BLOCKS_0</span> <span class="o">+</span> <span class="n">port</span><span class="o">*</span><span class="mi">4</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span><span class="p">)</span>
		<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_IFDOWN</span><span class="p">,</span>
		   <span class="s">&quot;BRB1 is not empty  %d blocks are occupied</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

	<span class="cm">/* TODO: Close Doorbell port? */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bnx2x_reset_hw</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">,</span> <span class="n">u32</span> <span class="n">load_code</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2x_func_state_params</span> <span class="n">func_params</span> <span class="o">=</span> <span class="p">{</span><span class="nb">NULL</span><span class="p">};</span>

	<span class="cm">/* Prepare parameters for function state transitions */</span>
	<span class="n">__set_bit</span><span class="p">(</span><span class="n">RAMROD_COMP_WAIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">func_params</span><span class="p">.</span><span class="n">ramrod_flags</span><span class="p">);</span>

	<span class="n">func_params</span><span class="p">.</span><span class="n">f_obj</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">func_obj</span><span class="p">;</span>
	<span class="n">func_params</span><span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">BNX2X_F_CMD_HW_RESET</span><span class="p">;</span>

	<span class="n">func_params</span><span class="p">.</span><span class="n">params</span><span class="p">.</span><span class="n">hw_init</span><span class="p">.</span><span class="n">load_phase</span> <span class="o">=</span> <span class="n">load_code</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">bnx2x_func_state_change</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">func_params</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bnx2x_func_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2x_func_state_params</span> <span class="n">func_params</span> <span class="o">=</span> <span class="p">{</span><span class="nb">NULL</span><span class="p">};</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="cm">/* Prepare parameters for function state transitions */</span>
	<span class="n">__set_bit</span><span class="p">(</span><span class="n">RAMROD_COMP_WAIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">func_params</span><span class="p">.</span><span class="n">ramrod_flags</span><span class="p">);</span>
	<span class="n">func_params</span><span class="p">.</span><span class="n">f_obj</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">func_obj</span><span class="p">;</span>
	<span class="n">func_params</span><span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">BNX2X_F_CMD_STOP</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Try to stop the function the &#39;good way&#39;. If fails (in case</span>
<span class="cm">	 * of a parity error during bnx2x_chip_cleanup()) and we are</span>
<span class="cm">	 * not in a debug mode, perform a state transaction in order to</span>
<span class="cm">	 * enable further HW_RESET transaction.</span>
<span class="cm">	 */</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">bnx2x_func_state_change</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">func_params</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifdef BNX2X_STOP_ON_ERROR</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="cp">#else</span>
		<span class="n">BNX2X_ERR</span><span class="p">(</span><span class="s">&quot;FUNC_STOP ramrod failed. Running a dry transaction</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">__set_bit</span><span class="p">(</span><span class="n">RAMROD_DRV_CLR_ONLY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">func_params</span><span class="p">.</span><span class="n">ramrod_flags</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">bnx2x_func_state_change</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">func_params</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * bnx2x_send_unload_req - request unload mode from the MCP.</span>
<span class="cm"> *</span>
<span class="cm"> * @bp:			driver handle</span>
<span class="cm"> * @unload_mode:	requested function&#39;s unload mode</span>
<span class="cm"> *</span>
<span class="cm"> * Return unload mode returned by the MCP: COMMON, PORT or FUNC.</span>
<span class="cm"> */</span>
<span class="n">u32</span> <span class="nf">bnx2x_send_unload_req</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">unload_mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">reset_code</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">port</span> <span class="o">=</span> <span class="n">BP_PORT</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>

	<span class="cm">/* Select the UNLOAD request mode */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unload_mode</span> <span class="o">==</span> <span class="n">UNLOAD_NORMAL</span><span class="p">)</span>
		<span class="n">reset_code</span> <span class="o">=</span> <span class="n">DRV_MSG_CODE_UNLOAD_REQ_WOL_DIS</span><span class="p">;</span>

	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">NO_WOL_FLAG</span><span class="p">)</span>
		<span class="n">reset_code</span> <span class="o">=</span> <span class="n">DRV_MSG_CODE_UNLOAD_REQ_WOL_MCP</span><span class="p">;</span>

	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">wol</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">emac_base</span> <span class="o">=</span> <span class="n">port</span> <span class="o">?</span> <span class="n">GRCBASE_EMAC1</span> <span class="o">:</span> <span class="n">GRCBASE_EMAC0</span><span class="p">;</span>
		<span class="n">u8</span> <span class="o">*</span><span class="n">mac_addr</span> <span class="o">=</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>
		<span class="n">u16</span> <span class="n">pmc</span><span class="p">;</span>

		<span class="cm">/* The mac address is written to entries 1-4 to</span>
<span class="cm">		 * preserve entry 0 which is used by the PMF</span>
<span class="cm">		 */</span>
		<span class="n">u8</span> <span class="n">entry</span> <span class="o">=</span> <span class="p">(</span><span class="n">BP_VN</span><span class="p">(</span><span class="n">bp</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mi">8</span><span class="p">;</span>

		<span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">mac_addr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">mac_addr</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
		<span class="n">EMAC_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">EMAC_REG_EMAC_MAC_MATCH</span> <span class="o">+</span> <span class="n">entry</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

		<span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">mac_addr</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">mac_addr</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span>
		      <span class="p">(</span><span class="n">mac_addr</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">mac_addr</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
		<span class="n">EMAC_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">EMAC_REG_EMAC_MAC_MATCH</span> <span class="o">+</span> <span class="n">entry</span> <span class="o">+</span> <span class="mi">4</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

		<span class="cm">/* Enable the PME and clear the status */</span>
		<span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">pm_cap</span> <span class="o">+</span> <span class="n">PCI_PM_CTRL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pmc</span><span class="p">);</span>
		<span class="n">pmc</span> <span class="o">|=</span> <span class="n">PCI_PM_CTRL_PME_ENABLE</span> <span class="o">|</span> <span class="n">PCI_PM_CTRL_PME_STATUS</span><span class="p">;</span>
		<span class="n">pci_write_config_word</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">pm_cap</span> <span class="o">+</span> <span class="n">PCI_PM_CTRL</span><span class="p">,</span> <span class="n">pmc</span><span class="p">);</span>

		<span class="n">reset_code</span> <span class="o">=</span> <span class="n">DRV_MSG_CODE_UNLOAD_REQ_WOL_EN</span><span class="p">;</span>

	<span class="p">}</span> <span class="k">else</span>
		<span class="n">reset_code</span> <span class="o">=</span> <span class="n">DRV_MSG_CODE_UNLOAD_REQ_WOL_DIS</span><span class="p">;</span>

	<span class="cm">/* Send the request to the MCP */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">BP_NOMCP</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span>
		<span class="n">reset_code</span> <span class="o">=</span> <span class="n">bnx2x_fw_command</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">reset_code</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">path</span> <span class="o">=</span> <span class="n">BP_PATH</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>

		<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_IFDOWN</span><span class="p">,</span> <span class="s">&quot;NO MCP - load counts[%d]      %d, %d, %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">path</span><span class="p">,</span> <span class="n">load_count</span><span class="p">[</span><span class="n">path</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">load_count</span><span class="p">[</span><span class="n">path</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span>
		   <span class="n">load_count</span><span class="p">[</span><span class="n">path</span><span class="p">][</span><span class="mi">2</span><span class="p">]);</span>
		<span class="n">load_count</span><span class="p">[</span><span class="n">path</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">--</span><span class="p">;</span>
		<span class="n">load_count</span><span class="p">[</span><span class="n">path</span><span class="p">][</span><span class="mi">1</span> <span class="o">+</span> <span class="n">port</span><span class="p">]</span><span class="o">--</span><span class="p">;</span>
		<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_IFDOWN</span><span class="p">,</span> <span class="s">&quot;NO MCP - new load counts[%d]  %d, %d, %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">path</span><span class="p">,</span> <span class="n">load_count</span><span class="p">[</span><span class="n">path</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">load_count</span><span class="p">[</span><span class="n">path</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span>
		   <span class="n">load_count</span><span class="p">[</span><span class="n">path</span><span class="p">][</span><span class="mi">2</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">load_count</span><span class="p">[</span><span class="n">path</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">reset_code</span> <span class="o">=</span> <span class="n">FW_MSG_CODE_DRV_UNLOAD_COMMON</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">load_count</span><span class="p">[</span><span class="n">path</span><span class="p">][</span><span class="mi">1</span> <span class="o">+</span> <span class="n">port</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">reset_code</span> <span class="o">=</span> <span class="n">FW_MSG_CODE_DRV_UNLOAD_PORT</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">reset_code</span> <span class="o">=</span> <span class="n">FW_MSG_CODE_DRV_UNLOAD_FUNCTION</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">reset_code</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * bnx2x_send_unload_done - send UNLOAD_DONE command to the MCP.</span>
<span class="cm"> *</span>
<span class="cm"> * @bp:		driver handle</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">bnx2x_send_unload_done</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Report UNLOAD_DONE to MCP */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">BP_NOMCP</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span>
		<span class="n">bnx2x_fw_command</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">DRV_MSG_CODE_UNLOAD_DONE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bnx2x_func_wait_started</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">tout</span> <span class="o">=</span> <span class="mi">50</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">msix</span> <span class="o">=</span> <span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">USING_MSIX_FLAG</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">pmf</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * (assumption: No Attention from MCP at this stage)</span>
<span class="cm">	 * PMF probably in the middle of TXdisable/enable transaction</span>
<span class="cm">	 * 1. Sync IRS for default SB</span>
<span class="cm">	 * 2. Sync SP queue - this guarantes us that attention handling started</span>
<span class="cm">	 * 3. Wait, that TXdisable/enable transaction completes</span>
<span class="cm">	 *</span>
<span class="cm">	 * 1+2 guranty that if DCBx attention was scheduled it already changed</span>
<span class="cm">	 * pending bit of transaction from STARTED--&gt;TX_STOPPED, if we alredy</span>
<span class="cm">	 * received complettion for the transaction the state is TX_STOPPED.</span>
<span class="cm">	 * State will return to STARTED after completion of TX_STOPPED--&gt;STARTED</span>
<span class="cm">	 * transaction.</span>
<span class="cm">	 */</span>

	<span class="cm">/* make sure default SB ISR is done */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">msix</span><span class="p">)</span>
		<span class="n">synchronize_irq</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">msix_table</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">vector</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">synchronize_irq</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>

	<span class="n">flush_workqueue</span><span class="p">(</span><span class="n">bnx2x_wq</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">bnx2x_func_get_state</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">func_obj</span><span class="p">)</span> <span class="o">!=</span>
				<span class="n">BNX2X_F_STATE_STARTED</span> <span class="o">&amp;&amp;</span> <span class="n">tout</span><span class="o">--</span><span class="p">)</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bnx2x_func_get_state</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">func_obj</span><span class="p">)</span> <span class="o">!=</span>
						<span class="n">BNX2X_F_STATE_STARTED</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifdef BNX2X_STOP_ON_ERROR</span>
		<span class="n">BNX2X_ERR</span><span class="p">(</span><span class="s">&quot;Wrong function state</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
<span class="cp">#else</span>
		<span class="cm">/*</span>
<span class="cm">		 * Failed to complete the transaction in a &quot;good way&quot;</span>
<span class="cm">		 * Force both transactions with CLR bit</span>
<span class="cm">		 */</span>
		<span class="k">struct</span> <span class="n">bnx2x_func_state_params</span> <span class="n">func_params</span> <span class="o">=</span> <span class="p">{</span><span class="nb">NULL</span><span class="p">};</span>

		<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_IFDOWN</span><span class="p">,</span>
		   <span class="s">&quot;Hmmm... unexpected function state! Forcing STARTED--&gt;TX_ST0PPED--&gt;STARTED</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="n">func_params</span><span class="p">.</span><span class="n">f_obj</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">func_obj</span><span class="p">;</span>
		<span class="n">__set_bit</span><span class="p">(</span><span class="n">RAMROD_DRV_CLR_ONLY</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">func_params</span><span class="p">.</span><span class="n">ramrod_flags</span><span class="p">);</span>

		<span class="cm">/* STARTED--&gt;TX_ST0PPED */</span>
		<span class="n">func_params</span><span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">BNX2X_F_CMD_TX_STOP</span><span class="p">;</span>
		<span class="n">bnx2x_func_state_change</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">func_params</span><span class="p">);</span>

		<span class="cm">/* TX_ST0PPED--&gt;STARTED */</span>
		<span class="n">func_params</span><span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">BNX2X_F_CMD_TX_START</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">bnx2x_func_state_change</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">func_params</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">bnx2x_chip_cleanup</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">unload_mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">port</span> <span class="o">=</span> <span class="n">BP_PORT</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">cos</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bnx2x_mcast_ramrod_params</span> <span class="n">rparam</span> <span class="o">=</span> <span class="p">{</span><span class="nb">NULL</span><span class="p">};</span>
	<span class="n">u32</span> <span class="n">reset_code</span><span class="p">;</span>

	<span class="cm">/* Wait until tx fastpath tasks complete */</span>
	<span class="n">for_each_tx_queue</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">bnx2x_fastpath</span> <span class="o">*</span><span class="n">fp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">fp</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="n">for_each_cos_in_tx_queue</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">cos</span><span class="p">)</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">bnx2x_clean_tx_queue</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">txdata</span><span class="p">[</span><span class="n">cos</span><span class="p">]);</span>
<span class="cp">#ifdef BNX2X_STOP_ON_ERROR</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="p">}</span>

	<span class="cm">/* Give HW time to discard old tx messages */</span>
	<span class="n">usleep_range</span><span class="p">(</span><span class="mi">1000</span><span class="p">,</span> <span class="mi">1000</span><span class="p">);</span>

	<span class="cm">/* Clean all ETH MACs */</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">bnx2x_del_all_macs</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">fp</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">mac_obj</span><span class="p">,</span> <span class="n">BNX2X_ETH_MAC</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">BNX2X_ERR</span><span class="p">(</span><span class="s">&quot;Failed to delete all ETH macs: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>

	<span class="cm">/* Clean up UC list  */</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">bnx2x_del_all_macs</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">fp</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">mac_obj</span><span class="p">,</span> <span class="n">BNX2X_UC_LIST_MAC</span><span class="p">,</span>
				<span class="nb">true</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">BNX2X_ERR</span><span class="p">(</span><span class="s">&quot;Failed to schedule DEL commands for UC MACs list: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">rc</span><span class="p">);</span>

	<span class="cm">/* Disable LLH */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CHIP_IS_E1</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span>
		<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">NIG_REG_LLH0_FUNC_EN</span> <span class="o">+</span> <span class="n">port</span><span class="o">*</span><span class="mi">8</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* Set &quot;drop all&quot; (stop Rx).</span>
<span class="cm">	 * We need to take a netif_addr_lock() here in order to prevent</span>
<span class="cm">	 * a race between the completion code and this code.</span>
<span class="cm">	 */</span>
	<span class="n">netif_addr_lock_bh</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="cm">/* Schedule the rx_mode command */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">BNX2X_FILTER_RX_MODE_PENDING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">sp_state</span><span class="p">))</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">BNX2X_FILTER_RX_MODE_SCHED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">sp_state</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">bnx2x_set_storm_rx_mode</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>

	<span class="cm">/* Cleanup multicast configuration */</span>
	<span class="n">rparam</span><span class="p">.</span><span class="n">mcast_obj</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">mcast_obj</span><span class="p">;</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">bnx2x_config_mcast</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rparam</span><span class="p">,</span> <span class="n">BNX2X_MCAST_CMD_DEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">BNX2X_ERR</span><span class="p">(</span><span class="s">&quot;Failed to send DEL multicast command: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>

	<span class="n">netif_addr_unlock_bh</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>



	<span class="cm">/*</span>
<span class="cm">	 * Send the UNLOAD_REQUEST to the MCP. This will return if</span>
<span class="cm">	 * this function should perform FUNC, PORT or COMMON HW</span>
<span class="cm">	 * reset.</span>
<span class="cm">	 */</span>
	<span class="n">reset_code</span> <span class="o">=</span> <span class="n">bnx2x_send_unload_req</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">unload_mode</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * (assumption: No Attention from MCP at this stage)</span>
<span class="cm">	 * PMF probably in the middle of TXdisable/enable transaction</span>
<span class="cm">	 */</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">bnx2x_func_wait_started</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BNX2X_ERR</span><span class="p">(</span><span class="s">&quot;bnx2x_func_wait_started failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#ifdef BNX2X_STOP_ON_ERROR</span>
		<span class="k">return</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="p">}</span>

	<span class="cm">/* Close multi and leading connections</span>
<span class="cm">	 * Completions for ramrods are collected in a synchronous way</span>
<span class="cm">	 */</span>
	<span class="n">for_each_queue</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bnx2x_stop_queue</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">i</span><span class="p">))</span>
<span class="cp">#ifdef BNX2X_STOP_ON_ERROR</span>
			<span class="k">return</span><span class="p">;</span>
<span class="cp">#else</span>
			<span class="k">goto</span> <span class="n">unload_error</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="cm">/* If SP settings didn&#39;t get completed so far - something</span>
<span class="cm">	 * very wrong has happen.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bnx2x_wait_sp_comp</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="o">~</span><span class="mh">0x0UL</span><span class="p">))</span>
		<span class="n">BNX2X_ERR</span><span class="p">(</span><span class="s">&quot;Hmmm... Common slow path ramrods got stuck!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

<span class="cp">#ifndef BNX2X_STOP_ON_ERROR</span>
<span class="nl">unload_error:</span>
<span class="cp">#endif</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">bnx2x_func_stop</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BNX2X_ERR</span><span class="p">(</span><span class="s">&quot;Function stop failed!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#ifdef BNX2X_STOP_ON_ERROR</span>
		<span class="k">return</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="p">}</span>

	<span class="cm">/* Disable HW interrupts, NAPI */</span>
	<span class="n">bnx2x_netif_stop</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* Release IRQs */</span>
	<span class="n">bnx2x_free_irq</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>

	<span class="cm">/* Reset the chip */</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">bnx2x_reset_hw</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">reset_code</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="n">BNX2X_ERR</span><span class="p">(</span><span class="s">&quot;HW_RESET failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>


	<span class="cm">/* Report UNLOAD_DONE to MCP */</span>
	<span class="n">bnx2x_send_unload_done</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">bnx2x_disable_close_the_gate</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_IFDOWN</span><span class="p">,</span> <span class="s">&quot;Disabling </span><span class="se">\&quot;</span><span class="s">close the gates</span><span class="se">\&quot;\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">CHIP_IS_E1</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">port</span> <span class="o">=</span> <span class="n">BP_PORT</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
		<span class="n">u32</span> <span class="n">addr</span> <span class="o">=</span> <span class="n">port</span> <span class="o">?</span> <span class="n">MISC_REG_AEU_MASK_ATTN_FUNC_1</span> <span class="o">:</span>
			<span class="n">MISC_REG_AEU_MASK_ATTN_FUNC_0</span><span class="p">;</span>

		<span class="n">val</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
		<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mh">0x300</span><span class="p">);</span>
		<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">MISC_REG_AEU_GENERAL_MASK</span><span class="p">);</span>
		<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">MISC_AEU_GENERAL_MASK_REG_AEU_PXP_CLOSE_MASK</span> <span class="o">|</span>
			 <span class="n">MISC_AEU_GENERAL_MASK_REG_AEU_NIG_CLOSE_MASK</span><span class="p">);</span>
		<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">MISC_REG_AEU_GENERAL_MASK</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* Close gates #2, #3 and #4: */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_set_234_gates</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">,</span> <span class="n">bool</span> <span class="n">close</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>

	<span class="cm">/* Gates #2 and #4a are closed/opened for &quot;not E1&quot; only */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CHIP_IS_E1</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* #4 */</span>
		<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">PXP_REG_HST_DISCARD_DOORBELLS</span><span class="p">,</span> <span class="o">!!</span><span class="n">close</span><span class="p">);</span>
		<span class="cm">/* #2 */</span>
		<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">PXP_REG_HST_DISCARD_INTERNAL_WRITES</span><span class="p">,</span> <span class="o">!!</span><span class="n">close</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* #3 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">CHIP_IS_E1x</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Prevent interrupts from HC on both ports */</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">HC_REG_CONFIG_1</span><span class="p">);</span>
		<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">HC_REG_CONFIG_1</span><span class="p">,</span>
		       <span class="p">(</span><span class="o">!</span><span class="n">close</span><span class="p">)</span> <span class="o">?</span> <span class="p">(</span><span class="n">val</span> <span class="o">|</span> <span class="n">HC_CONFIG_1_REG_BLOCK_DISABLE_1</span><span class="p">)</span> <span class="o">:</span>
		       <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">HC_CONFIG_1_REG_BLOCK_DISABLE_1</span><span class="p">));</span>

		<span class="n">val</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">HC_REG_CONFIG_0</span><span class="p">);</span>
		<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">HC_REG_CONFIG_0</span><span class="p">,</span>
		       <span class="p">(</span><span class="o">!</span><span class="n">close</span><span class="p">)</span> <span class="o">?</span> <span class="p">(</span><span class="n">val</span> <span class="o">|</span> <span class="n">HC_CONFIG_0_REG_BLOCK_DISABLE_0</span><span class="p">)</span> <span class="o">:</span>
		       <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">HC_CONFIG_0_REG_BLOCK_DISABLE_0</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Prevent incomming interrupts in IGU */</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">IGU_REG_BLOCK_CONFIGURATION</span><span class="p">);</span>

		<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">IGU_REG_BLOCK_CONFIGURATION</span><span class="p">,</span>
		       <span class="p">(</span><span class="o">!</span><span class="n">close</span><span class="p">)</span> <span class="o">?</span>
		       <span class="p">(</span><span class="n">val</span> <span class="o">|</span> <span class="n">IGU_BLOCK_CONFIGURATION_REG_BLOCK_ENABLE</span><span class="p">)</span> <span class="o">:</span>
		       <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">IGU_BLOCK_CONFIGURATION_REG_BLOCK_ENABLE</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_HW</span> <span class="o">|</span> <span class="n">NETIF_MSG_IFUP</span><span class="p">,</span> <span class="s">&quot;%s gates #2, #3 and #4</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">close</span> <span class="o">?</span> <span class="s">&quot;closing&quot;</span> <span class="o">:</span> <span class="s">&quot;opening&quot;</span><span class="p">);</span>
	<span class="n">mmiowb</span><span class="p">();</span>
<span class="p">}</span>

<span class="cp">#define SHARED_MF_CLP_MAGIC  0x80000000 </span><span class="cm">/* `magic&#39; bit */</span><span class="cp"></span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_clp_reset_prep</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">magic_val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Do some magic... */</span>
	<span class="n">u32</span> <span class="n">val</span> <span class="o">=</span> <span class="n">MF_CFG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">shared_mf_config</span><span class="p">.</span><span class="n">clp_mb</span><span class="p">);</span>
	<span class="o">*</span><span class="n">magic_val</span> <span class="o">=</span> <span class="n">val</span> <span class="o">&amp;</span> <span class="n">SHARED_MF_CLP_MAGIC</span><span class="p">;</span>
	<span class="n">MF_CFG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">shared_mf_config</span><span class="p">.</span><span class="n">clp_mb</span><span class="p">,</span> <span class="n">val</span> <span class="o">|</span> <span class="n">SHARED_MF_CLP_MAGIC</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * bnx2x_clp_reset_done - restore the value of the `magic&#39; bit.</span>
<span class="cm"> *</span>
<span class="cm"> * @bp:		driver handle</span>
<span class="cm"> * @magic_val:	old value of the `magic&#39; bit.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_clp_reset_done</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">,</span> <span class="n">u32</span> <span class="n">magic_val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Restore the `magic&#39; bit value... */</span>
	<span class="n">u32</span> <span class="n">val</span> <span class="o">=</span> <span class="n">MF_CFG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">shared_mf_config</span><span class="p">.</span><span class="n">clp_mb</span><span class="p">);</span>
	<span class="n">MF_CFG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">shared_mf_config</span><span class="p">.</span><span class="n">clp_mb</span><span class="p">,</span>
		<span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="n">SHARED_MF_CLP_MAGIC</span><span class="p">))</span> <span class="o">|</span> <span class="n">magic_val</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * bnx2x_reset_mcp_prep - prepare for MCP reset.</span>
<span class="cm"> *</span>
<span class="cm"> * @bp:		driver handle</span>
<span class="cm"> * @magic_val:	old value of &#39;magic&#39; bit.</span>
<span class="cm"> *</span>
<span class="cm"> * Takes care of CLP configurations.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_reset_mcp_prep</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">magic_val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">shmem</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">validity_offset</span><span class="p">;</span>

	<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_HW</span> <span class="o">|</span> <span class="n">NETIF_MSG_IFUP</span><span class="p">,</span> <span class="s">&quot;Starting</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* Set `magic&#39; bit in order to save MF config */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CHIP_IS_E1</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span>
		<span class="n">bnx2x_clp_reset_prep</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">magic_val</span><span class="p">);</span>

	<span class="cm">/* Get shmem offset */</span>
	<span class="n">shmem</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">MISC_REG_SHARED_MEM_ADDR</span><span class="p">);</span>
	<span class="n">validity_offset</span> <span class="o">=</span> <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">shmem_region</span><span class="p">,</span> <span class="n">validity_map</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>

	<span class="cm">/* Clear validity map flags */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">shmem</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">shmem</span> <span class="o">+</span> <span class="n">validity_offset</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#define MCP_TIMEOUT      5000   </span><span class="cm">/* 5 seconds (in ms) */</span><span class="cp"></span>
<span class="cp">#define MCP_ONE_TIMEOUT  100    </span><span class="cm">/* 100 ms */</span><span class="cp"></span>

<span class="cm">/**</span>
<span class="cm"> * bnx2x_mcp_wait_one - wait for MCP_ONE_TIMEOUT</span>
<span class="cm"> *</span>
<span class="cm"> * @bp:	driver handle</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_mcp_wait_one</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* special handling for emulation and FPGA,</span>
<span class="cm">	   wait 10 times longer */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">CHIP_REV_IS_SLOW</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span>
		<span class="n">msleep</span><span class="p">(</span><span class="n">MCP_ONE_TIMEOUT</span><span class="o">*</span><span class="mi">10</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">msleep</span><span class="p">(</span><span class="n">MCP_ONE_TIMEOUT</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * initializes bp-&gt;common.shmem_base and waits for validity signature to appear</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">bnx2x_init_shmem</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">bp</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">.</span><span class="n">shmem_base</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">MISC_REG_SHARED_MEM_ADDR</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">.</span><span class="n">shmem_base</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">val</span> <span class="o">=</span> <span class="n">SHMEM_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">validity_map</span><span class="p">[</span><span class="n">BP_PORT</span><span class="p">(</span><span class="n">bp</span><span class="p">)]);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">SHR_MEM_VALIDITY_MB</span><span class="p">)</span>
				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">bnx2x_mcp_wait_one</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>

	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">cnt</span><span class="o">++</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">MCP_TIMEOUT</span> <span class="o">/</span> <span class="n">MCP_ONE_TIMEOUT</span><span class="p">));</span>

	<span class="n">BNX2X_ERR</span><span class="p">(</span><span class="s">&quot;BAD MCP validity signature</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bnx2x_reset_mcp_comp</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">,</span> <span class="n">u32</span> <span class="n">magic_val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="n">bnx2x_init_shmem</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>

	<span class="cm">/* Restore the `magic&#39; bit value */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CHIP_IS_E1</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span>
		<span class="n">bnx2x_clp_reset_done</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">magic_val</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_pxp_prep</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CHIP_IS_E1</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">PXP2_REG_RD_START_INIT</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">PXP2_REG_RQ_RBC_DONE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">mmiowb</span><span class="p">();</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Reset the whole chip except for:</span>
<span class="cm"> *      - PCIE core</span>
<span class="cm"> *      - PCI Glue, PSWHST, PXP/PXP2 RF (all controlled by</span>
<span class="cm"> *              one reset bit)</span>
<span class="cm"> *      - IGU</span>
<span class="cm"> *      - MISC (including AEU)</span>
<span class="cm"> *      - GRC</span>
<span class="cm"> *      - RBCN, RBCP</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_process_kill_chip_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">,</span> <span class="n">bool</span> <span class="n">global</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">not_reset_mask1</span><span class="p">,</span> <span class="n">reset_mask1</span><span class="p">,</span> <span class="n">not_reset_mask2</span><span class="p">,</span> <span class="n">reset_mask2</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">global_bits2</span><span class="p">,</span> <span class="n">stay_reset2</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Bits that have to be set in reset_mask2 if we want to reset &#39;global&#39;</span>
<span class="cm">	 * (per chip) blocks.</span>
<span class="cm">	 */</span>
	<span class="n">global_bits2</span> <span class="o">=</span>
		<span class="n">MISC_REGISTERS_RESET_REG_2_RST_MCP_N_RESET_CMN_CPU</span> <span class="o">|</span>
		<span class="n">MISC_REGISTERS_RESET_REG_2_RST_MCP_N_RESET_CMN_CORE</span><span class="p">;</span>

	<span class="cm">/* Don&#39;t reset the following blocks */</span>
	<span class="n">not_reset_mask1</span> <span class="o">=</span>
		<span class="n">MISC_REGISTERS_RESET_REG_1_RST_HC</span> <span class="o">|</span>
		<span class="n">MISC_REGISTERS_RESET_REG_1_RST_PXPV</span> <span class="o">|</span>
		<span class="n">MISC_REGISTERS_RESET_REG_1_RST_PXP</span><span class="p">;</span>

	<span class="n">not_reset_mask2</span> <span class="o">=</span>
		<span class="n">MISC_REGISTERS_RESET_REG_2_RST_PCI_MDIO</span> <span class="o">|</span>
		<span class="n">MISC_REGISTERS_RESET_REG_2_RST_EMAC0_HARD_CORE</span> <span class="o">|</span>
		<span class="n">MISC_REGISTERS_RESET_REG_2_RST_EMAC1_HARD_CORE</span> <span class="o">|</span>
		<span class="n">MISC_REGISTERS_RESET_REG_2_RST_MISC_CORE</span> <span class="o">|</span>
		<span class="n">MISC_REGISTERS_RESET_REG_2_RST_RBCN</span> <span class="o">|</span>
		<span class="n">MISC_REGISTERS_RESET_REG_2_RST_GRC</span>  <span class="o">|</span>
		<span class="n">MISC_REGISTERS_RESET_REG_2_RST_MCP_N_RESET_REG_HARD_CORE</span> <span class="o">|</span>
		<span class="n">MISC_REGISTERS_RESET_REG_2_RST_MCP_N_HARD_CORE_RST_B</span> <span class="o">|</span>
		<span class="n">MISC_REGISTERS_RESET_REG_2_RST_ATC</span> <span class="o">|</span>
		<span class="n">MISC_REGISTERS_RESET_REG_2_PGLC</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Keep the following blocks in reset:</span>
<span class="cm">	 *  - all xxMACs are handled by the bnx2x_link code.</span>
<span class="cm">	 */</span>
	<span class="n">stay_reset2</span> <span class="o">=</span>
		<span class="n">MISC_REGISTERS_RESET_REG_2_RST_BMAC0</span> <span class="o">|</span>
		<span class="n">MISC_REGISTERS_RESET_REG_2_RST_BMAC1</span> <span class="o">|</span>
		<span class="n">MISC_REGISTERS_RESET_REG_2_RST_EMAC0</span> <span class="o">|</span>
		<span class="n">MISC_REGISTERS_RESET_REG_2_RST_EMAC1</span> <span class="o">|</span>
		<span class="n">MISC_REGISTERS_RESET_REG_2_UMAC0</span> <span class="o">|</span>
		<span class="n">MISC_REGISTERS_RESET_REG_2_UMAC1</span> <span class="o">|</span>
		<span class="n">MISC_REGISTERS_RESET_REG_2_XMAC</span> <span class="o">|</span>
		<span class="n">MISC_REGISTERS_RESET_REG_2_XMAC_SOFT</span><span class="p">;</span>

	<span class="cm">/* Full reset masks according to the chip */</span>
	<span class="n">reset_mask1</span> <span class="o">=</span> <span class="mh">0xffffffff</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">CHIP_IS_E1</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span>
		<span class="n">reset_mask2</span> <span class="o">=</span> <span class="mh">0xffff</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">CHIP_IS_E1H</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span>
		<span class="n">reset_mask2</span> <span class="o">=</span> <span class="mh">0x1ffff</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">CHIP_IS_E2</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span>
		<span class="n">reset_mask2</span> <span class="o">=</span> <span class="mh">0xfffff</span><span class="p">;</span>
	<span class="k">else</span> <span class="cm">/* CHIP_IS_E3 */</span>
		<span class="n">reset_mask2</span> <span class="o">=</span> <span class="mh">0x3ffffff</span><span class="p">;</span>

	<span class="cm">/* Don&#39;t reset global blocks unless we need to */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">global</span><span class="p">)</span>
		<span class="n">reset_mask2</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">global_bits2</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * In case of attention in the QM, we need to reset PXP</span>
<span class="cm">	 * (MISC_REGISTERS_RESET_REG_2_RST_PXP_RQ_RD_WR) before QM</span>
<span class="cm">	 * because otherwise QM reset would release &#39;close the gates&#39; shortly</span>
<span class="cm">	 * before resetting the PXP, then the PSWRQ would send a write</span>
<span class="cm">	 * request to PGLUE. Then when PXP is reset, PGLUE would try to</span>
<span class="cm">	 * read the payload data from PSWWR, but PSWWR would not</span>
<span class="cm">	 * respond. The write queue in PGLUE would stuck, dmae commands</span>
<span class="cm">	 * would not return. Therefore it&#39;s important to reset the second</span>
<span class="cm">	 * reset register (containing the</span>
<span class="cm">	 * MISC_REGISTERS_RESET_REG_2_RST_PXP_RQ_RD_WR bit) before the</span>
<span class="cm">	 * first one (containing the MISC_REGISTERS_RESET_REG_1_RST_QM</span>
<span class="cm">	 * bit).</span>
<span class="cm">	 */</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">GRCBASE_MISC</span> <span class="o">+</span> <span class="n">MISC_REGISTERS_RESET_REG_2_CLEAR</span><span class="p">,</span>
	       <span class="n">reset_mask2</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="n">not_reset_mask2</span><span class="p">));</span>

	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">GRCBASE_MISC</span> <span class="o">+</span> <span class="n">MISC_REGISTERS_RESET_REG_1_CLEAR</span><span class="p">,</span>
	       <span class="n">reset_mask1</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="n">not_reset_mask1</span><span class="p">));</span>

	<span class="n">barrier</span><span class="p">();</span>
	<span class="n">mmiowb</span><span class="p">();</span>

	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">GRCBASE_MISC</span> <span class="o">+</span> <span class="n">MISC_REGISTERS_RESET_REG_2_SET</span><span class="p">,</span>
	       <span class="n">reset_mask2</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="n">stay_reset2</span><span class="p">));</span>

	<span class="n">barrier</span><span class="p">();</span>
	<span class="n">mmiowb</span><span class="p">();</span>

	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">GRCBASE_MISC</span> <span class="o">+</span> <span class="n">MISC_REGISTERS_RESET_REG_1_SET</span><span class="p">,</span> <span class="n">reset_mask1</span><span class="p">);</span>
	<span class="n">mmiowb</span><span class="p">();</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * bnx2x_er_poll_igu_vq - poll for pending writes bit.</span>
<span class="cm"> * It should get cleared in no more than 1s.</span>
<span class="cm"> *</span>
<span class="cm"> * @bp:	driver handle</span>
<span class="cm"> *</span>
<span class="cm"> * It should get cleared in no more than 1s. Returns 0 if</span>
<span class="cm"> * pending writes bit gets cleared.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">bnx2x_er_poll_igu_vq</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">cnt</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">pend_bits</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">pend_bits</span>  <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">IGU_REG_PENDING_BITS_STATUS</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">pend_bits</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">usleep_range</span><span class="p">(</span><span class="mi">1000</span><span class="p">,</span> <span class="mi">1000</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">cnt</span><span class="o">--</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BNX2X_ERR</span><span class="p">(</span><span class="s">&quot;Still pending IGU requests pend_bits=%x!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">pend_bits</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bnx2x_process_kill</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">,</span> <span class="n">bool</span> <span class="n">global</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">cnt</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">sr_cnt</span><span class="p">,</span> <span class="n">blk_cnt</span><span class="p">,</span> <span class="n">port_is_idle_0</span><span class="p">,</span> <span class="n">port_is_idle_1</span><span class="p">,</span> <span class="n">pgl_exp_rom2</span><span class="p">;</span>


	<span class="cm">/* Empty the Tetris buffer, wait for 1s */</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">sr_cnt</span>  <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">PXP2_REG_RD_SR_CNT</span><span class="p">);</span>
		<span class="n">blk_cnt</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">PXP2_REG_RD_BLK_CNT</span><span class="p">);</span>
		<span class="n">port_is_idle_0</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">PXP2_REG_RD_PORT_IS_IDLE_0</span><span class="p">);</span>
		<span class="n">port_is_idle_1</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">PXP2_REG_RD_PORT_IS_IDLE_1</span><span class="p">);</span>
		<span class="n">pgl_exp_rom2</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">PXP2_REG_PGL_EXP_ROM2</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">sr_cnt</span> <span class="o">==</span> <span class="mh">0x7e</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">blk_cnt</span> <span class="o">==</span> <span class="mh">0xa0</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">((</span><span class="n">port_is_idle_0</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x1</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">((</span><span class="n">port_is_idle_1</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x1</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">pgl_exp_rom2</span> <span class="o">==</span> <span class="mh">0xffffffff</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">usleep_range</span><span class="p">(</span><span class="mi">1000</span><span class="p">,</span> <span class="mi">1000</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">cnt</span><span class="o">--</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BNX2X_ERR</span><span class="p">(</span><span class="s">&quot;Tetris buffer didn&#39;t get empty or there are still outstanding read requests after 1s!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">BNX2X_ERR</span><span class="p">(</span><span class="s">&quot;sr_cnt=0x%08x, blk_cnt=0x%08x, port_is_idle_0=0x%08x, port_is_idle_1=0x%08x, pgl_exp_rom2=0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">sr_cnt</span><span class="p">,</span> <span class="n">blk_cnt</span><span class="p">,</span> <span class="n">port_is_idle_0</span><span class="p">,</span> <span class="n">port_is_idle_1</span><span class="p">,</span>
			  <span class="n">pgl_exp_rom2</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">barrier</span><span class="p">();</span>

	<span class="cm">/* Close gates #2, #3 and #4 */</span>
	<span class="n">bnx2x_set_234_gates</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>

	<span class="cm">/* Poll for IGU VQs for 57712 and newer chips */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CHIP_IS_E1x</span><span class="p">(</span><span class="n">bp</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">bnx2x_er_poll_igu_vq</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>


	<span class="cm">/* TBD: Indicate that &quot;process kill&quot; is in progress to MCP */</span>

	<span class="cm">/* Clear &quot;unprepared&quot; bit */</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">MISC_REG_UNPREPARED</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">barrier</span><span class="p">();</span>

	<span class="cm">/* Make sure all is written to the chip before the reset */</span>
	<span class="n">mmiowb</span><span class="p">();</span>

	<span class="cm">/* Wait for 1ms to empty GLUE and PCI-E core queues,</span>
<span class="cm">	 * PSWHST, GRC and PSWRD Tetris buffer.</span>
<span class="cm">	 */</span>
	<span class="n">usleep_range</span><span class="p">(</span><span class="mi">1000</span><span class="p">,</span> <span class="mi">1000</span><span class="p">);</span>

	<span class="cm">/* Prepare to chip reset: */</span>
	<span class="cm">/* MCP */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">global</span><span class="p">)</span>
		<span class="n">bnx2x_reset_mcp_prep</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>

	<span class="cm">/* PXP */</span>
	<span class="n">bnx2x_pxp_prep</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
	<span class="n">barrier</span><span class="p">();</span>

	<span class="cm">/* reset the chip */</span>
	<span class="n">bnx2x_process_kill_chip_reset</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">global</span><span class="p">);</span>
	<span class="n">barrier</span><span class="p">();</span>

	<span class="cm">/* Recover after reset: */</span>
	<span class="cm">/* MCP */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">global</span> <span class="o">&amp;&amp;</span> <span class="n">bnx2x_reset_mcp_comp</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">val</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>

	<span class="cm">/* TBD: Add resetting the NO_MCP mode DB here */</span>

	<span class="cm">/* PXP */</span>
	<span class="n">bnx2x_pxp_prep</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>

	<span class="cm">/* Open the gates #2, #3 and #4 */</span>
	<span class="n">bnx2x_set_234_gates</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>

	<span class="cm">/* TBD: IGU/AEU preparation bring back the AEU/IGU to a</span>
<span class="cm">	 * reset state, re-enable attentions. */</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">bnx2x_leader_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">global</span> <span class="o">=</span> <span class="n">bnx2x_reset_is_global</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">load_code</span><span class="p">;</span>

	<span class="cm">/* if not going to reset MCP - load &quot;fake&quot; driver to reset HW while</span>
<span class="cm">	 * driver is owner of the HW</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">global</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">BP_NOMCP</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">load_code</span> <span class="o">=</span> <span class="n">bnx2x_fw_command</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">DRV_MSG_CODE_LOAD_REQ</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">load_code</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">BNX2X_ERR</span><span class="p">(</span><span class="s">&quot;MCP response failure, aborting</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">exit_leader_reset</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">load_code</span> <span class="o">!=</span> <span class="n">FW_MSG_CODE_DRV_LOAD_COMMON_CHIP</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">load_code</span> <span class="o">!=</span> <span class="n">FW_MSG_CODE_DRV_LOAD_COMMON</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">BNX2X_ERR</span><span class="p">(</span><span class="s">&quot;MCP unexpected resp, aborting</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">exit_leader_reset2</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">load_code</span> <span class="o">=</span> <span class="n">bnx2x_fw_command</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">DRV_MSG_CODE_LOAD_DONE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">load_code</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">BNX2X_ERR</span><span class="p">(</span><span class="s">&quot;MCP response failure, aborting</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">exit_leader_reset2</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Try to recover after the failure */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bnx2x_process_kill</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">global</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">BNX2X_ERR</span><span class="p">(</span><span class="s">&quot;Something bad had happen on engine %d! Aii!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">BP_PATH</span><span class="p">(</span><span class="n">bp</span><span class="p">));</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">exit_leader_reset2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Clear RESET_IN_PROGRES and RESET_GLOBAL bits and update the driver</span>
<span class="cm">	 * state.</span>
<span class="cm">	 */</span>
	<span class="n">bnx2x_set_reset_done</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">global</span><span class="p">)</span>
		<span class="n">bnx2x_clear_reset_global</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>

<span class="nl">exit_leader_reset2:</span>
	<span class="cm">/* unload &quot;fake driver&quot; if it was loaded */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">global</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">BP_NOMCP</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">bnx2x_fw_command</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">DRV_MSG_CODE_UNLOAD_REQ_WOL_MCP</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">bnx2x_fw_command</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">DRV_MSG_CODE_UNLOAD_DONE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
<span class="nl">exit_leader_reset:</span>
	<span class="n">bp</span><span class="o">-&gt;</span><span class="n">is_leader</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">bnx2x_release_leader_lock</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
	<span class="n">smp_mb</span><span class="p">();</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_recovery_failed</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">netdev_err</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Recovery has failed. Power cycle is needed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* Disconnect this device */</span>
	<span class="n">netif_device_detach</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Block ifup for all function on this engine until &quot;process kill&quot;</span>
<span class="cm">	 * or power cycle.</span>
<span class="cm">	 */</span>
	<span class="n">bnx2x_set_reset_in_progress</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>

	<span class="cm">/* Shut down the power */</span>
	<span class="n">bnx2x_set_power_state</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">PCI_D3hot</span><span class="p">);</span>

	<span class="n">bp</span><span class="o">-&gt;</span><span class="n">recovery_state</span> <span class="o">=</span> <span class="n">BNX2X_RECOVERY_FAILED</span><span class="p">;</span>

	<span class="n">smp_mb</span><span class="p">();</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Assumption: runs under rtnl lock. This together with the fact</span>
<span class="cm"> * that it&#39;s called only from bnx2x_sp_rtnl() ensure that it</span>
<span class="cm"> * will never be called when netif_running(bp-&gt;dev) is false.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_parity_recover</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bool</span> <span class="n">global</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">error_recovered</span><span class="p">,</span> <span class="n">error_unrecovered</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">is_parity</span><span class="p">;</span>

	<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_HW</span><span class="p">,</span> <span class="s">&quot;Handling parity</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">recovery_state</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">BNX2X_RECOVERY_INIT</span>:
			<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_HW</span><span class="p">,</span> <span class="s">&quot;State is BNX2X_RECOVERY_INIT</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">is_parity</span> <span class="o">=</span> <span class="n">bnx2x_chk_parity_attn</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">global</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
			<span class="n">WARN_ON</span><span class="p">(</span><span class="o">!</span><span class="n">is_parity</span><span class="p">);</span>

			<span class="cm">/* Try to get a LEADER_LOCK HW lock */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">bnx2x_trylock_leader_lock</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">bnx2x_set_reset_in_progress</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
				<span class="cm">/*</span>
<span class="cm">				 * Check if there is a global attention and if</span>
<span class="cm">				 * there was a global attention, set the global</span>
<span class="cm">				 * reset bit.</span>
<span class="cm">				 */</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">global</span><span class="p">)</span>
					<span class="n">bnx2x_set_reset_global</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>

				<span class="n">bp</span><span class="o">-&gt;</span><span class="n">is_leader</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="cm">/* Stop the driver */</span>
			<span class="cm">/* If interface has been removed - break */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">bnx2x_nic_unload</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">UNLOAD_RECOVERY</span><span class="p">))</span>
				<span class="k">return</span><span class="p">;</span>

			<span class="n">bp</span><span class="o">-&gt;</span><span class="n">recovery_state</span> <span class="o">=</span> <span class="n">BNX2X_RECOVERY_WAIT</span><span class="p">;</span>

			<span class="cm">/* Ensure &quot;is_leader&quot;, MCP command sequence and</span>
<span class="cm">			 * &quot;recovery_state&quot; update values are seen on other</span>
<span class="cm">			 * CPUs.</span>
<span class="cm">			 */</span>
			<span class="n">smp_mb</span><span class="p">();</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">BNX2X_RECOVERY_WAIT</span>:
			<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_HW</span><span class="p">,</span> <span class="s">&quot;State is BNX2X_RECOVERY_WAIT</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">is_leader</span><span class="p">)</span> <span class="p">{</span>
				<span class="kt">int</span> <span class="n">other_engine</span> <span class="o">=</span> <span class="n">BP_PATH</span><span class="p">(</span><span class="n">bp</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">bool</span> <span class="n">other_load_status</span> <span class="o">=</span>
					<span class="n">bnx2x_get_load_status</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">other_engine</span><span class="p">);</span>
				<span class="n">bool</span> <span class="n">load_status</span> <span class="o">=</span>
					<span class="n">bnx2x_get_load_status</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">BP_PATH</span><span class="p">(</span><span class="n">bp</span><span class="p">));</span>
				<span class="n">global</span> <span class="o">=</span> <span class="n">bnx2x_reset_is_global</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>

				<span class="cm">/*</span>
<span class="cm">				 * In case of a parity in a global block, let</span>
<span class="cm">				 * the first leader that performs a</span>
<span class="cm">				 * leader_reset() reset the global blocks in</span>
<span class="cm">				 * order to clear global attentions. Otherwise</span>
<span class="cm">				 * the the gates will remain closed for that</span>
<span class="cm">				 * engine.</span>
<span class="cm">				 */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">load_status</span> <span class="o">||</span>
				    <span class="p">(</span><span class="n">global</span> <span class="o">&amp;&amp;</span> <span class="n">other_load_status</span><span class="p">))</span> <span class="p">{</span>
					<span class="cm">/* Wait until all other functions get</span>
<span class="cm">					 * down.</span>
<span class="cm">					 */</span>
					<span class="n">schedule_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">sp_rtnl_task</span><span class="p">,</span>
								<span class="n">HZ</span><span class="o">/</span><span class="mi">10</span><span class="p">);</span>
					<span class="k">return</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="cm">/* If all other functions got down -</span>
<span class="cm">					 * try to bring the chip back to</span>
<span class="cm">					 * normal. In any case it&#39;s an exit</span>
<span class="cm">					 * point for a leader.</span>
<span class="cm">					 */</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">bnx2x_leader_reset</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span> <span class="p">{</span>
						<span class="n">bnx2x_recovery_failed</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
						<span class="k">return</span><span class="p">;</span>
					<span class="p">}</span>

					<span class="cm">/* If we are here, means that the</span>
<span class="cm">					 * leader has succeeded and doesn&#39;t</span>
<span class="cm">					 * want to be a leader any more. Try</span>
<span class="cm">					 * to continue as a none-leader.</span>
<span class="cm">					 */</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="cm">/* non-leader */</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bnx2x_reset_is_done</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">BP_PATH</span><span class="p">(</span><span class="n">bp</span><span class="p">)))</span> <span class="p">{</span>
					<span class="cm">/* Try to get a LEADER_LOCK HW lock as</span>
<span class="cm">					 * long as a former leader may have</span>
<span class="cm">					 * been unloaded by the user or</span>
<span class="cm">					 * released a leadership by another</span>
<span class="cm">					 * reason.</span>
<span class="cm">					 */</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">bnx2x_trylock_leader_lock</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span> <span class="p">{</span>
						<span class="cm">/* I&#39;m a leader now! Restart a</span>
<span class="cm">						 * switch case.</span>
<span class="cm">						 */</span>
						<span class="n">bp</span><span class="o">-&gt;</span><span class="n">is_leader</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
						<span class="k">break</span><span class="p">;</span>
					<span class="p">}</span>

					<span class="n">schedule_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">sp_rtnl_task</span><span class="p">,</span>
								<span class="n">HZ</span><span class="o">/</span><span class="mi">10</span><span class="p">);</span>
					<span class="k">return</span><span class="p">;</span>

				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="cm">/*</span>
<span class="cm">					 * If there was a global attention, wait</span>
<span class="cm">					 * for it to be cleared.</span>
<span class="cm">					 */</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">bnx2x_reset_is_global</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span> <span class="p">{</span>
						<span class="n">schedule_delayed_work</span><span class="p">(</span>
							<span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">sp_rtnl_task</span><span class="p">,</span>
							<span class="n">HZ</span><span class="o">/</span><span class="mi">10</span><span class="p">);</span>
						<span class="k">return</span><span class="p">;</span>
					<span class="p">}</span>

					<span class="n">error_recovered</span> <span class="o">=</span>
					  <span class="n">bp</span><span class="o">-&gt;</span><span class="n">eth_stats</span><span class="p">.</span><span class="n">recoverable_error</span><span class="p">;</span>
					<span class="n">error_unrecovered</span> <span class="o">=</span>
					  <span class="n">bp</span><span class="o">-&gt;</span><span class="n">eth_stats</span><span class="p">.</span><span class="n">unrecoverable_error</span><span class="p">;</span>
					<span class="n">bp</span><span class="o">-&gt;</span><span class="n">recovery_state</span> <span class="o">=</span>
						<span class="n">BNX2X_RECOVERY_NIC_LOADING</span><span class="p">;</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">bnx2x_nic_load</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">LOAD_NORMAL</span><span class="p">))</span> <span class="p">{</span>
						<span class="n">error_unrecovered</span><span class="o">++</span><span class="p">;</span>
						<span class="n">netdev_err</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
							   <span class="s">&quot;Recovery failed. Power cycle needed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
						<span class="cm">/* Disconnect this device */</span>
						<span class="n">netif_device_detach</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
						<span class="cm">/* Shut down the power */</span>
						<span class="n">bnx2x_set_power_state</span><span class="p">(</span>
							<span class="n">bp</span><span class="p">,</span> <span class="n">PCI_D3hot</span><span class="p">);</span>
						<span class="n">smp_mb</span><span class="p">();</span>
					<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
						<span class="n">bp</span><span class="o">-&gt;</span><span class="n">recovery_state</span> <span class="o">=</span>
							<span class="n">BNX2X_RECOVERY_DONE</span><span class="p">;</span>
						<span class="n">error_recovered</span><span class="o">++</span><span class="p">;</span>
						<span class="n">smp_mb</span><span class="p">();</span>
					<span class="p">}</span>
					<span class="n">bp</span><span class="o">-&gt;</span><span class="n">eth_stats</span><span class="p">.</span><span class="n">recoverable_error</span> <span class="o">=</span>
						<span class="n">error_recovered</span><span class="p">;</span>
					<span class="n">bp</span><span class="o">-&gt;</span><span class="n">eth_stats</span><span class="p">.</span><span class="n">unrecoverable_error</span> <span class="o">=</span>
						<span class="n">error_unrecovered</span><span class="p">;</span>

					<span class="k">return</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="nl">default:</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">bnx2x_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>

<span class="cm">/* bnx2x_nic_unload() flushes the bnx2x_wq, thus reset task is</span>
<span class="cm"> * scheduled on a general queue in order to prevent a dead lock.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_sp_rtnl_task</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bnx2x</span><span class="p">,</span> <span class="n">sp_rtnl_task</span><span class="p">.</span><span class="n">work</span><span class="p">);</span>

	<span class="n">rtnl_lock</span><span class="p">();</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">netif_running</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">sp_rtnl_exit</span><span class="p">;</span>

	<span class="cm">/* if stop on error is defined no recovery flows should be executed */</span>
<span class="cp">#ifdef BNX2X_STOP_ON_ERROR</span>
	<span class="n">BNX2X_ERR</span><span class="p">(</span><span class="s">&quot;recovery flow called but STOP_ON_ERROR defined so reset not done to allow debug dump,</span><span class="se">\n</span><span class="s">&quot;</span>
		  <span class="s">&quot;you will need to reboot when done</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">goto</span> <span class="n">sp_rtnl_not_reset</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">recovery_state</span> <span class="o">!=</span> <span class="n">BNX2X_RECOVERY_DONE</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Clear all pending SP commands as we are going to reset the</span>
<span class="cm">		 * function anyway.</span>
<span class="cm">		 */</span>
		<span class="n">bp</span><span class="o">-&gt;</span><span class="n">sp_rtnl_state</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">smp_mb</span><span class="p">();</span>

		<span class="n">bnx2x_parity_recover</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>

		<span class="k">goto</span> <span class="n">sp_rtnl_exit</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">BNX2X_SP_RTNL_TX_TIMEOUT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">sp_rtnl_state</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Clear all pending SP commands as we are going to reset the</span>
<span class="cm">		 * function anyway.</span>
<span class="cm">		 */</span>
		<span class="n">bp</span><span class="o">-&gt;</span><span class="n">sp_rtnl_state</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">smp_mb</span><span class="p">();</span>

		<span class="n">bnx2x_nic_unload</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">UNLOAD_NORMAL</span><span class="p">);</span>
		<span class="n">bnx2x_nic_load</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">LOAD_NORMAL</span><span class="p">);</span>

		<span class="k">goto</span> <span class="n">sp_rtnl_exit</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#ifdef BNX2X_STOP_ON_ERROR</span>
<span class="nl">sp_rtnl_not_reset:</span>
<span class="cp">#endif</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">BNX2X_SP_RTNL_SETUP_TC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">sp_rtnl_state</span><span class="p">))</span>
		<span class="n">bnx2x_setup_tc</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">dcbx_port_params</span><span class="p">.</span><span class="n">ets</span><span class="p">.</span><span class="n">num_of_cos</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">BNX2X_SP_RTNL_AFEX_F_UPDATE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">sp_rtnl_state</span><span class="p">))</span>
		<span class="n">bnx2x_after_function_update</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * in case of fan failure we need to reset id if the &quot;stop on error&quot;</span>
<span class="cm">	 * debug flag is set, since we trying to prevent permanent overheating</span>
<span class="cm">	 * damage</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">BNX2X_SP_RTNL_FAN_FAILURE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">sp_rtnl_state</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_HW</span><span class="p">,</span> <span class="s">&quot;fan failure detected. Unloading driver</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">netif_device_detach</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">bnx2x_close</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>

<span class="nl">sp_rtnl_exit:</span>
	<span class="n">rtnl_unlock</span><span class="p">();</span>
<span class="p">}</span>

<span class="cm">/* end of nic load/unload */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_period_task</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bnx2x</span><span class="p">,</span> <span class="n">period_task</span><span class="p">.</span><span class="n">work</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">netif_running</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">period_task_exit</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">CHIP_REV_IS_SLOW</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">BNX2X_ERR</span><span class="p">(</span><span class="s">&quot;period task called on emulation, ignoring</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">period_task_exit</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">bnx2x_acquire_phy_lock</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * The barrier is needed to ensure the ordering between the writing to</span>
<span class="cm">	 * the bp-&gt;port.pmf in the bnx2x_nic_load() or bnx2x_pmf_update() and</span>
<span class="cm">	 * the reading here.</span>
<span class="cm">	 */</span>
	<span class="n">smp_mb</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">pmf</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bnx2x_period_func</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">link_params</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">link_vars</span><span class="p">);</span>

		<span class="cm">/* Re-queue task in 1 sec */</span>
		<span class="n">queue_delayed_work</span><span class="p">(</span><span class="n">bnx2x_wq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">period_task</span><span class="p">,</span> <span class="mi">1</span><span class="o">*</span><span class="n">HZ</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">bnx2x_release_phy_lock</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
<span class="nl">period_task_exit:</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Init service functions</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">bnx2x_get_pretend_reg</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">base</span> <span class="o">=</span> <span class="n">PXP2_REG_PGL_PRETEND_FUNC_F0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">stride</span> <span class="o">=</span> <span class="n">PXP2_REG_PGL_PRETEND_FUNC_F1</span> <span class="o">-</span> <span class="n">base</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">base</span> <span class="o">+</span> <span class="p">(</span><span class="n">BP_ABS_FUNC</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span> <span class="o">*</span> <span class="n">stride</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_undi_int_disable_e1h</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">reg</span> <span class="o">=</span> <span class="n">bnx2x_get_pretend_reg</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>

	<span class="cm">/* Flush all outstanding writes */</span>
	<span class="n">mmiowb</span><span class="p">();</span>

	<span class="cm">/* Pretend to be function 0 */</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>	<span class="cm">/* Flush the GRC transaction (in the chip) */</span>

	<span class="cm">/* From now we are in the &quot;like-E1&quot; mode */</span>
	<span class="n">bnx2x_int_disable</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>

	<span class="cm">/* Flush all outstanding writes */</span>
	<span class="n">mmiowb</span><span class="p">();</span>

	<span class="cm">/* Restore the original function */</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">BP_ABS_FUNC</span><span class="p">(</span><span class="n">bp</span><span class="p">));</span>
	<span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">bnx2x_undi_int_disable</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">CHIP_IS_E1</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span>
		<span class="n">bnx2x_int_disable</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">bnx2x_undi_int_disable_e1h</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span> <span class="nf">bnx2x_prev_unload_close_mac</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">,</span> <span class="n">base_addr</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">reset_reg</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">mac_stopped</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">port</span> <span class="o">=</span> <span class="n">BP_PORT</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>

	<span class="n">reset_reg</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">MISC_REG_RESET_REG_2</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CHIP_IS_E3</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">NIG_REG_BMAC0_REGS_OUT_EN</span> <span class="o">+</span> <span class="n">port</span> <span class="o">*</span> <span class="mi">4</span><span class="p">);</span>
		<span class="n">mask</span> <span class="o">=</span> <span class="n">MISC_REGISTERS_RESET_REG_2_RST_BMAC0</span> <span class="o">&lt;&lt;</span> <span class="n">port</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="n">reset_reg</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">val</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u32</span> <span class="n">wb_data</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
			<span class="n">BNX2X_DEV_INFO</span><span class="p">(</span><span class="s">&quot;Disable bmac Rx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">base_addr</span> <span class="o">=</span> <span class="n">BP_PORT</span><span class="p">(</span><span class="n">bp</span><span class="p">)</span> <span class="o">?</span> <span class="n">NIG_REG_INGRESS_BMAC1_MEM</span>
						<span class="o">:</span> <span class="n">NIG_REG_INGRESS_BMAC0_MEM</span><span class="p">;</span>
			<span class="n">offset</span> <span class="o">=</span> <span class="n">CHIP_IS_E2</span><span class="p">(</span><span class="n">bp</span><span class="p">)</span> <span class="o">?</span> <span class="n">BIGMAC2_REGISTER_BMAC_CONTROL</span>
						<span class="o">:</span> <span class="n">BIGMAC_REGISTER_BMAC_CONTROL</span><span class="p">;</span>

			<span class="cm">/*</span>
<span class="cm">			 * use rd/wr since we cannot use dmae. This is safe</span>
<span class="cm">			 * since MCP won&#39;t access the bus due to the request</span>
<span class="cm">			 * to unload, and no function on the path can be</span>
<span class="cm">			 * loaded at this time.</span>
<span class="cm">			 */</span>
			<span class="n">wb_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">base_addr</span> <span class="o">+</span> <span class="n">offset</span><span class="p">);</span>
			<span class="n">wb_data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">base_addr</span> <span class="o">+</span> <span class="n">offset</span> <span class="o">+</span> <span class="mh">0x4</span><span class="p">);</span>
			<span class="n">wb_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">BMAC_CONTROL_RX_ENABLE</span><span class="p">;</span>
			<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">base_addr</span> <span class="o">+</span> <span class="n">offset</span><span class="p">,</span> <span class="n">wb_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
			<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">base_addr</span> <span class="o">+</span> <span class="n">offset</span> <span class="o">+</span> <span class="mh">0x4</span><span class="p">,</span> <span class="n">wb_data</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>

		<span class="p">}</span>
		<span class="n">BNX2X_DEV_INFO</span><span class="p">(</span><span class="s">&quot;Disable emac Rx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">NIG_REG_NIG_EMAC0_EN</span> <span class="o">+</span> <span class="n">BP_PORT</span><span class="p">(</span><span class="n">bp</span><span class="p">)</span><span class="o">*</span><span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="n">mac_stopped</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">reset_reg</span> <span class="o">&amp;</span> <span class="n">MISC_REGISTERS_RESET_REG_2_XMAC</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">BNX2X_DEV_INFO</span><span class="p">(</span><span class="s">&quot;Disable xmac Rx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">base_addr</span> <span class="o">=</span> <span class="n">BP_PORT</span><span class="p">(</span><span class="n">bp</span><span class="p">)</span> <span class="o">?</span> <span class="n">GRCBASE_XMAC1</span> <span class="o">:</span> <span class="n">GRCBASE_XMAC0</span><span class="p">;</span>
			<span class="n">val</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">base_addr</span> <span class="o">+</span> <span class="n">XMAC_REG_PFC_CTRL_HI</span><span class="p">);</span>
			<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">base_addr</span> <span class="o">+</span> <span class="n">XMAC_REG_PFC_CTRL_HI</span><span class="p">,</span>
			       <span class="n">val</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">));</span>
			<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">base_addr</span> <span class="o">+</span> <span class="n">XMAC_REG_PFC_CTRL_HI</span><span class="p">,</span>
			       <span class="n">val</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">));</span>
			<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">base_addr</span> <span class="o">+</span> <span class="n">XMAC_REG_CTRL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">mac_stopped</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">mask</span> <span class="o">=</span> <span class="n">MISC_REGISTERS_RESET_REG_2_UMAC0</span> <span class="o">&lt;&lt;</span> <span class="n">port</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="n">reset_reg</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">BNX2X_DEV_INFO</span><span class="p">(</span><span class="s">&quot;Disable umac Rx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">base_addr</span> <span class="o">=</span> <span class="n">BP_PORT</span><span class="p">(</span><span class="n">bp</span><span class="p">)</span> <span class="o">?</span> <span class="n">GRCBASE_UMAC1</span> <span class="o">:</span> <span class="n">GRCBASE_UMAC0</span><span class="p">;</span>
			<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">base_addr</span> <span class="o">+</span> <span class="n">UMAC_REG_COMMAND_CONFIG</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">mac_stopped</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mac_stopped</span><span class="p">)</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>

<span class="p">}</span>

<span class="cp">#define BNX2X_PREV_UNDI_PROD_ADDR(p) (BAR_TSTRORM_INTMEM + 0x1508 + ((p) &lt;&lt; 4))</span>
<span class="cp">#define BNX2X_PREV_UNDI_RCQ(val)	((val) &amp; 0xffff)</span>
<span class="cp">#define BNX2X_PREV_UNDI_BD(val)		((val) &gt;&gt; 16 &amp; 0xffff)</span>
<span class="cp">#define BNX2X_PREV_UNDI_PROD(rcq, bd)	((bd) &lt;&lt; 16 | (rcq))</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span> <span class="nf">bnx2x_prev_unload_undi_inc</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">,</span> <span class="n">u8</span> <span class="n">port</span><span class="p">,</span>
						 <span class="n">u8</span> <span class="n">inc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">rcq</span><span class="p">,</span> <span class="n">bd</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tmp_reg</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">BNX2X_PREV_UNDI_PROD_ADDR</span><span class="p">(</span><span class="n">port</span><span class="p">));</span>

	<span class="n">rcq</span> <span class="o">=</span> <span class="n">BNX2X_PREV_UNDI_RCQ</span><span class="p">(</span><span class="n">tmp_reg</span><span class="p">)</span> <span class="o">+</span> <span class="n">inc</span><span class="p">;</span>
	<span class="n">bd</span> <span class="o">=</span> <span class="n">BNX2X_PREV_UNDI_BD</span><span class="p">(</span><span class="n">tmp_reg</span><span class="p">)</span> <span class="o">+</span> <span class="n">inc</span><span class="p">;</span>

	<span class="n">tmp_reg</span> <span class="o">=</span> <span class="n">BNX2X_PREV_UNDI_PROD</span><span class="p">(</span><span class="n">rcq</span><span class="p">,</span> <span class="n">bd</span><span class="p">);</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">BNX2X_PREV_UNDI_PROD_ADDR</span><span class="p">(</span><span class="n">port</span><span class="p">),</span> <span class="n">tmp_reg</span><span class="p">);</span>

	<span class="n">BNX2X_DEV_INFO</span><span class="p">(</span><span class="s">&quot;UNDI producer [%d] rings bd -&gt; 0x%04x, rcq -&gt; 0x%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">port</span><span class="p">,</span> <span class="n">bd</span><span class="p">,</span> <span class="n">rcq</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">bnx2x_prev_mcp_done</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">rc</span> <span class="o">=</span> <span class="n">bnx2x_fw_command</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">DRV_MSG_CODE_UNLOAD_DONE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BNX2X_ERR</span><span class="p">(</span><span class="s">&quot;MCP response failure, aborting</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="n">__devinit</span> <span class="nf">bnx2x_prev_is_path_marked</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2x_prev_path_list</span> <span class="o">*</span><span class="n">tmp_list</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">down_trylock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bnx2x_prev_sem</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">tmp_list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bnx2x_prev_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">PCI_SLOT</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">)</span> <span class="o">==</span> <span class="n">tmp_list</span><span class="o">-&gt;</span><span class="n">slot</span> <span class="o">&amp;&amp;</span>
		    <span class="n">bp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">number</span> <span class="o">==</span> <span class="n">tmp_list</span><span class="o">-&gt;</span><span class="n">bus</span> <span class="o">&amp;&amp;</span>
		    <span class="n">BP_PATH</span><span class="p">(</span><span class="n">bp</span><span class="p">)</span> <span class="o">==</span> <span class="n">tmp_list</span><span class="o">-&gt;</span><span class="n">path</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="n">BNX2X_DEV_INFO</span><span class="p">(</span><span class="s">&quot;Path %d was already cleaned from previous drivers</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">BP_PATH</span><span class="p">(</span><span class="n">bp</span><span class="p">));</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bnx2x_prev_sem</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">bnx2x_prev_mark_path</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2x_prev_path_list</span> <span class="o">*</span><span class="n">tmp_list</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">tmp_list</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x_prev_path_list</span> <span class="o">*</span><span class="p">)</span>
		    <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x_prev_path_list</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tmp_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BNX2X_ERR</span><span class="p">(</span><span class="s">&quot;Failed to allocate &#39;bnx2x_prev_path_list&#39;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">tmp_list</span><span class="o">-&gt;</span><span class="n">bus</span> <span class="o">=</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">;</span>
	<span class="n">tmp_list</span><span class="o">-&gt;</span><span class="n">slot</span> <span class="o">=</span> <span class="n">PCI_SLOT</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">);</span>
	<span class="n">tmp_list</span><span class="o">-&gt;</span><span class="n">path</span> <span class="o">=</span> <span class="n">BP_PATH</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">down_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bnx2x_prev_sem</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BNX2X_ERR</span><span class="p">(</span><span class="s">&quot;Received %d when tried to take lock</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">tmp_list</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">BNX2X_DEV_INFO</span><span class="p">(</span><span class="s">&quot;Marked path [%d] - finished previous unload</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">BP_PATH</span><span class="p">(</span><span class="n">bp</span><span class="p">));</span>
		<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tmp_list</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bnx2x_prev_list</span><span class="p">);</span>
		<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bnx2x_prev_sem</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="n">__devinit</span> <span class="nf">bnx2x_can_flr</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">pos</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">cap</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">;</span>

	<span class="n">pos</span> <span class="o">=</span> <span class="n">pci_pcie_cap</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pos</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">pos</span> <span class="o">+</span> <span class="n">PCI_EXP_DEVCAP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cap</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">cap</span> <span class="o">&amp;</span> <span class="n">PCI_EXP_DEVCAP_FLR</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">bnx2x_do_flr</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">pos</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">status</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">;</span>

	<span class="cm">/* probe the capability first */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bnx2x_can_flr</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOTTY</span><span class="p">;</span>

	<span class="n">pos</span> <span class="o">=</span> <span class="n">pci_pcie_cap</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pos</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOTTY</span><span class="p">;</span>

	<span class="cm">/* Wait for Transaction Pending bit clean */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="p">)</span>
			<span class="n">msleep</span><span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">*</span> <span class="mi">100</span><span class="p">);</span>

		<span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">pos</span> <span class="o">+</span> <span class="n">PCI_EXP_DEVSTA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">PCI_EXP_DEVSTA_TRPND</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">clear</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
		<span class="s">&quot;transaction is not cleared; proceeding with reset anyway</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

<span class="nl">clear:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">.</span><span class="n">bc_ver</span> <span class="o">&lt;</span> <span class="n">REQ_BC_VER_4_INITIATE_FLR</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BNX2X_ERR</span><span class="p">(</span><span class="s">&quot;FLR not supported by BC_VER: 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">bp</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">.</span><span class="n">bc_ver</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">bnx2x_fw_command</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">DRV_MSG_CODE_INITIATE_FLR</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">bnx2x_prev_unload_uncommon</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">BNX2X_DEV_INFO</span><span class="p">(</span><span class="s">&quot;Uncommon unload Flow</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* Test if previous unload process was already finished for this path */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bnx2x_prev_is_path_marked</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">bnx2x_prev_mcp_done</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>

	<span class="cm">/* If function has FLR capabilities, and existing FW version matches</span>
<span class="cm">	 * the one required, then FLR will be sufficient to clean any residue</span>
<span class="cm">	 * left by previous driver</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bnx2x_test_firmware_version</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="nb">false</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">bnx2x_can_flr</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">bnx2x_do_flr</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>

	<span class="cm">/* Close the MCP request, return failure*/</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">bnx2x_prev_mcp_done</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rc</span><span class="p">)</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">BNX2X_PREV_WAIT_NEEDED</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">bnx2x_prev_unload_common</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">reset_reg</span><span class="p">,</span> <span class="n">tmp_reg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">rc</span><span class="p">;</span>
	<span class="cm">/* It is possible a previous function received &#39;common&#39; answer,</span>
<span class="cm">	 * but hasn&#39;t loaded yet, therefore creating a scenario of</span>
<span class="cm">	 * multiple functions receiving &#39;common&#39; on the same path.</span>
<span class="cm">	 */</span>
	<span class="n">BNX2X_DEV_INFO</span><span class="p">(</span><span class="s">&quot;Common unload Flow</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bnx2x_prev_is_path_marked</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">bnx2x_prev_mcp_done</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>

	<span class="n">reset_reg</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">MISC_REG_RESET_REG_1</span><span class="p">);</span>

	<span class="cm">/* Reset should be performed after BRB is emptied */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reset_reg</span> <span class="o">&amp;</span> <span class="n">MISC_REGISTERS_RESET_REG_1_RST_BRB1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">timer_count</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">;</span>
		<span class="n">bool</span> <span class="n">prev_undi</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

		<span class="cm">/* Close the MAC Rx to prevent BRB from filling up */</span>
		<span class="n">bnx2x_prev_unload_close_mac</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>

		<span class="cm">/* Check if the UNDI driver was previously loaded</span>
<span class="cm">		 * UNDI driver initializes CID offset for normal bell to 0x7</span>
<span class="cm">		 */</span>
		<span class="n">reset_reg</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">MISC_REG_RESET_REG_1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">reset_reg</span> <span class="o">&amp;</span> <span class="n">MISC_REGISTERS_RESET_REG_1_RST_DORQ</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">tmp_reg</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">DORQ_REG_NORM_CID_OFST</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tmp_reg</span> <span class="o">==</span> <span class="mh">0x7</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">BNX2X_DEV_INFO</span><span class="p">(</span><span class="s">&quot;UNDI previously loaded</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">prev_undi</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
				<span class="cm">/* clear the UNDI indication */</span>
				<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">DORQ_REG_NORM_CID_OFST</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="cm">/* wait until BRB is empty */</span>
		<span class="n">tmp_reg</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">BRB1_REG_NUM_OF_FULL_BLOCKS</span><span class="p">);</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">timer_count</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u32</span> <span class="n">prev_brb</span> <span class="o">=</span> <span class="n">tmp_reg</span><span class="p">;</span>

			<span class="n">tmp_reg</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">BRB1_REG_NUM_OF_FULL_BLOCKS</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tmp_reg</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="n">BNX2X_DEV_INFO</span><span class="p">(</span><span class="s">&quot;BRB still has 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tmp_reg</span><span class="p">);</span>

			<span class="cm">/* reset timer as long as BRB actually gets emptied */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">prev_brb</span> <span class="o">&gt;</span> <span class="n">tmp_reg</span><span class="p">)</span>
				<span class="n">timer_count</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">timer_count</span><span class="o">--</span><span class="p">;</span>

			<span class="cm">/* If UNDI resides in memory, manually increment it */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">prev_undi</span><span class="p">)</span>
				<span class="n">bnx2x_prev_unload_undi_inc</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">BP_PORT</span><span class="p">(</span><span class="n">bp</span><span class="p">),</span> <span class="mi">1</span><span class="p">);</span>

			<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">timer_count</span><span class="p">)</span>
			<span class="n">BNX2X_ERR</span><span class="p">(</span><span class="s">&quot;Failed to empty BRB, hope for the best</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="p">}</span>

	<span class="cm">/* No packets are in the pipeline, path is ready for reset */</span>
	<span class="n">bnx2x_reset_common</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">bnx2x_prev_mark_path</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bnx2x_prev_mcp_done</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">bnx2x_prev_mcp_done</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* previous driver DMAE transaction may have occurred when pre-boot stage ended</span>
<span class="cm"> * and boot began, or when kdump kernel was loaded. Either case would invalidate</span>
<span class="cm"> * the addresses of the transaction, resulting in was-error bit set in the pci</span>
<span class="cm"> * causing all hw-to-host pcie transactions to timeout. If this happened we want</span>
<span class="cm"> * to clear the interrupt which detected this from the pglueb and the was done</span>
<span class="cm"> * bit</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span> <span class="nf">bnx2x_prev_interrupted_dmae</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">val</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">PGLUE_B_REG_PGLUE_B_INT_STS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">PGLUE_B_PGLUE_B_INT_STS_REG_WAS_ERROR_ATTN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BNX2X_ERR</span><span class="p">(</span><span class="s">&quot;was error bit was found to be set in pglueb upon startup. Clearing&quot;</span><span class="p">);</span>
		<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">PGLUE_B_REG_WAS_ERROR_PF_7_0_CLR</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">BP_FUNC</span><span class="p">(</span><span class="n">bp</span><span class="p">));</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">bnx2x_prev_unload</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">time_counter</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">rc</span><span class="p">,</span> <span class="n">fw</span><span class="p">,</span> <span class="n">hw_lock_reg</span><span class="p">,</span> <span class="n">hw_lock_val</span><span class="p">;</span>
	<span class="n">BNX2X_DEV_INFO</span><span class="p">(</span><span class="s">&quot;Entering Previous Unload Flow</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* clear hw from errors which may have resulted from an interrupted</span>
<span class="cm">	 * dmae transaction.</span>
<span class="cm">	 */</span>
	<span class="n">bnx2x_prev_interrupted_dmae</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>

	<span class="cm">/* Release previously held locks */</span>
	<span class="n">hw_lock_reg</span> <span class="o">=</span> <span class="p">(</span><span class="n">BP_FUNC</span><span class="p">(</span><span class="n">bp</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">5</span><span class="p">)</span> <span class="o">?</span>
		      <span class="p">(</span><span class="n">MISC_REG_DRIVER_CONTROL_1</span> <span class="o">+</span> <span class="n">BP_FUNC</span><span class="p">(</span><span class="n">bp</span><span class="p">)</span> <span class="o">*</span> <span class="mi">8</span><span class="p">)</span> <span class="o">:</span>
		      <span class="p">(</span><span class="n">MISC_REG_DRIVER_CONTROL_7</span> <span class="o">+</span> <span class="p">(</span><span class="n">BP_FUNC</span><span class="p">(</span><span class="n">bp</span><span class="p">)</span> <span class="o">-</span> <span class="mi">6</span><span class="p">)</span> <span class="o">*</span> <span class="mi">8</span><span class="p">);</span>

	<span class="n">hw_lock_val</span> <span class="o">=</span> <span class="p">(</span><span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">hw_lock_reg</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hw_lock_val</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hw_lock_val</span> <span class="o">&amp;</span> <span class="n">HW_LOCK_RESOURCE_NVRAM</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">BNX2X_DEV_INFO</span><span class="p">(</span><span class="s">&quot;Release Previously held NVRAM lock</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">MCP_REG_MCPR_NVM_SW_ARB</span><span class="p">,</span>
			       <span class="p">(</span><span class="n">MCPR_NVM_SW_ARB_ARB_REQ_CLR1</span> <span class="o">&lt;&lt;</span> <span class="n">BP_PORT</span><span class="p">(</span><span class="n">bp</span><span class="p">)));</span>
		<span class="p">}</span>

		<span class="n">BNX2X_DEV_INFO</span><span class="p">(</span><span class="s">&quot;Release Previously held hw lock</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">hw_lock_reg</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">BNX2X_DEV_INFO</span><span class="p">(</span><span class="s">&quot;No need to release hw/nvram locks</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">MCPR_ACCESS_LOCK_LOCK</span> <span class="o">&amp;</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">MCP_REG_MCPR_ACCESS_LOCK</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">BNX2X_DEV_INFO</span><span class="p">(</span><span class="s">&quot;Release previously held alr</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">MCP_REG_MCPR_ACCESS_LOCK</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>


	<span class="k">do</span> <span class="p">{</span>
		<span class="cm">/* Lock MCP using an unload request */</span>
		<span class="n">fw</span> <span class="o">=</span> <span class="n">bnx2x_fw_command</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">DRV_MSG_CODE_UNLOAD_REQ_WOL_DIS</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fw</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">BNX2X_ERR</span><span class="p">(</span><span class="s">&quot;MCP response failure, aborting</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">fw</span> <span class="o">==</span> <span class="n">FW_MSG_CODE_DRV_UNLOAD_COMMON</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">bnx2x_prev_unload_common</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* non-common reply from MCP night require looping */</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">bnx2x_prev_unload_uncommon</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="n">BNX2X_PREV_WAIT_NEEDED</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">msleep</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">time_counter</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">time_counter</span> <span class="o">||</span> <span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BNX2X_ERR</span><span class="p">(</span><span class="s">&quot;Failed unloading previous driver, aborting</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">BNX2X_DEV_INFO</span><span class="p">(</span><span class="s">&quot;Finished Previous Unload Flow [%d]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span> <span class="nf">bnx2x_get_common_hwinfo</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">,</span> <span class="n">val2</span><span class="p">,</span> <span class="n">val3</span><span class="p">,</span> <span class="n">val4</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span> <span class="n">boot_mode</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">pmc</span><span class="p">;</span>

	<span class="cm">/* Get the chip revision id and number. */</span>
	<span class="cm">/* chip num:16-31, rev:12-15, metal:4-11, bond_id:0-3 */</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">MISC_REG_CHIP_NUM</span><span class="p">);</span>
	<span class="n">id</span> <span class="o">=</span> <span class="p">((</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">MISC_REG_CHIP_REV</span><span class="p">);</span>
	<span class="n">id</span> <span class="o">|=</span> <span class="p">((</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">MISC_REG_CHIP_METAL</span><span class="p">);</span>
	<span class="n">id</span> <span class="o">|=</span> <span class="p">((</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">MISC_REG_BOND_ID</span><span class="p">);</span>
	<span class="n">id</span> <span class="o">|=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">);</span>
	<span class="n">bp</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">.</span><span class="n">chip_id</span> <span class="o">=</span> <span class="n">id</span><span class="p">;</span>

	<span class="cm">/* force 57811 according to MISC register */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">MISC_REG_CHIP_TYPE</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">MISC_REG_CHIP_TYPE_57811_MASK</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">CHIP_IS_57810</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span>
			<span class="n">bp</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">.</span><span class="n">chip_id</span> <span class="o">=</span> <span class="p">(</span><span class="n">CHIP_NUM_57811</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span>
				<span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">.</span><span class="n">chip_id</span> <span class="o">&amp;</span> <span class="mh">0x0000FFFF</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">CHIP_IS_57810_MF</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span>
			<span class="n">bp</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">.</span><span class="n">chip_id</span> <span class="o">=</span> <span class="p">(</span><span class="n">CHIP_NUM_57811_MF</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span>
				<span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">.</span><span class="n">chip_id</span> <span class="o">&amp;</span> <span class="mh">0x0000FFFF</span><span class="p">);</span>
		<span class="n">bp</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">.</span><span class="n">chip_id</span> <span class="o">|=</span> <span class="mh">0x1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Set doorbell size */</span>
	<span class="n">bp</span><span class="o">-&gt;</span><span class="n">db_size</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">BNX2X_DB_SHIFT</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CHIP_IS_E1x</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">MISC_REG_PORT4MODE_EN_OVWR</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">val</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">MISC_REG_PORT4MODE_EN</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">BNX2X_DEV_INFO</span><span class="p">(</span><span class="s">&quot;chip is in %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">val</span> <span class="o">?</span> <span class="s">&quot;4_PORT_MODE&quot;</span> <span class="o">:</span>
						       <span class="s">&quot;2_PORT_MODE&quot;</span><span class="p">);</span>
		<span class="n">bp</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">.</span><span class="n">chip_port_mode</span> <span class="o">=</span> <span class="n">val</span> <span class="o">?</span> <span class="n">CHIP_4_PORT_MODE</span> <span class="o">:</span>
						 <span class="n">CHIP_2_PORT_MODE</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">CHIP_MODE_IS_4_PORT</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span>
			<span class="n">bp</span><span class="o">-&gt;</span><span class="n">pfid</span> <span class="o">=</span> <span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">pf_num</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">);</span>	<span class="cm">/* 0..3 */</span>
		<span class="k">else</span>
			<span class="n">bp</span><span class="o">-&gt;</span><span class="n">pfid</span> <span class="o">=</span> <span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">pf_num</span> <span class="o">&amp;</span> <span class="mh">0x6</span><span class="p">);</span>	<span class="cm">/* 0, 2, 4, 6 */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">bp</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">.</span><span class="n">chip_port_mode</span> <span class="o">=</span> <span class="n">CHIP_PORT_MODE_NONE</span><span class="p">;</span> <span class="cm">/* N/A */</span>
		<span class="n">bp</span><span class="o">-&gt;</span><span class="n">pfid</span> <span class="o">=</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">pf_num</span><span class="p">;</span>			<span class="cm">/* 0..7 */</span>
	<span class="p">}</span>

	<span class="n">BNX2X_DEV_INFO</span><span class="p">(</span><span class="s">&quot;pf_id: %x&quot;</span><span class="p">,</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">pfid</span><span class="p">);</span>

	<span class="n">bp</span><span class="o">-&gt;</span><span class="n">link_params</span><span class="p">.</span><span class="n">chip_id</span> <span class="o">=</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">.</span><span class="n">chip_id</span><span class="p">;</span>
	<span class="n">BNX2X_DEV_INFO</span><span class="p">(</span><span class="s">&quot;chip ID is 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">id</span><span class="p">);</span>

	<span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="mh">0x2874</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x55</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">.</span><span class="n">chip_id</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">CHIP_IS_E1</span><span class="p">(</span><span class="n">bp</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">val</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">CHIP_IS_E1H</span><span class="p">(</span><span class="n">bp</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">val</span> <span class="o">==</span> <span class="mh">0x55</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">bp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">ONE_PORT_FLAG</span><span class="p">;</span>
		<span class="n">BNX2X_DEV_INFO</span><span class="p">(</span><span class="s">&quot;single port device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">MCP_REG_MCPR_NVM_CFG4</span><span class="p">);</span>
	<span class="n">bp</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">.</span><span class="n">flash_size</span> <span class="o">=</span> <span class="p">(</span><span class="n">BNX2X_NVRAM_1MB_SIZE</span> <span class="o">&lt;&lt;</span>
				 <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">MCPR_NVM_CFG4_FLASH_SIZE</span><span class="p">));</span>
	<span class="n">BNX2X_DEV_INFO</span><span class="p">(</span><span class="s">&quot;flash_size 0x%x (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">bp</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">.</span><span class="n">flash_size</span><span class="p">,</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">.</span><span class="n">flash_size</span><span class="p">);</span>

	<span class="n">bnx2x_init_shmem</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>



	<span class="n">bp</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">.</span><span class="n">shmem2_base</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="p">(</span><span class="n">BP_PATH</span><span class="p">(</span><span class="n">bp</span><span class="p">)</span> <span class="o">?</span>
					<span class="n">MISC_REG_GENERIC_CR_1</span> <span class="o">:</span>
					<span class="n">MISC_REG_GENERIC_CR_0</span><span class="p">));</span>

	<span class="n">bp</span><span class="o">-&gt;</span><span class="n">link_params</span><span class="p">.</span><span class="n">shmem_base</span> <span class="o">=</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">.</span><span class="n">shmem_base</span><span class="p">;</span>
	<span class="n">bp</span><span class="o">-&gt;</span><span class="n">link_params</span><span class="p">.</span><span class="n">shmem2_base</span> <span class="o">=</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">.</span><span class="n">shmem2_base</span><span class="p">;</span>
	<span class="n">BNX2X_DEV_INFO</span><span class="p">(</span><span class="s">&quot;shmem offset 0x%x  shmem2 offset 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">bp</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">.</span><span class="n">shmem_base</span><span class="p">,</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">.</span><span class="n">shmem2_base</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">.</span><span class="n">shmem_base</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BNX2X_DEV_INFO</span><span class="p">(</span><span class="s">&quot;MCP not active</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">bp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">NO_MCP_FLAG</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">bp</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">.</span><span class="n">hw_config</span> <span class="o">=</span> <span class="n">SHMEM_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">dev_info</span><span class="p">.</span><span class="n">shared_hw_config</span><span class="p">.</span><span class="n">config</span><span class="p">);</span>
	<span class="n">BNX2X_DEV_INFO</span><span class="p">(</span><span class="s">&quot;hw_config 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">.</span><span class="n">hw_config</span><span class="p">);</span>

	<span class="n">bp</span><span class="o">-&gt;</span><span class="n">link_params</span><span class="p">.</span><span class="n">hw_led_mode</span> <span class="o">=</span> <span class="p">((</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">.</span><span class="n">hw_config</span> <span class="o">&amp;</span>
					<span class="n">SHARED_HW_CFG_LED_MODE_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span>
				       <span class="n">SHARED_HW_CFG_LED_MODE_SHIFT</span><span class="p">);</span>

	<span class="n">bp</span><span class="o">-&gt;</span><span class="n">link_params</span><span class="p">.</span><span class="n">feature_config_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">SHMEM_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">dev_info</span><span class="p">.</span><span class="n">shared_feature_config</span><span class="p">.</span><span class="n">config</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">SHARED_FEAT_CFG_OVERRIDE_PREEMPHASIS_CFG_ENABLED</span><span class="p">)</span>
		<span class="n">bp</span><span class="o">-&gt;</span><span class="n">link_params</span><span class="p">.</span><span class="n">feature_config_flags</span> <span class="o">|=</span>
				<span class="n">FEATURE_CONFIG_OVERRIDE_PREEMPHASIS_ENABLED</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">bp</span><span class="o">-&gt;</span><span class="n">link_params</span><span class="p">.</span><span class="n">feature_config_flags</span> <span class="o">&amp;=</span>
				<span class="o">~</span><span class="n">FEATURE_CONFIG_OVERRIDE_PREEMPHASIS_ENABLED</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">SHMEM_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">dev_info</span><span class="p">.</span><span class="n">bc_rev</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">bp</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">.</span><span class="n">bc_ver</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
	<span class="n">BNX2X_DEV_INFO</span><span class="p">(</span><span class="s">&quot;bc_ver %X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&lt;</span> <span class="n">BNX2X_BC_VER</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* for now only warn</span>
<span class="cm">		 * later we might need to enforce this */</span>
		<span class="n">BNX2X_ERR</span><span class="p">(</span><span class="s">&quot;This driver needs bc_ver %X but found %X, please upgrade BC</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">BNX2X_BC_VER</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">bp</span><span class="o">-&gt;</span><span class="n">link_params</span><span class="p">.</span><span class="n">feature_config_flags</span> <span class="o">|=</span>
				<span class="p">(</span><span class="n">val</span> <span class="o">&gt;=</span> <span class="n">REQ_BC_VER_4_VRFY_FIRST_PHY_OPT_MDL</span><span class="p">)</span> <span class="o">?</span>
				<span class="n">FEATURE_CONFIG_BC_SUPPORTS_OPT_MDL_VRFY</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">bp</span><span class="o">-&gt;</span><span class="n">link_params</span><span class="p">.</span><span class="n">feature_config_flags</span> <span class="o">|=</span>
		<span class="p">(</span><span class="n">val</span> <span class="o">&gt;=</span> <span class="n">REQ_BC_VER_4_VRFY_SPECIFIC_PHY_OPT_MDL</span><span class="p">)</span> <span class="o">?</span>
		<span class="n">FEATURE_CONFIG_BC_SUPPORTS_DUAL_PHY_OPT_MDL_VRFY</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">bp</span><span class="o">-&gt;</span><span class="n">link_params</span><span class="p">.</span><span class="n">feature_config_flags</span> <span class="o">|=</span>
		<span class="p">(</span><span class="n">val</span> <span class="o">&gt;=</span> <span class="n">REQ_BC_VER_4_VRFY_AFEX_SUPPORTED</span><span class="p">)</span> <span class="o">?</span>
		<span class="n">FEATURE_CONFIG_BC_SUPPORTS_AFEX</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">bp</span><span class="o">-&gt;</span><span class="n">link_params</span><span class="p">.</span><span class="n">feature_config_flags</span> <span class="o">|=</span>
		<span class="p">(</span><span class="n">val</span> <span class="o">&gt;=</span> <span class="n">REQ_BC_VER_4_SFP_TX_DISABLE_SUPPORTED</span><span class="p">)</span> <span class="o">?</span>
		<span class="n">FEATURE_CONFIG_BC_SUPPORTS_SFP_TX_DISABLED</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">bp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;=</span> <span class="n">REQ_BC_VER_4_PFC_STATS_SUPPORTED</span><span class="p">)</span> <span class="o">?</span>
			<span class="n">BC_SUPPORTS_PFC_STATS</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">boot_mode</span> <span class="o">=</span> <span class="n">SHMEM_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span>
			<span class="n">dev_info</span><span class="p">.</span><span class="n">port_feature_config</span><span class="p">[</span><span class="n">BP_PORT</span><span class="p">(</span><span class="n">bp</span><span class="p">)].</span><span class="n">mba_config</span><span class="p">)</span> <span class="o">&amp;</span>
			<span class="n">PORT_FEATURE_MBA_BOOT_AGENT_TYPE_MASK</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">boot_mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PORT_FEATURE_MBA_BOOT_AGENT_TYPE_PXE</span>:
		<span class="n">bp</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">.</span><span class="n">boot_mode</span> <span class="o">=</span> <span class="n">FEATURE_ETH_BOOTMODE_PXE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PORT_FEATURE_MBA_BOOT_AGENT_TYPE_ISCSIB</span>:
		<span class="n">bp</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">.</span><span class="n">boot_mode</span> <span class="o">=</span> <span class="n">FEATURE_ETH_BOOTMODE_ISCSI</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PORT_FEATURE_MBA_BOOT_AGENT_TYPE_FCOE_BOOT</span>:
		<span class="n">bp</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">.</span><span class="n">boot_mode</span> <span class="o">=</span> <span class="n">FEATURE_ETH_BOOTMODE_FCOE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PORT_FEATURE_MBA_BOOT_AGENT_TYPE_NONE</span>:
		<span class="n">bp</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">.</span><span class="n">boot_mode</span> <span class="o">=</span> <span class="n">FEATURE_ETH_BOOTMODE_NONE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">pm_cap</span> <span class="o">+</span> <span class="n">PCI_PM_PMC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pmc</span><span class="p">);</span>
	<span class="n">bp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="p">(</span><span class="n">pmc</span> <span class="o">&amp;</span> <span class="n">PCI_PM_CAP_PME_D3cold</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">NO_WOL_FLAG</span><span class="p">;</span>

	<span class="n">BNX2X_DEV_INFO</span><span class="p">(</span><span class="s">&quot;%sWoL capable</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">NO_WOL_FLAG</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;not &quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">);</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">SHMEM_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">dev_info</span><span class="p">.</span><span class="n">shared_hw_config</span><span class="p">.</span><span class="n">part_num</span><span class="p">);</span>
	<span class="n">val2</span> <span class="o">=</span> <span class="n">SHMEM_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">dev_info</span><span class="p">.</span><span class="n">shared_hw_config</span><span class="p">.</span><span class="n">part_num</span><span class="p">[</span><span class="mi">4</span><span class="p">]);</span>
	<span class="n">val3</span> <span class="o">=</span> <span class="n">SHMEM_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">dev_info</span><span class="p">.</span><span class="n">shared_hw_config</span><span class="p">.</span><span class="n">part_num</span><span class="p">[</span><span class="mi">8</span><span class="p">]);</span>
	<span class="n">val4</span> <span class="o">=</span> <span class="n">SHMEM_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">dev_info</span><span class="p">.</span><span class="n">shared_hw_config</span><span class="p">.</span><span class="n">part_num</span><span class="p">[</span><span class="mi">12</span><span class="p">]);</span>

	<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;part number %X-%X-%X-%X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">val</span><span class="p">,</span> <span class="n">val2</span><span class="p">,</span> <span class="n">val3</span><span class="p">,</span> <span class="n">val4</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#define IGU_FID(val)	GET_FIELD((val), IGU_REG_MAPPING_MEMORY_FID)</span>
<span class="cp">#define IGU_VEC(val)	GET_FIELD((val), IGU_REG_MAPPING_MEMORY_VECTOR)</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span> <span class="nf">bnx2x_get_igu_cam_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">pfid</span> <span class="o">=</span> <span class="n">BP_FUNC</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">igu_sb_id</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">fid</span><span class="p">,</span> <span class="n">igu_sb_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">bp</span><span class="o">-&gt;</span><span class="n">igu_base_sb</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">CHIP_INT_MODE_IS_BC</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">vn</span> <span class="o">=</span> <span class="n">BP_VN</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
		<span class="n">igu_sb_cnt</span> <span class="o">=</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">igu_sb_cnt</span><span class="p">;</span>
		<span class="n">bp</span><span class="o">-&gt;</span><span class="n">igu_base_sb</span> <span class="o">=</span> <span class="p">(</span><span class="n">CHIP_MODE_IS_4_PORT</span><span class="p">(</span><span class="n">bp</span><span class="p">)</span> <span class="o">?</span> <span class="n">pfid</span> <span class="o">:</span> <span class="n">vn</span><span class="p">)</span> <span class="o">*</span>
			<span class="n">FP_SB_MAX_E1x</span><span class="p">;</span>

		<span class="n">bp</span><span class="o">-&gt;</span><span class="n">igu_dsb_id</span> <span class="o">=</span>  <span class="n">E1HVN_MAX</span> <span class="o">*</span> <span class="n">FP_SB_MAX_E1x</span> <span class="o">+</span>
			<span class="p">(</span><span class="n">CHIP_MODE_IS_4_PORT</span><span class="p">(</span><span class="n">bp</span><span class="p">)</span> <span class="o">?</span> <span class="n">pfid</span> <span class="o">:</span> <span class="n">vn</span><span class="p">);</span>

		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* IGU in normal mode - read CAM */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">igu_sb_id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">igu_sb_id</span> <span class="o">&lt;</span> <span class="n">IGU_REG_MAPPING_MEMORY_SIZE</span><span class="p">;</span>
	     <span class="n">igu_sb_id</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">IGU_REG_MAPPING_MEMORY</span> <span class="o">+</span> <span class="n">igu_sb_id</span> <span class="o">*</span> <span class="mi">4</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">IGU_REG_MAPPING_MEMORY_VALID</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">fid</span> <span class="o">=</span> <span class="n">IGU_FID</span><span class="p">(</span><span class="n">val</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">fid</span> <span class="o">&amp;</span> <span class="n">IGU_FID_ENCODE_IS_PF</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">fid</span> <span class="o">&amp;</span> <span class="n">IGU_FID_PF_NUM_MASK</span><span class="p">)</span> <span class="o">!=</span> <span class="n">pfid</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">IGU_VEC</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="cm">/* default status block */</span>
				<span class="n">bp</span><span class="o">-&gt;</span><span class="n">igu_dsb_id</span> <span class="o">=</span> <span class="n">igu_sb_id</span><span class="p">;</span>
			<span class="k">else</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">igu_base_sb</span> <span class="o">==</span> <span class="mh">0xff</span><span class="p">)</span>
					<span class="n">bp</span><span class="o">-&gt;</span><span class="n">igu_base_sb</span> <span class="o">=</span> <span class="n">igu_sb_id</span><span class="p">;</span>
				<span class="n">igu_sb_cnt</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

<span class="cp">#ifdef CONFIG_PCI_MSI</span>
	<span class="cm">/*</span>
<span class="cm">	 * It&#39;s expected that number of CAM entries for this functions is equal</span>
<span class="cm">	 * to the number evaluated based on the MSI-X table size. We want a</span>
<span class="cm">	 * harsh warning if these values are different!</span>
<span class="cm">	 */</span>
	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">igu_sb_cnt</span> <span class="o">!=</span> <span class="n">igu_sb_cnt</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">igu_sb_cnt</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">BNX2X_ERR</span><span class="p">(</span><span class="s">&quot;CAM configuration error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span> <span class="nf">bnx2x_link_settings_supported</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">,</span>
						    <span class="n">u32</span> <span class="n">switch_cfg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">cfg_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">port</span> <span class="o">=</span> <span class="n">BP_PORT</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>

	<span class="cm">/* Aggregation of supported attributes of all external phys */</span>
	<span class="n">bp</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">supported</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">bp</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">supported</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">link_params</span><span class="p">.</span><span class="n">num_phys</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">bp</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">supported</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">link_params</span><span class="p">.</span><span class="n">phy</span><span class="p">[</span><span class="n">INT_PHY</span><span class="p">].</span><span class="n">supported</span><span class="p">;</span>
		<span class="n">cfg_size</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="n">bp</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">supported</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">link_params</span><span class="p">.</span><span class="n">phy</span><span class="p">[</span><span class="n">EXT_PHY1</span><span class="p">].</span><span class="n">supported</span><span class="p">;</span>
		<span class="n">cfg_size</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">3</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">link_params</span><span class="p">.</span><span class="n">multi_phy_config</span> <span class="o">&amp;</span>
		    <span class="n">PORT_HW_CFG_PHY_SWAPPED_ENABLED</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">bp</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">supported</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span>
				<span class="n">bp</span><span class="o">-&gt;</span><span class="n">link_params</span><span class="p">.</span><span class="n">phy</span><span class="p">[</span><span class="n">EXT_PHY1</span><span class="p">].</span><span class="n">supported</span><span class="p">;</span>
			<span class="n">bp</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">supported</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span>
				<span class="n">bp</span><span class="o">-&gt;</span><span class="n">link_params</span><span class="p">.</span><span class="n">phy</span><span class="p">[</span><span class="n">EXT_PHY2</span><span class="p">].</span><span class="n">supported</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">bp</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">supported</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span>
				<span class="n">bp</span><span class="o">-&gt;</span><span class="n">link_params</span><span class="p">.</span><span class="n">phy</span><span class="p">[</span><span class="n">EXT_PHY1</span><span class="p">].</span><span class="n">supported</span><span class="p">;</span>
			<span class="n">bp</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">supported</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span>
				<span class="n">bp</span><span class="o">-&gt;</span><span class="n">link_params</span><span class="p">.</span><span class="n">phy</span><span class="p">[</span><span class="n">EXT_PHY2</span><span class="p">].</span><span class="n">supported</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">cfg_size</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">supported</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">||</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">supported</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span> <span class="p">{</span>
		<span class="n">BNX2X_ERR</span><span class="p">(</span><span class="s">&quot;NVRAM config error. BAD phy config. PHY1 config 0x%x, PHY2 config 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">SHMEM_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span>
			   <span class="n">dev_info</span><span class="p">.</span><span class="n">port_hw_config</span><span class="p">[</span><span class="n">port</span><span class="p">].</span><span class="n">external_phy_config</span><span class="p">),</span>
			   <span class="n">SHMEM_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span>
			   <span class="n">dev_info</span><span class="p">.</span><span class="n">port_hw_config</span><span class="p">[</span><span class="n">port</span><span class="p">].</span><span class="n">external_phy_config2</span><span class="p">));</span>
			<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">CHIP_IS_E3</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span>
		<span class="n">bp</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">phy_addr</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">MISC_REG_WC0_CTRL_PHY_ADDR</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">switch_cfg</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">SWITCH_CFG_1G</span>:
			<span class="n">bp</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">phy_addr</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span>
				<span class="n">bp</span><span class="p">,</span> <span class="n">NIG_REG_SERDES0_CTRL_PHY_ADDR</span> <span class="o">+</span> <span class="n">port</span><span class="o">*</span><span class="mh">0x10</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">SWITCH_CFG_10G</span>:
			<span class="n">bp</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">phy_addr</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span>
				<span class="n">bp</span><span class="p">,</span> <span class="n">NIG_REG_XGXS0_CTRL_PHY_ADDR</span> <span class="o">+</span> <span class="n">port</span><span class="o">*</span><span class="mh">0x18</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">BNX2X_ERR</span><span class="p">(</span><span class="s">&quot;BAD switch_cfg link_config 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				  <span class="n">bp</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">link_config</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">BNX2X_DEV_INFO</span><span class="p">(</span><span class="s">&quot;phy_addr 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">phy_addr</span><span class="p">);</span>
	<span class="cm">/* mask what we support according to speed_cap_mask per configuration */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">cfg_size</span><span class="p">;</span> <span class="n">idx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">link_params</span><span class="p">.</span><span class="n">speed_cap_mask</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">&amp;</span>
				<span class="n">PORT_HW_CFG_SPEED_CAPABILITY_D0_10M_HALF</span><span class="p">))</span>
			<span class="n">bp</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">supported</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SUPPORTED_10baseT_Half</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">link_params</span><span class="p">.</span><span class="n">speed_cap_mask</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">&amp;</span>
				<span class="n">PORT_HW_CFG_SPEED_CAPABILITY_D0_10M_FULL</span><span class="p">))</span>
			<span class="n">bp</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">supported</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SUPPORTED_10baseT_Full</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">link_params</span><span class="p">.</span><span class="n">speed_cap_mask</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">&amp;</span>
				<span class="n">PORT_HW_CFG_SPEED_CAPABILITY_D0_100M_HALF</span><span class="p">))</span>
			<span class="n">bp</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">supported</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SUPPORTED_100baseT_Half</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">link_params</span><span class="p">.</span><span class="n">speed_cap_mask</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">&amp;</span>
				<span class="n">PORT_HW_CFG_SPEED_CAPABILITY_D0_100M_FULL</span><span class="p">))</span>
			<span class="n">bp</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">supported</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SUPPORTED_100baseT_Full</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">link_params</span><span class="p">.</span><span class="n">speed_cap_mask</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">&amp;</span>
					<span class="n">PORT_HW_CFG_SPEED_CAPABILITY_D0_1G</span><span class="p">))</span>
			<span class="n">bp</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">supported</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">SUPPORTED_1000baseT_Half</span> <span class="o">|</span>
						     <span class="n">SUPPORTED_1000baseT_Full</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">link_params</span><span class="p">.</span><span class="n">speed_cap_mask</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">&amp;</span>
					<span class="n">PORT_HW_CFG_SPEED_CAPABILITY_D0_2_5G</span><span class="p">))</span>
			<span class="n">bp</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">supported</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SUPPORTED_2500baseX_Full</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">link_params</span><span class="p">.</span><span class="n">speed_cap_mask</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">&amp;</span>
					<span class="n">PORT_HW_CFG_SPEED_CAPABILITY_D0_10G</span><span class="p">))</span>
			<span class="n">bp</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">supported</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SUPPORTED_10000baseT_Full</span><span class="p">;</span>

	<span class="p">}</span>

	<span class="n">BNX2X_DEV_INFO</span><span class="p">(</span><span class="s">&quot;supported 0x%x 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">supported</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
		       <span class="n">bp</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">supported</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span> <span class="nf">bnx2x_link_settings_requested</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">link_config</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">cfg_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">bp</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">advertising</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">bp</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">advertising</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">link_params</span><span class="p">.</span><span class="n">num_phys</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">1</span>:
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="n">cfg_size</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">3</span>:
		<span class="n">cfg_size</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">cfg_size</span><span class="p">;</span> <span class="n">idx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bp</span><span class="o">-&gt;</span><span class="n">link_params</span><span class="p">.</span><span class="n">req_duplex</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">DUPLEX_FULL</span><span class="p">;</span>
		<span class="n">link_config</span> <span class="o">=</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">link_config</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">link_config</span> <span class="o">&amp;</span> <span class="n">PORT_FEATURE_LINK_SPEED_MASK</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">PORT_FEATURE_LINK_SPEED_AUTO</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">supported</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">SUPPORTED_Autoneg</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">bp</span><span class="o">-&gt;</span><span class="n">link_params</span><span class="p">.</span><span class="n">req_line_speed</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span>
					<span class="n">SPEED_AUTO_NEG</span><span class="p">;</span>
				<span class="n">bp</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">advertising</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">|=</span>
					<span class="n">bp</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">supported</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">link_params</span><span class="p">.</span><span class="n">phy</span><span class="p">[</span><span class="n">EXT_PHY1</span><span class="p">].</span><span class="n">type</span> <span class="o">==</span>
				    <span class="n">PORT_HW_CFG_XGXS_EXT_PHY_TYPE_BCM84833</span><span class="p">)</span>
					<span class="n">bp</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">advertising</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">|=</span>
					<span class="p">(</span><span class="n">SUPPORTED_100baseT_Half</span> <span class="o">|</span>
					 <span class="n">SUPPORTED_100baseT_Full</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="cm">/* force 10G, no AN */</span>
				<span class="n">bp</span><span class="o">-&gt;</span><span class="n">link_params</span><span class="p">.</span><span class="n">req_line_speed</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span>
					<span class="n">SPEED_10000</span><span class="p">;</span>
				<span class="n">bp</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">advertising</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">|=</span>
					<span class="p">(</span><span class="n">ADVERTISED_10000baseT_Full</span> <span class="o">|</span>
					 <span class="n">ADVERTISED_FIBRE</span><span class="p">);</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">PORT_FEATURE_LINK_SPEED_10M_FULL</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">supported</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">SUPPORTED_10baseT_Full</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">bp</span><span class="o">-&gt;</span><span class="n">link_params</span><span class="p">.</span><span class="n">req_line_speed</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span>
					<span class="n">SPEED_10</span><span class="p">;</span>
				<span class="n">bp</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">advertising</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">|=</span>
					<span class="p">(</span><span class="n">ADVERTISED_10baseT_Full</span> <span class="o">|</span>
					 <span class="n">ADVERTISED_TP</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">BNX2X_ERR</span><span class="p">(</span><span class="s">&quot;NVRAM config error. Invalid link_config 0x%x  speed_cap_mask 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					    <span class="n">link_config</span><span class="p">,</span>
				    <span class="n">bp</span><span class="o">-&gt;</span><span class="n">link_params</span><span class="p">.</span><span class="n">speed_cap_mask</span><span class="p">[</span><span class="n">idx</span><span class="p">]);</span>
				<span class="k">return</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">PORT_FEATURE_LINK_SPEED_10M_HALF</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">supported</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">SUPPORTED_10baseT_Half</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">bp</span><span class="o">-&gt;</span><span class="n">link_params</span><span class="p">.</span><span class="n">req_line_speed</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span>
					<span class="n">SPEED_10</span><span class="p">;</span>
				<span class="n">bp</span><span class="o">-&gt;</span><span class="n">link_params</span><span class="p">.</span><span class="n">req_duplex</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span>
					<span class="n">DUPLEX_HALF</span><span class="p">;</span>
				<span class="n">bp</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">advertising</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">|=</span>
					<span class="p">(</span><span class="n">ADVERTISED_10baseT_Half</span> <span class="o">|</span>
					 <span class="n">ADVERTISED_TP</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">BNX2X_ERR</span><span class="p">(</span><span class="s">&quot;NVRAM config error. Invalid link_config 0x%x  speed_cap_mask 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					    <span class="n">link_config</span><span class="p">,</span>
					  <span class="n">bp</span><span class="o">-&gt;</span><span class="n">link_params</span><span class="p">.</span><span class="n">speed_cap_mask</span><span class="p">[</span><span class="n">idx</span><span class="p">]);</span>
				<span class="k">return</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">PORT_FEATURE_LINK_SPEED_100M_FULL</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">supported</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">&amp;</span>
			    <span class="n">SUPPORTED_100baseT_Full</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">bp</span><span class="o">-&gt;</span><span class="n">link_params</span><span class="p">.</span><span class="n">req_line_speed</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span>
					<span class="n">SPEED_100</span><span class="p">;</span>
				<span class="n">bp</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">advertising</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">|=</span>
					<span class="p">(</span><span class="n">ADVERTISED_100baseT_Full</span> <span class="o">|</span>
					 <span class="n">ADVERTISED_TP</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">BNX2X_ERR</span><span class="p">(</span><span class="s">&quot;NVRAM config error. Invalid link_config 0x%x  speed_cap_mask 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					    <span class="n">link_config</span><span class="p">,</span>
					  <span class="n">bp</span><span class="o">-&gt;</span><span class="n">link_params</span><span class="p">.</span><span class="n">speed_cap_mask</span><span class="p">[</span><span class="n">idx</span><span class="p">]);</span>
				<span class="k">return</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">PORT_FEATURE_LINK_SPEED_100M_HALF</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">supported</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">&amp;</span>
			    <span class="n">SUPPORTED_100baseT_Half</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">bp</span><span class="o">-&gt;</span><span class="n">link_params</span><span class="p">.</span><span class="n">req_line_speed</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span>
								<span class="n">SPEED_100</span><span class="p">;</span>
				<span class="n">bp</span><span class="o">-&gt;</span><span class="n">link_params</span><span class="p">.</span><span class="n">req_duplex</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span>
								<span class="n">DUPLEX_HALF</span><span class="p">;</span>
				<span class="n">bp</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">advertising</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">|=</span>
					<span class="p">(</span><span class="n">ADVERTISED_100baseT_Half</span> <span class="o">|</span>
					 <span class="n">ADVERTISED_TP</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">BNX2X_ERR</span><span class="p">(</span><span class="s">&quot;NVRAM config error. Invalid link_config 0x%x  speed_cap_mask 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				    <span class="n">link_config</span><span class="p">,</span>
				    <span class="n">bp</span><span class="o">-&gt;</span><span class="n">link_params</span><span class="p">.</span><span class="n">speed_cap_mask</span><span class="p">[</span><span class="n">idx</span><span class="p">]);</span>
				<span class="k">return</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">PORT_FEATURE_LINK_SPEED_1G</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">supported</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">&amp;</span>
			    <span class="n">SUPPORTED_1000baseT_Full</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">bp</span><span class="o">-&gt;</span><span class="n">link_params</span><span class="p">.</span><span class="n">req_line_speed</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span>
					<span class="n">SPEED_1000</span><span class="p">;</span>
				<span class="n">bp</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">advertising</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">|=</span>
					<span class="p">(</span><span class="n">ADVERTISED_1000baseT_Full</span> <span class="o">|</span>
					 <span class="n">ADVERTISED_TP</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">BNX2X_ERR</span><span class="p">(</span><span class="s">&quot;NVRAM config error. Invalid link_config 0x%x  speed_cap_mask 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				    <span class="n">link_config</span><span class="p">,</span>
				    <span class="n">bp</span><span class="o">-&gt;</span><span class="n">link_params</span><span class="p">.</span><span class="n">speed_cap_mask</span><span class="p">[</span><span class="n">idx</span><span class="p">]);</span>
				<span class="k">return</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">PORT_FEATURE_LINK_SPEED_2_5G</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">supported</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">&amp;</span>
			    <span class="n">SUPPORTED_2500baseX_Full</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">bp</span><span class="o">-&gt;</span><span class="n">link_params</span><span class="p">.</span><span class="n">req_line_speed</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span>
					<span class="n">SPEED_2500</span><span class="p">;</span>
				<span class="n">bp</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">advertising</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">|=</span>
					<span class="p">(</span><span class="n">ADVERTISED_2500baseX_Full</span> <span class="o">|</span>
						<span class="n">ADVERTISED_TP</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">BNX2X_ERR</span><span class="p">(</span><span class="s">&quot;NVRAM config error. Invalid link_config 0x%x  speed_cap_mask 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				    <span class="n">link_config</span><span class="p">,</span>
				    <span class="n">bp</span><span class="o">-&gt;</span><span class="n">link_params</span><span class="p">.</span><span class="n">speed_cap_mask</span><span class="p">[</span><span class="n">idx</span><span class="p">]);</span>
				<span class="k">return</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">PORT_FEATURE_LINK_SPEED_10G_CX4</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">supported</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">&amp;</span>
			    <span class="n">SUPPORTED_10000baseT_Full</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">bp</span><span class="o">-&gt;</span><span class="n">link_params</span><span class="p">.</span><span class="n">req_line_speed</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span>
					<span class="n">SPEED_10000</span><span class="p">;</span>
				<span class="n">bp</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">advertising</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">|=</span>
					<span class="p">(</span><span class="n">ADVERTISED_10000baseT_Full</span> <span class="o">|</span>
						<span class="n">ADVERTISED_FIBRE</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">BNX2X_ERR</span><span class="p">(</span><span class="s">&quot;NVRAM config error. Invalid link_config 0x%x  speed_cap_mask 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				    <span class="n">link_config</span><span class="p">,</span>
				    <span class="n">bp</span><span class="o">-&gt;</span><span class="n">link_params</span><span class="p">.</span><span class="n">speed_cap_mask</span><span class="p">[</span><span class="n">idx</span><span class="p">]);</span>
				<span class="k">return</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">PORT_FEATURE_LINK_SPEED_20G</span>:
			<span class="n">bp</span><span class="o">-&gt;</span><span class="n">link_params</span><span class="p">.</span><span class="n">req_line_speed</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">SPEED_20000</span><span class="p">;</span>

			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">BNX2X_ERR</span><span class="p">(</span><span class="s">&quot;NVRAM config error. BAD link speed link_config 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				  <span class="n">link_config</span><span class="p">);</span>
				<span class="n">bp</span><span class="o">-&gt;</span><span class="n">link_params</span><span class="p">.</span><span class="n">req_line_speed</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span>
							<span class="n">SPEED_AUTO_NEG</span><span class="p">;</span>
				<span class="n">bp</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">advertising</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span>
						<span class="n">bp</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">supported</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">bp</span><span class="o">-&gt;</span><span class="n">link_params</span><span class="p">.</span><span class="n">req_flow_ctrl</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">link_config</span> <span class="o">&amp;</span>
					 <span class="n">PORT_FEATURE_FLOW_CONTROL_MASK</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">link_params</span><span class="p">.</span><span class="n">req_flow_ctrl</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">==</span>
		     <span class="n">BNX2X_FLOW_CTRL_AUTO</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="o">!</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">supported</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">SUPPORTED_Autoneg</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">bp</span><span class="o">-&gt;</span><span class="n">link_params</span><span class="p">.</span><span class="n">req_flow_ctrl</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span>
				<span class="n">BNX2X_FLOW_CTRL_NONE</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">BNX2X_DEV_INFO</span><span class="p">(</span><span class="s">&quot;req_line_speed %d  req_duplex %d req_flow_ctrl 0x%x advertising 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">bp</span><span class="o">-&gt;</span><span class="n">link_params</span><span class="p">.</span><span class="n">req_line_speed</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span>
			       <span class="n">bp</span><span class="o">-&gt;</span><span class="n">link_params</span><span class="p">.</span><span class="n">req_duplex</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span>
			       <span class="n">bp</span><span class="o">-&gt;</span><span class="n">link_params</span><span class="p">.</span><span class="n">req_flow_ctrl</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span>
			       <span class="n">bp</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">advertising</span><span class="p">[</span><span class="n">idx</span><span class="p">]);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span> <span class="nf">bnx2x_set_mac_buf</span><span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="n">mac_buf</span><span class="p">,</span> <span class="n">u32</span> <span class="n">mac_lo</span><span class="p">,</span> <span class="n">u16</span> <span class="n">mac_hi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mac_hi</span> <span class="o">=</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="n">mac_hi</span><span class="p">);</span>
	<span class="n">mac_lo</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">mac_lo</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">mac_buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mac_hi</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mac_hi</span><span class="p">));</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">mac_buf</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mac_hi</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">mac_lo</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mac_lo</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span> <span class="nf">bnx2x_get_port_hwinfo</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">port</span> <span class="o">=</span> <span class="n">BP_PORT</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">config</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ext_phy_type</span><span class="p">,</span> <span class="n">ext_phy_config</span><span class="p">;</span>

	<span class="n">bp</span><span class="o">-&gt;</span><span class="n">link_params</span><span class="p">.</span><span class="n">bp</span> <span class="o">=</span> <span class="n">bp</span><span class="p">;</span>
	<span class="n">bp</span><span class="o">-&gt;</span><span class="n">link_params</span><span class="p">.</span><span class="n">port</span> <span class="o">=</span> <span class="n">port</span><span class="p">;</span>

	<span class="n">bp</span><span class="o">-&gt;</span><span class="n">link_params</span><span class="p">.</span><span class="n">lane_config</span> <span class="o">=</span>
		<span class="n">SHMEM_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">dev_info</span><span class="p">.</span><span class="n">port_hw_config</span><span class="p">[</span><span class="n">port</span><span class="p">].</span><span class="n">lane_config</span><span class="p">);</span>

	<span class="n">bp</span><span class="o">-&gt;</span><span class="n">link_params</span><span class="p">.</span><span class="n">speed_cap_mask</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span>
		<span class="n">SHMEM_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span>
			 <span class="n">dev_info</span><span class="p">.</span><span class="n">port_hw_config</span><span class="p">[</span><span class="n">port</span><span class="p">].</span><span class="n">speed_capability_mask</span><span class="p">);</span>
	<span class="n">bp</span><span class="o">-&gt;</span><span class="n">link_params</span><span class="p">.</span><span class="n">speed_cap_mask</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span>
		<span class="n">SHMEM_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span>
			 <span class="n">dev_info</span><span class="p">.</span><span class="n">port_hw_config</span><span class="p">[</span><span class="n">port</span><span class="p">].</span><span class="n">speed_capability_mask2</span><span class="p">);</span>
	<span class="n">bp</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">link_config</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span>
		<span class="n">SHMEM_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">dev_info</span><span class="p">.</span><span class="n">port_feature_config</span><span class="p">[</span><span class="n">port</span><span class="p">].</span><span class="n">link_config</span><span class="p">);</span>

	<span class="n">bp</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">link_config</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span>
		<span class="n">SHMEM_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">dev_info</span><span class="p">.</span><span class="n">port_feature_config</span><span class="p">[</span><span class="n">port</span><span class="p">].</span><span class="n">link_config2</span><span class="p">);</span>

	<span class="n">bp</span><span class="o">-&gt;</span><span class="n">link_params</span><span class="p">.</span><span class="n">multi_phy_config</span> <span class="o">=</span>
		<span class="n">SHMEM_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">dev_info</span><span class="p">.</span><span class="n">port_hw_config</span><span class="p">[</span><span class="n">port</span><span class="p">].</span><span class="n">multi_phy_config</span><span class="p">);</span>
	<span class="cm">/* If the device is capable of WoL, set the default state according</span>
<span class="cm">	 * to the HW</span>
<span class="cm">	 */</span>
	<span class="n">config</span> <span class="o">=</span> <span class="n">SHMEM_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">dev_info</span><span class="p">.</span><span class="n">port_feature_config</span><span class="p">[</span><span class="n">port</span><span class="p">].</span><span class="n">config</span><span class="p">);</span>
	<span class="n">bp</span><span class="o">-&gt;</span><span class="n">wol</span> <span class="o">=</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">NO_WOL_FLAG</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		   <span class="p">(</span><span class="n">config</span> <span class="o">&amp;</span> <span class="n">PORT_FEATURE_WOL_ENABLED</span><span class="p">));</span>

	<span class="n">BNX2X_DEV_INFO</span><span class="p">(</span><span class="s">&quot;lane_config 0x%08x  speed_cap_mask0 0x%08x  link_config0 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">bp</span><span class="o">-&gt;</span><span class="n">link_params</span><span class="p">.</span><span class="n">lane_config</span><span class="p">,</span>
		       <span class="n">bp</span><span class="o">-&gt;</span><span class="n">link_params</span><span class="p">.</span><span class="n">speed_cap_mask</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
		       <span class="n">bp</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">link_config</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>

	<span class="n">bp</span><span class="o">-&gt;</span><span class="n">link_params</span><span class="p">.</span><span class="n">switch_cfg</span> <span class="o">=</span> <span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">link_config</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span>
				      <span class="n">PORT_FEATURE_CONNECTED_SWITCH_MASK</span><span class="p">);</span>
	<span class="n">bnx2x_phy_probe</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">link_params</span><span class="p">);</span>
	<span class="n">bnx2x_link_settings_supported</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">link_params</span><span class="p">.</span><span class="n">switch_cfg</span><span class="p">);</span>

	<span class="n">bnx2x_link_settings_requested</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * If connected directly, work with the internal PHY, otherwise, work</span>
<span class="cm">	 * with the external PHY</span>
<span class="cm">	 */</span>
	<span class="n">ext_phy_config</span> <span class="o">=</span>
		<span class="n">SHMEM_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span>
			 <span class="n">dev_info</span><span class="p">.</span><span class="n">port_hw_config</span><span class="p">[</span><span class="n">port</span><span class="p">].</span><span class="n">external_phy_config</span><span class="p">);</span>
	<span class="n">ext_phy_type</span> <span class="o">=</span> <span class="n">XGXS_EXT_PHY_TYPE</span><span class="p">(</span><span class="n">ext_phy_config</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ext_phy_type</span> <span class="o">==</span> <span class="n">PORT_HW_CFG_XGXS_EXT_PHY_TYPE_DIRECT</span><span class="p">)</span>
		<span class="n">bp</span><span class="o">-&gt;</span><span class="n">mdio</span><span class="p">.</span><span class="n">prtad</span> <span class="o">=</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">phy_addr</span><span class="p">;</span>

	<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">ext_phy_type</span> <span class="o">!=</span> <span class="n">PORT_HW_CFG_XGXS_EXT_PHY_TYPE_FAILURE</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		 <span class="p">(</span><span class="n">ext_phy_type</span> <span class="o">!=</span> <span class="n">PORT_HW_CFG_XGXS_EXT_PHY_TYPE_NOT_CONN</span><span class="p">))</span>
		<span class="n">bp</span><span class="o">-&gt;</span><span class="n">mdio</span><span class="p">.</span><span class="n">prtad</span> <span class="o">=</span>
			<span class="n">XGXS_EXT_PHY_ADDR</span><span class="p">(</span><span class="n">ext_phy_config</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Check if hw lock is required to access MDC/MDIO bus to the PHY(s)</span>
<span class="cm">	 * In MF mode, it is set to cover self test cases</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_MF</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span>
		<span class="n">bp</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">need_hw_lock</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">bp</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">need_hw_lock</span> <span class="o">=</span> <span class="n">bnx2x_hw_lock_required</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span>
							<span class="n">bp</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">.</span><span class="n">shmem_base</span><span class="p">,</span>
							<span class="n">bp</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">.</span><span class="n">shmem2_base</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">bnx2x_get_iscsi_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">no_flags</span> <span class="o">=</span> <span class="n">NO_ISCSI_FLAG</span><span class="p">;</span>
<span class="cp">#ifdef BCM_CNIC</span>
	<span class="kt">int</span> <span class="n">port</span> <span class="o">=</span> <span class="n">BP_PORT</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>

	<span class="n">u32</span> <span class="n">max_iscsi_conn</span> <span class="o">=</span> <span class="n">FW_ENCODE_32BIT_PATTERN</span> <span class="o">^</span> <span class="n">SHMEM_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span>
				<span class="n">drv_lic_key</span><span class="p">[</span><span class="n">port</span><span class="p">].</span><span class="n">max_iscsi_conn</span><span class="p">);</span>

	<span class="cm">/* Get the number of maximum allowed iSCSI connections */</span>
	<span class="n">bp</span><span class="o">-&gt;</span><span class="n">cnic_eth_dev</span><span class="p">.</span><span class="n">max_iscsi_conn</span> <span class="o">=</span>
		<span class="p">(</span><span class="n">max_iscsi_conn</span> <span class="o">&amp;</span> <span class="n">BNX2X_MAX_ISCSI_INIT_CONN_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span>
		<span class="n">BNX2X_MAX_ISCSI_INIT_CONN_SHIFT</span><span class="p">;</span>

	<span class="n">BNX2X_DEV_INFO</span><span class="p">(</span><span class="s">&quot;max_iscsi_conn 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">bp</span><span class="o">-&gt;</span><span class="n">cnic_eth_dev</span><span class="p">.</span><span class="n">max_iscsi_conn</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * If maximum allowed number of connections is zero -</span>
<span class="cm">	 * disable the feature.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">cnic_eth_dev</span><span class="p">.</span><span class="n">max_iscsi_conn</span><span class="p">)</span>
		<span class="n">bp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">no_flags</span><span class="p">;</span>
<span class="cp">#else</span>
	<span class="n">bp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">no_flags</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="cp">#ifdef BCM_CNIC</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span> <span class="nf">bnx2x_get_ext_wwn_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">func</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Port info */</span>
	<span class="n">bp</span><span class="o">-&gt;</span><span class="n">cnic_eth_dev</span><span class="p">.</span><span class="n">fcoe_wwn_port_name_hi</span> <span class="o">=</span>
		<span class="n">MF_CFG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">func_ext_config</span><span class="p">[</span><span class="n">func</span><span class="p">].</span><span class="n">fcoe_wwn_port_name_upper</span><span class="p">);</span>
	<span class="n">bp</span><span class="o">-&gt;</span><span class="n">cnic_eth_dev</span><span class="p">.</span><span class="n">fcoe_wwn_port_name_lo</span> <span class="o">=</span>
		<span class="n">MF_CFG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">func_ext_config</span><span class="p">[</span><span class="n">func</span><span class="p">].</span><span class="n">fcoe_wwn_port_name_lower</span><span class="p">);</span>

	<span class="cm">/* Node info */</span>
	<span class="n">bp</span><span class="o">-&gt;</span><span class="n">cnic_eth_dev</span><span class="p">.</span><span class="n">fcoe_wwn_node_name_hi</span> <span class="o">=</span>
		<span class="n">MF_CFG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">func_ext_config</span><span class="p">[</span><span class="n">func</span><span class="p">].</span><span class="n">fcoe_wwn_node_name_upper</span><span class="p">);</span>
	<span class="n">bp</span><span class="o">-&gt;</span><span class="n">cnic_eth_dev</span><span class="p">.</span><span class="n">fcoe_wwn_node_name_lo</span> <span class="o">=</span>
		<span class="n">MF_CFG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">func_ext_config</span><span class="p">[</span><span class="n">func</span><span class="p">].</span><span class="n">fcoe_wwn_node_name_lower</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span> <span class="nf">bnx2x_get_fcoe_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef BCM_CNIC</span>
	<span class="kt">int</span> <span class="n">port</span> <span class="o">=</span> <span class="n">BP_PORT</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">func</span> <span class="o">=</span> <span class="n">BP_ABS_FUNC</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>

	<span class="n">u32</span> <span class="n">max_fcoe_conn</span> <span class="o">=</span> <span class="n">FW_ENCODE_32BIT_PATTERN</span> <span class="o">^</span> <span class="n">SHMEM_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span>
				<span class="n">drv_lic_key</span><span class="p">[</span><span class="n">port</span><span class="p">].</span><span class="n">max_fcoe_conn</span><span class="p">);</span>

	<span class="cm">/* Get the number of maximum allowed FCoE connections */</span>
	<span class="n">bp</span><span class="o">-&gt;</span><span class="n">cnic_eth_dev</span><span class="p">.</span><span class="n">max_fcoe_conn</span> <span class="o">=</span>
		<span class="p">(</span><span class="n">max_fcoe_conn</span> <span class="o">&amp;</span> <span class="n">BNX2X_MAX_FCOE_INIT_CONN_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span>
		<span class="n">BNX2X_MAX_FCOE_INIT_CONN_SHIFT</span><span class="p">;</span>

	<span class="cm">/* Read the WWN: */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_MF</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Port info */</span>
		<span class="n">bp</span><span class="o">-&gt;</span><span class="n">cnic_eth_dev</span><span class="p">.</span><span class="n">fcoe_wwn_port_name_hi</span> <span class="o">=</span>
			<span class="n">SHMEM_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span>
				<span class="n">dev_info</span><span class="p">.</span><span class="n">port_hw_config</span><span class="p">[</span><span class="n">port</span><span class="p">].</span>
				 <span class="n">fcoe_wwn_port_name_upper</span><span class="p">);</span>
		<span class="n">bp</span><span class="o">-&gt;</span><span class="n">cnic_eth_dev</span><span class="p">.</span><span class="n">fcoe_wwn_port_name_lo</span> <span class="o">=</span>
			<span class="n">SHMEM_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span>
				<span class="n">dev_info</span><span class="p">.</span><span class="n">port_hw_config</span><span class="p">[</span><span class="n">port</span><span class="p">].</span>
				 <span class="n">fcoe_wwn_port_name_lower</span><span class="p">);</span>

		<span class="cm">/* Node info */</span>
		<span class="n">bp</span><span class="o">-&gt;</span><span class="n">cnic_eth_dev</span><span class="p">.</span><span class="n">fcoe_wwn_node_name_hi</span> <span class="o">=</span>
			<span class="n">SHMEM_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span>
				<span class="n">dev_info</span><span class="p">.</span><span class="n">port_hw_config</span><span class="p">[</span><span class="n">port</span><span class="p">].</span>
				 <span class="n">fcoe_wwn_node_name_upper</span><span class="p">);</span>
		<span class="n">bp</span><span class="o">-&gt;</span><span class="n">cnic_eth_dev</span><span class="p">.</span><span class="n">fcoe_wwn_node_name_lo</span> <span class="o">=</span>
			<span class="n">SHMEM_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span>
				<span class="n">dev_info</span><span class="p">.</span><span class="n">port_hw_config</span><span class="p">[</span><span class="n">port</span><span class="p">].</span>
				 <span class="n">fcoe_wwn_node_name_lower</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_MF_SD</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">cfg</span> <span class="o">=</span> <span class="n">MF_CFG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">func_ext_config</span><span class="p">[</span><span class="n">func</span><span class="p">].</span><span class="n">func_cfg</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * Read the WWN info only if the FCoE feature is enabled for</span>
<span class="cm">		 * this function.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cfg</span> <span class="o">&amp;</span> <span class="n">MACP_FUNC_CFG_FLAGS_FCOE_OFFLOAD</span><span class="p">)</span>
			<span class="n">bnx2x_get_ext_wwn_info</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">func</span><span class="p">);</span>

	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">IS_MF_FCOE_SD</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span>
		<span class="n">bnx2x_get_ext_wwn_info</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">func</span><span class="p">);</span>

	<span class="n">BNX2X_DEV_INFO</span><span class="p">(</span><span class="s">&quot;max_fcoe_conn 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">cnic_eth_dev</span><span class="p">.</span><span class="n">max_fcoe_conn</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * If maximum allowed number of connections is zero -</span>
<span class="cm">	 * disable the feature.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">cnic_eth_dev</span><span class="p">.</span><span class="n">max_fcoe_conn</span><span class="p">)</span>
		<span class="n">bp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">NO_FCOE_FLAG</span><span class="p">;</span>
<span class="cp">#else</span>
	<span class="n">bp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">NO_FCOE_FLAG</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span> <span class="nf">bnx2x_get_cnic_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * iSCSI may be dynamically disabled but reading</span>
<span class="cm">	 * info here we will decrease memory usage by driver</span>
<span class="cm">	 * if the feature is disabled for good</span>
<span class="cm">	 */</span>
	<span class="n">bnx2x_get_iscsi_info</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
	<span class="n">bnx2x_get_fcoe_info</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span> <span class="nf">bnx2x_get_mac_hwinfo</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">,</span> <span class="n">val2</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">func</span> <span class="o">=</span> <span class="n">BP_ABS_FUNC</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">port</span> <span class="o">=</span> <span class="n">BP_PORT</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
<span class="cp">#ifdef BCM_CNIC</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">iscsi_mac</span> <span class="o">=</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">cnic_eth_dev</span><span class="p">.</span><span class="n">iscsi_mac</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">fip_mac</span> <span class="o">=</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">fip_mac</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="cm">/* Zero primary MAC configuration */</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">BP_NOMCP</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">BNX2X_ERROR</span><span class="p">(</span><span class="s">&quot;warning: random MAC workaround active</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">eth_hw_addr_random</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">IS_MF</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">val2</span> <span class="o">=</span> <span class="n">MF_CFG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">func_mf_config</span><span class="p">[</span><span class="n">func</span><span class="p">].</span><span class="n">mac_upper</span><span class="p">);</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">MF_CFG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">func_mf_config</span><span class="p">[</span><span class="n">func</span><span class="p">].</span><span class="n">mac_lower</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">val2</span> <span class="o">!=</span> <span class="n">FUNC_MF_CFG_UPPERMAC_DEFAULT</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">val</span> <span class="o">!=</span> <span class="n">FUNC_MF_CFG_LOWERMAC_DEFAULT</span><span class="p">))</span>
			<span class="n">bnx2x_set_mac_buf</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">val2</span><span class="p">);</span>

<span class="cp">#ifdef BCM_CNIC</span>
		<span class="cm">/*</span>
<span class="cm">		 * iSCSI and FCoE NPAR MACs: if there is no either iSCSI or</span>
<span class="cm">		 * FCoE MAC then the appropriate feature should be disabled.</span>
<span class="cm">		 *</span>
<span class="cm">		 * In non SD mode features configuration comes from</span>
<span class="cm">		 * struct func_ext_config.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_MF_SD</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">u32</span> <span class="n">cfg</span> <span class="o">=</span> <span class="n">MF_CFG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">func_ext_config</span><span class="p">[</span><span class="n">func</span><span class="p">].</span><span class="n">func_cfg</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cfg</span> <span class="o">&amp;</span> <span class="n">MACP_FUNC_CFG_FLAGS_ISCSI_OFFLOAD</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">val2</span> <span class="o">=</span> <span class="n">MF_CFG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">func_ext_config</span><span class="p">[</span><span class="n">func</span><span class="p">].</span>
						     <span class="n">iscsi_mac_addr_upper</span><span class="p">);</span>
				<span class="n">val</span> <span class="o">=</span> <span class="n">MF_CFG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">func_ext_config</span><span class="p">[</span><span class="n">func</span><span class="p">].</span>
						    <span class="n">iscsi_mac_addr_lower</span><span class="p">);</span>
				<span class="n">bnx2x_set_mac_buf</span><span class="p">(</span><span class="n">iscsi_mac</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">val2</span><span class="p">);</span>
				<span class="n">BNX2X_DEV_INFO</span><span class="p">(</span><span class="s">&quot;Read iSCSI MAC: %pM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					       <span class="n">iscsi_mac</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="n">bp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">NO_ISCSI_OOO_FLAG</span> <span class="o">|</span> <span class="n">NO_ISCSI_FLAG</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">cfg</span> <span class="o">&amp;</span> <span class="n">MACP_FUNC_CFG_FLAGS_FCOE_OFFLOAD</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">val2</span> <span class="o">=</span> <span class="n">MF_CFG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">func_ext_config</span><span class="p">[</span><span class="n">func</span><span class="p">].</span>
						     <span class="n">fcoe_mac_addr_upper</span><span class="p">);</span>
				<span class="n">val</span> <span class="o">=</span> <span class="n">MF_CFG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">func_ext_config</span><span class="p">[</span><span class="n">func</span><span class="p">].</span>
						    <span class="n">fcoe_mac_addr_lower</span><span class="p">);</span>
				<span class="n">bnx2x_set_mac_buf</span><span class="p">(</span><span class="n">fip_mac</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">val2</span><span class="p">);</span>
				<span class="n">BNX2X_DEV_INFO</span><span class="p">(</span><span class="s">&quot;Read FCoE L2 MAC: %pM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					       <span class="n">fip_mac</span><span class="p">);</span>

			<span class="p">}</span> <span class="k">else</span>
				<span class="n">bp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">NO_FCOE_FLAG</span><span class="p">;</span>

			<span class="n">bp</span><span class="o">-&gt;</span><span class="n">mf_ext_config</span> <span class="o">=</span> <span class="n">cfg</span><span class="p">;</span>

		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="cm">/* SD MODE */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">IS_MF_STORAGE_SD</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">BNX2X_IS_MF_SD_PROTOCOL_ISCSI</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span> <span class="p">{</span>
					<span class="cm">/* use primary mac as iscsi mac */</span>
					<span class="n">memcpy</span><span class="p">(</span><span class="n">iscsi_mac</span><span class="p">,</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span>
					       <span class="n">ETH_ALEN</span><span class="p">);</span>

					<span class="n">BNX2X_DEV_INFO</span><span class="p">(</span><span class="s">&quot;SD ISCSI MODE</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
					<span class="n">BNX2X_DEV_INFO</span><span class="p">(</span><span class="s">&quot;Read iSCSI MAC: %pM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						       <span class="n">iscsi_mac</span><span class="p">);</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="cm">/* FCoE */</span>
					<span class="n">memcpy</span><span class="p">(</span><span class="n">fip_mac</span><span class="p">,</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span>
					       <span class="n">ETH_ALEN</span><span class="p">);</span>
					<span class="n">BNX2X_DEV_INFO</span><span class="p">(</span><span class="s">&quot;SD FCoE MODE</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
					<span class="n">BNX2X_DEV_INFO</span><span class="p">(</span><span class="s">&quot;Read FIP MAC: %pM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						       <span class="n">fip_mac</span><span class="p">);</span>
				<span class="p">}</span>
				<span class="cm">/* Zero primary MAC configuration */</span>
				<span class="n">memset</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">IS_MF_FCOE_AFEX</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span>
			<span class="cm">/* use FIP MAC as primary MAC */</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">fip_mac</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>

<span class="cp">#endif</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* in SF read MACs from port configuration */</span>
		<span class="n">val2</span> <span class="o">=</span> <span class="n">SHMEM_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">dev_info</span><span class="p">.</span><span class="n">port_hw_config</span><span class="p">[</span><span class="n">port</span><span class="p">].</span><span class="n">mac_upper</span><span class="p">);</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">SHMEM_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">dev_info</span><span class="p">.</span><span class="n">port_hw_config</span><span class="p">[</span><span class="n">port</span><span class="p">].</span><span class="n">mac_lower</span><span class="p">);</span>
		<span class="n">bnx2x_set_mac_buf</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">val2</span><span class="p">);</span>

<span class="cp">#ifdef BCM_CNIC</span>
		<span class="n">val2</span> <span class="o">=</span> <span class="n">SHMEM_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">dev_info</span><span class="p">.</span><span class="n">port_hw_config</span><span class="p">[</span><span class="n">port</span><span class="p">].</span>
				    <span class="n">iscsi_mac_upper</span><span class="p">);</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">SHMEM_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">dev_info</span><span class="p">.</span><span class="n">port_hw_config</span><span class="p">[</span><span class="n">port</span><span class="p">].</span>
				   <span class="n">iscsi_mac_lower</span><span class="p">);</span>
		<span class="n">bnx2x_set_mac_buf</span><span class="p">(</span><span class="n">iscsi_mac</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">val2</span><span class="p">);</span>

		<span class="n">val2</span> <span class="o">=</span> <span class="n">SHMEM_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">dev_info</span><span class="p">.</span><span class="n">port_hw_config</span><span class="p">[</span><span class="n">port</span><span class="p">].</span>
				    <span class="n">fcoe_fip_mac_upper</span><span class="p">);</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">SHMEM_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">dev_info</span><span class="p">.</span><span class="n">port_hw_config</span><span class="p">[</span><span class="n">port</span><span class="p">].</span>
				   <span class="n">fcoe_fip_mac_lower</span><span class="p">);</span>
		<span class="n">bnx2x_set_mac_buf</span><span class="p">(</span><span class="n">fip_mac</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">val2</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="p">}</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">link_params</span><span class="p">.</span><span class="n">mac_addr</span><span class="p">,</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">perm_addr</span><span class="p">,</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>

<span class="cp">#ifdef BCM_CNIC</span>
	<span class="cm">/* Disable iSCSI if MAC configuration is</span>
<span class="cm">	 * invalid.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_valid_ether_addr</span><span class="p">(</span><span class="n">iscsi_mac</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">bp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">NO_ISCSI_FLAG</span><span class="p">;</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">iscsi_mac</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Disable FCoE if MAC configuration is</span>
<span class="cm">	 * invalid.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_valid_ether_addr</span><span class="p">(</span><span class="n">fip_mac</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">bp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">NO_FCOE_FLAG</span><span class="p">;</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">fip_mac</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bnx2x_is_valid_ether_addr</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">))</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;bad Ethernet MAC address configuration: %pM</span><span class="se">\n</span><span class="s">&quot;</span>
			<span class="s">&quot;change it manually before bringing up the appropriate network interface</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">bp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">);</span>


<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">bnx2x_get_hwinfo</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="cm">/*abs*/</span><span class="n">func</span> <span class="o">=</span> <span class="n">BP_ABS_FUNC</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">vn</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">bnx2x_get_common_hwinfo</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * initialize IGU parameters</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">CHIP_IS_E1x</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">bp</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">.</span><span class="n">int_block</span> <span class="o">=</span> <span class="n">INT_BLOCK_HC</span><span class="p">;</span>

		<span class="n">bp</span><span class="o">-&gt;</span><span class="n">igu_dsb_id</span> <span class="o">=</span> <span class="n">DEF_SB_IGU_ID</span><span class="p">;</span>
		<span class="n">bp</span><span class="o">-&gt;</span><span class="n">igu_base_sb</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">bp</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">.</span><span class="n">int_block</span> <span class="o">=</span> <span class="n">INT_BLOCK_IGU</span><span class="p">;</span>

		<span class="cm">/* do not allow device reset during IGU info preocessing */</span>
		<span class="n">bnx2x_acquire_hw_lock</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">HW_LOCK_RESOURCE_RESET</span><span class="p">);</span>

		<span class="n">val</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">IGU_REG_BLOCK_CONFIGURATION</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">IGU_BLOCK_CONFIGURATION_REG_BACKWARD_COMP_EN</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">tout</span> <span class="o">=</span> <span class="mi">5000</span><span class="p">;</span>

			<span class="n">BNX2X_DEV_INFO</span><span class="p">(</span><span class="s">&quot;FORCING Normal Mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

			<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">IGU_BLOCK_CONFIGURATION_REG_BACKWARD_COMP_EN</span><span class="p">);</span>
			<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">IGU_REG_BLOCK_CONFIGURATION</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
			<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">IGU_REG_RESET_MEMORIES</span><span class="p">,</span> <span class="mh">0x7f</span><span class="p">);</span>

			<span class="k">while</span> <span class="p">(</span><span class="n">tout</span> <span class="o">&amp;&amp;</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">IGU_REG_RESET_MEMORIES</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">tout</span><span class="o">--</span><span class="p">;</span>
				<span class="n">usleep_range</span><span class="p">(</span><span class="mi">1000</span><span class="p">,</span> <span class="mi">1000</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">IGU_REG_RESET_MEMORIES</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					<span class="s">&quot;FORCING Normal Mode failed!!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">IGU_BLOCK_CONFIGURATION_REG_BACKWARD_COMP_EN</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">BNX2X_DEV_INFO</span><span class="p">(</span><span class="s">&quot;IGU Backward Compatible Mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">bp</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">.</span><span class="n">int_block</span> <span class="o">|=</span> <span class="n">INT_BLOCK_MODE_BW_COMP</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">BNX2X_DEV_INFO</span><span class="p">(</span><span class="s">&quot;IGU Normal Mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="n">bnx2x_get_igu_cam_info</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>

		<span class="n">bnx2x_release_hw_lock</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">HW_LOCK_RESOURCE_RESET</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * set base FW non-default (fast path) status block id, this value is</span>
<span class="cm">	 * used to initialize the fw_sb_id saved on the fp/queue structure to</span>
<span class="cm">	 * determine the id used by the FW.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">CHIP_IS_E1x</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span>
		<span class="n">bp</span><span class="o">-&gt;</span><span class="n">base_fw_ndsb</span> <span class="o">=</span> <span class="n">BP_PORT</span><span class="p">(</span><span class="n">bp</span><span class="p">)</span> <span class="o">*</span> <span class="n">FP_SB_MAX_E1x</span> <span class="o">+</span> <span class="n">BP_L_ID</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
	<span class="k">else</span> <span class="cm">/*</span>
<span class="cm">	      * 57712 - we currently use one FW SB per IGU SB (Rx and Tx of</span>
<span class="cm">	      * the same queue are indicated on the same IGU SB). So we prefer</span>
<span class="cm">	      * FW and IGU SBs to be the same value.</span>
<span class="cm">	      */</span>
		<span class="n">bp</span><span class="o">-&gt;</span><span class="n">base_fw_ndsb</span> <span class="o">=</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">igu_base_sb</span><span class="p">;</span>

	<span class="n">BNX2X_DEV_INFO</span><span class="p">(</span><span class="s">&quot;igu_dsb_id %d  igu_base_sb %d  igu_sb_cnt %d</span><span class="se">\n</span><span class="s">&quot;</span>
		       <span class="s">&quot;base_fw_ndsb %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">igu_dsb_id</span><span class="p">,</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">igu_base_sb</span><span class="p">,</span>
		       <span class="n">bp</span><span class="o">-&gt;</span><span class="n">igu_sb_cnt</span><span class="p">,</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">base_fw_ndsb</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Initialize MF configuration</span>
<span class="cm">	 */</span>

	<span class="n">bp</span><span class="o">-&gt;</span><span class="n">mf_ov</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">bp</span><span class="o">-&gt;</span><span class="n">mf_mode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">vn</span> <span class="o">=</span> <span class="n">BP_VN</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CHIP_IS_E1</span><span class="p">(</span><span class="n">bp</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">BP_NOMCP</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">BNX2X_DEV_INFO</span><span class="p">(</span><span class="s">&quot;shmem2base 0x%x, size %d, mfcfg offset %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">bp</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">.</span><span class="n">shmem2_base</span><span class="p">,</span> <span class="n">SHMEM2_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">size</span><span class="p">),</span>
			      <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">shmem2_region</span><span class="p">,</span> <span class="n">mf_cfg_addr</span><span class="p">));</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">SHMEM2_HAS</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">mf_cfg_addr</span><span class="p">))</span>
			<span class="n">bp</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">.</span><span class="n">mf_cfg_base</span> <span class="o">=</span> <span class="n">SHMEM2_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">mf_cfg_addr</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">bp</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">.</span><span class="n">mf_cfg_base</span> <span class="o">=</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">.</span><span class="n">shmem_base</span> <span class="o">+</span>
				<span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">shmem_region</span><span class="p">,</span> <span class="n">func_mb</span><span class="p">)</span> <span class="o">+</span>
				<span class="n">E1H_FUNC_MAX</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">drv_func_mb</span><span class="p">);</span>
		<span class="cm">/*</span>
<span class="cm">		 * get mf configuration:</span>
<span class="cm">		 * 1. existence of MF configuration</span>
<span class="cm">		 * 2. MAC address must be legal (check only upper bytes)</span>
<span class="cm">		 *    for  Switch-Independent mode;</span>
<span class="cm">		 *    OVLAN must be legal for Switch-Dependent mode</span>
<span class="cm">		 * 3. SF_MODE configures specific MF mode</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">.</span><span class="n">mf_cfg_base</span> <span class="o">!=</span> <span class="n">SHMEM_MF_CFG_ADDR_NONE</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* get mf configuration */</span>
			<span class="n">val</span> <span class="o">=</span> <span class="n">SHMEM_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span>
				       <span class="n">dev_info</span><span class="p">.</span><span class="n">shared_feature_config</span><span class="p">.</span><span class="n">config</span><span class="p">);</span>
			<span class="n">val</span> <span class="o">&amp;=</span> <span class="n">SHARED_FEAT_CFG_FORCE_SF_MODE_MASK</span><span class="p">;</span>

			<span class="k">switch</span> <span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">SHARED_FEAT_CFG_FORCE_SF_MODE_SWITCH_INDEPT</span>:
				<span class="n">val</span> <span class="o">=</span> <span class="n">MF_CFG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">func_mf_config</span><span class="p">[</span><span class="n">func</span><span class="p">].</span>
						<span class="n">mac_upper</span><span class="p">);</span>
				<span class="cm">/* check for legal mac (upper bytes)*/</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">!=</span> <span class="mh">0xffff</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">bp</span><span class="o">-&gt;</span><span class="n">mf_mode</span> <span class="o">=</span> <span class="n">MULTI_FUNCTION_SI</span><span class="p">;</span>
					<span class="n">bp</span><span class="o">-&gt;</span><span class="n">mf_config</span><span class="p">[</span><span class="n">vn</span><span class="p">]</span> <span class="o">=</span> <span class="n">MF_CFG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span>
						   <span class="n">func_mf_config</span><span class="p">[</span><span class="n">func</span><span class="p">].</span><span class="n">config</span><span class="p">);</span>
				<span class="p">}</span> <span class="k">else</span>
					<span class="n">BNX2X_DEV_INFO</span><span class="p">(</span><span class="s">&quot;illegal MAC address for SI</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">SHARED_FEAT_CFG_FORCE_SF_MODE_AFEX_MODE</span>:
				<span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="n">CHIP_IS_E1x</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
				    <span class="p">(</span><span class="n">MF_CFG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">func_mf_config</span><span class="p">[</span><span class="n">func</span><span class="p">].</span>
					       <span class="n">mac_upper</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0xffff</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
				    <span class="p">(</span><span class="n">SHMEM2_HAS</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span>
						<span class="n">afex_driver_support</span><span class="p">)))</span> <span class="p">{</span>
					<span class="n">bp</span><span class="o">-&gt;</span><span class="n">mf_mode</span> <span class="o">=</span> <span class="n">MULTI_FUNCTION_AFEX</span><span class="p">;</span>
					<span class="n">bp</span><span class="o">-&gt;</span><span class="n">mf_config</span><span class="p">[</span><span class="n">vn</span><span class="p">]</span> <span class="o">=</span> <span class="n">MF_CFG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span>
						<span class="n">func_mf_config</span><span class="p">[</span><span class="n">func</span><span class="p">].</span><span class="n">config</span><span class="p">);</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">BNX2X_DEV_INFO</span><span class="p">(</span><span class="s">&quot;can not configure afex mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="p">}</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">SHARED_FEAT_CFG_FORCE_SF_MODE_MF_ALLOWED</span>:
				<span class="cm">/* get OV configuration */</span>
				<span class="n">val</span> <span class="o">=</span> <span class="n">MF_CFG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span>
					<span class="n">func_mf_config</span><span class="p">[</span><span class="n">FUNC_0</span><span class="p">].</span><span class="n">e1hov_tag</span><span class="p">);</span>
				<span class="n">val</span> <span class="o">&amp;=</span> <span class="n">FUNC_MF_CFG_E1HOV_TAG_MASK</span><span class="p">;</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">!=</span> <span class="n">FUNC_MF_CFG_E1HOV_TAG_DEFAULT</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">bp</span><span class="o">-&gt;</span><span class="n">mf_mode</span> <span class="o">=</span> <span class="n">MULTI_FUNCTION_SD</span><span class="p">;</span>
					<span class="n">bp</span><span class="o">-&gt;</span><span class="n">mf_config</span><span class="p">[</span><span class="n">vn</span><span class="p">]</span> <span class="o">=</span> <span class="n">MF_CFG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span>
						<span class="n">func_mf_config</span><span class="p">[</span><span class="n">func</span><span class="p">].</span><span class="n">config</span><span class="p">);</span>
				<span class="p">}</span> <span class="k">else</span>
					<span class="n">BNX2X_DEV_INFO</span><span class="p">(</span><span class="s">&quot;illegal OV for SD</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span>
				<span class="cm">/* Unknown configuration: reset mf_config */</span>
				<span class="n">bp</span><span class="o">-&gt;</span><span class="n">mf_config</span><span class="p">[</span><span class="n">vn</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">BNX2X_DEV_INFO</span><span class="p">(</span><span class="s">&quot;unknown MF mode 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="n">BNX2X_DEV_INFO</span><span class="p">(</span><span class="s">&quot;%s function mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">IS_MF</span><span class="p">(</span><span class="n">bp</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;multi&quot;</span> <span class="o">:</span> <span class="s">&quot;single&quot;</span><span class="p">);</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">mf_mode</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">MULTI_FUNCTION_SD</span>:
			<span class="n">val</span> <span class="o">=</span> <span class="n">MF_CFG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">func_mf_config</span><span class="p">[</span><span class="n">func</span><span class="p">].</span><span class="n">e1hov_tag</span><span class="p">)</span> <span class="o">&amp;</span>
			      <span class="n">FUNC_MF_CFG_E1HOV_TAG_MASK</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">!=</span> <span class="n">FUNC_MF_CFG_E1HOV_TAG_DEFAULT</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">bp</span><span class="o">-&gt;</span><span class="n">mf_ov</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
				<span class="n">bp</span><span class="o">-&gt;</span><span class="n">path_has_ovlan</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

				<span class="n">BNX2X_DEV_INFO</span><span class="p">(</span><span class="s">&quot;MF OV for func %d is %d (0x%04x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					       <span class="n">func</span><span class="p">,</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">mf_ov</span><span class="p">,</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">mf_ov</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					<span class="s">&quot;No valid MF OV for func %d, aborting</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">func</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MULTI_FUNCTION_AFEX</span>:
			<span class="n">BNX2X_DEV_INFO</span><span class="p">(</span><span class="s">&quot;func %d is in MF afex mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">func</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MULTI_FUNCTION_SI</span>:
			<span class="n">BNX2X_DEV_INFO</span><span class="p">(</span><span class="s">&quot;func %d is in MF switch-independent mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">func</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">vn</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					<span class="s">&quot;VN %d is in a single function mode, aborting</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">vn</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* check if other port on the path needs ovlan:</span>
<span class="cm">		 * Since MF configuration is shared between ports</span>
<span class="cm">		 * Possible mixed modes are only</span>
<span class="cm">		 * {SF, SI} {SF, SD} {SD, SF} {SI, SF}</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">CHIP_MODE_IS_4_PORT</span><span class="p">(</span><span class="n">bp</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="o">!</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">path_has_ovlan</span> <span class="o">&amp;&amp;</span>
		    <span class="o">!</span><span class="n">IS_MF</span><span class="p">(</span><span class="n">bp</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="n">bp</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">.</span><span class="n">mf_cfg_base</span> <span class="o">!=</span> <span class="n">SHMEM_MF_CFG_ADDR_NONE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u8</span> <span class="n">other_port</span> <span class="o">=</span> <span class="o">!</span><span class="n">BP_PORT</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
			<span class="n">u8</span> <span class="n">other_func</span> <span class="o">=</span> <span class="n">BP_PATH</span><span class="p">(</span><span class="n">bp</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">other_port</span><span class="p">;</span>
			<span class="n">val</span> <span class="o">=</span> <span class="n">MF_CFG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span>
					<span class="n">func_mf_config</span><span class="p">[</span><span class="n">other_func</span><span class="p">].</span><span class="n">e1hov_tag</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">!=</span> <span class="n">FUNC_MF_CFG_E1HOV_TAG_DEFAULT</span><span class="p">)</span>
				<span class="n">bp</span><span class="o">-&gt;</span><span class="n">path_has_ovlan</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* adjust igu_sb_cnt to MF for E1x */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">CHIP_IS_E1x</span><span class="p">(</span><span class="n">bp</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">IS_MF</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span>
		<span class="n">bp</span><span class="o">-&gt;</span><span class="n">igu_sb_cnt</span> <span class="o">/=</span> <span class="n">E1HVN_MAX</span><span class="p">;</span>

	<span class="cm">/* port info */</span>
	<span class="n">bnx2x_get_port_hwinfo</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>

	<span class="cm">/* Get MAC addresses */</span>
	<span class="n">bnx2x_get_mac_hwinfo</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>

	<span class="n">bnx2x_get_cnic_info</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span> <span class="nf">bnx2x_read_fwinfo</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">cnt</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">block_end</span><span class="p">,</span> <span class="n">rodi</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">vpd_start</span><span class="p">[</span><span class="n">BNX2X_VPD_LEN</span><span class="o">+</span><span class="mi">1</span><span class="p">];</span>
	<span class="kt">char</span> <span class="n">str_id_reg</span><span class="p">[</span><span class="n">VENDOR_ID_LEN</span><span class="o">+</span><span class="mi">1</span><span class="p">];</span>
	<span class="kt">char</span> <span class="n">str_id_cap</span><span class="p">[</span><span class="n">VENDOR_ID_LEN</span><span class="o">+</span><span class="mi">1</span><span class="p">];</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">vpd_data</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">vpd_extended_data</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">len</span><span class="p">;</span>

	<span class="n">cnt</span> <span class="o">=</span> <span class="n">pci_read_vpd</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">BNX2X_VPD_LEN</span><span class="p">,</span> <span class="n">vpd_start</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">fw_ver</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">fw_ver</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">&lt;</span> <span class="n">BNX2X_VPD_LEN</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_not_found</span><span class="p">;</span>

	<span class="cm">/* VPD RO tag should be first tag after identifier string, hence</span>
<span class="cm">	 * we should be able to find it in first BNX2X_VPD_LEN chars</span>
<span class="cm">	 */</span>
	<span class="n">i</span> <span class="o">=</span> <span class="n">pci_vpd_find_tag</span><span class="p">(</span><span class="n">vpd_start</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">BNX2X_VPD_LEN</span><span class="p">,</span>
			     <span class="n">PCI_VPD_LRDT_RO_DATA</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_not_found</span><span class="p">;</span>

	<span class="n">block_end</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="n">PCI_VPD_LRDT_TAG_SIZE</span> <span class="o">+</span>
		    <span class="n">pci_vpd_lrdt_size</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vpd_start</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

	<span class="n">i</span> <span class="o">+=</span> <span class="n">PCI_VPD_LRDT_TAG_SIZE</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">block_end</span> <span class="o">&gt;</span> <span class="n">BNX2X_VPD_LEN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vpd_extended_data</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">block_end</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vpd_extended_data</span>  <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_not_found</span><span class="p">;</span>

		<span class="cm">/* read rest of vpd image into vpd_extended_data */</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">vpd_extended_data</span><span class="p">,</span> <span class="n">vpd_start</span><span class="p">,</span> <span class="n">BNX2X_VPD_LEN</span><span class="p">);</span>
		<span class="n">cnt</span> <span class="o">=</span> <span class="n">pci_read_vpd</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">BNX2X_VPD_LEN</span><span class="p">,</span>
				   <span class="n">block_end</span> <span class="o">-</span> <span class="n">BNX2X_VPD_LEN</span><span class="p">,</span>
				   <span class="n">vpd_extended_data</span> <span class="o">+</span> <span class="n">BNX2X_VPD_LEN</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">block_end</span> <span class="o">-</span> <span class="n">BNX2X_VPD_LEN</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">out_not_found</span><span class="p">;</span>
		<span class="n">vpd_data</span> <span class="o">=</span> <span class="n">vpd_extended_data</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">vpd_data</span> <span class="o">=</span> <span class="n">vpd_start</span><span class="p">;</span>

	<span class="cm">/* now vpd_data holds full vpd content in both cases */</span>

	<span class="n">rodi</span> <span class="o">=</span> <span class="n">pci_vpd_find_info_keyword</span><span class="p">(</span><span class="n">vpd_data</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">block_end</span><span class="p">,</span>
				   <span class="n">PCI_VPD_RO_KEYWORD_MFR_ID</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rodi</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_not_found</span><span class="p">;</span>

	<span class="n">len</span> <span class="o">=</span> <span class="n">pci_vpd_info_field_size</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vpd_data</span><span class="p">[</span><span class="n">rodi</span><span class="p">]);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">!=</span> <span class="n">VENDOR_ID_LEN</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_not_found</span><span class="p">;</span>

	<span class="n">rodi</span> <span class="o">+=</span> <span class="n">PCI_VPD_INFO_FLD_HDR_SIZE</span><span class="p">;</span>

	<span class="cm">/* vendor specific info */</span>
	<span class="n">snprintf</span><span class="p">(</span><span class="n">str_id_reg</span><span class="p">,</span> <span class="n">VENDOR_ID_LEN</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%04x&quot;</span><span class="p">,</span> <span class="n">PCI_VENDOR_ID_DELL</span><span class="p">);</span>
	<span class="n">snprintf</span><span class="p">(</span><span class="n">str_id_cap</span><span class="p">,</span> <span class="n">VENDOR_ID_LEN</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%04X&quot;</span><span class="p">,</span> <span class="n">PCI_VENDOR_ID_DELL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">str_id_reg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vpd_data</span><span class="p">[</span><span class="n">rodi</span><span class="p">],</span> <span class="n">VENDOR_ID_LEN</span><span class="p">)</span> <span class="o">||</span>
	    <span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">str_id_cap</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vpd_data</span><span class="p">[</span><span class="n">rodi</span><span class="p">],</span> <span class="n">VENDOR_ID_LEN</span><span class="p">))</span> <span class="p">{</span>

		<span class="n">rodi</span> <span class="o">=</span> <span class="n">pci_vpd_find_info_keyword</span><span class="p">(</span><span class="n">vpd_data</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">block_end</span><span class="p">,</span>
						<span class="n">PCI_VPD_RO_KEYWORD_VENDOR0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rodi</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">len</span> <span class="o">=</span> <span class="n">pci_vpd_info_field_size</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vpd_data</span><span class="p">[</span><span class="n">rodi</span><span class="p">]);</span>

			<span class="n">rodi</span> <span class="o">+=</span> <span class="n">PCI_VPD_INFO_FLD_HDR_SIZE</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="mi">32</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">len</span> <span class="o">+</span> <span class="n">rodi</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">BNX2X_VPD_LEN</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">memcpy</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">fw_ver</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vpd_data</span><span class="p">[</span><span class="n">rodi</span><span class="p">],</span> <span class="n">len</span><span class="p">);</span>
				<span class="n">bp</span><span class="o">-&gt;</span><span class="n">fw_ver</span><span class="p">[</span><span class="n">len</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39; &#39;</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">vpd_extended_data</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
<span class="nl">out_not_found:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">vpd_extended_data</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span> <span class="nf">bnx2x_set_modes_bitmap</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">CHIP_REV_IS_FPGA</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span>
		<span class="n">SET_FLAGS</span><span class="p">(</span><span class="n">flags</span><span class="p">,</span> <span class="n">MODE_FPGA</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">CHIP_REV_IS_EMUL</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span>
		<span class="n">SET_FLAGS</span><span class="p">(</span><span class="n">flags</span><span class="p">,</span> <span class="n">MODE_EMUL</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">SET_FLAGS</span><span class="p">(</span><span class="n">flags</span><span class="p">,</span> <span class="n">MODE_ASIC</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">CHIP_MODE_IS_4_PORT</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span>
		<span class="n">SET_FLAGS</span><span class="p">(</span><span class="n">flags</span><span class="p">,</span> <span class="n">MODE_PORT4</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">SET_FLAGS</span><span class="p">(</span><span class="n">flags</span><span class="p">,</span> <span class="n">MODE_PORT2</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">CHIP_IS_E2</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span>
		<span class="n">SET_FLAGS</span><span class="p">(</span><span class="n">flags</span><span class="p">,</span> <span class="n">MODE_E2</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">CHIP_IS_E3</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">SET_FLAGS</span><span class="p">(</span><span class="n">flags</span><span class="p">,</span> <span class="n">MODE_E3</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">CHIP_REV</span><span class="p">(</span><span class="n">bp</span><span class="p">)</span> <span class="o">==</span> <span class="n">CHIP_REV_Ax</span><span class="p">)</span>
			<span class="n">SET_FLAGS</span><span class="p">(</span><span class="n">flags</span><span class="p">,</span> <span class="n">MODE_E3_A0</span><span class="p">);</span>
		<span class="k">else</span> <span class="cm">/*if (CHIP_REV(bp) == CHIP_REV_Bx)*/</span>
			<span class="n">SET_FLAGS</span><span class="p">(</span><span class="n">flags</span><span class="p">,</span> <span class="n">MODE_E3_B0</span> <span class="o">|</span> <span class="n">MODE_COS3</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_MF</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">SET_FLAGS</span><span class="p">(</span><span class="n">flags</span><span class="p">,</span> <span class="n">MODE_MF</span><span class="p">);</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">mf_mode</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">MULTI_FUNCTION_SD</span>:
			<span class="n">SET_FLAGS</span><span class="p">(</span><span class="n">flags</span><span class="p">,</span> <span class="n">MODE_MF_SD</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MULTI_FUNCTION_SI</span>:
			<span class="n">SET_FLAGS</span><span class="p">(</span><span class="n">flags</span><span class="p">,</span> <span class="n">MODE_MF_SI</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MULTI_FUNCTION_AFEX</span>:
			<span class="n">SET_FLAGS</span><span class="p">(</span><span class="n">flags</span><span class="p">,</span> <span class="n">MODE_MF_AFEX</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">SET_FLAGS</span><span class="p">(</span><span class="n">flags</span><span class="p">,</span> <span class="n">MODE_SF</span><span class="p">);</span>

<span class="cp">#if defined(__LITTLE_ENDIAN)</span>
	<span class="n">SET_FLAGS</span><span class="p">(</span><span class="n">flags</span><span class="p">,</span> <span class="n">MODE_LITTLE_ENDIAN</span><span class="p">);</span>
<span class="cp">#else </span><span class="cm">/*(__BIG_ENDIAN)*/</span><span class="cp"></span>
	<span class="n">SET_FLAGS</span><span class="p">(</span><span class="n">flags</span><span class="p">,</span> <span class="n">MODE_BIG_ENDIAN</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">INIT_MODE_FLAGS</span><span class="p">(</span><span class="n">bp</span><span class="p">)</span> <span class="o">=</span> <span class="n">flags</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">bnx2x_init_bp</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">func</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">phy_mutex</span><span class="p">);</span>
	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">fw_mb_mutex</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">stats_lock</span><span class="p">);</span>
<span class="cp">#ifdef BCM_CNIC</span>
	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">cnic_mutex</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="n">INIT_DELAYED_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">sp_task</span><span class="p">,</span> <span class="n">bnx2x_sp_task</span><span class="p">);</span>
	<span class="n">INIT_DELAYED_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">sp_rtnl_task</span><span class="p">,</span> <span class="n">bnx2x_sp_rtnl_task</span><span class="p">);</span>
	<span class="n">INIT_DELAYED_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">period_task</span><span class="p">,</span> <span class="n">bnx2x_period_task</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">bnx2x_get_hwinfo</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">bnx2x_set_modes_bitmap</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">bnx2x_alloc_mem_bp</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">bnx2x_read_fwinfo</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>

	<span class="n">func</span> <span class="o">=</span> <span class="n">BP_FUNC</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>

	<span class="cm">/* need to reset chip if undi was active */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">BP_NOMCP</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* init fw_seq */</span>
		<span class="n">bp</span><span class="o">-&gt;</span><span class="n">fw_seq</span> <span class="o">=</span>
			<span class="n">SHMEM_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">func_mb</span><span class="p">[</span><span class="n">BP_FW_MB_IDX</span><span class="p">(</span><span class="n">bp</span><span class="p">)].</span><span class="n">drv_mb_header</span><span class="p">)</span> <span class="o">&amp;</span>
							<span class="n">DRV_MSG_SEQ_NUMBER_MASK</span><span class="p">;</span>
		<span class="n">BNX2X_DEV_INFO</span><span class="p">(</span><span class="s">&quot;fw_seq 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">fw_seq</span><span class="p">);</span>

		<span class="n">bnx2x_prev_unload</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
	<span class="p">}</span>


	<span class="k">if</span> <span class="p">(</span><span class="n">CHIP_REV_IS_FPGA</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;FPGA detected</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">BP_NOMCP</span><span class="p">(</span><span class="n">bp</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">func</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;MCP disabled, must load devices in order!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">bp</span><span class="o">-&gt;</span><span class="n">disable_tpa</span> <span class="o">=</span> <span class="n">disable_tpa</span><span class="p">;</span>

<span class="cp">#ifdef BCM_CNIC</span>
	<span class="n">bp</span><span class="o">-&gt;</span><span class="n">disable_tpa</span> <span class="o">|=</span> <span class="n">IS_MF_STORAGE_SD</span><span class="p">(</span><span class="n">bp</span><span class="p">)</span> <span class="o">||</span> <span class="n">IS_MF_FCOE_AFEX</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="cm">/* Set TPA flags */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">disable_tpa</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">TPA_ENABLE_FLAG</span> <span class="o">|</span> <span class="n">GRO_ENABLE_FLAG</span><span class="p">);</span>
		<span class="n">bp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">NETIF_F_LRO</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">bp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="p">(</span><span class="n">TPA_ENABLE_FLAG</span> <span class="o">|</span> <span class="n">GRO_ENABLE_FLAG</span><span class="p">);</span>
		<span class="n">bp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">|=</span> <span class="n">NETIF_F_LRO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">CHIP_IS_E1</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span>
		<span class="n">bp</span><span class="o">-&gt;</span><span class="n">dropless_fc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">bp</span><span class="o">-&gt;</span><span class="n">dropless_fc</span> <span class="o">=</span> <span class="n">dropless_fc</span><span class="p">;</span>

	<span class="n">bp</span><span class="o">-&gt;</span><span class="n">mrrs</span> <span class="o">=</span> <span class="n">mrrs</span><span class="p">;</span>

	<span class="n">bp</span><span class="o">-&gt;</span><span class="n">tx_ring_size</span> <span class="o">=</span> <span class="n">IS_MF_FCOE_AFEX</span><span class="p">(</span><span class="n">bp</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">MAX_TX_AVAIL</span><span class="p">;</span>

	<span class="cm">/* make sure that the numbers are in the right granularity */</span>
	<span class="n">bp</span><span class="o">-&gt;</span><span class="n">tx_ticks</span> <span class="o">=</span> <span class="p">(</span><span class="mi">50</span> <span class="o">/</span> <span class="n">BNX2X_BTR</span><span class="p">)</span> <span class="o">*</span> <span class="n">BNX2X_BTR</span><span class="p">;</span>
	<span class="n">bp</span><span class="o">-&gt;</span><span class="n">rx_ticks</span> <span class="o">=</span> <span class="p">(</span><span class="mi">25</span> <span class="o">/</span> <span class="n">BNX2X_BTR</span><span class="p">)</span> <span class="o">*</span> <span class="n">BNX2X_BTR</span><span class="p">;</span>

	<span class="n">bp</span><span class="o">-&gt;</span><span class="n">current_interval</span> <span class="o">=</span> <span class="n">CHIP_REV_IS_SLOW</span><span class="p">(</span><span class="n">bp</span><span class="p">)</span> <span class="o">?</span> <span class="mi">5</span><span class="o">*</span><span class="n">HZ</span> <span class="o">:</span> <span class="n">HZ</span><span class="p">;</span>

	<span class="n">init_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
	<span class="n">bp</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">current_interval</span><span class="p">;</span>
	<span class="n">bp</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">bp</span><span class="p">;</span>
	<span class="n">bp</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="n">bnx2x_timer</span><span class="p">;</span>

	<span class="n">bnx2x_dcbx_set_state</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span> <span class="n">BNX2X_DCBX_ENABLED_ON_NEG_ON</span><span class="p">);</span>
	<span class="n">bnx2x_dcbx_init_params</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>

<span class="cp">#ifdef BCM_CNIC</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">CHIP_IS_E1x</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span>
		<span class="n">bp</span><span class="o">-&gt;</span><span class="n">cnic_base_cl_id</span> <span class="o">=</span> <span class="n">FP_SB_MAX_E1x</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">bp</span><span class="o">-&gt;</span><span class="n">cnic_base_cl_id</span> <span class="o">=</span> <span class="n">FP_SB_MAX_E2</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="cm">/* multiple tx priority */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">CHIP_IS_E1x</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span>
		<span class="n">bp</span><span class="o">-&gt;</span><span class="n">max_cos</span> <span class="o">=</span> <span class="n">BNX2X_MULTI_TX_COS_E1X</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">CHIP_IS_E2</span><span class="p">(</span><span class="n">bp</span><span class="p">)</span> <span class="o">||</span> <span class="n">CHIP_IS_E3A0</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span>
		<span class="n">bp</span><span class="o">-&gt;</span><span class="n">max_cos</span> <span class="o">=</span> <span class="n">BNX2X_MULTI_TX_COS_E2_E3A0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">CHIP_IS_E3B0</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span>
		<span class="n">bp</span><span class="o">-&gt;</span><span class="n">max_cos</span> <span class="o">=</span> <span class="n">BNX2X_MULTI_TX_COS_E3B0</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/****************************************************************************</span>
<span class="cm">* General service functions</span>
<span class="cm">****************************************************************************/</span>

<span class="cm">/*</span>
<span class="cm"> * net_device service functions</span>
<span class="cm"> */</span>

<span class="cm">/* called with rtnl_lock */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">bnx2x_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">bool</span> <span class="n">global</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">other_engine</span> <span class="o">=</span> <span class="n">BP_PATH</span><span class="p">(</span><span class="n">bp</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">other_load_status</span><span class="p">,</span> <span class="n">load_status</span><span class="p">;</span>

	<span class="n">bp</span><span class="o">-&gt;</span><span class="n">stats_init</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="n">netif_carrier_off</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">bnx2x_set_power_state</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">PCI_D0</span><span class="p">);</span>

	<span class="n">other_load_status</span> <span class="o">=</span> <span class="n">bnx2x_get_load_status</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">other_engine</span><span class="p">);</span>
	<span class="n">load_status</span> <span class="o">=</span> <span class="n">bnx2x_get_load_status</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">BP_PATH</span><span class="p">(</span><span class="n">bp</span><span class="p">));</span>

	<span class="cm">/*</span>
<span class="cm">	 * If parity had happen during the unload, then attentions</span>
<span class="cm">	 * and/or RECOVERY_IN_PROGRES may still be set. In this case we</span>
<span class="cm">	 * want the first function loaded on the current engine to</span>
<span class="cm">	 * complete the recovery.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bnx2x_reset_is_done</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">BP_PATH</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span> <span class="o">||</span>
	    <span class="n">bnx2x_chk_parity_attn</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">global</span><span class="p">,</span> <span class="nb">true</span><span class="p">))</span>
		<span class="k">do</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * If there are attentions and they are in a global</span>
<span class="cm">			 * blocks, set the GLOBAL_RESET bit regardless whether</span>
<span class="cm">			 * it will be this function that will complete the</span>
<span class="cm">			 * recovery or not.</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">global</span><span class="p">)</span>
				<span class="n">bnx2x_set_reset_global</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>

			<span class="cm">/*</span>
<span class="cm">			 * Only the first function on the current engine should</span>
<span class="cm">			 * try to recover in open. In case of attentions in</span>
<span class="cm">			 * global blocks only the first in the chip should try</span>
<span class="cm">			 * to recover.</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="n">load_status</span> <span class="o">&amp;&amp;</span>
			     <span class="p">(</span><span class="o">!</span><span class="n">global</span> <span class="o">||</span> <span class="o">!</span><span class="n">other_load_status</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
			    <span class="n">bnx2x_trylock_leader_lock</span><span class="p">(</span><span class="n">bp</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="o">!</span><span class="n">bnx2x_leader_reset</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">netdev_info</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Recovered in open</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="cm">/* recovery has failed... */</span>
			<span class="n">bnx2x_set_power_state</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">PCI_D3hot</span><span class="p">);</span>
			<span class="n">bp</span><span class="o">-&gt;</span><span class="n">recovery_state</span> <span class="o">=</span> <span class="n">BNX2X_RECOVERY_FAILED</span><span class="p">;</span>

			<span class="n">BNX2X_ERR</span><span class="p">(</span><span class="s">&quot;Recovery flow hasn&#39;t been properly completed yet. Try again later.</span><span class="se">\n</span><span class="s">&quot;</span>
				  <span class="s">&quot;If you still see this message after a few retries then power cycle is required.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

			<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>

	<span class="n">bp</span><span class="o">-&gt;</span><span class="n">recovery_state</span> <span class="o">=</span> <span class="n">BNX2X_RECOVERY_DONE</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">bnx2x_nic_load</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">LOAD_OPEN</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* called with rtnl_lock */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">bnx2x_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* Unload the driver, release IRQs */</span>
	<span class="n">bnx2x_nic_unload</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">UNLOAD_CLOSE</span><span class="p">);</span>

	<span class="cm">/* Power off */</span>
	<span class="n">bnx2x_set_power_state</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">PCI_D3hot</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bnx2x_init_mcast_macs_list</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">bnx2x_mcast_ramrod_params</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">mc_count</span> <span class="o">=</span> <span class="n">netdev_mc_count</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">bnx2x_mcast_list_elem</span> <span class="o">*</span><span class="n">mc_mac</span> <span class="o">=</span>
		<span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">mc_mac</span><span class="p">)</span> <span class="o">*</span> <span class="n">mc_count</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">netdev_hw_addr</span> <span class="o">*</span><span class="n">ha</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mc_mac</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">mcast_list</span><span class="p">);</span>

	<span class="n">netdev_for_each_mc_addr</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mc_mac</span><span class="o">-&gt;</span><span class="n">mac</span> <span class="o">=</span> <span class="n">bnx2x_mc_addr</span><span class="p">(</span><span class="n">ha</span><span class="p">);</span>
		<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mc_mac</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">mcast_list</span><span class="p">);</span>
		<span class="n">mc_mac</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">p</span><span class="o">-&gt;</span><span class="n">mcast_list_len</span> <span class="o">=</span> <span class="n">mc_count</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_free_mcast_macs_list</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">bnx2x_mcast_ramrod_params</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2x_mcast_list_elem</span> <span class="o">*</span><span class="n">mc_mac</span> <span class="o">=</span>
		<span class="n">list_first_entry</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">mcast_list</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bnx2x_mcast_list_elem</span><span class="p">,</span>
				 <span class="n">link</span><span class="p">);</span>

	<span class="n">WARN_ON</span><span class="p">(</span><span class="o">!</span><span class="n">mc_mac</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">mc_mac</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * bnx2x_set_uc_list - configure a new unicast MACs list.</span>
<span class="cm"> *</span>
<span class="cm"> * @bp: driver handle</span>
<span class="cm"> *</span>
<span class="cm"> * We will use zero (0) as a MAC type for these MACs.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">bnx2x_set_uc_list</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">netdev_hw_addr</span> <span class="o">*</span><span class="n">ha</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bnx2x_vlan_mac_obj</span> <span class="o">*</span><span class="n">mac_obj</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">mac_obj</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ramrod_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* First schedule a cleanup up of old configuration */</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">bnx2x_del_all_macs</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">mac_obj</span><span class="p">,</span> <span class="n">BNX2X_UC_LIST_MAC</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BNX2X_ERR</span><span class="p">(</span><span class="s">&quot;Failed to schedule DELETE operations: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">netdev_for_each_uc_addr</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">bnx2x_set_mac_one</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">bnx2x_uc_addr</span><span class="p">(</span><span class="n">ha</span><span class="p">),</span> <span class="n">mac_obj</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span>
				       <span class="n">BNX2X_UC_LIST_MAC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ramrod_flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">BNX2X_ERR</span><span class="p">(</span><span class="s">&quot;Failed to schedule ADD operations: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				  <span class="n">rc</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Execute the pending commands */</span>
	<span class="n">__set_bit</span><span class="p">(</span><span class="n">RAMROD_CONT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ramrod_flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">bnx2x_set_mac_one</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">mac_obj</span><span class="p">,</span> <span class="nb">false</span> <span class="cm">/* don&#39;t care */</span><span class="p">,</span>
				 <span class="n">BNX2X_UC_LIST_MAC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ramrod_flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bnx2x_set_mc_list</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bnx2x_mcast_ramrod_params</span> <span class="n">rparam</span> <span class="o">=</span> <span class="p">{</span><span class="nb">NULL</span><span class="p">};</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">rparam</span><span class="p">.</span><span class="n">mcast_obj</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">mcast_obj</span><span class="p">;</span>

	<span class="cm">/* first, clear all configured multicast MACs */</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">bnx2x_config_mcast</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rparam</span><span class="p">,</span> <span class="n">BNX2X_MCAST_CMD_DEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BNX2X_ERR</span><span class="p">(</span><span class="s">&quot;Failed to clear multicast configuration: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* then, configure a new MACs list */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">netdev_mc_count</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">bnx2x_init_mcast_macs_list</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rparam</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">BNX2X_ERR</span><span class="p">(</span><span class="s">&quot;Failed to create multicast MACs list: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				  <span class="n">rc</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Now add the new MACs */</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">bnx2x_config_mcast</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rparam</span><span class="p">,</span>
					<span class="n">BNX2X_MCAST_CMD_ADD</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">BNX2X_ERR</span><span class="p">(</span><span class="s">&quot;Failed to set a new multicast configuration: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				  <span class="n">rc</span><span class="p">);</span>

		<span class="n">bnx2x_free_mcast_macs_list</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rparam</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* If bp-&gt;state is OPEN, should be called with netif_addr_lock_bh() */</span>
<span class="kt">void</span> <span class="nf">bnx2x_set_rx_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">rx_mode</span> <span class="o">=</span> <span class="n">BNX2X_RX_MODE_NORMAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">BNX2X_STATE_OPEN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_IFUP</span><span class="p">,</span> <span class="s">&quot;state is %x, returning</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_IFUP</span><span class="p">,</span> <span class="s">&quot;dev-&gt;flags = %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_PROMISC</span><span class="p">)</span>
		<span class="n">rx_mode</span> <span class="o">=</span> <span class="n">BNX2X_RX_MODE_PROMISC</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_ALLMULTI</span><span class="p">)</span> <span class="o">||</span>
		 <span class="p">((</span><span class="n">netdev_mc_count</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">BNX2X_MAX_MULTICAST</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		  <span class="n">CHIP_IS_E1</span><span class="p">(</span><span class="n">bp</span><span class="p">)))</span>
		<span class="n">rx_mode</span> <span class="o">=</span> <span class="n">BNX2X_RX_MODE_ALLMULTI</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* some multicasts */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bnx2x_set_mc_list</span><span class="p">(</span><span class="n">bp</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">rx_mode</span> <span class="o">=</span> <span class="n">BNX2X_RX_MODE_ALLMULTI</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">bnx2x_set_uc_list</span><span class="p">(</span><span class="n">bp</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">rx_mode</span> <span class="o">=</span> <span class="n">BNX2X_RX_MODE_PROMISC</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">bp</span><span class="o">-&gt;</span><span class="n">rx_mode</span> <span class="o">=</span> <span class="n">rx_mode</span><span class="p">;</span>
<span class="cp">#ifdef BCM_CNIC</span>
	<span class="cm">/* handle ISCSI SD mode */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_MF_ISCSI_SD</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span>
		<span class="n">bp</span><span class="o">-&gt;</span><span class="n">rx_mode</span> <span class="o">=</span> <span class="n">BNX2X_RX_MODE_NONE</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="cm">/* Schedule the rx_mode command */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">BNX2X_FILTER_RX_MODE_PENDING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">sp_state</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">BNX2X_FILTER_RX_MODE_SCHED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">sp_state</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">bnx2x_set_storm_rx_mode</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* called with rtnl_lock */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">bnx2x_mdio_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">prtad</span><span class="p">,</span>
			   <span class="kt">int</span> <span class="n">devad</span><span class="p">,</span> <span class="n">u16</span> <span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="n">u16</span> <span class="n">value</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;mdio_read: prtad 0x%x, devad 0x%x, addr 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	   <span class="n">prtad</span><span class="p">,</span> <span class="n">devad</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>

	<span class="cm">/* The HW expects different devad if CL22 is used */</span>
	<span class="n">devad</span> <span class="o">=</span> <span class="p">(</span><span class="n">devad</span> <span class="o">==</span> <span class="n">MDIO_DEVAD_NONE</span><span class="p">)</span> <span class="o">?</span> <span class="n">DEFAULT_PHY_DEV_ADDR</span> <span class="o">:</span> <span class="n">devad</span><span class="p">;</span>

	<span class="n">bnx2x_acquire_phy_lock</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">bnx2x_phy_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">link_params</span><span class="p">,</span> <span class="n">prtad</span><span class="p">,</span> <span class="n">devad</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">);</span>
	<span class="n">bnx2x_release_phy_lock</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
	<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;mdio_read_val 0x%x rc = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rc</span><span class="p">)</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* called with rtnl_lock */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">bnx2x_mdio_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">prtad</span><span class="p">,</span> <span class="kt">int</span> <span class="n">devad</span><span class="p">,</span>
			    <span class="n">u16</span> <span class="n">addr</span><span class="p">,</span> <span class="n">u16</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span>
	   <span class="s">&quot;mdio_write: prtad 0x%x, devad 0x%x, addr 0x%x, value 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	   <span class="n">prtad</span><span class="p">,</span> <span class="n">devad</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>

	<span class="cm">/* The HW expects different devad if CL22 is used */</span>
	<span class="n">devad</span> <span class="o">=</span> <span class="p">(</span><span class="n">devad</span> <span class="o">==</span> <span class="n">MDIO_DEVAD_NONE</span><span class="p">)</span> <span class="o">?</span> <span class="n">DEFAULT_PHY_DEV_ADDR</span> <span class="o">:</span> <span class="n">devad</span><span class="p">;</span>

	<span class="n">bnx2x_acquire_phy_lock</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">bnx2x_phy_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">link_params</span><span class="p">,</span> <span class="n">prtad</span><span class="p">,</span> <span class="n">devad</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
	<span class="n">bnx2x_release_phy_lock</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* called with rtnl_lock */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">bnx2x_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ifreq</span> <span class="o">*</span><span class="n">ifr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">mii_ioctl_data</span> <span class="o">*</span><span class="n">mdio</span> <span class="o">=</span> <span class="n">if_mii</span><span class="p">(</span><span class="n">ifr</span><span class="p">);</span>

	<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;ioctl: phy id 0x%x, reg 0x%x, val_in 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	   <span class="n">mdio</span><span class="o">-&gt;</span><span class="n">phy_id</span><span class="p">,</span> <span class="n">mdio</span><span class="o">-&gt;</span><span class="n">reg_num</span><span class="p">,</span> <span class="n">mdio</span><span class="o">-&gt;</span><span class="n">val_in</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">netif_running</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">mdio_mii_ioctl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">mdio</span><span class="p">,</span> <span class="n">mdio</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_NET_POLL_CONTROLLER</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">poll_bnx2x</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">disable_irq</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
	<span class="n">bnx2x_interrupt</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="n">enable_irq</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bnx2x_validate_addr</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bnx2x_is_valid_ether_addr</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">BNX2X_ERR</span><span class="p">(</span><span class="s">&quot;Non-valid Ethernet address</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EADDRNOTAVAIL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">net_device_ops</span> <span class="n">bnx2x_netdev_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">ndo_open</span>		<span class="o">=</span> <span class="n">bnx2x_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_stop</span>		<span class="o">=</span> <span class="n">bnx2x_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_start_xmit</span>		<span class="o">=</span> <span class="n">bnx2x_start_xmit</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_select_queue</span>	<span class="o">=</span> <span class="n">bnx2x_select_queue</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_set_rx_mode</span>	<span class="o">=</span> <span class="n">bnx2x_set_rx_mode</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_set_mac_address</span>	<span class="o">=</span> <span class="n">bnx2x_change_mac_addr</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_validate_addr</span>	<span class="o">=</span> <span class="n">bnx2x_validate_addr</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_do_ioctl</span>		<span class="o">=</span> <span class="n">bnx2x_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_change_mtu</span>		<span class="o">=</span> <span class="n">bnx2x_change_mtu</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_fix_features</span>	<span class="o">=</span> <span class="n">bnx2x_fix_features</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_set_features</span>	<span class="o">=</span> <span class="n">bnx2x_set_features</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_tx_timeout</span>		<span class="o">=</span> <span class="n">bnx2x_tx_timeout</span><span class="p">,</span>
<span class="cp">#ifdef CONFIG_NET_POLL_CONTROLLER</span>
	<span class="p">.</span><span class="n">ndo_poll_controller</span>	<span class="o">=</span> <span class="n">poll_bnx2x</span><span class="p">,</span>
<span class="cp">#endif</span>
	<span class="p">.</span><span class="n">ndo_setup_tc</span>		<span class="o">=</span> <span class="n">bnx2x_setup_tc</span><span class="p">,</span>

<span class="cp">#if defined(NETDEV_FCOE_WWNN) &amp;&amp; defined(BCM_CNIC)</span>
	<span class="p">.</span><span class="n">ndo_fcoe_get_wwn</span>	<span class="o">=</span> <span class="n">bnx2x_fcoe_get_wwn</span><span class="p">,</span>
<span class="cp">#endif</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bnx2x_set_coherency_mask</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dma_set_mask</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">64</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">USING_DAC_FLAG</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dma_set_coherent_mask</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">64</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;dma_set_coherent_mask failed, aborting</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dma_set_mask</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">32</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;System does not support DMA, aborting</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">bnx2x_init_dev</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">board_type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">pci_cfg_dword</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">chip_is_e1x</span> <span class="o">=</span> <span class="p">(</span><span class="n">board_type</span> <span class="o">==</span> <span class="n">BCM57710</span> <span class="o">||</span>
			    <span class="n">board_type</span> <span class="o">==</span> <span class="n">BCM57711</span> <span class="o">||</span>
			    <span class="n">board_type</span> <span class="o">==</span> <span class="n">BCM57711E</span><span class="p">);</span>

	<span class="n">SET_NETDEV_DEV</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">bp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">bp</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	<span class="n">bp</span><span class="o">-&gt;</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">pdev</span><span class="p">;</span>
	<span class="n">bp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">pci_enable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;Cannot enable PCI device, aborting</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">pci_resource_flags</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">IORESOURCE_MEM</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;Cannot find PCI device base address, aborting</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_out_disable</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">pci_resource_flags</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">IORESOURCE_MEM</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Cannot find second PCI device&quot;</span>
		       <span class="s">&quot; base address, aborting</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_out_disable</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">enable_cnt</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">pci_request_regions</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">DRV_MODULE_NAME</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;Cannot obtain PCI resources, aborting</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">err_out_disable</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">pci_set_master</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
		<span class="n">pci_save_state</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">bp</span><span class="o">-&gt;</span><span class="n">pm_cap</span> <span class="o">=</span> <span class="n">pci_find_capability</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_CAP_ID_PM</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">pm_cap</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;Cannot find power management capability, aborting</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_out_release</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pci_is_pcie</span><span class="p">(</span><span class="n">pdev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Not PCI Express, aborting</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_out_release</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">bnx2x_set_coherency_mask</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_out_release</span><span class="p">;</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">mem_start</span> <span class="o">=</span> <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">mem_start</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">mem_end</span> <span class="o">=</span> <span class="n">pci_resource_end</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>

	<span class="n">bp</span><span class="o">-&gt;</span><span class="n">regview</span> <span class="o">=</span> <span class="n">pci_ioremap_bar</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">regview</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;Cannot map register space, aborting</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_out_release</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* In E1/E1H use pci device function given by kernel.</span>
<span class="cm">	 * In E2/E3 read physical function from ME register since these chips</span>
<span class="cm">	 * support Physical Device Assignment where kernel BDF maybe arbitrary</span>
<span class="cm">	 * (depending on hypervisor).</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip_is_e1x</span><span class="p">)</span>
		<span class="n">bp</span><span class="o">-&gt;</span><span class="n">pf_num</span> <span class="o">=</span> <span class="n">PCI_FUNC</span><span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span><span class="cm">/* chip is E2/3*/</span>
		<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span>
				      <span class="n">PCICFG_ME_REGISTER</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pci_cfg_dword</span><span class="p">);</span>
		<span class="n">bp</span><span class="o">-&gt;</span><span class="n">pf_num</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)((</span><span class="n">pci_cfg_dword</span> <span class="o">&amp;</span> <span class="n">ME_REG_ABS_PF_NUM</span><span class="p">)</span> <span class="o">&gt;&gt;</span>
		    <span class="n">ME_REG_ABS_PF_NUM_SHIFT</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">BNX2X_DEV_INFO</span><span class="p">(</span><span class="s">&quot;me reg PF num: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">pf_num</span><span class="p">);</span>

	<span class="n">bnx2x_set_power_state</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">PCI_D0</span><span class="p">);</span>

	<span class="cm">/* clean indirect addresses */</span>
	<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCICFG_GRC_ADDRESS</span><span class="p">,</span>
			       <span class="n">PCICFG_VENDOR_ID_OFFSET</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * Clean the following indirect addresses for all functions since it</span>
<span class="cm">	 * is not used by the driver.</span>
<span class="cm">	 */</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">PXP2_REG_PGL_ADDR_88_F0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">PXP2_REG_PGL_ADDR_8C_F0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">PXP2_REG_PGL_ADDR_90_F0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">PXP2_REG_PGL_ADDR_94_F0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chip_is_e1x</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">PXP2_REG_PGL_ADDR_88_F1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">PXP2_REG_PGL_ADDR_8C_F1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">PXP2_REG_PGL_ADDR_90_F1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">PXP2_REG_PGL_ADDR_94_F1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Enable internal target-read (in case we are probed after PF FLR).</span>
<span class="cm">	 * Must be done prior to any BAR read access. Only for 57712 and up</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">chip_is_e1x</span><span class="p">)</span>
		<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">PGLUE_B_REG_INTERNAL_PFID_ENABLE_TARGET_READ</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* Reset the load counter */</span>
	<span class="n">bnx2x_clear_load_status</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">watchdog_timeo</span> <span class="o">=</span> <span class="n">TX_TIMEOUT</span><span class="p">;</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">netdev_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">bnx2x_netdev_ops</span><span class="p">;</span>
	<span class="n">bnx2x_set_ethtool_ops</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">priv_flags</span> <span class="o">|=</span> <span class="n">IFF_UNICAST_FLT</span><span class="p">;</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">hw_features</span> <span class="o">=</span> <span class="n">NETIF_F_SG</span> <span class="o">|</span> <span class="n">NETIF_F_IP_CSUM</span> <span class="o">|</span> <span class="n">NETIF_F_IPV6_CSUM</span> <span class="o">|</span>
		<span class="n">NETIF_F_TSO</span> <span class="o">|</span> <span class="n">NETIF_F_TSO_ECN</span> <span class="o">|</span> <span class="n">NETIF_F_TSO6</span> <span class="o">|</span>
		<span class="n">NETIF_F_RXCSUM</span> <span class="o">|</span> <span class="n">NETIF_F_LRO</span> <span class="o">|</span> <span class="n">NETIF_F_GRO</span> <span class="o">|</span>
		<span class="n">NETIF_F_RXHASH</span> <span class="o">|</span> <span class="n">NETIF_F_HW_VLAN_TX</span><span class="p">;</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">vlan_features</span> <span class="o">=</span> <span class="n">NETIF_F_SG</span> <span class="o">|</span> <span class="n">NETIF_F_IP_CSUM</span> <span class="o">|</span> <span class="n">NETIF_F_IPV6_CSUM</span> <span class="o">|</span>
		<span class="n">NETIF_F_TSO</span> <span class="o">|</span> <span class="n">NETIF_F_TSO_ECN</span> <span class="o">|</span> <span class="n">NETIF_F_TSO6</span> <span class="o">|</span> <span class="n">NETIF_F_HIGHDMA</span><span class="p">;</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">|=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">hw_features</span> <span class="o">|</span> <span class="n">NETIF_F_HW_VLAN_RX</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">USING_DAC_FLAG</span><span class="p">)</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">|=</span> <span class="n">NETIF_F_HIGHDMA</span><span class="p">;</span>

	<span class="cm">/* Add Loopback capability to the device */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">hw_features</span> <span class="o">|=</span> <span class="n">NETIF_F_LOOPBACK</span><span class="p">;</span>

<span class="cp">#ifdef BCM_DCBNL</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dcbnl_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">bnx2x_dcbnl_ops</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="cm">/* get_port_hwinfo() will set prtad and mmds properly */</span>
	<span class="n">bp</span><span class="o">-&gt;</span><span class="n">mdio</span><span class="p">.</span><span class="n">prtad</span> <span class="o">=</span> <span class="n">MDIO_PRTAD_NONE</span><span class="p">;</span>
	<span class="n">bp</span><span class="o">-&gt;</span><span class="n">mdio</span><span class="p">.</span><span class="n">mmds</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">bp</span><span class="o">-&gt;</span><span class="n">mdio</span><span class="p">.</span><span class="n">mode_support</span> <span class="o">=</span> <span class="n">MDIO_SUPPORTS_C45</span> <span class="o">|</span> <span class="n">MDIO_EMULATE_C22</span><span class="p">;</span>
	<span class="n">bp</span><span class="o">-&gt;</span><span class="n">mdio</span><span class="p">.</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	<span class="n">bp</span><span class="o">-&gt;</span><span class="n">mdio</span><span class="p">.</span><span class="n">mdio_read</span> <span class="o">=</span> <span class="n">bnx2x_mdio_read</span><span class="p">;</span>
	<span class="n">bp</span><span class="o">-&gt;</span><span class="n">mdio</span><span class="p">.</span><span class="n">mdio_write</span> <span class="o">=</span> <span class="n">bnx2x_mdio_write</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_out_release:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">enable_cnt</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">pci_release_regions</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

<span class="nl">err_out_disable:</span>
	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

<span class="nl">err_out:</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span> <span class="nf">bnx2x_get_pcie_width_speed</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">,</span>
						 <span class="kt">int</span> <span class="o">*</span><span class="n">width</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">speed</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">val</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">PCICFG_OFFSET</span> <span class="o">+</span> <span class="n">PCICFG_LINK_CONTROL</span><span class="p">);</span>

	<span class="o">*</span><span class="n">width</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">PCICFG_LINK_WIDTH</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">PCICFG_LINK_WIDTH_SHIFT</span><span class="p">;</span>

	<span class="cm">/* return value of 1=2.5GHz 2=5GHz */</span>
	<span class="o">*</span><span class="n">speed</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">PCICFG_LINK_SPEED</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">PCICFG_LINK_SPEED_SHIFT</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bnx2x_check_firmware</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">firmware</span> <span class="o">*</span><span class="n">firmware</span> <span class="o">=</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">firmware</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bnx2x_fw_file_hdr</span> <span class="o">*</span><span class="n">fw_hdr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bnx2x_fw_file_section</span> <span class="o">*</span><span class="n">sections</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">offset</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">num_ops</span><span class="p">;</span>
	<span class="n">u16</span> <span class="o">*</span><span class="n">ops_offsets</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">fw_ver</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">firmware</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x_fw_file_hdr</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">BNX2X_ERR</span><span class="p">(</span><span class="s">&quot;Wrong FW size</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">fw_hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x_fw_file_hdr</span> <span class="o">*</span><span class="p">)</span><span class="n">firmware</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">sections</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x_fw_file_section</span> <span class="o">*</span><span class="p">)</span><span class="n">fw_hdr</span><span class="p">;</span>

	<span class="cm">/* Make sure none of the offsets and sizes make us read beyond</span>
<span class="cm">	 * the end of the firmware data */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">fw_hdr</span><span class="p">)</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">sections</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">offset</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">sections</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">offset</span><span class="p">);</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">sections</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">len</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">offset</span> <span class="o">+</span> <span class="n">len</span> <span class="o">&gt;</span> <span class="n">firmware</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">BNX2X_ERR</span><span class="p">(</span><span class="s">&quot;Section %d length is out of bounds</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Likewise for the init_ops offsets */</span>
	<span class="n">offset</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">fw_hdr</span><span class="o">-&gt;</span><span class="n">init_ops_offsets</span><span class="p">.</span><span class="n">offset</span><span class="p">);</span>
	<span class="n">ops_offsets</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span> <span class="o">*</span><span class="p">)(</span><span class="n">firmware</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="n">offset</span><span class="p">);</span>
	<span class="n">num_ops</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">fw_hdr</span><span class="o">-&gt;</span><span class="n">init_ops</span><span class="p">.</span><span class="n">len</span><span class="p">)</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">raw_op</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">fw_hdr</span><span class="o">-&gt;</span><span class="n">init_ops_offsets</span><span class="p">.</span><span class="n">len</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">ops_offsets</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">&gt;</span> <span class="n">num_ops</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">BNX2X_ERR</span><span class="p">(</span><span class="s">&quot;Section offset %d is out of bounds</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Check FW version */</span>
	<span class="n">offset</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">fw_hdr</span><span class="o">-&gt;</span><span class="n">fw_version</span><span class="p">.</span><span class="n">offset</span><span class="p">);</span>
	<span class="n">fw_ver</span> <span class="o">=</span> <span class="n">firmware</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="n">offset</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">fw_ver</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">BCM_5710_FW_MAJOR_VERSION</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">fw_ver</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="n">BCM_5710_FW_MINOR_VERSION</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">fw_ver</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">!=</span> <span class="n">BCM_5710_FW_REVISION_VERSION</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">fw_ver</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">!=</span> <span class="n">BCM_5710_FW_ENGINEERING_VERSION</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">BNX2X_ERR</span><span class="p">(</span><span class="s">&quot;Bad FW version:%d.%d.%d.%d. Should be %d.%d.%d.%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">fw_ver</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">fw_ver</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">fw_ver</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">fw_ver</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
		       <span class="n">BCM_5710_FW_MAJOR_VERSION</span><span class="p">,</span>
		       <span class="n">BCM_5710_FW_MINOR_VERSION</span><span class="p">,</span>
		       <span class="n">BCM_5710_FW_REVISION_VERSION</span><span class="p">,</span>
		       <span class="n">BCM_5710_FW_ENGINEERING_VERSION</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">be32_to_cpu_n</span><span class="p">(</span><span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">_source</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">_target</span><span class="p">,</span> <span class="n">u32</span> <span class="n">n</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="n">__be32</span> <span class="o">*</span><span class="n">source</span> <span class="o">=</span> <span class="p">(</span><span class="k">const</span> <span class="n">__be32</span> <span class="o">*</span><span class="p">)</span><span class="n">_source</span><span class="p">;</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">target</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="n">_target</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n</span><span class="o">/</span><span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">target</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">source</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">   Ops array is stored in the following format:</span>
<span class="cm">   {op(8bit), offset(24bit, big endian), data(32bit, big endian)}</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_prep_ops</span><span class="p">(</span><span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">_source</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">_target</span><span class="p">,</span> <span class="n">u32</span> <span class="n">n</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="n">__be32</span> <span class="o">*</span><span class="n">source</span> <span class="o">=</span> <span class="p">(</span><span class="k">const</span> <span class="n">__be32</span> <span class="o">*</span><span class="p">)</span><span class="n">_source</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">raw_op</span> <span class="o">*</span><span class="n">target</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">raw_op</span> <span class="o">*</span><span class="p">)</span><span class="n">_target</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n</span><span class="o">/</span><span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">j</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">source</span><span class="p">[</span><span class="n">j</span><span class="p">]);</span>
		<span class="n">target</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">op</span> <span class="o">=</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="n">target</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">offset</span> <span class="o">=</span> <span class="n">tmp</span> <span class="o">&amp;</span> <span class="mh">0xffffff</span><span class="p">;</span>
		<span class="n">target</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">raw_data</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">source</span><span class="p">[</span><span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * IRO array is stored in the following format:</span>
<span class="cm"> * {base(24bit), m1(16bit), m2(16bit), m3(16bit), size(16bit) }</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_prep_iro</span><span class="p">(</span><span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">_source</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">_target</span><span class="p">,</span> <span class="n">u32</span> <span class="n">n</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="n">__be32</span> <span class="o">*</span><span class="n">source</span> <span class="o">=</span> <span class="p">(</span><span class="k">const</span> <span class="n">__be32</span> <span class="o">*</span><span class="p">)</span><span class="n">_source</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iro</span> <span class="o">*</span><span class="n">target</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">iro</span> <span class="o">*</span><span class="p">)</span><span class="n">_target</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n</span><span class="o">/</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">iro</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">target</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">base</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">source</span><span class="p">[</span><span class="n">j</span><span class="p">]);</span>
		<span class="n">j</span><span class="o">++</span><span class="p">;</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">source</span><span class="p">[</span><span class="n">j</span><span class="p">]);</span>
		<span class="n">target</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">m1</span> <span class="o">=</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">;</span>
		<span class="n">target</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">m2</span> <span class="o">=</span> <span class="n">tmp</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">;</span>
		<span class="n">j</span><span class="o">++</span><span class="p">;</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">source</span><span class="p">[</span><span class="n">j</span><span class="p">]);</span>
		<span class="n">target</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">m3</span> <span class="o">=</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">;</span>
		<span class="n">target</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">size</span> <span class="o">=</span> <span class="n">tmp</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">;</span>
		<span class="n">j</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">be16_to_cpu_n</span><span class="p">(</span><span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">_source</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">_target</span><span class="p">,</span> <span class="n">u32</span> <span class="n">n</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="n">__be16</span> <span class="o">*</span><span class="n">source</span> <span class="o">=</span> <span class="p">(</span><span class="k">const</span> <span class="n">__be16</span> <span class="o">*</span><span class="p">)</span><span class="n">_source</span><span class="p">;</span>
	<span class="n">u16</span> <span class="o">*</span><span class="n">target</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span> <span class="o">*</span><span class="p">)</span><span class="n">_target</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n</span><span class="o">/</span><span class="mi">2</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">target</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">source</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="p">}</span>

<span class="cp">#define BNX2X_ALLOC_AND_SET(arr, lbl, func)				\</span>
<span class="cp">do {									\</span>
<span class="cp">	u32 len = be32_to_cpu(fw_hdr-&gt;arr.len);				\</span>
<span class="cp">	bp-&gt;arr = kmalloc(len, GFP_KERNEL);				\</span>
<span class="cp">	if (!bp-&gt;arr)							\</span>
<span class="cp">		goto lbl;						\</span>
<span class="cp">	func(bp-&gt;firmware-&gt;data + be32_to_cpu(fw_hdr-&gt;arr.offset),	\</span>
<span class="cp">	     (u8 *)bp-&gt;arr, len);					\</span>
<span class="cp">} while (0)</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bnx2x_init_firmware</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fw_file_name</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bnx2x_fw_file_hdr</span> <span class="o">*</span><span class="n">fw_hdr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">firmware</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">CHIP_IS_E1</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span>
		<span class="n">fw_file_name</span> <span class="o">=</span> <span class="n">FW_FILE_NAME_E1</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">CHIP_IS_E1H</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span>
		<span class="n">fw_file_name</span> <span class="o">=</span> <span class="n">FW_FILE_NAME_E1H</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CHIP_IS_E1x</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span>
		<span class="n">fw_file_name</span> <span class="o">=</span> <span class="n">FW_FILE_NAME_E2</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">BNX2X_ERR</span><span class="p">(</span><span class="s">&quot;Unsupported chip revision</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">BNX2X_DEV_INFO</span><span class="p">(</span><span class="s">&quot;Loading %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fw_file_name</span><span class="p">);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">request_firmware</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">firmware</span><span class="p">,</span> <span class="n">fw_file_name</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BNX2X_ERR</span><span class="p">(</span><span class="s">&quot;Can&#39;t load firmware file %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">fw_file_name</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">request_firmware_exit</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">bnx2x_check_firmware</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BNX2X_ERR</span><span class="p">(</span><span class="s">&quot;Corrupt firmware file %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fw_file_name</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">request_firmware_exit</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">fw_hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x_fw_file_hdr</span> <span class="o">*</span><span class="p">)</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">firmware</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

	<span class="cm">/* Initialize the pointers to the init arrays */</span>
	<span class="cm">/* Blob */</span>
	<span class="n">BNX2X_ALLOC_AND_SET</span><span class="p">(</span><span class="n">init_data</span><span class="p">,</span> <span class="n">request_firmware_exit</span><span class="p">,</span> <span class="n">be32_to_cpu_n</span><span class="p">);</span>

	<span class="cm">/* Opcodes */</span>
	<span class="n">BNX2X_ALLOC_AND_SET</span><span class="p">(</span><span class="n">init_ops</span><span class="p">,</span> <span class="n">init_ops_alloc_err</span><span class="p">,</span> <span class="n">bnx2x_prep_ops</span><span class="p">);</span>

	<span class="cm">/* Offsets */</span>
	<span class="n">BNX2X_ALLOC_AND_SET</span><span class="p">(</span><span class="n">init_ops_offsets</span><span class="p">,</span> <span class="n">init_offsets_alloc_err</span><span class="p">,</span>
			    <span class="n">be16_to_cpu_n</span><span class="p">);</span>

	<span class="cm">/* STORMs firmware */</span>
	<span class="n">INIT_TSEM_INT_TABLE_DATA</span><span class="p">(</span><span class="n">bp</span><span class="p">)</span> <span class="o">=</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">firmware</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span>
			<span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">fw_hdr</span><span class="o">-&gt;</span><span class="n">tsem_int_table_data</span><span class="p">.</span><span class="n">offset</span><span class="p">);</span>
	<span class="n">INIT_TSEM_PRAM_DATA</span><span class="p">(</span><span class="n">bp</span><span class="p">)</span>      <span class="o">=</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">firmware</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span>
			<span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">fw_hdr</span><span class="o">-&gt;</span><span class="n">tsem_pram_data</span><span class="p">.</span><span class="n">offset</span><span class="p">);</span>
	<span class="n">INIT_USEM_INT_TABLE_DATA</span><span class="p">(</span><span class="n">bp</span><span class="p">)</span> <span class="o">=</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">firmware</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span>
			<span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">fw_hdr</span><span class="o">-&gt;</span><span class="n">usem_int_table_data</span><span class="p">.</span><span class="n">offset</span><span class="p">);</span>
	<span class="n">INIT_USEM_PRAM_DATA</span><span class="p">(</span><span class="n">bp</span><span class="p">)</span>      <span class="o">=</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">firmware</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span>
			<span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">fw_hdr</span><span class="o">-&gt;</span><span class="n">usem_pram_data</span><span class="p">.</span><span class="n">offset</span><span class="p">);</span>
	<span class="n">INIT_XSEM_INT_TABLE_DATA</span><span class="p">(</span><span class="n">bp</span><span class="p">)</span> <span class="o">=</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">firmware</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span>
			<span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">fw_hdr</span><span class="o">-&gt;</span><span class="n">xsem_int_table_data</span><span class="p">.</span><span class="n">offset</span><span class="p">);</span>
	<span class="n">INIT_XSEM_PRAM_DATA</span><span class="p">(</span><span class="n">bp</span><span class="p">)</span>      <span class="o">=</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">firmware</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span>
			<span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">fw_hdr</span><span class="o">-&gt;</span><span class="n">xsem_pram_data</span><span class="p">.</span><span class="n">offset</span><span class="p">);</span>
	<span class="n">INIT_CSEM_INT_TABLE_DATA</span><span class="p">(</span><span class="n">bp</span><span class="p">)</span> <span class="o">=</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">firmware</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span>
			<span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">fw_hdr</span><span class="o">-&gt;</span><span class="n">csem_int_table_data</span><span class="p">.</span><span class="n">offset</span><span class="p">);</span>
	<span class="n">INIT_CSEM_PRAM_DATA</span><span class="p">(</span><span class="n">bp</span><span class="p">)</span>      <span class="o">=</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">firmware</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span>
			<span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">fw_hdr</span><span class="o">-&gt;</span><span class="n">csem_pram_data</span><span class="p">.</span><span class="n">offset</span><span class="p">);</span>
	<span class="cm">/* IRO */</span>
	<span class="n">BNX2X_ALLOC_AND_SET</span><span class="p">(</span><span class="n">iro_arr</span><span class="p">,</span> <span class="n">iro_alloc_err</span><span class="p">,</span> <span class="n">bnx2x_prep_iro</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">iro_alloc_err:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">init_ops_offsets</span><span class="p">);</span>
<span class="nl">init_offsets_alloc_err:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">init_ops</span><span class="p">);</span>
<span class="nl">init_ops_alloc_err:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">init_data</span><span class="p">);</span>
<span class="nl">request_firmware_exit:</span>
	<span class="n">release_firmware</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">firmware</span><span class="p">);</span>
	<span class="n">bp</span><span class="o">-&gt;</span><span class="n">firmware</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_release_firmware</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">init_ops_offsets</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">init_ops</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">init_data</span><span class="p">);</span>
	<span class="n">release_firmware</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">firmware</span><span class="p">);</span>
	<span class="n">bp</span><span class="o">-&gt;</span><span class="n">firmware</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="k">struct</span> <span class="n">bnx2x_func_sp_drv_ops</span> <span class="n">bnx2x_func_sp_drv</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">init_hw_cmn_chip</span> <span class="o">=</span> <span class="n">bnx2x_init_hw_common_chip</span><span class="p">,</span>
	<span class="p">.</span><span class="n">init_hw_cmn</span>      <span class="o">=</span> <span class="n">bnx2x_init_hw_common</span><span class="p">,</span>
	<span class="p">.</span><span class="n">init_hw_port</span>     <span class="o">=</span> <span class="n">bnx2x_init_hw_port</span><span class="p">,</span>
	<span class="p">.</span><span class="n">init_hw_func</span>     <span class="o">=</span> <span class="n">bnx2x_init_hw_func</span><span class="p">,</span>

	<span class="p">.</span><span class="n">reset_hw_cmn</span>     <span class="o">=</span> <span class="n">bnx2x_reset_common</span><span class="p">,</span>
	<span class="p">.</span><span class="n">reset_hw_port</span>    <span class="o">=</span> <span class="n">bnx2x_reset_port</span><span class="p">,</span>
	<span class="p">.</span><span class="n">reset_hw_func</span>    <span class="o">=</span> <span class="n">bnx2x_reset_func</span><span class="p">,</span>

	<span class="p">.</span><span class="n">gunzip_init</span>      <span class="o">=</span> <span class="n">bnx2x_gunzip_init</span><span class="p">,</span>
	<span class="p">.</span><span class="n">gunzip_end</span>       <span class="o">=</span> <span class="n">bnx2x_gunzip_end</span><span class="p">,</span>

	<span class="p">.</span><span class="n">init_fw</span>          <span class="o">=</span> <span class="n">bnx2x_init_firmware</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release_fw</span>       <span class="o">=</span> <span class="n">bnx2x_release_firmware</span><span class="p">,</span>
<span class="p">};</span>

<span class="kt">void</span> <span class="nf">bnx2x__init_func_obj</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Prepare DMAE related driver resources */</span>
	<span class="n">bnx2x_setup_dmae</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>

	<span class="n">bnx2x_init_func_obj</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">func_obj</span><span class="p">,</span>
			    <span class="n">bnx2x_sp</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">func_rdata</span><span class="p">),</span>
			    <span class="n">bnx2x_sp_mapping</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">func_rdata</span><span class="p">),</span>
			    <span class="n">bnx2x_sp</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">func_afex_rdata</span><span class="p">),</span>
			    <span class="n">bnx2x_sp_mapping</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">func_afex_rdata</span><span class="p">),</span>
			    <span class="o">&amp;</span><span class="n">bnx2x_func_sp_drv</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* must be called after sriov-enable */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">bnx2x_set_qm_cid_count</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">cid_count</span> <span class="o">=</span> <span class="n">BNX2X_L2_CID_COUNT</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>

<span class="cp">#ifdef BCM_CNIC</span>
	<span class="n">cid_count</span> <span class="o">+=</span> <span class="n">CNIC_CID_MAX</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="k">return</span> <span class="n">roundup</span><span class="p">(</span><span class="n">cid_count</span><span class="p">,</span> <span class="n">QM_CID_ROUND</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * bnx2x_get_num_none_def_sbs - return the number of none default SBs</span>
<span class="cm"> *</span>
<span class="cm"> * @dev:	pci device</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">bnx2x_get_num_non_def_sbs</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">pos</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">control</span><span class="p">;</span>

	<span class="n">pos</span> <span class="o">=</span> <span class="n">pci_find_capability</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_CAP_ID_MSIX</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * If MSI-X is not supported - return number of SBs needed to support</span>
<span class="cm">	 * one fast path queue: one FP queue + SB for CNIC</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pos</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">CNIC_PRESENT</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * The value in the PCI configuration space is the index of the last</span>
<span class="cm">	 * entry, namely one less than the actual size of the table, which is</span>
<span class="cm">	 * exactly what we want to return from this function: number of all SBs</span>
<span class="cm">	 * without the default SB.</span>
<span class="cm">	 */</span>
	<span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">pos</span>  <span class="o">+</span> <span class="n">PCI_MSI_FLAGS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">control</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">control</span> <span class="o">&amp;</span> <span class="n">PCI_MSIX_FLAGS_QSIZE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">bnx2x_init_one</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span>
				    <span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="o">*</span><span class="n">ent</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">pcie_width</span><span class="p">,</span> <span class="n">pcie_speed</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">,</span> <span class="n">max_non_def_sbs</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rx_count</span><span class="p">,</span> <span class="n">tx_count</span><span class="p">,</span> <span class="n">rss_count</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * An estimated maximum supported CoS number according to the chip</span>
<span class="cm">	 * version.</span>
<span class="cm">	 * We will try to roughly estimate the maximum number of CoSes this chip</span>
<span class="cm">	 * may support in order to minimize the memory allocated for Tx</span>
<span class="cm">	 * netdev_queue&#39;s. This number will be accurately calculated during the</span>
<span class="cm">	 * initialization of bp-&gt;max_cos based on the chip versions AND chip</span>
<span class="cm">	 * revision in the bnx2x_init_bp().</span>
<span class="cm">	 */</span>
	<span class="n">u8</span> <span class="n">max_cos_est</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">ent</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">BCM57710</span>:
	<span class="k">case</span> <span class="n">BCM57711</span>:
	<span class="k">case</span> <span class="n">BCM57711E</span>:
		<span class="n">max_cos_est</span> <span class="o">=</span> <span class="n">BNX2X_MULTI_TX_COS_E1X</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BCM57712</span>:
	<span class="k">case</span> <span class="n">BCM57712_MF</span>:
		<span class="n">max_cos_est</span> <span class="o">=</span> <span class="n">BNX2X_MULTI_TX_COS_E2_E3A0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BCM57800</span>:
	<span class="k">case</span> <span class="n">BCM57800_MF</span>:
	<span class="k">case</span> <span class="n">BCM57810</span>:
	<span class="k">case</span> <span class="n">BCM57810_MF</span>:
	<span class="k">case</span> <span class="n">BCM57840</span>:
	<span class="k">case</span> <span class="n">BCM57840_MF</span>:
	<span class="k">case</span> <span class="n">BCM57811</span>:
	<span class="k">case</span> <span class="n">BCM57811_MF</span>:
		<span class="n">max_cos_est</span> <span class="o">=</span> <span class="n">BNX2X_MULTI_TX_COS_E3B0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Unknown board_type (%ld), aborting</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">ent</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">max_non_def_sbs</span> <span class="o">=</span> <span class="n">bnx2x_get_num_non_def_sbs</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="cm">/* !!! FIXME !!!</span>
<span class="cm">	 * Do not allow the maximum SB count to grow above 16</span>
<span class="cm">	 * since Special CIDs starts from 16*BNX2X_MULTI_TX_COS=48.</span>
<span class="cm">	 * We will use the FP_SB_MAX_E1x macro for this matter.</span>
<span class="cm">	 */</span>
	<span class="n">max_non_def_sbs</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="n">FP_SB_MAX_E1x</span><span class="p">,</span> <span class="n">max_non_def_sbs</span><span class="p">);</span>

	<span class="n">WARN_ON</span><span class="p">(</span><span class="o">!</span><span class="n">max_non_def_sbs</span><span class="p">);</span>

	<span class="cm">/* Maximum number of RSS queues: one IGU SB goes to CNIC */</span>
	<span class="n">rss_count</span> <span class="o">=</span> <span class="n">max_non_def_sbs</span> <span class="o">-</span> <span class="n">CNIC_PRESENT</span><span class="p">;</span>

	<span class="cm">/* Maximum number of netdev Rx queues: RSS + FCoE L2 */</span>
	<span class="n">rx_count</span> <span class="o">=</span> <span class="n">rss_count</span> <span class="o">+</span> <span class="n">FCOE_PRESENT</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Maximum number of netdev Tx queues:</span>
<span class="cm">	 *      Maximum TSS queues * Maximum supported number of CoS  + FCoE L2</span>
<span class="cm">	 */</span>
	<span class="n">tx_count</span> <span class="o">=</span> <span class="n">MAX_TXQS_PER_COS</span> <span class="o">*</span> <span class="n">max_cos_est</span> <span class="o">+</span> <span class="n">FCOE_PRESENT</span><span class="p">;</span>

	<span class="cm">/* dev zeroed in init_etherdev */</span>
	<span class="n">dev</span> <span class="o">=</span> <span class="n">alloc_etherdev_mqs</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">bp</span><span class="p">),</span> <span class="n">tx_count</span><span class="p">,</span> <span class="n">rx_count</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">bp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">BNX2X_DEV_INFO</span><span class="p">(</span><span class="s">&quot;Allocated netdev with %d tx and %d rx queues</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">tx_count</span><span class="p">,</span> <span class="n">rx_count</span><span class="p">);</span>

	<span class="n">bp</span><span class="o">-&gt;</span><span class="n">igu_sb_cnt</span> <span class="o">=</span> <span class="n">max_non_def_sbs</span><span class="p">;</span>
	<span class="n">bp</span><span class="o">-&gt;</span><span class="n">msg_enable</span> <span class="o">=</span> <span class="n">debug</span><span class="p">;</span>
	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">bnx2x_init_dev</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="n">ent</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">free_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">BNX2X_DEV_INFO</span><span class="p">(</span><span class="s">&quot;max_non_def_sbs %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">max_non_def_sbs</span><span class="p">);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">bnx2x_init_bp</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">init_one_exit</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Map doorbels here as we need the real value of bp-&gt;max_cos which</span>
<span class="cm">	 * is initialized in bnx2x_init_bp().</span>
<span class="cm">	 */</span>
	<span class="n">bp</span><span class="o">-&gt;</span><span class="n">doorbells</span> <span class="o">=</span> <span class="n">ioremap_nocache</span><span class="p">(</span><span class="n">pci_resource_start</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
					<span class="n">min_t</span><span class="p">(</span><span class="n">u64</span><span class="p">,</span> <span class="n">BNX2X_DB_SIZE</span><span class="p">(</span><span class="n">bp</span><span class="p">),</span>
					      <span class="n">pci_resource_len</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">2</span><span class="p">)));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">doorbells</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;Cannot map doorbell space, aborting</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">init_one_exit</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* calc qm_cid_count */</span>
	<span class="n">bp</span><span class="o">-&gt;</span><span class="n">qm_cid_count</span> <span class="o">=</span> <span class="n">bnx2x_set_qm_cid_count</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>

<span class="cp">#ifdef BCM_CNIC</span>
	<span class="cm">/* disable FCOE L2 queue for E1x */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">CHIP_IS_E1x</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span>
		<span class="n">bp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">NO_FCOE_FLAG</span><span class="p">;</span>

<span class="cp">#endif</span>

	<span class="cm">/* Configure interrupt mode: try to enable MSI-X/MSI if</span>
<span class="cm">	 * needed, set bp-&gt;num_queues appropriately.</span>
<span class="cm">	 */</span>
	<span class="n">bnx2x_set_int_mode</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>

	<span class="cm">/* Add all NAPI objects */</span>
	<span class="n">bnx2x_add_all_napi</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">register_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Cannot register net device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">init_one_exit</span><span class="p">;</span>
	<span class="p">}</span>

<span class="cp">#ifdef BCM_CNIC</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">NO_FCOE</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Add storage MAC address */</span>
		<span class="n">rtnl_lock</span><span class="p">();</span>
		<span class="n">dev_addr_add</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">fip_mac</span><span class="p">,</span> <span class="n">NETDEV_HW_ADDR_T_SAN</span><span class="p">);</span>
		<span class="n">rtnl_unlock</span><span class="p">();</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="n">bnx2x_get_pcie_width_speed</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pcie_width</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pcie_speed</span><span class="p">);</span>

	<span class="n">BNX2X_DEV_INFO</span><span class="p">(</span>
		<span class="s">&quot;%s (%c%d) PCI-E x%d %s found at mem %lx, IRQ %d, node addr %pM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">board_info</span><span class="p">[</span><span class="n">ent</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">].</span><span class="n">name</span><span class="p">,</span>
		    <span class="p">(</span><span class="n">CHIP_REV</span><span class="p">(</span><span class="n">bp</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">+</span> <span class="sc">&#39;A&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">CHIP_METAL</span><span class="p">(</span><span class="n">bp</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">),</span>
		    <span class="n">pcie_width</span><span class="p">,</span>
		    <span class="p">((</span><span class="o">!</span><span class="n">CHIP_IS_E2</span><span class="p">(</span><span class="n">bp</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">pcie_speed</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="o">||</span>
		     <span class="p">(</span><span class="n">CHIP_IS_E2</span><span class="p">(</span><span class="n">bp</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">pcie_speed</span> <span class="o">==</span> <span class="mi">1</span><span class="p">))</span> <span class="o">?</span>
		    <span class="s">&quot;5GHz (Gen2)&quot;</span> <span class="o">:</span> <span class="s">&quot;2.5GHz&quot;</span><span class="p">,</span>
		    <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">,</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">init_one_exit:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">regview</span><span class="p">)</span>
		<span class="n">iounmap</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">regview</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">doorbells</span><span class="p">)</span>
		<span class="n">iounmap</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">doorbells</span><span class="p">);</span>

	<span class="n">free_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">enable_cnt</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">pci_release_regions</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devexit</span> <span class="nf">bnx2x_remove_one</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;BAD net device from bnx2x_init_one</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">bp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

<span class="cp">#ifdef BCM_CNIC</span>
	<span class="cm">/* Delete storage MAC address */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">NO_FCOE</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rtnl_lock</span><span class="p">();</span>
		<span class="n">dev_addr_del</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">fip_mac</span><span class="p">,</span> <span class="n">NETDEV_HW_ADDR_T_SAN</span><span class="p">);</span>
		<span class="n">rtnl_unlock</span><span class="p">();</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef BCM_DCBNL</span>
	<span class="cm">/* Delete app tlvs from dcbnl */</span>
	<span class="n">bnx2x_dcbnl_update_applist</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="n">unregister_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* Delete all NAPI objects */</span>
	<span class="n">bnx2x_del_all_napi</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>

	<span class="cm">/* Power on: we can&#39;t let PCI layer write to us while we are in D3 */</span>
	<span class="n">bnx2x_set_power_state</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">PCI_D0</span><span class="p">);</span>

	<span class="cm">/* Disable MSI/MSI-X */</span>
	<span class="n">bnx2x_disable_msi</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>

	<span class="cm">/* Power off */</span>
	<span class="n">bnx2x_set_power_state</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">PCI_D3hot</span><span class="p">);</span>

	<span class="cm">/* Make sure RESET task is not scheduled before continuing */</span>
	<span class="n">cancel_delayed_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">sp_rtnl_task</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">regview</span><span class="p">)</span>
		<span class="n">iounmap</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">regview</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">doorbells</span><span class="p">)</span>
		<span class="n">iounmap</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">doorbells</span><span class="p">);</span>

	<span class="n">bnx2x_release_firmware</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>

	<span class="n">bnx2x_free_mem_bp</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>

	<span class="n">free_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">enable_cnt</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">pci_release_regions</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bnx2x_eeh_nic_unload</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">bp</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">BNX2X_STATE_ERROR</span><span class="p">;</span>

	<span class="n">bp</span><span class="o">-&gt;</span><span class="n">rx_mode</span> <span class="o">=</span> <span class="n">BNX2X_RX_MODE_NONE</span><span class="p">;</span>

<span class="cp">#ifdef BCM_CNIC</span>
	<span class="n">bnx2x_cnic_notify</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">CNIC_CTL_STOP_CMD</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="cm">/* Stop Tx */</span>
	<span class="n">bnx2x_tx_disable</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>

	<span class="n">bnx2x_netif_stop</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>

	<span class="n">bnx2x_stats_handle</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">STATS_EVENT_STOP</span><span class="p">);</span>

	<span class="cm">/* Release IRQs */</span>
	<span class="n">bnx2x_free_irq</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>

	<span class="cm">/* Free SKBs, SGEs, TPA pool and driver internals */</span>
	<span class="n">bnx2x_free_skbs</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>

	<span class="n">for_each_rx_queue</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
		<span class="n">bnx2x_free_rx_sge_range</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">fp</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="n">NUM_RX_SGE</span><span class="p">);</span>

	<span class="n">bnx2x_free_mem</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>

	<span class="n">bp</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">BNX2X_STATE_CLOSED</span><span class="p">;</span>

	<span class="n">netif_carrier_off</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_eeh_recover</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">phy_mutex</span><span class="p">);</span>


	<span class="n">val</span> <span class="o">=</span> <span class="n">SHMEM_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">validity_map</span><span class="p">[</span><span class="n">BP_PORT</span><span class="p">(</span><span class="n">bp</span><span class="p">)]);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">val</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">SHR_MEM_VALIDITY_DEV_INFO</span> <span class="o">|</span> <span class="n">SHR_MEM_VALIDITY_MB</span><span class="p">))</span>
		<span class="o">!=</span> <span class="p">(</span><span class="n">SHR_MEM_VALIDITY_DEV_INFO</span> <span class="o">|</span> <span class="n">SHR_MEM_VALIDITY_MB</span><span class="p">))</span>
		<span class="n">BNX2X_ERR</span><span class="p">(</span><span class="s">&quot;BAD MCP validity signature</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * bnx2x_io_error_detected - called when PCI error is detected</span>
<span class="cm"> * @pdev: Pointer to PCI device</span>
<span class="cm"> * @state: The current pci connection state</span>
<span class="cm"> *</span>
<span class="cm"> * This function is called after a PCI bus error affecting</span>
<span class="cm"> * this device has been detected.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">pci_ers_result_t</span> <span class="nf">bnx2x_io_error_detected</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span>
						<span class="n">pci_channel_state_t</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">rtnl_lock</span><span class="p">();</span>

	<span class="n">netif_device_detach</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">state</span> <span class="o">==</span> <span class="n">pci_channel_io_perm_failure</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rtnl_unlock</span><span class="p">();</span>
		<span class="k">return</span> <span class="n">PCI_ERS_RESULT_DISCONNECT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">netif_running</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="n">bnx2x_eeh_nic_unload</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>

	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="n">rtnl_unlock</span><span class="p">();</span>

	<span class="cm">/* Request a slot reset */</span>
	<span class="k">return</span> <span class="n">PCI_ERS_RESULT_NEED_RESET</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * bnx2x_io_slot_reset - called after the PCI bus has been reset</span>
<span class="cm"> * @pdev: Pointer to PCI device</span>
<span class="cm"> *</span>
<span class="cm"> * Restart the card from scratch, as if from a cold-boot.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">pci_ers_result_t</span> <span class="nf">bnx2x_io_slot_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">rtnl_lock</span><span class="p">();</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pci_enable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;Cannot re-enable PCI device after reset</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">rtnl_unlock</span><span class="p">();</span>
		<span class="k">return</span> <span class="n">PCI_ERS_RESULT_DISCONNECT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pci_set_master</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">pci_restore_state</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">netif_running</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="n">bnx2x_set_power_state</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">PCI_D0</span><span class="p">);</span>

	<span class="n">rtnl_unlock</span><span class="p">();</span>

	<span class="k">return</span> <span class="n">PCI_ERS_RESULT_RECOVERED</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * bnx2x_io_resume - called when traffic can start flowing again</span>
<span class="cm"> * @pdev: Pointer to PCI device</span>
<span class="cm"> *</span>
<span class="cm"> * This callback is called when the error recovery driver tells us that</span>
<span class="cm"> * its OK to resume normal operation.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_io_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">recovery_state</span> <span class="o">!=</span> <span class="n">BNX2X_RECOVERY_DONE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netdev_err</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Handling parity error recovery. Try again later</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rtnl_lock</span><span class="p">();</span>

	<span class="n">bnx2x_eeh_recover</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">netif_running</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="n">bnx2x_nic_load</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">LOAD_NORMAL</span><span class="p">);</span>

	<span class="n">netif_device_attach</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">rtnl_unlock</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_error_handlers</span> <span class="n">bnx2x_err_handler</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">error_detected</span> <span class="o">=</span> <span class="n">bnx2x_io_error_detected</span><span class="p">,</span>
	<span class="p">.</span><span class="n">slot_reset</span>     <span class="o">=</span> <span class="n">bnx2x_io_slot_reset</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume</span>         <span class="o">=</span> <span class="n">bnx2x_io_resume</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_driver</span> <span class="n">bnx2x_pci_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>        <span class="o">=</span> <span class="n">DRV_MODULE_NAME</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span>    <span class="o">=</span> <span class="n">bnx2x_pci_tbl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span>       <span class="o">=</span> <span class="n">bnx2x_init_one</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>      <span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">bnx2x_remove_one</span><span class="p">),</span>
	<span class="p">.</span><span class="n">suspend</span>     <span class="o">=</span> <span class="n">bnx2x_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume</span>      <span class="o">=</span> <span class="n">bnx2x_resume</span><span class="p">,</span>
	<span class="p">.</span><span class="n">err_handler</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">bnx2x_err_handler</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">bnx2x_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">version</span><span class="p">);</span>

	<span class="n">bnx2x_wq</span> <span class="o">=</span> <span class="n">create_singlethread_workqueue</span><span class="p">(</span><span class="s">&quot;bnx2x&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bnx2x_wq</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Cannot create workqueue</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">pci_register_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bnx2x_pci_driver</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Cannot register driver</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">destroy_workqueue</span><span class="p">(</span><span class="n">bnx2x_wq</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">bnx2x_cleanup</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">pos</span><span class="p">,</span> <span class="o">*</span><span class="n">q</span><span class="p">;</span>
	<span class="n">pci_unregister_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bnx2x_pci_driver</span><span class="p">);</span>

	<span class="n">destroy_workqueue</span><span class="p">(</span><span class="n">bnx2x_wq</span><span class="p">);</span>

	<span class="cm">/* Free globablly allocated resources */</span>
	<span class="n">list_for_each_safe</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bnx2x_prev_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">bnx2x_prev_path_list</span> <span class="o">*</span><span class="n">tmp</span> <span class="o">=</span>
			<span class="n">list_entry</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bnx2x_prev_path_list</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>
		<span class="n">list_del</span><span class="p">(</span><span class="n">pos</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">tmp</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">bnx2x_notify_link_changed</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">MISC_REG_AEU_GENERAL_ATTN_12</span> <span class="o">+</span> <span class="n">BP_FUNC</span><span class="p">(</span><span class="n">bp</span><span class="p">)</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">),</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">bnx2x_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">bnx2x_cleanup</span><span class="p">);</span>

<span class="cp">#ifdef BCM_CNIC</span>
<span class="cm">/**</span>
<span class="cm"> * bnx2x_set_iscsi_eth_mac_addr - set iSCSI MAC(s).</span>
<span class="cm"> *</span>
<span class="cm"> * @bp:		driver handle</span>
<span class="cm"> * @set:	set or clear the CAM entry</span>
<span class="cm"> *</span>
<span class="cm"> * This function will wait until the ramdord completion returns.</span>
<span class="cm"> * Return 0 if success, -ENODEV if ramrod doesn&#39;t return.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">bnx2x_set_iscsi_eth_mac_addr</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ramrod_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">__set_bit</span><span class="p">(</span><span class="n">RAMROD_COMP_WAIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ramrod_flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">bnx2x_set_mac_one</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">cnic_eth_dev</span><span class="p">.</span><span class="n">iscsi_mac</span><span class="p">,</span>
				 <span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">iscsi_l2_mac_obj</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span>
				 <span class="n">BNX2X_ISCSI_ETH_MAC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ramrod_flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* count denotes the number of new completions we have seen */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_cnic_sp_post</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">eth_spe</span> <span class="o">*</span><span class="n">spe</span><span class="p">;</span>

<span class="cp">#ifdef BNX2X_STOP_ON_ERROR</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">panic</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">spq_lock</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">cnic_spq_pending</span> <span class="o">&lt;</span> <span class="n">count</span><span class="p">);</span>
	<span class="n">bp</span><span class="o">-&gt;</span><span class="n">cnic_spq_pending</span> <span class="o">-=</span> <span class="n">count</span><span class="p">;</span>


	<span class="k">for</span> <span class="p">(;</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">cnic_kwq_pending</span><span class="p">;</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">cnic_kwq_pending</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u16</span> <span class="n">type</span> <span class="o">=</span>  <span class="p">(</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">cnic_kwq_cons</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">type</span><span class="p">)</span>
				<span class="o">&amp;</span> <span class="n">SPE_HDR_CONN_TYPE</span><span class="p">)</span> <span class="o">&gt;&gt;</span>
				<span class="n">SPE_HDR_CONN_TYPE_SHIFT</span><span class="p">;</span>
		<span class="n">u8</span> <span class="n">cmd</span> <span class="o">=</span> <span class="p">(</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">cnic_kwq_cons</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">conn_and_cmd_data</span><span class="p">)</span>
				<span class="o">&gt;&gt;</span> <span class="n">SPE_HDR_CMD_ID_SHIFT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>

		<span class="cm">/* Set validation for iSCSI L2 client before sending SETUP</span>
<span class="cm">		 *  ramrod</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">ETH_CONNECTION_TYPE</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">RAMROD_CMD_ID_ETH_CLIENT_SETUP</span><span class="p">)</span>
				<span class="n">bnx2x_set_ctx_validation</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">.</span>
					<span class="n">vcxt</span><span class="p">[</span><span class="n">BNX2X_ISCSI_ETH_CID</span><span class="p">].</span><span class="n">eth</span><span class="p">,</span>
					<span class="n">BNX2X_ISCSI_ETH_CID</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/*</span>
<span class="cm">		 * There may be not more than 8 L2, not more than 8 L5 SPEs</span>
<span class="cm">		 * and in the air. We also check that number of outstanding</span>
<span class="cm">		 * COMMON ramrods is not more than the EQ and SPQ can</span>
<span class="cm">		 * accommodate.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">ETH_CONNECTION_TYPE</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">cq_spq_left</span><span class="p">))</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">cq_spq_left</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">NONE_CONNECTION_TYPE</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">eq_spq_left</span><span class="p">))</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">eq_spq_left</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">type</span> <span class="o">==</span> <span class="n">ISCSI_CONNECTION_TYPE</span><span class="p">)</span> <span class="o">||</span>
			   <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">FCOE_CONNECTION_TYPE</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">cnic_spq_pending</span> <span class="o">&gt;=</span>
			    <span class="n">bp</span><span class="o">-&gt;</span><span class="n">cnic_eth_dev</span><span class="p">.</span><span class="n">max_kwqe_pending</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">bp</span><span class="o">-&gt;</span><span class="n">cnic_spq_pending</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">BNX2X_ERR</span><span class="p">(</span><span class="s">&quot;Unknown SPE type: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">type</span><span class="p">);</span>
			<span class="n">bnx2x_panic</span><span class="p">();</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">spe</span> <span class="o">=</span> <span class="n">bnx2x_sp_get_next</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
		<span class="o">*</span><span class="n">spe</span> <span class="o">=</span> <span class="o">*</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">cnic_kwq_cons</span><span class="p">;</span>

		<span class="n">DP</span><span class="p">(</span><span class="n">BNX2X_MSG_SP</span><span class="p">,</span> <span class="s">&quot;pending on SPQ %d, on KWQ %d count %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">bp</span><span class="o">-&gt;</span><span class="n">cnic_spq_pending</span><span class="p">,</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">cnic_kwq_pending</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">cnic_kwq_cons</span> <span class="o">==</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">cnic_kwq_last</span><span class="p">)</span>
			<span class="n">bp</span><span class="o">-&gt;</span><span class="n">cnic_kwq_cons</span> <span class="o">=</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">cnic_kwq</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">bp</span><span class="o">-&gt;</span><span class="n">cnic_kwq_cons</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">bnx2x_sp_prod_update</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">spq_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bnx2x_cnic_sp_queue</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">kwqe_16</span> <span class="o">*</span><span class="n">kwqes</span><span class="p">[],</span> <span class="n">u32</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

<span class="cp">#ifdef BNX2X_STOP_ON_ERROR</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">panic</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">BNX2X_ERR</span><span class="p">(</span><span class="s">&quot;Can&#39;t post to SP queue while panic</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">recovery_state</span> <span class="o">!=</span> <span class="n">BNX2X_RECOVERY_DONE</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">recovery_state</span> <span class="o">!=</span> <span class="n">BNX2X_RECOVERY_NIC_LOADING</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">BNX2X_ERR</span><span class="p">(</span><span class="s">&quot;Handling parity error recovery. Try again later</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">spq_lock</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">eth_spe</span> <span class="o">*</span><span class="n">spe</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">eth_spe</span> <span class="o">*</span><span class="p">)</span><span class="n">kwqes</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">cnic_kwq_pending</span> <span class="o">==</span> <span class="n">MAX_SP_DESC_CNT</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="o">*</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">cnic_kwq_prod</span> <span class="o">=</span> <span class="o">*</span><span class="n">spe</span><span class="p">;</span>

		<span class="n">bp</span><span class="o">-&gt;</span><span class="n">cnic_kwq_pending</span><span class="o">++</span><span class="p">;</span>

		<span class="n">DP</span><span class="p">(</span><span class="n">BNX2X_MSG_SP</span><span class="p">,</span> <span class="s">&quot;L5 SPQE %x %x %x:%x pos %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">spe</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">conn_and_cmd_data</span><span class="p">,</span> <span class="n">spe</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">type</span><span class="p">,</span>
		   <span class="n">spe</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">update_data_addr</span><span class="p">.</span><span class="n">hi</span><span class="p">,</span>
		   <span class="n">spe</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">update_data_addr</span><span class="p">.</span><span class="n">lo</span><span class="p">,</span>
		   <span class="n">bp</span><span class="o">-&gt;</span><span class="n">cnic_kwq_pending</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">cnic_kwq_prod</span> <span class="o">==</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">cnic_kwq_last</span><span class="p">)</span>
			<span class="n">bp</span><span class="o">-&gt;</span><span class="n">cnic_kwq_prod</span> <span class="o">=</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">cnic_kwq</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">bp</span><span class="o">-&gt;</span><span class="n">cnic_kwq_prod</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">spq_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">cnic_spq_pending</span> <span class="o">&lt;</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">cnic_eth_dev</span><span class="p">.</span><span class="n">max_kwqe_pending</span><span class="p">)</span>
		<span class="n">bnx2x_cnic_sp_post</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">i</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bnx2x_cnic_ctl_send</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cnic_ctl_info</span> <span class="o">*</span><span class="n">ctl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cnic_ops</span> <span class="o">*</span><span class="n">c_ops</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">cnic_mutex</span><span class="p">);</span>
	<span class="n">c_ops</span> <span class="o">=</span> <span class="n">rcu_dereference_protected</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">cnic_ops</span><span class="p">,</span>
					  <span class="n">lockdep_is_held</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">cnic_mutex</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">c_ops</span><span class="p">)</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">c_ops</span><span class="o">-&gt;</span><span class="n">cnic_ctl</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">cnic_data</span><span class="p">,</span> <span class="n">ctl</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">cnic_mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bnx2x_cnic_ctl_send_bh</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cnic_ctl_info</span> <span class="o">*</span><span class="n">ctl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cnic_ops</span> <span class="o">*</span><span class="n">c_ops</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">rcu_read_lock</span><span class="p">();</span>
	<span class="n">c_ops</span> <span class="o">=</span> <span class="n">rcu_dereference</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">cnic_ops</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">c_ops</span><span class="p">)</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">c_ops</span><span class="o">-&gt;</span><span class="n">cnic_ctl</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">cnic_data</span><span class="p">,</span> <span class="n">ctl</span><span class="p">);</span>
	<span class="n">rcu_read_unlock</span><span class="p">();</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * for commands that have no data</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">bnx2x_cnic_notify</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cnic_ctl_info</span> <span class="n">ctl</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>

	<span class="n">ctl</span><span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">bnx2x_cnic_ctl_send</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ctl</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_cnic_cfc_comp</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cid</span><span class="p">,</span> <span class="n">u8</span> <span class="n">err</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cnic_ctl_info</span> <span class="n">ctl</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>

	<span class="cm">/* first we tell CNIC and only then we count this as a completion */</span>
	<span class="n">ctl</span><span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">CNIC_CTL_COMPLETION_CMD</span><span class="p">;</span>
	<span class="n">ctl</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">comp</span><span class="p">.</span><span class="n">cid</span> <span class="o">=</span> <span class="n">cid</span><span class="p">;</span>
	<span class="n">ctl</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">comp</span><span class="p">.</span><span class="n">error</span> <span class="o">=</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">bnx2x_cnic_ctl_send_bh</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ctl</span><span class="p">);</span>
	<span class="n">bnx2x_cnic_sp_post</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/* Called with netif_addr_lock_bh() taken.</span>
<span class="cm"> * Sets an rx_mode config for an iSCSI ETH client.</span>
<span class="cm"> * Doesn&#39;t block.</span>
<span class="cm"> * Completion should be checked outside.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_set_iscsi_eth_rx_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">,</span> <span class="n">bool</span> <span class="n">start</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">accept_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ramrod_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">cl_id</span> <span class="o">=</span> <span class="n">bnx2x_cnic_eth_cl_id</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">BNX2X_ISCSI_ETH_CL_ID_IDX</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">sched_state</span> <span class="o">=</span> <span class="n">BNX2X_FILTER_ISCSI_ETH_STOP_SCHED</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">start</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Start accepting on iSCSI L2 ring. Accept all multicasts</span>
<span class="cm">		 * because it&#39;s the only way for UIO Queue to accept</span>
<span class="cm">		 * multicasts (in non-promiscuous mode only one Queue per</span>
<span class="cm">		 * function will receive multicast packets (leading in our</span>
<span class="cm">		 * case).</span>
<span class="cm">		 */</span>
		<span class="n">__set_bit</span><span class="p">(</span><span class="n">BNX2X_ACCEPT_UNICAST</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">accept_flags</span><span class="p">);</span>
		<span class="n">__set_bit</span><span class="p">(</span><span class="n">BNX2X_ACCEPT_ALL_MULTICAST</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">accept_flags</span><span class="p">);</span>
		<span class="n">__set_bit</span><span class="p">(</span><span class="n">BNX2X_ACCEPT_BROADCAST</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">accept_flags</span><span class="p">);</span>
		<span class="n">__set_bit</span><span class="p">(</span><span class="n">BNX2X_ACCEPT_ANY_VLAN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">accept_flags</span><span class="p">);</span>

		<span class="cm">/* Clear STOP_PENDING bit if START is requested */</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">BNX2X_FILTER_ISCSI_ETH_STOP_SCHED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">sp_state</span><span class="p">);</span>

		<span class="n">sched_state</span> <span class="o">=</span> <span class="n">BNX2X_FILTER_ISCSI_ETH_START_SCHED</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="cm">/* Clear START_PENDING bit if STOP is requested */</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">BNX2X_FILTER_ISCSI_ETH_START_SCHED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">sp_state</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">BNX2X_FILTER_RX_MODE_PENDING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">sp_state</span><span class="p">))</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">sched_state</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">sp_state</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">__set_bit</span><span class="p">(</span><span class="n">RAMROD_RX</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ramrod_flags</span><span class="p">);</span>
		<span class="n">bnx2x_set_q_rx_mode</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">cl_id</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">accept_flags</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				    <span class="n">ramrod_flags</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">bnx2x_drv_ctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">drv_ctl_info</span> <span class="o">*</span><span class="n">ctl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">ctl</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">DRV_CTL_CTXTBL_WR_CMD</span>: <span class="p">{</span>
		<span class="n">u32</span> <span class="n">index</span> <span class="o">=</span> <span class="n">ctl</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">offset</span><span class="p">;</span>
		<span class="n">dma_addr_t</span> <span class="n">addr</span> <span class="o">=</span> <span class="n">ctl</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">dma_addr</span><span class="p">;</span>

		<span class="n">bnx2x_ilt_wr</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">case</span> <span class="n">DRV_CTL_RET_L5_SPQ_CREDIT_CMD</span>: <span class="p">{</span>
		<span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="n">ctl</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">credit</span><span class="p">.</span><span class="n">credit_count</span><span class="p">;</span>

		<span class="n">bnx2x_cnic_sp_post</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* rtnl_lock is held.  */</span>
	<span class="k">case</span> <span class="n">DRV_CTL_START_L2_CMD</span>: <span class="p">{</span>
		<span class="k">struct</span> <span class="n">cnic_eth_dev</span> <span class="o">*</span><span class="n">cp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">cnic_eth_dev</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">sp_bits</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="cm">/* Configure the iSCSI classification object */</span>
		<span class="n">bnx2x_init_mac_obj</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">iscsi_l2_mac_obj</span><span class="p">,</span>
				   <span class="n">cp</span><span class="o">-&gt;</span><span class="n">iscsi_l2_client_id</span><span class="p">,</span>
				   <span class="n">cp</span><span class="o">-&gt;</span><span class="n">iscsi_l2_cid</span><span class="p">,</span> <span class="n">BP_FUNC</span><span class="p">(</span><span class="n">bp</span><span class="p">),</span>
				   <span class="n">bnx2x_sp</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">mac_rdata</span><span class="p">),</span>
				   <span class="n">bnx2x_sp_mapping</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">mac_rdata</span><span class="p">),</span>
				   <span class="n">BNX2X_FILTER_MAC_PENDING</span><span class="p">,</span>
				   <span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">sp_state</span><span class="p">,</span> <span class="n">BNX2X_OBJ_TYPE_RX</span><span class="p">,</span>
				   <span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">macs_pool</span><span class="p">);</span>

		<span class="cm">/* Set iSCSI MAC address */</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">bnx2x_set_iscsi_eth_mac_addr</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">mmiowb</span><span class="p">();</span>
		<span class="n">barrier</span><span class="p">();</span>

		<span class="cm">/* Start accepting on iSCSI L2 ring */</span>

		<span class="n">netif_addr_lock_bh</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">bnx2x_set_iscsi_eth_rx_mode</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
		<span class="n">netif_addr_unlock_bh</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

		<span class="cm">/* bits to wait on */</span>
		<span class="n">__set_bit</span><span class="p">(</span><span class="n">BNX2X_FILTER_RX_MODE_PENDING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sp_bits</span><span class="p">);</span>
		<span class="n">__set_bit</span><span class="p">(</span><span class="n">BNX2X_FILTER_ISCSI_ETH_START_SCHED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sp_bits</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bnx2x_wait_sp_comp</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">sp_bits</span><span class="p">))</span>
			<span class="n">BNX2X_ERR</span><span class="p">(</span><span class="s">&quot;rx_mode completion timed out!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* rtnl_lock is held.  */</span>
	<span class="k">case</span> <span class="n">DRV_CTL_STOP_L2_CMD</span>: <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">sp_bits</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="cm">/* Stop accepting on iSCSI L2 ring */</span>
		<span class="n">netif_addr_lock_bh</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">bnx2x_set_iscsi_eth_rx_mode</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
		<span class="n">netif_addr_unlock_bh</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

		<span class="cm">/* bits to wait on */</span>
		<span class="n">__set_bit</span><span class="p">(</span><span class="n">BNX2X_FILTER_RX_MODE_PENDING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sp_bits</span><span class="p">);</span>
		<span class="n">__set_bit</span><span class="p">(</span><span class="n">BNX2X_FILTER_ISCSI_ETH_STOP_SCHED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sp_bits</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bnx2x_wait_sp_comp</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">sp_bits</span><span class="p">))</span>
			<span class="n">BNX2X_ERR</span><span class="p">(</span><span class="s">&quot;rx_mode completion timed out!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="n">mmiowb</span><span class="p">();</span>
		<span class="n">barrier</span><span class="p">();</span>

		<span class="cm">/* Unset iSCSI L2 MAC */</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">bnx2x_del_all_macs</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">iscsi_l2_mac_obj</span><span class="p">,</span>
					<span class="n">BNX2X_ISCSI_ETH_MAC</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">case</span> <span class="n">DRV_CTL_RET_L2_SPQ_CREDIT_CMD</span>: <span class="p">{</span>
		<span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="n">ctl</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">credit</span><span class="p">.</span><span class="n">credit_count</span><span class="p">;</span>

		<span class="n">smp_mb__before_atomic_inc</span><span class="p">();</span>
		<span class="n">atomic_add</span><span class="p">(</span><span class="n">count</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">cq_spq_left</span><span class="p">);</span>
		<span class="n">smp_mb__after_atomic_inc</span><span class="p">();</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">case</span> <span class="n">DRV_CTL_ULP_REGISTER_CMD</span>: <span class="p">{</span>
		<span class="kt">int</span> <span class="n">ulp_type</span> <span class="o">=</span> <span class="n">ctl</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">ulp_type</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">CHIP_IS_E3</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">idx</span> <span class="o">=</span> <span class="n">BP_FW_MB_IDX</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
			<span class="n">u32</span> <span class="n">cap</span><span class="p">;</span>

			<span class="n">cap</span> <span class="o">=</span> <span class="n">SHMEM2_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">drv_capabilities_flag</span><span class="p">[</span><span class="n">idx</span><span class="p">]);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ulp_type</span> <span class="o">==</span> <span class="n">CNIC_ULP_ISCSI</span><span class="p">)</span>
				<span class="n">cap</span> <span class="o">|=</span> <span class="n">DRV_FLAGS_CAPABILITIES_LOADED_ISCSI</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ulp_type</span> <span class="o">==</span> <span class="n">CNIC_ULP_FCOE</span><span class="p">)</span>
				<span class="n">cap</span> <span class="o">|=</span> <span class="n">DRV_FLAGS_CAPABILITIES_LOADED_FCOE</span><span class="p">;</span>
			<span class="n">SHMEM2_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">drv_capabilities_flag</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">cap</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">case</span> <span class="n">DRV_CTL_ULP_UNREGISTER_CMD</span>: <span class="p">{</span>
		<span class="kt">int</span> <span class="n">ulp_type</span> <span class="o">=</span> <span class="n">ctl</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">ulp_type</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">CHIP_IS_E3</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">idx</span> <span class="o">=</span> <span class="n">BP_FW_MB_IDX</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
			<span class="n">u32</span> <span class="n">cap</span><span class="p">;</span>

			<span class="n">cap</span> <span class="o">=</span> <span class="n">SHMEM2_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">drv_capabilities_flag</span><span class="p">[</span><span class="n">idx</span><span class="p">]);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ulp_type</span> <span class="o">==</span> <span class="n">CNIC_ULP_ISCSI</span><span class="p">)</span>
				<span class="n">cap</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">DRV_FLAGS_CAPABILITIES_LOADED_ISCSI</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ulp_type</span> <span class="o">==</span> <span class="n">CNIC_ULP_FCOE</span><span class="p">)</span>
				<span class="n">cap</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">DRV_FLAGS_CAPABILITIES_LOADED_FCOE</span><span class="p">;</span>
			<span class="n">SHMEM2_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">drv_capabilities_flag</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">cap</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="nl">default:</span>
		<span class="n">BNX2X_ERR</span><span class="p">(</span><span class="s">&quot;unknown command %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ctl</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">bnx2x_setup_cnic_irq_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cnic_eth_dev</span> <span class="o">*</span><span class="n">cp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">cnic_eth_dev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">USING_MSIX_FLAG</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cp</span><span class="o">-&gt;</span><span class="n">drv_state</span> <span class="o">|=</span> <span class="n">CNIC_DRV_STATE_USING_MSIX</span><span class="p">;</span>
		<span class="n">cp</span><span class="o">-&gt;</span><span class="n">irq_arr</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">irq_flags</span> <span class="o">|=</span> <span class="n">CNIC_IRQ_FL_MSIX</span><span class="p">;</span>
		<span class="n">cp</span><span class="o">-&gt;</span><span class="n">irq_arr</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">vector</span> <span class="o">=</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">msix_table</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">vector</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">cp</span><span class="o">-&gt;</span><span class="n">drv_state</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">CNIC_DRV_STATE_USING_MSIX</span><span class="p">;</span>
		<span class="n">cp</span><span class="o">-&gt;</span><span class="n">irq_arr</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">irq_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">CNIC_IRQ_FL_MSIX</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CHIP_IS_E1x</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span>
		<span class="n">cp</span><span class="o">-&gt;</span><span class="n">irq_arr</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">status_blk</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">cnic_sb</span><span class="p">.</span><span class="n">e2_sb</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">cp</span><span class="o">-&gt;</span><span class="n">irq_arr</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">status_blk</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">cnic_sb</span><span class="p">.</span><span class="n">e1x_sb</span><span class="p">;</span>

	<span class="n">cp</span><span class="o">-&gt;</span><span class="n">irq_arr</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">status_blk_num</span> <span class="o">=</span>  <span class="n">bnx2x_cnic_fw_sb_id</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
	<span class="n">cp</span><span class="o">-&gt;</span><span class="n">irq_arr</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">status_blk_num2</span> <span class="o">=</span> <span class="n">bnx2x_cnic_igu_sb_id</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
	<span class="n">cp</span><span class="o">-&gt;</span><span class="n">irq_arr</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">status_blk</span> <span class="o">=</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">def_status_blk</span><span class="p">;</span>
	<span class="n">cp</span><span class="o">-&gt;</span><span class="n">irq_arr</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">status_blk_num</span> <span class="o">=</span> <span class="n">DEF_SB_ID</span><span class="p">;</span>
	<span class="n">cp</span><span class="o">-&gt;</span><span class="n">irq_arr</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">status_blk_num2</span> <span class="o">=</span> <span class="n">DEF_SB_IGU_ID</span><span class="p">;</span>

	<span class="n">cp</span><span class="o">-&gt;</span><span class="n">num_irq</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bnx2x_register_cnic</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cnic_ops</span> <span class="o">*</span><span class="n">ops</span><span class="p">,</span>
			       <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">cnic_eth_dev</span> <span class="o">*</span><span class="n">cp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">cnic_eth_dev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ops</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BNX2X_ERR</span><span class="p">(</span><span class="s">&quot;NULL ops received</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">bp</span><span class="o">-&gt;</span><span class="n">cnic_kwq</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">cnic_kwq</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">bp</span><span class="o">-&gt;</span><span class="n">cnic_kwq_cons</span> <span class="o">=</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">cnic_kwq</span><span class="p">;</span>
	<span class="n">bp</span><span class="o">-&gt;</span><span class="n">cnic_kwq_prod</span> <span class="o">=</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">cnic_kwq</span><span class="p">;</span>
	<span class="n">bp</span><span class="o">-&gt;</span><span class="n">cnic_kwq_last</span> <span class="o">=</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">cnic_kwq</span> <span class="o">+</span> <span class="n">MAX_SP_DESC_CNT</span><span class="p">;</span>

	<span class="n">bp</span><span class="o">-&gt;</span><span class="n">cnic_spq_pending</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">bp</span><span class="o">-&gt;</span><span class="n">cnic_kwq_pending</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">bp</span><span class="o">-&gt;</span><span class="n">cnic_data</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>

	<span class="n">cp</span><span class="o">-&gt;</span><span class="n">num_irq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cp</span><span class="o">-&gt;</span><span class="n">drv_state</span> <span class="o">|=</span> <span class="n">CNIC_DRV_STATE_REGD</span><span class="p">;</span>
	<span class="n">cp</span><span class="o">-&gt;</span><span class="n">iro_arr</span> <span class="o">=</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">iro_arr</span><span class="p">;</span>

	<span class="n">bnx2x_setup_cnic_irq_info</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>

	<span class="n">rcu_assign_pointer</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">cnic_ops</span><span class="p">,</span> <span class="n">ops</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bnx2x_unregister_cnic</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">cnic_eth_dev</span> <span class="o">*</span><span class="n">cp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">cnic_eth_dev</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">cnic_mutex</span><span class="p">);</span>
	<span class="n">cp</span><span class="o">-&gt;</span><span class="n">drv_state</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">RCU_INIT_POINTER</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">cnic_ops</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">cnic_mutex</span><span class="p">);</span>
	<span class="n">synchronize_rcu</span><span class="p">();</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">cnic_kwq</span><span class="p">);</span>
	<span class="n">bp</span><span class="o">-&gt;</span><span class="n">cnic_kwq</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">cnic_eth_dev</span> <span class="o">*</span><span class="nf">bnx2x_cnic_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">cnic_eth_dev</span> <span class="o">*</span><span class="n">cp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">cnic_eth_dev</span><span class="p">;</span>

	<span class="cm">/* If both iSCSI and FCoE are disabled - return NULL in</span>
<span class="cm">	 * order to indicate CNIC that it should not try to work</span>
<span class="cm">	 * with this device.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">NO_ISCSI</span><span class="p">(</span><span class="n">bp</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">NO_FCOE</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">cp</span><span class="o">-&gt;</span><span class="n">drv_owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">;</span>
	<span class="n">cp</span><span class="o">-&gt;</span><span class="n">chip_id</span> <span class="o">=</span> <span class="n">CHIP_ID</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
	<span class="n">cp</span><span class="o">-&gt;</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">;</span>
	<span class="n">cp</span><span class="o">-&gt;</span><span class="n">io_base</span> <span class="o">=</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">regview</span><span class="p">;</span>
	<span class="n">cp</span><span class="o">-&gt;</span><span class="n">io_base2</span> <span class="o">=</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">doorbells</span><span class="p">;</span>
	<span class="n">cp</span><span class="o">-&gt;</span><span class="n">max_kwqe_pending</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">cp</span><span class="o">-&gt;</span><span class="n">ctx_blk_size</span> <span class="o">=</span> <span class="n">CDU_ILT_PAGE_SZ</span><span class="p">;</span>
	<span class="n">cp</span><span class="o">-&gt;</span><span class="n">ctx_tbl_offset</span> <span class="o">=</span> <span class="n">FUNC_ILT_BASE</span><span class="p">(</span><span class="n">BP_FUNC</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span> <span class="o">+</span>
			     <span class="n">bnx2x_cid_ilt_lines</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
	<span class="n">cp</span><span class="o">-&gt;</span><span class="n">ctx_tbl_len</span> <span class="o">=</span> <span class="n">CNIC_ILT_LINES</span><span class="p">;</span>
	<span class="n">cp</span><span class="o">-&gt;</span><span class="n">starting_cid</span> <span class="o">=</span> <span class="n">bnx2x_cid_ilt_lines</span><span class="p">(</span><span class="n">bp</span><span class="p">)</span> <span class="o">*</span> <span class="n">ILT_PAGE_CIDS</span><span class="p">;</span>
	<span class="n">cp</span><span class="o">-&gt;</span><span class="n">drv_submit_kwqes_16</span> <span class="o">=</span> <span class="n">bnx2x_cnic_sp_queue</span><span class="p">;</span>
	<span class="n">cp</span><span class="o">-&gt;</span><span class="n">drv_ctl</span> <span class="o">=</span> <span class="n">bnx2x_drv_ctl</span><span class="p">;</span>
	<span class="n">cp</span><span class="o">-&gt;</span><span class="n">drv_register_cnic</span> <span class="o">=</span> <span class="n">bnx2x_register_cnic</span><span class="p">;</span>
	<span class="n">cp</span><span class="o">-&gt;</span><span class="n">drv_unregister_cnic</span> <span class="o">=</span> <span class="n">bnx2x_unregister_cnic</span><span class="p">;</span>
	<span class="n">cp</span><span class="o">-&gt;</span><span class="n">fcoe_init_cid</span> <span class="o">=</span> <span class="n">BNX2X_FCOE_ETH_CID</span><span class="p">;</span>
	<span class="n">cp</span><span class="o">-&gt;</span><span class="n">iscsi_l2_client_id</span> <span class="o">=</span>
		<span class="n">bnx2x_cnic_eth_cl_id</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">BNX2X_ISCSI_ETH_CL_ID_IDX</span><span class="p">);</span>
	<span class="n">cp</span><span class="o">-&gt;</span><span class="n">iscsi_l2_cid</span> <span class="o">=</span> <span class="n">BNX2X_ISCSI_ETH_CID</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">NO_ISCSI_OOO</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span>
		<span class="n">cp</span><span class="o">-&gt;</span><span class="n">drv_state</span> <span class="o">|=</span> <span class="n">CNIC_DRV_STATE_NO_ISCSI_OOO</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">NO_ISCSI</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span>
		<span class="n">cp</span><span class="o">-&gt;</span><span class="n">drv_state</span> <span class="o">|=</span> <span class="n">CNIC_DRV_STATE_NO_ISCSI</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">NO_FCOE</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span>
		<span class="n">cp</span><span class="o">-&gt;</span><span class="n">drv_state</span> <span class="o">|=</span> <span class="n">CNIC_DRV_STATE_NO_FCOE</span><span class="p">;</span>

	<span class="n">BNX2X_DEV_INFO</span><span class="p">(</span>
		<span class="s">&quot;page_size %d, tbl_offset %d, tbl_lines %d, starting cid %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	   <span class="n">cp</span><span class="o">-&gt;</span><span class="n">ctx_blk_size</span><span class="p">,</span>
	   <span class="n">cp</span><span class="o">-&gt;</span><span class="n">ctx_tbl_offset</span><span class="p">,</span>
	   <span class="n">cp</span><span class="o">-&gt;</span><span class="n">ctx_tbl_len</span><span class="p">,</span>
	   <span class="n">cp</span><span class="o">-&gt;</span><span class="n">starting_cid</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">cp</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">bnx2x_cnic_probe</span><span class="p">);</span>

<span class="cp">#endif </span><span class="cm">/* BCM_CNIC */</span><span class="cp"></span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:5}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../../javascript/docco.min.js"></script>
</html>
