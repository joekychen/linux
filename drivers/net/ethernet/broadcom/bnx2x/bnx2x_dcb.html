<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › ethernet › broadcom › bnx2x › bnx2x_dcb.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../../index.html"></a><h1>bnx2x_dcb.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/* bnx2x_dcb.c: Broadcom Everest network driver.</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright 2009-2012 Broadcom Corporation</span>
<span class="cm"> *</span>
<span class="cm"> * Unless you and Broadcom execute a separate written software license</span>
<span class="cm"> * agreement governing use of this software, this software is licensed to you</span>
<span class="cm"> * under the terms of the GNU General Public License version 2, available</span>
<span class="cm"> * at http://www.gnu.org/licenses/old-licenses/gpl-2.0.html (the &quot;GPL&quot;).</span>
<span class="cm"> *</span>
<span class="cm"> * Notwithstanding the above, under no circumstances may you combine this</span>
<span class="cm"> * software in any way with any other Broadcom software provided under a</span>
<span class="cm"> * license other than the GPL, without Broadcom&#39;s express prior written</span>
<span class="cm"> * consent.</span>
<span class="cm"> *</span>
<span class="cm"> * Maintained by: Eilon Greenstein &lt;eilong@broadcom.com&gt;</span>
<span class="cm"> * Written by: Dmitry Kravkov</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#define pr_fmt(fmt) KBUILD_MODNAME &quot;: &quot; fmt</span>

<span class="cp">#include &lt;linux/netdevice.h&gt;</span>
<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/rtnetlink.h&gt;</span>
<span class="cp">#include &lt;net/dcbnl.h&gt;</span>

<span class="cp">#include &quot;bnx2x.h&quot;</span>
<span class="cp">#include &quot;bnx2x_cmn.h&quot;</span>
<span class="cp">#include &quot;bnx2x_dcb.h&quot;</span>

<span class="cm">/* forward declarations of dcbx related functions */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">bnx2x_dcbx_stop_hw_tx</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">bnx2x_pfc_set_pfc</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">bnx2x_dcbx_update_ets_params</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">bnx2x_dcbx_resume_hw_tx</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">bnx2x_dcbx_get_ets_pri_pg_tbl</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">,</span>
					  <span class="n">u32</span> <span class="o">*</span><span class="n">set_configuration_ets_pg</span><span class="p">,</span>
					  <span class="n">u32</span> <span class="o">*</span><span class="n">pri_pg_tbl</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">bnx2x_dcbx_get_num_pg_traf_type</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">,</span>
					    <span class="n">u32</span> <span class="o">*</span><span class="n">pg_pri_orginal_spread</span><span class="p">,</span>
					    <span class="k">struct</span> <span class="n">pg_help_data</span> <span class="o">*</span><span class="n">help_data</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">bnx2x_dcbx_fill_cos_params</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">pg_help_data</span> <span class="o">*</span><span class="n">help_data</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">dcbx_ets_feature</span> <span class="o">*</span><span class="n">ets</span><span class="p">,</span>
				       <span class="n">u32</span> <span class="o">*</span><span class="n">pg_pri_orginal_spread</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">bnx2x_dcbx_separate_pauseable_from_non</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">cos_help_data</span> <span class="o">*</span><span class="n">cos_data</span><span class="p">,</span>
				<span class="n">u32</span> <span class="o">*</span><span class="n">pg_pri_orginal_spread</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">dcbx_ets_feature</span> <span class="o">*</span><span class="n">ets</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">bnx2x_dcbx_fw_struct</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">bnx2x_func_tx_start_params</span><span class="o">*</span><span class="p">);</span>

<span class="cm">/* helpers: read/write len bytes from addr into buff by REG_RD/REG_WR */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_read_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">buff</span><span class="p">,</span>
				   <span class="n">u32</span> <span class="n">addr</span><span class="p">,</span> <span class="n">u32</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">,</span> <span class="n">buff</span><span class="o">++</span><span class="p">)</span>
		<span class="o">*</span><span class="n">buff</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">addr</span> <span class="o">+</span> <span class="n">i</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_write_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">buff</span><span class="p">,</span>
				    <span class="n">u32</span> <span class="n">addr</span><span class="p">,</span> <span class="n">u32</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">,</span> <span class="n">buff</span><span class="o">++</span><span class="p">)</span>
		<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">addr</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="o">*</span><span class="n">buff</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_pfc_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2x_nig_brb_pfc_port_params</span> <span class="n">pfc_params</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
	<span class="n">u32</span> <span class="n">pri_bit</span><span class="p">,</span> <span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">pfc_params</span><span class="p">.</span><span class="n">num_of_rx_cos_priority_mask</span> <span class="o">=</span>
					<span class="n">bp</span><span class="o">-&gt;</span><span class="n">dcbx_port_params</span><span class="p">.</span><span class="n">ets</span><span class="p">.</span><span class="n">num_of_cos</span><span class="p">;</span>

	<span class="cm">/* Tx COS configuration */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">dcbx_port_params</span><span class="p">.</span><span class="n">ets</span><span class="p">.</span><span class="n">num_of_cos</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="cm">/*</span>
<span class="cm">		 * We configure only the pauseable bits (non pauseable aren&#39;t</span>
<span class="cm">		 * configured at all) it&#39;s done to avoid false pauses from</span>
<span class="cm">		 * network</span>
<span class="cm">		 */</span>
		<span class="n">pfc_params</span><span class="p">.</span><span class="n">rx_cos_priority_mask</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span>
			<span class="n">bp</span><span class="o">-&gt;</span><span class="n">dcbx_port_params</span><span class="p">.</span><span class="n">ets</span><span class="p">.</span><span class="n">cos_params</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">pri_bitmask</span>
				<span class="o">&amp;</span> <span class="n">DCBX_PFC_PRI_PAUSE_MASK</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Rx COS configuration</span>
<span class="cm">	 * Changing PFC RX configuration .</span>
<span class="cm">	 * In RX COS0 will always be configured to lossy and COS1 to lossless</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_PFC_PRIORITIES</span> <span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pri_bit</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">pri_bit</span> <span class="o">&amp;</span> <span class="n">DCBX_PFC_PRI_PAUSE_MASK</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span>
			<span class="n">val</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="mi">4</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">pfc_params</span><span class="p">.</span><span class="n">pkt_priority_to_cos</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>

	<span class="cm">/* RX COS0 */</span>
	<span class="n">pfc_params</span><span class="p">.</span><span class="n">llfc_low_priority_classes</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="cm">/* RX COS1 */</span>
	<span class="n">pfc_params</span><span class="p">.</span><span class="n">llfc_high_priority_classes</span> <span class="o">=</span> <span class="n">DCBX_PFC_PRI_PAUSE_MASK</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>

	<span class="cm">/* BRB configuration */</span>
	<span class="n">pfc_params</span><span class="p">.</span><span class="n">cos0_pauseable</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">pfc_params</span><span class="p">.</span><span class="n">cos1_pauseable</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="n">bnx2x_acquire_phy_lock</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
	<span class="n">bp</span><span class="o">-&gt;</span><span class="n">link_params</span><span class="p">.</span><span class="n">feature_config_flags</span> <span class="o">|=</span> <span class="n">FEATURE_CONFIG_PFC_ENABLED</span><span class="p">;</span>
	<span class="n">bnx2x_update_pfc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">link_params</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">link_vars</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pfc_params</span><span class="p">);</span>
	<span class="n">bnx2x_release_phy_lock</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_pfc_clear</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2x_nig_brb_pfc_port_params</span> <span class="n">nig_params</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
	<span class="n">nig_params</span><span class="p">.</span><span class="n">pause_enable</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">bnx2x_acquire_phy_lock</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
	<span class="n">bp</span><span class="o">-&gt;</span><span class="n">link_params</span><span class="p">.</span><span class="n">feature_config_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">FEATURE_CONFIG_PFC_ENABLED</span><span class="p">;</span>
	<span class="n">bnx2x_update_pfc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">link_params</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">link_vars</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nig_params</span><span class="p">);</span>
	<span class="n">bnx2x_release_phy_lock</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>  <span class="nf">bnx2x_dump_dcbx_drv_param</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">dcbx_features</span> <span class="o">*</span><span class="n">features</span><span class="p">,</span>
				       <span class="n">u32</span> <span class="n">error</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;local_mib.error %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">error</span><span class="p">);</span>

	<span class="cm">/* PG */</span>
	<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span>
	   <span class="s">&quot;local_mib.features.ets.enabled %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">features</span><span class="o">-&gt;</span><span class="n">ets</span><span class="p">.</span><span class="n">enabled</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">DCBX_MAX_NUM_PG_BW_ENTRIES</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span>
		   <span class="s">&quot;local_mib.features.ets.pg_bw_tbl[%d] %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span>
		   <span class="n">DCBX_PG_BW_GET</span><span class="p">(</span><span class="n">features</span><span class="o">-&gt;</span><span class="n">ets</span><span class="p">.</span><span class="n">pg_bw_tbl</span><span class="p">,</span> <span class="n">i</span><span class="p">));</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">DCBX_MAX_NUM_PRI_PG_ENTRIES</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span>
		   <span class="s">&quot;local_mib.features.ets.pri_pg_tbl[%d] %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span>
		   <span class="n">DCBX_PRI_PG_GET</span><span class="p">(</span><span class="n">features</span><span class="o">-&gt;</span><span class="n">ets</span><span class="p">.</span><span class="n">pri_pg_tbl</span><span class="p">,</span> <span class="n">i</span><span class="p">));</span>

	<span class="cm">/* pfc */</span>
	<span class="n">DP</span><span class="p">(</span><span class="n">BNX2X_MSG_DCB</span><span class="p">,</span> <span class="s">&quot;dcbx_features.pfc.pri_en_bitmap %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">features</span><span class="o">-&gt;</span><span class="n">pfc</span><span class="p">.</span><span class="n">pri_en_bitmap</span><span class="p">);</span>
	<span class="n">DP</span><span class="p">(</span><span class="n">BNX2X_MSG_DCB</span><span class="p">,</span> <span class="s">&quot;dcbx_features.pfc.pfc_caps %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">features</span><span class="o">-&gt;</span><span class="n">pfc</span><span class="p">.</span><span class="n">pfc_caps</span><span class="p">);</span>
	<span class="n">DP</span><span class="p">(</span><span class="n">BNX2X_MSG_DCB</span><span class="p">,</span> <span class="s">&quot;dcbx_features.pfc.enabled %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">features</span><span class="o">-&gt;</span><span class="n">pfc</span><span class="p">.</span><span class="n">enabled</span><span class="p">);</span>

	<span class="n">DP</span><span class="p">(</span><span class="n">BNX2X_MSG_DCB</span><span class="p">,</span> <span class="s">&quot;dcbx_features.app.default_pri %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">features</span><span class="o">-&gt;</span><span class="n">app</span><span class="p">.</span><span class="n">default_pri</span><span class="p">);</span>
	<span class="n">DP</span><span class="p">(</span><span class="n">BNX2X_MSG_DCB</span><span class="p">,</span> <span class="s">&quot;dcbx_features.app.tc_supported %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">features</span><span class="o">-&gt;</span><span class="n">app</span><span class="p">.</span><span class="n">tc_supported</span><span class="p">);</span>
	<span class="n">DP</span><span class="p">(</span><span class="n">BNX2X_MSG_DCB</span><span class="p">,</span> <span class="s">&quot;dcbx_features.app.enabled %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">features</span><span class="o">-&gt;</span><span class="n">app</span><span class="p">.</span><span class="n">enabled</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">DCBX_MAX_APP_PROTOCOL</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DP</span><span class="p">(</span><span class="n">BNX2X_MSG_DCB</span><span class="p">,</span>
		   <span class="s">&quot;dcbx_features.app.app_pri_tbl[%x].app_id %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">i</span><span class="p">,</span> <span class="n">features</span><span class="o">-&gt;</span><span class="n">app</span><span class="p">.</span><span class="n">app_pri_tbl</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">app_id</span><span class="p">);</span>
		<span class="n">DP</span><span class="p">(</span><span class="n">BNX2X_MSG_DCB</span><span class="p">,</span>
		   <span class="s">&quot;dcbx_features.app.app_pri_tbl[%x].pri_bitmap %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">i</span><span class="p">,</span> <span class="n">features</span><span class="o">-&gt;</span><span class="n">app</span><span class="p">.</span><span class="n">app_pri_tbl</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">pri_bitmap</span><span class="p">);</span>
		<span class="n">DP</span><span class="p">(</span><span class="n">BNX2X_MSG_DCB</span><span class="p">,</span>
		   <span class="s">&quot;dcbx_features.app.app_pri_tbl[%x].appBitfield %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">i</span><span class="p">,</span> <span class="n">features</span><span class="o">-&gt;</span><span class="n">app</span><span class="p">.</span><span class="n">app_pri_tbl</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">appBitfield</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_dcbx_get_ap_priority</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">,</span>
				       <span class="n">u8</span> <span class="n">pri_bitmap</span><span class="p">,</span>
				       <span class="n">u8</span> <span class="n">llfc_traf_type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">pri</span> <span class="o">=</span> <span class="n">MAX_PFC_PRIORITIES</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">index</span> <span class="o">=</span> <span class="n">MAX_PFC_PRIORITIES</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">pri_mask</span><span class="p">;</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">ttp</span> <span class="o">=</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">dcbx_port_params</span><span class="p">.</span><span class="n">app</span><span class="p">.</span><span class="n">traffic_type_priority</span><span class="p">;</span>

	<span class="cm">/* Choose the highest priority */</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">MAX_PFC_PRIORITIES</span> <span class="o">==</span> <span class="n">pri</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="mi">0</span> <span class="o">!=</span> <span class="n">index</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pri_mask</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">index</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">GET_FLAGS</span><span class="p">(</span><span class="n">pri_bitmap</span><span class="p">,</span> <span class="n">pri_mask</span><span class="p">))</span>
			<span class="n">pri</span> <span class="o">=</span> <span class="n">index</span> <span class="p">;</span>
		<span class="n">index</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pri</span> <span class="o">&lt;</span> <span class="n">MAX_PFC_PRIORITIES</span><span class="p">)</span>
		<span class="n">ttp</span><span class="p">[</span><span class="n">llfc_traf_type</span><span class="p">]</span> <span class="o">=</span> <span class="n">max_t</span><span class="p">(</span><span class="n">u32</span><span class="p">,</span> <span class="n">ttp</span><span class="p">[</span><span class="n">llfc_traf_type</span><span class="p">],</span> <span class="n">pri</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_dcbx_get_ap_feature</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">dcbx_app_priority_feature</span> <span class="o">*</span><span class="n">app</span><span class="p">,</span>
				   <span class="n">u32</span> <span class="n">error</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">u8</span> <span class="n">index</span><span class="p">;</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">ttp</span> <span class="o">=</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">dcbx_port_params</span><span class="p">.</span><span class="n">app</span><span class="p">.</span><span class="n">traffic_type_priority</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">GET_FLAGS</span><span class="p">(</span><span class="n">error</span><span class="p">,</span> <span class="n">DCBX_LOCAL_APP_ERROR</span><span class="p">))</span>
		<span class="n">DP</span><span class="p">(</span><span class="n">BNX2X_MSG_DCB</span><span class="p">,</span> <span class="s">&quot;DCBX_LOCAL_APP_ERROR</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">GET_FLAGS</span><span class="p">(</span><span class="n">error</span><span class="p">,</span> <span class="n">DCBX_LOCAL_APP_MISMATCH</span><span class="p">))</span>
		<span class="n">DP</span><span class="p">(</span><span class="n">BNX2X_MSG_DCB</span><span class="p">,</span> <span class="s">&quot;DCBX_LOCAL_APP_MISMATCH</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">GET_FLAGS</span><span class="p">(</span><span class="n">error</span><span class="p">,</span> <span class="n">DCBX_REMOTE_APP_TLV_NOT_FOUND</span><span class="p">))</span>
		<span class="n">DP</span><span class="p">(</span><span class="n">BNX2X_MSG_DCB</span><span class="p">,</span> <span class="s">&quot;DCBX_REMOTE_APP_TLV_NOT_FOUND</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">app</span><span class="o">-&gt;</span><span class="n">enabled</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">GET_FLAGS</span><span class="p">(</span><span class="n">error</span><span class="p">,</span> <span class="n">DCBX_LOCAL_APP_ERROR</span> <span class="o">|</span> <span class="n">DCBX_LOCAL_APP_MISMATCH</span> <span class="o">|</span>
			      <span class="n">DCBX_REMOTE_APP_TLV_NOT_FOUND</span><span class="p">))</span> <span class="p">{</span>

		<span class="n">bp</span><span class="o">-&gt;</span><span class="n">dcbx_port_params</span><span class="p">.</span><span class="n">app</span><span class="p">.</span><span class="n">enabled</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">index</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span> <span class="n">index</span> <span class="o">&lt;</span> <span class="n">LLFC_DRIVER_TRAFFIC_TYPE_MAX</span><span class="p">;</span> <span class="n">index</span><span class="o">++</span><span class="p">)</span>
			<span class="n">ttp</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">app</span><span class="o">-&gt;</span><span class="n">default_pri</span> <span class="o">&lt;</span> <span class="n">MAX_PFC_PRIORITIES</span><span class="p">)</span>
			<span class="n">ttp</span><span class="p">[</span><span class="n">LLFC_TRAFFIC_TYPE_NW</span><span class="p">]</span> <span class="o">=</span> <span class="n">app</span><span class="o">-&gt;</span><span class="n">default_pri</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">index</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span> <span class="n">index</span> <span class="o">&lt;</span> <span class="n">DCBX_MAX_APP_PROTOCOL</span><span class="p">;</span> <span class="n">index</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">dcbx_app_priority_entry</span> <span class="o">*</span><span class="n">entry</span> <span class="o">=</span>
							<span class="n">app</span><span class="o">-&gt;</span><span class="n">app_pri_tbl</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">GET_FLAGS</span><span class="p">(</span><span class="n">entry</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">appBitfield</span><span class="p">,</span>
				     <span class="n">DCBX_APP_SF_ETH_TYPE</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			   <span class="n">ETH_TYPE_FCOE</span> <span class="o">==</span> <span class="n">entry</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">app_id</span><span class="p">)</span>
				<span class="n">bnx2x_dcbx_get_ap_priority</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span>
						<span class="n">entry</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">pri_bitmap</span><span class="p">,</span>
						<span class="n">LLFC_TRAFFIC_TYPE_FCOE</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">GET_FLAGS</span><span class="p">(</span><span class="n">entry</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">appBitfield</span><span class="p">,</span>
				     <span class="n">DCBX_APP_SF_PORT</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			   <span class="n">TCP_PORT_ISCSI</span> <span class="o">==</span> <span class="n">entry</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">app_id</span><span class="p">)</span>
				<span class="n">bnx2x_dcbx_get_ap_priority</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span>
						<span class="n">entry</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">pri_bitmap</span><span class="p">,</span>
						<span class="n">LLFC_TRAFFIC_TYPE_ISCSI</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">DP</span><span class="p">(</span><span class="n">BNX2X_MSG_DCB</span><span class="p">,</span> <span class="s">&quot;DCBX_LOCAL_APP_DISABLED</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">bp</span><span class="o">-&gt;</span><span class="n">dcbx_port_params</span><span class="p">.</span><span class="n">app</span><span class="p">.</span><span class="n">enabled</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">index</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span> <span class="n">index</span> <span class="o">&lt;</span> <span class="n">LLFC_DRIVER_TRAFFIC_TYPE_MAX</span><span class="p">;</span> <span class="n">index</span><span class="o">++</span><span class="p">)</span>
			<span class="n">ttp</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">INVALID_TRAFFIC_TYPE_PRIORITY</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_dcbx_get_ets_feature</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">dcbx_ets_feature</span> <span class="o">*</span><span class="n">ets</span><span class="p">,</span>
				       <span class="n">u32</span> <span class="n">error</span><span class="p">)</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">pg_pri_orginal_spread</span><span class="p">[</span><span class="n">DCBX_MAX_NUM_PG_BW_ENTRIES</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
	<span class="k">struct</span> <span class="n">pg_help_data</span> <span class="n">pg_help_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bnx2x_dcbx_cos_params</span> <span class="o">*</span><span class="n">cos_params</span> <span class="o">=</span>
			<span class="n">bp</span><span class="o">-&gt;</span><span class="n">dcbx_port_params</span><span class="p">.</span><span class="n">ets</span><span class="p">.</span><span class="n">cos_params</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pg_help_data</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">pg_help_data</span><span class="p">));</span>


	<span class="k">if</span> <span class="p">(</span><span class="n">GET_FLAGS</span><span class="p">(</span><span class="n">error</span><span class="p">,</span> <span class="n">DCBX_LOCAL_ETS_ERROR</span><span class="p">))</span>
		<span class="n">DP</span><span class="p">(</span><span class="n">BNX2X_MSG_DCB</span><span class="p">,</span> <span class="s">&quot;DCBX_LOCAL_ETS_ERROR</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">GET_FLAGS</span><span class="p">(</span><span class="n">error</span><span class="p">,</span> <span class="n">DCBX_REMOTE_ETS_TLV_NOT_FOUND</span><span class="p">))</span>
		<span class="n">DP</span><span class="p">(</span><span class="n">BNX2X_MSG_DCB</span><span class="p">,</span> <span class="s">&quot;DCBX_REMOTE_ETS_TLV_NOT_FOUND</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* Clean up old settings of ets on COS */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">dcbx_port_params</span><span class="p">.</span><span class="n">ets</span><span class="p">.</span><span class="n">cos_params</span><span class="p">)</span> <span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cos_params</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">pauseable</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">cos_params</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">strict</span> <span class="o">=</span> <span class="n">BNX2X_DCBX_STRICT_INVALID</span><span class="p">;</span>
		<span class="n">cos_params</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">bw_tbl</span> <span class="o">=</span> <span class="n">DCBX_INVALID_COS_BW</span><span class="p">;</span>
		<span class="n">cos_params</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">pri_bitmask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">dcbx_port_params</span><span class="p">.</span><span class="n">app</span><span class="p">.</span><span class="n">enabled</span> <span class="o">&amp;&amp;</span> <span class="n">ets</span><span class="o">-&gt;</span><span class="n">enabled</span> <span class="o">&amp;&amp;</span>
	   <span class="o">!</span><span class="n">GET_FLAGS</span><span class="p">(</span><span class="n">error</span><span class="p">,</span>
		      <span class="n">DCBX_LOCAL_ETS_ERROR</span> <span class="o">|</span> <span class="n">DCBX_REMOTE_ETS_TLV_NOT_FOUND</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DP</span><span class="p">(</span><span class="n">BNX2X_MSG_DCB</span><span class="p">,</span> <span class="s">&quot;DCBX_LOCAL_ETS_ENABLE</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">bp</span><span class="o">-&gt;</span><span class="n">dcbx_port_params</span><span class="p">.</span><span class="n">ets</span><span class="p">.</span><span class="n">enabled</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

		<span class="n">bnx2x_dcbx_get_ets_pri_pg_tbl</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span>
					      <span class="n">pg_pri_orginal_spread</span><span class="p">,</span>
					      <span class="n">ets</span><span class="o">-&gt;</span><span class="n">pri_pg_tbl</span><span class="p">);</span>

		<span class="n">bnx2x_dcbx_get_num_pg_traf_type</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span>
						<span class="n">pg_pri_orginal_spread</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">pg_help_data</span><span class="p">);</span>

		<span class="n">bnx2x_dcbx_fill_cos_params</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pg_help_data</span><span class="p">,</span>
					   <span class="n">ets</span><span class="p">,</span> <span class="n">pg_pri_orginal_spread</span><span class="p">);</span>

	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">DP</span><span class="p">(</span><span class="n">BNX2X_MSG_DCB</span><span class="p">,</span> <span class="s">&quot;DCBX_LOCAL_ETS_DISABLED</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">bp</span><span class="o">-&gt;</span><span class="n">dcbx_port_params</span><span class="p">.</span><span class="n">ets</span><span class="p">.</span><span class="n">enabled</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">ets</span><span class="o">-&gt;</span><span class="n">pri_pg_tbl</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">DCBX_MAX_NUM_PRI_PG_ENTRIES</span> <span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">DCBX_PG_BW_SET</span><span class="p">(</span><span class="n">ets</span><span class="o">-&gt;</span><span class="n">pg_bw_tbl</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>  <span class="nf">bnx2x_dcbx_get_pfc_feature</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">dcbx_pfc_feature</span> <span class="o">*</span><span class="n">pfc</span><span class="p">,</span> <span class="n">u32</span> <span class="n">error</span><span class="p">)</span>
<span class="p">{</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">GET_FLAGS</span><span class="p">(</span><span class="n">error</span><span class="p">,</span> <span class="n">DCBX_LOCAL_PFC_ERROR</span><span class="p">))</span>
		<span class="n">DP</span><span class="p">(</span><span class="n">BNX2X_MSG_DCB</span><span class="p">,</span> <span class="s">&quot;DCBX_LOCAL_PFC_ERROR</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">GET_FLAGS</span><span class="p">(</span><span class="n">error</span><span class="p">,</span> <span class="n">DCBX_REMOTE_PFC_TLV_NOT_FOUND</span><span class="p">))</span>
		<span class="n">DP</span><span class="p">(</span><span class="n">BNX2X_MSG_DCB</span><span class="p">,</span> <span class="s">&quot;DCBX_REMOTE_PFC_TLV_NOT_FOUND</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">dcbx_port_params</span><span class="p">.</span><span class="n">app</span><span class="p">.</span><span class="n">enabled</span> <span class="o">&amp;&amp;</span> <span class="n">pfc</span><span class="o">-&gt;</span><span class="n">enabled</span> <span class="o">&amp;&amp;</span>
	   <span class="o">!</span><span class="n">GET_FLAGS</span><span class="p">(</span><span class="n">error</span><span class="p">,</span> <span class="n">DCBX_LOCAL_PFC_ERROR</span> <span class="o">|</span> <span class="n">DCBX_LOCAL_PFC_MISMATCH</span> <span class="o">|</span>
			     <span class="n">DCBX_REMOTE_PFC_TLV_NOT_FOUND</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">bp</span><span class="o">-&gt;</span><span class="n">dcbx_port_params</span><span class="p">.</span><span class="n">pfc</span><span class="p">.</span><span class="n">enabled</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">bp</span><span class="o">-&gt;</span><span class="n">dcbx_port_params</span><span class="p">.</span><span class="n">pfc</span><span class="p">.</span><span class="n">priority_non_pauseable_mask</span> <span class="o">=</span>
			<span class="o">~</span><span class="p">(</span><span class="n">pfc</span><span class="o">-&gt;</span><span class="n">pri_en_bitmap</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">DP</span><span class="p">(</span><span class="n">BNX2X_MSG_DCB</span><span class="p">,</span> <span class="s">&quot;DCBX_LOCAL_PFC_DISABLED</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">bp</span><span class="o">-&gt;</span><span class="n">dcbx_port_params</span><span class="p">.</span><span class="n">pfc</span><span class="p">.</span><span class="n">enabled</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">bp</span><span class="o">-&gt;</span><span class="n">dcbx_port_params</span><span class="p">.</span><span class="n">pfc</span><span class="p">.</span><span class="n">priority_non_pauseable_mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* maps unmapped priorities to to the same COS as L2 */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_dcbx_map_nw</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">unmapped</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">MAX_PFC_PRIORITIES</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* all ones */</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">ttp</span> <span class="o">=</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">dcbx_port_params</span><span class="p">.</span><span class="n">app</span><span class="p">.</span><span class="n">traffic_type_priority</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">nw_prio</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">ttp</span><span class="p">[</span><span class="n">LLFC_TRAFFIC_TYPE_NW</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">bnx2x_dcbx_cos_params</span> <span class="o">*</span><span class="n">cos_params</span> <span class="o">=</span>
			<span class="n">bp</span><span class="o">-&gt;</span><span class="n">dcbx_port_params</span><span class="p">.</span><span class="n">ets</span><span class="p">.</span><span class="n">cos_params</span><span class="p">;</span>

	<span class="cm">/* get unmapped priorities by clearing mapped bits */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">LLFC_DRIVER_TRAFFIC_TYPE_MAX</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">unmapped</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">ttp</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

	<span class="cm">/* find cos for nw prio and extend it with unmapped */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">dcbx_port_params</span><span class="p">.</span><span class="n">ets</span><span class="p">.</span><span class="n">cos_params</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cos_params</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">pri_bitmask</span> <span class="o">&amp;</span> <span class="n">nw_prio</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* extend the bitmask with unmapped */</span>
			<span class="n">DP</span><span class="p">(</span><span class="n">BNX2X_MSG_DCB</span><span class="p">,</span>
			   <span class="s">&quot;cos %d extended with 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">unmapped</span><span class="p">);</span>
			<span class="n">cos_params</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">pri_bitmask</span> <span class="o">|=</span> <span class="n">unmapped</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_get_dcbx_drv_param</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">dcbx_features</span> <span class="o">*</span><span class="n">features</span><span class="p">,</span>
				     <span class="n">u32</span> <span class="n">error</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bnx2x_dcbx_get_ap_feature</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">features</span><span class="o">-&gt;</span><span class="n">app</span><span class="p">,</span> <span class="n">error</span><span class="p">);</span>

	<span class="n">bnx2x_dcbx_get_pfc_feature</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">features</span><span class="o">-&gt;</span><span class="n">pfc</span><span class="p">,</span> <span class="n">error</span><span class="p">);</span>

	<span class="n">bnx2x_dcbx_get_ets_feature</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">features</span><span class="o">-&gt;</span><span class="n">ets</span><span class="p">,</span> <span class="n">error</span><span class="p">);</span>

	<span class="n">bnx2x_dcbx_map_nw</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#define DCBX_LOCAL_MIB_MAX_TRY_READ		(100)</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">bnx2x_dcbx_read_mib</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">,</span>
			       <span class="n">u32</span> <span class="o">*</span><span class="n">base_mib_addr</span><span class="p">,</span>
			       <span class="n">u32</span> <span class="n">offset</span><span class="p">,</span>
			       <span class="kt">int</span> <span class="n">read_mib_type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">max_try_read</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">mib_size</span><span class="p">,</span> <span class="n">prefix_seq_num</span><span class="p">,</span> <span class="n">suffix_seq_num</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lldp_remote_mib</span> <span class="o">*</span><span class="n">remote_mib</span> <span class="p">;</span>
	<span class="k">struct</span> <span class="n">lldp_local_mib</span>  <span class="o">*</span><span class="n">local_mib</span><span class="p">;</span>


	<span class="k">switch</span> <span class="p">(</span><span class="n">read_mib_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">DCBX_READ_LOCAL_MIB</span>:
		<span class="n">mib_size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">lldp_local_mib</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DCBX_READ_REMOTE_MIB</span>:
		<span class="n">mib_size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">lldp_remote_mib</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/*error*/</span>
	<span class="p">}</span>

	<span class="n">offset</span> <span class="o">+=</span> <span class="n">BP_PORT</span><span class="p">(</span><span class="n">bp</span><span class="p">)</span> <span class="o">*</span> <span class="n">mib_size</span><span class="p">;</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">bnx2x_read_data</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">base_mib_addr</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">mib_size</span><span class="p">);</span>

		<span class="n">max_try_read</span><span class="o">++</span><span class="p">;</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">read_mib_type</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">DCBX_READ_LOCAL_MIB</span>:
			<span class="n">local_mib</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">lldp_local_mib</span> <span class="o">*</span><span class="p">)</span> <span class="n">base_mib_addr</span><span class="p">;</span>
			<span class="n">prefix_seq_num</span> <span class="o">=</span> <span class="n">local_mib</span><span class="o">-&gt;</span><span class="n">prefix_seq_num</span><span class="p">;</span>
			<span class="n">suffix_seq_num</span> <span class="o">=</span> <span class="n">local_mib</span><span class="o">-&gt;</span><span class="n">suffix_seq_num</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">DCBX_READ_REMOTE_MIB</span>:
			<span class="n">remote_mib</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">lldp_remote_mib</span> <span class="o">*</span><span class="p">)</span> <span class="n">base_mib_addr</span><span class="p">;</span>
			<span class="n">prefix_seq_num</span> <span class="o">=</span> <span class="n">remote_mib</span><span class="o">-&gt;</span><span class="n">prefix_seq_num</span><span class="p">;</span>
			<span class="n">suffix_seq_num</span> <span class="o">=</span> <span class="n">remote_mib</span><span class="o">-&gt;</span><span class="n">suffix_seq_num</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/*error*/</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">((</span><span class="n">prefix_seq_num</span> <span class="o">!=</span> <span class="n">suffix_seq_num</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	       <span class="p">(</span><span class="n">max_try_read</span> <span class="o">&lt;</span> <span class="n">DCBX_LOCAL_MIB_MAX_TRY_READ</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">max_try_read</span> <span class="o">&gt;=</span> <span class="n">DCBX_LOCAL_MIB_MAX_TRY_READ</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BNX2X_ERR</span><span class="p">(</span><span class="s">&quot;MIB could not be read</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_pfc_set_pfc</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">dcbx_port_params</span><span class="p">.</span><span class="n">pfc</span><span class="p">.</span><span class="n">enabled</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">dcbx_error</span> <span class="o">&amp;</span> <span class="n">DCBX_REMOTE_MIB_ERROR</span><span class="p">))</span>
		<span class="cm">/*</span>
<span class="cm">		 * 1. Fills up common PFC structures if required</span>
<span class="cm">		 * 2. Configure NIG, MAC and BRB via the elink</span>
<span class="cm">		 */</span>
		<span class="n">bnx2x_pfc_set</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">bnx2x_pfc_clear</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bnx2x_dcbx_stop_hw_tx</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2x_func_state_params</span> <span class="n">func_params</span> <span class="o">=</span> <span class="p">{</span><span class="nb">NULL</span><span class="p">};</span>

	<span class="n">func_params</span><span class="p">.</span><span class="n">f_obj</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">func_obj</span><span class="p">;</span>
	<span class="n">func_params</span><span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">BNX2X_F_CMD_TX_STOP</span><span class="p">;</span>

	<span class="n">DP</span><span class="p">(</span><span class="n">BNX2X_MSG_DCB</span><span class="p">,</span> <span class="s">&quot;STOP TRAFFIC</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">bnx2x_func_state_change</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">func_params</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bnx2x_dcbx_resume_hw_tx</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2x_func_state_params</span> <span class="n">func_params</span> <span class="o">=</span> <span class="p">{</span><span class="nb">NULL</span><span class="p">};</span>
	<span class="k">struct</span> <span class="n">bnx2x_func_tx_start_params</span> <span class="o">*</span><span class="n">tx_params</span> <span class="o">=</span>
		<span class="o">&amp;</span><span class="n">func_params</span><span class="p">.</span><span class="n">params</span><span class="p">.</span><span class="n">tx_start</span><span class="p">;</span>

	<span class="n">func_params</span><span class="p">.</span><span class="n">f_obj</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">func_obj</span><span class="p">;</span>
	<span class="n">func_params</span><span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">BNX2X_F_CMD_TX_START</span><span class="p">;</span>

	<span class="n">bnx2x_dcbx_fw_struct</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">tx_params</span><span class="p">);</span>

	<span class="n">DP</span><span class="p">(</span><span class="n">BNX2X_MSG_DCB</span><span class="p">,</span> <span class="s">&quot;START TRAFFIC</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">bnx2x_func_state_change</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">func_params</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_dcbx_2cos_limit_update_ets_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2x_dcbx_pg_params</span> <span class="o">*</span><span class="n">ets</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">dcbx_port_params</span><span class="p">.</span><span class="n">ets</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ets</span><span class="o">-&gt;</span><span class="n">num_of_cos</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">ets</span><span class="o">-&gt;</span><span class="n">num_of_cos</span> <span class="o">&gt;</span> <span class="n">DCBX_COS_MAX_NUM_E2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BNX2X_ERR</span><span class="p">(</span><span class="s">&quot;Illegal number of COSes %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ets</span><span class="o">-&gt;</span><span class="n">num_of_cos</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* valid COS entries */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ets</span><span class="o">-&gt;</span><span class="n">num_of_cos</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>   <span class="cm">/* no ETS */</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* sanity */</span>
	<span class="k">if</span> <span class="p">(((</span><span class="n">BNX2X_DCBX_STRICT_INVALID</span> <span class="o">==</span> <span class="n">ets</span><span class="o">-&gt;</span><span class="n">cos_params</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">strict</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	     <span class="p">(</span><span class="n">DCBX_INVALID_COS_BW</span> <span class="o">==</span> <span class="n">ets</span><span class="o">-&gt;</span><span class="n">cos_params</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">bw_tbl</span><span class="p">))</span> <span class="o">||</span>
	    <span class="p">((</span><span class="n">BNX2X_DCBX_STRICT_INVALID</span> <span class="o">==</span> <span class="n">ets</span><span class="o">-&gt;</span><span class="n">cos_params</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">strict</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	     <span class="p">(</span><span class="n">DCBX_INVALID_COS_BW</span> <span class="o">==</span> <span class="n">ets</span><span class="o">-&gt;</span><span class="n">cos_params</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">bw_tbl</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">BNX2X_ERR</span><span class="p">(</span><span class="s">&quot;all COS should have at least bw_limit or strict&quot;</span>
			    <span class="s">&quot;ets-&gt;cos_params[0].strict= %x&quot;</span>
			    <span class="s">&quot;ets-&gt;cos_params[0].bw_tbl= %x&quot;</span>
			    <span class="s">&quot;ets-&gt;cos_params[1].strict= %x&quot;</span>
			    <span class="s">&quot;ets-&gt;cos_params[1].bw_tbl= %x&quot;</span><span class="p">,</span>
			  <span class="n">ets</span><span class="o">-&gt;</span><span class="n">cos_params</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">strict</span><span class="p">,</span>
			  <span class="n">ets</span><span class="o">-&gt;</span><span class="n">cos_params</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">bw_tbl</span><span class="p">,</span>
			  <span class="n">ets</span><span class="o">-&gt;</span><span class="n">cos_params</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">strict</span><span class="p">,</span>
			  <span class="n">ets</span><span class="o">-&gt;</span><span class="n">cos_params</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">bw_tbl</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* If we join a group and there is bw_tbl and strict then bw rules */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">DCBX_INVALID_COS_BW</span> <span class="o">!=</span> <span class="n">ets</span><span class="o">-&gt;</span><span class="n">cos_params</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">bw_tbl</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">DCBX_INVALID_COS_BW</span> <span class="o">!=</span> <span class="n">ets</span><span class="o">-&gt;</span><span class="n">cos_params</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">bw_tbl</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">bw_tbl_0</span> <span class="o">=</span> <span class="n">ets</span><span class="o">-&gt;</span><span class="n">cos_params</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">bw_tbl</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">bw_tbl_1</span> <span class="o">=</span> <span class="n">ets</span><span class="o">-&gt;</span><span class="n">cos_params</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">bw_tbl</span><span class="p">;</span>
		<span class="cm">/* Do not allow 0-100 configuration</span>
<span class="cm">		 * since PBF does not support it</span>
<span class="cm">		 * force 1-99 instead</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bw_tbl_0</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">bw_tbl_0</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">bw_tbl_1</span> <span class="o">=</span> <span class="mi">99</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">bw_tbl_1</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">bw_tbl_1</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">bw_tbl_0</span> <span class="o">=</span> <span class="mi">99</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">bnx2x_ets_bw_limit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">link_params</span><span class="p">,</span> <span class="n">bw_tbl_0</span><span class="p">,</span> <span class="n">bw_tbl_1</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ets</span><span class="o">-&gt;</span><span class="n">cos_params</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">strict</span> <span class="o">==</span> <span class="n">BNX2X_DCBX_STRICT_COS_HIGHEST</span><span class="p">)</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">bnx2x_ets_strict</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">link_params</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ets</span><span class="o">-&gt;</span><span class="n">cos_params</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">strict</span>
					<span class="o">==</span> <span class="n">BNX2X_DCBX_STRICT_COS_HIGHEST</span><span class="p">)</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">bnx2x_ets_strict</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">link_params</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
			<span class="n">BNX2X_ERR</span><span class="p">(</span><span class="s">&quot;update_ets_params failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * In E3B0 the configuration may have more than 2 COS.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_dcbx_update_ets_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2x_dcbx_pg_params</span> <span class="o">*</span><span class="n">ets</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">dcbx_port_params</span><span class="p">.</span><span class="n">ets</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">bnx2x_ets_params</span> <span class="n">ets_params</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span> <span class="p">};</span>
	<span class="n">u8</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">ets_params</span><span class="p">.</span><span class="n">num_of_cos</span> <span class="o">=</span> <span class="n">ets</span><span class="o">-&gt;</span><span class="n">num_of_cos</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ets</span><span class="o">-&gt;</span><span class="n">num_of_cos</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* COS is SP */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ets</span><span class="o">-&gt;</span><span class="n">cos_params</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">strict</span> <span class="o">!=</span> <span class="n">BNX2X_DCBX_STRICT_INVALID</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ets</span><span class="o">-&gt;</span><span class="n">cos_params</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">bw_tbl</span> <span class="o">!=</span> <span class="n">DCBX_INVALID_COS_BW</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">BNX2X_ERR</span><span class="p">(</span><span class="s">&quot;COS can&#39;t be not BW and not SP</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">return</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">ets_params</span><span class="p">.</span><span class="n">cos</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">state</span> <span class="o">=</span> <span class="n">bnx2x_cos_state_strict</span><span class="p">;</span>
			<span class="n">ets_params</span><span class="p">.</span><span class="n">cos</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">params</span><span class="p">.</span><span class="n">sp_params</span><span class="p">.</span><span class="n">pri</span> <span class="o">=</span>
						<span class="n">ets</span><span class="o">-&gt;</span><span class="n">cos_params</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">strict</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="cm">/* COS is BW */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ets</span><span class="o">-&gt;</span><span class="n">cos_params</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">bw_tbl</span> <span class="o">==</span> <span class="n">DCBX_INVALID_COS_BW</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">BNX2X_ERR</span><span class="p">(</span><span class="s">&quot;COS can&#39;t be not BW and not SP</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">return</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">ets_params</span><span class="p">.</span><span class="n">cos</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">state</span> <span class="o">=</span> <span class="n">bnx2x_cos_state_bw</span><span class="p">;</span>
			<span class="n">ets_params</span><span class="p">.</span><span class="n">cos</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">params</span><span class="p">.</span><span class="n">bw_params</span><span class="p">.</span><span class="n">bw</span> <span class="o">=</span>
						<span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">ets</span><span class="o">-&gt;</span><span class="n">cos_params</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">bw_tbl</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Configure the ETS in HW */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bnx2x_ets_e3b0_config</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">link_params</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">link_vars</span><span class="p">,</span>
				  <span class="o">&amp;</span><span class="n">ets_params</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">BNX2X_ERR</span><span class="p">(</span><span class="s">&quot;bnx2x_ets_e3b0_config failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">bnx2x_ets_disabled</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">link_params</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">link_vars</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_dcbx_update_ets_params</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bnx2x_ets_disabled</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">link_params</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">link_vars</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">dcbx_port_params</span><span class="p">.</span><span class="n">ets</span><span class="p">.</span><span class="n">enabled</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">dcbx_error</span> <span class="o">&amp;</span> <span class="n">DCBX_REMOTE_MIB_ERROR</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">CHIP_IS_E3B0</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span>
		<span class="n">bnx2x_dcbx_update_ets_config</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">bnx2x_dcbx_2cos_limit_update_ets_config</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef BCM_DCBNL</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">bnx2x_dcbx_read_shmem_remote_mib</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lldp_remote_mib</span> <span class="n">remote_mib</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
	<span class="n">u32</span> <span class="n">dcbx_remote_mib_offset</span> <span class="o">=</span> <span class="n">SHMEM2_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">dcbx_remote_mib_offset</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">DP</span><span class="p">(</span><span class="n">BNX2X_MSG_DCB</span><span class="p">,</span> <span class="s">&quot;dcbx_remote_mib_offset 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	   <span class="n">dcbx_remote_mib_offset</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">SHMEM_DCBX_REMOTE_MIB_NONE</span> <span class="o">==</span> <span class="n">dcbx_remote_mib_offset</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BNX2X_ERR</span><span class="p">(</span><span class="s">&quot;FW doesn&#39;t support dcbx_remote_mib_offset</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">bnx2x_dcbx_read_mib</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">remote_mib</span><span class="p">,</span> <span class="n">dcbx_remote_mib_offset</span><span class="p">,</span>
				 <span class="n">DCBX_READ_REMOTE_MIB</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BNX2X_ERR</span><span class="p">(</span><span class="s">&quot;Faild to read remote mib from FW</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* save features and flags */</span>
	<span class="n">bp</span><span class="o">-&gt;</span><span class="n">dcbx_remote_feat</span> <span class="o">=</span> <span class="n">remote_mib</span><span class="p">.</span><span class="n">features</span><span class="p">;</span>
	<span class="n">bp</span><span class="o">-&gt;</span><span class="n">dcbx_remote_flags</span> <span class="o">=</span> <span class="n">remote_mib</span><span class="p">.</span><span class="n">flags</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bnx2x_dcbx_read_shmem_neg_results</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lldp_local_mib</span> <span class="n">local_mib</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
	<span class="n">u32</span> <span class="n">dcbx_neg_res_offset</span> <span class="o">=</span> <span class="n">SHMEM2_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">dcbx_neg_res_offset</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">DP</span><span class="p">(</span><span class="n">BNX2X_MSG_DCB</span><span class="p">,</span> <span class="s">&quot;dcbx_neg_res_offset 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dcbx_neg_res_offset</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">SHMEM_DCBX_NEG_RES_NONE</span> <span class="o">==</span> <span class="n">dcbx_neg_res_offset</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BNX2X_ERR</span><span class="p">(</span><span class="s">&quot;FW doesn&#39;t support dcbx_neg_res_offset</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">bnx2x_dcbx_read_mib</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">local_mib</span><span class="p">,</span> <span class="n">dcbx_neg_res_offset</span><span class="p">,</span>
				 <span class="n">DCBX_READ_LOCAL_MIB</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BNX2X_ERR</span><span class="p">(</span><span class="s">&quot;Faild to read local mib from FW</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* save features and error */</span>
	<span class="n">bp</span><span class="o">-&gt;</span><span class="n">dcbx_local_feat</span> <span class="o">=</span> <span class="n">local_mib</span><span class="p">.</span><span class="n">features</span><span class="p">;</span>
	<span class="n">bp</span><span class="o">-&gt;</span><span class="n">dcbx_error</span> <span class="o">=</span> <span class="n">local_mib</span><span class="p">.</span><span class="n">error</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cp">#ifdef BCM_DCBNL</span>
<span class="k">static</span> <span class="kr">inline</span>
<span class="n">u8</span> <span class="nf">bnx2x_dcbx_dcbnl_app_up</span><span class="p">(</span><span class="k">struct</span> <span class="n">dcbx_app_priority_entry</span> <span class="o">*</span><span class="n">ent</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">pri</span><span class="p">;</span>

	<span class="cm">/* Choose the highest priority */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">pri</span> <span class="o">=</span> <span class="n">MAX_PFC_PRIORITIES</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="n">pri</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="n">pri</span><span class="o">--</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ent</span><span class="o">-&gt;</span><span class="n">pri_bitmap</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">pri</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">pri</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span>
<span class="n">u8</span> <span class="nf">bnx2x_dcbx_dcbnl_app_idtype</span><span class="p">(</span><span class="k">struct</span> <span class="n">dcbx_app_priority_entry</span> <span class="o">*</span><span class="n">ent</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">((</span><span class="n">ent</span><span class="o">-&gt;</span><span class="n">appBitfield</span> <span class="o">&amp;</span> <span class="n">DCBX_APP_ENTRY_SF_MASK</span><span class="p">)</span> <span class="o">==</span>
		<span class="n">DCBX_APP_SF_PORT</span><span class="p">)</span> <span class="o">?</span> <span class="n">DCB_APP_IDTYPE_PORTNUM</span> <span class="o">:</span>
		<span class="n">DCB_APP_IDTYPE_ETHTYPE</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">bnx2x_dcbnl_update_applist</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">,</span> <span class="n">bool</span> <span class="n">delall</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">DCBX_MAX_APP_PROTOCOL</span> <span class="o">&amp;&amp;</span> <span class="n">err</span> <span class="o">==</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">dcbx_app_priority_entry</span> <span class="o">*</span><span class="n">ent</span> <span class="o">=</span>
			<span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">dcbx_local_feat</span><span class="p">.</span><span class="n">app</span><span class="p">.</span><span class="n">app_pri_tbl</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ent</span><span class="o">-&gt;</span><span class="n">appBitfield</span> <span class="o">&amp;</span> <span class="n">DCBX_APP_ENTRY_VALID</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u8</span> <span class="n">up</span> <span class="o">=</span> <span class="n">bnx2x_dcbx_dcbnl_app_up</span><span class="p">(</span><span class="n">ent</span><span class="p">);</span>

			<span class="cm">/* avoid invalid user-priority */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">up</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">struct</span> <span class="n">dcb_app</span> <span class="n">app</span><span class="p">;</span>
				<span class="n">app</span><span class="p">.</span><span class="n">selector</span> <span class="o">=</span> <span class="n">bnx2x_dcbx_dcbnl_app_idtype</span><span class="p">(</span><span class="n">ent</span><span class="p">);</span>
				<span class="n">app</span><span class="p">.</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">ent</span><span class="o">-&gt;</span><span class="n">app_id</span><span class="p">;</span>
				<span class="n">app</span><span class="p">.</span><span class="n">priority</span> <span class="o">=</span> <span class="n">delall</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">up</span><span class="p">;</span>
				<span class="n">err</span> <span class="o">=</span> <span class="n">dcb_setapp</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">app</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">bnx2x_dcbx_update_tc_mapping</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">prio</span><span class="p">,</span> <span class="n">cos</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">cos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">cos</span> <span class="o">&lt;</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">dcbx_port_params</span><span class="p">.</span><span class="n">ets</span><span class="p">.</span><span class="n">num_of_cos</span><span class="p">;</span> <span class="n">cos</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">prio</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">prio</span> <span class="o">&lt;</span> <span class="n">BNX2X_MAX_PRIORITY</span><span class="p">;</span> <span class="n">prio</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">dcbx_port_params</span><span class="p">.</span><span class="n">ets</span><span class="p">.</span><span class="n">cos_params</span><span class="p">[</span><span class="n">cos</span><span class="p">].</span><span class="n">pri_bitmask</span>
			    <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">prio</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">bp</span><span class="o">-&gt;</span><span class="n">prio_to_cos</span><span class="p">[</span><span class="n">prio</span><span class="p">]</span> <span class="o">=</span> <span class="n">cos</span><span class="p">;</span>
				<span class="n">DP</span><span class="p">(</span><span class="n">BNX2X_MSG_DCB</span><span class="p">,</span>
				   <span class="s">&quot;tx_mapping %d --&gt; %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">prio</span><span class="p">,</span> <span class="n">cos</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* setup tc must be called under rtnl lock, but we can&#39;t take it here</span>
<span class="cm">	 * as we are handling an attetntion on a work queue which must be</span>
<span class="cm">	 * flushed at some rtnl-locked contexts (e.g. if down)</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">BNX2X_SP_RTNL_SETUP_TC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">sp_rtnl_state</span><span class="p">))</span>
		<span class="n">schedule_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">sp_rtnl_task</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">bnx2x_dcbx_set_params</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">,</span> <span class="n">u32</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">BNX2X_DCBX_STATE_NEG_RECEIVED</span>:
		<span class="p">{</span>
			<span class="n">DP</span><span class="p">(</span><span class="n">BNX2X_MSG_DCB</span><span class="p">,</span> <span class="s">&quot;BNX2X_DCBX_STATE_NEG_RECEIVED</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#ifdef BCM_DCBNL</span>
			<span class="cm">/**</span>
<span class="cm">			 * Delete app tlvs from dcbnl before reading new</span>
<span class="cm">			 * negotiation results</span>
<span class="cm">			 */</span>
			<span class="n">bnx2x_dcbnl_update_applist</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>

			<span class="cm">/* Read rmeote mib if dcbx is in the FW */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">bnx2x_dcbx_read_shmem_remote_mib</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span>
				<span class="k">return</span><span class="p">;</span>
<span class="cp">#endif</span>
			<span class="cm">/* Read neg results if dcbx is in the FW */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">bnx2x_dcbx_read_shmem_neg_results</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span>
				<span class="k">return</span><span class="p">;</span>

			<span class="n">bnx2x_dump_dcbx_drv_param</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">dcbx_local_feat</span><span class="p">,</span>
						  <span class="n">bp</span><span class="o">-&gt;</span><span class="n">dcbx_error</span><span class="p">);</span>

			<span class="n">bnx2x_get_dcbx_drv_param</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">dcbx_local_feat</span><span class="p">,</span>
						 <span class="n">bp</span><span class="o">-&gt;</span><span class="n">dcbx_error</span><span class="p">);</span>

			<span class="cm">/* mark DCBX result for PMF migration */</span>
			<span class="n">bnx2x_update_drv_flags</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span>
					       <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">DRV_FLAGS_DCB_CONFIGURED</span><span class="p">,</span>
					       <span class="mi">1</span><span class="p">);</span>
<span class="cp">#ifdef BCM_DCBNL</span>
			<span class="cm">/*</span>
<span class="cm">			 * Add new app tlvs to dcbnl</span>
<span class="cm">			 */</span>
			<span class="n">bnx2x_dcbnl_update_applist</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
<span class="cp">#endif</span>
			<span class="cm">/*</span>
<span class="cm">			 * reconfigure the netdevice with the results of the new</span>
<span class="cm">			 * dcbx negotiation.</span>
<span class="cm">			 */</span>
			<span class="n">bnx2x_dcbx_update_tc_mapping</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>

			<span class="cm">/*</span>
<span class="cm">			 * allow other funtions to update their netdevices</span>
<span class="cm">			 * accordingly</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">IS_MF</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span>
				<span class="n">bnx2x_link_sync_notify</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>

			<span class="n">bnx2x_dcbx_stop_hw_tx</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>

			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="k">case</span> <span class="n">BNX2X_DCBX_STATE_TX_PAUSED</span>:
		<span class="n">DP</span><span class="p">(</span><span class="n">BNX2X_MSG_DCB</span><span class="p">,</span> <span class="s">&quot;BNX2X_DCBX_STATE_TX_PAUSED</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">bnx2x_pfc_set_pfc</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>

		<span class="n">bnx2x_dcbx_update_ets_params</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
		<span class="n">bnx2x_dcbx_resume_hw_tx</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>

		<span class="k">return</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">BNX2X_DCBX_STATE_TX_RELEASED</span>:
		<span class="n">DP</span><span class="p">(</span><span class="n">BNX2X_MSG_DCB</span><span class="p">,</span> <span class="s">&quot;BNX2X_DCBX_STATE_TX_RELEASED</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">bnx2x_fw_command</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">DRV_MSG_CODE_DCBX_PMF_DRV_OK</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="cp">#ifdef BCM_DCBNL</span>
		<span class="cm">/*</span>
<span class="cm">		 * Send a notification for the new negotiated parameters</span>
<span class="cm">		 */</span>
		<span class="n">dcbnl_cee_notify</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">RTM_GETDCB</span><span class="p">,</span> <span class="n">DCB_CMD_CEE_GET</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">BNX2X_ERR</span><span class="p">(</span><span class="s">&quot;Unknown DCBX_STATE</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cp">#define LLDP_ADMIN_MIB_OFFSET(bp)	(PORT_MAX*sizeof(struct lldp_params) + \</span>
<span class="cp">				      BP_PORT(bp)*sizeof(struct lldp_admin_mib))</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_dcbx_admin_mib_updated_params</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">,</span>
				<span class="n">u32</span> <span class="n">dcbx_lldp_params_offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lldp_admin_mib</span> <span class="n">admin_mib</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">i</span><span class="p">,</span> <span class="n">other_traf_type</span> <span class="o">=</span> <span class="n">PREDEFINED_APP_IDX_MAX</span><span class="p">,</span> <span class="n">traf_type</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">offset</span> <span class="o">=</span> <span class="n">dcbx_lldp_params_offset</span> <span class="o">+</span> <span class="n">LLDP_ADMIN_MIB_OFFSET</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>

	<span class="cm">/*shortcuts*/</span>
	<span class="k">struct</span> <span class="n">dcbx_features</span> <span class="o">*</span><span class="n">af</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">admin_mib</span><span class="p">.</span><span class="n">features</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bnx2x_config_dcbx_params</span> <span class="o">*</span><span class="n">dp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">dcbx_config_params</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">admin_mib</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">lldp_admin_mib</span><span class="p">));</span>

	<span class="cm">/* Read the data first */</span>
	<span class="n">bnx2x_read_data</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">admin_mib</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">lldp_admin_mib</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">dcbx_enabled</span> <span class="o">==</span> <span class="n">BNX2X_DCBX_ENABLED_ON_NEG_ON</span><span class="p">)</span>
		<span class="n">SET_FLAGS</span><span class="p">(</span><span class="n">admin_mib</span><span class="p">.</span><span class="n">ver_cfg_flags</span><span class="p">,</span> <span class="n">DCBX_DCBX_ENABLED</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">RESET_FLAGS</span><span class="p">(</span><span class="n">admin_mib</span><span class="p">.</span><span class="n">ver_cfg_flags</span><span class="p">,</span> <span class="n">DCBX_DCBX_ENABLED</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dp</span><span class="o">-&gt;</span><span class="n">overwrite_settings</span> <span class="o">==</span> <span class="n">BNX2X_DCBX_OVERWRITE_SETTINGS_ENABLE</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">RESET_FLAGS</span><span class="p">(</span><span class="n">admin_mib</span><span class="p">.</span><span class="n">ver_cfg_flags</span><span class="p">,</span> <span class="n">DCBX_CEE_VERSION_MASK</span><span class="p">);</span>
		<span class="n">admin_mib</span><span class="p">.</span><span class="n">ver_cfg_flags</span> <span class="o">|=</span>
			<span class="p">(</span><span class="n">dp</span><span class="o">-&gt;</span><span class="n">admin_dcbx_version</span> <span class="o">&lt;&lt;</span> <span class="n">DCBX_CEE_VERSION_SHIFT</span><span class="p">)</span> <span class="o">&amp;</span>
			 <span class="n">DCBX_CEE_VERSION_MASK</span><span class="p">;</span>

		<span class="n">af</span><span class="o">-&gt;</span><span class="n">ets</span><span class="p">.</span><span class="n">enabled</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">dp</span><span class="o">-&gt;</span><span class="n">admin_ets_enable</span><span class="p">;</span>

		<span class="n">af</span><span class="o">-&gt;</span><span class="n">pfc</span><span class="p">.</span><span class="n">enabled</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">dp</span><span class="o">-&gt;</span><span class="n">admin_pfc_enable</span><span class="p">;</span>

		<span class="cm">/* FOR IEEE dp-&gt;admin_tc_supported_tx_enable */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dp</span><span class="o">-&gt;</span><span class="n">admin_ets_configuration_tx_enable</span><span class="p">)</span>
			<span class="n">SET_FLAGS</span><span class="p">(</span><span class="n">admin_mib</span><span class="p">.</span><span class="n">ver_cfg_flags</span><span class="p">,</span>
				  <span class="n">DCBX_ETS_CONFIG_TX_ENABLED</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">RESET_FLAGS</span><span class="p">(</span><span class="n">admin_mib</span><span class="p">.</span><span class="n">ver_cfg_flags</span><span class="p">,</span>
				    <span class="n">DCBX_ETS_CONFIG_TX_ENABLED</span><span class="p">);</span>
		<span class="cm">/* For IEEE admin_ets_recommendation_tx_enable */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dp</span><span class="o">-&gt;</span><span class="n">admin_pfc_tx_enable</span><span class="p">)</span>
			<span class="n">SET_FLAGS</span><span class="p">(</span><span class="n">admin_mib</span><span class="p">.</span><span class="n">ver_cfg_flags</span><span class="p">,</span>
				  <span class="n">DCBX_PFC_CONFIG_TX_ENABLED</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">RESET_FLAGS</span><span class="p">(</span><span class="n">admin_mib</span><span class="p">.</span><span class="n">ver_cfg_flags</span><span class="p">,</span>
				  <span class="n">DCBX_PFC_CONFIG_TX_ENABLED</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">dp</span><span class="o">-&gt;</span><span class="n">admin_application_priority_tx_enable</span><span class="p">)</span>
			<span class="n">SET_FLAGS</span><span class="p">(</span><span class="n">admin_mib</span><span class="p">.</span><span class="n">ver_cfg_flags</span><span class="p">,</span>
				  <span class="n">DCBX_APP_CONFIG_TX_ENABLED</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">RESET_FLAGS</span><span class="p">(</span><span class="n">admin_mib</span><span class="p">.</span><span class="n">ver_cfg_flags</span><span class="p">,</span>
				  <span class="n">DCBX_APP_CONFIG_TX_ENABLED</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">dp</span><span class="o">-&gt;</span><span class="n">admin_ets_willing</span><span class="p">)</span>
			<span class="n">SET_FLAGS</span><span class="p">(</span><span class="n">admin_mib</span><span class="p">.</span><span class="n">ver_cfg_flags</span><span class="p">,</span> <span class="n">DCBX_ETS_WILLING</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">RESET_FLAGS</span><span class="p">(</span><span class="n">admin_mib</span><span class="p">.</span><span class="n">ver_cfg_flags</span><span class="p">,</span> <span class="n">DCBX_ETS_WILLING</span><span class="p">);</span>
		<span class="cm">/* For IEEE admin_ets_reco_valid */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dp</span><span class="o">-&gt;</span><span class="n">admin_pfc_willing</span><span class="p">)</span>
			<span class="n">SET_FLAGS</span><span class="p">(</span><span class="n">admin_mib</span><span class="p">.</span><span class="n">ver_cfg_flags</span><span class="p">,</span> <span class="n">DCBX_PFC_WILLING</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">RESET_FLAGS</span><span class="p">(</span><span class="n">admin_mib</span><span class="p">.</span><span class="n">ver_cfg_flags</span><span class="p">,</span> <span class="n">DCBX_PFC_WILLING</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">dp</span><span class="o">-&gt;</span><span class="n">admin_app_priority_willing</span><span class="p">)</span>
			<span class="n">SET_FLAGS</span><span class="p">(</span><span class="n">admin_mib</span><span class="p">.</span><span class="n">ver_cfg_flags</span><span class="p">,</span> <span class="n">DCBX_APP_WILLING</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">RESET_FLAGS</span><span class="p">(</span><span class="n">admin_mib</span><span class="p">.</span><span class="n">ver_cfg_flags</span><span class="p">,</span> <span class="n">DCBX_APP_WILLING</span><span class="p">);</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">DCBX_MAX_NUM_PG_BW_ENTRIES</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DCBX_PG_BW_SET</span><span class="p">(</span><span class="n">af</span><span class="o">-&gt;</span><span class="n">ets</span><span class="p">.</span><span class="n">pg_bw_tbl</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span>
				<span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">dp</span><span class="o">-&gt;</span><span class="n">admin_configuration_bw_precentage</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

			<span class="n">DP</span><span class="p">(</span><span class="n">BNX2X_MSG_DCB</span><span class="p">,</span> <span class="s">&quot;pg_bw_tbl[%d] = %02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">i</span><span class="p">,</span> <span class="n">DCBX_PG_BW_GET</span><span class="p">(</span><span class="n">af</span><span class="o">-&gt;</span><span class="n">ets</span><span class="p">.</span><span class="n">pg_bw_tbl</span><span class="p">,</span> <span class="n">i</span><span class="p">));</span>
		<span class="p">}</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">DCBX_MAX_NUM_PRI_PG_ENTRIES</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DCBX_PRI_PG_SET</span><span class="p">(</span><span class="n">af</span><span class="o">-&gt;</span><span class="n">ets</span><span class="p">.</span><span class="n">pri_pg_tbl</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span>
					<span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">dp</span><span class="o">-&gt;</span><span class="n">admin_configuration_ets_pg</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

			<span class="n">DP</span><span class="p">(</span><span class="n">BNX2X_MSG_DCB</span><span class="p">,</span> <span class="s">&quot;pri_pg_tbl[%d] = %02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">i</span><span class="p">,</span> <span class="n">DCBX_PRI_PG_GET</span><span class="p">(</span><span class="n">af</span><span class="o">-&gt;</span><span class="n">ets</span><span class="p">.</span><span class="n">pri_pg_tbl</span><span class="p">,</span> <span class="n">i</span><span class="p">));</span>
		<span class="p">}</span>

		<span class="cm">/*For IEEE admin_recommendation_bw_precentage</span>
<span class="cm">		 *For IEEE admin_recommendation_ets_pg */</span>
		<span class="n">af</span><span class="o">-&gt;</span><span class="n">pfc</span><span class="p">.</span><span class="n">pri_en_bitmap</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">dp</span><span class="o">-&gt;</span><span class="n">admin_pfc_bitmap</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">DCBX_CONFIG_MAX_APP_PROTOCOL</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dp</span><span class="o">-&gt;</span><span class="n">admin_priority_app_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">valid</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">struct</span> <span class="n">bnx2x_admin_priority_app_table</span> <span class="o">*</span><span class="n">table</span> <span class="o">=</span>
					<span class="n">dp</span><span class="o">-&gt;</span><span class="n">admin_priority_app_table</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">ETH_TYPE_FCOE</span> <span class="o">==</span> <span class="n">table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">app_id</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
				   <span class="p">(</span><span class="n">TRAFFIC_TYPE_ETH</span> <span class="o">==</span> <span class="n">table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">traffic_type</span><span class="p">))</span>
					<span class="n">traf_type</span> <span class="o">=</span> <span class="n">FCOE_APP_IDX</span><span class="p">;</span>
				<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">TCP_PORT_ISCSI</span> <span class="o">==</span> <span class="n">table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">app_id</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
				   <span class="p">(</span><span class="n">TRAFFIC_TYPE_PORT</span> <span class="o">==</span> <span class="n">table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">traffic_type</span><span class="p">))</span>
					<span class="n">traf_type</span> <span class="o">=</span> <span class="n">ISCSI_APP_IDX</span><span class="p">;</span>
				<span class="k">else</span>
					<span class="n">traf_type</span> <span class="o">=</span> <span class="n">other_traf_type</span><span class="o">++</span><span class="p">;</span>

				<span class="n">af</span><span class="o">-&gt;</span><span class="n">app</span><span class="p">.</span><span class="n">app_pri_tbl</span><span class="p">[</span><span class="n">traf_type</span><span class="p">].</span><span class="n">app_id</span> <span class="o">=</span>
					<span class="n">table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">app_id</span><span class="p">;</span>

				<span class="n">af</span><span class="o">-&gt;</span><span class="n">app</span><span class="p">.</span><span class="n">app_pri_tbl</span><span class="p">[</span><span class="n">traf_type</span><span class="p">].</span><span class="n">pri_bitmap</span> <span class="o">=</span>
					<span class="p">(</span><span class="n">u8</span><span class="p">)(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">priority</span><span class="p">);</span>

				<span class="n">af</span><span class="o">-&gt;</span><span class="n">app</span><span class="p">.</span><span class="n">app_pri_tbl</span><span class="p">[</span><span class="n">traf_type</span><span class="p">].</span><span class="n">appBitfield</span> <span class="o">=</span>
				    <span class="p">(</span><span class="n">DCBX_APP_ENTRY_VALID</span><span class="p">);</span>

				<span class="n">af</span><span class="o">-&gt;</span><span class="n">app</span><span class="p">.</span><span class="n">app_pri_tbl</span><span class="p">[</span><span class="n">traf_type</span><span class="p">].</span><span class="n">appBitfield</span> <span class="o">|=</span>
				   <span class="p">(</span><span class="n">TRAFFIC_TYPE_ETH</span> <span class="o">==</span> <span class="n">table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">traffic_type</span><span class="p">)</span> <span class="o">?</span>
					<span class="n">DCBX_APP_SF_ETH_TYPE</span> <span class="o">:</span> <span class="n">DCBX_APP_SF_PORT</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="n">af</span><span class="o">-&gt;</span><span class="n">app</span><span class="p">.</span><span class="n">default_pri</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">dp</span><span class="o">-&gt;</span><span class="n">admin_default_priority</span><span class="p">;</span>

	<span class="p">}</span>

	<span class="cm">/* Write the data. */</span>
	<span class="n">bnx2x_write_data</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">admin_mib</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span>
			 <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">lldp_admin_mib</span><span class="p">));</span>

<span class="p">}</span>

<span class="kt">void</span> <span class="nf">bnx2x_dcbx_set_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">,</span> <span class="n">bool</span> <span class="n">dcb_on</span><span class="p">,</span> <span class="n">u32</span> <span class="n">dcbx_enabled</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CHIP_IS_E1x</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">bp</span><span class="o">-&gt;</span><span class="n">dcb_state</span> <span class="o">=</span> <span class="n">dcb_on</span><span class="p">;</span>
		<span class="n">bp</span><span class="o">-&gt;</span><span class="n">dcbx_enabled</span> <span class="o">=</span> <span class="n">dcbx_enabled</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">bp</span><span class="o">-&gt;</span><span class="n">dcb_state</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">bp</span><span class="o">-&gt;</span><span class="n">dcbx_enabled</span> <span class="o">=</span> <span class="n">BNX2X_DCBX_ENABLED_INVALID</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">DP</span><span class="p">(</span><span class="n">BNX2X_MSG_DCB</span><span class="p">,</span> <span class="s">&quot;DCB state [%s:%s]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	   <span class="n">dcb_on</span> <span class="o">?</span> <span class="s">&quot;ON&quot;</span> <span class="o">:</span> <span class="s">&quot;OFF&quot;</span><span class="p">,</span>
	   <span class="n">dcbx_enabled</span> <span class="o">==</span> <span class="n">BNX2X_DCBX_ENABLED_OFF</span> <span class="o">?</span> <span class="s">&quot;user-mode&quot;</span> <span class="o">:</span>
	   <span class="n">dcbx_enabled</span> <span class="o">==</span> <span class="n">BNX2X_DCBX_ENABLED_ON_NEG_OFF</span> <span class="o">?</span> <span class="s">&quot;on-chip static&quot;</span> <span class="o">:</span>
	   <span class="n">dcbx_enabled</span> <span class="o">==</span> <span class="n">BNX2X_DCBX_ENABLED_ON_NEG_ON</span> <span class="o">?</span>
	   <span class="s">&quot;on-chip with negotiation&quot;</span> <span class="o">:</span> <span class="s">&quot;invalid&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">bnx2x_dcbx_init_params</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bp</span><span class="o">-&gt;</span><span class="n">dcbx_config_params</span><span class="p">.</span><span class="n">admin_dcbx_version</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span> <span class="cm">/* 0 - CEE; 1 - IEEE */</span>
	<span class="n">bp</span><span class="o">-&gt;</span><span class="n">dcbx_config_params</span><span class="p">.</span><span class="n">admin_ets_willing</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">bp</span><span class="o">-&gt;</span><span class="n">dcbx_config_params</span><span class="p">.</span><span class="n">admin_pfc_willing</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">bp</span><span class="o">-&gt;</span><span class="n">dcbx_config_params</span><span class="p">.</span><span class="n">overwrite_settings</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">bp</span><span class="o">-&gt;</span><span class="n">dcbx_config_params</span><span class="p">.</span><span class="n">admin_ets_enable</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">bp</span><span class="o">-&gt;</span><span class="n">dcbx_config_params</span><span class="p">.</span><span class="n">admin_pfc_enable</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">bp</span><span class="o">-&gt;</span><span class="n">dcbx_config_params</span><span class="p">.</span><span class="n">admin_tc_supported_tx_enable</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">bp</span><span class="o">-&gt;</span><span class="n">dcbx_config_params</span><span class="p">.</span><span class="n">admin_ets_configuration_tx_enable</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">bp</span><span class="o">-&gt;</span><span class="n">dcbx_config_params</span><span class="p">.</span><span class="n">admin_pfc_tx_enable</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">bp</span><span class="o">-&gt;</span><span class="n">dcbx_config_params</span><span class="p">.</span><span class="n">admin_application_priority_tx_enable</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">bp</span><span class="o">-&gt;</span><span class="n">dcbx_config_params</span><span class="p">.</span><span class="n">admin_ets_reco_valid</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">bp</span><span class="o">-&gt;</span><span class="n">dcbx_config_params</span><span class="p">.</span><span class="n">admin_app_priority_willing</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">bp</span><span class="o">-&gt;</span><span class="n">dcbx_config_params</span><span class="p">.</span><span class="n">admin_configuration_bw_precentage</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
	<span class="n">bp</span><span class="o">-&gt;</span><span class="n">dcbx_config_params</span><span class="p">.</span><span class="n">admin_configuration_bw_precentage</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">bp</span><span class="o">-&gt;</span><span class="n">dcbx_config_params</span><span class="p">.</span><span class="n">admin_configuration_bw_precentage</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">bp</span><span class="o">-&gt;</span><span class="n">dcbx_config_params</span><span class="p">.</span><span class="n">admin_configuration_bw_precentage</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">bp</span><span class="o">-&gt;</span><span class="n">dcbx_config_params</span><span class="p">.</span><span class="n">admin_configuration_bw_precentage</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">bp</span><span class="o">-&gt;</span><span class="n">dcbx_config_params</span><span class="p">.</span><span class="n">admin_configuration_bw_precentage</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">bp</span><span class="o">-&gt;</span><span class="n">dcbx_config_params</span><span class="p">.</span><span class="n">admin_configuration_bw_precentage</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">bp</span><span class="o">-&gt;</span><span class="n">dcbx_config_params</span><span class="p">.</span><span class="n">admin_configuration_bw_precentage</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">bp</span><span class="o">-&gt;</span><span class="n">dcbx_config_params</span><span class="p">.</span><span class="n">admin_configuration_ets_pg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">bp</span><span class="o">-&gt;</span><span class="n">dcbx_config_params</span><span class="p">.</span><span class="n">admin_configuration_ets_pg</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">bp</span><span class="o">-&gt;</span><span class="n">dcbx_config_params</span><span class="p">.</span><span class="n">admin_configuration_ets_pg</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">bp</span><span class="o">-&gt;</span><span class="n">dcbx_config_params</span><span class="p">.</span><span class="n">admin_configuration_ets_pg</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">bp</span><span class="o">-&gt;</span><span class="n">dcbx_config_params</span><span class="p">.</span><span class="n">admin_configuration_ets_pg</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">bp</span><span class="o">-&gt;</span><span class="n">dcbx_config_params</span><span class="p">.</span><span class="n">admin_configuration_ets_pg</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">bp</span><span class="o">-&gt;</span><span class="n">dcbx_config_params</span><span class="p">.</span><span class="n">admin_configuration_ets_pg</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">bp</span><span class="o">-&gt;</span><span class="n">dcbx_config_params</span><span class="p">.</span><span class="n">admin_configuration_ets_pg</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">bp</span><span class="o">-&gt;</span><span class="n">dcbx_config_params</span><span class="p">.</span><span class="n">admin_recommendation_bw_precentage</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
	<span class="n">bp</span><span class="o">-&gt;</span><span class="n">dcbx_config_params</span><span class="p">.</span><span class="n">admin_recommendation_bw_precentage</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">bp</span><span class="o">-&gt;</span><span class="n">dcbx_config_params</span><span class="p">.</span><span class="n">admin_recommendation_bw_precentage</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">bp</span><span class="o">-&gt;</span><span class="n">dcbx_config_params</span><span class="p">.</span><span class="n">admin_recommendation_bw_precentage</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">bp</span><span class="o">-&gt;</span><span class="n">dcbx_config_params</span><span class="p">.</span><span class="n">admin_recommendation_bw_precentage</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">bp</span><span class="o">-&gt;</span><span class="n">dcbx_config_params</span><span class="p">.</span><span class="n">admin_recommendation_bw_precentage</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">bp</span><span class="o">-&gt;</span><span class="n">dcbx_config_params</span><span class="p">.</span><span class="n">admin_recommendation_bw_precentage</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">bp</span><span class="o">-&gt;</span><span class="n">dcbx_config_params</span><span class="p">.</span><span class="n">admin_recommendation_bw_precentage</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">bp</span><span class="o">-&gt;</span><span class="n">dcbx_config_params</span><span class="p">.</span><span class="n">admin_recommendation_ets_pg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">bp</span><span class="o">-&gt;</span><span class="n">dcbx_config_params</span><span class="p">.</span><span class="n">admin_recommendation_ets_pg</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">bp</span><span class="o">-&gt;</span><span class="n">dcbx_config_params</span><span class="p">.</span><span class="n">admin_recommendation_ets_pg</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">bp</span><span class="o">-&gt;</span><span class="n">dcbx_config_params</span><span class="p">.</span><span class="n">admin_recommendation_ets_pg</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
	<span class="n">bp</span><span class="o">-&gt;</span><span class="n">dcbx_config_params</span><span class="p">.</span><span class="n">admin_recommendation_ets_pg</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">bp</span><span class="o">-&gt;</span><span class="n">dcbx_config_params</span><span class="p">.</span><span class="n">admin_recommendation_ets_pg</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
	<span class="n">bp</span><span class="o">-&gt;</span><span class="n">dcbx_config_params</span><span class="p">.</span><span class="n">admin_recommendation_ets_pg</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
	<span class="n">bp</span><span class="o">-&gt;</span><span class="n">dcbx_config_params</span><span class="p">.</span><span class="n">admin_recommendation_ets_pg</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span>
	<span class="n">bp</span><span class="o">-&gt;</span><span class="n">dcbx_config_params</span><span class="p">.</span><span class="n">admin_pfc_bitmap</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>
	<span class="n">bp</span><span class="o">-&gt;</span><span class="n">dcbx_config_params</span><span class="p">.</span><span class="n">admin_priority_app_table</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">valid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">bp</span><span class="o">-&gt;</span><span class="n">dcbx_config_params</span><span class="p">.</span><span class="n">admin_priority_app_table</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">valid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">bp</span><span class="o">-&gt;</span><span class="n">dcbx_config_params</span><span class="p">.</span><span class="n">admin_priority_app_table</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">valid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">bp</span><span class="o">-&gt;</span><span class="n">dcbx_config_params</span><span class="p">.</span><span class="n">admin_priority_app_table</span><span class="p">[</span><span class="mi">3</span><span class="p">].</span><span class="n">valid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">bp</span><span class="o">-&gt;</span><span class="n">dcbx_config_params</span><span class="p">.</span><span class="n">admin_default_priority</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">bnx2x_dcbx_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">dcbx_lldp_params_offset</span> <span class="o">=</span> <span class="n">SHMEM_LLDP_DCBX_PARAMS_NONE</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">dcbx_enabled</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* validate:</span>
<span class="cm">	 * chip of good for dcbx version,</span>
<span class="cm">	 * dcb is wanted</span>
<span class="cm">	 * the function is pmf</span>
<span class="cm">	 * shmem2 contains DCBX support fields</span>
<span class="cm">	 */</span>
	<span class="n">DP</span><span class="p">(</span><span class="n">BNX2X_MSG_DCB</span><span class="p">,</span> <span class="s">&quot;dcb_state %d bp-&gt;port.pmf %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	   <span class="n">bp</span><span class="o">-&gt;</span><span class="n">dcb_state</span><span class="p">,</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">pmf</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">dcb_state</span> <span class="o">==</span> <span class="n">BNX2X_DCB_STATE_ON</span> <span class="o">&amp;&amp;</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">pmf</span> <span class="o">&amp;&amp;</span>
	    <span class="n">SHMEM2_HAS</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">dcbx_lldp_params_offset</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dcbx_lldp_params_offset</span> <span class="o">=</span>
			<span class="n">SHMEM2_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">dcbx_lldp_params_offset</span><span class="p">);</span>

		<span class="n">DP</span><span class="p">(</span><span class="n">BNX2X_MSG_DCB</span><span class="p">,</span> <span class="s">&quot;dcbx_lldp_params_offset 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">dcbx_lldp_params_offset</span><span class="p">);</span>

		<span class="n">bnx2x_update_drv_flags</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">DRV_FLAGS_DCB_CONFIGURED</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">SHMEM_LLDP_DCBX_PARAMS_NONE</span> <span class="o">!=</span> <span class="n">dcbx_lldp_params_offset</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">bnx2x_dcbx_admin_mib_updated_params</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span>
				<span class="n">dcbx_lldp_params_offset</span><span class="p">);</span>

			<span class="cm">/* Let HW start negotiation */</span>
			<span class="n">bnx2x_fw_command</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span>
					 <span class="n">DRV_MSG_CODE_DCBX_ADMIN_PMF_MSG</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bnx2x_dcbx_print_cos_params</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">bnx2x_func_tx_start_params</span> <span class="o">*</span><span class="n">pfc_fw_cfg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">pri</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">cos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">DP</span><span class="p">(</span><span class="n">BNX2X_MSG_DCB</span><span class="p">,</span>
	   <span class="s">&quot;pfc_fw_cfg-&gt;dcb_version %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pfc_fw_cfg</span><span class="o">-&gt;</span><span class="n">dcb_version</span><span class="p">);</span>
	<span class="n">DP</span><span class="p">(</span><span class="n">BNX2X_MSG_DCB</span><span class="p">,</span>
	   <span class="s">&quot;pdev-&gt;params.dcbx_port_params.pfc.priority_non_pauseable_mask %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	   <span class="n">bp</span><span class="o">-&gt;</span><span class="n">dcbx_port_params</span><span class="p">.</span><span class="n">pfc</span><span class="p">.</span><span class="n">priority_non_pauseable_mask</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">cos</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span> <span class="n">cos</span> <span class="o">&lt;</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">dcbx_port_params</span><span class="p">.</span><span class="n">ets</span><span class="p">.</span><span class="n">num_of_cos</span> <span class="p">;</span> <span class="n">cos</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DP</span><span class="p">(</span><span class="n">BNX2X_MSG_DCB</span><span class="p">,</span>
		   <span class="s">&quot;pdev-&gt;params.dcbx_port_params.ets.cos_params[%d].pri_bitmask %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">cos</span><span class="p">,</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">dcbx_port_params</span><span class="p">.</span><span class="n">ets</span><span class="p">.</span><span class="n">cos_params</span><span class="p">[</span><span class="n">cos</span><span class="p">].</span><span class="n">pri_bitmask</span><span class="p">);</span>

		<span class="n">DP</span><span class="p">(</span><span class="n">BNX2X_MSG_DCB</span><span class="p">,</span>
		   <span class="s">&quot;pdev-&gt;params.dcbx_port_params.ets.cos_params[%d].bw_tbl %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">cos</span><span class="p">,</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">dcbx_port_params</span><span class="p">.</span><span class="n">ets</span><span class="p">.</span><span class="n">cos_params</span><span class="p">[</span><span class="n">cos</span><span class="p">].</span><span class="n">bw_tbl</span><span class="p">);</span>

		<span class="n">DP</span><span class="p">(</span><span class="n">BNX2X_MSG_DCB</span><span class="p">,</span>
		   <span class="s">&quot;pdev-&gt;params.dcbx_port_params.ets.cos_params[%d].strict %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">cos</span><span class="p">,</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">dcbx_port_params</span><span class="p">.</span><span class="n">ets</span><span class="p">.</span><span class="n">cos_params</span><span class="p">[</span><span class="n">cos</span><span class="p">].</span><span class="n">strict</span><span class="p">);</span>

		<span class="n">DP</span><span class="p">(</span><span class="n">BNX2X_MSG_DCB</span><span class="p">,</span>
		   <span class="s">&quot;pdev-&gt;params.dcbx_port_params.ets.cos_params[%d].pauseable %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">cos</span><span class="p">,</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">dcbx_port_params</span><span class="p">.</span><span class="n">ets</span><span class="p">.</span><span class="n">cos_params</span><span class="p">[</span><span class="n">cos</span><span class="p">].</span><span class="n">pauseable</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">pri</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">pri</span> <span class="o">&lt;</span> <span class="n">LLFC_DRIVER_TRAFFIC_TYPE_MAX</span><span class="p">;</span> <span class="n">pri</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DP</span><span class="p">(</span><span class="n">BNX2X_MSG_DCB</span><span class="p">,</span>
		   <span class="s">&quot;pfc_fw_cfg-&gt;traffic_type_to_priority_cos[%d].priority %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">pri</span><span class="p">,</span> <span class="n">pfc_fw_cfg</span><span class="o">-&gt;</span><span class="n">traffic_type_to_priority_cos</span><span class="p">[</span><span class="n">pri</span><span class="p">].</span><span class="n">priority</span><span class="p">);</span>

		<span class="n">DP</span><span class="p">(</span><span class="n">BNX2X_MSG_DCB</span><span class="p">,</span>
		   <span class="s">&quot;pfc_fw_cfg-&gt;traffic_type_to_priority_cos[%d].cos %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">pri</span><span class="p">,</span> <span class="n">pfc_fw_cfg</span><span class="o">-&gt;</span><span class="n">traffic_type_to_priority_cos</span><span class="p">[</span><span class="n">pri</span><span class="p">].</span><span class="n">cos</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* fills help_data according to pg_info */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_dcbx_get_num_pg_traf_type</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">,</span>
					    <span class="n">u32</span> <span class="o">*</span><span class="n">pg_pri_orginal_spread</span><span class="p">,</span>
					    <span class="k">struct</span> <span class="n">pg_help_data</span> <span class="o">*</span><span class="n">help_data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bool</span> <span class="n">pg_found</span>  <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">i</span><span class="p">,</span> <span class="n">traf_type</span><span class="p">,</span> <span class="n">add_traf_type</span><span class="p">,</span> <span class="n">add_pg</span><span class="p">;</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">ttp</span> <span class="o">=</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">dcbx_port_params</span><span class="p">.</span><span class="n">app</span><span class="p">.</span><span class="n">traffic_type_priority</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pg_entry_help_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">help_data</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span> <span class="cm">/*shotcut*/</span>

	<span class="cm">/* Set to invalid */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">LLFC_DRIVER_TRAFFIC_TYPE_MAX</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">pg</span> <span class="o">=</span> <span class="n">DCBX_ILLEGAL_PG</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">add_traf_type</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	     <span class="n">add_traf_type</span> <span class="o">&lt;</span> <span class="n">LLFC_DRIVER_TRAFFIC_TYPE_MAX</span><span class="p">;</span> <span class="n">add_traf_type</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pg_found</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ttp</span><span class="p">[</span><span class="n">add_traf_type</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">MAX_PFC_PRIORITIES</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">add_pg</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">pg_pri_orginal_spread</span><span class="p">[</span><span class="n">ttp</span><span class="p">[</span><span class="n">add_traf_type</span><span class="p">]];</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">traf_type</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			     <span class="n">traf_type</span> <span class="o">&lt;</span> <span class="n">LLFC_DRIVER_TRAFFIC_TYPE_MAX</span><span class="p">;</span>
			     <span class="n">traf_type</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">traf_type</span><span class="p">].</span><span class="n">pg</span> <span class="o">==</span> <span class="n">add_pg</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">traf_type</span><span class="p">].</span><span class="n">pg_priority</span> <span class="o">&amp;</span>
					     <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">ttp</span><span class="p">[</span><span class="n">add_traf_type</span><span class="p">])))</span>
						<span class="n">data</span><span class="p">[</span><span class="n">traf_type</span><span class="p">].</span>
							<span class="n">num_of_dif_pri</span><span class="o">++</span><span class="p">;</span>
					<span class="n">data</span><span class="p">[</span><span class="n">traf_type</span><span class="p">].</span><span class="n">pg_priority</span> <span class="o">|=</span>
						<span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">ttp</span><span class="p">[</span><span class="n">add_traf_type</span><span class="p">]);</span>
					<span class="n">pg_found</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="nb">false</span> <span class="o">==</span> <span class="n">pg_found</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">data</span><span class="p">[</span><span class="n">help_data</span><span class="o">-&gt;</span><span class="n">num_of_pg</span><span class="p">].</span><span class="n">pg</span> <span class="o">=</span> <span class="n">add_pg</span><span class="p">;</span>
				<span class="n">data</span><span class="p">[</span><span class="n">help_data</span><span class="o">-&gt;</span><span class="n">num_of_pg</span><span class="p">].</span><span class="n">pg_priority</span> <span class="o">=</span>
						<span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">ttp</span><span class="p">[</span><span class="n">add_traf_type</span><span class="p">]);</span>
				<span class="n">data</span><span class="p">[</span><span class="n">help_data</span><span class="o">-&gt;</span><span class="n">num_of_pg</span><span class="p">].</span><span class="n">num_of_dif_pri</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">help_data</span><span class="o">-&gt;</span><span class="n">num_of_pg</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">DP</span><span class="p">(</span><span class="n">BNX2X_MSG_DCB</span><span class="p">,</span>
		   <span class="s">&quot;add_traf_type %d pg_found %s num_of_pg %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">add_traf_type</span><span class="p">,</span> <span class="p">(</span><span class="nb">false</span> <span class="o">==</span> <span class="n">pg_found</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;NO&quot;</span> <span class="o">:</span> <span class="s">&quot;YES&quot;</span><span class="p">,</span>
		   <span class="n">help_data</span><span class="o">-&gt;</span><span class="n">num_of_pg</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_dcbx_ets_disabled_entry_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">,</span>
					       <span class="k">struct</span> <span class="n">cos_help_data</span> <span class="o">*</span><span class="n">cos_data</span><span class="p">,</span>
					       <span class="n">u32</span> <span class="n">pri_join_mask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Only one priority than only one COS */</span>
	<span class="n">cos_data</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">pausable</span> <span class="o">=</span>
		<span class="n">IS_DCBX_PFC_PRI_ONLY_PAUSE</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">pri_join_mask</span><span class="p">);</span>
	<span class="n">cos_data</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">pri_join_mask</span> <span class="o">=</span> <span class="n">pri_join_mask</span><span class="p">;</span>
	<span class="n">cos_data</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">cos_bw</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
	<span class="n">cos_data</span><span class="o">-&gt;</span><span class="n">num_of_cos</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">bnx2x_dcbx_add_to_cos_bw</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">,</span>
					    <span class="k">struct</span> <span class="n">cos_entry_help_data</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
					    <span class="n">u8</span> <span class="n">pg_bw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">cos_bw</span> <span class="o">==</span> <span class="n">DCBX_INVALID_COS_BW</span><span class="p">)</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">cos_bw</span> <span class="o">=</span> <span class="n">pg_bw</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">cos_bw</span> <span class="o">+=</span> <span class="n">pg_bw</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_dcbx_separate_pauseable_from_non</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">cos_help_data</span> <span class="o">*</span><span class="n">cos_data</span><span class="p">,</span>
			<span class="n">u32</span> <span class="o">*</span><span class="n">pg_pri_orginal_spread</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">dcbx_ets_feature</span> <span class="o">*</span><span class="n">ets</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span>	<span class="n">pri_tested</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span>	<span class="n">i</span>		<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span>	<span class="n">entry</span>		<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span>	<span class="n">pg_entry</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span>	<span class="n">num_of_pri</span>	<span class="o">=</span> <span class="n">LLFC_DRIVER_TRAFFIC_TYPE_MAX</span><span class="p">;</span>

	<span class="n">cos_data</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">pausable</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="n">cos_data</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">pausable</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">cos_data</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">pri_join_mask</span> <span class="o">=</span> <span class="n">cos_data</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">pri_join_mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num_of_pri</span> <span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pri_tested</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">dcbx_port_params</span><span class="p">.</span>
					<span class="n">app</span><span class="p">.</span><span class="n">traffic_type_priority</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">pri_tested</span> <span class="o">&amp;</span> <span class="n">DCBX_PFC_PRI_NON_PAUSE_MASK</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">cos_data</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">pri_join_mask</span> <span class="o">|=</span> <span class="n">pri_tested</span><span class="p">;</span>
			<span class="n">entry</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">cos_data</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">pri_join_mask</span> <span class="o">|=</span> <span class="n">pri_tested</span><span class="p">;</span>
			<span class="n">entry</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">pg_entry</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">pg_pri_orginal_spread</span><span class="p">[</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">dcbx_port_params</span><span class="p">.</span>
						<span class="n">app</span><span class="p">.</span><span class="n">traffic_type_priority</span><span class="p">[</span><span class="n">i</span><span class="p">]];</span>
		<span class="cm">/* There can be only one strict pg */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pg_entry</span> <span class="o">&lt;</span> <span class="n">DCBX_MAX_NUM_PG_BW_ENTRIES</span><span class="p">)</span>
			<span class="n">bnx2x_dcbx_add_to_cos_bw</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cos_data</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">entry</span><span class="p">],</span>
				<span class="n">DCBX_PG_BW_GET</span><span class="p">(</span><span class="n">ets</span><span class="o">-&gt;</span><span class="n">pg_bw_tbl</span><span class="p">,</span> <span class="n">pg_entry</span><span class="p">));</span>
		<span class="k">else</span>
			<span class="cm">/* If we join a group and one is strict</span>
<span class="cm">			 * than the bw rulls */</span>
			<span class="n">cos_data</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">entry</span><span class="p">].</span><span class="n">strict</span> <span class="o">=</span>
						<span class="n">BNX2X_DCBX_STRICT_COS_HIGHEST</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="mi">0</span> <span class="o">==</span> <span class="n">cos_data</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">pri_join_mask</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="mi">0</span> <span class="o">==</span> <span class="n">cos_data</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">pri_join_mask</span><span class="p">))</span>
		<span class="n">BNX2X_ERR</span><span class="p">(</span><span class="s">&quot;dcbx error: Both groups must have priorities</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>


<span class="cp">#ifndef POWER_OF_2</span>
<span class="cp">#define POWER_OF_2(x)	((0 != x) &amp;&amp; (0 == (x &amp; (x-1))))</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_dcbx_2cos_limit_cee_single_pg_to_cos_params</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">,</span>
					      <span class="k">struct</span> <span class="n">pg_help_data</span> <span class="o">*</span><span class="n">pg_help_data</span><span class="p">,</span>
					      <span class="k">struct</span> <span class="n">cos_help_data</span> <span class="o">*</span><span class="n">cos_data</span><span class="p">,</span>
					      <span class="n">u32</span> <span class="n">pri_join_mask</span><span class="p">,</span>
					      <span class="n">u8</span> <span class="n">num_of_dif_pri</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">pri_tested</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">pri_mask_without_pri</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">ttp</span> <span class="o">=</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">dcbx_port_params</span><span class="p">.</span><span class="n">app</span><span class="p">.</span><span class="n">traffic_type_priority</span><span class="p">;</span>
	<span class="cm">/*debug*/</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">num_of_dif_pri</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bnx2x_dcbx_ets_disabled_entry_data</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">cos_data</span><span class="p">,</span> <span class="n">pri_join_mask</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* single priority group */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pg_help_data</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">pg</span> <span class="o">&lt;</span> <span class="n">DCBX_MAX_NUM_PG_BW_ENTRIES</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* If there are both pauseable and non-pauseable priorities,</span>
<span class="cm">		 * the pauseable priorities go to the first queue and</span>
<span class="cm">		 * the non-pauseable priorities go to the second queue.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_DCBX_PFC_PRI_MIX_PAUSE</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">pri_join_mask</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* Pauseable */</span>
			<span class="n">cos_data</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">pausable</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="cm">/* Non pauseable.*/</span>
			<span class="n">cos_data</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">pausable</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="mi">2</span> <span class="o">==</span> <span class="n">num_of_dif_pri</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">cos_data</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">cos_bw</span> <span class="o">=</span> <span class="mi">50</span><span class="p">;</span>
				<span class="n">cos_data</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">cos_bw</span> <span class="o">=</span> <span class="mi">50</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="mi">3</span> <span class="o">==</span> <span class="n">num_of_dif_pri</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">POWER_OF_2</span><span class="p">(</span><span class="n">DCBX_PFC_PRI_GET_PAUSE</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span>
							<span class="n">pri_join_mask</span><span class="p">)))</span> <span class="p">{</span>
					<span class="n">cos_data</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">cos_bw</span> <span class="o">=</span> <span class="mi">33</span><span class="p">;</span>
					<span class="n">cos_data</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">cos_bw</span> <span class="o">=</span> <span class="mi">67</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">cos_data</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">cos_bw</span> <span class="o">=</span> <span class="mi">67</span><span class="p">;</span>
					<span class="n">cos_data</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">cos_bw</span> <span class="o">=</span> <span class="mi">33</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>

		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">IS_DCBX_PFC_PRI_ONLY_PAUSE</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">pri_join_mask</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* If there are only pauseable priorities,</span>
<span class="cm">			 * then one/two priorities go to the first queue</span>
<span class="cm">			 * and one priority goes to the second queue.</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="mi">2</span> <span class="o">==</span> <span class="n">num_of_dif_pri</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">cos_data</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">cos_bw</span> <span class="o">=</span> <span class="mi">50</span><span class="p">;</span>
				<span class="n">cos_data</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">cos_bw</span> <span class="o">=</span> <span class="mi">50</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">cos_data</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">cos_bw</span> <span class="o">=</span> <span class="mi">67</span><span class="p">;</span>
				<span class="n">cos_data</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">cos_bw</span> <span class="o">=</span> <span class="mi">33</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">cos_data</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">pausable</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="n">cos_data</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">pausable</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="cm">/* All priorities except FCOE */</span>
			<span class="n">cos_data</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">pri_join_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">pri_join_mask</span> <span class="o">&amp;</span>
				<span class="p">((</span><span class="n">u8</span><span class="p">)</span><span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">ttp</span><span class="p">[</span><span class="n">LLFC_TRAFFIC_TYPE_FCOE</span><span class="p">])));</span>
			<span class="cm">/* Only FCOE priority.*/</span>
			<span class="n">cos_data</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">pri_join_mask</span> <span class="o">=</span>
				<span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">ttp</span><span class="p">[</span><span class="n">LLFC_TRAFFIC_TYPE_FCOE</span><span class="p">]);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="cm">/* If there are only non-pauseable priorities,</span>
<span class="cm">			 * they will all go to the same queue.</span>
<span class="cm">			 */</span>
			<span class="n">bnx2x_dcbx_ets_disabled_entry_data</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span>
						<span class="n">cos_data</span><span class="p">,</span> <span class="n">pri_join_mask</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* priority group which is not BW limited (PG#15):*/</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_DCBX_PFC_PRI_MIX_PAUSE</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">pri_join_mask</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* If there are both pauseable and non-pauseable</span>
<span class="cm">			 * priorities, the pauseable priorities go to the first</span>
<span class="cm">			 * queue and the non-pauseable priorities</span>
<span class="cm">			 * go to the second queue.</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">DCBX_PFC_PRI_GET_PAUSE</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">pri_join_mask</span><span class="p">)</span> <span class="o">&gt;</span>
			    <span class="n">DCBX_PFC_PRI_GET_NON_PAUSE</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">pri_join_mask</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">cos_data</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">strict</span> <span class="o">=</span>
					<span class="n">BNX2X_DCBX_STRICT_COS_HIGHEST</span><span class="p">;</span>
				<span class="n">cos_data</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">strict</span> <span class="o">=</span>
					<span class="n">BNX2X_DCBX_STRICT_COS_NEXT_LOWER_PRI</span><span class="p">(</span>
						<span class="n">BNX2X_DCBX_STRICT_COS_HIGHEST</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">cos_data</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">strict</span> <span class="o">=</span>
					<span class="n">BNX2X_DCBX_STRICT_COS_NEXT_LOWER_PRI</span><span class="p">(</span>
						<span class="n">BNX2X_DCBX_STRICT_COS_HIGHEST</span><span class="p">);</span>
				<span class="n">cos_data</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">strict</span> <span class="o">=</span>
					<span class="n">BNX2X_DCBX_STRICT_COS_HIGHEST</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="cm">/* Pauseable */</span>
			<span class="n">cos_data</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">pausable</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="cm">/* Non pause-able.*/</span>
			<span class="n">cos_data</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">pausable</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* If there are only pauseable priorities or</span>
<span class="cm">			 * only non-pauseable,* the lower priorities go</span>
<span class="cm">			 * to the first queue and the higherpriorities go</span>
<span class="cm">			 * to the second queue.</span>
<span class="cm">			 */</span>
			<span class="n">cos_data</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">pausable</span> <span class="o">=</span>
				<span class="n">cos_data</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">pausable</span> <span class="o">=</span>
				<span class="n">IS_DCBX_PFC_PRI_ONLY_PAUSE</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">pri_join_mask</span><span class="p">);</span>

			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">LLFC_DRIVER_TRAFFIC_TYPE_MAX</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">pri_tested</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">dcbx_port_params</span><span class="p">.</span>
					<span class="n">app</span><span class="p">.</span><span class="n">traffic_type_priority</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
				<span class="cm">/* Remove priority tested */</span>
				<span class="n">pri_mask_without_pri</span> <span class="o">=</span>
					<span class="p">(</span><span class="n">pri_join_mask</span> <span class="o">&amp;</span> <span class="p">((</span><span class="n">u8</span><span class="p">)(</span><span class="o">~</span><span class="n">pri_tested</span><span class="p">)));</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">pri_mask_without_pri</span> <span class="o">&lt;</span> <span class="n">pri_tested</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">LLFC_DRIVER_TRAFFIC_TYPE_MAX</span><span class="p">)</span>
				<span class="n">BNX2X_ERR</span><span class="p">(</span><span class="s">&quot;Invalid value for pri_join_mask - could not find a priority</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

			<span class="n">cos_data</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">pri_join_mask</span> <span class="o">=</span> <span class="n">pri_mask_without_pri</span><span class="p">;</span>
			<span class="n">cos_data</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">pri_join_mask</span> <span class="o">=</span> <span class="n">pri_tested</span><span class="p">;</span>
			<span class="cm">/* Both queues are strict priority,</span>
<span class="cm">			 * and that with the highest priority</span>
<span class="cm">			 * gets the highest strict priority in the arbiter.</span>
<span class="cm">			 */</span>
			<span class="n">cos_data</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">strict</span> <span class="o">=</span>
					<span class="n">BNX2X_DCBX_STRICT_COS_NEXT_LOWER_PRI</span><span class="p">(</span>
						<span class="n">BNX2X_DCBX_STRICT_COS_HIGHEST</span><span class="p">);</span>
			<span class="n">cos_data</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">strict</span> <span class="o">=</span>
					<span class="n">BNX2X_DCBX_STRICT_COS_HIGHEST</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_dcbx_2cos_limit_cee_two_pg_to_cos_params</span><span class="p">(</span>
			    <span class="k">struct</span> <span class="n">bnx2x</span>		<span class="o">*</span><span class="n">bp</span><span class="p">,</span>
			    <span class="k">struct</span>  <span class="n">pg_help_data</span>	<span class="o">*</span><span class="n">pg_help_data</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">dcbx_ets_feature</span>	<span class="o">*</span><span class="n">ets</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">cos_help_data</span>	<span class="o">*</span><span class="n">cos_data</span><span class="p">,</span>
			    <span class="n">u32</span>			<span class="o">*</span><span class="n">pg_pri_orginal_spread</span><span class="p">,</span>
			    <span class="n">u32</span>				<span class="n">pri_join_mask</span><span class="p">,</span>
			    <span class="n">u8</span>				<span class="n">num_of_dif_pri</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">pg</span><span class="p">[</span><span class="n">DCBX_COS_MAX_NUM_E2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span> <span class="p">};</span>

	<span class="cm">/* If there are both pauseable and non-pauseable priorities,</span>
<span class="cm">	 * the pauseable priorities go to the first queue and</span>
<span class="cm">	 * the non-pauseable priorities go to the second queue.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_DCBX_PFC_PRI_MIX_PAUSE</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">pri_join_mask</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_DCBX_PFC_PRI_MIX_PAUSE</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span>
					 <span class="n">pg_help_data</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">pg_priority</span><span class="p">)</span> <span class="o">||</span>
		    <span class="n">IS_DCBX_PFC_PRI_MIX_PAUSE</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span>
					 <span class="n">pg_help_data</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">pg_priority</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* If one PG contains both pauseable and</span>
<span class="cm">			 * non-pauseable priorities then ETS is disabled.</span>
<span class="cm">			 */</span>
			<span class="n">bnx2x_dcbx_separate_pauseable_from_non</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">cos_data</span><span class="p">,</span>
					<span class="n">pg_pri_orginal_spread</span><span class="p">,</span> <span class="n">ets</span><span class="p">);</span>
			<span class="n">bp</span><span class="o">-&gt;</span><span class="n">dcbx_port_params</span><span class="p">.</span><span class="n">ets</span><span class="p">.</span><span class="n">enabled</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Pauseable */</span>
		<span class="n">cos_data</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">pausable</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="cm">/* Non pauseable. */</span>
		<span class="n">cos_data</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">pausable</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_DCBX_PFC_PRI_ONLY_PAUSE</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span>
				<span class="n">pg_help_data</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">pg_priority</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* 0 is pauseable */</span>
			<span class="n">cos_data</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">pri_join_mask</span> <span class="o">=</span>
				<span class="n">pg_help_data</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">pg_priority</span><span class="p">;</span>
			<span class="n">pg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">pg_help_data</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">pg</span><span class="p">;</span>
			<span class="n">cos_data</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">pri_join_mask</span> <span class="o">=</span>
				<span class="n">pg_help_data</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">pg_priority</span><span class="p">;</span>
			<span class="n">pg</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">pg_help_data</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">pg</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span><span class="cm">/* 1 is pauseable */</span>
			<span class="n">cos_data</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">pri_join_mask</span> <span class="o">=</span>
				<span class="n">pg_help_data</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">pg_priority</span><span class="p">;</span>
			<span class="n">pg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">pg_help_data</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">pg</span><span class="p">;</span>
			<span class="n">cos_data</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">pri_join_mask</span> <span class="o">=</span>
				<span class="n">pg_help_data</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">pg_priority</span><span class="p">;</span>
			<span class="n">pg</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">pg_help_data</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">pg</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* If there are only pauseable priorities or</span>
<span class="cm">		 * only non-pauseable, each PG goes to a queue.</span>
<span class="cm">		 */</span>
		<span class="n">cos_data</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">pausable</span> <span class="o">=</span> <span class="n">cos_data</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">pausable</span> <span class="o">=</span>
			<span class="n">IS_DCBX_PFC_PRI_ONLY_PAUSE</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">pri_join_mask</span><span class="p">);</span>
		<span class="n">cos_data</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">pri_join_mask</span> <span class="o">=</span>
			<span class="n">pg_help_data</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">pg_priority</span><span class="p">;</span>
		<span class="n">pg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">pg_help_data</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">pg</span><span class="p">;</span>
		<span class="n">cos_data</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">pri_join_mask</span> <span class="o">=</span>
			<span class="n">pg_help_data</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">pg_priority</span><span class="p">;</span>
		<span class="n">pg</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">pg_help_data</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">pg</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* There can be only one strict pg */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">pg</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pg</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">DCBX_MAX_NUM_PG_BW_ENTRIES</span><span class="p">)</span>
			<span class="n">cos_data</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">cos_bw</span> <span class="o">=</span>
				<span class="n">DCBX_PG_BW_GET</span><span class="p">(</span><span class="n">ets</span><span class="o">-&gt;</span><span class="n">pg_bw_tbl</span><span class="p">,</span> <span class="n">pg</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="k">else</span>
			<span class="n">cos_data</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">strict</span> <span class="o">=</span>
						<span class="n">BNX2X_DCBX_STRICT_COS_HIGHEST</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bnx2x_dcbx_join_pgs</span><span class="p">(</span>
			      <span class="k">struct</span> <span class="n">bnx2x</span>            <span class="o">*</span><span class="n">bp</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">dcbx_ets_feature</span> <span class="o">*</span><span class="n">ets</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">pg_help_data</span>     <span class="o">*</span><span class="n">pg_help_data</span><span class="p">,</span>
			      <span class="n">u8</span>                      <span class="n">required_num_of_pg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">entry_joined</span>    <span class="o">=</span> <span class="n">pg_help_data</span><span class="o">-&gt;</span><span class="n">num_of_pg</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">entry_removed</span>   <span class="o">=</span> <span class="n">entry_joined</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">pg_joined</span>       <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">required_num_of_pg</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">pg_help_data</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">)</span>
						<span class="o">&lt;=</span> <span class="n">pg_help_data</span><span class="o">-&gt;</span><span class="n">num_of_pg</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">BNX2X_ERR</span><span class="p">(</span><span class="s">&quot;required_num_of_pg can&#39;t be zero</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">required_num_of_pg</span> <span class="o">&lt;</span> <span class="n">pg_help_data</span><span class="o">-&gt;</span><span class="n">num_of_pg</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">entry_joined</span> <span class="o">=</span> <span class="n">pg_help_data</span><span class="o">-&gt;</span><span class="n">num_of_pg</span> <span class="o">-</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">entry_removed</span> <span class="o">=</span> <span class="n">entry_joined</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="cm">/* protect index */</span>
		<span class="n">entry_removed</span> <span class="o">%=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">pg_help_data</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>

		<span class="n">pg_help_data</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">entry_joined</span><span class="p">].</span><span class="n">pg_priority</span> <span class="o">|=</span>
			<span class="n">pg_help_data</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">entry_removed</span><span class="p">].</span><span class="n">pg_priority</span><span class="p">;</span>

		<span class="n">pg_help_data</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">entry_joined</span><span class="p">].</span><span class="n">num_of_dif_pri</span> <span class="o">+=</span>
			<span class="n">pg_help_data</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">entry_removed</span><span class="p">].</span><span class="n">num_of_dif_pri</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">pg_help_data</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">entry_joined</span><span class="p">].</span><span class="n">pg</span> <span class="o">==</span> <span class="n">DCBX_STRICT_PRI_PG</span> <span class="o">||</span>
		    <span class="n">pg_help_data</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">entry_removed</span><span class="p">].</span><span class="n">pg</span> <span class="o">==</span> <span class="n">DCBX_STRICT_PRI_PG</span><span class="p">)</span>
			<span class="cm">/* Entries joined strict priority rules */</span>
			<span class="n">pg_help_data</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">entry_joined</span><span class="p">].</span><span class="n">pg</span> <span class="o">=</span>
							<span class="n">DCBX_STRICT_PRI_PG</span><span class="p">;</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* Entries can be joined join BW */</span>
			<span class="n">pg_joined</span> <span class="o">=</span> <span class="n">DCBX_PG_BW_GET</span><span class="p">(</span><span class="n">ets</span><span class="o">-&gt;</span><span class="n">pg_bw_tbl</span><span class="p">,</span>
					<span class="n">pg_help_data</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">entry_joined</span><span class="p">].</span><span class="n">pg</span><span class="p">)</span> <span class="o">+</span>
				    <span class="n">DCBX_PG_BW_GET</span><span class="p">(</span><span class="n">ets</span><span class="o">-&gt;</span><span class="n">pg_bw_tbl</span><span class="p">,</span>
					<span class="n">pg_help_data</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">entry_removed</span><span class="p">].</span><span class="n">pg</span><span class="p">);</span>

			<span class="n">DCBX_PG_BW_SET</span><span class="p">(</span><span class="n">ets</span><span class="o">-&gt;</span><span class="n">pg_bw_tbl</span><span class="p">,</span>
				<span class="n">pg_help_data</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">entry_joined</span><span class="p">].</span><span class="n">pg</span><span class="p">,</span> <span class="n">pg_joined</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="cm">/* Joined the entries */</span>
		<span class="n">pg_help_data</span><span class="o">-&gt;</span><span class="n">num_of_pg</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_dcbx_2cos_limit_cee_three_pg_to_cos_params</span><span class="p">(</span>
			      <span class="k">struct</span> <span class="n">bnx2x</span>		<span class="o">*</span><span class="n">bp</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">pg_help_data</span>	<span class="o">*</span><span class="n">pg_help_data</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">dcbx_ets_feature</span>	<span class="o">*</span><span class="n">ets</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">cos_help_data</span>	<span class="o">*</span><span class="n">cos_data</span><span class="p">,</span>
			      <span class="n">u32</span>			<span class="o">*</span><span class="n">pg_pri_orginal_spread</span><span class="p">,</span>
			      <span class="n">u32</span>			<span class="n">pri_join_mask</span><span class="p">,</span>
			      <span class="n">u8</span>			<span class="n">num_of_dif_pri</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">pri_tested</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">entry</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">pg_entry</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">b_found_strict</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">num_of_pri</span> <span class="o">=</span> <span class="n">LLFC_DRIVER_TRAFFIC_TYPE_MAX</span><span class="p">;</span>

	<span class="n">cos_data</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">pri_join_mask</span> <span class="o">=</span> <span class="n">cos_data</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">pri_join_mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="cm">/* If there are both pauseable and non-pauseable priorities,</span>
<span class="cm">	 * the pauseable priorities go to the first queue and the</span>
<span class="cm">	 * non-pauseable priorities go to the second queue.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_DCBX_PFC_PRI_MIX_PAUSE</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">pri_join_mask</span><span class="p">))</span>
		<span class="n">bnx2x_dcbx_separate_pauseable_from_non</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span>
				<span class="n">cos_data</span><span class="p">,</span> <span class="n">pg_pri_orginal_spread</span><span class="p">,</span> <span class="n">ets</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* If two BW-limited PG-s were combined to one queue,</span>
<span class="cm">		 * the BW is their sum.</span>
<span class="cm">		 *</span>
<span class="cm">		 * If there are only pauseable priorities or only non-pauseable,</span>
<span class="cm">		 * and there are both BW-limited and non-BW-limited PG-s,</span>
<span class="cm">		 * the BW-limited PG/s go to one queue and the non-BW-limited</span>
<span class="cm">		 * PG/s go to the second queue.</span>
<span class="cm">		 *</span>
<span class="cm">		 * If there are only pauseable priorities or only non-pauseable</span>
<span class="cm">		 * and all are BW limited, then	two priorities go to the first</span>
<span class="cm">		 * queue and one priority goes to the second queue.</span>
<span class="cm">		 *</span>
<span class="cm">		 * We will join this two cases:</span>
<span class="cm">		 * if one is BW limited it will go to the secoend queue</span>
<span class="cm">		 * otherwise the last priority will get it</span>
<span class="cm">		 */</span>

		<span class="n">cos_data</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">pausable</span> <span class="o">=</span> <span class="n">cos_data</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">pausable</span> <span class="o">=</span>
			<span class="n">IS_DCBX_PFC_PRI_ONLY_PAUSE</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">pri_join_mask</span><span class="p">);</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num_of_pri</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pri_tested</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">dcbx_port_params</span><span class="p">.</span>
				<span class="n">app</span><span class="p">.</span><span class="n">traffic_type_priority</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="n">pg_entry</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">pg_pri_orginal_spread</span><span class="p">[</span><span class="n">bp</span><span class="o">-&gt;</span>
				<span class="n">dcbx_port_params</span><span class="p">.</span><span class="n">app</span><span class="p">.</span><span class="n">traffic_type_priority</span><span class="p">[</span><span class="n">i</span><span class="p">]];</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">pg_entry</span> <span class="o">&lt;</span> <span class="n">DCBX_MAX_NUM_PG_BW_ENTRIES</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">entry</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="p">(</span><span class="n">num_of_pri</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
				    <span class="nb">false</span> <span class="o">==</span> <span class="n">b_found_strict</span><span class="p">)</span>
					<span class="cm">/* last entry will be handled separately</span>
<span class="cm">					 * If no priority is strict than last</span>
<span class="cm">					 * enty goes to last queue.*/</span>
					<span class="n">entry</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">cos_data</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">entry</span><span class="p">].</span><span class="n">pri_join_mask</span> <span class="o">|=</span>
								<span class="n">pri_tested</span><span class="p">;</span>
				<span class="n">bnx2x_dcbx_add_to_cos_bw</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">cos_data</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">entry</span><span class="p">],</span>
					<span class="n">DCBX_PG_BW_GET</span><span class="p">(</span><span class="n">ets</span><span class="o">-&gt;</span><span class="n">pg_bw_tbl</span><span class="p">,</span>
						       <span class="n">pg_entry</span><span class="p">));</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">b_found_strict</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
				<span class="n">cos_data</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">pri_join_mask</span> <span class="o">|=</span> <span class="n">pri_tested</span><span class="p">;</span>
				<span class="cm">/* If we join a group and one is strict</span>
<span class="cm">				 * than the bw rulls */</span>
				<span class="n">cos_data</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">strict</span> <span class="o">=</span>
					<span class="n">BNX2X_DCBX_STRICT_COS_HIGHEST</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_dcbx_2cos_limit_cee_fill_cos_params</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">pg_help_data</span> <span class="o">*</span><span class="n">help_data</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">dcbx_ets_feature</span> <span class="o">*</span><span class="n">ets</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">cos_help_data</span> <span class="o">*</span><span class="n">cos_data</span><span class="p">,</span>
				       <span class="n">u32</span> <span class="o">*</span><span class="n">pg_pri_orginal_spread</span><span class="p">,</span>
				       <span class="n">u32</span> <span class="n">pri_join_mask</span><span class="p">,</span>
				       <span class="n">u8</span> <span class="n">num_of_dif_pri</span><span class="p">)</span>
<span class="p">{</span>

	<span class="cm">/* default E2 settings */</span>
	<span class="n">cos_data</span><span class="o">-&gt;</span><span class="n">num_of_cos</span> <span class="o">=</span> <span class="n">DCBX_COS_MAX_NUM_E2</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">help_data</span><span class="o">-&gt;</span><span class="n">num_of_pg</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">bnx2x_dcbx_2cos_limit_cee_single_pg_to_cos_params</span><span class="p">(</span>
					       <span class="n">bp</span><span class="p">,</span>
					       <span class="n">help_data</span><span class="p">,</span>
					       <span class="n">cos_data</span><span class="p">,</span>
					       <span class="n">pri_join_mask</span><span class="p">,</span>
					       <span class="n">num_of_dif_pri</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="n">bnx2x_dcbx_2cos_limit_cee_two_pg_to_cos_params</span><span class="p">(</span>
					    <span class="n">bp</span><span class="p">,</span>
					    <span class="n">help_data</span><span class="p">,</span>
					    <span class="n">ets</span><span class="p">,</span>
					    <span class="n">cos_data</span><span class="p">,</span>
					    <span class="n">pg_pri_orginal_spread</span><span class="p">,</span>
					    <span class="n">pri_join_mask</span><span class="p">,</span>
					    <span class="n">num_of_dif_pri</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mi">3</span>:
		<span class="n">bnx2x_dcbx_2cos_limit_cee_three_pg_to_cos_params</span><span class="p">(</span>
					      <span class="n">bp</span><span class="p">,</span>
					      <span class="n">help_data</span><span class="p">,</span>
					      <span class="n">ets</span><span class="p">,</span>
					      <span class="n">cos_data</span><span class="p">,</span>
					      <span class="n">pg_pri_orginal_spread</span><span class="p">,</span>
					      <span class="n">pri_join_mask</span><span class="p">,</span>
					      <span class="n">num_of_dif_pri</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">BNX2X_ERR</span><span class="p">(</span><span class="s">&quot;Wrong pg_help_data.num_of_pg</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">bnx2x_dcbx_ets_disabled_entry_data</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span>
						   <span class="n">cos_data</span><span class="p">,</span> <span class="n">pri_join_mask</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bnx2x_dcbx_spread_strict_pri</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">cos_help_data</span> <span class="o">*</span><span class="n">cos_data</span><span class="p">,</span>
					<span class="n">u8</span> <span class="n">entry</span><span class="p">,</span>
					<span class="n">u8</span> <span class="n">num_spread_of_entries</span><span class="p">,</span>
					<span class="n">u8</span> <span class="n">strict_app_pris</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">strict_pri</span> <span class="o">=</span> <span class="n">BNX2X_DCBX_STRICT_COS_HIGHEST</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">num_of_app_pri</span> <span class="o">=</span> <span class="n">MAX_PFC_PRIORITIES</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">app_pri_bit</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">num_spread_of_entries</span> <span class="o">&amp;&amp;</span> <span class="n">num_of_app_pri</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">app_pri_bit</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">num_of_app_pri</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">app_pri_bit</span> <span class="o">&amp;</span> <span class="n">strict_app_pris</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">cos_entry_help_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cos_data</span><span class="o">-&gt;</span>
								<span class="n">data</span><span class="p">[</span><span class="n">entry</span><span class="p">];</span>
			<span class="n">num_spread_of_entries</span><span class="o">--</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">num_spread_of_entries</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* last entry needed put all the entries left */</span>
				<span class="n">data</span><span class="o">-&gt;</span><span class="n">cos_bw</span> <span class="o">=</span> <span class="n">DCBX_INVALID_COS_BW</span><span class="p">;</span>
				<span class="n">data</span><span class="o">-&gt;</span><span class="n">strict</span> <span class="o">=</span> <span class="n">strict_pri</span><span class="p">;</span>
				<span class="n">data</span><span class="o">-&gt;</span><span class="n">pri_join_mask</span> <span class="o">=</span> <span class="n">strict_app_pris</span><span class="p">;</span>
				<span class="n">data</span><span class="o">-&gt;</span><span class="n">pausable</span> <span class="o">=</span> <span class="n">DCBX_IS_PFC_PRI_SOME_PAUSE</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span>
							<span class="n">data</span><span class="o">-&gt;</span><span class="n">pri_join_mask</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">strict_app_pris</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">app_pri_bit</span><span class="p">;</span>

				<span class="n">data</span><span class="o">-&gt;</span><span class="n">cos_bw</span> <span class="o">=</span> <span class="n">DCBX_INVALID_COS_BW</span><span class="p">;</span>
				<span class="n">data</span><span class="o">-&gt;</span><span class="n">strict</span> <span class="o">=</span> <span class="n">strict_pri</span><span class="p">;</span>
				<span class="n">data</span><span class="o">-&gt;</span><span class="n">pri_join_mask</span> <span class="o">=</span> <span class="n">app_pri_bit</span><span class="p">;</span>
				<span class="n">data</span><span class="o">-&gt;</span><span class="n">pausable</span> <span class="o">=</span> <span class="n">DCBX_IS_PFC_PRI_SOME_PAUSE</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span>
							<span class="n">data</span><span class="o">-&gt;</span><span class="n">pri_join_mask</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="n">strict_pri</span> <span class="o">=</span>
			    <span class="n">BNX2X_DCBX_STRICT_COS_NEXT_LOWER_PRI</span><span class="p">(</span><span class="n">strict_pri</span><span class="p">);</span>
			<span class="n">entry</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">num_of_app_pri</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">num_spread_of_entries</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BNX2X_ERR</span><span class="p">(</span><span class="s">&quot;Didn&#39;t succeed to spread strict priorities</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u8</span> <span class="nf">bnx2x_dcbx_cee_fill_strict_pri</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">,</span>
					 <span class="k">struct</span> <span class="n">cos_help_data</span> <span class="o">*</span><span class="n">cos_data</span><span class="p">,</span>
					 <span class="n">u8</span> <span class="n">entry</span><span class="p">,</span>
					 <span class="n">u8</span> <span class="n">num_spread_of_entries</span><span class="p">,</span>
					 <span class="n">u8</span> <span class="n">strict_app_pris</span><span class="p">)</span>
<span class="p">{</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bnx2x_dcbx_spread_strict_pri</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">cos_data</span><span class="p">,</span> <span class="n">entry</span><span class="p">,</span>
					 <span class="n">num_spread_of_entries</span><span class="p">,</span>
					 <span class="n">strict_app_pris</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">cos_entry_help_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cos_data</span><span class="o">-&gt;</span>
						    <span class="n">data</span><span class="p">[</span><span class="n">entry</span><span class="p">];</span>
		<span class="cm">/* Fill BW entry */</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">cos_bw</span> <span class="o">=</span> <span class="n">DCBX_INVALID_COS_BW</span><span class="p">;</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">strict</span> <span class="o">=</span> <span class="n">BNX2X_DCBX_STRICT_COS_HIGHEST</span><span class="p">;</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">pri_join_mask</span> <span class="o">=</span> <span class="n">strict_app_pris</span><span class="p">;</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">pausable</span> <span class="o">=</span> <span class="n">DCBX_IS_PFC_PRI_SOME_PAUSE</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span>
				 <span class="n">data</span><span class="o">-&gt;</span><span class="n">pri_join_mask</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">num_spread_of_entries</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_dcbx_cee_fill_cos_params</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">,</span>
					   <span class="k">struct</span> <span class="n">pg_help_data</span> <span class="o">*</span><span class="n">help_data</span><span class="p">,</span>
					   <span class="k">struct</span> <span class="n">dcbx_ets_feature</span> <span class="o">*</span><span class="n">ets</span><span class="p">,</span>
					   <span class="k">struct</span> <span class="n">cos_help_data</span> <span class="o">*</span><span class="n">cos_data</span><span class="p">,</span>
					   <span class="n">u32</span> <span class="n">pri_join_mask</span><span class="p">)</span>

<span class="p">{</span>
	<span class="n">u8</span> <span class="n">need_num_of_entries</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">entry</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * if the number of requested PG-s in CEE is greater than 3</span>
<span class="cm">	 * then the results are not determined since this is a violation</span>
<span class="cm">	 * of the standard.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">help_data</span><span class="o">-&gt;</span><span class="n">num_of_pg</span> <span class="o">&gt;</span> <span class="n">DCBX_COS_MAX_NUM_E3B0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bnx2x_dcbx_join_pgs</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">ets</span><span class="p">,</span> <span class="n">help_data</span><span class="p">,</span>
					<span class="n">DCBX_COS_MAX_NUM_E3B0</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">BNX2X_ERR</span><span class="p">(</span><span class="s">&quot;Unable to reduce the number of PGs - we will disables ETS</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">bnx2x_dcbx_ets_disabled_entry_data</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">cos_data</span><span class="p">,</span>
							   <span class="n">pri_join_mask</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">help_data</span><span class="o">-&gt;</span><span class="n">num_of_pg</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">pg_entry_help_data</span> <span class="o">*</span><span class="n">pg</span> <span class="o">=</span>  <span class="o">&amp;</span><span class="n">help_data</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pg</span><span class="o">-&gt;</span><span class="n">pg</span> <span class="o">&lt;</span> <span class="n">DCBX_MAX_NUM_PG_BW_ENTRIES</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">cos_entry_help_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cos_data</span><span class="o">-&gt;</span>
							    <span class="n">data</span><span class="p">[</span><span class="n">entry</span><span class="p">];</span>
			<span class="cm">/* Fill BW entry */</span>
			<span class="n">data</span><span class="o">-&gt;</span><span class="n">cos_bw</span> <span class="o">=</span> <span class="n">DCBX_PG_BW_GET</span><span class="p">(</span><span class="n">ets</span><span class="o">-&gt;</span><span class="n">pg_bw_tbl</span><span class="p">,</span> <span class="n">pg</span><span class="o">-&gt;</span><span class="n">pg</span><span class="p">);</span>
			<span class="n">data</span><span class="o">-&gt;</span><span class="n">strict</span> <span class="o">=</span> <span class="n">BNX2X_DCBX_STRICT_INVALID</span><span class="p">;</span>
			<span class="n">data</span><span class="o">-&gt;</span><span class="n">pri_join_mask</span> <span class="o">=</span> <span class="n">pg</span><span class="o">-&gt;</span><span class="n">pg_priority</span><span class="p">;</span>
			<span class="n">data</span><span class="o">-&gt;</span><span class="n">pausable</span> <span class="o">=</span> <span class="n">DCBX_IS_PFC_PRI_SOME_PAUSE</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span>
						<span class="n">data</span><span class="o">-&gt;</span><span class="n">pri_join_mask</span><span class="p">);</span>

			<span class="n">entry</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">need_num_of_entries</span> <span class="o">=</span>  <span class="n">min_t</span><span class="p">(</span><span class="n">u8</span><span class="p">,</span>
				<span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">pg</span><span class="o">-&gt;</span><span class="n">num_of_dif_pri</span><span class="p">,</span>
				<span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">DCBX_COS_MAX_NUM_E3B0</span> <span class="o">-</span>
						 <span class="n">help_data</span><span class="o">-&gt;</span><span class="n">num_of_pg</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
			<span class="cm">/*</span>
<span class="cm">			 * If there are still VOQ-s which have no associated PG,</span>
<span class="cm">			 * then associate these VOQ-s to PG15. These PG-s will</span>
<span class="cm">			 * be used for SP between priorities on PG15.</span>
<span class="cm">			 */</span>
			<span class="n">entry</span> <span class="o">+=</span> <span class="n">bnx2x_dcbx_cee_fill_strict_pri</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">cos_data</span><span class="p">,</span>
				<span class="n">entry</span><span class="p">,</span> <span class="n">need_num_of_entries</span><span class="p">,</span> <span class="n">pg</span><span class="o">-&gt;</span><span class="n">pg_priority</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* the entry will represent the number of COSes used */</span>
	<span class="n">cos_data</span><span class="o">-&gt;</span><span class="n">num_of_cos</span> <span class="o">=</span> <span class="n">entry</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_dcbx_fill_cos_params</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">pg_help_data</span> <span class="o">*</span><span class="n">help_data</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">dcbx_ets_feature</span> <span class="o">*</span><span class="n">ets</span><span class="p">,</span>
				       <span class="n">u32</span> <span class="o">*</span><span class="n">pg_pri_orginal_spread</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cos_help_data</span>         <span class="n">cos_data</span><span class="p">;</span>
	<span class="n">u8</span>                    <span class="n">i</span>                           <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span>                   <span class="n">pri_join_mask</span>               <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span>                    <span class="n">num_of_dif_pri</span>              <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cos_data</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cos_data</span><span class="p">));</span>

	<span class="cm">/* Validate the pg value */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">help_data</span><span class="o">-&gt;</span><span class="n">num_of_pg</span> <span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">DCBX_STRICT_PRIORITY</span> <span class="o">!=</span> <span class="n">help_data</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">pg</span> <span class="o">&amp;&amp;</span>
		    <span class="n">DCBX_MAX_NUM_PG_BW_ENTRIES</span> <span class="o">&lt;=</span> <span class="n">help_data</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">pg</span><span class="p">)</span>
			<span class="n">BNX2X_ERR</span><span class="p">(</span><span class="s">&quot;Invalid pg[%d] data %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span>
				  <span class="n">help_data</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">pg</span><span class="p">);</span>
		<span class="n">pri_join_mask</span>   <span class="o">|=</span>  <span class="n">help_data</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">pg_priority</span><span class="p">;</span>
		<span class="n">num_of_dif_pri</span>  <span class="o">+=</span> <span class="n">help_data</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">num_of_dif_pri</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* defaults */</span>
	<span class="n">cos_data</span><span class="p">.</span><span class="n">num_of_cos</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">cos_data</span><span class="p">.</span><span class="n">data</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cos_data</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">pri_join_mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">cos_data</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">pausable</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">cos_data</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">strict</span> <span class="o">=</span> <span class="n">BNX2X_DCBX_STRICT_INVALID</span><span class="p">;</span>
		<span class="n">cos_data</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">cos_bw</span> <span class="o">=</span> <span class="n">DCBX_INVALID_COS_BW</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">CHIP_IS_E3B0</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span>
		<span class="n">bnx2x_dcbx_cee_fill_cos_params</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">help_data</span><span class="p">,</span> <span class="n">ets</span><span class="p">,</span>
					       <span class="o">&amp;</span><span class="n">cos_data</span><span class="p">,</span> <span class="n">pri_join_mask</span><span class="p">);</span>
	<span class="k">else</span> <span class="cm">/* E2 + E3A0 */</span>
		<span class="n">bnx2x_dcbx_2cos_limit_cee_fill_cos_params</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span>
							  <span class="n">help_data</span><span class="p">,</span> <span class="n">ets</span><span class="p">,</span>
							  <span class="o">&amp;</span><span class="n">cos_data</span><span class="p">,</span>
							  <span class="n">pg_pri_orginal_spread</span><span class="p">,</span>
							  <span class="n">pri_join_mask</span><span class="p">,</span>
							  <span class="n">num_of_dif_pri</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">cos_data</span><span class="p">.</span><span class="n">num_of_cos</span> <span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">bnx2x_dcbx_cos_params</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span>
			<span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">dcbx_port_params</span><span class="p">.</span><span class="n">ets</span><span class="p">.</span><span class="n">cos_params</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="n">p</span><span class="o">-&gt;</span><span class="n">strict</span> <span class="o">=</span> <span class="n">cos_data</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">strict</span><span class="p">;</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">bw_tbl</span> <span class="o">=</span> <span class="n">cos_data</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">cos_bw</span><span class="p">;</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">pri_bitmask</span> <span class="o">=</span> <span class="n">cos_data</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">pri_join_mask</span><span class="p">;</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">pauseable</span> <span class="o">=</span> <span class="n">cos_data</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">pausable</span><span class="p">;</span>

		<span class="cm">/* sanity */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">bw_tbl</span> <span class="o">!=</span> <span class="n">DCBX_INVALID_COS_BW</span> <span class="o">||</span>
		    <span class="n">p</span><span class="o">-&gt;</span><span class="n">strict</span> <span class="o">!=</span> <span class="n">BNX2X_DCBX_STRICT_INVALID</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">pri_bitmask</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">BNX2X_ERR</span><span class="p">(</span><span class="s">&quot;Invalid pri_bitmask for %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">CHIP_IS_E2</span><span class="p">(</span><span class="n">bp</span><span class="p">)</span> <span class="o">||</span> <span class="n">CHIP_IS_E3A0</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span> <span class="p">{</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">pauseable</span> <span class="o">&amp;&amp;</span>
				    <span class="n">DCBX_PFC_PRI_GET_NON_PAUSE</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span>
						<span class="n">p</span><span class="o">-&gt;</span><span class="n">pri_bitmask</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
					<span class="n">BNX2X_ERR</span><span class="p">(</span><span class="s">&quot;Inconsistent config for pausable COS %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						  <span class="n">i</span><span class="p">);</span>

				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">pauseable</span> <span class="o">&amp;&amp;</span>
				    <span class="n">DCBX_PFC_PRI_GET_PAUSE</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span>
						<span class="n">p</span><span class="o">-&gt;</span><span class="n">pri_bitmask</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
					<span class="n">BNX2X_ERR</span><span class="p">(</span><span class="s">&quot;Inconsistent config for nonpausable COS %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						  <span class="n">i</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">pauseable</span><span class="p">)</span>
			<span class="n">DP</span><span class="p">(</span><span class="n">BNX2X_MSG_DCB</span><span class="p">,</span> <span class="s">&quot;COS %d PAUSABLE prijoinmask 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				  <span class="n">i</span><span class="p">,</span> <span class="n">cos_data</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">pri_join_mask</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">DP</span><span class="p">(</span><span class="n">BNX2X_MSG_DCB</span><span class="p">,</span>
			   <span class="s">&quot;COS %d NONPAUSABLE prijoinmask 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">i</span><span class="p">,</span> <span class="n">cos_data</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">pri_join_mask</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">bp</span><span class="o">-&gt;</span><span class="n">dcbx_port_params</span><span class="p">.</span><span class="n">ets</span><span class="p">.</span><span class="n">num_of_cos</span> <span class="o">=</span> <span class="n">cos_data</span><span class="p">.</span><span class="n">num_of_cos</span> <span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_dcbx_get_ets_pri_pg_tbl</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">,</span>
				<span class="n">u32</span> <span class="o">*</span><span class="n">set_configuration_ets_pg</span><span class="p">,</span>
				<span class="n">u32</span> <span class="o">*</span><span class="n">pri_pg_tbl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">DCBX_MAX_NUM_PRI_PG_ENTRIES</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">set_configuration_ets_pg</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">DCBX_PRI_PG_GET</span><span class="p">(</span><span class="n">pri_pg_tbl</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>

		<span class="n">DP</span><span class="p">(</span><span class="n">BNX2X_MSG_DCB</span><span class="p">,</span> <span class="s">&quot;set_configuration_ets_pg[%d] = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">i</span><span class="p">,</span> <span class="n">set_configuration_ets_pg</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_dcbx_fw_struct</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">bnx2x_func_tx_start_params</span> <span class="o">*</span><span class="n">pfc_fw_cfg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">pri_bit</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">cos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">pri</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">priority_cos</span> <span class="o">*</span><span class="n">tt2cos</span><span class="p">;</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">ttp</span> <span class="o">=</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">dcbx_port_params</span><span class="p">.</span><span class="n">app</span><span class="p">.</span><span class="n">traffic_type_priority</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">pfc_fw_cfg</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">pfc_fw_cfg</span><span class="p">));</span>

	<span class="cm">/* to disable DCB - the structure must be zeroed */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">dcbx_error</span> <span class="o">&amp;</span> <span class="n">DCBX_REMOTE_MIB_ERROR</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/*shortcut*/</span>
	<span class="n">tt2cos</span> <span class="o">=</span> <span class="n">pfc_fw_cfg</span><span class="o">-&gt;</span><span class="n">traffic_type_to_priority_cos</span><span class="p">;</span>

	<span class="cm">/* Fw version should be incremented each update */</span>
	<span class="n">pfc_fw_cfg</span><span class="o">-&gt;</span><span class="n">dcb_version</span> <span class="o">=</span> <span class="o">++</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">dcb_version</span><span class="p">;</span>
	<span class="n">pfc_fw_cfg</span><span class="o">-&gt;</span><span class="n">dcb_enabled</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* Fill priority parameters */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">pri</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">pri</span> <span class="o">&lt;</span> <span class="n">LLFC_DRIVER_TRAFFIC_TYPE_MAX</span><span class="p">;</span> <span class="n">pri</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tt2cos</span><span class="p">[</span><span class="n">pri</span><span class="p">].</span><span class="n">priority</span> <span class="o">=</span> <span class="n">ttp</span><span class="p">[</span><span class="n">pri</span><span class="p">];</span>
		<span class="n">pri_bit</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">tt2cos</span><span class="p">[</span><span class="n">pri</span><span class="p">].</span><span class="n">priority</span><span class="p">;</span>

		<span class="cm">/* Fill COS parameters based on COS calculated to</span>
<span class="cm">		 * make it more general for future use */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">cos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">cos</span> <span class="o">&lt;</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">dcbx_port_params</span><span class="p">.</span><span class="n">ets</span><span class="p">.</span><span class="n">num_of_cos</span><span class="p">;</span> <span class="n">cos</span><span class="o">++</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">dcbx_port_params</span><span class="p">.</span><span class="n">ets</span><span class="p">.</span><span class="n">cos_params</span><span class="p">[</span><span class="n">cos</span><span class="p">].</span>
						<span class="n">pri_bitmask</span> <span class="o">&amp;</span> <span class="n">pri_bit</span><span class="p">)</span>
					<span class="n">tt2cos</span><span class="p">[</span><span class="n">pri</span><span class="p">].</span><span class="n">cos</span> <span class="o">=</span> <span class="n">cos</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* we never want the FW to add a 0 vlan tag */</span>
	<span class="n">pfc_fw_cfg</span><span class="o">-&gt;</span><span class="n">dont_add_pri_0_en</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">bnx2x_dcbx_print_cos_params</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span>	<span class="n">pfc_fw_cfg</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">bnx2x_dcbx_pmf_update</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* if we need to syncronize DCBX result from prev PMF</span>
<span class="cm">	 * read it from shmem and update bp and netdev accordingly</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">SHMEM2_HAS</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">drv_flags</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	   <span class="n">GET_FLAGS</span><span class="p">(</span><span class="n">SHMEM2_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">drv_flags</span><span class="p">),</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">DRV_FLAGS_DCB_CONFIGURED</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Read neg results if dcbx is in the FW */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bnx2x_dcbx_read_shmem_neg_results</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span>
			<span class="k">return</span><span class="p">;</span>

		<span class="n">bnx2x_dump_dcbx_drv_param</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">dcbx_local_feat</span><span class="p">,</span>
					  <span class="n">bp</span><span class="o">-&gt;</span><span class="n">dcbx_error</span><span class="p">);</span>
		<span class="n">bnx2x_get_dcbx_drv_param</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">dcbx_local_feat</span><span class="p">,</span>
					 <span class="n">bp</span><span class="o">-&gt;</span><span class="n">dcbx_error</span><span class="p">);</span>
<span class="cp">#ifdef BCM_DCBNL</span>
		<span class="cm">/*</span>
<span class="cm">		 * Add new app tlvs to dcbnl</span>
<span class="cm">		 */</span>
		<span class="n">bnx2x_dcbnl_update_applist</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
		<span class="cm">/*</span>
<span class="cm">		 * Send a notification for the new negotiated parameters</span>
<span class="cm">		 */</span>
		<span class="n">dcbnl_cee_notify</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">RTM_GETDCB</span><span class="p">,</span> <span class="n">DCB_CMD_CEE_GET</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="cm">/*</span>
<span class="cm">		 * reconfigure the netdevice with the results of the new</span>
<span class="cm">		 * dcbx negotiation.</span>
<span class="cm">		 */</span>
		<span class="n">bnx2x_dcbx_update_tc_mapping</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>

	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* DCB netlink */</span>
<span class="cp">#ifdef BCM_DCBNL</span>

<span class="cp">#define BNX2X_DCBX_CAPS		(DCB_CAP_DCBX_LLD_MANAGED | \</span>
<span class="cp">				DCB_CAP_DCBX_VER_CEE | DCB_CAP_DCBX_STATIC)</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">bool</span> <span class="nf">bnx2x_dcbnl_set_valid</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* validate dcbnl call that may change HW state:</span>
<span class="cm">	 * DCB is on and DCBX mode was SUCCESSFULLY set by the user.</span>
<span class="cm">	 */</span>
	<span class="k">return</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">dcb_state</span> <span class="o">&amp;&amp;</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">dcbx_mode_uset</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u8</span> <span class="nf">bnx2x_dcbnl_get_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="n">DP</span><span class="p">(</span><span class="n">BNX2X_MSG_DCB</span><span class="p">,</span> <span class="s">&quot;state = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">dcb_state</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">dcb_state</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u8</span> <span class="nf">bnx2x_dcbnl_set_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span> <span class="n">u8</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="n">DP</span><span class="p">(</span><span class="n">BNX2X_MSG_DCB</span><span class="p">,</span> <span class="s">&quot;state = %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">state</span> <span class="o">?</span> <span class="s">&quot;on&quot;</span> <span class="o">:</span> <span class="s">&quot;off&quot;</span><span class="p">);</span>

	<span class="n">bnx2x_dcbx_set_state</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="p">(</span><span class="n">state</span> <span class="o">?</span> <span class="nb">true</span> <span class="o">:</span> <span class="nb">false</span><span class="p">),</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">dcbx_enabled</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_dcbnl_get_perm_hw_addr</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span>
					 <span class="n">u8</span> <span class="o">*</span><span class="n">perm_addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="n">DP</span><span class="p">(</span><span class="n">BNX2X_MSG_DCB</span><span class="p">,</span> <span class="s">&quot;GET-PERM-ADDR</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* first the HW mac address */</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">perm_addr</span><span class="p">,</span> <span class="n">netdev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">netdev</span><span class="o">-&gt;</span><span class="n">addr_len</span><span class="p">);</span>

<span class="cp">#ifdef BCM_CNIC</span>
	<span class="cm">/* second SAN address */</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">perm_addr</span><span class="o">+</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">addr_len</span><span class="p">,</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">fip_mac</span><span class="p">,</span> <span class="n">netdev</span><span class="o">-&gt;</span><span class="n">addr_len</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_dcbnl_set_pg_tccfg_tx</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">prio</span><span class="p">,</span>
					<span class="n">u8</span> <span class="n">prio_type</span><span class="p">,</span> <span class="n">u8</span> <span class="n">pgid</span><span class="p">,</span> <span class="n">u8</span> <span class="n">bw_pct</span><span class="p">,</span>
					<span class="n">u8</span> <span class="n">up_map</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>

	<span class="n">DP</span><span class="p">(</span><span class="n">BNX2X_MSG_DCB</span><span class="p">,</span> <span class="s">&quot;prio[%d] = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">prio</span><span class="p">,</span> <span class="n">pgid</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bnx2x_dcbnl_set_valid</span><span class="p">(</span><span class="n">bp</span><span class="p">)</span> <span class="o">||</span> <span class="n">prio</span> <span class="o">&gt;=</span> <span class="n">DCBX_MAX_NUM_PRI_PG_ENTRIES</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/**</span>
<span class="cm">	 * bw_pct ingnored -	band-width percentage devision between user</span>
<span class="cm">	 *			priorities within the same group is not</span>
<span class="cm">	 *			standard and hence not supported</span>
<span class="cm">	 *</span>
<span class="cm">	 * prio_type igonred -	priority levels within the same group are not</span>
<span class="cm">	 *			standard and hence are not supported. According</span>
<span class="cm">	 *			to the standard pgid 15 is dedicated to strict</span>
<span class="cm">	 *			prioirty traffic (on the port level).</span>
<span class="cm">	 *</span>
<span class="cm">	 * up_map ignored</span>
<span class="cm">	 */</span>

	<span class="n">bp</span><span class="o">-&gt;</span><span class="n">dcbx_config_params</span><span class="p">.</span><span class="n">admin_configuration_ets_pg</span><span class="p">[</span><span class="n">prio</span><span class="p">]</span> <span class="o">=</span> <span class="n">pgid</span><span class="p">;</span>
	<span class="n">bp</span><span class="o">-&gt;</span><span class="n">dcbx_config_params</span><span class="p">.</span><span class="n">admin_ets_configuration_tx_enable</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_dcbnl_set_pg_bwgcfg_tx</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span>
					 <span class="kt">int</span> <span class="n">pgid</span><span class="p">,</span> <span class="n">u8</span> <span class="n">bw_pct</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="n">DP</span><span class="p">(</span><span class="n">BNX2X_MSG_DCB</span><span class="p">,</span> <span class="s">&quot;pgid[%d] = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pgid</span><span class="p">,</span> <span class="n">bw_pct</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bnx2x_dcbnl_set_valid</span><span class="p">(</span><span class="n">bp</span><span class="p">)</span> <span class="o">||</span> <span class="n">pgid</span> <span class="o">&gt;=</span> <span class="n">DCBX_MAX_NUM_PG_BW_ENTRIES</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">bp</span><span class="o">-&gt;</span><span class="n">dcbx_config_params</span><span class="p">.</span><span class="n">admin_configuration_bw_precentage</span><span class="p">[</span><span class="n">pgid</span><span class="p">]</span> <span class="o">=</span> <span class="n">bw_pct</span><span class="p">;</span>
	<span class="n">bp</span><span class="o">-&gt;</span><span class="n">dcbx_config_params</span><span class="p">.</span><span class="n">admin_ets_configuration_tx_enable</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_dcbnl_set_pg_tccfg_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">prio</span><span class="p">,</span>
					<span class="n">u8</span> <span class="n">prio_type</span><span class="p">,</span> <span class="n">u8</span> <span class="n">pgid</span><span class="p">,</span> <span class="n">u8</span> <span class="n">bw_pct</span><span class="p">,</span>
					<span class="n">u8</span> <span class="n">up_map</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="n">DP</span><span class="p">(</span><span class="n">BNX2X_MSG_DCB</span><span class="p">,</span> <span class="s">&quot;Nothing to set; No RX support</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_dcbnl_set_pg_bwgcfg_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span>
					 <span class="kt">int</span> <span class="n">pgid</span><span class="p">,</span> <span class="n">u8</span> <span class="n">bw_pct</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="n">DP</span><span class="p">(</span><span class="n">BNX2X_MSG_DCB</span><span class="p">,</span> <span class="s">&quot;Nothing to set; No RX support</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_dcbnl_get_pg_tccfg_tx</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">prio</span><span class="p">,</span>
					<span class="n">u8</span> <span class="o">*</span><span class="n">prio_type</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">pgid</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">bw_pct</span><span class="p">,</span>
					<span class="n">u8</span> <span class="o">*</span><span class="n">up_map</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="n">DP</span><span class="p">(</span><span class="n">BNX2X_MSG_DCB</span><span class="p">,</span> <span class="s">&quot;prio = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">prio</span><span class="p">);</span>

	<span class="cm">/**</span>
<span class="cm">	 * bw_pct ingnored -	band-width percentage devision between user</span>
<span class="cm">	 *			priorities within the same group is not</span>
<span class="cm">	 *			standard and hence not supported</span>
<span class="cm">	 *</span>
<span class="cm">	 * prio_type igonred -	priority levels within the same group are not</span>
<span class="cm">	 *			standard and hence are not supported. According</span>
<span class="cm">	 *			to the standard pgid 15 is dedicated to strict</span>
<span class="cm">	 *			prioirty traffic (on the port level).</span>
<span class="cm">	 *</span>
<span class="cm">	 * up_map ignored</span>
<span class="cm">	 */</span>
	<span class="o">*</span><span class="n">up_map</span> <span class="o">=</span> <span class="o">*</span><span class="n">bw_pct</span> <span class="o">=</span> <span class="o">*</span><span class="n">prio_type</span> <span class="o">=</span> <span class="o">*</span><span class="n">pgid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">dcb_state</span> <span class="o">||</span> <span class="n">prio</span> <span class="o">&gt;=</span> <span class="n">DCBX_MAX_NUM_PRI_PG_ENTRIES</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="o">*</span><span class="n">pgid</span> <span class="o">=</span> <span class="n">DCBX_PRI_PG_GET</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">dcbx_local_feat</span><span class="p">.</span><span class="n">ets</span><span class="p">.</span><span class="n">pri_pg_tbl</span><span class="p">,</span> <span class="n">prio</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_dcbnl_get_pg_bwgcfg_tx</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span>
					 <span class="kt">int</span> <span class="n">pgid</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">bw_pct</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="n">DP</span><span class="p">(</span><span class="n">BNX2X_MSG_DCB</span><span class="p">,</span> <span class="s">&quot;pgid = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pgid</span><span class="p">);</span>

	<span class="o">*</span><span class="n">bw_pct</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">dcb_state</span> <span class="o">||</span> <span class="n">pgid</span> <span class="o">&gt;=</span> <span class="n">DCBX_MAX_NUM_PG_BW_ENTRIES</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="o">*</span><span class="n">bw_pct</span> <span class="o">=</span> <span class="n">DCBX_PG_BW_GET</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">dcbx_local_feat</span><span class="p">.</span><span class="n">ets</span><span class="p">.</span><span class="n">pg_bw_tbl</span><span class="p">,</span> <span class="n">pgid</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_dcbnl_get_pg_tccfg_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">prio</span><span class="p">,</span>
					<span class="n">u8</span> <span class="o">*</span><span class="n">prio_type</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">pgid</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">bw_pct</span><span class="p">,</span>
					<span class="n">u8</span> <span class="o">*</span><span class="n">up_map</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="n">DP</span><span class="p">(</span><span class="n">BNX2X_MSG_DCB</span><span class="p">,</span> <span class="s">&quot;Nothing to get; No RX support</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="o">*</span><span class="n">prio_type</span> <span class="o">=</span> <span class="o">*</span><span class="n">pgid</span> <span class="o">=</span> <span class="o">*</span><span class="n">bw_pct</span> <span class="o">=</span> <span class="o">*</span><span class="n">up_map</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_dcbnl_get_pg_bwgcfg_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span>
					 <span class="kt">int</span> <span class="n">pgid</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">bw_pct</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="n">DP</span><span class="p">(</span><span class="n">BNX2X_MSG_DCB</span><span class="p">,</span> <span class="s">&quot;Nothing to get; No RX support</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="o">*</span><span class="n">bw_pct</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_dcbnl_set_pfc_cfg</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">prio</span><span class="p">,</span>
				    <span class="n">u8</span> <span class="n">setting</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="n">DP</span><span class="p">(</span><span class="n">BNX2X_MSG_DCB</span><span class="p">,</span> <span class="s">&quot;prio[%d] = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">prio</span><span class="p">,</span> <span class="n">setting</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bnx2x_dcbnl_set_valid</span><span class="p">(</span><span class="n">bp</span><span class="p">)</span> <span class="o">||</span> <span class="n">prio</span> <span class="o">&gt;=</span> <span class="n">MAX_PFC_PRIORITIES</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">bp</span><span class="o">-&gt;</span><span class="n">dcbx_config_params</span><span class="p">.</span><span class="n">admin_pfc_bitmap</span> <span class="o">|=</span> <span class="p">((</span><span class="n">setting</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">prio</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">setting</span><span class="p">)</span>
		<span class="n">bp</span><span class="o">-&gt;</span><span class="n">dcbx_config_params</span><span class="p">.</span><span class="n">admin_pfc_tx_enable</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_dcbnl_get_pfc_cfg</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">prio</span><span class="p">,</span>
				    <span class="n">u8</span> <span class="o">*</span><span class="n">setting</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="n">DP</span><span class="p">(</span><span class="n">BNX2X_MSG_DCB</span><span class="p">,</span> <span class="s">&quot;prio = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">prio</span><span class="p">);</span>

	<span class="o">*</span><span class="n">setting</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">dcb_state</span> <span class="o">||</span> <span class="n">prio</span> <span class="o">&gt;=</span> <span class="n">MAX_PFC_PRIORITIES</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="o">*</span><span class="n">setting</span> <span class="o">=</span> <span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">dcbx_local_feat</span><span class="p">.</span><span class="n">pfc</span><span class="p">.</span><span class="n">pri_en_bitmap</span> <span class="o">&gt;&gt;</span> <span class="n">prio</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u8</span> <span class="nf">bnx2x_dcbnl_set_all</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">DP</span><span class="p">(</span><span class="n">BNX2X_MSG_DCB</span><span class="p">,</span> <span class="s">&quot;SET-ALL</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bnx2x_dcbnl_set_valid</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">recovery_state</span> <span class="o">!=</span> <span class="n">BNX2X_RECOVERY_DONE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netdev_err</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			   <span class="s">&quot;Handling parity error recovery. Try again later</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">netif_running</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">bnx2x_nic_unload</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">UNLOAD_NORMAL</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">bnx2x_nic_load</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">LOAD_NORMAL</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">DP</span><span class="p">(</span><span class="n">BNX2X_MSG_DCB</span><span class="p">,</span> <span class="s">&quot;set_dcbx_params done (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u8</span> <span class="nf">bnx2x_dcbnl_get_cap</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">capid</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">cap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">rval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">dcb_state</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">capid</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">DCB_CAP_ATTR_PG</span>:
			<span class="o">*</span><span class="n">cap</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">DCB_CAP_ATTR_PFC</span>:
			<span class="o">*</span><span class="n">cap</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">DCB_CAP_ATTR_UP2TC</span>:
			<span class="o">*</span><span class="n">cap</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">DCB_CAP_ATTR_PG_TCS</span>:
			<span class="o">*</span><span class="n">cap</span> <span class="o">=</span> <span class="mh">0x80</span><span class="p">;</span>	<span class="cm">/* 8 priorities for PGs */</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">DCB_CAP_ATTR_PFC_TCS</span>:
			<span class="o">*</span><span class="n">cap</span> <span class="o">=</span> <span class="mh">0x80</span><span class="p">;</span>	<span class="cm">/* 8 priorities for PFC */</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">DCB_CAP_ATTR_GSP</span>:
			<span class="o">*</span><span class="n">cap</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">DCB_CAP_ATTR_BCN</span>:
			<span class="o">*</span><span class="n">cap</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">DCB_CAP_ATTR_DCBX</span>:
			<span class="o">*</span><span class="n">cap</span> <span class="o">=</span> <span class="n">BNX2X_DCBX_CAPS</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">BNX2X_ERR</span><span class="p">(</span><span class="s">&quot;Non valid capability ID</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">rval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">DP</span><span class="p">(</span><span class="n">BNX2X_MSG_DCB</span><span class="p">,</span> <span class="s">&quot;DCB disabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">rval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">DP</span><span class="p">(</span><span class="n">BNX2X_MSG_DCB</span><span class="p">,</span> <span class="s">&quot;capid %d:%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">capid</span><span class="p">,</span> <span class="o">*</span><span class="n">cap</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bnx2x_dcbnl_get_numtcs</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">tcid</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">num</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">rval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">DP</span><span class="p">(</span><span class="n">BNX2X_MSG_DCB</span><span class="p">,</span> <span class="s">&quot;tcid %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tcid</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">dcb_state</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">tcid</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">DCB_NUMTCS_ATTR_PG</span>:
			<span class="o">*</span><span class="n">num</span> <span class="o">=</span> <span class="n">CHIP_IS_E3B0</span><span class="p">(</span><span class="n">bp</span><span class="p">)</span> <span class="o">?</span> <span class="n">DCBX_COS_MAX_NUM_E3B0</span> <span class="o">:</span>
						  <span class="n">DCBX_COS_MAX_NUM_E2</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">DCB_NUMTCS_ATTR_PFC</span>:
			<span class="o">*</span><span class="n">num</span> <span class="o">=</span> <span class="n">CHIP_IS_E3B0</span><span class="p">(</span><span class="n">bp</span><span class="p">)</span> <span class="o">?</span> <span class="n">DCBX_COS_MAX_NUM_E3B0</span> <span class="o">:</span>
						  <span class="n">DCBX_COS_MAX_NUM_E2</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">BNX2X_ERR</span><span class="p">(</span><span class="s">&quot;Non valid TC-ID</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">rval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">DP</span><span class="p">(</span><span class="n">BNX2X_MSG_DCB</span><span class="p">,</span> <span class="s">&quot;DCB disabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">rval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bnx2x_dcbnl_set_numtcs</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">tcid</span><span class="p">,</span> <span class="n">u8</span> <span class="n">num</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="n">DP</span><span class="p">(</span><span class="n">BNX2X_MSG_DCB</span><span class="p">,</span> <span class="s">&quot;num tcs = %d; Not supported</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">num</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u8</span>  <span class="nf">bnx2x_dcbnl_get_pfc_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="n">DP</span><span class="p">(</span><span class="n">BNX2X_MSG_DCB</span><span class="p">,</span> <span class="s">&quot;state = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">dcbx_local_feat</span><span class="p">.</span><span class="n">pfc</span><span class="p">.</span><span class="n">enabled</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">dcb_state</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">dcbx_local_feat</span><span class="p">.</span><span class="n">pfc</span><span class="p">.</span><span class="n">enabled</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_dcbnl_set_pfc_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span> <span class="n">u8</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="n">DP</span><span class="p">(</span><span class="n">BNX2X_MSG_DCB</span><span class="p">,</span> <span class="s">&quot;state = %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">state</span> <span class="o">?</span> <span class="s">&quot;on&quot;</span> <span class="o">:</span> <span class="s">&quot;off&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bnx2x_dcbnl_set_valid</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">bp</span><span class="o">-&gt;</span><span class="n">dcbx_config_params</span><span class="p">.</span><span class="n">admin_pfc_tx_enable</span> <span class="o">=</span>
	<span class="n">bp</span><span class="o">-&gt;</span><span class="n">dcbx_config_params</span><span class="p">.</span><span class="n">admin_pfc_enable</span> <span class="o">=</span> <span class="p">(</span><span class="n">state</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_admin_app_set_ent</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">bnx2x_admin_priority_app_table</span> <span class="o">*</span><span class="n">app_ent</span><span class="p">,</span>
	<span class="n">u8</span> <span class="n">idtype</span><span class="p">,</span> <span class="n">u16</span> <span class="n">idval</span><span class="p">,</span> <span class="n">u8</span> <span class="n">up</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">app_ent</span><span class="o">-&gt;</span><span class="n">valid</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">idtype</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">DCB_APP_IDTYPE_ETHTYPE</span>:
		<span class="n">app_ent</span><span class="o">-&gt;</span><span class="n">traffic_type</span> <span class="o">=</span> <span class="n">TRAFFIC_TYPE_ETH</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DCB_APP_IDTYPE_PORTNUM</span>:
		<span class="n">app_ent</span><span class="o">-&gt;</span><span class="n">traffic_type</span> <span class="o">=</span> <span class="n">TRAFFIC_TYPE_PORT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span> <span class="cm">/* never gets here */</span>
	<span class="p">}</span>
	<span class="n">app_ent</span><span class="o">-&gt;</span><span class="n">app_id</span> <span class="o">=</span> <span class="n">idval</span><span class="p">;</span>
	<span class="n">app_ent</span><span class="o">-&gt;</span><span class="n">priority</span> <span class="o">=</span> <span class="n">up</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">bnx2x_admin_app_is_equal</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">bnx2x_admin_priority_app_table</span> <span class="o">*</span><span class="n">app_ent</span><span class="p">,</span>
	<span class="n">u8</span> <span class="n">idtype</span><span class="p">,</span> <span class="n">u16</span> <span class="n">idval</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">app_ent</span><span class="o">-&gt;</span><span class="n">valid</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">idtype</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">DCB_APP_IDTYPE_ETHTYPE</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">app_ent</span><span class="o">-&gt;</span><span class="n">traffic_type</span> <span class="o">!=</span> <span class="n">TRAFFIC_TYPE_ETH</span><span class="p">)</span>
			<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DCB_APP_IDTYPE_PORTNUM</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">app_ent</span><span class="o">-&gt;</span><span class="n">traffic_type</span> <span class="o">!=</span> <span class="n">TRAFFIC_TYPE_PORT</span><span class="p">)</span>
			<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">app_ent</span><span class="o">-&gt;</span><span class="n">app_id</span> <span class="o">!=</span> <span class="n">idval</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bnx2x_set_admin_app_up</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">,</span> <span class="n">u8</span> <span class="n">idtype</span><span class="p">,</span> <span class="n">u16</span> <span class="n">idval</span><span class="p">,</span> <span class="n">u8</span> <span class="n">up</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">ff</span><span class="p">;</span>

	<span class="cm">/* iterate over the app entries looking for idtype and idval */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ff</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">DCBX_CONFIG_MAX_APP_PROTOCOL</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">bnx2x_admin_priority_app_table</span> <span class="o">*</span><span class="n">app_ent</span> <span class="o">=</span>
			<span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">dcbx_config_params</span><span class="p">.</span><span class="n">admin_priority_app_table</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bnx2x_admin_app_is_equal</span><span class="p">(</span><span class="n">app_ent</span><span class="p">,</span> <span class="n">idtype</span><span class="p">,</span> <span class="n">idval</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ff</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">app_ent</span><span class="o">-&gt;</span><span class="n">valid</span><span class="p">)</span>
			<span class="n">ff</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">DCBX_CONFIG_MAX_APP_PROTOCOL</span><span class="p">)</span>
		<span class="cm">/* if found overwrite up */</span>
		<span class="n">bp</span><span class="o">-&gt;</span><span class="n">dcbx_config_params</span><span class="p">.</span>
			<span class="n">admin_priority_app_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">priority</span> <span class="o">=</span> <span class="n">up</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ff</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="cm">/* not found use first-free */</span>
		<span class="n">bnx2x_admin_app_set_ent</span><span class="p">(</span>
			<span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">dcbx_config_params</span><span class="p">.</span><span class="n">admin_priority_app_table</span><span class="p">[</span><span class="n">ff</span><span class="p">],</span>
			<span class="n">idtype</span><span class="p">,</span> <span class="n">idval</span><span class="p">,</span> <span class="n">up</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* app table is full */</span>
		<span class="n">BNX2X_ERR</span><span class="p">(</span><span class="s">&quot;Application table is too large</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* up configured, if not 0 make sure feature is enabled */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">up</span><span class="p">)</span>
		<span class="n">bp</span><span class="o">-&gt;</span><span class="n">dcbx_config_params</span><span class="p">.</span><span class="n">admin_application_priority_tx_enable</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u8</span> <span class="nf">bnx2x_dcbnl_set_app_up</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span> <span class="n">u8</span> <span class="n">idtype</span><span class="p">,</span>
				 <span class="n">u16</span> <span class="n">idval</span><span class="p">,</span> <span class="n">u8</span> <span class="n">up</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>

	<span class="n">DP</span><span class="p">(</span><span class="n">BNX2X_MSG_DCB</span><span class="p">,</span> <span class="s">&quot;app_type %d, app_id %x, prio bitmap %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	   <span class="n">idtype</span><span class="p">,</span> <span class="n">idval</span><span class="p">,</span> <span class="n">up</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bnx2x_dcbnl_set_valid</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DP</span><span class="p">(</span><span class="n">BNX2X_MSG_DCB</span><span class="p">,</span> <span class="s">&quot;dcbnl call not valid</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* verify idtype */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">idtype</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">DCB_APP_IDTYPE_ETHTYPE</span>:
	<span class="k">case</span> <span class="n">DCB_APP_IDTYPE_PORTNUM</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">DP</span><span class="p">(</span><span class="n">BNX2X_MSG_DCB</span><span class="p">,</span> <span class="s">&quot;Wrong ID type</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">bnx2x_set_admin_app_up</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">idtype</span><span class="p">,</span> <span class="n">idval</span><span class="p">,</span> <span class="n">up</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u8</span> <span class="nf">bnx2x_dcbnl_get_dcbx</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">state</span><span class="p">;</span>

	<span class="n">state</span> <span class="o">=</span> <span class="n">DCB_CAP_DCBX_LLD_MANAGED</span> <span class="o">|</span> <span class="n">DCB_CAP_DCBX_VER_CEE</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">dcbx_enabled</span> <span class="o">==</span> <span class="n">BNX2X_DCBX_ENABLED_ON_NEG_OFF</span><span class="p">)</span>
		<span class="n">state</span> <span class="o">|=</span> <span class="n">DCB_CAP_DCBX_STATIC</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">state</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u8</span> <span class="nf">bnx2x_dcbnl_set_dcbx</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span> <span class="n">u8</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="n">DP</span><span class="p">(</span><span class="n">BNX2X_MSG_DCB</span><span class="p">,</span> <span class="s">&quot;state = %02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">state</span><span class="p">);</span>

	<span class="cm">/* set dcbx mode */</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">state</span> <span class="o">&amp;</span> <span class="n">BNX2X_DCBX_CAPS</span><span class="p">)</span> <span class="o">!=</span> <span class="n">state</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BNX2X_ERR</span><span class="p">(</span><span class="s">&quot;Requested DCBX mode %x is beyond advertised capabilities</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">state</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">dcb_state</span> <span class="o">!=</span> <span class="n">BNX2X_DCB_STATE_ON</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BNX2X_ERR</span><span class="p">(</span><span class="s">&quot;DCB turned off, DCBX configuration is invalid</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">state</span> <span class="o">&amp;</span> <span class="n">DCB_CAP_DCBX_STATIC</span><span class="p">)</span>
		<span class="n">bp</span><span class="o">-&gt;</span><span class="n">dcbx_enabled</span> <span class="o">=</span> <span class="n">BNX2X_DCBX_ENABLED_ON_NEG_OFF</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">bp</span><span class="o">-&gt;</span><span class="n">dcbx_enabled</span> <span class="o">=</span> <span class="n">BNX2X_DCBX_ENABLED_ON_NEG_ON</span><span class="p">;</span>

	<span class="n">bp</span><span class="o">-&gt;</span><span class="n">dcbx_mode_uset</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u8</span> <span class="nf">bnx2x_dcbnl_get_featcfg</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">featid</span><span class="p">,</span>
				  <span class="n">u8</span> <span class="o">*</span><span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">rval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">DP</span><span class="p">(</span><span class="n">BNX2X_MSG_DCB</span><span class="p">,</span> <span class="s">&quot;featid %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">featid</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">dcb_state</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">featid</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">DCB_FEATCFG_ATTR_PG</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">dcbx_local_feat</span><span class="p">.</span><span class="n">ets</span><span class="p">.</span><span class="n">enabled</span><span class="p">)</span>
				<span class="o">*</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">DCB_FEATCFG_ENABLE</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">dcbx_error</span> <span class="o">&amp;</span> <span class="n">DCBX_LOCAL_ETS_ERROR</span><span class="p">)</span>
				<span class="o">*</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">DCB_FEATCFG_ERROR</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">DCB_FEATCFG_ATTR_PFC</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">dcbx_local_feat</span><span class="p">.</span><span class="n">pfc</span><span class="p">.</span><span class="n">enabled</span><span class="p">)</span>
				<span class="o">*</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">DCB_FEATCFG_ENABLE</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">dcbx_error</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">DCBX_LOCAL_PFC_ERROR</span> <span class="o">|</span>
			    <span class="n">DCBX_LOCAL_PFC_MISMATCH</span><span class="p">))</span>
				<span class="o">*</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">DCB_FEATCFG_ERROR</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">DCB_FEATCFG_ATTR_APP</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">dcbx_local_feat</span><span class="p">.</span><span class="n">app</span><span class="p">.</span><span class="n">enabled</span><span class="p">)</span>
				<span class="o">*</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">DCB_FEATCFG_ENABLE</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">dcbx_error</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">DCBX_LOCAL_APP_ERROR</span> <span class="o">|</span>
			    <span class="n">DCBX_LOCAL_APP_MISMATCH</span><span class="p">))</span>
				<span class="o">*</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">DCB_FEATCFG_ERROR</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">BNX2X_ERR</span><span class="p">(</span><span class="s">&quot;Non valid featrue-ID</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">rval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">DP</span><span class="p">(</span><span class="n">BNX2X_MSG_DCB</span><span class="p">,</span> <span class="s">&quot;DCB disabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">rval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u8</span> <span class="nf">bnx2x_dcbnl_set_featcfg</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">featid</span><span class="p">,</span>
				  <span class="n">u8</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">rval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">DP</span><span class="p">(</span><span class="n">BNX2X_MSG_DCB</span><span class="p">,</span> <span class="s">&quot;featid = %d flags = %02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">featid</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* ignore the &#39;advertise&#39; flag */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bnx2x_dcbnl_set_valid</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">featid</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">DCB_FEATCFG_ATTR_PG</span>:
			<span class="n">bp</span><span class="o">-&gt;</span><span class="n">dcbx_config_params</span><span class="p">.</span><span class="n">admin_ets_enable</span> <span class="o">=</span>
				<span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DCB_FEATCFG_ENABLE</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">bp</span><span class="o">-&gt;</span><span class="n">dcbx_config_params</span><span class="p">.</span><span class="n">admin_ets_willing</span> <span class="o">=</span>
				<span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DCB_FEATCFG_WILLING</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">DCB_FEATCFG_ATTR_PFC</span>:
			<span class="n">bp</span><span class="o">-&gt;</span><span class="n">dcbx_config_params</span><span class="p">.</span><span class="n">admin_pfc_enable</span> <span class="o">=</span>
				<span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DCB_FEATCFG_ENABLE</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">bp</span><span class="o">-&gt;</span><span class="n">dcbx_config_params</span><span class="p">.</span><span class="n">admin_pfc_willing</span> <span class="o">=</span>
				<span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DCB_FEATCFG_WILLING</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">DCB_FEATCFG_ATTR_APP</span>:
			<span class="cm">/* ignore enable, always enabled */</span>
			<span class="n">bp</span><span class="o">-&gt;</span><span class="n">dcbx_config_params</span><span class="p">.</span><span class="n">admin_app_priority_willing</span> <span class="o">=</span>
				<span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DCB_FEATCFG_WILLING</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">BNX2X_ERR</span><span class="p">(</span><span class="s">&quot;Non valid featrue-ID</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">rval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">DP</span><span class="p">(</span><span class="n">BNX2X_MSG_DCB</span><span class="p">,</span> <span class="s">&quot;dcbnl call not valid</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">rval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bnx2x_peer_appinfo</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">dcb_peer_app_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="n">u16</span><span class="o">*</span> <span class="n">app_count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>

	<span class="n">DP</span><span class="p">(</span><span class="n">BNX2X_MSG_DCB</span><span class="p">,</span> <span class="s">&quot;APP-INFO</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">willing</span> <span class="o">=</span> <span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">dcbx_remote_flags</span> <span class="o">&amp;</span> <span class="n">DCBX_APP_REM_WILLING</span><span class="p">)</span> <span class="o">?:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">dcbx_remote_flags</span> <span class="o">&amp;</span> <span class="n">DCBX_APP_RX_ERROR</span><span class="p">)</span> <span class="o">?:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="o">*</span><span class="n">app_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">DCBX_MAX_APP_PROTOCOL</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">dcbx_remote_feat</span><span class="p">.</span><span class="n">app</span><span class="p">.</span><span class="n">app_pri_tbl</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">appBitfield</span> <span class="o">&amp;</span>
		    <span class="n">DCBX_APP_ENTRY_VALID</span><span class="p">)</span>
			<span class="p">(</span><span class="o">*</span><span class="n">app_count</span><span class="p">)</span><span class="o">++</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bnx2x_peer_apptable</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">dcb_app</span> <span class="o">*</span><span class="n">table</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>

	<span class="n">DP</span><span class="p">(</span><span class="n">BNX2X_MSG_DCB</span><span class="p">,</span> <span class="s">&quot;APP-TABLE</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">DCBX_MAX_APP_PROTOCOL</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">dcbx_app_priority_entry</span> <span class="o">*</span><span class="n">ent</span> <span class="o">=</span>
			<span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">dcbx_remote_feat</span><span class="p">.</span><span class="n">app</span><span class="p">.</span><span class="n">app_pri_tbl</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ent</span><span class="o">-&gt;</span><span class="n">appBitfield</span> <span class="o">&amp;</span> <span class="n">DCBX_APP_ENTRY_VALID</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">table</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">selector</span> <span class="o">=</span> <span class="n">bnx2x_dcbx_dcbnl_app_idtype</span><span class="p">(</span><span class="n">ent</span><span class="p">);</span>
			<span class="n">table</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">priority</span> <span class="o">=</span> <span class="n">bnx2x_dcbx_dcbnl_app_up</span><span class="p">(</span><span class="n">ent</span><span class="p">);</span>
			<span class="n">table</span><span class="p">[</span><span class="n">j</span><span class="o">++</span><span class="p">].</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">ent</span><span class="o">-&gt;</span><span class="n">app_id</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bnx2x_cee_peer_getpg</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cee_pg</span> <span class="o">*</span><span class="n">pg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>

	<span class="n">pg</span><span class="o">-&gt;</span><span class="n">willing</span> <span class="o">=</span> <span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">dcbx_remote_flags</span> <span class="o">&amp;</span> <span class="n">DCBX_ETS_REM_WILLING</span><span class="p">)</span> <span class="o">?:</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">CEE_DCBX_MAX_PGS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pg</span><span class="o">-&gt;</span><span class="n">pg_bw</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span>
			<span class="n">DCBX_PG_BW_GET</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">dcbx_remote_feat</span><span class="p">.</span><span class="n">ets</span><span class="p">.</span><span class="n">pg_bw_tbl</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="n">pg</span><span class="o">-&gt;</span><span class="n">prio_pg</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span>
			<span class="n">DCBX_PRI_PG_GET</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">dcbx_remote_feat</span><span class="p">.</span><span class="n">ets</span><span class="p">.</span><span class="n">pri_pg_tbl</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bnx2x_cee_peer_getpfc</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">cee_pfc</span> <span class="o">*</span><span class="n">pfc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="n">pfc</span><span class="o">-&gt;</span><span class="n">tcs_supported</span> <span class="o">=</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">dcbx_remote_feat</span><span class="p">.</span><span class="n">pfc</span><span class="p">.</span><span class="n">pfc_caps</span><span class="p">;</span>
	<span class="n">pfc</span><span class="o">-&gt;</span><span class="n">pfc_en</span> <span class="o">=</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">dcbx_remote_feat</span><span class="p">.</span><span class="n">pfc</span><span class="p">.</span><span class="n">pri_en_bitmap</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">const</span> <span class="k">struct</span> <span class="n">dcbnl_rtnl_ops</span> <span class="n">bnx2x_dcbnl_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">getstate</span>		<span class="o">=</span> <span class="n">bnx2x_dcbnl_get_state</span><span class="p">,</span>
	<span class="p">.</span><span class="n">setstate</span>		<span class="o">=</span> <span class="n">bnx2x_dcbnl_set_state</span><span class="p">,</span>
	<span class="p">.</span><span class="n">getpermhwaddr</span>		<span class="o">=</span> <span class="n">bnx2x_dcbnl_get_perm_hw_addr</span><span class="p">,</span>
	<span class="p">.</span><span class="n">setpgtccfgtx</span>		<span class="o">=</span> <span class="n">bnx2x_dcbnl_set_pg_tccfg_tx</span><span class="p">,</span>
	<span class="p">.</span><span class="n">setpgbwgcfgtx</span>		<span class="o">=</span> <span class="n">bnx2x_dcbnl_set_pg_bwgcfg_tx</span><span class="p">,</span>
	<span class="p">.</span><span class="n">setpgtccfgrx</span>		<span class="o">=</span> <span class="n">bnx2x_dcbnl_set_pg_tccfg_rx</span><span class="p">,</span>
	<span class="p">.</span><span class="n">setpgbwgcfgrx</span>		<span class="o">=</span> <span class="n">bnx2x_dcbnl_set_pg_bwgcfg_rx</span><span class="p">,</span>
	<span class="p">.</span><span class="n">getpgtccfgtx</span>		<span class="o">=</span> <span class="n">bnx2x_dcbnl_get_pg_tccfg_tx</span><span class="p">,</span>
	<span class="p">.</span><span class="n">getpgbwgcfgtx</span>		<span class="o">=</span> <span class="n">bnx2x_dcbnl_get_pg_bwgcfg_tx</span><span class="p">,</span>
	<span class="p">.</span><span class="n">getpgtccfgrx</span>		<span class="o">=</span> <span class="n">bnx2x_dcbnl_get_pg_tccfg_rx</span><span class="p">,</span>
	<span class="p">.</span><span class="n">getpgbwgcfgrx</span>		<span class="o">=</span> <span class="n">bnx2x_dcbnl_get_pg_bwgcfg_rx</span><span class="p">,</span>
	<span class="p">.</span><span class="n">setpfccfg</span>		<span class="o">=</span> <span class="n">bnx2x_dcbnl_set_pfc_cfg</span><span class="p">,</span>
	<span class="p">.</span><span class="n">getpfccfg</span>		<span class="o">=</span> <span class="n">bnx2x_dcbnl_get_pfc_cfg</span><span class="p">,</span>
	<span class="p">.</span><span class="n">setall</span>			<span class="o">=</span> <span class="n">bnx2x_dcbnl_set_all</span><span class="p">,</span>
	<span class="p">.</span><span class="n">getcap</span>			<span class="o">=</span> <span class="n">bnx2x_dcbnl_get_cap</span><span class="p">,</span>
	<span class="p">.</span><span class="n">getnumtcs</span>		<span class="o">=</span> <span class="n">bnx2x_dcbnl_get_numtcs</span><span class="p">,</span>
	<span class="p">.</span><span class="n">setnumtcs</span>		<span class="o">=</span> <span class="n">bnx2x_dcbnl_set_numtcs</span><span class="p">,</span>
	<span class="p">.</span><span class="n">getpfcstate</span>		<span class="o">=</span> <span class="n">bnx2x_dcbnl_get_pfc_state</span><span class="p">,</span>
	<span class="p">.</span><span class="n">setpfcstate</span>		<span class="o">=</span> <span class="n">bnx2x_dcbnl_set_pfc_state</span><span class="p">,</span>
	<span class="p">.</span><span class="n">setapp</span>			<span class="o">=</span> <span class="n">bnx2x_dcbnl_set_app_up</span><span class="p">,</span>
	<span class="p">.</span><span class="n">getdcbx</span>		<span class="o">=</span> <span class="n">bnx2x_dcbnl_get_dcbx</span><span class="p">,</span>
	<span class="p">.</span><span class="n">setdcbx</span>		<span class="o">=</span> <span class="n">bnx2x_dcbnl_set_dcbx</span><span class="p">,</span>
	<span class="p">.</span><span class="n">getfeatcfg</span>		<span class="o">=</span> <span class="n">bnx2x_dcbnl_get_featcfg</span><span class="p">,</span>
	<span class="p">.</span><span class="n">setfeatcfg</span>		<span class="o">=</span> <span class="n">bnx2x_dcbnl_set_featcfg</span><span class="p">,</span>
	<span class="p">.</span><span class="n">peer_getappinfo</span>	<span class="o">=</span> <span class="n">bnx2x_peer_appinfo</span><span class="p">,</span>
	<span class="p">.</span><span class="n">peer_getapptable</span>	<span class="o">=</span> <span class="n">bnx2x_peer_apptable</span><span class="p">,</span>
	<span class="p">.</span><span class="n">cee_peer_getpg</span>		<span class="o">=</span> <span class="n">bnx2x_cee_peer_getpg</span><span class="p">,</span>
	<span class="p">.</span><span class="n">cee_peer_getpfc</span>	<span class="o">=</span> <span class="n">bnx2x_cee_peer_getpfc</span><span class="p">,</span>
<span class="p">};</span>

<span class="cp">#endif </span><span class="cm">/* BCM_DCBNL */</span><span class="cp"></span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:5}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../../javascript/docco.min.js"></script>
</html>
