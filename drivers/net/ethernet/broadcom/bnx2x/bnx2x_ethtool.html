<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › ethernet › broadcom › bnx2x › bnx2x_ethtool.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../../index.html"></a><h1>bnx2x_ethtool.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/* bnx2x_ethtool.c: Broadcom Everest network driver.</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (c) 2007-2012 Broadcom Corporation</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License as published by</span>
<span class="cm"> * the Free Software Foundation.</span>
<span class="cm"> *</span>
<span class="cm"> * Maintained by: Eilon Greenstein &lt;eilong@broadcom.com&gt;</span>
<span class="cm"> * Written by: Eliezer Tamir</span>
<span class="cm"> * Based on code from Michael Chan&#39;s bnx2 driver</span>
<span class="cm"> * UDP CSUM errata workaround by Arik Gendelman</span>
<span class="cm"> * Slowpath and fastpath rework by Vladislav Zolotarov</span>
<span class="cm"> * Statistics and Link management by Yitchak Gertner</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#define pr_fmt(fmt) KBUILD_MODNAME &quot;: &quot; fmt</span>

<span class="cp">#include &lt;linux/ethtool.h&gt;</span>
<span class="cp">#include &lt;linux/netdevice.h&gt;</span>
<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/crc32.h&gt;</span>
<span class="cp">#include &quot;bnx2x.h&quot;</span>
<span class="cp">#include &quot;bnx2x_cmn.h&quot;</span>
<span class="cp">#include &quot;bnx2x_dump.h&quot;</span>
<span class="cp">#include &quot;bnx2x_init.h&quot;</span>

<span class="cm">/* Note: in the format strings below %s is replaced by the queue-name which is</span>
<span class="cm"> * either its index or &#39;fcoe&#39; for the fcoe queue. Make sure the format string</span>
<span class="cm"> * length does not exceed ETH_GSTRING_LEN - MAX_QUEUE_NAME_LEN + 2</span>
<span class="cm"> */</span>
<span class="cp">#define MAX_QUEUE_NAME_LEN	4</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="p">{</span>
	<span class="kt">long</span> <span class="n">offset</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">size</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">string</span><span class="p">[</span><span class="n">ETH_GSTRING_LEN</span><span class="p">];</span>
<span class="p">}</span> <span class="n">bnx2x_q_stats_arr</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
<span class="cm">/* 1 */</span>	<span class="p">{</span> <span class="n">Q_STATS_OFFSET32</span><span class="p">(</span><span class="n">total_bytes_received_hi</span><span class="p">),</span> <span class="mi">8</span><span class="p">,</span> <span class="s">&quot;[%s]: rx_bytes&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">Q_STATS_OFFSET32</span><span class="p">(</span><span class="n">total_unicast_packets_received_hi</span><span class="p">),</span>
						<span class="mi">8</span><span class="p">,</span> <span class="s">&quot;[%s]: rx_ucast_packets&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">Q_STATS_OFFSET32</span><span class="p">(</span><span class="n">total_multicast_packets_received_hi</span><span class="p">),</span>
						<span class="mi">8</span><span class="p">,</span> <span class="s">&quot;[%s]: rx_mcast_packets&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">Q_STATS_OFFSET32</span><span class="p">(</span><span class="n">total_broadcast_packets_received_hi</span><span class="p">),</span>
						<span class="mi">8</span><span class="p">,</span> <span class="s">&quot;[%s]: rx_bcast_packets&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">Q_STATS_OFFSET32</span><span class="p">(</span><span class="n">no_buff_discard_hi</span><span class="p">),</span>	<span class="mi">8</span><span class="p">,</span> <span class="s">&quot;[%s]: rx_discards&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">Q_STATS_OFFSET32</span><span class="p">(</span><span class="n">rx_err_discard_pkt</span><span class="p">),</span>
					 <span class="mi">4</span><span class="p">,</span> <span class="s">&quot;[%s]: rx_phy_ip_err_discards&quot;</span><span class="p">},</span>
	<span class="p">{</span> <span class="n">Q_STATS_OFFSET32</span><span class="p">(</span><span class="n">rx_skb_alloc_failed</span><span class="p">),</span>
					 <span class="mi">4</span><span class="p">,</span> <span class="s">&quot;[%s]: rx_skb_alloc_discard&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">Q_STATS_OFFSET32</span><span class="p">(</span><span class="n">hw_csum_err</span><span class="p">),</span> <span class="mi">4</span><span class="p">,</span> <span class="s">&quot;[%s]: rx_csum_offload_errors&quot;</span> <span class="p">},</span>

	<span class="p">{</span> <span class="n">Q_STATS_OFFSET32</span><span class="p">(</span><span class="n">total_bytes_transmitted_hi</span><span class="p">),</span>	<span class="mi">8</span><span class="p">,</span> <span class="s">&quot;[%s]: tx_bytes&quot;</span> <span class="p">},</span>
<span class="cm">/* 10 */</span><span class="p">{</span> <span class="n">Q_STATS_OFFSET32</span><span class="p">(</span><span class="n">total_unicast_packets_transmitted_hi</span><span class="p">),</span>
						<span class="mi">8</span><span class="p">,</span> <span class="s">&quot;[%s]: tx_ucast_packets&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">Q_STATS_OFFSET32</span><span class="p">(</span><span class="n">total_multicast_packets_transmitted_hi</span><span class="p">),</span>
						<span class="mi">8</span><span class="p">,</span> <span class="s">&quot;[%s]: tx_mcast_packets&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">Q_STATS_OFFSET32</span><span class="p">(</span><span class="n">total_broadcast_packets_transmitted_hi</span><span class="p">),</span>
						<span class="mi">8</span><span class="p">,</span> <span class="s">&quot;[%s]: tx_bcast_packets&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">Q_STATS_OFFSET32</span><span class="p">(</span><span class="n">total_tpa_aggregations_hi</span><span class="p">),</span>
						<span class="mi">8</span><span class="p">,</span> <span class="s">&quot;[%s]: tpa_aggregations&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">Q_STATS_OFFSET32</span><span class="p">(</span><span class="n">total_tpa_aggregated_frames_hi</span><span class="p">),</span>
					<span class="mi">8</span><span class="p">,</span> <span class="s">&quot;[%s]: tpa_aggregated_frames&quot;</span><span class="p">},</span>
	<span class="p">{</span> <span class="n">Q_STATS_OFFSET32</span><span class="p">(</span><span class="n">total_tpa_bytes_hi</span><span class="p">),</span>	<span class="mi">8</span><span class="p">,</span> <span class="s">&quot;[%s]: tpa_bytes&quot;</span><span class="p">}</span>
<span class="p">};</span>

<span class="cp">#define BNX2X_NUM_Q_STATS ARRAY_SIZE(bnx2x_q_stats_arr)</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="p">{</span>
	<span class="kt">long</span> <span class="n">offset</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">size</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">flags</span><span class="p">;</span>
<span class="cp">#define STATS_FLAGS_PORT		1</span>
<span class="cp">#define STATS_FLAGS_FUNC		2</span>
<span class="cp">#define STATS_FLAGS_BOTH		(STATS_FLAGS_FUNC | STATS_FLAGS_PORT)</span>
	<span class="kt">char</span> <span class="n">string</span><span class="p">[</span><span class="n">ETH_GSTRING_LEN</span><span class="p">];</span>
<span class="p">}</span> <span class="n">bnx2x_stats_arr</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
<span class="cm">/* 1 */</span>	<span class="p">{</span> <span class="n">STATS_OFFSET32</span><span class="p">(</span><span class="n">total_bytes_received_hi</span><span class="p">),</span>
				<span class="mi">8</span><span class="p">,</span> <span class="n">STATS_FLAGS_BOTH</span><span class="p">,</span> <span class="s">&quot;rx_bytes&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STATS_OFFSET32</span><span class="p">(</span><span class="n">error_bytes_received_hi</span><span class="p">),</span>
				<span class="mi">8</span><span class="p">,</span> <span class="n">STATS_FLAGS_BOTH</span><span class="p">,</span> <span class="s">&quot;rx_error_bytes&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STATS_OFFSET32</span><span class="p">(</span><span class="n">total_unicast_packets_received_hi</span><span class="p">),</span>
				<span class="mi">8</span><span class="p">,</span> <span class="n">STATS_FLAGS_BOTH</span><span class="p">,</span> <span class="s">&quot;rx_ucast_packets&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STATS_OFFSET32</span><span class="p">(</span><span class="n">total_multicast_packets_received_hi</span><span class="p">),</span>
				<span class="mi">8</span><span class="p">,</span> <span class="n">STATS_FLAGS_BOTH</span><span class="p">,</span> <span class="s">&quot;rx_mcast_packets&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STATS_OFFSET32</span><span class="p">(</span><span class="n">total_broadcast_packets_received_hi</span><span class="p">),</span>
				<span class="mi">8</span><span class="p">,</span> <span class="n">STATS_FLAGS_BOTH</span><span class="p">,</span> <span class="s">&quot;rx_bcast_packets&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STATS_OFFSET32</span><span class="p">(</span><span class="n">rx_stat_dot3statsfcserrors_hi</span><span class="p">),</span>
				<span class="mi">8</span><span class="p">,</span> <span class="n">STATS_FLAGS_PORT</span><span class="p">,</span> <span class="s">&quot;rx_crc_errors&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STATS_OFFSET32</span><span class="p">(</span><span class="n">rx_stat_dot3statsalignmenterrors_hi</span><span class="p">),</span>
				<span class="mi">8</span><span class="p">,</span> <span class="n">STATS_FLAGS_PORT</span><span class="p">,</span> <span class="s">&quot;rx_align_errors&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STATS_OFFSET32</span><span class="p">(</span><span class="n">rx_stat_etherstatsundersizepkts_hi</span><span class="p">),</span>
				<span class="mi">8</span><span class="p">,</span> <span class="n">STATS_FLAGS_PORT</span><span class="p">,</span> <span class="s">&quot;rx_undersize_packets&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STATS_OFFSET32</span><span class="p">(</span><span class="n">etherstatsoverrsizepkts_hi</span><span class="p">),</span>
				<span class="mi">8</span><span class="p">,</span> <span class="n">STATS_FLAGS_PORT</span><span class="p">,</span> <span class="s">&quot;rx_oversize_packets&quot;</span> <span class="p">},</span>
<span class="cm">/* 10 */</span><span class="p">{</span> <span class="n">STATS_OFFSET32</span><span class="p">(</span><span class="n">rx_stat_etherstatsfragments_hi</span><span class="p">),</span>
				<span class="mi">8</span><span class="p">,</span> <span class="n">STATS_FLAGS_PORT</span><span class="p">,</span> <span class="s">&quot;rx_fragments&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STATS_OFFSET32</span><span class="p">(</span><span class="n">rx_stat_etherstatsjabbers_hi</span><span class="p">),</span>
				<span class="mi">8</span><span class="p">,</span> <span class="n">STATS_FLAGS_PORT</span><span class="p">,</span> <span class="s">&quot;rx_jabbers&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STATS_OFFSET32</span><span class="p">(</span><span class="n">no_buff_discard_hi</span><span class="p">),</span>
				<span class="mi">8</span><span class="p">,</span> <span class="n">STATS_FLAGS_BOTH</span><span class="p">,</span> <span class="s">&quot;rx_discards&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STATS_OFFSET32</span><span class="p">(</span><span class="n">mac_filter_discard</span><span class="p">),</span>
				<span class="mi">4</span><span class="p">,</span> <span class="n">STATS_FLAGS_PORT</span><span class="p">,</span> <span class="s">&quot;rx_filtered_packets&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STATS_OFFSET32</span><span class="p">(</span><span class="n">mf_tag_discard</span><span class="p">),</span>
				<span class="mi">4</span><span class="p">,</span> <span class="n">STATS_FLAGS_PORT</span><span class="p">,</span> <span class="s">&quot;rx_mf_tag_discard&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STATS_OFFSET32</span><span class="p">(</span><span class="n">pfc_frames_received_hi</span><span class="p">),</span>
				<span class="mi">8</span><span class="p">,</span> <span class="n">STATS_FLAGS_PORT</span><span class="p">,</span> <span class="s">&quot;pfc_frames_received&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STATS_OFFSET32</span><span class="p">(</span><span class="n">pfc_frames_sent_hi</span><span class="p">),</span>
				<span class="mi">8</span><span class="p">,</span> <span class="n">STATS_FLAGS_PORT</span><span class="p">,</span> <span class="s">&quot;pfc_frames_sent&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STATS_OFFSET32</span><span class="p">(</span><span class="n">brb_drop_hi</span><span class="p">),</span>
				<span class="mi">8</span><span class="p">,</span> <span class="n">STATS_FLAGS_PORT</span><span class="p">,</span> <span class="s">&quot;rx_brb_discard&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STATS_OFFSET32</span><span class="p">(</span><span class="n">brb_truncate_hi</span><span class="p">),</span>
				<span class="mi">8</span><span class="p">,</span> <span class="n">STATS_FLAGS_PORT</span><span class="p">,</span> <span class="s">&quot;rx_brb_truncate&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STATS_OFFSET32</span><span class="p">(</span><span class="n">pause_frames_received_hi</span><span class="p">),</span>
				<span class="mi">8</span><span class="p">,</span> <span class="n">STATS_FLAGS_PORT</span><span class="p">,</span> <span class="s">&quot;rx_pause_frames&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STATS_OFFSET32</span><span class="p">(</span><span class="n">rx_stat_maccontrolframesreceived_hi</span><span class="p">),</span>
				<span class="mi">8</span><span class="p">,</span> <span class="n">STATS_FLAGS_PORT</span><span class="p">,</span> <span class="s">&quot;rx_mac_ctrl_frames&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STATS_OFFSET32</span><span class="p">(</span><span class="n">nig_timer_max</span><span class="p">),</span>
			<span class="mi">4</span><span class="p">,</span> <span class="n">STATS_FLAGS_PORT</span><span class="p">,</span> <span class="s">&quot;rx_constant_pause_events&quot;</span> <span class="p">},</span>
<span class="cm">/* 20 */</span><span class="p">{</span> <span class="n">STATS_OFFSET32</span><span class="p">(</span><span class="n">rx_err_discard_pkt</span><span class="p">),</span>
				<span class="mi">4</span><span class="p">,</span> <span class="n">STATS_FLAGS_BOTH</span><span class="p">,</span> <span class="s">&quot;rx_phy_ip_err_discards&quot;</span><span class="p">},</span>
	<span class="p">{</span> <span class="n">STATS_OFFSET32</span><span class="p">(</span><span class="n">rx_skb_alloc_failed</span><span class="p">),</span>
				<span class="mi">4</span><span class="p">,</span> <span class="n">STATS_FLAGS_BOTH</span><span class="p">,</span> <span class="s">&quot;rx_skb_alloc_discard&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STATS_OFFSET32</span><span class="p">(</span><span class="n">hw_csum_err</span><span class="p">),</span>
				<span class="mi">4</span><span class="p">,</span> <span class="n">STATS_FLAGS_BOTH</span><span class="p">,</span> <span class="s">&quot;rx_csum_offload_errors&quot;</span> <span class="p">},</span>

	<span class="p">{</span> <span class="n">STATS_OFFSET32</span><span class="p">(</span><span class="n">total_bytes_transmitted_hi</span><span class="p">),</span>
				<span class="mi">8</span><span class="p">,</span> <span class="n">STATS_FLAGS_BOTH</span><span class="p">,</span> <span class="s">&quot;tx_bytes&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STATS_OFFSET32</span><span class="p">(</span><span class="n">tx_stat_ifhcoutbadoctets_hi</span><span class="p">),</span>
				<span class="mi">8</span><span class="p">,</span> <span class="n">STATS_FLAGS_PORT</span><span class="p">,</span> <span class="s">&quot;tx_error_bytes&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STATS_OFFSET32</span><span class="p">(</span><span class="n">total_unicast_packets_transmitted_hi</span><span class="p">),</span>
				<span class="mi">8</span><span class="p">,</span> <span class="n">STATS_FLAGS_BOTH</span><span class="p">,</span> <span class="s">&quot;tx_ucast_packets&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STATS_OFFSET32</span><span class="p">(</span><span class="n">total_multicast_packets_transmitted_hi</span><span class="p">),</span>
				<span class="mi">8</span><span class="p">,</span> <span class="n">STATS_FLAGS_BOTH</span><span class="p">,</span> <span class="s">&quot;tx_mcast_packets&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STATS_OFFSET32</span><span class="p">(</span><span class="n">total_broadcast_packets_transmitted_hi</span><span class="p">),</span>
				<span class="mi">8</span><span class="p">,</span> <span class="n">STATS_FLAGS_BOTH</span><span class="p">,</span> <span class="s">&quot;tx_bcast_packets&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STATS_OFFSET32</span><span class="p">(</span><span class="n">tx_stat_dot3statsinternalmactransmiterrors_hi</span><span class="p">),</span>
				<span class="mi">8</span><span class="p">,</span> <span class="n">STATS_FLAGS_PORT</span><span class="p">,</span> <span class="s">&quot;tx_mac_errors&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STATS_OFFSET32</span><span class="p">(</span><span class="n">rx_stat_dot3statscarriersenseerrors_hi</span><span class="p">),</span>
				<span class="mi">8</span><span class="p">,</span> <span class="n">STATS_FLAGS_PORT</span><span class="p">,</span> <span class="s">&quot;tx_carrier_errors&quot;</span> <span class="p">},</span>
<span class="cm">/* 30 */</span><span class="p">{</span> <span class="n">STATS_OFFSET32</span><span class="p">(</span><span class="n">tx_stat_dot3statssinglecollisionframes_hi</span><span class="p">),</span>
				<span class="mi">8</span><span class="p">,</span> <span class="n">STATS_FLAGS_PORT</span><span class="p">,</span> <span class="s">&quot;tx_single_collisions&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STATS_OFFSET32</span><span class="p">(</span><span class="n">tx_stat_dot3statsmultiplecollisionframes_hi</span><span class="p">),</span>
				<span class="mi">8</span><span class="p">,</span> <span class="n">STATS_FLAGS_PORT</span><span class="p">,</span> <span class="s">&quot;tx_multi_collisions&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STATS_OFFSET32</span><span class="p">(</span><span class="n">tx_stat_dot3statsdeferredtransmissions_hi</span><span class="p">),</span>
				<span class="mi">8</span><span class="p">,</span> <span class="n">STATS_FLAGS_PORT</span><span class="p">,</span> <span class="s">&quot;tx_deferred&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STATS_OFFSET32</span><span class="p">(</span><span class="n">tx_stat_dot3statsexcessivecollisions_hi</span><span class="p">),</span>
				<span class="mi">8</span><span class="p">,</span> <span class="n">STATS_FLAGS_PORT</span><span class="p">,</span> <span class="s">&quot;tx_excess_collisions&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STATS_OFFSET32</span><span class="p">(</span><span class="n">tx_stat_dot3statslatecollisions_hi</span><span class="p">),</span>
				<span class="mi">8</span><span class="p">,</span> <span class="n">STATS_FLAGS_PORT</span><span class="p">,</span> <span class="s">&quot;tx_late_collisions&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STATS_OFFSET32</span><span class="p">(</span><span class="n">tx_stat_etherstatscollisions_hi</span><span class="p">),</span>
				<span class="mi">8</span><span class="p">,</span> <span class="n">STATS_FLAGS_PORT</span><span class="p">,</span> <span class="s">&quot;tx_total_collisions&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STATS_OFFSET32</span><span class="p">(</span><span class="n">tx_stat_etherstatspkts64octets_hi</span><span class="p">),</span>
				<span class="mi">8</span><span class="p">,</span> <span class="n">STATS_FLAGS_PORT</span><span class="p">,</span> <span class="s">&quot;tx_64_byte_packets&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STATS_OFFSET32</span><span class="p">(</span><span class="n">tx_stat_etherstatspkts65octetsto127octets_hi</span><span class="p">),</span>
			<span class="mi">8</span><span class="p">,</span> <span class="n">STATS_FLAGS_PORT</span><span class="p">,</span> <span class="s">&quot;tx_65_to_127_byte_packets&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STATS_OFFSET32</span><span class="p">(</span><span class="n">tx_stat_etherstatspkts128octetsto255octets_hi</span><span class="p">),</span>
			<span class="mi">8</span><span class="p">,</span> <span class="n">STATS_FLAGS_PORT</span><span class="p">,</span> <span class="s">&quot;tx_128_to_255_byte_packets&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STATS_OFFSET32</span><span class="p">(</span><span class="n">tx_stat_etherstatspkts256octetsto511octets_hi</span><span class="p">),</span>
			<span class="mi">8</span><span class="p">,</span> <span class="n">STATS_FLAGS_PORT</span><span class="p">,</span> <span class="s">&quot;tx_256_to_511_byte_packets&quot;</span> <span class="p">},</span>
<span class="cm">/* 40 */</span><span class="p">{</span> <span class="n">STATS_OFFSET32</span><span class="p">(</span><span class="n">tx_stat_etherstatspkts512octetsto1023octets_hi</span><span class="p">),</span>
			<span class="mi">8</span><span class="p">,</span> <span class="n">STATS_FLAGS_PORT</span><span class="p">,</span> <span class="s">&quot;tx_512_to_1023_byte_packets&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STATS_OFFSET32</span><span class="p">(</span><span class="n">etherstatspkts1024octetsto1522octets_hi</span><span class="p">),</span>
			<span class="mi">8</span><span class="p">,</span> <span class="n">STATS_FLAGS_PORT</span><span class="p">,</span> <span class="s">&quot;tx_1024_to_1522_byte_packets&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STATS_OFFSET32</span><span class="p">(</span><span class="n">etherstatspktsover1522octets_hi</span><span class="p">),</span>
			<span class="mi">8</span><span class="p">,</span> <span class="n">STATS_FLAGS_PORT</span><span class="p">,</span> <span class="s">&quot;tx_1523_to_9022_byte_packets&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STATS_OFFSET32</span><span class="p">(</span><span class="n">pause_frames_sent_hi</span><span class="p">),</span>
				<span class="mi">8</span><span class="p">,</span> <span class="n">STATS_FLAGS_PORT</span><span class="p">,</span> <span class="s">&quot;tx_pause_frames&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STATS_OFFSET32</span><span class="p">(</span><span class="n">total_tpa_aggregations_hi</span><span class="p">),</span>
			<span class="mi">8</span><span class="p">,</span> <span class="n">STATS_FLAGS_FUNC</span><span class="p">,</span> <span class="s">&quot;tpa_aggregations&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STATS_OFFSET32</span><span class="p">(</span><span class="n">total_tpa_aggregated_frames_hi</span><span class="p">),</span>
			<span class="mi">8</span><span class="p">,</span> <span class="n">STATS_FLAGS_FUNC</span><span class="p">,</span> <span class="s">&quot;tpa_aggregated_frames&quot;</span><span class="p">},</span>
	<span class="p">{</span> <span class="n">STATS_OFFSET32</span><span class="p">(</span><span class="n">total_tpa_bytes_hi</span><span class="p">),</span>
			<span class="mi">8</span><span class="p">,</span> <span class="n">STATS_FLAGS_FUNC</span><span class="p">,</span> <span class="s">&quot;tpa_bytes&quot;</span><span class="p">},</span>
	<span class="p">{</span> <span class="n">STATS_OFFSET32</span><span class="p">(</span><span class="n">recoverable_error</span><span class="p">),</span>
			<span class="mi">4</span><span class="p">,</span> <span class="n">STATS_FLAGS_FUNC</span><span class="p">,</span> <span class="s">&quot;recoverable_errors&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">STATS_OFFSET32</span><span class="p">(</span><span class="n">unrecoverable_error</span><span class="p">),</span>
			<span class="mi">4</span><span class="p">,</span> <span class="n">STATS_FLAGS_FUNC</span><span class="p">,</span> <span class="s">&quot;unrecoverable_errors&quot;</span> <span class="p">},</span>
<span class="p">};</span>

<span class="cp">#define BNX2X_NUM_STATS		ARRAY_SIZE(bnx2x_stats_arr)</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">bnx2x_get_port_type</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">port_type</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">phy_idx</span> <span class="o">=</span> <span class="n">bnx2x_get_cur_phy_idx</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">link_params</span><span class="p">.</span><span class="n">phy</span><span class="p">[</span><span class="n">phy_idx</span><span class="p">].</span><span class="n">media_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ETH_PHY_SFP_FIBER</span>:
	<span class="k">case</span> <span class="n">ETH_PHY_XFP_FIBER</span>:
	<span class="k">case</span> <span class="n">ETH_PHY_KR</span>:
	<span class="k">case</span> <span class="n">ETH_PHY_CX4</span>:
		<span class="n">port_type</span> <span class="o">=</span> <span class="n">PORT_FIBRE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ETH_PHY_DA_TWINAX</span>:
		<span class="n">port_type</span> <span class="o">=</span> <span class="n">PORT_DA</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ETH_PHY_BASE_T</span>:
		<span class="n">port_type</span> <span class="o">=</span> <span class="n">PORT_TP</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ETH_PHY_NOT_PRESENT</span>:
		<span class="n">port_type</span> <span class="o">=</span> <span class="n">PORT_NONE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ETH_PHY_UNSPECIFIED</span>:
	<span class="nl">default:</span>
		<span class="n">port_type</span> <span class="o">=</span> <span class="n">PORT_OTHER</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">port_type</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bnx2x_get_settings</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ethtool_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">cfg_idx</span> <span class="o">=</span> <span class="n">bnx2x_get_link_cfg_idx</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>

	<span class="cm">/* Dual Media boards present all available port types */</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">supported</span> <span class="o">=</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">supported</span><span class="p">[</span><span class="n">cfg_idx</span><span class="p">]</span> <span class="o">|</span>
		<span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">supported</span><span class="p">[</span><span class="n">cfg_idx</span> <span class="o">^</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span>
		 <span class="p">(</span><span class="n">SUPPORTED_TP</span> <span class="o">|</span> <span class="n">SUPPORTED_FIBRE</span><span class="p">));</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">advertising</span> <span class="o">=</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">advertising</span><span class="p">[</span><span class="n">cfg_idx</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">BNX2X_STATE_OPEN</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">link_vars</span><span class="p">.</span><span class="n">link_up</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MF_FUNC_DIS</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ethtool_cmd_speed_set</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">link_vars</span><span class="p">.</span><span class="n">line_speed</span><span class="p">);</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">duplex</span> <span class="o">=</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">link_vars</span><span class="p">.</span><span class="n">duplex</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">ethtool_cmd_speed_set</span><span class="p">(</span>
				<span class="n">cmd</span><span class="p">,</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">link_params</span><span class="p">.</span><span class="n">req_line_speed</span><span class="p">[</span><span class="n">cfg_idx</span><span class="p">]);</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">duplex</span> <span class="o">=</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">link_params</span><span class="p">.</span><span class="n">req_duplex</span><span class="p">[</span><span class="n">cfg_idx</span><span class="p">];</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">IS_MF</span><span class="p">(</span><span class="n">bp</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">BP_NOMCP</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span>
			<span class="n">ethtool_cmd_speed_set</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">bnx2x_get_mf_speed</span><span class="p">(</span><span class="n">bp</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">duplex</span> <span class="o">=</span> <span class="n">DUPLEX_UNKNOWN</span><span class="p">;</span>
		<span class="n">ethtool_cmd_speed_set</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">SPEED_UNKNOWN</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">=</span> <span class="n">bnx2x_get_port_type</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>

	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">phy_address</span> <span class="o">=</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">mdio</span><span class="p">.</span><span class="n">prtad</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">transceiver</span> <span class="o">=</span> <span class="n">XCVR_INTERNAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">link_params</span><span class="p">.</span><span class="n">req_line_speed</span><span class="p">[</span><span class="n">cfg_idx</span><span class="p">]</span> <span class="o">==</span> <span class="n">SPEED_AUTO_NEG</span><span class="p">)</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">autoneg</span> <span class="o">=</span> <span class="n">AUTONEG_ENABLE</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">autoneg</span> <span class="o">=</span> <span class="n">AUTONEG_DISABLE</span><span class="p">;</span>

	<span class="cm">/* Publish LP advertised speeds and FC */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">link_vars</span><span class="p">.</span><span class="n">link_status</span> <span class="o">&amp;</span> <span class="n">LINK_STATUS_AUTO_NEGOTIATE_COMPLETE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">status</span> <span class="o">=</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">link_vars</span><span class="p">.</span><span class="n">link_status</span><span class="p">;</span>

		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">lp_advertising</span> <span class="o">|=</span> <span class="n">ADVERTISED_Autoneg</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">LINK_STATUS_LINK_PARTNER_SYMMETRIC_PAUSE</span><span class="p">)</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">lp_advertising</span> <span class="o">|=</span> <span class="n">ADVERTISED_Pause</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">LINK_STATUS_LINK_PARTNER_ASYMMETRIC_PAUSE</span><span class="p">)</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">lp_advertising</span> <span class="o">|=</span> <span class="n">ADVERTISED_Asym_Pause</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">LINK_STATUS_LINK_PARTNER_10THD_CAPABLE</span><span class="p">)</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">lp_advertising</span> <span class="o">|=</span> <span class="n">ADVERTISED_10baseT_Half</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">LINK_STATUS_LINK_PARTNER_10TFD_CAPABLE</span><span class="p">)</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">lp_advertising</span> <span class="o">|=</span> <span class="n">ADVERTISED_10baseT_Full</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">LINK_STATUS_LINK_PARTNER_100TXHD_CAPABLE</span><span class="p">)</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">lp_advertising</span> <span class="o">|=</span> <span class="n">ADVERTISED_100baseT_Half</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">LINK_STATUS_LINK_PARTNER_100TXFD_CAPABLE</span><span class="p">)</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">lp_advertising</span> <span class="o">|=</span> <span class="n">ADVERTISED_100baseT_Full</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">LINK_STATUS_LINK_PARTNER_1000THD_CAPABLE</span><span class="p">)</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">lp_advertising</span> <span class="o">|=</span> <span class="n">ADVERTISED_1000baseT_Half</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">LINK_STATUS_LINK_PARTNER_1000TFD_CAPABLE</span><span class="p">)</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">lp_advertising</span> <span class="o">|=</span> <span class="n">ADVERTISED_1000baseT_Full</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">LINK_STATUS_LINK_PARTNER_2500XFD_CAPABLE</span><span class="p">)</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">lp_advertising</span> <span class="o">|=</span> <span class="n">ADVERTISED_2500baseX_Full</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">LINK_STATUS_LINK_PARTNER_10GXFD_CAPABLE</span><span class="p">)</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">lp_advertising</span> <span class="o">|=</span> <span class="n">ADVERTISED_10000baseT_Full</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">maxtxpkt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">maxrxpkt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">DP</span><span class="p">(</span><span class="n">BNX2X_MSG_ETHTOOL</span><span class="p">,</span> <span class="s">&quot;ethtool_cmd: cmd %d</span><span class="se">\n</span><span class="s">&quot;</span>
	   <span class="s">&quot;  supported 0x%x  advertising 0x%x  speed %u</span><span class="se">\n</span><span class="s">&quot;</span>
	   <span class="s">&quot;  duplex %d  port %d  phy_address %d  transceiver %d</span><span class="se">\n</span><span class="s">&quot;</span>
	   <span class="s">&quot;  autoneg %d  maxtxpkt %d  maxrxpkt %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	   <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">supported</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">advertising</span><span class="p">,</span>
	   <span class="n">ethtool_cmd_speed</span><span class="p">(</span><span class="n">cmd</span><span class="p">),</span>
	   <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">duplex</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">phy_address</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">transceiver</span><span class="p">,</span>
	   <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">autoneg</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">maxtxpkt</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">maxrxpkt</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bnx2x_set_settings</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ethtool_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">advertising</span><span class="p">,</span> <span class="n">cfg_idx</span><span class="p">,</span> <span class="n">old_multi_phy_config</span><span class="p">,</span> <span class="n">new_multi_phy_config</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">speed</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_MF_SD</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">DP</span><span class="p">(</span><span class="n">BNX2X_MSG_ETHTOOL</span><span class="p">,</span> <span class="s">&quot;ethtool_cmd: cmd %d</span><span class="se">\n</span><span class="s">&quot;</span>
	   <span class="s">&quot;  supported 0x%x  advertising 0x%x  speed %u</span><span class="se">\n</span><span class="s">&quot;</span>
	   <span class="s">&quot;  duplex %d  port %d  phy_address %d  transceiver %d</span><span class="se">\n</span><span class="s">&quot;</span>
	   <span class="s">&quot;  autoneg %d  maxtxpkt %d  maxrxpkt %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	   <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">supported</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">advertising</span><span class="p">,</span>
	   <span class="n">ethtool_cmd_speed</span><span class="p">(</span><span class="n">cmd</span><span class="p">),</span>
	   <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">duplex</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">phy_address</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">transceiver</span><span class="p">,</span>
	   <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">autoneg</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">maxtxpkt</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">maxrxpkt</span><span class="p">);</span>

	<span class="n">speed</span> <span class="o">=</span> <span class="n">ethtool_cmd_speed</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>

	<span class="cm">/* If recieved a request for an unknown duplex, assume full*/</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">duplex</span> <span class="o">==</span> <span class="n">DUPLEX_UNKNOWN</span><span class="p">)</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">duplex</span> <span class="o">=</span> <span class="n">DUPLEX_FULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_MF_SI</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">part</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">line_speed</span> <span class="o">=</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">link_vars</span><span class="p">.</span><span class="n">line_speed</span><span class="p">;</span>

		<span class="cm">/* use 10G if no link detected */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">line_speed</span><span class="p">)</span>
			<span class="n">line_speed</span> <span class="o">=</span> <span class="mi">10000</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">.</span><span class="n">bc_ver</span> <span class="o">&lt;</span> <span class="n">REQ_BC_VER_4_SET_MF_BW</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DP</span><span class="p">(</span><span class="n">BNX2X_MSG_ETHTOOL</span><span class="p">,</span>
			   <span class="s">&quot;To set speed BC %X or higher is required, please upgrade BC</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">REQ_BC_VER_4_SET_MF_BW</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">part</span> <span class="o">=</span> <span class="p">(</span><span class="n">speed</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span> <span class="o">/</span> <span class="n">line_speed</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">line_speed</span> <span class="o">&lt;</span> <span class="n">speed</span> <span class="o">||</span> <span class="o">!</span><span class="n">part</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DP</span><span class="p">(</span><span class="n">BNX2X_MSG_ETHTOOL</span><span class="p">,</span>
			   <span class="s">&quot;Speed setting should be in a range from 1%% to 100%% of actual line speed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">BNX2X_STATE_OPEN</span><span class="p">)</span>
			<span class="cm">/* store value for following &quot;load&quot; */</span>
			<span class="n">bp</span><span class="o">-&gt;</span><span class="n">pending_max</span> <span class="o">=</span> <span class="n">part</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">bnx2x_update_max_mf_config</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">part</span><span class="p">);</span>

		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cfg_idx</span> <span class="o">=</span> <span class="n">bnx2x_get_link_cfg_idx</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
	<span class="n">old_multi_phy_config</span> <span class="o">=</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">link_params</span><span class="p">.</span><span class="n">multi_phy_config</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PORT_TP</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">supported</span><span class="p">[</span><span class="n">cfg_idx</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">SUPPORTED_TP</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span> <span class="cm">/* no port change */</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">supported</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">SUPPORTED_TP</span> <span class="o">||</span>
		      <span class="n">bp</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">supported</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">SUPPORTED_TP</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">DP</span><span class="p">(</span><span class="n">BNX2X_MSG_ETHTOOL</span><span class="p">,</span> <span class="s">&quot;Unsupported port type</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">bp</span><span class="o">-&gt;</span><span class="n">link_params</span><span class="p">.</span><span class="n">multi_phy_config</span> <span class="o">&amp;=</span>
			<span class="o">~</span><span class="n">PORT_HW_CFG_PHY_SELECTION_MASK</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">link_params</span><span class="p">.</span><span class="n">multi_phy_config</span> <span class="o">&amp;</span>
		    <span class="n">PORT_HW_CFG_PHY_SWAPPED_ENABLED</span><span class="p">)</span>
			<span class="n">bp</span><span class="o">-&gt;</span><span class="n">link_params</span><span class="p">.</span><span class="n">multi_phy_config</span> <span class="o">|=</span>
			<span class="n">PORT_HW_CFG_PHY_SELECTION_SECOND_PHY</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">bp</span><span class="o">-&gt;</span><span class="n">link_params</span><span class="p">.</span><span class="n">multi_phy_config</span> <span class="o">|=</span>
			<span class="n">PORT_HW_CFG_PHY_SELECTION_FIRST_PHY</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PORT_FIBRE</span>:
	<span class="k">case</span> <span class="n">PORT_DA</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">supported</span><span class="p">[</span><span class="n">cfg_idx</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">SUPPORTED_FIBRE</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span> <span class="cm">/* no port change */</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">supported</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">SUPPORTED_FIBRE</span> <span class="o">||</span>
		      <span class="n">bp</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">supported</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">SUPPORTED_FIBRE</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">DP</span><span class="p">(</span><span class="n">BNX2X_MSG_ETHTOOL</span><span class="p">,</span> <span class="s">&quot;Unsupported port type</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">bp</span><span class="o">-&gt;</span><span class="n">link_params</span><span class="p">.</span><span class="n">multi_phy_config</span> <span class="o">&amp;=</span>
			<span class="o">~</span><span class="n">PORT_HW_CFG_PHY_SELECTION_MASK</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">link_params</span><span class="p">.</span><span class="n">multi_phy_config</span> <span class="o">&amp;</span>
		    <span class="n">PORT_HW_CFG_PHY_SWAPPED_ENABLED</span><span class="p">)</span>
			<span class="n">bp</span><span class="o">-&gt;</span><span class="n">link_params</span><span class="p">.</span><span class="n">multi_phy_config</span> <span class="o">|=</span>
			<span class="n">PORT_HW_CFG_PHY_SELECTION_FIRST_PHY</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">bp</span><span class="o">-&gt;</span><span class="n">link_params</span><span class="p">.</span><span class="n">multi_phy_config</span> <span class="o">|=</span>
			<span class="n">PORT_HW_CFG_PHY_SELECTION_SECOND_PHY</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">DP</span><span class="p">(</span><span class="n">BNX2X_MSG_ETHTOOL</span><span class="p">,</span> <span class="s">&quot;Unsupported port type</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* Save new config in case command complete successully */</span>
	<span class="n">new_multi_phy_config</span> <span class="o">=</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">link_params</span><span class="p">.</span><span class="n">multi_phy_config</span><span class="p">;</span>
	<span class="cm">/* Get the new cfg_idx */</span>
	<span class="n">cfg_idx</span> <span class="o">=</span> <span class="n">bnx2x_get_link_cfg_idx</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
	<span class="cm">/* Restore old config in case command failed */</span>
	<span class="n">bp</span><span class="o">-&gt;</span><span class="n">link_params</span><span class="p">.</span><span class="n">multi_phy_config</span> <span class="o">=</span> <span class="n">old_multi_phy_config</span><span class="p">;</span>
	<span class="n">DP</span><span class="p">(</span><span class="n">BNX2X_MSG_ETHTOOL</span><span class="p">,</span> <span class="s">&quot;cfg_idx = %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cfg_idx</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">autoneg</span> <span class="o">==</span> <span class="n">AUTONEG_ENABLE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">an_supported_speed</span> <span class="o">=</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">supported</span><span class="p">[</span><span class="n">cfg_idx</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">link_params</span><span class="p">.</span><span class="n">phy</span><span class="p">[</span><span class="n">EXT_PHY1</span><span class="p">].</span><span class="n">type</span> <span class="o">==</span>
		    <span class="n">PORT_HW_CFG_XGXS_EXT_PHY_TYPE_BCM84833</span><span class="p">)</span>
			<span class="n">an_supported_speed</span> <span class="o">|=</span> <span class="p">(</span><span class="n">SUPPORTED_100baseT_Half</span> <span class="o">|</span>
					       <span class="n">SUPPORTED_100baseT_Full</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">supported</span><span class="p">[</span><span class="n">cfg_idx</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">SUPPORTED_Autoneg</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">DP</span><span class="p">(</span><span class="n">BNX2X_MSG_ETHTOOL</span><span class="p">,</span> <span class="s">&quot;Autoneg not supported</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* advertise the requested speed and duplex if supported */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">advertising</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">an_supported_speed</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DP</span><span class="p">(</span><span class="n">BNX2X_MSG_ETHTOOL</span><span class="p">,</span>
			   <span class="s">&quot;Advertisement parameters are not supported</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">bp</span><span class="o">-&gt;</span><span class="n">link_params</span><span class="p">.</span><span class="n">req_line_speed</span><span class="p">[</span><span class="n">cfg_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">SPEED_AUTO_NEG</span><span class="p">;</span>
		<span class="n">bp</span><span class="o">-&gt;</span><span class="n">link_params</span><span class="p">.</span><span class="n">req_duplex</span><span class="p">[</span><span class="n">cfg_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">duplex</span><span class="p">;</span>
		<span class="n">bp</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">advertising</span><span class="p">[</span><span class="n">cfg_idx</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">ADVERTISED_Autoneg</span> <span class="o">|</span>
					 <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">advertising</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">advertising</span><span class="p">)</span> <span class="p">{</span>

			<span class="n">bp</span><span class="o">-&gt;</span><span class="n">link_params</span><span class="p">.</span><span class="n">speed_cap_mask</span><span class="p">[</span><span class="n">cfg_idx</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">advertising</span> <span class="o">&amp;</span> <span class="n">ADVERTISED_10baseT_Half</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">bp</span><span class="o">-&gt;</span><span class="n">link_params</span><span class="p">.</span><span class="n">speed_cap_mask</span><span class="p">[</span><span class="n">cfg_idx</span><span class="p">]</span> <span class="o">|=</span>
				<span class="n">PORT_HW_CFG_SPEED_CAPABILITY_D0_10M_HALF</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">advertising</span> <span class="o">&amp;</span> <span class="n">ADVERTISED_10baseT_Full</span><span class="p">)</span>
				<span class="n">bp</span><span class="o">-&gt;</span><span class="n">link_params</span><span class="p">.</span><span class="n">speed_cap_mask</span><span class="p">[</span><span class="n">cfg_idx</span><span class="p">]</span> <span class="o">|=</span>
				<span class="n">PORT_HW_CFG_SPEED_CAPABILITY_D0_10M_FULL</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">advertising</span> <span class="o">&amp;</span> <span class="n">ADVERTISED_100baseT_Full</span><span class="p">)</span>
				<span class="n">bp</span><span class="o">-&gt;</span><span class="n">link_params</span><span class="p">.</span><span class="n">speed_cap_mask</span><span class="p">[</span><span class="n">cfg_idx</span><span class="p">]</span> <span class="o">|=</span>
				<span class="n">PORT_HW_CFG_SPEED_CAPABILITY_D0_100M_FULL</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">advertising</span> <span class="o">&amp;</span> <span class="n">ADVERTISED_100baseT_Half</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">bp</span><span class="o">-&gt;</span><span class="n">link_params</span><span class="p">.</span><span class="n">speed_cap_mask</span><span class="p">[</span><span class="n">cfg_idx</span><span class="p">]</span> <span class="o">|=</span>
				     <span class="n">PORT_HW_CFG_SPEED_CAPABILITY_D0_100M_HALF</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">advertising</span> <span class="o">&amp;</span> <span class="n">ADVERTISED_1000baseT_Half</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">bp</span><span class="o">-&gt;</span><span class="n">link_params</span><span class="p">.</span><span class="n">speed_cap_mask</span><span class="p">[</span><span class="n">cfg_idx</span><span class="p">]</span> <span class="o">|=</span>
					<span class="n">PORT_HW_CFG_SPEED_CAPABILITY_D0_1G</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">advertising</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ADVERTISED_1000baseT_Full</span> <span class="o">|</span>
						<span class="n">ADVERTISED_1000baseKX_Full</span><span class="p">))</span>
				<span class="n">bp</span><span class="o">-&gt;</span><span class="n">link_params</span><span class="p">.</span><span class="n">speed_cap_mask</span><span class="p">[</span><span class="n">cfg_idx</span><span class="p">]</span> <span class="o">|=</span>
					<span class="n">PORT_HW_CFG_SPEED_CAPABILITY_D0_1G</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">advertising</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ADVERTISED_10000baseT_Full</span> <span class="o">|</span>
						<span class="n">ADVERTISED_10000baseKX4_Full</span> <span class="o">|</span>
						<span class="n">ADVERTISED_10000baseKR_Full</span><span class="p">))</span>
				<span class="n">bp</span><span class="o">-&gt;</span><span class="n">link_params</span><span class="p">.</span><span class="n">speed_cap_mask</span><span class="p">[</span><span class="n">cfg_idx</span><span class="p">]</span> <span class="o">|=</span>
					<span class="n">PORT_HW_CFG_SPEED_CAPABILITY_D0_10G</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="cm">/* forced speed */</span>
		<span class="cm">/* advertise the requested speed and duplex if supported */</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">speed</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">SPEED_10</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">duplex</span> <span class="o">==</span> <span class="n">DUPLEX_FULL</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">supported</span><span class="p">[</span><span class="n">cfg_idx</span><span class="p">]</span> <span class="o">&amp;</span>
				      <span class="n">SUPPORTED_10baseT_Full</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">DP</span><span class="p">(</span><span class="n">BNX2X_MSG_ETHTOOL</span><span class="p">,</span>
					   <span class="s">&quot;10M full not supported</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
					<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
				<span class="p">}</span>

				<span class="n">advertising</span> <span class="o">=</span> <span class="p">(</span><span class="n">ADVERTISED_10baseT_Full</span> <span class="o">|</span>
					       <span class="n">ADVERTISED_TP</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">supported</span><span class="p">[</span><span class="n">cfg_idx</span><span class="p">]</span> <span class="o">&amp;</span>
				      <span class="n">SUPPORTED_10baseT_Half</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">DP</span><span class="p">(</span><span class="n">BNX2X_MSG_ETHTOOL</span><span class="p">,</span>
					   <span class="s">&quot;10M half not supported</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
					<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
				<span class="p">}</span>

				<span class="n">advertising</span> <span class="o">=</span> <span class="p">(</span><span class="n">ADVERTISED_10baseT_Half</span> <span class="o">|</span>
					       <span class="n">ADVERTISED_TP</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">SPEED_100</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">duplex</span> <span class="o">==</span> <span class="n">DUPLEX_FULL</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">supported</span><span class="p">[</span><span class="n">cfg_idx</span><span class="p">]</span> <span class="o">&amp;</span>
						<span class="n">SUPPORTED_100baseT_Full</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">DP</span><span class="p">(</span><span class="n">BNX2X_MSG_ETHTOOL</span><span class="p">,</span>
					   <span class="s">&quot;100M full not supported</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
					<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
				<span class="p">}</span>

				<span class="n">advertising</span> <span class="o">=</span> <span class="p">(</span><span class="n">ADVERTISED_100baseT_Full</span> <span class="o">|</span>
					       <span class="n">ADVERTISED_TP</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">supported</span><span class="p">[</span><span class="n">cfg_idx</span><span class="p">]</span> <span class="o">&amp;</span>
						<span class="n">SUPPORTED_100baseT_Half</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">DP</span><span class="p">(</span><span class="n">BNX2X_MSG_ETHTOOL</span><span class="p">,</span>
					   <span class="s">&quot;100M half not supported</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
					<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
				<span class="p">}</span>

				<span class="n">advertising</span> <span class="o">=</span> <span class="p">(</span><span class="n">ADVERTISED_100baseT_Half</span> <span class="o">|</span>
					       <span class="n">ADVERTISED_TP</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">SPEED_1000</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">duplex</span> <span class="o">!=</span> <span class="n">DUPLEX_FULL</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">DP</span><span class="p">(</span><span class="n">BNX2X_MSG_ETHTOOL</span><span class="p">,</span>
				   <span class="s">&quot;1G half not supported</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">supported</span><span class="p">[</span><span class="n">cfg_idx</span><span class="p">]</span> <span class="o">&amp;</span>
			      <span class="n">SUPPORTED_1000baseT_Full</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">DP</span><span class="p">(</span><span class="n">BNX2X_MSG_ETHTOOL</span><span class="p">,</span>
				   <span class="s">&quot;1G full not supported</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">advertising</span> <span class="o">=</span> <span class="p">(</span><span class="n">ADVERTISED_1000baseT_Full</span> <span class="o">|</span>
				       <span class="n">ADVERTISED_TP</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">SPEED_2500</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">duplex</span> <span class="o">!=</span> <span class="n">DUPLEX_FULL</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">DP</span><span class="p">(</span><span class="n">BNX2X_MSG_ETHTOOL</span><span class="p">,</span>
				   <span class="s">&quot;2.5G half not supported</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">supported</span><span class="p">[</span><span class="n">cfg_idx</span><span class="p">]</span>
			      <span class="o">&amp;</span> <span class="n">SUPPORTED_2500baseX_Full</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">DP</span><span class="p">(</span><span class="n">BNX2X_MSG_ETHTOOL</span><span class="p">,</span>
				   <span class="s">&quot;2.5G full not supported</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">advertising</span> <span class="o">=</span> <span class="p">(</span><span class="n">ADVERTISED_2500baseX_Full</span> <span class="o">|</span>
				       <span class="n">ADVERTISED_TP</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">SPEED_10000</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">duplex</span> <span class="o">!=</span> <span class="n">DUPLEX_FULL</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">DP</span><span class="p">(</span><span class="n">BNX2X_MSG_ETHTOOL</span><span class="p">,</span>
				   <span class="s">&quot;10G half not supported</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">supported</span><span class="p">[</span><span class="n">cfg_idx</span><span class="p">]</span>
			      <span class="o">&amp;</span> <span class="n">SUPPORTED_10000baseT_Full</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">DP</span><span class="p">(</span><span class="n">BNX2X_MSG_ETHTOOL</span><span class="p">,</span>
				   <span class="s">&quot;10G full not supported</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">advertising</span> <span class="o">=</span> <span class="p">(</span><span class="n">ADVERTISED_10000baseT_Full</span> <span class="o">|</span>
				       <span class="n">ADVERTISED_FIBRE</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="nl">default:</span>
			<span class="n">DP</span><span class="p">(</span><span class="n">BNX2X_MSG_ETHTOOL</span><span class="p">,</span> <span class="s">&quot;Unsupported speed %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">speed</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">bp</span><span class="o">-&gt;</span><span class="n">link_params</span><span class="p">.</span><span class="n">req_line_speed</span><span class="p">[</span><span class="n">cfg_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">speed</span><span class="p">;</span>
		<span class="n">bp</span><span class="o">-&gt;</span><span class="n">link_params</span><span class="p">.</span><span class="n">req_duplex</span><span class="p">[</span><span class="n">cfg_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">duplex</span><span class="p">;</span>
		<span class="n">bp</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">advertising</span><span class="p">[</span><span class="n">cfg_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">advertising</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">DP</span><span class="p">(</span><span class="n">BNX2X_MSG_ETHTOOL</span><span class="p">,</span> <span class="s">&quot;req_line_speed %d</span><span class="se">\n</span><span class="s">&quot;</span>
	   <span class="s">&quot;  req_duplex %d  advertising 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	   <span class="n">bp</span><span class="o">-&gt;</span><span class="n">link_params</span><span class="p">.</span><span class="n">req_line_speed</span><span class="p">[</span><span class="n">cfg_idx</span><span class="p">],</span>
	   <span class="n">bp</span><span class="o">-&gt;</span><span class="n">link_params</span><span class="p">.</span><span class="n">req_duplex</span><span class="p">[</span><span class="n">cfg_idx</span><span class="p">],</span>
	   <span class="n">bp</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">advertising</span><span class="p">[</span><span class="n">cfg_idx</span><span class="p">]);</span>

	<span class="cm">/* Set new config */</span>
	<span class="n">bp</span><span class="o">-&gt;</span><span class="n">link_params</span><span class="p">.</span><span class="n">multi_phy_config</span> <span class="o">=</span> <span class="n">new_multi_phy_config</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">netif_running</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">bnx2x_stats_handle</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">STATS_EVENT_STOP</span><span class="p">);</span>
		<span class="n">bnx2x_link_set</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define IS_E1_ONLINE(info)	(((info) &amp; RI_E1_ONLINE) == RI_E1_ONLINE)</span>
<span class="cp">#define IS_E1H_ONLINE(info)	(((info) &amp; RI_E1H_ONLINE) == RI_E1H_ONLINE)</span>
<span class="cp">#define IS_E2_ONLINE(info)	(((info) &amp; RI_E2_ONLINE) == RI_E2_ONLINE)</span>
<span class="cp">#define IS_E3_ONLINE(info)	(((info) &amp; RI_E3_ONLINE) == RI_E3_ONLINE)</span>
<span class="cp">#define IS_E3B0_ONLINE(info)	(((info) &amp; RI_E3B0_ONLINE) == RI_E3B0_ONLINE)</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">bnx2x_is_reg_online</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">,</span>
				<span class="k">const</span> <span class="k">struct</span> <span class="n">reg_addr</span> <span class="o">*</span><span class="n">reg_info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">CHIP_IS_E1</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">IS_E1_ONLINE</span><span class="p">(</span><span class="n">reg_info</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">CHIP_IS_E1H</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">IS_E1H_ONLINE</span><span class="p">(</span><span class="n">reg_info</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">CHIP_IS_E2</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">IS_E2_ONLINE</span><span class="p">(</span><span class="n">reg_info</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">CHIP_IS_E3A0</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">IS_E3_ONLINE</span><span class="p">(</span><span class="n">reg_info</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">CHIP_IS_E3B0</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">IS_E3B0_ONLINE</span><span class="p">(</span><span class="n">reg_info</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/******* Paged registers info selectors ********/</span>
<span class="k">static</span> <span class="k">const</span> <span class="n">u32</span> <span class="o">*</span><span class="nf">__bnx2x_get_page_addr_ar</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">CHIP_IS_E2</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">page_vals_e2</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">CHIP_IS_E3</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">page_vals_e3</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">__bnx2x_get_page_reg_num</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">CHIP_IS_E2</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PAGE_MODE_VALUES_E2</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">CHIP_IS_E3</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PAGE_MODE_VALUES_E3</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">u32</span> <span class="o">*</span><span class="nf">__bnx2x_get_page_write_ar</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">CHIP_IS_E2</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">page_write_regs_e2</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">CHIP_IS_E3</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">page_write_regs_e3</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">__bnx2x_get_page_write_num</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">CHIP_IS_E2</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PAGE_WRITE_REGS_E2</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">CHIP_IS_E3</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PAGE_WRITE_REGS_E3</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">reg_addr</span> <span class="o">*</span><span class="nf">__bnx2x_get_page_read_ar</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">CHIP_IS_E2</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">page_read_regs_e2</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">CHIP_IS_E3</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">page_read_regs_e3</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">__bnx2x_get_page_read_num</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">CHIP_IS_E2</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PAGE_READ_REGS_E2</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">CHIP_IS_E3</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PAGE_READ_REGS_E3</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">__bnx2x_get_regs_len</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">num_pages</span> <span class="o">=</span> <span class="n">__bnx2x_get_page_reg_num</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">page_write_num</span> <span class="o">=</span> <span class="n">__bnx2x_get_page_write_num</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">reg_addr</span> <span class="o">*</span><span class="n">page_read_addr</span> <span class="o">=</span> <span class="n">__bnx2x_get_page_read_ar</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">page_read_num</span> <span class="o">=</span> <span class="n">__bnx2x_get_page_read_num</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">regdump_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">REGS_COUNT</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bnx2x_is_reg_online</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg_addrs</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
			<span class="n">regdump_len</span> <span class="o">+=</span> <span class="n">reg_addrs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">size</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num_pages</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">page_write_num</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">page_read_num</span><span class="p">;</span> <span class="n">k</span><span class="o">++</span><span class="p">)</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">bnx2x_is_reg_online</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">page_read_addr</span><span class="p">[</span><span class="n">k</span><span class="p">]))</span>
					<span class="n">regdump_len</span> <span class="o">+=</span> <span class="n">page_read_addr</span><span class="p">[</span><span class="n">k</span><span class="p">].</span><span class="n">size</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">regdump_len</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bnx2x_get_regs_len</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">regdump_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">regdump_len</span> <span class="o">=</span> <span class="n">__bnx2x_get_regs_len</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
	<span class="n">regdump_len</span> <span class="o">*=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">regdump_len</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">dump_hdr</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">regdump_len</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * bnx2x_read_pages_regs - read &quot;paged&quot; registers</span>
<span class="cm"> *</span>
<span class="cm"> * @bp		device handle</span>
<span class="cm"> * @p		output buffer</span>
<span class="cm"> *</span>
<span class="cm"> * Reads &quot;paged&quot; memories: memories that may only be read by first writing to a</span>
<span class="cm"> * specific address (&quot;write address&quot;) and then reading from a specific address</span>
<span class="cm"> * (&quot;read address&quot;). There may be more than one write address per &quot;page&quot; and</span>
<span class="cm"> * more than one read address per write address.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_read_pages_regs</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">n</span><span class="p">;</span>
	<span class="cm">/* addresses of the paged registers */</span>
	<span class="k">const</span> <span class="n">u32</span> <span class="o">*</span><span class="n">page_addr</span> <span class="o">=</span> <span class="n">__bnx2x_get_page_addr_ar</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
	<span class="cm">/* number of paged registers */</span>
	<span class="kt">int</span> <span class="n">num_pages</span> <span class="o">=</span> <span class="n">__bnx2x_get_page_reg_num</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
	<span class="cm">/* write addresses */</span>
	<span class="k">const</span> <span class="n">u32</span> <span class="o">*</span><span class="n">write_addr</span> <span class="o">=</span> <span class="n">__bnx2x_get_page_write_ar</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
	<span class="cm">/* number of write addresses */</span>
	<span class="kt">int</span> <span class="n">write_num</span> <span class="o">=</span> <span class="n">__bnx2x_get_page_write_num</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
	<span class="cm">/* read addresses info */</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">reg_addr</span> <span class="o">*</span><span class="n">read_addr</span> <span class="o">=</span> <span class="n">__bnx2x_get_page_read_ar</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
	<span class="cm">/* number of read addresses */</span>
	<span class="kt">int</span> <span class="n">read_num</span> <span class="o">=</span> <span class="n">__bnx2x_get_page_read_num</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num_pages</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">write_num</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">write_addr</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">page_addr</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">read_num</span><span class="p">;</span> <span class="n">k</span><span class="o">++</span><span class="p">)</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">bnx2x_is_reg_online</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">read_addr</span><span class="p">[</span><span class="n">k</span><span class="p">]))</span>
					<span class="k">for</span> <span class="p">(</span><span class="n">n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">n</span> <span class="o">&lt;</span>
					      <span class="n">read_addr</span><span class="p">[</span><span class="n">k</span><span class="p">].</span><span class="n">size</span><span class="p">;</span> <span class="n">n</span><span class="o">++</span><span class="p">)</span>
						<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span>
						       <span class="n">read_addr</span><span class="p">[</span><span class="n">k</span><span class="p">].</span><span class="n">addr</span> <span class="o">+</span> <span class="n">n</span><span class="o">*</span><span class="mi">4</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">__bnx2x_get_regs</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>

	<span class="cm">/* Read the regular registers */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">REGS_COUNT</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bnx2x_is_reg_online</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg_addrs</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">reg_addrs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">size</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
				<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">reg_addrs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">addr</span> <span class="o">+</span> <span class="n">j</span><span class="o">*</span><span class="mi">4</span><span class="p">);</span>

	<span class="cm">/* Read &quot;paged&quot; registes */</span>
	<span class="n">bnx2x_read_pages_regs</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_get_regs</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">ethtool_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">_p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">_p</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">dump_hdr</span> <span class="n">dump_hdr</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>

	<span class="n">regs</span><span class="o">-&gt;</span><span class="n">version</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">netif_running</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* Disable parity attentions as long as following dump may</span>
<span class="cm">	 * cause false alarms by reading never written registers. We</span>
<span class="cm">	 * will re-enable parity attentions right after the dump.</span>
<span class="cm">	 */</span>
	<span class="n">bnx2x_disable_blocks_parity</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>

	<span class="n">dump_hdr</span><span class="p">.</span><span class="n">hdr_size</span> <span class="o">=</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">dump_hdr</span><span class="p">)</span> <span class="o">/</span> <span class="mi">4</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">dump_hdr</span><span class="p">.</span><span class="n">dump_sign</span> <span class="o">=</span> <span class="n">dump_sign_all</span><span class="p">;</span>
	<span class="n">dump_hdr</span><span class="p">.</span><span class="n">xstorm_waitp</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">XSTORM_WAITP_ADDR</span><span class="p">);</span>
	<span class="n">dump_hdr</span><span class="p">.</span><span class="n">tstorm_waitp</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">TSTORM_WAITP_ADDR</span><span class="p">);</span>
	<span class="n">dump_hdr</span><span class="p">.</span><span class="n">ustorm_waitp</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">USTORM_WAITP_ADDR</span><span class="p">);</span>
	<span class="n">dump_hdr</span><span class="p">.</span><span class="n">cstorm_waitp</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">CSTORM_WAITP_ADDR</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">CHIP_IS_E1</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span>
		<span class="n">dump_hdr</span><span class="p">.</span><span class="n">info</span> <span class="o">=</span> <span class="n">RI_E1_ONLINE</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">CHIP_IS_E1H</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span>
		<span class="n">dump_hdr</span><span class="p">.</span><span class="n">info</span> <span class="o">=</span> <span class="n">RI_E1H_ONLINE</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CHIP_IS_E1x</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span>
		<span class="n">dump_hdr</span><span class="p">.</span><span class="n">info</span> <span class="o">=</span> <span class="n">RI_E2_ONLINE</span> <span class="o">|</span>
		<span class="p">(</span><span class="n">BP_PATH</span><span class="p">(</span><span class="n">bp</span><span class="p">)</span> <span class="o">?</span> <span class="n">RI_PATH1_DUMP</span> <span class="o">:</span> <span class="n">RI_PATH0_DUMP</span><span class="p">);</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dump_hdr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">dump_hdr</span><span class="p">));</span>
	<span class="n">p</span> <span class="o">+=</span> <span class="n">dump_hdr</span><span class="p">.</span><span class="n">hdr_size</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* Actually read the registers */</span>
	<span class="n">__bnx2x_get_regs</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>

	<span class="cm">/* Re-enable parity attentions */</span>
	<span class="n">bnx2x_clear_blocks_parity</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
	<span class="n">bnx2x_enable_blocks_parity</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_get_drvinfo</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">ethtool_drvinfo</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">phy_fw_ver</span><span class="p">[</span><span class="n">PHY_FW_VER_LEN</span><span class="p">];</span>

	<span class="n">strlcpy</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">,</span> <span class="n">DRV_MODULE_NAME</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">));</span>
	<span class="n">strlcpy</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">,</span> <span class="n">DRV_MODULE_VERSION</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">));</span>

	<span class="n">phy_fw_ver</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
	<span class="n">bnx2x_get_ext_phy_fw_version</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">link_params</span><span class="p">,</span>
				     <span class="n">phy_fw_ver</span><span class="p">,</span> <span class="n">PHY_FW_VER_LEN</span><span class="p">);</span>
	<span class="n">strlcpy</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">fw_version</span><span class="p">,</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">fw_ver</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">fw_version</span><span class="p">));</span>
	<span class="n">snprintf</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">fw_version</span> <span class="o">+</span> <span class="n">strlen</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">fw_ver</span><span class="p">),</span> <span class="mi">32</span> <span class="o">-</span> <span class="n">strlen</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">fw_ver</span><span class="p">),</span>
		 <span class="s">&quot;bc %d.%d.%d%s%s&quot;</span><span class="p">,</span>
		 <span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">.</span><span class="n">bc_ver</span> <span class="o">&amp;</span> <span class="mh">0xff0000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">,</span>
		 <span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">.</span><span class="n">bc_ver</span> <span class="o">&amp;</span> <span class="mh">0xff00</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">,</span>
		 <span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">.</span><span class="n">bc_ver</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">),</span>
		 <span class="p">((</span><span class="n">phy_fw_ver</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">&#39;\0&#39;</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; phy &quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">),</span> <span class="n">phy_fw_ver</span><span class="p">);</span>
	<span class="n">strlcpy</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">bus_info</span><span class="p">,</span> <span class="n">pci_name</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">),</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">bus_info</span><span class="p">));</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">n_stats</span> <span class="o">=</span> <span class="n">BNX2X_NUM_STATS</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">testinfo_len</span> <span class="o">=</span> <span class="n">BNX2X_NUM_TESTS</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">eedump_len</span> <span class="o">=</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">.</span><span class="n">flash_size</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">regdump_len</span> <span class="o">=</span> <span class="n">bnx2x_get_regs_len</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_get_wol</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ethtool_wolinfo</span> <span class="o">*</span><span class="n">wol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">NO_WOL_FLAG</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wol</span><span class="o">-&gt;</span><span class="n">supported</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">wol</span><span class="o">-&gt;</span><span class="n">wolopts</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">wol</span><span class="o">-&gt;</span><span class="n">supported</span> <span class="o">=</span> <span class="n">WAKE_MAGIC</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">wol</span><span class="p">)</span>
			<span class="n">wol</span><span class="o">-&gt;</span><span class="n">wolopts</span> <span class="o">=</span> <span class="n">WAKE_MAGIC</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">wol</span><span class="o">-&gt;</span><span class="n">wolopts</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wol</span><span class="o">-&gt;</span><span class="n">sopass</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">wol</span><span class="o">-&gt;</span><span class="n">sopass</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bnx2x_set_wol</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ethtool_wolinfo</span> <span class="o">*</span><span class="n">wol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wol</span><span class="o">-&gt;</span><span class="n">wolopts</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">WAKE_MAGIC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DP</span><span class="p">(</span><span class="n">BNX2X_MSG_ETHTOOL</span><span class="p">,</span> <span class="s">&quot;WOL not supproted</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wol</span><span class="o">-&gt;</span><span class="n">wolopts</span> <span class="o">&amp;</span> <span class="n">WAKE_MAGIC</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">NO_WOL_FLAG</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DP</span><span class="p">(</span><span class="n">BNX2X_MSG_ETHTOOL</span><span class="p">,</span> <span class="s">&quot;WOL not supproted</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">bp</span><span class="o">-&gt;</span><span class="n">wol</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">bp</span><span class="o">-&gt;</span><span class="n">wol</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">bnx2x_get_msglevel</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">msg_enable</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_set_msglevel</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">level</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_NET_ADMIN</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* dump MCP trace */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">level</span> <span class="o">&amp;</span> <span class="n">BNX2X_MSG_MCP</span><span class="p">)</span>
			<span class="n">bnx2x_fw_dump_lvl</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="p">);</span>
		<span class="n">bp</span><span class="o">-&gt;</span><span class="n">msg_enable</span> <span class="o">=</span> <span class="n">level</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bnx2x_nway_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">pmf</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">netif_running</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">bnx2x_stats_handle</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">STATS_EVENT_STOP</span><span class="p">);</span>
		<span class="n">bnx2x_link_set</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">bnx2x_get_link</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MF_FUNC_DIS</span> <span class="o">||</span> <span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">BNX2X_STATE_OPEN</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">link_vars</span><span class="p">.</span><span class="n">link_up</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bnx2x_get_eeprom_len</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">.</span><span class="n">flash_size</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Per pf misc lock must be aquired before the per port mcp lock. Otherwise, had</span>
<span class="cm"> * we done things the other way around, if two pfs from the same port would</span>
<span class="cm"> * attempt to access nvram at the same time, we could run into a scenario such</span>
<span class="cm"> * as:</span>
<span class="cm"> * pf A takes the port lock.</span>
<span class="cm"> * pf B succeeds in taking the same lock since they are from the same port.</span>
<span class="cm"> * pf A takes the per pf misc lock. Performs eeprom access.</span>
<span class="cm"> * pf A finishes. Unlocks the per pf misc lock.</span>
<span class="cm"> * Pf B takes the lock and proceeds to perform it&#39;s own access.</span>
<span class="cm"> * pf A unlocks the per port lock, while pf B is still working (!).</span>
<span class="cm"> * mcp takes the per port lock and corrupts pf B&#39;s access (and/or has it&#39;s own</span>
<span class="cm"> * acess corrupted by pf B).*</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">bnx2x_acquire_nvram_lock</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">port</span> <span class="o">=</span> <span class="n">BP_PORT</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">count</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>

	<span class="cm">/* acquire HW lock: protect against other PFs in PF Direct Assignment */</span>
	<span class="n">bnx2x_acquire_hw_lock</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">HW_LOCK_RESOURCE_NVRAM</span><span class="p">);</span>

	<span class="cm">/* adjust timeout for emulation/FPGA */</span>
	<span class="n">count</span> <span class="o">=</span> <span class="n">BNX2X_NVRAM_TIMEOUT_COUNT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">CHIP_REV_IS_SLOW</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span>
		<span class="n">count</span> <span class="o">*=</span> <span class="mi">100</span><span class="p">;</span>

	<span class="cm">/* request access to nvram interface */</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">MCP_REG_MCPR_NVM_SW_ARB</span><span class="p">,</span>
	       <span class="p">(</span><span class="n">MCPR_NVM_SW_ARB_ARB_REQ_SET1</span> <span class="o">&lt;&lt;</span> <span class="n">port</span><span class="p">));</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">count</span><span class="o">*</span><span class="mi">10</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">MCP_REG_MCPR_NVM_SW_ARB</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">MCPR_NVM_SW_ARB_ARB_ARB1</span> <span class="o">&lt;&lt;</span> <span class="n">port</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">udelay</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">MCPR_NVM_SW_ARB_ARB_ARB1</span> <span class="o">&lt;&lt;</span> <span class="n">port</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">DP</span><span class="p">(</span><span class="n">BNX2X_MSG_ETHTOOL</span> <span class="o">|</span> <span class="n">BNX2X_MSG_NVM</span><span class="p">,</span>
		   <span class="s">&quot;cannot get access to nvram interface</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bnx2x_release_nvram_lock</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">port</span> <span class="o">=</span> <span class="n">BP_PORT</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">count</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>

	<span class="cm">/* adjust timeout for emulation/FPGA */</span>
	<span class="n">count</span> <span class="o">=</span> <span class="n">BNX2X_NVRAM_TIMEOUT_COUNT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">CHIP_REV_IS_SLOW</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span>
		<span class="n">count</span> <span class="o">*=</span> <span class="mi">100</span><span class="p">;</span>

	<span class="cm">/* relinquish nvram interface */</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">MCP_REG_MCPR_NVM_SW_ARB</span><span class="p">,</span>
	       <span class="p">(</span><span class="n">MCPR_NVM_SW_ARB_ARB_REQ_CLR1</span> <span class="o">&lt;&lt;</span> <span class="n">port</span><span class="p">));</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">count</span><span class="o">*</span><span class="mi">10</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">MCP_REG_MCPR_NVM_SW_ARB</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">MCPR_NVM_SW_ARB_ARB_ARB1</span> <span class="o">&lt;&lt;</span> <span class="n">port</span><span class="p">)))</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">udelay</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">MCPR_NVM_SW_ARB_ARB_ARB1</span> <span class="o">&lt;&lt;</span> <span class="n">port</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DP</span><span class="p">(</span><span class="n">BNX2X_MSG_ETHTOOL</span> <span class="o">|</span> <span class="n">BNX2X_MSG_NVM</span><span class="p">,</span>
		   <span class="s">&quot;cannot free access to nvram interface</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* release HW lock: protect against other PFs in PF Direct Assignment */</span>
	<span class="n">bnx2x_release_hw_lock</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">HW_LOCK_RESOURCE_NVRAM</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_enable_nvram_access</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">MCP_REG_MCPR_NVM_ACCESS_ENABLE</span><span class="p">);</span>

	<span class="cm">/* enable both bits, even on read */</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">MCP_REG_MCPR_NVM_ACCESS_ENABLE</span><span class="p">,</span>
	       <span class="p">(</span><span class="n">val</span> <span class="o">|</span> <span class="n">MCPR_NVM_ACCESS_ENABLE_EN</span> <span class="o">|</span>
		      <span class="n">MCPR_NVM_ACCESS_ENABLE_WR_EN</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_disable_nvram_access</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">MCP_REG_MCPR_NVM_ACCESS_ENABLE</span><span class="p">);</span>

	<span class="cm">/* disable both bits, even after read */</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">MCP_REG_MCPR_NVM_ACCESS_ENABLE</span><span class="p">,</span>
	       <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">MCPR_NVM_ACCESS_ENABLE_EN</span> <span class="o">|</span>
			<span class="n">MCPR_NVM_ACCESS_ENABLE_WR_EN</span><span class="p">)));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bnx2x_nvram_read_dword</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">,</span> <span class="n">u32</span> <span class="n">offset</span><span class="p">,</span> <span class="n">__be32</span> <span class="o">*</span><span class="n">ret_val</span><span class="p">,</span>
				  <span class="n">u32</span> <span class="n">cmd_flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">count</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">rc</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>

	<span class="cm">/* build the command word */</span>
	<span class="n">cmd_flags</span> <span class="o">|=</span> <span class="n">MCPR_NVM_COMMAND_DOIT</span><span class="p">;</span>

	<span class="cm">/* need to clear DONE bit separately */</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">MCP_REG_MCPR_NVM_COMMAND</span><span class="p">,</span> <span class="n">MCPR_NVM_COMMAND_DONE</span><span class="p">);</span>

	<span class="cm">/* address of the NVRAM to read from */</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">MCP_REG_MCPR_NVM_ADDR</span><span class="p">,</span>
	       <span class="p">(</span><span class="n">offset</span> <span class="o">&amp;</span> <span class="n">MCPR_NVM_ADDR_NVM_ADDR_VALUE</span><span class="p">));</span>

	<span class="cm">/* issue a read command */</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">MCP_REG_MCPR_NVM_COMMAND</span><span class="p">,</span> <span class="n">cmd_flags</span><span class="p">);</span>

	<span class="cm">/* adjust timeout for emulation/FPGA */</span>
	<span class="n">count</span> <span class="o">=</span> <span class="n">BNX2X_NVRAM_TIMEOUT_COUNT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">CHIP_REV_IS_SLOW</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span>
		<span class="n">count</span> <span class="o">*=</span> <span class="mi">100</span><span class="p">;</span>

	<span class="cm">/* wait for completion */</span>
	<span class="o">*</span><span class="n">ret_val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">MCP_REG_MCPR_NVM_COMMAND</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">MCPR_NVM_COMMAND_DONE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">val</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">MCP_REG_MCPR_NVM_READ</span><span class="p">);</span>
			<span class="cm">/* we read nvram data in cpu order</span>
<span class="cm">			 * but ethtool sees it as an array of bytes</span>
<span class="cm">			 * converting to big-endian will do the work */</span>
			<span class="o">*</span><span class="n">ret_val</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">val</span><span class="p">);</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">)</span>
		<span class="n">DP</span><span class="p">(</span><span class="n">BNX2X_MSG_ETHTOOL</span> <span class="o">|</span> <span class="n">BNX2X_MSG_NVM</span><span class="p">,</span>
		   <span class="s">&quot;nvram read timeout expired</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bnx2x_nvram_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">,</span> <span class="n">u32</span> <span class="n">offset</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">ret_buf</span><span class="p">,</span>
			    <span class="kt">int</span> <span class="n">buf_size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">cmd_flags</span><span class="p">;</span>
	<span class="n">__be32</span> <span class="n">val</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">offset</span> <span class="o">&amp;</span> <span class="mh">0x03</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">buf_size</span> <span class="o">&amp;</span> <span class="mh">0x03</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">buf_size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DP</span><span class="p">(</span><span class="n">BNX2X_MSG_ETHTOOL</span> <span class="o">|</span> <span class="n">BNX2X_MSG_NVM</span><span class="p">,</span>
		   <span class="s">&quot;Invalid parameter: offset 0x%x  buf_size 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">offset</span><span class="p">,</span> <span class="n">buf_size</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">offset</span> <span class="o">+</span> <span class="n">buf_size</span> <span class="o">&gt;</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">.</span><span class="n">flash_size</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DP</span><span class="p">(</span><span class="n">BNX2X_MSG_ETHTOOL</span> <span class="o">|</span> <span class="n">BNX2X_MSG_NVM</span><span class="p">,</span>
		   <span class="s">&quot;Invalid parameter: offset (0x%x) + buf_size (0x%x) &gt; flash_size (0x%x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">offset</span><span class="p">,</span> <span class="n">buf_size</span><span class="p">,</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">.</span><span class="n">flash_size</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* request access to nvram interface */</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">bnx2x_acquire_nvram_lock</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="cm">/* enable access to nvram interface */</span>
	<span class="n">bnx2x_enable_nvram_access</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>

	<span class="cm">/* read the first word(s) */</span>
	<span class="n">cmd_flags</span> <span class="o">=</span> <span class="n">MCPR_NVM_COMMAND_FIRST</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">buf_size</span> <span class="o">&gt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">))</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">bnx2x_nvram_read_dword</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">,</span> <span class="n">cmd_flags</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">ret_buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>

		<span class="cm">/* advance to the next dword */</span>
		<span class="n">offset</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">);</span>
		<span class="n">ret_buf</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">);</span>
		<span class="n">buf_size</span> <span class="o">-=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">);</span>
		<span class="n">cmd_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cmd_flags</span> <span class="o">|=</span> <span class="n">MCPR_NVM_COMMAND_LAST</span><span class="p">;</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">bnx2x_nvram_read_dword</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">,</span> <span class="n">cmd_flags</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">ret_buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* disable access to nvram interface */</span>
	<span class="n">bnx2x_disable_nvram_access</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
	<span class="n">bnx2x_release_nvram_lock</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bnx2x_get_eeprom</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">ethtool_eeprom</span> <span class="o">*</span><span class="n">eeprom</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">eebuf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">netif_running</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DP</span><span class="p">(</span><span class="n">BNX2X_MSG_ETHTOOL</span>  <span class="o">|</span> <span class="n">BNX2X_MSG_NVM</span><span class="p">,</span>
		   <span class="s">&quot;cannot access eeprom when the interface is down</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">DP</span><span class="p">(</span><span class="n">BNX2X_MSG_ETHTOOL</span> <span class="o">|</span> <span class="n">BNX2X_MSG_NVM</span><span class="p">,</span> <span class="s">&quot;ethtool_eeprom: cmd %d</span><span class="se">\n</span><span class="s">&quot;</span>
	   <span class="s">&quot;  magic 0x%x  offset 0x%x (%d)  len 0x%x (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	   <span class="n">eeprom</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">,</span> <span class="n">eeprom</span><span class="o">-&gt;</span><span class="n">magic</span><span class="p">,</span> <span class="n">eeprom</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">,</span> <span class="n">eeprom</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">,</span>
	   <span class="n">eeprom</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">eeprom</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>

	<span class="cm">/* parameters already validated in ethtool_get_eeprom */</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">bnx2x_nvram_read</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">eeprom</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">,</span> <span class="n">eebuf</span><span class="p">,</span> <span class="n">eeprom</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bnx2x_nvram_write_dword</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">,</span> <span class="n">u32</span> <span class="n">offset</span><span class="p">,</span> <span class="n">u32</span> <span class="n">val</span><span class="p">,</span>
				   <span class="n">u32</span> <span class="n">cmd_flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">count</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">rc</span><span class="p">;</span>

	<span class="cm">/* build the command word */</span>
	<span class="n">cmd_flags</span> <span class="o">|=</span> <span class="n">MCPR_NVM_COMMAND_DOIT</span> <span class="o">|</span> <span class="n">MCPR_NVM_COMMAND_WR</span><span class="p">;</span>

	<span class="cm">/* need to clear DONE bit separately */</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">MCP_REG_MCPR_NVM_COMMAND</span><span class="p">,</span> <span class="n">MCPR_NVM_COMMAND_DONE</span><span class="p">);</span>

	<span class="cm">/* write the data */</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">MCP_REG_MCPR_NVM_WRITE</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

	<span class="cm">/* address of the NVRAM to write to */</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">MCP_REG_MCPR_NVM_ADDR</span><span class="p">,</span>
	       <span class="p">(</span><span class="n">offset</span> <span class="o">&amp;</span> <span class="n">MCPR_NVM_ADDR_NVM_ADDR_VALUE</span><span class="p">));</span>

	<span class="cm">/* issue the write command */</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">MCP_REG_MCPR_NVM_COMMAND</span><span class="p">,</span> <span class="n">cmd_flags</span><span class="p">);</span>

	<span class="cm">/* adjust timeout for emulation/FPGA */</span>
	<span class="n">count</span> <span class="o">=</span> <span class="n">BNX2X_NVRAM_TIMEOUT_COUNT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">CHIP_REV_IS_SLOW</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span>
		<span class="n">count</span> <span class="o">*=</span> <span class="mi">100</span><span class="p">;</span>

	<span class="cm">/* wait for completion */</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">MCP_REG_MCPR_NVM_COMMAND</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">MCPR_NVM_COMMAND_DONE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">)</span>
		<span class="n">DP</span><span class="p">(</span><span class="n">BNX2X_MSG_ETHTOOL</span> <span class="o">|</span> <span class="n">BNX2X_MSG_NVM</span><span class="p">,</span>
		   <span class="s">&quot;nvram write timeout expired</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define BYTE_OFFSET(offset)		(8 * (offset &amp; 0x03))</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bnx2x_nvram_write1</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">,</span> <span class="n">u32</span> <span class="n">offset</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">data_buf</span><span class="p">,</span>
			      <span class="kt">int</span> <span class="n">buf_size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">cmd_flags</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">align_offset</span><span class="p">;</span>
	<span class="n">__be32</span> <span class="n">val</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">offset</span> <span class="o">+</span> <span class="n">buf_size</span> <span class="o">&gt;</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">.</span><span class="n">flash_size</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DP</span><span class="p">(</span><span class="n">BNX2X_MSG_ETHTOOL</span> <span class="o">|</span> <span class="n">BNX2X_MSG_NVM</span><span class="p">,</span>
		   <span class="s">&quot;Invalid parameter: offset (0x%x) + buf_size (0x%x) &gt; flash_size (0x%x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">offset</span><span class="p">,</span> <span class="n">buf_size</span><span class="p">,</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">.</span><span class="n">flash_size</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* request access to nvram interface */</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">bnx2x_acquire_nvram_lock</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="cm">/* enable access to nvram interface */</span>
	<span class="n">bnx2x_enable_nvram_access</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>

	<span class="n">cmd_flags</span> <span class="o">=</span> <span class="p">(</span><span class="n">MCPR_NVM_COMMAND_FIRST</span> <span class="o">|</span> <span class="n">MCPR_NVM_COMMAND_LAST</span><span class="p">);</span>
	<span class="n">align_offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">offset</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x03</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">bnx2x_nvram_read_dword</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">align_offset</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">,</span> <span class="n">cmd_flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mh">0xff</span> <span class="o">&lt;&lt;</span> <span class="n">BYTE_OFFSET</span><span class="p">(</span><span class="n">offset</span><span class="p">));</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="p">(</span><span class="o">*</span><span class="n">data_buf</span> <span class="o">&lt;&lt;</span> <span class="n">BYTE_OFFSET</span><span class="p">(</span><span class="n">offset</span><span class="p">));</span>

		<span class="cm">/* nvram data is returned as an array of bytes</span>
<span class="cm">		 * convert it back to cpu order */</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">val</span><span class="p">);</span>

		<span class="n">rc</span> <span class="o">=</span> <span class="n">bnx2x_nvram_write_dword</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">align_offset</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span>
					     <span class="n">cmd_flags</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* disable access to nvram interface */</span>
	<span class="n">bnx2x_disable_nvram_access</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
	<span class="n">bnx2x_release_nvram_lock</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bnx2x_nvram_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">,</span> <span class="n">u32</span> <span class="n">offset</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">data_buf</span><span class="p">,</span>
			     <span class="kt">int</span> <span class="n">buf_size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">cmd_flags</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">written_so_far</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">buf_size</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>	<span class="cm">/* ethtool */</span>
		<span class="k">return</span> <span class="n">bnx2x_nvram_write1</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">data_buf</span><span class="p">,</span> <span class="n">buf_size</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">offset</span> <span class="o">&amp;</span> <span class="mh">0x03</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">buf_size</span> <span class="o">&amp;</span> <span class="mh">0x03</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">buf_size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DP</span><span class="p">(</span><span class="n">BNX2X_MSG_ETHTOOL</span> <span class="o">|</span> <span class="n">BNX2X_MSG_NVM</span><span class="p">,</span>
		   <span class="s">&quot;Invalid parameter: offset 0x%x  buf_size 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">offset</span><span class="p">,</span> <span class="n">buf_size</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">offset</span> <span class="o">+</span> <span class="n">buf_size</span> <span class="o">&gt;</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">.</span><span class="n">flash_size</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DP</span><span class="p">(</span><span class="n">BNX2X_MSG_ETHTOOL</span> <span class="o">|</span> <span class="n">BNX2X_MSG_NVM</span><span class="p">,</span>
		   <span class="s">&quot;Invalid parameter: offset (0x%x) + buf_size (0x%x) &gt; flash_size (0x%x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">offset</span><span class="p">,</span> <span class="n">buf_size</span><span class="p">,</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">.</span><span class="n">flash_size</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* request access to nvram interface */</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">bnx2x_acquire_nvram_lock</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="cm">/* enable access to nvram interface */</span>
	<span class="n">bnx2x_enable_nvram_access</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>

	<span class="n">written_so_far</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cmd_flags</span> <span class="o">=</span> <span class="n">MCPR_NVM_COMMAND_FIRST</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">written_so_far</span> <span class="o">&lt;</span> <span class="n">buf_size</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">written_so_far</span> <span class="o">==</span> <span class="p">(</span><span class="n">buf_size</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">)))</span>
			<span class="n">cmd_flags</span> <span class="o">|=</span> <span class="n">MCPR_NVM_COMMAND_LAST</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(((</span><span class="n">offset</span> <span class="o">+</span> <span class="mi">4</span><span class="p">)</span> <span class="o">%</span> <span class="n">BNX2X_NVRAM_PAGE_SIZE</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">cmd_flags</span> <span class="o">|=</span> <span class="n">MCPR_NVM_COMMAND_LAST</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">offset</span> <span class="o">%</span> <span class="n">BNX2X_NVRAM_PAGE_SIZE</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">cmd_flags</span> <span class="o">|=</span> <span class="n">MCPR_NVM_COMMAND_FIRST</span><span class="p">;</span>

		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">val</span><span class="p">,</span> <span class="n">data_buf</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>

		<span class="n">rc</span> <span class="o">=</span> <span class="n">bnx2x_nvram_write_dword</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">cmd_flags</span><span class="p">);</span>

		<span class="cm">/* advance to the next dword */</span>
		<span class="n">offset</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">);</span>
		<span class="n">data_buf</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">);</span>
		<span class="n">written_so_far</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">);</span>
		<span class="n">cmd_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* disable access to nvram interface */</span>
	<span class="n">bnx2x_disable_nvram_access</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
	<span class="n">bnx2x_release_nvram_lock</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bnx2x_set_eeprom</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">ethtool_eeprom</span> <span class="o">*</span><span class="n">eeprom</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">eebuf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">port</span> <span class="o">=</span> <span class="n">BP_PORT</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ext_phy_config</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">netif_running</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DP</span><span class="p">(</span><span class="n">BNX2X_MSG_ETHTOOL</span> <span class="o">|</span> <span class="n">BNX2X_MSG_NVM</span><span class="p">,</span>
		   <span class="s">&quot;cannot access eeprom when the interface is down</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">DP</span><span class="p">(</span><span class="n">BNX2X_MSG_ETHTOOL</span> <span class="o">|</span> <span class="n">BNX2X_MSG_NVM</span><span class="p">,</span> <span class="s">&quot;ethtool_eeprom: cmd %d</span><span class="se">\n</span><span class="s">&quot;</span>
	   <span class="s">&quot;  magic 0x%x  offset 0x%x (%d)  len 0x%x (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	   <span class="n">eeprom</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">,</span> <span class="n">eeprom</span><span class="o">-&gt;</span><span class="n">magic</span><span class="p">,</span> <span class="n">eeprom</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">,</span> <span class="n">eeprom</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">,</span>
	   <span class="n">eeprom</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">eeprom</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>

	<span class="cm">/* parameters already validated in ethtool_set_eeprom */</span>

	<span class="cm">/* PHY eeprom can be accessed only by the PMF */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">eeprom</span><span class="o">-&gt;</span><span class="n">magic</span> <span class="o">&gt;=</span> <span class="mh">0x50485900</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">eeprom</span><span class="o">-&gt;</span><span class="n">magic</span> <span class="o">&lt;=</span> <span class="mh">0x504859FF</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">pmf</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DP</span><span class="p">(</span><span class="n">BNX2X_MSG_ETHTOOL</span> <span class="o">|</span> <span class="n">BNX2X_MSG_NVM</span><span class="p">,</span>
		   <span class="s">&quot;wrong magic or interface is not pmf</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ext_phy_config</span> <span class="o">=</span>
		<span class="n">SHMEM_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span>
			 <span class="n">dev_info</span><span class="p">.</span><span class="n">port_hw_config</span><span class="p">[</span><span class="n">port</span><span class="p">].</span><span class="n">external_phy_config</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">eeprom</span><span class="o">-&gt;</span><span class="n">magic</span> <span class="o">==</span> <span class="mh">0x50485950</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* &#39;PHYP&#39; (0x50485950): prepare phy for FW upgrade */</span>
		<span class="n">bnx2x_stats_handle</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">STATS_EVENT_STOP</span><span class="p">);</span>

		<span class="n">bnx2x_acquire_phy_lock</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">|=</span> <span class="n">bnx2x_link_reset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">link_params</span><span class="p">,</span>
				       <span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">link_vars</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">XGXS_EXT_PHY_TYPE</span><span class="p">(</span><span class="n">ext_phy_config</span><span class="p">)</span> <span class="o">==</span>
					<span class="n">PORT_HW_CFG_XGXS_EXT_PHY_TYPE_SFX7101</span><span class="p">)</span>
			<span class="n">bnx2x_set_gpio</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">MISC_REGISTERS_GPIO_0</span><span class="p">,</span>
				       <span class="n">MISC_REGISTERS_GPIO_HIGH</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>
		<span class="n">bnx2x_release_phy_lock</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
		<span class="n">bnx2x_link_report</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>

	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">eeprom</span><span class="o">-&gt;</span><span class="n">magic</span> <span class="o">==</span> <span class="mh">0x50485952</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* &#39;PHYR&#39; (0x50485952): re-init link after FW upgrade */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">BNX2X_STATE_OPEN</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">bnx2x_acquire_phy_lock</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
			<span class="n">rc</span> <span class="o">|=</span> <span class="n">bnx2x_link_reset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">link_params</span><span class="p">,</span>
					       <span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">link_vars</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

			<span class="n">rc</span> <span class="o">|=</span> <span class="n">bnx2x_phy_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">link_params</span><span class="p">,</span>
					     <span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">link_vars</span><span class="p">);</span>
			<span class="n">bnx2x_release_phy_lock</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
			<span class="n">bnx2x_calc_fc_adv</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">eeprom</span><span class="o">-&gt;</span><span class="n">magic</span> <span class="o">==</span> <span class="mh">0x53985943</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* &#39;PHYC&#39; (0x53985943): PHY FW upgrade completed */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">XGXS_EXT_PHY_TYPE</span><span class="p">(</span><span class="n">ext_phy_config</span><span class="p">)</span> <span class="o">==</span>
				       <span class="n">PORT_HW_CFG_XGXS_EXT_PHY_TYPE_SFX7101</span><span class="p">)</span> <span class="p">{</span>

			<span class="cm">/* DSP Remove Download Mode */</span>
			<span class="n">bnx2x_set_gpio</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">MISC_REGISTERS_GPIO_0</span><span class="p">,</span>
				       <span class="n">MISC_REGISTERS_GPIO_LOW</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>

			<span class="n">bnx2x_acquire_phy_lock</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>

			<span class="n">bnx2x_sfx7101_sp_sw_reset</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">link_params</span><span class="p">.</span><span class="n">phy</span><span class="p">[</span><span class="n">EXT_PHY1</span><span class="p">]);</span>

			<span class="cm">/* wait 0.5 sec to allow it to run */</span>
			<span class="n">msleep</span><span class="p">(</span><span class="mi">500</span><span class="p">);</span>
			<span class="n">bnx2x_ext_phy_hw_reset</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>
			<span class="n">msleep</span><span class="p">(</span><span class="mi">500</span><span class="p">);</span>
			<span class="n">bnx2x_release_phy_lock</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">bnx2x_nvram_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">eeprom</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">,</span> <span class="n">eebuf</span><span class="p">,</span> <span class="n">eeprom</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bnx2x_get_coalesce</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">ethtool_coalesce</span> <span class="o">*</span><span class="n">coal</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">coal</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ethtool_coalesce</span><span class="p">));</span>

	<span class="n">coal</span><span class="o">-&gt;</span><span class="n">rx_coalesce_usecs</span> <span class="o">=</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">rx_ticks</span><span class="p">;</span>
	<span class="n">coal</span><span class="o">-&gt;</span><span class="n">tx_coalesce_usecs</span> <span class="o">=</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">tx_ticks</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bnx2x_set_coalesce</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">ethtool_coalesce</span> <span class="o">*</span><span class="n">coal</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">bp</span><span class="o">-&gt;</span><span class="n">rx_ticks</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span><span class="n">coal</span><span class="o">-&gt;</span><span class="n">rx_coalesce_usecs</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">rx_ticks</span> <span class="o">&gt;</span> <span class="n">BNX2X_MAX_COALESCE_TOUT</span><span class="p">)</span>
		<span class="n">bp</span><span class="o">-&gt;</span><span class="n">rx_ticks</span> <span class="o">=</span> <span class="n">BNX2X_MAX_COALESCE_TOUT</span><span class="p">;</span>

	<span class="n">bp</span><span class="o">-&gt;</span><span class="n">tx_ticks</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span><span class="n">coal</span><span class="o">-&gt;</span><span class="n">tx_coalesce_usecs</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">tx_ticks</span> <span class="o">&gt;</span> <span class="n">BNX2X_MAX_COALESCE_TOUT</span><span class="p">)</span>
		<span class="n">bp</span><span class="o">-&gt;</span><span class="n">tx_ticks</span> <span class="o">=</span> <span class="n">BNX2X_MAX_COALESCE_TOUT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">netif_running</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="n">bnx2x_update_coalesce</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_get_ringparam</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">ethtool_ringparam</span> <span class="o">*</span><span class="n">ering</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">ering</span><span class="o">-&gt;</span><span class="n">rx_max_pending</span> <span class="o">=</span> <span class="n">MAX_RX_AVAIL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">rx_ring_size</span><span class="p">)</span>
		<span class="n">ering</span><span class="o">-&gt;</span><span class="n">rx_pending</span> <span class="o">=</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">rx_ring_size</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">ering</span><span class="o">-&gt;</span><span class="n">rx_pending</span> <span class="o">=</span> <span class="n">MAX_RX_AVAIL</span><span class="p">;</span>

	<span class="n">ering</span><span class="o">-&gt;</span><span class="n">tx_max_pending</span> <span class="o">=</span> <span class="n">IS_MF_FCOE_AFEX</span><span class="p">(</span><span class="n">bp</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">MAX_TX_AVAIL</span><span class="p">;</span>
	<span class="n">ering</span><span class="o">-&gt;</span><span class="n">tx_pending</span> <span class="o">=</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">tx_ring_size</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bnx2x_set_ringparam</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">ethtool_ringparam</span> <span class="o">*</span><span class="n">ering</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">recovery_state</span> <span class="o">!=</span> <span class="n">BNX2X_RECOVERY_DONE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DP</span><span class="p">(</span><span class="n">BNX2X_MSG_ETHTOOL</span><span class="p">,</span>
		   <span class="s">&quot;Handling parity error recovery. Try again later</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ering</span><span class="o">-&gt;</span><span class="n">rx_pending</span> <span class="o">&gt;</span> <span class="n">MAX_RX_AVAIL</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">ering</span><span class="o">-&gt;</span><span class="n">rx_pending</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">disable_tpa</span> <span class="o">?</span> <span class="n">MIN_RX_SIZE_NONTPA</span> <span class="o">:</span>
						    <span class="n">MIN_RX_SIZE_TPA</span><span class="p">))</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">ering</span><span class="o">-&gt;</span><span class="n">tx_pending</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">IS_MF_FCOE_AFEX</span><span class="p">(</span><span class="n">bp</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">MAX_TX_AVAIL</span><span class="p">))</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">ering</span><span class="o">-&gt;</span><span class="n">tx_pending</span> <span class="o">&lt;=</span> <span class="n">MAX_SKB_FRAGS</span> <span class="o">+</span> <span class="mi">4</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DP</span><span class="p">(</span><span class="n">BNX2X_MSG_ETHTOOL</span><span class="p">,</span> <span class="s">&quot;Command parameters not supported</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">bp</span><span class="o">-&gt;</span><span class="n">rx_ring_size</span> <span class="o">=</span> <span class="n">ering</span><span class="o">-&gt;</span><span class="n">rx_pending</span><span class="p">;</span>
	<span class="n">bp</span><span class="o">-&gt;</span><span class="n">tx_ring_size</span> <span class="o">=</span> <span class="n">ering</span><span class="o">-&gt;</span><span class="n">tx_pending</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">bnx2x_reload_if_running</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_get_pauseparam</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">ethtool_pauseparam</span> <span class="o">*</span><span class="n">epause</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">cfg_idx</span> <span class="o">=</span> <span class="n">bnx2x_get_link_cfg_idx</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">cfg_reg</span><span class="p">;</span>

	<span class="n">epause</span><span class="o">-&gt;</span><span class="n">autoneg</span> <span class="o">=</span> <span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">link_params</span><span class="p">.</span><span class="n">req_flow_ctrl</span><span class="p">[</span><span class="n">cfg_idx</span><span class="p">]</span> <span class="o">==</span>
			   <span class="n">BNX2X_FLOW_CTRL_AUTO</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">epause</span><span class="o">-&gt;</span><span class="n">autoneg</span><span class="p">)</span>
		<span class="n">cfg_reg</span> <span class="o">=</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">link_params</span><span class="p">.</span><span class="n">req_flow_ctrl</span><span class="p">[</span><span class="n">cfg_idx</span><span class="p">];</span>
	<span class="k">else</span>
		<span class="n">cfg_reg</span> <span class="o">=</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">link_params</span><span class="p">.</span><span class="n">req_fc_auto_adv</span><span class="p">;</span>

	<span class="n">epause</span><span class="o">-&gt;</span><span class="n">rx_pause</span> <span class="o">=</span> <span class="p">((</span><span class="n">cfg_reg</span> <span class="o">&amp;</span> <span class="n">BNX2X_FLOW_CTRL_RX</span><span class="p">)</span> <span class="o">==</span>
			    <span class="n">BNX2X_FLOW_CTRL_RX</span><span class="p">);</span>
	<span class="n">epause</span><span class="o">-&gt;</span><span class="n">tx_pause</span> <span class="o">=</span> <span class="p">((</span><span class="n">cfg_reg</span> <span class="o">&amp;</span> <span class="n">BNX2X_FLOW_CTRL_TX</span><span class="p">)</span> <span class="o">==</span>
			    <span class="n">BNX2X_FLOW_CTRL_TX</span><span class="p">);</span>

	<span class="n">DP</span><span class="p">(</span><span class="n">BNX2X_MSG_ETHTOOL</span><span class="p">,</span> <span class="s">&quot;ethtool_pauseparam: cmd %d</span><span class="se">\n</span><span class="s">&quot;</span>
	   <span class="s">&quot;  autoneg %d  rx_pause %d  tx_pause %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	   <span class="n">epause</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">,</span> <span class="n">epause</span><span class="o">-&gt;</span><span class="n">autoneg</span><span class="p">,</span> <span class="n">epause</span><span class="o">-&gt;</span><span class="n">rx_pause</span><span class="p">,</span> <span class="n">epause</span><span class="o">-&gt;</span><span class="n">tx_pause</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bnx2x_set_pauseparam</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">ethtool_pauseparam</span> <span class="o">*</span><span class="n">epause</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">cfg_idx</span> <span class="o">=</span> <span class="n">bnx2x_get_link_cfg_idx</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_MF</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">DP</span><span class="p">(</span><span class="n">BNX2X_MSG_ETHTOOL</span><span class="p">,</span> <span class="s">&quot;ethtool_pauseparam: cmd %d</span><span class="se">\n</span><span class="s">&quot;</span>
	   <span class="s">&quot;  autoneg %d  rx_pause %d  tx_pause %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	   <span class="n">epause</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">,</span> <span class="n">epause</span><span class="o">-&gt;</span><span class="n">autoneg</span><span class="p">,</span> <span class="n">epause</span><span class="o">-&gt;</span><span class="n">rx_pause</span><span class="p">,</span> <span class="n">epause</span><span class="o">-&gt;</span><span class="n">tx_pause</span><span class="p">);</span>

	<span class="n">bp</span><span class="o">-&gt;</span><span class="n">link_params</span><span class="p">.</span><span class="n">req_flow_ctrl</span><span class="p">[</span><span class="n">cfg_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">BNX2X_FLOW_CTRL_AUTO</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">epause</span><span class="o">-&gt;</span><span class="n">rx_pause</span><span class="p">)</span>
		<span class="n">bp</span><span class="o">-&gt;</span><span class="n">link_params</span><span class="p">.</span><span class="n">req_flow_ctrl</span><span class="p">[</span><span class="n">cfg_idx</span><span class="p">]</span> <span class="o">|=</span> <span class="n">BNX2X_FLOW_CTRL_RX</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">epause</span><span class="o">-&gt;</span><span class="n">tx_pause</span><span class="p">)</span>
		<span class="n">bp</span><span class="o">-&gt;</span><span class="n">link_params</span><span class="p">.</span><span class="n">req_flow_ctrl</span><span class="p">[</span><span class="n">cfg_idx</span><span class="p">]</span> <span class="o">|=</span> <span class="n">BNX2X_FLOW_CTRL_TX</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">link_params</span><span class="p">.</span><span class="n">req_flow_ctrl</span><span class="p">[</span><span class="n">cfg_idx</span><span class="p">]</span> <span class="o">==</span> <span class="n">BNX2X_FLOW_CTRL_AUTO</span><span class="p">)</span>
		<span class="n">bp</span><span class="o">-&gt;</span><span class="n">link_params</span><span class="p">.</span><span class="n">req_flow_ctrl</span><span class="p">[</span><span class="n">cfg_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">BNX2X_FLOW_CTRL_NONE</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">epause</span><span class="o">-&gt;</span><span class="n">autoneg</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">supported</span><span class="p">[</span><span class="n">cfg_idx</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">SUPPORTED_Autoneg</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">DP</span><span class="p">(</span><span class="n">BNX2X_MSG_ETHTOOL</span><span class="p">,</span> <span class="s">&quot;autoneg not supported</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">link_params</span><span class="p">.</span><span class="n">req_line_speed</span><span class="p">[</span><span class="n">cfg_idx</span><span class="p">]</span> <span class="o">==</span> <span class="n">SPEED_AUTO_NEG</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">bp</span><span class="o">-&gt;</span><span class="n">link_params</span><span class="p">.</span><span class="n">req_flow_ctrl</span><span class="p">[</span><span class="n">cfg_idx</span><span class="p">]</span> <span class="o">=</span>
				<span class="n">BNX2X_FLOW_CTRL_AUTO</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">DP</span><span class="p">(</span><span class="n">BNX2X_MSG_ETHTOOL</span><span class="p">,</span>
	   <span class="s">&quot;req_flow_ctrl 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">link_params</span><span class="p">.</span><span class="n">req_flow_ctrl</span><span class="p">[</span><span class="n">cfg_idx</span><span class="p">]);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">netif_running</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">bnx2x_stats_handle</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">STATS_EVENT_STOP</span><span class="p">);</span>
		<span class="n">bnx2x_link_set</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="p">{</span>
	<span class="kt">char</span> <span class="n">string</span><span class="p">[</span><span class="n">ETH_GSTRING_LEN</span><span class="p">];</span>
<span class="p">}</span> <span class="n">bnx2x_tests_str_arr</span><span class="p">[</span><span class="n">BNX2X_NUM_TESTS</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="s">&quot;register_test (offline)&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;memory_test (offline)&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;loopback_test (offline)&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;nvram_test (online)&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;interrupt_test (online)&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;link_test (online)&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;idle check (online)&quot;</span> <span class="p">}</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="p">{</span>
	<span class="n">BNX2X_CHIP_E1_OFST</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="n">BNX2X_CHIP_E1H_OFST</span><span class="p">,</span>
	<span class="n">BNX2X_CHIP_E2_OFST</span><span class="p">,</span>
	<span class="n">BNX2X_CHIP_E3_OFST</span><span class="p">,</span>
	<span class="n">BNX2X_CHIP_E3B0_OFST</span><span class="p">,</span>
	<span class="n">BNX2X_CHIP_MAX_OFST</span>
<span class="p">};</span>

<span class="cp">#define BNX2X_CHIP_MASK_E1	(1 &lt;&lt; BNX2X_CHIP_E1_OFST)</span>
<span class="cp">#define BNX2X_CHIP_MASK_E1H	(1 &lt;&lt; BNX2X_CHIP_E1H_OFST)</span>
<span class="cp">#define BNX2X_CHIP_MASK_E2	(1 &lt;&lt; BNX2X_CHIP_E2_OFST)</span>
<span class="cp">#define BNX2X_CHIP_MASK_E3	(1 &lt;&lt; BNX2X_CHIP_E3_OFST)</span>
<span class="cp">#define BNX2X_CHIP_MASK_E3B0	(1 &lt;&lt; BNX2X_CHIP_E3B0_OFST)</span>

<span class="cp">#define BNX2X_CHIP_MASK_ALL	((1 &lt;&lt; BNX2X_CHIP_MAX_OFST) - 1)</span>
<span class="cp">#define BNX2X_CHIP_MASK_E1X	(BNX2X_CHIP_MASK_E1 | BNX2X_CHIP_MASK_E1H)</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bnx2x_test_registers</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">idx</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">wr_val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">hw</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">port</span> <span class="o">=</span> <span class="n">BP_PORT</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
	<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">hw</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">offset0</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">offset1</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">mask</span><span class="p">;</span>
	<span class="p">}</span> <span class="n">reg_tbl</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
<span class="cm">/* 0 */</span>		<span class="p">{</span> <span class="n">BNX2X_CHIP_MASK_ALL</span><span class="p">,</span>
			<span class="n">BRB1_REG_PAUSE_LOW_THRESHOLD_0</span><span class="p">,</span>	<span class="mi">4</span><span class="p">,</span> <span class="mh">0x000003ff</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">BNX2X_CHIP_MASK_ALL</span><span class="p">,</span>
			<span class="n">DORQ_REG_DB_ADDR0</span><span class="p">,</span>		<span class="mi">4</span><span class="p">,</span> <span class="mh">0xffffffff</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">BNX2X_CHIP_MASK_E1X</span><span class="p">,</span>
			<span class="n">HC_REG_AGG_INT_0</span><span class="p">,</span>		<span class="mi">4</span><span class="p">,</span> <span class="mh">0x000003ff</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">BNX2X_CHIP_MASK_ALL</span><span class="p">,</span>
			<span class="n">PBF_REG_MAC_IF0_ENABLE</span><span class="p">,</span>		<span class="mi">4</span><span class="p">,</span> <span class="mh">0x00000001</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">BNX2X_CHIP_MASK_E1X</span> <span class="o">|</span> <span class="n">BNX2X_CHIP_MASK_E2</span> <span class="o">|</span> <span class="n">BNX2X_CHIP_MASK_E3</span><span class="p">,</span>
			<span class="n">PBF_REG_P0_INIT_CRD</span><span class="p">,</span>		<span class="mi">4</span><span class="p">,</span> <span class="mh">0x000007ff</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">BNX2X_CHIP_MASK_E3B0</span><span class="p">,</span>
			<span class="n">PBF_REG_INIT_CRD_Q0</span><span class="p">,</span>		<span class="mi">4</span><span class="p">,</span> <span class="mh">0x000007ff</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">BNX2X_CHIP_MASK_ALL</span><span class="p">,</span>
			<span class="n">PRS_REG_CID_PORT_0</span><span class="p">,</span>		<span class="mi">4</span><span class="p">,</span> <span class="mh">0x00ffffff</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">BNX2X_CHIP_MASK_ALL</span><span class="p">,</span>
			<span class="n">PXP2_REG_PSWRQ_CDU0_L2P</span><span class="p">,</span>	<span class="mi">4</span><span class="p">,</span> <span class="mh">0x000fffff</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">BNX2X_CHIP_MASK_ALL</span><span class="p">,</span>
			<span class="n">PXP2_REG_RQ_CDU0_EFIRST_MEM_ADDR</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mh">0x0003ffff</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">BNX2X_CHIP_MASK_ALL</span><span class="p">,</span>
			<span class="n">PXP2_REG_PSWRQ_TM0_L2P</span><span class="p">,</span>		<span class="mi">4</span><span class="p">,</span> <span class="mh">0x000fffff</span> <span class="p">},</span>
<span class="cm">/* 10 */</span>	<span class="p">{</span> <span class="n">BNX2X_CHIP_MASK_ALL</span><span class="p">,</span>
			<span class="n">PXP2_REG_RQ_USDM0_EFIRST_MEM_ADDR</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mh">0x0003ffff</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">BNX2X_CHIP_MASK_ALL</span><span class="p">,</span>
			<span class="n">PXP2_REG_PSWRQ_TSDM0_L2P</span><span class="p">,</span>	<span class="mi">4</span><span class="p">,</span> <span class="mh">0x000fffff</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">BNX2X_CHIP_MASK_ALL</span><span class="p">,</span>
			<span class="n">QM_REG_CONNNUM_0</span><span class="p">,</span>		<span class="mi">4</span><span class="p">,</span> <span class="mh">0x000fffff</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">BNX2X_CHIP_MASK_ALL</span><span class="p">,</span>
			<span class="n">TM_REG_LIN0_MAX_ACTIVE_CID</span><span class="p">,</span>	<span class="mi">4</span><span class="p">,</span> <span class="mh">0x0003ffff</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">BNX2X_CHIP_MASK_ALL</span><span class="p">,</span>
			<span class="n">SRC_REG_KEYRSS0_0</span><span class="p">,</span>		<span class="mi">40</span><span class="p">,</span> <span class="mh">0xffffffff</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">BNX2X_CHIP_MASK_ALL</span><span class="p">,</span>
			<span class="n">SRC_REG_KEYRSS0_7</span><span class="p">,</span>		<span class="mi">40</span><span class="p">,</span> <span class="mh">0xffffffff</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">BNX2X_CHIP_MASK_ALL</span><span class="p">,</span>
			<span class="n">XCM_REG_WU_DA_SET_TMR_CNT_FLG_CMD00</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mh">0x00000001</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">BNX2X_CHIP_MASK_ALL</span><span class="p">,</span>
			<span class="n">XCM_REG_WU_DA_CNT_CMD00</span><span class="p">,</span>	<span class="mi">4</span><span class="p">,</span> <span class="mh">0x00000003</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">BNX2X_CHIP_MASK_ALL</span><span class="p">,</span>
			<span class="n">XCM_REG_GLB_DEL_ACK_MAX_CNT_0</span><span class="p">,</span>	<span class="mi">4</span><span class="p">,</span> <span class="mh">0x000000ff</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">BNX2X_CHIP_MASK_ALL</span><span class="p">,</span>
			<span class="n">NIG_REG_LLH0_T_BIT</span><span class="p">,</span>		<span class="mi">4</span><span class="p">,</span> <span class="mh">0x00000001</span> <span class="p">},</span>
<span class="cm">/* 20 */</span>	<span class="p">{</span> <span class="n">BNX2X_CHIP_MASK_E1X</span> <span class="o">|</span> <span class="n">BNX2X_CHIP_MASK_E2</span><span class="p">,</span>
			<span class="n">NIG_REG_EMAC0_IN_EN</span><span class="p">,</span>		<span class="mi">4</span><span class="p">,</span> <span class="mh">0x00000001</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">BNX2X_CHIP_MASK_E1X</span> <span class="o">|</span> <span class="n">BNX2X_CHIP_MASK_E2</span><span class="p">,</span>
			<span class="n">NIG_REG_BMAC0_IN_EN</span><span class="p">,</span>		<span class="mi">4</span><span class="p">,</span> <span class="mh">0x00000001</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">BNX2X_CHIP_MASK_ALL</span><span class="p">,</span>
			<span class="n">NIG_REG_XCM0_OUT_EN</span><span class="p">,</span>		<span class="mi">4</span><span class="p">,</span> <span class="mh">0x00000001</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">BNX2X_CHIP_MASK_ALL</span><span class="p">,</span>
			<span class="n">NIG_REG_BRB0_OUT_EN</span><span class="p">,</span>		<span class="mi">4</span><span class="p">,</span> <span class="mh">0x00000001</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">BNX2X_CHIP_MASK_ALL</span><span class="p">,</span>
			<span class="n">NIG_REG_LLH0_XCM_MASK</span><span class="p">,</span>		<span class="mi">4</span><span class="p">,</span> <span class="mh">0x00000007</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">BNX2X_CHIP_MASK_ALL</span><span class="p">,</span>
			<span class="n">NIG_REG_LLH0_ACPI_PAT_6_LEN</span><span class="p">,</span>	<span class="mi">68</span><span class="p">,</span> <span class="mh">0x000000ff</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">BNX2X_CHIP_MASK_ALL</span><span class="p">,</span>
			<span class="n">NIG_REG_LLH0_ACPI_PAT_0_CRC</span><span class="p">,</span>	<span class="mi">68</span><span class="p">,</span> <span class="mh">0xffffffff</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">BNX2X_CHIP_MASK_ALL</span><span class="p">,</span>
			<span class="n">NIG_REG_LLH0_DEST_MAC_0_0</span><span class="p">,</span>	<span class="mi">160</span><span class="p">,</span> <span class="mh">0xffffffff</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">BNX2X_CHIP_MASK_ALL</span><span class="p">,</span>
			<span class="n">NIG_REG_LLH0_DEST_IP_0_1</span><span class="p">,</span>	<span class="mi">160</span><span class="p">,</span> <span class="mh">0xffffffff</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">BNX2X_CHIP_MASK_ALL</span><span class="p">,</span>
			<span class="n">NIG_REG_LLH0_IPV4_IPV6_0</span><span class="p">,</span>	<span class="mi">160</span><span class="p">,</span> <span class="mh">0x00000001</span> <span class="p">},</span>
<span class="cm">/* 30 */</span>	<span class="p">{</span> <span class="n">BNX2X_CHIP_MASK_ALL</span><span class="p">,</span>
			<span class="n">NIG_REG_LLH0_DEST_UDP_0</span><span class="p">,</span>	<span class="mi">160</span><span class="p">,</span> <span class="mh">0x0000ffff</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">BNX2X_CHIP_MASK_ALL</span><span class="p">,</span>
			<span class="n">NIG_REG_LLH0_DEST_TCP_0</span><span class="p">,</span>	<span class="mi">160</span><span class="p">,</span> <span class="mh">0x0000ffff</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">BNX2X_CHIP_MASK_ALL</span><span class="p">,</span>
			<span class="n">NIG_REG_LLH0_VLAN_ID_0</span><span class="p">,</span>	<span class="mi">160</span><span class="p">,</span> <span class="mh">0x00000fff</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">BNX2X_CHIP_MASK_E1X</span> <span class="o">|</span> <span class="n">BNX2X_CHIP_MASK_E2</span><span class="p">,</span>
			<span class="n">NIG_REG_XGXS_SERDES0_MODE_SEL</span><span class="p">,</span>	<span class="mi">4</span><span class="p">,</span> <span class="mh">0x00000001</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">BNX2X_CHIP_MASK_ALL</span><span class="p">,</span>
			<span class="n">NIG_REG_LED_CONTROL_OVERRIDE_TRAFFIC_P0</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mh">0x00000001</span><span class="p">},</span>
		<span class="p">{</span> <span class="n">BNX2X_CHIP_MASK_ALL</span><span class="p">,</span>
			<span class="n">NIG_REG_STATUS_INTERRUPT_PORT0</span><span class="p">,</span>	<span class="mi">4</span><span class="p">,</span> <span class="mh">0x07ffffff</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">BNX2X_CHIP_MASK_E1X</span> <span class="o">|</span> <span class="n">BNX2X_CHIP_MASK_E2</span><span class="p">,</span>
			<span class="n">NIG_REG_XGXS0_CTRL_EXTREMOTEMDIOST</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span> <span class="mh">0x00000001</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">BNX2X_CHIP_MASK_E1X</span> <span class="o">|</span> <span class="n">BNX2X_CHIP_MASK_E2</span><span class="p">,</span>
			<span class="n">NIG_REG_SERDES0_CTRL_PHY_ADDR</span><span class="p">,</span>	<span class="mi">16</span><span class="p">,</span> <span class="mh">0x0000001f</span> <span class="p">},</span>

		<span class="p">{</span> <span class="n">BNX2X_CHIP_MASK_ALL</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x00000000</span> <span class="p">}</span>
	<span class="p">};</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">netif_running</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DP</span><span class="p">(</span><span class="n">BNX2X_MSG_ETHTOOL</span> <span class="o">|</span> <span class="n">BNX2X_MSG_NVM</span><span class="p">,</span>
		   <span class="s">&quot;cannot access eeprom when the interface is down</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">CHIP_IS_E1</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span>
		<span class="n">hw</span> <span class="o">=</span> <span class="n">BNX2X_CHIP_MASK_E1</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">CHIP_IS_E1H</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span>
		<span class="n">hw</span> <span class="o">=</span> <span class="n">BNX2X_CHIP_MASK_E1H</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">CHIP_IS_E2</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span>
		<span class="n">hw</span> <span class="o">=</span> <span class="n">BNX2X_CHIP_MASK_E2</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">CHIP_IS_E3B0</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span>
		<span class="n">hw</span> <span class="o">=</span> <span class="n">BNX2X_CHIP_MASK_E3B0</span><span class="p">;</span>
	<span class="k">else</span> <span class="cm">/* e3 A0 */</span>
		<span class="n">hw</span> <span class="o">=</span> <span class="n">BNX2X_CHIP_MASK_E3</span><span class="p">;</span>

	<span class="cm">/* Repeat the test twice:</span>
<span class="cm">	   First by writing 0x00000000, second by writing 0xffffffff */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">idx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">idx</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">0</span>:
			<span class="n">wr_val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">1</span>:
			<span class="n">wr_val</span> <span class="o">=</span> <span class="mh">0xffffffff</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">reg_tbl</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">offset0</span> <span class="o">!=</span> <span class="mh">0xffffffff</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u32</span> <span class="n">offset</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">save_val</span><span class="p">,</span> <span class="n">val</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">hw</span> <span class="o">&amp;</span> <span class="n">reg_tbl</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">hw</span><span class="p">))</span>
				<span class="k">continue</span><span class="p">;</span>

			<span class="n">offset</span> <span class="o">=</span> <span class="n">reg_tbl</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">offset0</span> <span class="o">+</span> <span class="n">port</span><span class="o">*</span><span class="n">reg_tbl</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">offset1</span><span class="p">;</span>
			<span class="n">mask</span> <span class="o">=</span> <span class="n">reg_tbl</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">mask</span><span class="p">;</span>

			<span class="n">save_val</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">offset</span><span class="p">);</span>

			<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">wr_val</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">);</span>

			<span class="n">val</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">offset</span><span class="p">);</span>

			<span class="cm">/* Restore the original register&#39;s value */</span>
			<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">save_val</span><span class="p">);</span>

			<span class="cm">/* verify value is as expected */</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">)</span> <span class="o">!=</span> <span class="p">(</span><span class="n">wr_val</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">DP</span><span class="p">(</span><span class="n">BNX2X_MSG_ETHTOOL</span><span class="p">,</span>
				   <span class="s">&quot;offset 0x%x: val 0x%x != 0x%x mask 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				   <span class="n">offset</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">wr_val</span><span class="p">,</span> <span class="n">mask</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">test_reg_exit</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">test_reg_exit:</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bnx2x_test_memory</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">,</span> <span class="n">index</span><span class="p">;</span>
	<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">offset</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">size</span><span class="p">;</span>
	<span class="p">}</span> <span class="n">mem_tbl</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span> <span class="n">CCM_REG_XX_DESCR_TABLE</span><span class="p">,</span>   <span class="n">CCM_REG_XX_DESCR_TABLE_SIZE</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">CFC_REG_ACTIVITY_COUNTER</span><span class="p">,</span> <span class="n">CFC_REG_ACTIVITY_COUNTER_SIZE</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">CFC_REG_LINK_LIST</span><span class="p">,</span>        <span class="n">CFC_REG_LINK_LIST_SIZE</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">DMAE_REG_CMD_MEM</span><span class="p">,</span>         <span class="n">DMAE_REG_CMD_MEM_SIZE</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">TCM_REG_XX_DESCR_TABLE</span><span class="p">,</span>   <span class="n">TCM_REG_XX_DESCR_TABLE_SIZE</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">UCM_REG_XX_DESCR_TABLE</span><span class="p">,</span>   <span class="n">UCM_REG_XX_DESCR_TABLE_SIZE</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">XCM_REG_XX_DESCR_TABLE</span><span class="p">,</span>   <span class="n">XCM_REG_XX_DESCR_TABLE_SIZE</span> <span class="p">},</span>

		<span class="p">{</span> <span class="mh">0xffffffff</span><span class="p">,</span> <span class="mi">0</span> <span class="p">}</span>
	<span class="p">};</span>

	<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="p">{</span>
		<span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">offset</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">hw_mask</span><span class="p">[</span><span class="n">BNX2X_CHIP_MAX_OFST</span><span class="p">];</span>
	<span class="p">}</span> <span class="n">prty_tbl</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span> <span class="s">&quot;CCM_PRTY_STS&quot;</span><span class="p">,</span>  <span class="n">CCM_REG_CCM_PRTY_STS</span><span class="p">,</span>
			<span class="p">{</span><span class="mh">0x3ffc0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>   <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">}</span> <span class="p">},</span>
		<span class="p">{</span> <span class="s">&quot;CFC_PRTY_STS&quot;</span><span class="p">,</span>  <span class="n">CFC_REG_CFC_PRTY_STS</span><span class="p">,</span>
			<span class="p">{</span><span class="mh">0x2</span><span class="p">,</span>     <span class="mh">0x2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">}</span> <span class="p">},</span>
		<span class="p">{</span> <span class="s">&quot;DMAE_PRTY_STS&quot;</span><span class="p">,</span> <span class="n">DMAE_REG_DMAE_PRTY_STS</span><span class="p">,</span>
			<span class="p">{</span><span class="mi">0</span><span class="p">,</span>       <span class="mi">0</span><span class="p">,</span>   <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">}</span> <span class="p">},</span>
		<span class="p">{</span> <span class="s">&quot;TCM_PRTY_STS&quot;</span><span class="p">,</span>  <span class="n">TCM_REG_TCM_PRTY_STS</span><span class="p">,</span>
			<span class="p">{</span><span class="mh">0x3ffc0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>   <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">}</span> <span class="p">},</span>
		<span class="p">{</span> <span class="s">&quot;UCM_PRTY_STS&quot;</span><span class="p">,</span>  <span class="n">UCM_REG_UCM_PRTY_STS</span><span class="p">,</span>
			<span class="p">{</span><span class="mh">0x3ffc0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>   <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">}</span> <span class="p">},</span>
		<span class="p">{</span> <span class="s">&quot;XCM_PRTY_STS&quot;</span><span class="p">,</span>  <span class="n">XCM_REG_XCM_PRTY_STS</span><span class="p">,</span>
			<span class="p">{</span><span class="mh">0x3ffc1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>   <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">}</span> <span class="p">},</span>

		<span class="p">{</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">,</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">}</span> <span class="p">}</span>
	<span class="p">};</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">netif_running</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DP</span><span class="p">(</span><span class="n">BNX2X_MSG_ETHTOOL</span> <span class="o">|</span> <span class="n">BNX2X_MSG_NVM</span><span class="p">,</span>
		   <span class="s">&quot;cannot access eeprom when the interface is down</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">CHIP_IS_E1</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span>
		<span class="n">index</span> <span class="o">=</span> <span class="n">BNX2X_CHIP_E1_OFST</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">CHIP_IS_E1H</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span>
		<span class="n">index</span> <span class="o">=</span> <span class="n">BNX2X_CHIP_E1H_OFST</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">CHIP_IS_E2</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span>
		<span class="n">index</span> <span class="o">=</span> <span class="n">BNX2X_CHIP_E2_OFST</span><span class="p">;</span>
	<span class="k">else</span> <span class="cm">/* e3 */</span>
		<span class="n">index</span> <span class="o">=</span> <span class="n">BNX2X_CHIP_E3_OFST</span><span class="p">;</span>

	<span class="cm">/* pre-Check the parity status */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">prty_tbl</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">offset</span> <span class="o">!=</span> <span class="mh">0xffffffff</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">prty_tbl</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">offset</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">prty_tbl</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">hw_mask</span><span class="p">[</span><span class="n">index</span><span class="p">]))</span> <span class="p">{</span>
			<span class="n">DP</span><span class="p">(</span><span class="n">BNX2X_MSG_ETHTOOL</span><span class="p">,</span>
			   <span class="s">&quot;%s is 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">prty_tbl</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">test_mem_exit</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Go through all the memories */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">mem_tbl</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">offset</span> <span class="o">!=</span> <span class="mh">0xffffffff</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">mem_tbl</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">size</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
			<span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">mem_tbl</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">offset</span> <span class="o">+</span> <span class="n">j</span><span class="o">*</span><span class="mi">4</span><span class="p">);</span>

	<span class="cm">/* Check the parity status */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">prty_tbl</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">offset</span> <span class="o">!=</span> <span class="mh">0xffffffff</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">prty_tbl</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">offset</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">prty_tbl</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">hw_mask</span><span class="p">[</span><span class="n">index</span><span class="p">]))</span> <span class="p">{</span>
			<span class="n">DP</span><span class="p">(</span><span class="n">BNX2X_MSG_ETHTOOL</span><span class="p">,</span>
			   <span class="s">&quot;%s is 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">prty_tbl</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">test_mem_exit</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">test_mem_exit:</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_wait_for_link</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">,</span> <span class="n">u8</span> <span class="n">link_up</span><span class="p">,</span> <span class="n">u8</span> <span class="n">is_serdes</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">cnt</span> <span class="o">=</span> <span class="mi">1400</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">link_up</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">bnx2x_link_test</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">is_serdes</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">cnt</span><span class="o">--</span><span class="p">)</span>
			<span class="n">msleep</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">bnx2x_link_test</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">is_serdes</span><span class="p">))</span>
			<span class="n">DP</span><span class="p">(</span><span class="n">BNX2X_MSG_ETHTOOL</span><span class="p">,</span> <span class="s">&quot;Timeout waiting for link up</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bnx2x_run_loopback</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">loopback_mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pkt_size</span><span class="p">,</span> <span class="n">num_pkts</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">packet</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bnx2x_fastpath</span> <span class="o">*</span><span class="n">fp_rx</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">fp</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">bnx2x_fastpath</span> <span class="o">*</span><span class="n">fp_tx</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">fp</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">bnx2x_fp_txdata</span> <span class="o">*</span><span class="n">txdata</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fp_tx</span><span class="o">-&gt;</span><span class="n">txdata</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">u16</span> <span class="n">tx_start_idx</span><span class="p">,</span> <span class="n">tx_idx</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">rx_start_idx</span><span class="p">,</span> <span class="n">rx_idx</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">pkt_prod</span><span class="p">,</span> <span class="n">bd_prod</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sw_tx_bd</span> <span class="o">*</span><span class="n">tx_buf</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">eth_tx_start_bd</span> <span class="o">*</span><span class="n">tx_start_bd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">eth_tx_parse_bd_e1x</span>  <span class="o">*</span><span class="n">pbd_e1x</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">eth_tx_parse_bd_e2</span>  <span class="o">*</span><span class="n">pbd_e2</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">mapping</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">eth_rx_cqe</span> <span class="o">*</span><span class="n">cqe</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">cqe_fp_flags</span><span class="p">,</span> <span class="n">cqe_fp_type</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sw_rx_bd</span> <span class="o">*</span><span class="n">rx_buf</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">len</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">netdev_queue</span> <span class="o">*</span><span class="n">txq</span> <span class="o">=</span> <span class="n">netdev_get_tx_queue</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">txdata</span><span class="o">-&gt;</span><span class="n">txq_index</span><span class="p">);</span>

	<span class="cm">/* check the loopback mode */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">loopback_mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">BNX2X_PHY_LOOPBACK</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">link_params</span><span class="p">.</span><span class="n">loopback_mode</span> <span class="o">!=</span> <span class="n">LOOPBACK_XGXS</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">BNX2X_MAC_LOOPBACK</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">CHIP_IS_E3</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">cfg_idx</span> <span class="o">=</span> <span class="n">bnx2x_get_link_cfg_idx</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">supported</span><span class="p">[</span><span class="n">cfg_idx</span><span class="p">]</span> <span class="o">&amp;</span>
			    <span class="p">(</span><span class="n">SUPPORTED_10000baseT_Full</span> <span class="o">|</span>
			     <span class="n">SUPPORTED_20000baseMLD2_Full</span> <span class="o">|</span>
			     <span class="n">SUPPORTED_20000baseKR2_Full</span><span class="p">))</span>
				<span class="n">bp</span><span class="o">-&gt;</span><span class="n">link_params</span><span class="p">.</span><span class="n">loopback_mode</span> <span class="o">=</span> <span class="n">LOOPBACK_XMAC</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">bp</span><span class="o">-&gt;</span><span class="n">link_params</span><span class="p">.</span><span class="n">loopback_mode</span> <span class="o">=</span> <span class="n">LOOPBACK_UMAC</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">bp</span><span class="o">-&gt;</span><span class="n">link_params</span><span class="p">.</span><span class="n">loopback_mode</span> <span class="o">=</span> <span class="n">LOOPBACK_BMAC</span><span class="p">;</span>

		<span class="n">bnx2x_phy_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">link_params</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">link_vars</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">DP</span><span class="p">(</span><span class="n">BNX2X_MSG_ETHTOOL</span><span class="p">,</span> <span class="s">&quot;Command parameters not supported</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* prepare the loopback packet */</span>
	<span class="n">pkt_size</span> <span class="o">=</span> <span class="p">(((</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mtu</span> <span class="o">&lt;</span> <span class="n">ETH_MAX_PACKET_SIZE</span><span class="p">)</span> <span class="o">?</span>
		     <span class="n">bp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mtu</span> <span class="o">:</span> <span class="n">ETH_MAX_PACKET_SIZE</span><span class="p">)</span> <span class="o">+</span> <span class="n">ETH_HLEN</span><span class="p">);</span>
	<span class="n">skb</span> <span class="o">=</span> <span class="n">netdev_alloc_skb</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">fp_rx</span><span class="o">-&gt;</span><span class="n">rx_buf_size</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DP</span><span class="p">(</span><span class="n">BNX2X_MSG_ETHTOOL</span><span class="p">,</span> <span class="s">&quot;Can&#39;t allocate skb</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">test_loopback_exit</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">packet</span> <span class="o">=</span> <span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">pkt_size</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">packet</span><span class="p">,</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">packet</span> <span class="o">+</span> <span class="n">ETH_ALEN</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">packet</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">ETH_ALEN</span><span class="p">,</span> <span class="mh">0x77</span><span class="p">,</span> <span class="p">(</span><span class="n">ETH_HLEN</span> <span class="o">-</span> <span class="mi">2</span><span class="o">*</span><span class="n">ETH_ALEN</span><span class="p">));</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">ETH_HLEN</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">pkt_size</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">packet</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span> <span class="p">(</span><span class="n">i</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="n">mapping</span> <span class="o">=</span> <span class="n">dma_map_single</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span>
				 <span class="n">skb_headlen</span><span class="p">(</span><span class="n">skb</span><span class="p">),</span> <span class="n">DMA_TO_DEVICE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">dma_mapping_error</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">mapping</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="n">DP</span><span class="p">(</span><span class="n">BNX2X_MSG_ETHTOOL</span><span class="p">,</span> <span class="s">&quot;Unable to map SKB</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">test_loopback_exit</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* send the loopback packet */</span>
	<span class="n">num_pkts</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">tx_start_idx</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="o">*</span><span class="n">txdata</span><span class="o">-&gt;</span><span class="n">tx_cons_sb</span><span class="p">);</span>
	<span class="n">rx_start_idx</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="o">*</span><span class="n">fp_rx</span><span class="o">-&gt;</span><span class="n">rx_cons_sb</span><span class="p">);</span>

	<span class="n">netdev_tx_sent_queue</span><span class="p">(</span><span class="n">txq</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>

	<span class="n">pkt_prod</span> <span class="o">=</span> <span class="n">txdata</span><span class="o">-&gt;</span><span class="n">tx_pkt_prod</span><span class="o">++</span><span class="p">;</span>
	<span class="n">tx_buf</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">txdata</span><span class="o">-&gt;</span><span class="n">tx_buf_ring</span><span class="p">[</span><span class="n">TX_BD</span><span class="p">(</span><span class="n">pkt_prod</span><span class="p">)];</span>
	<span class="n">tx_buf</span><span class="o">-&gt;</span><span class="n">first_bd</span> <span class="o">=</span> <span class="n">txdata</span><span class="o">-&gt;</span><span class="n">tx_bd_prod</span><span class="p">;</span>
	<span class="n">tx_buf</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>
	<span class="n">tx_buf</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">bd_prod</span> <span class="o">=</span> <span class="n">TX_BD</span><span class="p">(</span><span class="n">txdata</span><span class="o">-&gt;</span><span class="n">tx_bd_prod</span><span class="p">);</span>
	<span class="n">tx_start_bd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">txdata</span><span class="o">-&gt;</span><span class="n">tx_desc_ring</span><span class="p">[</span><span class="n">bd_prod</span><span class="p">].</span><span class="n">start_bd</span><span class="p">;</span>
	<span class="n">tx_start_bd</span><span class="o">-&gt;</span><span class="n">addr_hi</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">U64_HI</span><span class="p">(</span><span class="n">mapping</span><span class="p">));</span>
	<span class="n">tx_start_bd</span><span class="o">-&gt;</span><span class="n">addr_lo</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">U64_LO</span><span class="p">(</span><span class="n">mapping</span><span class="p">));</span>
	<span class="n">tx_start_bd</span><span class="o">-&gt;</span><span class="n">nbd</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span> <span class="cm">/* start + pbd */</span>
	<span class="n">tx_start_bd</span><span class="o">-&gt;</span><span class="n">nbytes</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">skb_headlen</span><span class="p">(</span><span class="n">skb</span><span class="p">));</span>
	<span class="n">tx_start_bd</span><span class="o">-&gt;</span><span class="n">vlan_or_ethertype</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">pkt_prod</span><span class="p">);</span>
	<span class="n">tx_start_bd</span><span class="o">-&gt;</span><span class="n">bd_flags</span><span class="p">.</span><span class="n">as_bitfield</span> <span class="o">=</span> <span class="n">ETH_TX_BD_FLAGS_START_BD</span><span class="p">;</span>
	<span class="n">SET_FLAG</span><span class="p">(</span><span class="n">tx_start_bd</span><span class="o">-&gt;</span><span class="n">general_data</span><span class="p">,</span>
		 <span class="n">ETH_TX_START_BD_ETH_ADDR_TYPE</span><span class="p">,</span>
		 <span class="n">UNICAST_ADDRESS</span><span class="p">);</span>
	<span class="n">SET_FLAG</span><span class="p">(</span><span class="n">tx_start_bd</span><span class="o">-&gt;</span><span class="n">general_data</span><span class="p">,</span>
		 <span class="n">ETH_TX_START_BD_HDR_NBDS</span><span class="p">,</span>
		 <span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* turn on parsing and get a BD */</span>
	<span class="n">bd_prod</span> <span class="o">=</span> <span class="n">TX_BD</span><span class="p">(</span><span class="n">NEXT_TX_IDX</span><span class="p">(</span><span class="n">bd_prod</span><span class="p">));</span>

	<span class="n">pbd_e1x</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">txdata</span><span class="o">-&gt;</span><span class="n">tx_desc_ring</span><span class="p">[</span><span class="n">bd_prod</span><span class="p">].</span><span class="n">parse_bd_e1x</span><span class="p">;</span>
	<span class="n">pbd_e2</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">txdata</span><span class="o">-&gt;</span><span class="n">tx_desc_ring</span><span class="p">[</span><span class="n">bd_prod</span><span class="p">].</span><span class="n">parse_bd_e2</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">pbd_e2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">eth_tx_parse_bd_e2</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">pbd_e1x</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">eth_tx_parse_bd_e1x</span><span class="p">));</span>

	<span class="n">wmb</span><span class="p">();</span>

	<span class="n">txdata</span><span class="o">-&gt;</span><span class="n">tx_db</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">prod</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">barrier</span><span class="p">();</span>
	<span class="n">DOORBELL</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">txdata</span><span class="o">-&gt;</span><span class="n">cid</span><span class="p">,</span> <span class="n">txdata</span><span class="o">-&gt;</span><span class="n">tx_db</span><span class="p">.</span><span class="n">raw</span><span class="p">);</span>

	<span class="n">mmiowb</span><span class="p">();</span>
	<span class="n">barrier</span><span class="p">();</span>

	<span class="n">num_pkts</span><span class="o">++</span><span class="p">;</span>
	<span class="n">txdata</span><span class="o">-&gt;</span><span class="n">tx_bd_prod</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span> <span class="cm">/* start + pbd */</span>

	<span class="n">udelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>

	<span class="n">tx_idx</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="o">*</span><span class="n">txdata</span><span class="o">-&gt;</span><span class="n">tx_cons_sb</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tx_idx</span> <span class="o">!=</span> <span class="n">tx_start_idx</span> <span class="o">+</span> <span class="n">num_pkts</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">test_loopback_exit</span><span class="p">;</span>

	<span class="cm">/* Unlike HC IGU won&#39;t generate an interrupt for status block</span>
<span class="cm">	 * updates that have been performed while interrupts were</span>
<span class="cm">	 * disabled.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">.</span><span class="n">int_block</span> <span class="o">==</span> <span class="n">INT_BLOCK_IGU</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Disable local BHes to prevent a dead-lock situation between</span>
<span class="cm">		 * sch_direct_xmit() and bnx2x_run_loopback() (calling</span>
<span class="cm">		 * bnx2x_tx_int()), as both are taking netif_tx_lock().</span>
<span class="cm">		 */</span>
		<span class="n">local_bh_disable</span><span class="p">();</span>
		<span class="n">bnx2x_tx_int</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">txdata</span><span class="p">);</span>
		<span class="n">local_bh_enable</span><span class="p">();</span>
	<span class="p">}</span>

	<span class="n">rx_idx</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="o">*</span><span class="n">fp_rx</span><span class="o">-&gt;</span><span class="n">rx_cons_sb</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rx_idx</span> <span class="o">!=</span> <span class="n">rx_start_idx</span> <span class="o">+</span> <span class="n">num_pkts</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">test_loopback_exit</span><span class="p">;</span>

	<span class="n">cqe</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fp_rx</span><span class="o">-&gt;</span><span class="n">rx_comp_ring</span><span class="p">[</span><span class="n">RCQ_BD</span><span class="p">(</span><span class="n">fp_rx</span><span class="o">-&gt;</span><span class="n">rx_comp_cons</span><span class="p">)];</span>
	<span class="n">cqe_fp_flags</span> <span class="o">=</span> <span class="n">cqe</span><span class="o">-&gt;</span><span class="n">fast_path_cqe</span><span class="p">.</span><span class="n">type_error_flags</span><span class="p">;</span>
	<span class="n">cqe_fp_type</span> <span class="o">=</span> <span class="n">cqe_fp_flags</span> <span class="o">&amp;</span> <span class="n">ETH_FAST_PATH_RX_CQE_TYPE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CQE_TYPE_FAST</span><span class="p">(</span><span class="n">cqe_fp_type</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">cqe_fp_flags</span> <span class="o">&amp;</span> <span class="n">ETH_RX_ERROR_FALGS</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">test_loopback_rx_exit</span><span class="p">;</span>

	<span class="n">len</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">cqe</span><span class="o">-&gt;</span><span class="n">fast_path_cqe</span><span class="p">.</span><span class="n">pkt_len_or_gro_seg_len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">!=</span> <span class="n">pkt_size</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">test_loopback_rx_exit</span><span class="p">;</span>

	<span class="n">rx_buf</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fp_rx</span><span class="o">-&gt;</span><span class="n">rx_buf_ring</span><span class="p">[</span><span class="n">RX_BD</span><span class="p">(</span><span class="n">fp_rx</span><span class="o">-&gt;</span><span class="n">rx_bd_cons</span><span class="p">)];</span>
	<span class="n">dma_sync_single_for_cpu</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				   <span class="n">dma_unmap_addr</span><span class="p">(</span><span class="n">rx_buf</span><span class="p">,</span> <span class="n">mapping</span><span class="p">),</span>
				   <span class="n">fp_rx</span><span class="o">-&gt;</span><span class="n">rx_buf_size</span><span class="p">,</span> <span class="n">DMA_FROM_DEVICE</span><span class="p">);</span>
	<span class="n">data</span> <span class="o">=</span> <span class="n">rx_buf</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="n">NET_SKB_PAD</span> <span class="o">+</span> <span class="n">cqe</span><span class="o">-&gt;</span><span class="n">fast_path_cqe</span><span class="p">.</span><span class="n">placement_offset</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">ETH_HLEN</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">pkt_size</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">data</span> <span class="o">+</span> <span class="n">i</span><span class="p">)</span> <span class="o">!=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span> <span class="p">(</span><span class="n">i</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">test_loopback_rx_exit</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">test_loopback_rx_exit:</span>

	<span class="n">fp_rx</span><span class="o">-&gt;</span><span class="n">rx_bd_cons</span> <span class="o">=</span> <span class="n">NEXT_RX_IDX</span><span class="p">(</span><span class="n">fp_rx</span><span class="o">-&gt;</span><span class="n">rx_bd_cons</span><span class="p">);</span>
	<span class="n">fp_rx</span><span class="o">-&gt;</span><span class="n">rx_bd_prod</span> <span class="o">=</span> <span class="n">NEXT_RX_IDX</span><span class="p">(</span><span class="n">fp_rx</span><span class="o">-&gt;</span><span class="n">rx_bd_prod</span><span class="p">);</span>
	<span class="n">fp_rx</span><span class="o">-&gt;</span><span class="n">rx_comp_cons</span> <span class="o">=</span> <span class="n">NEXT_RCQ_IDX</span><span class="p">(</span><span class="n">fp_rx</span><span class="o">-&gt;</span><span class="n">rx_comp_cons</span><span class="p">);</span>
	<span class="n">fp_rx</span><span class="o">-&gt;</span><span class="n">rx_comp_prod</span> <span class="o">=</span> <span class="n">NEXT_RCQ_IDX</span><span class="p">(</span><span class="n">fp_rx</span><span class="o">-&gt;</span><span class="n">rx_comp_prod</span><span class="p">);</span>

	<span class="cm">/* Update producers */</span>
	<span class="n">bnx2x_update_rx_prod</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">fp_rx</span><span class="p">,</span> <span class="n">fp_rx</span><span class="o">-&gt;</span><span class="n">rx_bd_prod</span><span class="p">,</span> <span class="n">fp_rx</span><span class="o">-&gt;</span><span class="n">rx_comp_prod</span><span class="p">,</span>
			     <span class="n">fp_rx</span><span class="o">-&gt;</span><span class="n">rx_sge_prod</span><span class="p">);</span>

<span class="nl">test_loopback_exit:</span>
	<span class="n">bp</span><span class="o">-&gt;</span><span class="n">link_params</span><span class="p">.</span><span class="n">loopback_mode</span> <span class="o">=</span> <span class="n">LOOPBACK_NONE</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bnx2x_test_loopback</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">res</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">BP_NOMCP</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">netif_running</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">BNX2X_LOOPBACK_FAILED</span><span class="p">;</span>

	<span class="n">bnx2x_netif_stop</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">bnx2x_acquire_phy_lock</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>

	<span class="n">res</span> <span class="o">=</span> <span class="n">bnx2x_run_loopback</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">BNX2X_PHY_LOOPBACK</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DP</span><span class="p">(</span><span class="n">BNX2X_MSG_ETHTOOL</span><span class="p">,</span> <span class="s">&quot;  PHY loopback failed  (res %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">res</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">|=</span> <span class="n">BNX2X_PHY_LOOPBACK_FAILED</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">res</span> <span class="o">=</span> <span class="n">bnx2x_run_loopback</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">BNX2X_MAC_LOOPBACK</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DP</span><span class="p">(</span><span class="n">BNX2X_MSG_ETHTOOL</span><span class="p">,</span> <span class="s">&quot;  MAC loopback failed  (res %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">res</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">|=</span> <span class="n">BNX2X_MAC_LOOPBACK_FAILED</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">bnx2x_release_phy_lock</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
	<span class="n">bnx2x_netif_start</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define CRC32_RESIDUAL			0xdebb20e3</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bnx2x_test_nvram</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">offset</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">size</span><span class="p">;</span>
	<span class="p">}</span> <span class="n">nvram_tbl</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span>     <span class="mi">0</span><span class="p">,</span>  <span class="mh">0x14</span> <span class="p">},</span> <span class="cm">/* bootstrap */</span>
		<span class="p">{</span>  <span class="mh">0x14</span><span class="p">,</span>  <span class="mh">0xec</span> <span class="p">},</span> <span class="cm">/* dir */</span>
		<span class="p">{</span> <span class="mh">0x100</span><span class="p">,</span> <span class="mh">0x350</span> <span class="p">},</span> <span class="cm">/* manuf_info */</span>
		<span class="p">{</span> <span class="mh">0x450</span><span class="p">,</span>  <span class="mh">0xf0</span> <span class="p">},</span> <span class="cm">/* feature_info */</span>
		<span class="p">{</span> <span class="mh">0x640</span><span class="p">,</span>  <span class="mh">0x64</span> <span class="p">},</span> <span class="cm">/* upgrade_key_info */</span>
		<span class="p">{</span> <span class="mh">0x708</span><span class="p">,</span>  <span class="mh">0x70</span> <span class="p">},</span> <span class="cm">/* manuf_key_info */</span>
		<span class="p">{</span>     <span class="mi">0</span><span class="p">,</span>     <span class="mi">0</span> <span class="p">}</span>
	<span class="p">};</span>
	<span class="n">__be32</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">rc</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">magic</span><span class="p">,</span> <span class="n">crc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">BP_NOMCP</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">buf</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="mh">0x350</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buf</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DP</span><span class="p">(</span><span class="n">BNX2X_MSG_ETHTOOL</span> <span class="o">|</span> <span class="n">BNX2X_MSG_NVM</span><span class="p">,</span> <span class="s">&quot;kmalloc failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">test_nvram_exit</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">buf</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">bnx2x_nvram_read</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DP</span><span class="p">(</span><span class="n">BNX2X_MSG_ETHTOOL</span> <span class="o">|</span> <span class="n">BNX2X_MSG_NVM</span><span class="p">,</span>
		   <span class="s">&quot;magic value read (rc %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">test_nvram_exit</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">magic</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">magic</span> <span class="o">!=</span> <span class="mh">0x669955aa</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DP</span><span class="p">(</span><span class="n">BNX2X_MSG_ETHTOOL</span> <span class="o">|</span> <span class="n">BNX2X_MSG_NVM</span><span class="p">,</span>
		   <span class="s">&quot;wrong magic value (0x%08x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">magic</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">test_nvram_exit</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">nvram_tbl</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">size</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">rc</span> <span class="o">=</span> <span class="n">bnx2x_nvram_read</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">nvram_tbl</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">offset</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span>
				      <span class="n">nvram_tbl</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">size</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DP</span><span class="p">(</span><span class="n">BNX2X_MSG_ETHTOOL</span> <span class="o">|</span> <span class="n">BNX2X_MSG_NVM</span><span class="p">,</span>
			   <span class="s">&quot;nvram_tbl[%d] read data (rc %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">test_nvram_exit</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">crc</span> <span class="o">=</span> <span class="n">ether_crc_le</span><span class="p">(</span><span class="n">nvram_tbl</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">size</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">crc</span> <span class="o">!=</span> <span class="n">CRC32_RESIDUAL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DP</span><span class="p">(</span><span class="n">BNX2X_MSG_ETHTOOL</span> <span class="o">|</span> <span class="n">BNX2X_MSG_NVM</span><span class="p">,</span>
			   <span class="s">&quot;nvram_tbl[%d] wrong crc value (0x%08x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">crc</span><span class="p">);</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">test_nvram_exit</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

<span class="nl">test_nvram_exit:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Send an EMPTY ramrod on the first queue */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">bnx2x_test_intr</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2x_queue_state_params</span> <span class="n">params</span> <span class="o">=</span> <span class="p">{</span><span class="nb">NULL</span><span class="p">};</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">netif_running</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DP</span><span class="p">(</span><span class="n">BNX2X_MSG_ETHTOOL</span> <span class="o">|</span> <span class="n">BNX2X_MSG_NVM</span><span class="p">,</span>
		   <span class="s">&quot;cannot access eeprom when the interface is down</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">params</span><span class="p">.</span><span class="n">q_obj</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">q_obj</span><span class="p">;</span>
	<span class="n">params</span><span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">BNX2X_Q_CMD_EMPTY</span><span class="p">;</span>

	<span class="n">__set_bit</span><span class="p">(</span><span class="n">RAMROD_COMP_WAIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">params</span><span class="p">.</span><span class="n">ramrod_flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">bnx2x_queue_state_change</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">params</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_self_test</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">ethtool_test</span> <span class="o">*</span><span class="n">etest</span><span class="p">,</span> <span class="n">u64</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">is_serdes</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">recovery_state</span> <span class="o">!=</span> <span class="n">BNX2X_RECOVERY_DONE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netdev_err</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			   <span class="s">&quot;Handling parity error recovery. Try again later</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">etest</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">ETH_TEST_FL_FAILED</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u64</span><span class="p">)</span> <span class="o">*</span> <span class="n">BNX2X_NUM_TESTS</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">netif_running</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* offline tests are not supported in MF mode */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_MF</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span>
		<span class="n">etest</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ETH_TEST_FL_OFFLINE</span><span class="p">;</span>
	<span class="n">is_serdes</span> <span class="o">=</span> <span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">link_vars</span><span class="p">.</span><span class="n">link_status</span> <span class="o">&amp;</span> <span class="n">LINK_STATUS_SERDES_LINK</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">etest</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ETH_TEST_FL_OFFLINE</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">port</span> <span class="o">=</span> <span class="n">BP_PORT</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
		<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>
		<span class="n">u8</span> <span class="n">link_up</span><span class="p">;</span>

		<span class="cm">/* save current value of input enable for TX port IF */</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">NIG_REG_EGRESS_UMP0_IN_EN</span> <span class="o">+</span> <span class="n">port</span><span class="o">*</span><span class="mi">4</span><span class="p">);</span>
		<span class="cm">/* disable input for TX port IF */</span>
		<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">NIG_REG_EGRESS_UMP0_IN_EN</span> <span class="o">+</span> <span class="n">port</span><span class="o">*</span><span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="n">link_up</span> <span class="o">=</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">link_vars</span><span class="p">.</span><span class="n">link_up</span><span class="p">;</span>

		<span class="n">bnx2x_nic_unload</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">UNLOAD_NORMAL</span><span class="p">);</span>
		<span class="n">bnx2x_nic_load</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">LOAD_DIAG</span><span class="p">);</span>
		<span class="cm">/* wait until link state is restored */</span>
		<span class="n">bnx2x_wait_for_link</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">is_serdes</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">bnx2x_test_registers</span><span class="p">(</span><span class="n">bp</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">etest</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">ETH_TEST_FL_FAILED</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bnx2x_test_memory</span><span class="p">(</span><span class="n">bp</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">etest</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">ETH_TEST_FL_FAILED</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">bnx2x_test_loopback</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">etest</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">ETH_TEST_FL_FAILED</span><span class="p">;</span>

		<span class="n">bnx2x_nic_unload</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">UNLOAD_NORMAL</span><span class="p">);</span>

		<span class="cm">/* restore input for TX port IF */</span>
		<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">NIG_REG_EGRESS_UMP0_IN_EN</span> <span class="o">+</span> <span class="n">port</span><span class="o">*</span><span class="mi">4</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

		<span class="n">bnx2x_nic_load</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">LOAD_NORMAL</span><span class="p">);</span>
		<span class="cm">/* wait until link state is restored */</span>
		<span class="n">bnx2x_wait_for_link</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">link_up</span><span class="p">,</span> <span class="n">is_serdes</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bnx2x_test_nvram</span><span class="p">(</span><span class="n">bp</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">buf</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">etest</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">ETH_TEST_FL_FAILED</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bnx2x_test_intr</span><span class="p">(</span><span class="n">bp</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">buf</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">etest</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">ETH_TEST_FL_FAILED</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bnx2x_link_test</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">is_serdes</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">buf</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">etest</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">ETH_TEST_FL_FAILED</span><span class="p">;</span>
	<span class="p">}</span>

<span class="cp">#ifdef BNX2X_EXTRA_DEBUG</span>
	<span class="n">bnx2x_panic_dump</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="cp">#define IS_PORT_STAT(i) \</span>
<span class="cp">	((bnx2x_stats_arr[i].flags &amp; STATS_FLAGS_BOTH) == STATS_FLAGS_PORT)</span>
<span class="cp">#define IS_FUNC_STAT(i)		(bnx2x_stats_arr[i].flags &amp; STATS_FLAGS_FUNC)</span>
<span class="cp">#define IS_MF_MODE_STAT(bp) \</span>
<span class="cp">			(IS_MF(bp) &amp;&amp; !(bp-&gt;msg_enable &amp; BNX2X_MSG_STATS))</span>

<span class="cm">/* ethtool statistics are displayed for all regular ethernet queues and the</span>
<span class="cm"> * fcoe L2 queue if not disabled</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">bnx2x_num_stat_queues</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">BNX2X_NUM_ETH_QUEUES</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bnx2x_get_sset_count</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">stringset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">num_stats</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">stringset</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ETH_SS_STATS</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">is_multi</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">num_stats</span> <span class="o">=</span> <span class="n">bnx2x_num_stat_queues</span><span class="p">(</span><span class="n">bp</span><span class="p">)</span> <span class="o">*</span>
						<span class="n">BNX2X_NUM_Q_STATS</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">num_stats</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_MF_MODE_STAT</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">BNX2X_NUM_STATS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">IS_FUNC_STAT</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
					<span class="n">num_stats</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">num_stats</span> <span class="o">+=</span> <span class="n">BNX2X_NUM_STATS</span><span class="p">;</span>

		<span class="k">return</span> <span class="n">num_stats</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">ETH_SS_TEST</span>:
		<span class="k">return</span> <span class="n">BNX2X_NUM_TESTS</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_get_strings</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">stringset</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">queue_name</span><span class="p">[</span><span class="n">MAX_QUEUE_NAME_LEN</span><span class="o">+</span><span class="mi">1</span><span class="p">];</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">stringset</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ETH_SS_STATS</span>:
		<span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">is_multi</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">for_each_eth_queue</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">memset</span><span class="p">(</span><span class="n">queue_name</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">queue_name</span><span class="p">));</span>
				<span class="n">sprintf</span><span class="p">(</span><span class="n">queue_name</span><span class="p">,</span> <span class="s">&quot;%d&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
				<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">BNX2X_NUM_Q_STATS</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
					<span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="p">(</span><span class="n">k</span> <span class="o">+</span> <span class="n">j</span><span class="p">)</span><span class="o">*</span><span class="n">ETH_GSTRING_LEN</span><span class="p">,</span>
						<span class="n">ETH_GSTRING_LEN</span><span class="p">,</span>
						<span class="n">bnx2x_q_stats_arr</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">string</span><span class="p">,</span>
						<span class="n">queue_name</span><span class="p">);</span>
				<span class="n">k</span> <span class="o">+=</span> <span class="n">BNX2X_NUM_Q_STATS</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>


		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">BNX2X_NUM_STATS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">IS_MF_MODE_STAT</span><span class="p">(</span><span class="n">bp</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">IS_PORT_STAT</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="n">strcpy</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="p">(</span><span class="n">k</span> <span class="o">+</span> <span class="n">j</span><span class="p">)</span><span class="o">*</span><span class="n">ETH_GSTRING_LEN</span><span class="p">,</span>
				   <span class="n">bnx2x_stats_arr</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">string</span><span class="p">);</span>
			<span class="n">j</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">ETH_SS_TEST</span>:
		<span class="n">memcpy</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">bnx2x_tests_str_arr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">bnx2x_tests_str_arr</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_get_ethtool_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">ethtool_stats</span> <span class="o">*</span><span class="n">stats</span><span class="p">,</span> <span class="n">u64</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">hw_stats</span><span class="p">,</span> <span class="o">*</span><span class="n">offset</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_multi</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">for_each_eth_queue</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">hw_stats</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">fp</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">eth_q_stats</span><span class="p">;</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">BNX2X_NUM_Q_STATS</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">bnx2x_q_stats_arr</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
					<span class="cm">/* skip this counter */</span>
					<span class="n">buf</span><span class="p">[</span><span class="n">k</span> <span class="o">+</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
					<span class="k">continue</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">hw_stats</span> <span class="o">+</span>
					  <span class="n">bnx2x_q_stats_arr</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">offset</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">bnx2x_q_stats_arr</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">size</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
					<span class="cm">/* 4-byte counter */</span>
					<span class="n">buf</span><span class="p">[</span><span class="n">k</span> <span class="o">+</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span> <span class="o">*</span><span class="n">offset</span><span class="p">;</span>
					<span class="k">continue</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="cm">/* 8-byte counter */</span>
				<span class="n">buf</span><span class="p">[</span><span class="n">k</span> <span class="o">+</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">HILO_U64</span><span class="p">(</span><span class="o">*</span><span class="n">offset</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="n">offset</span> <span class="o">+</span> <span class="mi">1</span><span class="p">));</span>
			<span class="p">}</span>
			<span class="n">k</span> <span class="o">+=</span> <span class="n">BNX2X_NUM_Q_STATS</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">hw_stats</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">eth_stats</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">BNX2X_NUM_STATS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_MF_MODE_STAT</span><span class="p">(</span><span class="n">bp</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">IS_PORT_STAT</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bnx2x_stats_arr</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* skip this counter */</span>
			<span class="n">buf</span><span class="p">[</span><span class="n">k</span> <span class="o">+</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">j</span><span class="o">++</span><span class="p">;</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">hw_stats</span> <span class="o">+</span> <span class="n">bnx2x_stats_arr</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">offset</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bnx2x_stats_arr</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">size</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* 4-byte counter */</span>
			<span class="n">buf</span><span class="p">[</span><span class="n">k</span> <span class="o">+</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span> <span class="o">*</span><span class="n">offset</span><span class="p">;</span>
			<span class="n">j</span><span class="o">++</span><span class="p">;</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* 8-byte counter */</span>
		<span class="n">buf</span><span class="p">[</span><span class="n">k</span> <span class="o">+</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">HILO_U64</span><span class="p">(</span><span class="o">*</span><span class="n">offset</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="n">offset</span> <span class="o">+</span> <span class="mi">1</span><span class="p">));</span>
		<span class="n">j</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bnx2x_set_phys_id</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			     <span class="k">enum</span> <span class="n">ethtool_phys_id_state</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">netif_running</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DP</span><span class="p">(</span><span class="n">BNX2X_MSG_ETHTOOL</span> <span class="o">|</span> <span class="n">BNX2X_MSG_NVM</span><span class="p">,</span>
		   <span class="s">&quot;cannot access eeprom when the interface is down</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">pmf</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DP</span><span class="p">(</span><span class="n">BNX2X_MSG_ETHTOOL</span><span class="p">,</span> <span class="s">&quot;Interface is not pmf</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ETHTOOL_ID_ACTIVE</span>:
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* cycle on/off once per second */</span>

	<span class="k">case</span> <span class="n">ETHTOOL_ID_ON</span>:
		<span class="n">bnx2x_set_led</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">link_params</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">link_vars</span><span class="p">,</span>
			      <span class="n">LED_MODE_ON</span><span class="p">,</span> <span class="n">SPEED_1000</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">ETHTOOL_ID_OFF</span>:
		<span class="n">bnx2x_set_led</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">link_params</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">link_vars</span><span class="p">,</span>
			      <span class="n">LED_MODE_FRONT_PANEL_OFF</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">ETHTOOL_ID_INACTIVE</span>:
		<span class="n">bnx2x_set_led</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">link_params</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">link_vars</span><span class="p">,</span>
			      <span class="n">LED_MODE_OPER</span><span class="p">,</span>
			      <span class="n">bp</span><span class="o">-&gt;</span><span class="n">link_vars</span><span class="p">.</span><span class="n">line_speed</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bnx2x_get_rxnfc</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ethtool_rxnfc</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			   <span class="n">u32</span> <span class="o">*</span><span class="n">rules</span> <span class="n">__always_unused</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ETHTOOL_GRXRINGS</span>:
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">=</span> <span class="n">BNX2X_NUM_ETH_QUEUES</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">DP</span><span class="p">(</span><span class="n">BNX2X_MSG_ETHTOOL</span><span class="p">,</span> <span class="s">&quot;Command parameters not supported</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">bnx2x_get_rxfh_indir_size</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">T_ETH_INDIRECTION_TABLE_SIZE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bnx2x_get_rxfh_indir</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">indir</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">ind_table</span><span class="p">[</span><span class="n">T_ETH_INDIRECTION_TABLE_SIZE</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
	<span class="kt">size_t</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* Get the current configuration of the RSS indirection table */</span>
	<span class="n">bnx2x_get_rss_ind_table</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">rss_conf_obj</span><span class="p">,</span> <span class="n">ind_table</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * We can&#39;t use a memcpy() as an internal storage of an</span>
<span class="cm">	 * indirection table is a u8 array while indir-&gt;ring_index</span>
<span class="cm">	 * points to an array of u32.</span>
<span class="cm">	 *</span>
<span class="cm">	 * Indirection table contains the FW Client IDs, so we need to</span>
<span class="cm">	 * align the returned table to the Client ID of the leading RSS</span>
<span class="cm">	 * queue.</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">T_ETH_INDIRECTION_TABLE_SIZE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">indir</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ind_table</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">cl_id</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bnx2x_set_rxfh_indir</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">const</span> <span class="n">u32</span> <span class="o">*</span><span class="n">indir</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">size_t</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">ind_table</span><span class="p">[</span><span class="n">T_ETH_INDIRECTION_TABLE_SIZE</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">T_ETH_INDIRECTION_TABLE_SIZE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * The same as in bnx2x_get_rxfh_indir: we can&#39;t use a memcpy()</span>
<span class="cm">		 * as an internal storage of an indirection table is a u8 array</span>
<span class="cm">		 * while indir-&gt;ring_index points to an array of u32.</span>
<span class="cm">		 *</span>
<span class="cm">		 * Indirection table contains the FW Client IDs, so we need to</span>
<span class="cm">		 * align the received table to the Client ID of the leading RSS</span>
<span class="cm">		 * queue</span>
<span class="cm">		 */</span>
		<span class="n">ind_table</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">indir</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">cl_id</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">bnx2x_config_rss_eth</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">ind_table</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ethtool_ops</span> <span class="n">bnx2x_ethtool_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">get_settings</span>		<span class="o">=</span> <span class="n">bnx2x_get_settings</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_settings</span>		<span class="o">=</span> <span class="n">bnx2x_set_settings</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_drvinfo</span>		<span class="o">=</span> <span class="n">bnx2x_get_drvinfo</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_regs_len</span>		<span class="o">=</span> <span class="n">bnx2x_get_regs_len</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_regs</span>		<span class="o">=</span> <span class="n">bnx2x_get_regs</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_wol</span>		<span class="o">=</span> <span class="n">bnx2x_get_wol</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_wol</span>		<span class="o">=</span> <span class="n">bnx2x_set_wol</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_msglevel</span>		<span class="o">=</span> <span class="n">bnx2x_get_msglevel</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_msglevel</span>		<span class="o">=</span> <span class="n">bnx2x_set_msglevel</span><span class="p">,</span>
	<span class="p">.</span><span class="n">nway_reset</span>		<span class="o">=</span> <span class="n">bnx2x_nway_reset</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_link</span>		<span class="o">=</span> <span class="n">bnx2x_get_link</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_eeprom_len</span>		<span class="o">=</span> <span class="n">bnx2x_get_eeprom_len</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_eeprom</span>		<span class="o">=</span> <span class="n">bnx2x_get_eeprom</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_eeprom</span>		<span class="o">=</span> <span class="n">bnx2x_set_eeprom</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_coalesce</span>		<span class="o">=</span> <span class="n">bnx2x_get_coalesce</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_coalesce</span>		<span class="o">=</span> <span class="n">bnx2x_set_coalesce</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_ringparam</span>		<span class="o">=</span> <span class="n">bnx2x_get_ringparam</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_ringparam</span>		<span class="o">=</span> <span class="n">bnx2x_set_ringparam</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_pauseparam</span>		<span class="o">=</span> <span class="n">bnx2x_get_pauseparam</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_pauseparam</span>		<span class="o">=</span> <span class="n">bnx2x_set_pauseparam</span><span class="p">,</span>
	<span class="p">.</span><span class="n">self_test</span>		<span class="o">=</span> <span class="n">bnx2x_self_test</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_sset_count</span>		<span class="o">=</span> <span class="n">bnx2x_get_sset_count</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_strings</span>		<span class="o">=</span> <span class="n">bnx2x_get_strings</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_phys_id</span>		<span class="o">=</span> <span class="n">bnx2x_set_phys_id</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_ethtool_stats</span>	<span class="o">=</span> <span class="n">bnx2x_get_ethtool_stats</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_rxnfc</span>		<span class="o">=</span> <span class="n">bnx2x_get_rxnfc</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_rxfh_indir_size</span>	<span class="o">=</span> <span class="n">bnx2x_get_rxfh_indir_size</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_rxfh_indir</span>		<span class="o">=</span> <span class="n">bnx2x_get_rxfh_indir</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_rxfh_indir</span>		<span class="o">=</span> <span class="n">bnx2x_set_rxfh_indir</span><span class="p">,</span>
<span class="p">};</span>

<span class="kt">void</span> <span class="nf">bnx2x_set_ethtool_ops</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">SET_ETHTOOL_OPS</span><span class="p">(</span><span class="n">netdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bnx2x_ethtool_ops</span><span class="p">);</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:5}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../../javascript/docco.min.js"></script>
</html>
