<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › ethernet › broadcom › bnx2x › bnx2x_link.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../../index.html"></a><h1>bnx2x_link.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/* Copyright 2008-2012 Broadcom Corporation</span>
<span class="cm"> *</span>
<span class="cm"> * Unless you and Broadcom execute a separate written software license</span>
<span class="cm"> * agreement governing use of this software, this software is licensed to you</span>
<span class="cm"> * under the terms of the GNU General Public License version 2, available</span>
<span class="cm"> * at http://www.gnu.org/licenses/old-licenses/gpl-2.0.html (the &quot;GPL&quot;).</span>
<span class="cm"> *</span>
<span class="cm"> * Notwithstanding the above, under no circumstances may you combine this</span>
<span class="cm"> * software in any way with any other Broadcom software provided under a</span>
<span class="cm"> * license other than the GPL, without Broadcom&#39;s express prior written</span>
<span class="cm"> * consent.</span>
<span class="cm"> *</span>
<span class="cm"> * Written by Yaniv Rosner</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#define pr_fmt(fmt) KBUILD_MODNAME &quot;: &quot; fmt</span>

<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/netdevice.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/ethtool.h&gt;</span>
<span class="cp">#include &lt;linux/mutex.h&gt;</span>

<span class="cp">#include &quot;bnx2x.h&quot;</span>
<span class="cp">#include &quot;bnx2x_cmn.h&quot;</span>

<span class="cm">/********************************************************/</span>
<span class="cp">#define ETH_HLEN			14</span>
<span class="cm">/* L2 header size + 2*VLANs (8 bytes) + LLC SNAP (8 bytes) */</span>
<span class="cp">#define ETH_OVREHEAD			(ETH_HLEN + 8 + 8)</span>
<span class="cp">#define ETH_MIN_PACKET_SIZE		60</span>
<span class="cp">#define ETH_MAX_PACKET_SIZE		1500</span>
<span class="cp">#define ETH_MAX_JUMBO_PACKET_SIZE	9600</span>
<span class="cp">#define MDIO_ACCESS_TIMEOUT		1000</span>
<span class="cp">#define WC_LANE_MAX			4</span>
<span class="cp">#define I2C_SWITCH_WIDTH		2</span>
<span class="cp">#define I2C_BSC0			0</span>
<span class="cp">#define I2C_BSC1			1</span>
<span class="cp">#define I2C_WA_RETRY_CNT		3</span>
<span class="cp">#define I2C_WA_PWR_ITER			(I2C_WA_RETRY_CNT - 1)</span>
<span class="cp">#define MCPR_IMC_COMMAND_READ_OP	1</span>
<span class="cp">#define MCPR_IMC_COMMAND_WRITE_OP	2</span>

<span class="cm">/* LED Blink rate that will achieve ~15.9Hz */</span>
<span class="cp">#define LED_BLINK_RATE_VAL_E3		354</span>
<span class="cp">#define LED_BLINK_RATE_VAL_E1X_E2	480</span>
<span class="cm">/***********************************************************/</span>
<span class="cm">/*			Shortcut definitions		   */</span>
<span class="cm">/***********************************************************/</span>

<span class="cp">#define NIG_LATCH_BC_ENABLE_MI_INT 0</span>

<span class="cp">#define NIG_STATUS_EMAC0_MI_INT \</span>
<span class="cp">		NIG_STATUS_INTERRUPT_PORT0_REG_STATUS_EMAC0_MISC_MI_INT</span>
<span class="cp">#define NIG_STATUS_XGXS0_LINK10G \</span>
<span class="cp">		NIG_STATUS_INTERRUPT_PORT0_REG_STATUS_XGXS0_LINK10G</span>
<span class="cp">#define NIG_STATUS_XGXS0_LINK_STATUS \</span>
<span class="cp">		NIG_STATUS_INTERRUPT_PORT0_REG_STATUS_XGXS0_LINK_STATUS</span>
<span class="cp">#define NIG_STATUS_XGXS0_LINK_STATUS_SIZE \</span>
<span class="cp">		NIG_STATUS_INTERRUPT_PORT0_REG_STATUS_XGXS0_LINK_STATUS_SIZE</span>
<span class="cp">#define NIG_STATUS_SERDES0_LINK_STATUS \</span>
<span class="cp">		NIG_STATUS_INTERRUPT_PORT0_REG_STATUS_SERDES0_LINK_STATUS</span>
<span class="cp">#define NIG_MASK_MI_INT \</span>
<span class="cp">		NIG_MASK_INTERRUPT_PORT0_REG_MASK_EMAC0_MISC_MI_INT</span>
<span class="cp">#define NIG_MASK_XGXS0_LINK10G \</span>
<span class="cp">		NIG_MASK_INTERRUPT_PORT0_REG_MASK_XGXS0_LINK10G</span>
<span class="cp">#define NIG_MASK_XGXS0_LINK_STATUS \</span>
<span class="cp">		NIG_MASK_INTERRUPT_PORT0_REG_MASK_XGXS0_LINK_STATUS</span>
<span class="cp">#define NIG_MASK_SERDES0_LINK_STATUS \</span>
<span class="cp">		NIG_MASK_INTERRUPT_PORT0_REG_MASK_SERDES0_LINK_STATUS</span>

<span class="cp">#define MDIO_AN_CL73_OR_37_COMPLETE \</span>
<span class="cp">		(MDIO_GP_STATUS_TOP_AN_STATUS1_CL73_AUTONEG_COMPLETE | \</span>
<span class="cp">		 MDIO_GP_STATUS_TOP_AN_STATUS1_CL37_AUTONEG_COMPLETE)</span>

<span class="cp">#define XGXS_RESET_BITS \</span>
<span class="cp">	(MISC_REGISTERS_RESET_REG_3_MISC_NIG_MUX_XGXS0_RSTB_HW |   \</span>
<span class="cp">	 MISC_REGISTERS_RESET_REG_3_MISC_NIG_MUX_XGXS0_IDDQ |      \</span>
<span class="cp">	 MISC_REGISTERS_RESET_REG_3_MISC_NIG_MUX_XGXS0_PWRDWN |    \</span>
<span class="cp">	 MISC_REGISTERS_RESET_REG_3_MISC_NIG_MUX_XGXS0_PWRDWN_SD | \</span>
<span class="cp">	 MISC_REGISTERS_RESET_REG_3_MISC_NIG_MUX_XGXS0_TXD_FIFO_RSTB)</span>

<span class="cp">#define SERDES_RESET_BITS \</span>
<span class="cp">	(MISC_REGISTERS_RESET_REG_3_MISC_NIG_MUX_SERDES0_RSTB_HW | \</span>
<span class="cp">	 MISC_REGISTERS_RESET_REG_3_MISC_NIG_MUX_SERDES0_IDDQ |    \</span>
<span class="cp">	 MISC_REGISTERS_RESET_REG_3_MISC_NIG_MUX_SERDES0_PWRDWN |  \</span>
<span class="cp">	 MISC_REGISTERS_RESET_REG_3_MISC_NIG_MUX_SERDES0_PWRDWN_SD)</span>

<span class="cp">#define AUTONEG_CL37		SHARED_HW_CFG_AN_ENABLE_CL37</span>
<span class="cp">#define AUTONEG_CL73		SHARED_HW_CFG_AN_ENABLE_CL73</span>
<span class="cp">#define AUTONEG_BAM		SHARED_HW_CFG_AN_ENABLE_BAM</span>
<span class="cp">#define AUTONEG_PARALLEL \</span>
<span class="cp">				SHARED_HW_CFG_AN_ENABLE_PARALLEL_DETECTION</span>
<span class="cp">#define AUTONEG_SGMII_FIBER_AUTODET \</span>
<span class="cp">				SHARED_HW_CFG_AN_EN_SGMII_FIBER_AUTO_DETECT</span>
<span class="cp">#define AUTONEG_REMOTE_PHY	SHARED_HW_CFG_AN_ENABLE_REMOTE_PHY</span>

<span class="cp">#define GP_STATUS_PAUSE_RSOLUTION_TXSIDE \</span>
<span class="cp">			MDIO_GP_STATUS_TOP_AN_STATUS1_PAUSE_RSOLUTION_TXSIDE</span>
<span class="cp">#define GP_STATUS_PAUSE_RSOLUTION_RXSIDE \</span>
<span class="cp">			MDIO_GP_STATUS_TOP_AN_STATUS1_PAUSE_RSOLUTION_RXSIDE</span>
<span class="cp">#define GP_STATUS_SPEED_MASK \</span>
<span class="cp">			MDIO_GP_STATUS_TOP_AN_STATUS1_ACTUAL_SPEED_MASK</span>
<span class="cp">#define GP_STATUS_10M	MDIO_GP_STATUS_TOP_AN_STATUS1_ACTUAL_SPEED_10M</span>
<span class="cp">#define GP_STATUS_100M	MDIO_GP_STATUS_TOP_AN_STATUS1_ACTUAL_SPEED_100M</span>
<span class="cp">#define GP_STATUS_1G	MDIO_GP_STATUS_TOP_AN_STATUS1_ACTUAL_SPEED_1G</span>
<span class="cp">#define GP_STATUS_2_5G	MDIO_GP_STATUS_TOP_AN_STATUS1_ACTUAL_SPEED_2_5G</span>
<span class="cp">#define GP_STATUS_5G	MDIO_GP_STATUS_TOP_AN_STATUS1_ACTUAL_SPEED_5G</span>
<span class="cp">#define GP_STATUS_6G	MDIO_GP_STATUS_TOP_AN_STATUS1_ACTUAL_SPEED_6G</span>
<span class="cp">#define GP_STATUS_10G_HIG \</span>
<span class="cp">			MDIO_GP_STATUS_TOP_AN_STATUS1_ACTUAL_SPEED_10G_HIG</span>
<span class="cp">#define GP_STATUS_10G_CX4 \</span>
<span class="cp">			MDIO_GP_STATUS_TOP_AN_STATUS1_ACTUAL_SPEED_10G_CX4</span>
<span class="cp">#define GP_STATUS_1G_KX MDIO_GP_STATUS_TOP_AN_STATUS1_ACTUAL_SPEED_1G_KX</span>
<span class="cp">#define GP_STATUS_10G_KX4 \</span>
<span class="cp">			MDIO_GP_STATUS_TOP_AN_STATUS1_ACTUAL_SPEED_10G_KX4</span>
<span class="cp">#define	GP_STATUS_10G_KR MDIO_GP_STATUS_TOP_AN_STATUS1_ACTUAL_SPEED_10G_KR</span>
<span class="cp">#define	GP_STATUS_10G_XFI   MDIO_GP_STATUS_TOP_AN_STATUS1_ACTUAL_SPEED_10G_XFI</span>
<span class="cp">#define	GP_STATUS_20G_DXGXS MDIO_GP_STATUS_TOP_AN_STATUS1_ACTUAL_SPEED_20G_DXGXS</span>
<span class="cp">#define	GP_STATUS_10G_SFI   MDIO_GP_STATUS_TOP_AN_STATUS1_ACTUAL_SPEED_10G_SFI</span>
<span class="cp">#define LINK_10THD		LINK_STATUS_SPEED_AND_DUPLEX_10THD</span>
<span class="cp">#define LINK_10TFD		LINK_STATUS_SPEED_AND_DUPLEX_10TFD</span>
<span class="cp">#define LINK_100TXHD		LINK_STATUS_SPEED_AND_DUPLEX_100TXHD</span>
<span class="cp">#define LINK_100T4		LINK_STATUS_SPEED_AND_DUPLEX_100T4</span>
<span class="cp">#define LINK_100TXFD		LINK_STATUS_SPEED_AND_DUPLEX_100TXFD</span>
<span class="cp">#define LINK_1000THD		LINK_STATUS_SPEED_AND_DUPLEX_1000THD</span>
<span class="cp">#define LINK_1000TFD		LINK_STATUS_SPEED_AND_DUPLEX_1000TFD</span>
<span class="cp">#define LINK_1000XFD		LINK_STATUS_SPEED_AND_DUPLEX_1000XFD</span>
<span class="cp">#define LINK_2500THD		LINK_STATUS_SPEED_AND_DUPLEX_2500THD</span>
<span class="cp">#define LINK_2500TFD		LINK_STATUS_SPEED_AND_DUPLEX_2500TFD</span>
<span class="cp">#define LINK_2500XFD		LINK_STATUS_SPEED_AND_DUPLEX_2500XFD</span>
<span class="cp">#define LINK_10GTFD		LINK_STATUS_SPEED_AND_DUPLEX_10GTFD</span>
<span class="cp">#define LINK_10GXFD		LINK_STATUS_SPEED_AND_DUPLEX_10GXFD</span>
<span class="cp">#define LINK_20GTFD		LINK_STATUS_SPEED_AND_DUPLEX_20GTFD</span>
<span class="cp">#define LINK_20GXFD		LINK_STATUS_SPEED_AND_DUPLEX_20GXFD</span>



<span class="cp">#define SFP_EEPROM_CON_TYPE_ADDR		0x2</span>
	<span class="cp">#define SFP_EEPROM_CON_TYPE_VAL_LC	0x7</span>
	<span class="cp">#define SFP_EEPROM_CON_TYPE_VAL_COPPER	0x21</span>


<span class="cp">#define SFP_EEPROM_COMP_CODE_ADDR		0x3</span>
	<span class="cp">#define SFP_EEPROM_COMP_CODE_SR_MASK	(1&lt;&lt;4)</span>
	<span class="cp">#define SFP_EEPROM_COMP_CODE_LR_MASK	(1&lt;&lt;5)</span>
	<span class="cp">#define SFP_EEPROM_COMP_CODE_LRM_MASK	(1&lt;&lt;6)</span>

<span class="cp">#define SFP_EEPROM_FC_TX_TECH_ADDR		0x8</span>
	<span class="cp">#define SFP_EEPROM_FC_TX_TECH_BITMASK_COPPER_PASSIVE 0x4</span>
	<span class="cp">#define SFP_EEPROM_FC_TX_TECH_BITMASK_COPPER_ACTIVE  0x8</span>

<span class="cp">#define SFP_EEPROM_OPTIONS_ADDR			0x40</span>
	<span class="cp">#define SFP_EEPROM_OPTIONS_LINEAR_RX_OUT_MASK 0x1</span>
<span class="cp">#define SFP_EEPROM_OPTIONS_SIZE			2</span>

<span class="cp">#define EDC_MODE_LINEAR				0x0022</span>
<span class="cp">#define EDC_MODE_LIMITING				0x0044</span>
<span class="cp">#define EDC_MODE_PASSIVE_DAC			0x0055</span>

<span class="cm">/* BRB default for class 0 E2 */</span>
<span class="cp">#define DEFAULT0_E2_BRB_MAC_PAUSE_XOFF_THR	170</span>
<span class="cp">#define DEFAULT0_E2_BRB_MAC_PAUSE_XON_THR		250</span>
<span class="cp">#define DEFAULT0_E2_BRB_MAC_FULL_XOFF_THR		10</span>
<span class="cp">#define DEFAULT0_E2_BRB_MAC_FULL_XON_THR		50</span>

<span class="cm">/* BRB thresholds for E2*/</span>
<span class="cp">#define PFC_E2_BRB_MAC_PAUSE_XOFF_THR_PAUSE		170</span>
<span class="cp">#define PFC_E2_BRB_MAC_PAUSE_XOFF_THR_NON_PAUSE		0</span>

<span class="cp">#define PFC_E2_BRB_MAC_PAUSE_XON_THR_PAUSE		250</span>
<span class="cp">#define PFC_E2_BRB_MAC_PAUSE_XON_THR_NON_PAUSE		0</span>

<span class="cp">#define PFC_E2_BRB_MAC_FULL_XOFF_THR_PAUSE		10</span>
<span class="cp">#define PFC_E2_BRB_MAC_FULL_XOFF_THR_NON_PAUSE		90</span>

<span class="cp">#define PFC_E2_BRB_MAC_FULL_XON_THR_PAUSE			50</span>
<span class="cp">#define PFC_E2_BRB_MAC_FULL_XON_THR_NON_PAUSE		250</span>

<span class="cm">/* BRB default for class 0 E3A0 */</span>
<span class="cp">#define DEFAULT0_E3A0_BRB_MAC_PAUSE_XOFF_THR	290</span>
<span class="cp">#define DEFAULT0_E3A0_BRB_MAC_PAUSE_XON_THR	410</span>
<span class="cp">#define DEFAULT0_E3A0_BRB_MAC_FULL_XOFF_THR	10</span>
<span class="cp">#define DEFAULT0_E3A0_BRB_MAC_FULL_XON_THR	50</span>

<span class="cm">/* BRB thresholds for E3A0 */</span>
<span class="cp">#define PFC_E3A0_BRB_MAC_PAUSE_XOFF_THR_PAUSE		290</span>
<span class="cp">#define PFC_E3A0_BRB_MAC_PAUSE_XOFF_THR_NON_PAUSE		0</span>

<span class="cp">#define PFC_E3A0_BRB_MAC_PAUSE_XON_THR_PAUSE		410</span>
<span class="cp">#define PFC_E3A0_BRB_MAC_PAUSE_XON_THR_NON_PAUSE		0</span>

<span class="cp">#define PFC_E3A0_BRB_MAC_FULL_XOFF_THR_PAUSE		10</span>
<span class="cp">#define PFC_E3A0_BRB_MAC_FULL_XOFF_THR_NON_PAUSE		170</span>

<span class="cp">#define PFC_E3A0_BRB_MAC_FULL_XON_THR_PAUSE		50</span>
<span class="cp">#define PFC_E3A0_BRB_MAC_FULL_XON_THR_NON_PAUSE		410</span>

<span class="cm">/* BRB default for E3B0 */</span>
<span class="cp">#define DEFAULT0_E3B0_BRB_MAC_PAUSE_XOFF_THR	330</span>
<span class="cp">#define DEFAULT0_E3B0_BRB_MAC_PAUSE_XON_THR	490</span>
<span class="cp">#define DEFAULT0_E3B0_BRB_MAC_FULL_XOFF_THR	15</span>
<span class="cp">#define DEFAULT0_E3B0_BRB_MAC_FULL_XON_THR	55</span>

<span class="cm">/* BRB thresholds for E3B0 2 port mode*/</span>
<span class="cp">#define PFC_E3B0_2P_BRB_MAC_PAUSE_XOFF_THR_PAUSE		1025</span>
<span class="cp">#define PFC_E3B0_2P_BRB_MAC_PAUSE_XOFF_THR_NON_PAUSE	0</span>

<span class="cp">#define PFC_E3B0_2P_BRB_MAC_PAUSE_XON_THR_PAUSE		1025</span>
<span class="cp">#define PFC_E3B0_2P_BRB_MAC_PAUSE_XON_THR_NON_PAUSE	0</span>

<span class="cp">#define PFC_E3B0_2P_BRB_MAC_FULL_XOFF_THR_PAUSE		10</span>
<span class="cp">#define PFC_E3B0_2P_BRB_MAC_FULL_XOFF_THR_NON_PAUSE	1025</span>

<span class="cp">#define PFC_E3B0_2P_BRB_MAC_FULL_XON_THR_PAUSE		50</span>
<span class="cp">#define PFC_E3B0_2P_BRB_MAC_FULL_XON_THR_NON_PAUSE	1025</span>

<span class="cm">/* only for E3B0*/</span>
<span class="cp">#define PFC_E3B0_2P_BRB_FULL_LB_XOFF_THR			1025</span>
<span class="cp">#define PFC_E3B0_2P_BRB_FULL_LB_XON_THR			1025</span>

<span class="cm">/* Lossy +Lossless GUARANTIED == GUART */</span>
<span class="cp">#define PFC_E3B0_2P_MIX_PAUSE_LB_GUART			284</span>
<span class="cm">/* Lossless +Lossless*/</span>
<span class="cp">#define PFC_E3B0_2P_PAUSE_LB_GUART			236</span>
<span class="cm">/* Lossy +Lossy*/</span>
<span class="cp">#define PFC_E3B0_2P_NON_PAUSE_LB_GUART			342</span>

<span class="cm">/* Lossy +Lossless*/</span>
<span class="cp">#define PFC_E3B0_2P_MIX_PAUSE_MAC_0_CLASS_T_GUART		284</span>
<span class="cm">/* Lossless +Lossless*/</span>
<span class="cp">#define PFC_E3B0_2P_PAUSE_MAC_0_CLASS_T_GUART		236</span>
<span class="cm">/* Lossy +Lossy*/</span>
<span class="cp">#define PFC_E3B0_2P_NON_PAUSE_MAC_0_CLASS_T_GUART		336</span>
<span class="cp">#define PFC_E3B0_2P_BRB_MAC_0_CLASS_T_GUART_HYST		80</span>

<span class="cp">#define PFC_E3B0_2P_BRB_MAC_1_CLASS_T_GUART		0</span>
<span class="cp">#define PFC_E3B0_2P_BRB_MAC_1_CLASS_T_GUART_HYST		0</span>

<span class="cm">/* BRB thresholds for E3B0 4 port mode */</span>
<span class="cp">#define PFC_E3B0_4P_BRB_MAC_PAUSE_XOFF_THR_PAUSE		304</span>
<span class="cp">#define PFC_E3B0_4P_BRB_MAC_PAUSE_XOFF_THR_NON_PAUSE	0</span>

<span class="cp">#define PFC_E3B0_4P_BRB_MAC_PAUSE_XON_THR_PAUSE		384</span>
<span class="cp">#define PFC_E3B0_4P_BRB_MAC_PAUSE_XON_THR_NON_PAUSE	0</span>

<span class="cp">#define PFC_E3B0_4P_BRB_MAC_FULL_XOFF_THR_PAUSE		10</span>
<span class="cp">#define PFC_E3B0_4P_BRB_MAC_FULL_XOFF_THR_NON_PAUSE	304</span>

<span class="cp">#define PFC_E3B0_4P_BRB_MAC_FULL_XON_THR_PAUSE		50</span>
<span class="cp">#define PFC_E3B0_4P_BRB_MAC_FULL_XON_THR_NON_PAUSE	384</span>

<span class="cm">/* only for E3B0*/</span>
<span class="cp">#define PFC_E3B0_4P_BRB_FULL_LB_XOFF_THR			304</span>
<span class="cp">#define PFC_E3B0_4P_BRB_FULL_LB_XON_THR			384</span>
<span class="cp">#define PFC_E3B0_4P_LB_GUART		120</span>

<span class="cp">#define PFC_E3B0_4P_BRB_MAC_0_CLASS_T_GUART		120</span>
<span class="cp">#define PFC_E3B0_4P_BRB_MAC_0_CLASS_T_GUART_HYST	80</span>

<span class="cp">#define PFC_E3B0_4P_BRB_MAC_1_CLASS_T_GUART		80</span>
<span class="cp">#define PFC_E3B0_4P_BRB_MAC_1_CLASS_T_GUART_HYST	120</span>

<span class="cm">/* Pause defines*/</span>
<span class="cp">#define DEFAULT_E3B0_BRB_FULL_LB_XOFF_THR			330</span>
<span class="cp">#define DEFAULT_E3B0_BRB_FULL_LB_XON_THR			490</span>
<span class="cp">#define DEFAULT_E3B0_LB_GUART		40</span>

<span class="cp">#define DEFAULT_E3B0_BRB_MAC_0_CLASS_T_GUART		40</span>
<span class="cp">#define DEFAULT_E3B0_BRB_MAC_0_CLASS_T_GUART_HYST	0</span>

<span class="cp">#define DEFAULT_E3B0_BRB_MAC_1_CLASS_T_GUART		40</span>
<span class="cp">#define DEFAULT_E3B0_BRB_MAC_1_CLASS_T_GUART_HYST	0</span>

<span class="cm">/* ETS defines*/</span>
<span class="cp">#define DCBX_INVALID_COS					(0xFF)</span>

<span class="cp">#define ETS_BW_LIMIT_CREDIT_UPPER_BOUND		(0x5000)</span>
<span class="cp">#define ETS_BW_LIMIT_CREDIT_WEIGHT		(0x5000)</span>
<span class="cp">#define ETS_E3B0_NIG_MIN_W_VAL_UP_TO_10GBPS		(1360)</span>
<span class="cp">#define ETS_E3B0_NIG_MIN_W_VAL_20GBPS			(2720)</span>
<span class="cp">#define ETS_E3B0_PBF_MIN_W_VAL				(10000)</span>

<span class="cp">#define MAX_PACKET_SIZE					(9700)</span>
<span class="cp">#define WC_UC_TIMEOUT					100</span>
<span class="cp">#define MAX_KR_LINK_RETRY				4</span>

<span class="cm">/**********************************************************/</span>
<span class="cm">/*                     INTERFACE                          */</span>
<span class="cm">/**********************************************************/</span>

<span class="cp">#define CL22_WR_OVER_CL45(_bp, _phy, _bank, _addr, _val) \</span>
<span class="cp">	bnx2x_cl45_write(_bp, _phy, \</span>
<span class="cp">		(_phy)-&gt;def_md_devad, \</span>
<span class="cp">		(_bank + (_addr &amp; 0xf)), \</span>
<span class="cp">		_val)</span>

<span class="cp">#define CL22_RD_OVER_CL45(_bp, _phy, _bank, _addr, _val) \</span>
<span class="cp">	bnx2x_cl45_read(_bp, _phy, \</span>
<span class="cp">		(_phy)-&gt;def_md_devad, \</span>
<span class="cp">		(_bank + (_addr &amp; 0xf)), \</span>
<span class="cp">		_val)</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">bnx2x_bits_en</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">,</span> <span class="n">u32</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u32</span> <span class="n">bits</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">val</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

	<span class="n">val</span> <span class="o">|=</span> <span class="n">bits</span><span class="p">;</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">val</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">bnx2x_bits_dis</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">,</span> <span class="n">u32</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u32</span> <span class="n">bits</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">val</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

	<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">bits</span><span class="p">;</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">val</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/******************************************************************/</span>
<span class="cm">/*			EPIO/GPIO section			  */</span>
<span class="cm">/******************************************************************/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_get_epio</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">,</span> <span class="n">u32</span> <span class="n">epio_pin</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">en</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">epio_mask</span><span class="p">,</span> <span class="n">gp_oenable</span><span class="p">;</span>
	<span class="o">*</span><span class="n">en</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="cm">/* Sanity check */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">epio_pin</span> <span class="o">&gt;</span> <span class="mi">31</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;Invalid EPIO pin %d to get</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">epio_pin</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">epio_mask</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">epio_pin</span><span class="p">;</span>
	<span class="cm">/* Set this EPIO to output */</span>
	<span class="n">gp_oenable</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">MCP_REG_MCPR_GP_OENABLE</span><span class="p">);</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">MCP_REG_MCPR_GP_OENABLE</span><span class="p">,</span> <span class="n">gp_oenable</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">epio_mask</span><span class="p">);</span>

	<span class="o">*</span><span class="n">en</span> <span class="o">=</span> <span class="p">(</span><span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">MCP_REG_MCPR_GP_INPUTS</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">epio_mask</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">epio_pin</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_set_epio</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">,</span> <span class="n">u32</span> <span class="n">epio_pin</span><span class="p">,</span> <span class="n">u32</span> <span class="n">en</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">epio_mask</span><span class="p">,</span> <span class="n">gp_output</span><span class="p">,</span> <span class="n">gp_oenable</span><span class="p">;</span>

	<span class="cm">/* Sanity check */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">epio_pin</span> <span class="o">&gt;</span> <span class="mi">31</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;Invalid EPIO pin %d to set</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">epio_pin</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;Setting EPIO pin %d to %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">epio_pin</span><span class="p">,</span> <span class="n">en</span><span class="p">);</span>
	<span class="n">epio_mask</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">epio_pin</span><span class="p">;</span>
	<span class="cm">/* Set this EPIO to output */</span>
	<span class="n">gp_output</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">MCP_REG_MCPR_GP_OUTPUTS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">en</span><span class="p">)</span>
		<span class="n">gp_output</span> <span class="o">|=</span> <span class="n">epio_mask</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">gp_output</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">epio_mask</span><span class="p">;</span>

	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">MCP_REG_MCPR_GP_OUTPUTS</span><span class="p">,</span> <span class="n">gp_output</span><span class="p">);</span>

	<span class="cm">/* Set the value for this EPIO */</span>
	<span class="n">gp_oenable</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">MCP_REG_MCPR_GP_OENABLE</span><span class="p">);</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">MCP_REG_MCPR_GP_OENABLE</span><span class="p">,</span> <span class="n">gp_oenable</span> <span class="o">|</span> <span class="n">epio_mask</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_set_cfg_pin</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">,</span> <span class="n">u32</span> <span class="n">pin_cfg</span><span class="p">,</span> <span class="n">u32</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pin_cfg</span> <span class="o">==</span> <span class="n">PIN_CFG_NA</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pin_cfg</span> <span class="o">&gt;=</span> <span class="n">PIN_CFG_EPIO0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bnx2x_set_epio</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">pin_cfg</span> <span class="o">-</span> <span class="n">PIN_CFG_EPIO0</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="n">gpio_num</span> <span class="o">=</span> <span class="p">(</span><span class="n">pin_cfg</span> <span class="o">-</span> <span class="n">PIN_CFG_GPIO0_P0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3</span><span class="p">;</span>
		<span class="n">u8</span> <span class="n">gpio_port</span> <span class="o">=</span> <span class="p">(</span><span class="n">pin_cfg</span> <span class="o">-</span> <span class="n">PIN_CFG_GPIO0_P0</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">bnx2x_set_gpio</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">gpio_num</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">val</span><span class="p">,</span> <span class="n">gpio_port</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">bnx2x_get_cfg_pin</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">,</span> <span class="n">u32</span> <span class="n">pin_cfg</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pin_cfg</span> <span class="o">==</span> <span class="n">PIN_CFG_NA</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pin_cfg</span> <span class="o">&gt;=</span> <span class="n">PIN_CFG_EPIO0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bnx2x_get_epio</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">pin_cfg</span> <span class="o">-</span> <span class="n">PIN_CFG_EPIO0</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="n">gpio_num</span> <span class="o">=</span> <span class="p">(</span><span class="n">pin_cfg</span> <span class="o">-</span> <span class="n">PIN_CFG_GPIO0_P0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3</span><span class="p">;</span>
		<span class="n">u8</span> <span class="n">gpio_port</span> <span class="o">=</span> <span class="p">(</span><span class="n">pin_cfg</span> <span class="o">-</span> <span class="n">PIN_CFG_GPIO0_P0</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">;</span>
		<span class="o">*</span><span class="n">val</span> <span class="o">=</span> <span class="n">bnx2x_get_gpio</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">gpio_num</span><span class="p">,</span> <span class="n">gpio_port</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="p">}</span>
<span class="cm">/******************************************************************/</span>
<span class="cm">/*				ETS section			  */</span>
<span class="cm">/******************************************************************/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_ets_e2e3a0_disabled</span><span class="p">(</span><span class="k">struct</span> <span class="n">link_params</span> <span class="o">*</span><span class="n">params</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* ETS disabled configuration*/</span>
	<span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">bp</span><span class="p">;</span>

	<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;ETS E2E3 disabled configuration</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* mapping between entry  priority to client number (0,1,2 -debug and</span>
<span class="cm">	 * management clients, 3 - COS0 client, 4 - COS client)(HIGHEST)</span>
<span class="cm">	 * 3bits client num.</span>
<span class="cm">	 *   PRI4    |    PRI3    |    PRI2    |    PRI1    |    PRI0</span>
<span class="cm">	 * cos1-100     cos0-011     dbg1-010     dbg0-001     MCP-000</span>
<span class="cm">	 */</span>

	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">NIG_REG_P0_TX_ARB_PRIORITY_CLIENT</span><span class="p">,</span> <span class="mh">0x4688</span><span class="p">);</span>
	<span class="cm">/* Bitmap of 5bits length. Each bit specifies whether the entry behaves</span>
<span class="cm">	 * as strict.  Bits 0,1,2 - debug and management entries, 3 -</span>
<span class="cm">	 * COS0 entry, 4 - COS1 entry.</span>
<span class="cm">	 * COS1 | COS0 | DEBUG1 | DEBUG0 | MGMT</span>
<span class="cm">	 * bit4   bit3	  bit2   bit1	  bit0</span>
<span class="cm">	 * MCP and debug are strict</span>
<span class="cm">	 */</span>

	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">NIG_REG_P0_TX_ARB_CLIENT_IS_STRICT</span><span class="p">,</span> <span class="mh">0x7</span><span class="p">);</span>
	<span class="cm">/* defines which entries (clients) are subjected to WFQ arbitration */</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">NIG_REG_P0_TX_ARB_CLIENT_IS_SUBJECT2WFQ</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="cm">/* For strict priority entries defines the number of consecutive</span>
<span class="cm">	 * slots for the highest priority.</span>
<span class="cm">	 */</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">NIG_REG_P0_TX_ARB_NUM_STRICT_ARB_SLOTS</span><span class="p">,</span> <span class="mh">0x100</span><span class="p">);</span>
	<span class="cm">/* mapping between the CREDIT_WEIGHT registers and actual client</span>
<span class="cm">	 * numbers</span>
<span class="cm">	 */</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">NIG_REG_P0_TX_ARB_CLIENT_CREDIT_MAP</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">NIG_REG_P0_TX_ARB_CREDIT_WEIGHT_0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">NIG_REG_P0_TX_ARB_CREDIT_WEIGHT_1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">NIG_REG_P0_TX_ARB_CREDIT_UPPER_BOUND_0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">NIG_REG_P0_TX_ARB_CREDIT_UPPER_BOUND_1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">PBF_REG_HIGH_PRIORITY_COS_NUM</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="cm">/* ETS mode disable */</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">PBF_REG_ETS_ENABLED</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="cm">/* If ETS mode is enabled (there is no strict priority) defines a WFQ</span>
<span class="cm">	 * weight for COS0/COS1.</span>
<span class="cm">	 */</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">PBF_REG_COS0_WEIGHT</span><span class="p">,</span> <span class="mh">0x2710</span><span class="p">);</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">PBF_REG_COS1_WEIGHT</span><span class="p">,</span> <span class="mh">0x2710</span><span class="p">);</span>
	<span class="cm">/* Upper bound that COS0_WEIGHT can reach in the WFQ arbiter */</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">PBF_REG_COS0_UPPER_BOUND</span><span class="p">,</span> <span class="mh">0x989680</span><span class="p">);</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">PBF_REG_COS1_UPPER_BOUND</span><span class="p">,</span> <span class="mh">0x989680</span><span class="p">);</span>
	<span class="cm">/* Defines the number of consecutive slots for the strict priority */</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">PBF_REG_NUM_STRICT_ARB_SLOTS</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>
<span class="cm">/******************************************************************************</span>
<span class="cm">* Description:</span>
<span class="cm">*	Getting min_w_val will be set according to line speed .</span>
<span class="cm">*.</span>
<span class="cm">******************************************************************************/</span>
<span class="k">static</span> <span class="n">u32</span> <span class="nf">bnx2x_ets_get_min_w_val_nig</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">link_vars</span> <span class="o">*</span><span class="n">vars</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">min_w_val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="cm">/* Calculate min_w_val.*/</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vars</span><span class="o">-&gt;</span><span class="n">link_up</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vars</span><span class="o">-&gt;</span><span class="n">line_speed</span> <span class="o">==</span> <span class="n">SPEED_20000</span><span class="p">)</span>
			<span class="n">min_w_val</span> <span class="o">=</span> <span class="n">ETS_E3B0_NIG_MIN_W_VAL_20GBPS</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">min_w_val</span> <span class="o">=</span> <span class="n">ETS_E3B0_NIG_MIN_W_VAL_UP_TO_10GBPS</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">min_w_val</span> <span class="o">=</span> <span class="n">ETS_E3B0_NIG_MIN_W_VAL_20GBPS</span><span class="p">;</span>
	<span class="cm">/* If the link isn&#39;t up (static configuration for example ) The</span>
<span class="cm">	 * link will be according to 20GBPS.</span>
<span class="cm">	 */</span>
	<span class="k">return</span> <span class="n">min_w_val</span><span class="p">;</span>
<span class="p">}</span>
<span class="cm">/******************************************************************************</span>
<span class="cm">* Description:</span>
<span class="cm">*	Getting credit upper bound form min_w_val.</span>
<span class="cm">*.</span>
<span class="cm">******************************************************************************/</span>
<span class="k">static</span> <span class="n">u32</span> <span class="nf">bnx2x_ets_get_credit_upper_bound</span><span class="p">(</span><span class="k">const</span> <span class="n">u32</span> <span class="n">min_w_val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="n">u32</span> <span class="n">credit_upper_bound</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">MAXVAL</span><span class="p">((</span><span class="mi">150</span> <span class="o">*</span> <span class="n">min_w_val</span><span class="p">),</span>
						<span class="n">MAX_PACKET_SIZE</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">credit_upper_bound</span><span class="p">;</span>
<span class="p">}</span>
<span class="cm">/******************************************************************************</span>
<span class="cm">* Description:</span>
<span class="cm">*	Set credit upper bound for NIG.</span>
<span class="cm">*.</span>
<span class="cm">******************************************************************************/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_ets_e3b0_set_credit_upper_bound_nig</span><span class="p">(</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">link_params</span> <span class="o">*</span><span class="n">params</span><span class="p">,</span>
	<span class="k">const</span> <span class="n">u32</span> <span class="n">min_w_val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">bp</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">u8</span> <span class="n">port</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">u32</span> <span class="n">credit_upper_bound</span> <span class="o">=</span>
	    <span class="n">bnx2x_ets_get_credit_upper_bound</span><span class="p">(</span><span class="n">min_w_val</span><span class="p">);</span>

	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="p">(</span><span class="n">port</span><span class="p">)</span> <span class="o">?</span> <span class="n">NIG_REG_P1_TX_ARB_CREDIT_UPPER_BOUND_0</span> <span class="o">:</span>
		<span class="n">NIG_REG_P0_TX_ARB_CREDIT_UPPER_BOUND_0</span><span class="p">,</span> <span class="n">credit_upper_bound</span><span class="p">);</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="p">(</span><span class="n">port</span><span class="p">)</span> <span class="o">?</span> <span class="n">NIG_REG_P1_TX_ARB_CREDIT_UPPER_BOUND_1</span> <span class="o">:</span>
		   <span class="n">NIG_REG_P0_TX_ARB_CREDIT_UPPER_BOUND_1</span><span class="p">,</span> <span class="n">credit_upper_bound</span><span class="p">);</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="p">(</span><span class="n">port</span><span class="p">)</span> <span class="o">?</span> <span class="n">NIG_REG_P1_TX_ARB_CREDIT_UPPER_BOUND_2</span> <span class="o">:</span>
		   <span class="n">NIG_REG_P0_TX_ARB_CREDIT_UPPER_BOUND_2</span><span class="p">,</span> <span class="n">credit_upper_bound</span><span class="p">);</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="p">(</span><span class="n">port</span><span class="p">)</span> <span class="o">?</span> <span class="n">NIG_REG_P1_TX_ARB_CREDIT_UPPER_BOUND_3</span> <span class="o">:</span>
		   <span class="n">NIG_REG_P0_TX_ARB_CREDIT_UPPER_BOUND_3</span><span class="p">,</span> <span class="n">credit_upper_bound</span><span class="p">);</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="p">(</span><span class="n">port</span><span class="p">)</span> <span class="o">?</span> <span class="n">NIG_REG_P1_TX_ARB_CREDIT_UPPER_BOUND_4</span> <span class="o">:</span>
		   <span class="n">NIG_REG_P0_TX_ARB_CREDIT_UPPER_BOUND_4</span><span class="p">,</span> <span class="n">credit_upper_bound</span><span class="p">);</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="p">(</span><span class="n">port</span><span class="p">)</span> <span class="o">?</span> <span class="n">NIG_REG_P1_TX_ARB_CREDIT_UPPER_BOUND_5</span> <span class="o">:</span>
		   <span class="n">NIG_REG_P0_TX_ARB_CREDIT_UPPER_BOUND_5</span><span class="p">,</span> <span class="n">credit_upper_bound</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">port</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">NIG_REG_P0_TX_ARB_CREDIT_UPPER_BOUND_6</span><span class="p">,</span>
			<span class="n">credit_upper_bound</span><span class="p">);</span>
		<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">NIG_REG_P0_TX_ARB_CREDIT_UPPER_BOUND_7</span><span class="p">,</span>
			<span class="n">credit_upper_bound</span><span class="p">);</span>
		<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">NIG_REG_P0_TX_ARB_CREDIT_UPPER_BOUND_8</span><span class="p">,</span>
			<span class="n">credit_upper_bound</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="cm">/******************************************************************************</span>
<span class="cm">* Description:</span>
<span class="cm">*	Will return the NIG ETS registers to init values.Except</span>
<span class="cm">*	credit_upper_bound.</span>
<span class="cm">*	That isn&#39;t used in this configuration (No WFQ is enabled) and will be</span>
<span class="cm">*	configured acording to spec</span>
<span class="cm">*.</span>
<span class="cm">******************************************************************************/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_ets_e3b0_nig_disabled</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">link_params</span> <span class="o">*</span><span class="n">params</span><span class="p">,</span>
					<span class="k">const</span> <span class="k">struct</span> <span class="n">link_vars</span> <span class="o">*</span><span class="n">vars</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">bp</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">u8</span> <span class="n">port</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">u32</span> <span class="n">min_w_val</span> <span class="o">=</span> <span class="n">bnx2x_ets_get_min_w_val_nig</span><span class="p">(</span><span class="n">vars</span><span class="p">);</span>
	<span class="cm">/* Mapping between entry  priority to client number (0,1,2 -debug and</span>
<span class="cm">	 * management clients, 3 - COS0 client, 4 - COS1, ... 8 -</span>
<span class="cm">	 * COS5)(HIGHEST) 4bits client num.TODO_ETS - Should be done by</span>
<span class="cm">	 * reset value or init tool</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">port</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">NIG_REG_P1_TX_ARB_PRIORITY_CLIENT2_LSB</span><span class="p">,</span> <span class="mh">0x543210</span><span class="p">);</span>
		<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">NIG_REG_P1_TX_ARB_PRIORITY_CLIENT2_MSB</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">NIG_REG_P0_TX_ARB_PRIORITY_CLIENT2_LSB</span><span class="p">,</span> <span class="mh">0x76543210</span><span class="p">);</span>
		<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">NIG_REG_P0_TX_ARB_PRIORITY_CLIENT2_MSB</span><span class="p">,</span> <span class="mh">0x8</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/* For strict priority entries defines the number of consecutive</span>
<span class="cm">	 * slots for the highest priority.</span>
<span class="cm">	 */</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="p">(</span><span class="n">port</span><span class="p">)</span> <span class="o">?</span> <span class="n">NIG_REG_P1_TX_ARB_NUM_STRICT_ARB_SLOTS</span> <span class="o">:</span>
		   <span class="n">NIG_REG_P1_TX_ARB_NUM_STRICT_ARB_SLOTS</span><span class="p">,</span> <span class="mh">0x100</span><span class="p">);</span>
	<span class="cm">/* Mapping between the CREDIT_WEIGHT registers and actual client</span>
<span class="cm">	 * numbers</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">port</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*Port 1 has 6 COS*/</span>
		<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">NIG_REG_P1_TX_ARB_CLIENT_CREDIT_MAP2_LSB</span><span class="p">,</span> <span class="mh">0x210543</span><span class="p">);</span>
		<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">NIG_REG_P1_TX_ARB_CLIENT_CREDIT_MAP2_MSB</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/*Port 0 has 9 COS*/</span>
		<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">NIG_REG_P0_TX_ARB_CLIENT_CREDIT_MAP2_LSB</span><span class="p">,</span>
		       <span class="mh">0x43210876</span><span class="p">);</span>
		<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">NIG_REG_P0_TX_ARB_CLIENT_CREDIT_MAP2_MSB</span><span class="p">,</span> <span class="mh">0x5</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Bitmap of 5bits length. Each bit specifies whether the entry behaves</span>
<span class="cm">	 * as strict.  Bits 0,1,2 - debug and management entries, 3 -</span>
<span class="cm">	 * COS0 entry, 4 - COS1 entry.</span>
<span class="cm">	 * COS1 | COS0 | DEBUG1 | DEBUG0 | MGMT</span>
<span class="cm">	 * bit4   bit3	  bit2   bit1	  bit0</span>
<span class="cm">	 * MCP and debug are strict</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">port</span><span class="p">)</span>
		<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">NIG_REG_P1_TX_ARB_CLIENT_IS_STRICT</span><span class="p">,</span> <span class="mh">0x3f</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">NIG_REG_P0_TX_ARB_CLIENT_IS_STRICT</span><span class="p">,</span> <span class="mh">0x1ff</span><span class="p">);</span>
	<span class="cm">/* defines which entries (clients) are subjected to WFQ arbitration */</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="p">(</span><span class="n">port</span><span class="p">)</span> <span class="o">?</span> <span class="n">NIG_REG_P1_TX_ARB_CLIENT_IS_SUBJECT2WFQ</span> <span class="o">:</span>
		   <span class="n">NIG_REG_P0_TX_ARB_CLIENT_IS_SUBJECT2WFQ</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* Please notice the register address are note continuous and a</span>
<span class="cm">	 * for here is note appropriate.In 2 port mode port0 only COS0-5</span>
<span class="cm">	 * can be used. DEBUG1,DEBUG1,MGMT are never used for WFQ* In 4</span>
<span class="cm">	 * port mode port1 only COS0-2 can be used. DEBUG1,DEBUG1,MGMT</span>
<span class="cm">	 * are never used for WFQ</span>
<span class="cm">	 */</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="p">(</span><span class="n">port</span><span class="p">)</span> <span class="o">?</span> <span class="n">NIG_REG_P1_TX_ARB_CREDIT_WEIGHT_0</span> <span class="o">:</span>
		   <span class="n">NIG_REG_P0_TX_ARB_CREDIT_WEIGHT_0</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="p">(</span><span class="n">port</span><span class="p">)</span> <span class="o">?</span> <span class="n">NIG_REG_P1_TX_ARB_CREDIT_WEIGHT_1</span> <span class="o">:</span>
		   <span class="n">NIG_REG_P0_TX_ARB_CREDIT_WEIGHT_1</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="p">(</span><span class="n">port</span><span class="p">)</span> <span class="o">?</span> <span class="n">NIG_REG_P1_TX_ARB_CREDIT_WEIGHT_2</span> <span class="o">:</span>
		   <span class="n">NIG_REG_P0_TX_ARB_CREDIT_WEIGHT_2</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="p">(</span><span class="n">port</span><span class="p">)</span> <span class="o">?</span> <span class="n">NIG_REG_P1_TX_ARB_CREDIT_WEIGHT_3</span> <span class="o">:</span>
		   <span class="n">NIG_REG_P0_TX_ARB_CREDIT_WEIGHT_3</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="p">(</span><span class="n">port</span><span class="p">)</span> <span class="o">?</span> <span class="n">NIG_REG_P1_TX_ARB_CREDIT_WEIGHT_4</span> <span class="o">:</span>
		   <span class="n">NIG_REG_P0_TX_ARB_CREDIT_WEIGHT_4</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="p">(</span><span class="n">port</span><span class="p">)</span> <span class="o">?</span> <span class="n">NIG_REG_P1_TX_ARB_CREDIT_WEIGHT_5</span> <span class="o">:</span>
		   <span class="n">NIG_REG_P0_TX_ARB_CREDIT_WEIGHT_5</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">port</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">NIG_REG_P0_TX_ARB_CREDIT_WEIGHT_6</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>
		<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">NIG_REG_P0_TX_ARB_CREDIT_WEIGHT_7</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>
		<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">NIG_REG_P0_TX_ARB_CREDIT_WEIGHT_8</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">bnx2x_ets_e3b0_set_credit_upper_bound_nig</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">min_w_val</span><span class="p">);</span>
<span class="p">}</span>
<span class="cm">/******************************************************************************</span>
<span class="cm">* Description:</span>
<span class="cm">*	Set credit upper bound for PBF.</span>
<span class="cm">*.</span>
<span class="cm">******************************************************************************/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_ets_e3b0_set_credit_upper_bound_pbf</span><span class="p">(</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">link_params</span> <span class="o">*</span><span class="n">params</span><span class="p">,</span>
	<span class="k">const</span> <span class="n">u32</span> <span class="n">min_w_val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">bp</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">u32</span> <span class="n">credit_upper_bound</span> <span class="o">=</span>
	    <span class="n">bnx2x_ets_get_credit_upper_bound</span><span class="p">(</span><span class="n">min_w_val</span><span class="p">);</span>
	<span class="k">const</span> <span class="n">u8</span> <span class="n">port</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">base_upper_bound</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">max_cos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="cm">/* In 2 port mode port0 has COS0-5 that can be used for WFQ.In 4</span>
<span class="cm">	 * port mode port1 has COS0-2 that can be used for WFQ.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">port</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">base_upper_bound</span> <span class="o">=</span> <span class="n">PBF_REG_COS0_UPPER_BOUND_P0</span><span class="p">;</span>
		<span class="n">max_cos</span> <span class="o">=</span> <span class="n">DCBX_E3B0_MAX_NUM_COS_PORT0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">base_upper_bound</span> <span class="o">=</span> <span class="n">PBF_REG_COS0_UPPER_BOUND_P1</span><span class="p">;</span>
		<span class="n">max_cos</span> <span class="o">=</span> <span class="n">DCBX_E3B0_MAX_NUM_COS_PORT1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">max_cos</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">base_upper_bound</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">),</span> <span class="n">credit_upper_bound</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/******************************************************************************</span>
<span class="cm">* Description:</span>
<span class="cm">*	Will return the PBF ETS registers to init values.Except</span>
<span class="cm">*	credit_upper_bound.</span>
<span class="cm">*	That isn&#39;t used in this configuration (No WFQ is enabled) and will be</span>
<span class="cm">*	configured acording to spec</span>
<span class="cm">*.</span>
<span class="cm">******************************************************************************/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_ets_e3b0_pbf_disabled</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">link_params</span> <span class="o">*</span><span class="n">params</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">bp</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">u8</span> <span class="n">port</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">u32</span> <span class="n">min_w_val_pbf</span> <span class="o">=</span> <span class="n">ETS_E3B0_PBF_MIN_W_VAL</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">base_weight</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">max_cos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Mapping between entry  priority to client number 0 - COS0</span>
<span class="cm">	 * client, 2 - COS1, ... 5 - COS5)(HIGHEST) 4bits client num.</span>
<span class="cm">	 * TODO_ETS - Should be done by reset value or init tool</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">port</span><span class="p">)</span>
		<span class="cm">/*  0x688 (|011|0 10|00 1|000) */</span>
		<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">PBF_REG_ETS_ARB_PRIORITY_CLIENT_P1</span> <span class="p">,</span> <span class="mh">0x688</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="cm">/*  (10 1|100 |011|0 10|00 1|000) */</span>
		<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">PBF_REG_ETS_ARB_PRIORITY_CLIENT_P0</span> <span class="p">,</span> <span class="mh">0x2C688</span><span class="p">);</span>

	<span class="cm">/* TODO_ETS - Should be done by reset value or init tool */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">port</span><span class="p">)</span>
		<span class="cm">/* 0x688 (|011|0 10|00 1|000)*/</span>
		<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">PBF_REG_ETS_ARB_CLIENT_CREDIT_MAP_P1</span><span class="p">,</span> <span class="mh">0x688</span><span class="p">);</span>
	<span class="k">else</span>
	<span class="cm">/* 0x2C688 (10 1|100 |011|0 10|00 1|000) */</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">PBF_REG_ETS_ARB_CLIENT_CREDIT_MAP_P0</span><span class="p">,</span> <span class="mh">0x2C688</span><span class="p">);</span>

	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="p">(</span><span class="n">port</span><span class="p">)</span> <span class="o">?</span> <span class="n">PBF_REG_ETS_ARB_NUM_STRICT_ARB_SLOTS_P1</span> <span class="o">:</span>
		   <span class="n">PBF_REG_ETS_ARB_NUM_STRICT_ARB_SLOTS_P0</span> <span class="p">,</span> <span class="mh">0x100</span><span class="p">);</span>


	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="p">(</span><span class="n">port</span><span class="p">)</span> <span class="o">?</span> <span class="n">PBF_REG_ETS_ARB_CLIENT_IS_STRICT_P1</span> <span class="o">:</span>
		   <span class="n">PBF_REG_ETS_ARB_CLIENT_IS_STRICT_P0</span> <span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="p">(</span><span class="n">port</span><span class="p">)</span> <span class="o">?</span> <span class="n">PBF_REG_ETS_ARB_CLIENT_IS_SUBJECT2WFQ_P1</span> <span class="o">:</span>
		   <span class="n">PBF_REG_ETS_ARB_CLIENT_IS_SUBJECT2WFQ_P0</span> <span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="cm">/* In 2 port mode port0 has COS0-5 that can be used for WFQ.</span>
<span class="cm">	 * In 4 port mode port1 has COS0-2 that can be used for WFQ.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">port</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">base_weight</span> <span class="o">=</span> <span class="n">PBF_REG_COS0_WEIGHT_P0</span><span class="p">;</span>
		<span class="n">max_cos</span> <span class="o">=</span> <span class="n">DCBX_E3B0_MAX_NUM_COS_PORT0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">base_weight</span> <span class="o">=</span> <span class="n">PBF_REG_COS0_WEIGHT_P1</span><span class="p">;</span>
		<span class="n">max_cos</span> <span class="o">=</span> <span class="n">DCBX_E3B0_MAX_NUM_COS_PORT1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">max_cos</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">base_weight</span> <span class="o">+</span> <span class="p">(</span><span class="mh">0x4</span> <span class="o">*</span> <span class="n">i</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">bnx2x_ets_e3b0_set_credit_upper_bound_pbf</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">min_w_val_pbf</span><span class="p">);</span>
<span class="p">}</span>
<span class="cm">/******************************************************************************</span>
<span class="cm">* Description:</span>
<span class="cm">*	E3B0 disable will return basicly the values to init values.</span>
<span class="cm">*.</span>
<span class="cm">******************************************************************************/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">bnx2x_ets_e3b0_disabled</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">link_params</span> <span class="o">*</span><span class="n">params</span><span class="p">,</span>
				   <span class="k">const</span> <span class="k">struct</span> <span class="n">link_vars</span> <span class="o">*</span><span class="n">vars</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">bp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CHIP_IS_E3B0</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span>
		   <span class="s">&quot;bnx2x_ets_e3b0_disabled the chip isn&#39;t E3B0</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">bnx2x_ets_e3b0_nig_disabled</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">vars</span><span class="p">);</span>

	<span class="n">bnx2x_ets_e3b0_pbf_disabled</span><span class="p">(</span><span class="n">params</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/******************************************************************************</span>
<span class="cm">* Description:</span>
<span class="cm">*	Disable will return basicly the values to init values.</span>
<span class="cm">*</span>
<span class="cm">******************************************************************************/</span>
<span class="kt">int</span> <span class="nf">bnx2x_ets_disabled</span><span class="p">(</span><span class="k">struct</span> <span class="n">link_params</span> <span class="o">*</span><span class="n">params</span><span class="p">,</span>
		      <span class="k">struct</span> <span class="n">link_vars</span> <span class="o">*</span><span class="n">vars</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">bp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bnx2x_status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">CHIP_IS_E2</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span> <span class="o">||</span> <span class="p">(</span><span class="n">CHIP_IS_E3A0</span><span class="p">(</span><span class="n">bp</span><span class="p">)))</span>
		<span class="n">bnx2x_ets_e2e3a0_disabled</span><span class="p">(</span><span class="n">params</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">CHIP_IS_E3B0</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span>
		<span class="n">bnx2x_status</span> <span class="o">=</span> <span class="n">bnx2x_ets_e3b0_disabled</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">vars</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;bnx2x_ets_disabled - chip not supported</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">bnx2x_status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/******************************************************************************</span>
<span class="cm">* Description</span>
<span class="cm">*	Set the COS mappimg to SP and BW until this point all the COS are not</span>
<span class="cm">*	set as SP or BW.</span>
<span class="cm">******************************************************************************/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">bnx2x_ets_e3b0_cli_map</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">link_params</span> <span class="o">*</span><span class="n">params</span><span class="p">,</span>
				  <span class="k">const</span> <span class="k">struct</span> <span class="n">bnx2x_ets_params</span> <span class="o">*</span><span class="n">ets_params</span><span class="p">,</span>
				  <span class="k">const</span> <span class="n">u8</span> <span class="n">cos_sp_bitmap</span><span class="p">,</span>
				  <span class="k">const</span> <span class="n">u8</span> <span class="n">cos_bw_bitmap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">bp</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">u8</span> <span class="n">port</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">u8</span> <span class="n">nig_cli_sp_bitmap</span> <span class="o">=</span> <span class="mh">0x7</span> <span class="o">|</span> <span class="p">(</span><span class="n">cos_sp_bitmap</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">);</span>
	<span class="k">const</span> <span class="n">u8</span> <span class="n">pbf_cli_sp_bitmap</span> <span class="o">=</span> <span class="n">cos_sp_bitmap</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">u8</span> <span class="n">nig_cli_subject2wfq_bitmap</span> <span class="o">=</span> <span class="n">cos_bw_bitmap</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">u8</span> <span class="n">pbf_cli_subject2wfq_bitmap</span> <span class="o">=</span> <span class="n">cos_bw_bitmap</span><span class="p">;</span>

	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="p">(</span><span class="n">port</span><span class="p">)</span> <span class="o">?</span> <span class="n">NIG_REG_P1_TX_ARB_CLIENT_IS_STRICT</span> <span class="o">:</span>
	       <span class="n">NIG_REG_P0_TX_ARB_CLIENT_IS_STRICT</span><span class="p">,</span> <span class="n">nig_cli_sp_bitmap</span><span class="p">);</span>

	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="p">(</span><span class="n">port</span><span class="p">)</span> <span class="o">?</span> <span class="n">PBF_REG_ETS_ARB_CLIENT_IS_STRICT_P1</span> <span class="o">:</span>
	       <span class="n">PBF_REG_ETS_ARB_CLIENT_IS_STRICT_P0</span> <span class="p">,</span> <span class="n">pbf_cli_sp_bitmap</span><span class="p">);</span>

	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="p">(</span><span class="n">port</span><span class="p">)</span> <span class="o">?</span> <span class="n">NIG_REG_P1_TX_ARB_CLIENT_IS_SUBJECT2WFQ</span> <span class="o">:</span>
	       <span class="n">NIG_REG_P0_TX_ARB_CLIENT_IS_SUBJECT2WFQ</span><span class="p">,</span>
	       <span class="n">nig_cli_subject2wfq_bitmap</span><span class="p">);</span>

	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="p">(</span><span class="n">port</span><span class="p">)</span> <span class="o">?</span> <span class="n">PBF_REG_ETS_ARB_CLIENT_IS_SUBJECT2WFQ_P1</span> <span class="o">:</span>
	       <span class="n">PBF_REG_ETS_ARB_CLIENT_IS_SUBJECT2WFQ_P0</span><span class="p">,</span>
	       <span class="n">pbf_cli_subject2wfq_bitmap</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/******************************************************************************</span>
<span class="cm">* Description:</span>
<span class="cm">*	This function is needed because NIG ARB_CREDIT_WEIGHT_X are</span>
<span class="cm">*	not continues and ARB_CREDIT_WEIGHT_0 + offset is suitable.</span>
<span class="cm">******************************************************************************/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">bnx2x_ets_e3b0_set_cos_bw</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">,</span>
				     <span class="k">const</span> <span class="n">u8</span> <span class="n">cos_entry</span><span class="p">,</span>
				     <span class="k">const</span> <span class="n">u32</span> <span class="n">min_w_val_nig</span><span class="p">,</span>
				     <span class="k">const</span> <span class="n">u32</span> <span class="n">min_w_val_pbf</span><span class="p">,</span>
				     <span class="k">const</span> <span class="n">u16</span> <span class="n">total_bw</span><span class="p">,</span>
				     <span class="k">const</span> <span class="n">u8</span> <span class="n">bw</span><span class="p">,</span>
				     <span class="k">const</span> <span class="n">u8</span> <span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">nig_reg_adress_crd_weight</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">pbf_reg_adress_crd_weight</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="cm">/* Calculate and set BW for this COS - use 1 instead of 0 for BW */</span>
	<span class="k">const</span> <span class="n">u32</span> <span class="n">cos_bw_nig</span> <span class="o">=</span> <span class="p">((</span><span class="n">bw</span> <span class="o">?</span> <span class="n">bw</span> <span class="o">:</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">min_w_val_nig</span><span class="p">)</span> <span class="o">/</span> <span class="n">total_bw</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">u32</span> <span class="n">cos_bw_pbf</span> <span class="o">=</span> <span class="p">((</span><span class="n">bw</span> <span class="o">?</span> <span class="n">bw</span> <span class="o">:</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">min_w_val_pbf</span><span class="p">)</span> <span class="o">/</span> <span class="n">total_bw</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cos_entry</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
	    <span class="n">nig_reg_adress_crd_weight</span> <span class="o">=</span>
		 <span class="p">(</span><span class="n">port</span><span class="p">)</span> <span class="o">?</span> <span class="n">NIG_REG_P1_TX_ARB_CREDIT_WEIGHT_0</span> <span class="o">:</span>
		     <span class="n">NIG_REG_P0_TX_ARB_CREDIT_WEIGHT_0</span><span class="p">;</span>
	     <span class="n">pbf_reg_adress_crd_weight</span> <span class="o">=</span> <span class="p">(</span><span class="n">port</span><span class="p">)</span> <span class="o">?</span>
		 <span class="n">PBF_REG_COS0_WEIGHT_P1</span> <span class="o">:</span> <span class="n">PBF_REG_COS0_WEIGHT_P0</span><span class="p">;</span>
	     <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1</span>:
	     <span class="n">nig_reg_adress_crd_weight</span> <span class="o">=</span> <span class="p">(</span><span class="n">port</span><span class="p">)</span> <span class="o">?</span>
		 <span class="n">NIG_REG_P1_TX_ARB_CREDIT_WEIGHT_1</span> <span class="o">:</span>
		 <span class="n">NIG_REG_P0_TX_ARB_CREDIT_WEIGHT_1</span><span class="p">;</span>
	     <span class="n">pbf_reg_adress_crd_weight</span> <span class="o">=</span> <span class="p">(</span><span class="n">port</span><span class="p">)</span> <span class="o">?</span>
		 <span class="n">PBF_REG_COS1_WEIGHT_P1</span> <span class="o">:</span> <span class="n">PBF_REG_COS1_WEIGHT_P0</span><span class="p">;</span>
	     <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>:
	     <span class="n">nig_reg_adress_crd_weight</span> <span class="o">=</span> <span class="p">(</span><span class="n">port</span><span class="p">)</span> <span class="o">?</span>
		 <span class="n">NIG_REG_P1_TX_ARB_CREDIT_WEIGHT_2</span> <span class="o">:</span>
		 <span class="n">NIG_REG_P0_TX_ARB_CREDIT_WEIGHT_2</span><span class="p">;</span>

		 <span class="n">pbf_reg_adress_crd_weight</span> <span class="o">=</span> <span class="p">(</span><span class="n">port</span><span class="p">)</span> <span class="o">?</span>
		     <span class="n">PBF_REG_COS2_WEIGHT_P1</span> <span class="o">:</span> <span class="n">PBF_REG_COS2_WEIGHT_P0</span><span class="p">;</span>
	     <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">3</span>:
	    <span class="k">if</span> <span class="p">(</span><span class="n">port</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	     <span class="n">nig_reg_adress_crd_weight</span> <span class="o">=</span>
		 <span class="n">NIG_REG_P0_TX_ARB_CREDIT_WEIGHT_3</span><span class="p">;</span>
	     <span class="n">pbf_reg_adress_crd_weight</span> <span class="o">=</span>
		 <span class="n">PBF_REG_COS3_WEIGHT_P0</span><span class="p">;</span>
	     <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">4</span>:
	    <span class="k">if</span> <span class="p">(</span><span class="n">port</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	     <span class="n">nig_reg_adress_crd_weight</span> <span class="o">=</span>
		 <span class="n">NIG_REG_P0_TX_ARB_CREDIT_WEIGHT_4</span><span class="p">;</span>
	     <span class="n">pbf_reg_adress_crd_weight</span> <span class="o">=</span> <span class="n">PBF_REG_COS4_WEIGHT_P0</span><span class="p">;</span>
	     <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">5</span>:
	    <span class="k">if</span> <span class="p">(</span><span class="n">port</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	     <span class="n">nig_reg_adress_crd_weight</span> <span class="o">=</span>
		 <span class="n">NIG_REG_P0_TX_ARB_CREDIT_WEIGHT_5</span><span class="p">;</span>
	     <span class="n">pbf_reg_adress_crd_weight</span> <span class="o">=</span> <span class="n">PBF_REG_COS5_WEIGHT_P0</span><span class="p">;</span>
	     <span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">nig_reg_adress_crd_weight</span><span class="p">,</span> <span class="n">cos_bw_nig</span><span class="p">);</span>

	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">pbf_reg_adress_crd_weight</span><span class="p">,</span> <span class="n">cos_bw_pbf</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cm">/******************************************************************************</span>
<span class="cm">* Description:</span>
<span class="cm">*	Calculate the total BW.A value of 0 isn&#39;t legal.</span>
<span class="cm">*</span>
<span class="cm">******************************************************************************/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">bnx2x_ets_e3b0_get_total_bw</span><span class="p">(</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">link_params</span> <span class="o">*</span><span class="n">params</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">bnx2x_ets_params</span> <span class="o">*</span><span class="n">ets_params</span><span class="p">,</span>
	<span class="n">u16</span> <span class="o">*</span><span class="n">total_bw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">bp</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">cos_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">is_bw_cos_exist</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="o">*</span><span class="n">total_bw</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span>
	<span class="cm">/* Calculate total BW requested */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">cos_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">cos_idx</span> <span class="o">&lt;</span> <span class="n">ets_params</span><span class="o">-&gt;</span><span class="n">num_of_cos</span><span class="p">;</span> <span class="n">cos_idx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ets_params</span><span class="o">-&gt;</span><span class="n">cos</span><span class="p">[</span><span class="n">cos_idx</span><span class="p">].</span><span class="n">state</span> <span class="o">==</span> <span class="n">bnx2x_cos_state_bw</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">is_bw_cos_exist</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ets_params</span><span class="o">-&gt;</span><span class="n">cos</span><span class="p">[</span><span class="n">cos_idx</span><span class="p">].</span><span class="n">params</span><span class="p">.</span><span class="n">bw_params</span><span class="p">.</span><span class="n">bw</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;bnx2x_ets_E3B0_config BW&quot;</span>
						   <span class="s">&quot;was set to 0</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="cm">/* This is to prevent a state when ramrods</span>
<span class="cm">				 * can&#39;t be sent</span>
<span class="cm">				 */</span>
				<span class="n">ets_params</span><span class="o">-&gt;</span><span class="n">cos</span><span class="p">[</span><span class="n">cos_idx</span><span class="p">].</span><span class="n">params</span><span class="p">.</span><span class="n">bw_params</span><span class="p">.</span><span class="n">bw</span>
					 <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="o">*</span><span class="n">total_bw</span> <span class="o">+=</span>
				<span class="n">ets_params</span><span class="o">-&gt;</span><span class="n">cos</span><span class="p">[</span><span class="n">cos_idx</span><span class="p">].</span><span class="n">params</span><span class="p">.</span><span class="n">bw_params</span><span class="p">.</span><span class="n">bw</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Check total BW is valid */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">is_bw_cos_exist</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">*</span><span class="n">total_bw</span> <span class="o">!=</span> <span class="mi">100</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">total_bw</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span>
			   <span class="s">&quot;bnx2x_ets_E3B0_config total BW shouldn&#39;t be 0</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span>
		   <span class="s">&quot;bnx2x_ets_E3B0_config total BW should be 100</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="cm">/* We can handle a case whre the BW isn&#39;t 100 this can happen</span>
<span class="cm">		 * if the TC are joined.</span>
<span class="cm">		 */</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/******************************************************************************</span>
<span class="cm">* Description:</span>
<span class="cm">*	Invalidate all the sp_pri_to_cos.</span>
<span class="cm">*</span>
<span class="cm">******************************************************************************/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_ets_e3b0_sp_pri_to_cos_init</span><span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="n">sp_pri_to_cos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">pri</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">pri</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">pri</span> <span class="o">&lt;</span> <span class="n">DCBX_MAX_NUM_COS</span><span class="p">;</span> <span class="n">pri</span><span class="o">++</span><span class="p">)</span>
		<span class="n">sp_pri_to_cos</span><span class="p">[</span><span class="n">pri</span><span class="p">]</span> <span class="o">=</span> <span class="n">DCBX_INVALID_COS</span><span class="p">;</span>
<span class="p">}</span>
<span class="cm">/******************************************************************************</span>
<span class="cm">* Description:</span>
<span class="cm">*	Calculate and set the SP (ARB_PRIORITY_CLIENT) NIG and PBF registers</span>
<span class="cm">*	according to sp_pri_to_cos.</span>
<span class="cm">*</span>
<span class="cm">******************************************************************************/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">bnx2x_ets_e3b0_sp_pri_to_cos_set</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">link_params</span> <span class="o">*</span><span class="n">params</span><span class="p">,</span>
					    <span class="n">u8</span> <span class="o">*</span><span class="n">sp_pri_to_cos</span><span class="p">,</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">pri</span><span class="p">,</span>
					    <span class="k">const</span> <span class="n">u8</span> <span class="n">cos_entry</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">bp</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">u8</span> <span class="n">port</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">u8</span> <span class="n">max_num_of_cos</span> <span class="o">=</span> <span class="p">(</span><span class="n">port</span><span class="p">)</span> <span class="o">?</span> <span class="n">DCBX_E3B0_MAX_NUM_COS_PORT1</span> <span class="o">:</span>
		<span class="n">DCBX_E3B0_MAX_NUM_COS_PORT0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pri</span> <span class="o">&gt;=</span> <span class="n">max_num_of_cos</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;bnx2x_ets_e3b0_sp_pri_to_cos_set invalid &quot;</span>
		   <span class="s">&quot;parameter Illegal strict priority</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	    <span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sp_pri_to_cos</span><span class="p">[</span><span class="n">pri</span><span class="p">]</span> <span class="o">!=</span> <span class="n">DCBX_INVALID_COS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;bnx2x_ets_e3b0_sp_pri_to_cos_set invalid &quot;</span>
				   <span class="s">&quot;parameter There can&#39;t be two COS&#39;s with &quot;</span>
				   <span class="s">&quot;the same strict pri</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">sp_pri_to_cos</span><span class="p">[</span><span class="n">pri</span><span class="p">]</span> <span class="o">=</span> <span class="n">cos_entry</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="p">}</span>

<span class="cm">/******************************************************************************</span>
<span class="cm">* Description:</span>
<span class="cm">*	Returns the correct value according to COS and priority in</span>
<span class="cm">*	the sp_pri_cli register.</span>
<span class="cm">*</span>
<span class="cm">******************************************************************************/</span>
<span class="k">static</span> <span class="n">u64</span> <span class="nf">bnx2x_e3b0_sp_get_pri_cli_reg</span><span class="p">(</span><span class="k">const</span> <span class="n">u8</span> <span class="n">cos</span><span class="p">,</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">cos_offset</span><span class="p">,</span>
					 <span class="k">const</span> <span class="n">u8</span> <span class="n">pri_set</span><span class="p">,</span>
					 <span class="k">const</span> <span class="n">u8</span> <span class="n">pri_offset</span><span class="p">,</span>
					 <span class="k">const</span> <span class="n">u8</span> <span class="n">entry_size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">pri_cli_nig</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pri_cli_nig</span> <span class="o">=</span> <span class="p">((</span><span class="n">u64</span><span class="p">)(</span><span class="n">cos</span> <span class="o">+</span> <span class="n">cos_offset</span><span class="p">))</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">entry_size</span> <span class="o">*</span>
						    <span class="p">(</span><span class="n">pri_set</span> <span class="o">+</span> <span class="n">pri_offset</span><span class="p">));</span>

	<span class="k">return</span> <span class="n">pri_cli_nig</span><span class="p">;</span>
<span class="p">}</span>
<span class="cm">/******************************************************************************</span>
<span class="cm">* Description:</span>
<span class="cm">*	Returns the correct value according to COS and priority in the</span>
<span class="cm">*	sp_pri_cli register for NIG.</span>
<span class="cm">*</span>
<span class="cm">******************************************************************************/</span>
<span class="k">static</span> <span class="n">u64</span> <span class="nf">bnx2x_e3b0_sp_get_pri_cli_reg_nig</span><span class="p">(</span><span class="k">const</span> <span class="n">u8</span> <span class="n">cos</span><span class="p">,</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">pri_set</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* MCP Dbg0 and dbg1 are always with higher strict pri*/</span>
	<span class="k">const</span> <span class="n">u8</span> <span class="n">nig_cos_offset</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">u8</span> <span class="n">nig_pri_offset</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">bnx2x_e3b0_sp_get_pri_cli_reg</span><span class="p">(</span><span class="n">cos</span><span class="p">,</span> <span class="n">nig_cos_offset</span><span class="p">,</span> <span class="n">pri_set</span><span class="p">,</span>
		<span class="n">nig_pri_offset</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>

<span class="p">}</span>
<span class="cm">/******************************************************************************</span>
<span class="cm">* Description:</span>
<span class="cm">*	Returns the correct value according to COS and priority in the</span>
<span class="cm">*	sp_pri_cli register for PBF.</span>
<span class="cm">*</span>
<span class="cm">******************************************************************************/</span>
<span class="k">static</span> <span class="n">u64</span> <span class="nf">bnx2x_e3b0_sp_get_pri_cli_reg_pbf</span><span class="p">(</span><span class="k">const</span> <span class="n">u8</span> <span class="n">cos</span><span class="p">,</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">pri_set</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="n">u8</span> <span class="n">pbf_cos_offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">u8</span> <span class="n">pbf_pri_offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">bnx2x_e3b0_sp_get_pri_cli_reg</span><span class="p">(</span><span class="n">cos</span><span class="p">,</span> <span class="n">pbf_cos_offset</span><span class="p">,</span> <span class="n">pri_set</span><span class="p">,</span>
		<span class="n">pbf_pri_offset</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>

<span class="p">}</span>

<span class="cm">/******************************************************************************</span>
<span class="cm">* Description:</span>
<span class="cm">*	Calculate and set the SP (ARB_PRIORITY_CLIENT) NIG and PBF registers</span>
<span class="cm">*	according to sp_pri_to_cos.(which COS has higher priority)</span>
<span class="cm">*</span>
<span class="cm">******************************************************************************/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">bnx2x_ets_e3b0_sp_set_pri_cli_reg</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">link_params</span> <span class="o">*</span><span class="n">params</span><span class="p">,</span>
					     <span class="n">u8</span> <span class="o">*</span><span class="n">sp_pri_to_cos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">bp</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">u8</span> <span class="n">port</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>
	<span class="cm">/* MCP Dbg0 and dbg1 are always with higher strict pri*/</span>
	<span class="n">u64</span> <span class="n">pri_cli_nig</span> <span class="o">=</span> <span class="mh">0x210</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">pri_cli_pbf</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">pri_set</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">pri_bitmask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">u8</span> <span class="n">max_num_of_cos</span> <span class="o">=</span> <span class="p">(</span><span class="n">port</span><span class="p">)</span> <span class="o">?</span> <span class="n">DCBX_E3B0_MAX_NUM_COS_PORT1</span> <span class="o">:</span>
		<span class="n">DCBX_E3B0_MAX_NUM_COS_PORT0</span><span class="p">;</span>

	<span class="n">u8</span> <span class="n">cos_bit_to_set</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">max_num_of_cos</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* Set all the strict priority first */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">max_num_of_cos</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sp_pri_to_cos</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="n">DCBX_INVALID_COS</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">sp_pri_to_cos</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">DCBX_MAX_NUM_COS</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span>
					   <span class="s">&quot;bnx2x_ets_e3b0_sp_set_pri_cli_reg &quot;</span>
					   <span class="s">&quot;invalid cos entry</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">pri_cli_nig</span> <span class="o">|=</span> <span class="n">bnx2x_e3b0_sp_get_pri_cli_reg_nig</span><span class="p">(</span>
			    <span class="n">sp_pri_to_cos</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">pri_set</span><span class="p">);</span>

			<span class="n">pri_cli_pbf</span> <span class="o">|=</span> <span class="n">bnx2x_e3b0_sp_get_pri_cli_reg_pbf</span><span class="p">(</span>
			    <span class="n">sp_pri_to_cos</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">pri_set</span><span class="p">);</span>
			<span class="n">pri_bitmask</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">sp_pri_to_cos</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="cm">/* COS is used remove it from bitmap.*/</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">pri_bitmask</span> <span class="o">&amp;</span> <span class="n">cos_bit_to_set</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span>
					<span class="s">&quot;bnx2x_ets_e3b0_sp_set_pri_cli_reg &quot;</span>
					<span class="s">&quot;invalid There can&#39;t be two COS&#39;s with&quot;</span>
					<span class="s">&quot; the same strict pri</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">cos_bit_to_set</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">pri_bitmask</span><span class="p">;</span>
			<span class="n">pri_set</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Set all the Non strict priority i= COS*/</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">max_num_of_cos</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pri_bitmask</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">;</span>
		<span class="cm">/* Check if COS was already used for SP */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pri_bitmask</span> <span class="o">&amp;</span> <span class="n">cos_bit_to_set</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* COS wasn&#39;t used for SP */</span>
			<span class="n">pri_cli_nig</span> <span class="o">|=</span> <span class="n">bnx2x_e3b0_sp_get_pri_cli_reg_nig</span><span class="p">(</span>
			    <span class="n">i</span><span class="p">,</span> <span class="n">pri_set</span><span class="p">);</span>

			<span class="n">pri_cli_pbf</span> <span class="o">|=</span> <span class="n">bnx2x_e3b0_sp_get_pri_cli_reg_pbf</span><span class="p">(</span>
			    <span class="n">i</span><span class="p">,</span> <span class="n">pri_set</span><span class="p">);</span>
			<span class="cm">/* COS is used remove it from bitmap.*/</span>
			<span class="n">cos_bit_to_set</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">pri_bitmask</span><span class="p">;</span>
			<span class="n">pri_set</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pri_set</span> <span class="o">!=</span> <span class="n">max_num_of_cos</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;bnx2x_ets_e3b0_sp_set_pri_cli_reg not all &quot;</span>
				   <span class="s">&quot;entries were set</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">port</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Only 6 usable clients*/</span>
		<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">NIG_REG_P1_TX_ARB_PRIORITY_CLIENT2_LSB</span><span class="p">,</span>
		       <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">pri_cli_nig</span><span class="p">);</span>

		<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">PBF_REG_ETS_ARB_PRIORITY_CLIENT_P1</span> <span class="p">,</span> <span class="n">pri_cli_pbf</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Only 9 usable clients*/</span>
		<span class="k">const</span> <span class="n">u32</span> <span class="n">pri_cli_nig_lsb</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="p">(</span><span class="n">pri_cli_nig</span><span class="p">);</span>
		<span class="k">const</span> <span class="n">u32</span> <span class="n">pri_cli_nig_msb</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="p">((</span><span class="n">pri_cli_nig</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xF</span><span class="p">);</span>

		<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">NIG_REG_P0_TX_ARB_PRIORITY_CLIENT2_LSB</span><span class="p">,</span>
		       <span class="n">pri_cli_nig_lsb</span><span class="p">);</span>
		<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">NIG_REG_P0_TX_ARB_PRIORITY_CLIENT2_MSB</span><span class="p">,</span>
		       <span class="n">pri_cli_nig_msb</span><span class="p">);</span>

		<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">PBF_REG_ETS_ARB_PRIORITY_CLIENT_P0</span> <span class="p">,</span> <span class="n">pri_cli_pbf</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/******************************************************************************</span>
<span class="cm">* Description:</span>
<span class="cm">*	Configure the COS to ETS according to BW and SP settings.</span>
<span class="cm">******************************************************************************/</span>
<span class="kt">int</span> <span class="nf">bnx2x_ets_e3b0_config</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">link_params</span> <span class="o">*</span><span class="n">params</span><span class="p">,</span>
			 <span class="k">const</span> <span class="k">struct</span> <span class="n">link_vars</span> <span class="o">*</span><span class="n">vars</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">bnx2x_ets_params</span> <span class="o">*</span><span class="n">ets_params</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">bp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bnx2x_status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">u8</span> <span class="n">port</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">total_bw</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">u32</span> <span class="n">min_w_val_nig</span> <span class="o">=</span> <span class="n">bnx2x_ets_get_min_w_val_nig</span><span class="p">(</span><span class="n">vars</span><span class="p">);</span>
	<span class="k">const</span> <span class="n">u32</span> <span class="n">min_w_val_pbf</span> <span class="o">=</span> <span class="n">ETS_E3B0_PBF_MIN_W_VAL</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">cos_bw_bitmap</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">cos_sp_bitmap</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">sp_pri_to_cos</span><span class="p">[</span><span class="n">DCBX_MAX_NUM_COS</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
	<span class="k">const</span> <span class="n">u8</span> <span class="n">max_num_of_cos</span> <span class="o">=</span> <span class="p">(</span><span class="n">port</span><span class="p">)</span> <span class="o">?</span> <span class="n">DCBX_E3B0_MAX_NUM_COS_PORT1</span> <span class="o">:</span>
		<span class="n">DCBX_E3B0_MAX_NUM_COS_PORT0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">cos_entry</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CHIP_IS_E3B0</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span>
		   <span class="s">&quot;bnx2x_ets_e3b0_disabled the chip isn&#39;t E3B0</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ets_params</span><span class="o">-&gt;</span><span class="n">num_of_cos</span> <span class="o">&gt;</span> <span class="n">max_num_of_cos</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;bnx2x_ets_E3B0_config the number of COS &quot;</span>
				   <span class="s">&quot;isn&#39;t supported</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Prepare sp strict priority parameters*/</span>
	<span class="n">bnx2x_ets_e3b0_sp_pri_to_cos_init</span><span class="p">(</span><span class="n">sp_pri_to_cos</span><span class="p">);</span>

	<span class="cm">/* Prepare BW parameters*/</span>
	<span class="n">bnx2x_status</span> <span class="o">=</span> <span class="n">bnx2x_ets_e3b0_get_total_bw</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">ets_params</span><span class="p">,</span>
						   <span class="o">&amp;</span><span class="n">total_bw</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bnx2x_status</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span>
		   <span class="s">&quot;bnx2x_ets_E3B0_config get_total_bw failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Upper bound is set according to current link speed (min_w_val</span>
<span class="cm">	 * should be the same for upper bound and COS credit val).</span>
<span class="cm">	 */</span>
	<span class="n">bnx2x_ets_e3b0_set_credit_upper_bound_nig</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">min_w_val_nig</span><span class="p">);</span>
	<span class="n">bnx2x_ets_e3b0_set_credit_upper_bound_pbf</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">min_w_val_pbf</span><span class="p">);</span>


	<span class="k">for</span> <span class="p">(</span><span class="n">cos_entry</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">cos_entry</span> <span class="o">&lt;</span> <span class="n">ets_params</span><span class="o">-&gt;</span><span class="n">num_of_cos</span><span class="p">;</span> <span class="n">cos_entry</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bnx2x_cos_state_bw</span> <span class="o">==</span> <span class="n">ets_params</span><span class="o">-&gt;</span><span class="n">cos</span><span class="p">[</span><span class="n">cos_entry</span><span class="p">].</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cos_bw_bitmap</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">cos_entry</span><span class="p">);</span>
			<span class="cm">/* The function also sets the BW in HW(not the mappin</span>
<span class="cm">			 * yet)</span>
<span class="cm">			 */</span>
			<span class="n">bnx2x_status</span> <span class="o">=</span> <span class="n">bnx2x_ets_e3b0_set_cos_bw</span><span class="p">(</span>
				<span class="n">bp</span><span class="p">,</span> <span class="n">cos_entry</span><span class="p">,</span> <span class="n">min_w_val_nig</span><span class="p">,</span> <span class="n">min_w_val_pbf</span><span class="p">,</span>
				<span class="n">total_bw</span><span class="p">,</span>
				<span class="n">ets_params</span><span class="o">-&gt;</span><span class="n">cos</span><span class="p">[</span><span class="n">cos_entry</span><span class="p">].</span><span class="n">params</span><span class="p">.</span><span class="n">bw_params</span><span class="p">.</span><span class="n">bw</span><span class="p">,</span>
				 <span class="n">port</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">bnx2x_cos_state_strict</span> <span class="o">==</span>
			<span class="n">ets_params</span><span class="o">-&gt;</span><span class="n">cos</span><span class="p">[</span><span class="n">cos_entry</span><span class="p">].</span><span class="n">state</span><span class="p">){</span>
			<span class="n">cos_sp_bitmap</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">cos_entry</span><span class="p">);</span>

			<span class="n">bnx2x_status</span> <span class="o">=</span> <span class="n">bnx2x_ets_e3b0_sp_pri_to_cos_set</span><span class="p">(</span>
				<span class="n">params</span><span class="p">,</span>
				<span class="n">sp_pri_to_cos</span><span class="p">,</span>
				<span class="n">ets_params</span><span class="o">-&gt;</span><span class="n">cos</span><span class="p">[</span><span class="n">cos_entry</span><span class="p">].</span><span class="n">params</span><span class="p">.</span><span class="n">sp_params</span><span class="p">.</span><span class="n">pri</span><span class="p">,</span>
				<span class="n">cos_entry</span><span class="p">);</span>

		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span>
			   <span class="s">&quot;bnx2x_ets_e3b0_config cos state not valid</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bnx2x_status</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span>
			   <span class="s">&quot;bnx2x_ets_e3b0_config set cos bw failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">bnx2x_status</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Set SP register (which COS has higher priority) */</span>
	<span class="n">bnx2x_status</span> <span class="o">=</span> <span class="n">bnx2x_ets_e3b0_sp_set_pri_cli_reg</span><span class="p">(</span><span class="n">params</span><span class="p">,</span>
							 <span class="n">sp_pri_to_cos</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bnx2x_status</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span>
		   <span class="s">&quot;bnx2x_ets_E3B0_config set_pri_cli_reg failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">bnx2x_status</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Set client mapping of BW and strict */</span>
	<span class="n">bnx2x_status</span> <span class="o">=</span> <span class="n">bnx2x_ets_e3b0_cli_map</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">ets_params</span><span class="p">,</span>
					      <span class="n">cos_sp_bitmap</span><span class="p">,</span>
					      <span class="n">cos_bw_bitmap</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bnx2x_status</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;bnx2x_ets_E3B0_config SP failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">bnx2x_status</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_ets_bw_limit_common</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">link_params</span> <span class="o">*</span><span class="n">params</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* ETS disabled configuration */</span>
	<span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">bp</span><span class="p">;</span>
	<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;ETS enabled BW limit configuration</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="cm">/* Defines which entries (clients) are subjected to WFQ arbitration</span>
<span class="cm">	 * COS0 0x8</span>
<span class="cm">	 * COS1 0x10</span>
<span class="cm">	 */</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">NIG_REG_P0_TX_ARB_CLIENT_IS_SUBJECT2WFQ</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">);</span>
	<span class="cm">/* Mapping between the ARB_CREDIT_WEIGHT registers and actual</span>
<span class="cm">	 * client numbers (WEIGHT_0 does not actually have to represent</span>
<span class="cm">	 * client 0)</span>
<span class="cm">	 *    PRI4    |    PRI3    |    PRI2    |    PRI1    |    PRI0</span>
<span class="cm">	 *  cos1-001     cos0-000     dbg1-100     dbg0-011     MCP-010</span>
<span class="cm">	 */</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">NIG_REG_P0_TX_ARB_CLIENT_CREDIT_MAP</span><span class="p">,</span> <span class="mh">0x111A</span><span class="p">);</span>

	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">NIG_REG_P0_TX_ARB_CREDIT_UPPER_BOUND_0</span><span class="p">,</span>
	       <span class="n">ETS_BW_LIMIT_CREDIT_UPPER_BOUND</span><span class="p">);</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">NIG_REG_P0_TX_ARB_CREDIT_UPPER_BOUND_1</span><span class="p">,</span>
	       <span class="n">ETS_BW_LIMIT_CREDIT_UPPER_BOUND</span><span class="p">);</span>

	<span class="cm">/* ETS mode enabled*/</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">PBF_REG_ETS_ENABLED</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* Defines the number of consecutive slots for the strict priority */</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">PBF_REG_NUM_STRICT_ARB_SLOTS</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="cm">/* Bitmap of 5bits length. Each bit specifies whether the entry behaves</span>
<span class="cm">	 * as strict.  Bits 0,1,2 - debug and management entries, 3 - COS0</span>
<span class="cm">	 * entry, 4 - COS1 entry.</span>
<span class="cm">	 * COS1 | COS0 | DEBUG21 | DEBUG0 | MGMT</span>
<span class="cm">	 * bit4   bit3	  bit2     bit1	   bit0</span>
<span class="cm">	 * MCP and debug are strict</span>
<span class="cm">	 */</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">NIG_REG_P0_TX_ARB_CLIENT_IS_STRICT</span><span class="p">,</span> <span class="mh">0x7</span><span class="p">);</span>

	<span class="cm">/* Upper bound that COS0_WEIGHT can reach in the WFQ arbiter.*/</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">PBF_REG_COS0_UPPER_BOUND</span><span class="p">,</span>
	       <span class="n">ETS_BW_LIMIT_CREDIT_UPPER_BOUND</span><span class="p">);</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">PBF_REG_COS1_UPPER_BOUND</span><span class="p">,</span>
	       <span class="n">ETS_BW_LIMIT_CREDIT_UPPER_BOUND</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">bnx2x_ets_bw_limit</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">link_params</span> <span class="o">*</span><span class="n">params</span><span class="p">,</span> <span class="k">const</span> <span class="n">u32</span> <span class="n">cos0_bw</span><span class="p">,</span>
			<span class="k">const</span> <span class="n">u32</span> <span class="n">cos1_bw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* ETS disabled configuration*/</span>
	<span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">bp</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">u32</span> <span class="n">total_bw</span> <span class="o">=</span> <span class="n">cos0_bw</span> <span class="o">+</span> <span class="n">cos1_bw</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">cos0_credit_weight</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">cos1_credit_weight</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;ETS enabled BW limit configuration</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="n">total_bw</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="o">!</span><span class="n">cos0_bw</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="o">!</span><span class="n">cos1_bw</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;Total BW can&#39;t be zero</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cos0_credit_weight</span> <span class="o">=</span> <span class="p">(</span><span class="n">cos0_bw</span> <span class="o">*</span> <span class="n">ETS_BW_LIMIT_CREDIT_WEIGHT</span><span class="p">)</span><span class="o">/</span>
		<span class="n">total_bw</span><span class="p">;</span>
	<span class="n">cos1_credit_weight</span> <span class="o">=</span> <span class="p">(</span><span class="n">cos1_bw</span> <span class="o">*</span> <span class="n">ETS_BW_LIMIT_CREDIT_WEIGHT</span><span class="p">)</span><span class="o">/</span>
		<span class="n">total_bw</span><span class="p">;</span>

	<span class="n">bnx2x_ets_bw_limit_common</span><span class="p">(</span><span class="n">params</span><span class="p">);</span>

	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">NIG_REG_P0_TX_ARB_CREDIT_WEIGHT_0</span><span class="p">,</span> <span class="n">cos0_credit_weight</span><span class="p">);</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">NIG_REG_P0_TX_ARB_CREDIT_WEIGHT_1</span><span class="p">,</span> <span class="n">cos1_credit_weight</span><span class="p">);</span>

	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">PBF_REG_COS0_WEIGHT</span><span class="p">,</span> <span class="n">cos0_credit_weight</span><span class="p">);</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">PBF_REG_COS1_WEIGHT</span><span class="p">,</span> <span class="n">cos1_credit_weight</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">bnx2x_ets_strict</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">link_params</span> <span class="o">*</span><span class="n">params</span><span class="p">,</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">strict_cos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* ETS disabled configuration*/</span>
	<span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">bp</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">val</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;ETS enabled strict configuration</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="cm">/* Bitmap of 5bits length. Each bit specifies whether the entry behaves</span>
<span class="cm">	 * as strict.  Bits 0,1,2 - debug and management entries,</span>
<span class="cm">	 * 3 - COS0 entry, 4 - COS1 entry.</span>
<span class="cm">	 *  COS1 | COS0 | DEBUG21 | DEBUG0 | MGMT</span>
<span class="cm">	 *  bit4   bit3	  bit2      bit1     bit0</span>
<span class="cm">	 * MCP and debug are strict</span>
<span class="cm">	 */</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">NIG_REG_P0_TX_ARB_CLIENT_IS_STRICT</span><span class="p">,</span> <span class="mh">0x1F</span><span class="p">);</span>
	<span class="cm">/* For strict priority entries defines the number of consecutive slots</span>
<span class="cm">	 * for the highest priority.</span>
<span class="cm">	 */</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">NIG_REG_P0_TX_ARB_NUM_STRICT_ARB_SLOTS</span><span class="p">,</span> <span class="mh">0x100</span><span class="p">);</span>
	<span class="cm">/* ETS mode disable */</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">PBF_REG_ETS_ENABLED</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="cm">/* Defines the number of consecutive slots for the strict priority */</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">PBF_REG_NUM_STRICT_ARB_SLOTS</span><span class="p">,</span> <span class="mh">0x100</span><span class="p">);</span>

	<span class="cm">/* Defines the number of consecutive slots for the strict priority */</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">PBF_REG_HIGH_PRIORITY_COS_NUM</span><span class="p">,</span> <span class="n">strict_cos</span><span class="p">);</span>

	<span class="cm">/* Mapping between entry  priority to client number (0,1,2 -debug and</span>
<span class="cm">	 * management clients, 3 - COS0 client, 4 - COS client)(HIGHEST)</span>
<span class="cm">	 * 3bits client num.</span>
<span class="cm">	 *   PRI4    |    PRI3    |    PRI2    |    PRI1    |    PRI0</span>
<span class="cm">	 * dbg0-010     dbg1-001     cos1-100     cos0-011     MCP-000</span>
<span class="cm">	 * dbg0-010     dbg1-001     cos0-011     cos1-100     MCP-000</span>
<span class="cm">	 */</span>
	<span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="o">!</span><span class="n">strict_cos</span><span class="p">)</span> <span class="o">?</span> <span class="mh">0x2318</span> <span class="o">:</span> <span class="mh">0x22E0</span><span class="p">;</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">NIG_REG_P0_TX_ARB_PRIORITY_CLIENT</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cm">/******************************************************************/</span>
<span class="cm">/*			PFC section				  */</span>
<span class="cm">/******************************************************************/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_update_pfc_xmac</span><span class="p">(</span><span class="k">struct</span> <span class="n">link_params</span> <span class="o">*</span><span class="n">params</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">link_vars</span> <span class="o">*</span><span class="n">vars</span><span class="p">,</span>
				  <span class="n">u8</span> <span class="n">is_lb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">bp</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">xmac_base</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">pause_val</span><span class="p">,</span> <span class="n">pfc0_val</span><span class="p">,</span> <span class="n">pfc1_val</span><span class="p">;</span>

	<span class="cm">/* XMAC base adrr */</span>
	<span class="n">xmac_base</span> <span class="o">=</span> <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">)</span> <span class="o">?</span> <span class="n">GRCBASE_XMAC1</span> <span class="o">:</span> <span class="n">GRCBASE_XMAC0</span><span class="p">;</span>

	<span class="cm">/* Initialize pause and pfc registers */</span>
	<span class="n">pause_val</span> <span class="o">=</span> <span class="mh">0x18000</span><span class="p">;</span>
	<span class="n">pfc0_val</span> <span class="o">=</span> <span class="mh">0xFFFF8000</span><span class="p">;</span>
	<span class="n">pfc1_val</span> <span class="o">=</span> <span class="mh">0x2</span><span class="p">;</span>

	<span class="cm">/* No PFC support */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">feature_config_flags</span> <span class="o">&amp;</span>
	      <span class="n">FEATURE_CONFIG_PFC_ENABLED</span><span class="p">))</span> <span class="p">{</span>

		<span class="cm">/* RX flow control - Process pause frame in receive direction</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vars</span><span class="o">-&gt;</span><span class="n">flow_ctrl</span> <span class="o">&amp;</span> <span class="n">BNX2X_FLOW_CTRL_RX</span><span class="p">)</span>
			<span class="n">pause_val</span> <span class="o">|=</span> <span class="n">XMAC_PAUSE_CTRL_REG_RX_PAUSE_EN</span><span class="p">;</span>

		<span class="cm">/* TX flow control - Send pause packet when buffer is full */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vars</span><span class="o">-&gt;</span><span class="n">flow_ctrl</span> <span class="o">&amp;</span> <span class="n">BNX2X_FLOW_CTRL_TX</span><span class="p">)</span>
			<span class="n">pause_val</span> <span class="o">|=</span> <span class="n">XMAC_PAUSE_CTRL_REG_TX_PAUSE_EN</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span><span class="cm">/* PFC support */</span>
		<span class="n">pfc1_val</span> <span class="o">|=</span> <span class="n">XMAC_PFC_CTRL_HI_REG_PFC_REFRESH_EN</span> <span class="o">|</span>
			<span class="n">XMAC_PFC_CTRL_HI_REG_PFC_STATS_EN</span> <span class="o">|</span>
			<span class="n">XMAC_PFC_CTRL_HI_REG_RX_PFC_EN</span> <span class="o">|</span>
			<span class="n">XMAC_PFC_CTRL_HI_REG_TX_PFC_EN</span> <span class="o">|</span>
			<span class="n">XMAC_PFC_CTRL_HI_REG_FORCE_PFC_XON</span><span class="p">;</span>
		<span class="cm">/* Write pause and PFC registers */</span>
		<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">xmac_base</span> <span class="o">+</span> <span class="n">XMAC_REG_PAUSE_CTRL</span><span class="p">,</span> <span class="n">pause_val</span><span class="p">);</span>
		<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">xmac_base</span> <span class="o">+</span> <span class="n">XMAC_REG_PFC_CTRL</span><span class="p">,</span> <span class="n">pfc0_val</span><span class="p">);</span>
		<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">xmac_base</span> <span class="o">+</span> <span class="n">XMAC_REG_PFC_CTRL_HI</span><span class="p">,</span> <span class="n">pfc1_val</span><span class="p">);</span>
		<span class="n">pfc1_val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">XMAC_PFC_CTRL_HI_REG_FORCE_PFC_XON</span><span class="p">;</span>

	<span class="p">}</span>

	<span class="cm">/* Write pause and PFC registers */</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">xmac_base</span> <span class="o">+</span> <span class="n">XMAC_REG_PAUSE_CTRL</span><span class="p">,</span> <span class="n">pause_val</span><span class="p">);</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">xmac_base</span> <span class="o">+</span> <span class="n">XMAC_REG_PFC_CTRL</span><span class="p">,</span> <span class="n">pfc0_val</span><span class="p">);</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">xmac_base</span> <span class="o">+</span> <span class="n">XMAC_REG_PFC_CTRL_HI</span><span class="p">,</span> <span class="n">pfc1_val</span><span class="p">);</span>


	<span class="cm">/* Set MAC address for source TX Pause/PFC frames */</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">xmac_base</span> <span class="o">+</span> <span class="n">XMAC_REG_CTRL_SA_LO</span><span class="p">,</span>
	       <span class="p">((</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">mac_addr</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">mac_addr</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">mac_addr</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">mac_addr</span><span class="p">[</span><span class="mi">5</span><span class="p">])));</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">xmac_base</span> <span class="o">+</span> <span class="n">XMAC_REG_CTRL_SA_HI</span><span class="p">,</span>
	       <span class="p">((</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">mac_addr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">mac_addr</span><span class="p">[</span><span class="mi">1</span><span class="p">])));</span>

	<span class="n">udelay</span><span class="p">(</span><span class="mi">30</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_emac_get_pfc_stat</span><span class="p">(</span><span class="k">struct</span> <span class="n">link_params</span> <span class="o">*</span><span class="n">params</span><span class="p">,</span>
				    <span class="n">u32</span> <span class="n">pfc_frames_sent</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
				    <span class="n">u32</span> <span class="n">pfc_frames_received</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
<span class="p">{</span>
	<span class="cm">/* Read pfc statistic */</span>
	<span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">bp</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">emac_base</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">?</span> <span class="n">GRCBASE_EMAC1</span> <span class="o">:</span> <span class="n">GRCBASE_EMAC0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">val_xon</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">val_xoff</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;pfc statistic read from EMAC</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* PFC received frames */</span>
	<span class="n">val_xoff</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">emac_base</span> <span class="o">+</span>
				<span class="n">EMAC_REG_RX_PFC_STATS_XOFF_RCVD</span><span class="p">);</span>
	<span class="n">val_xoff</span> <span class="o">&amp;=</span> <span class="n">EMAC_REG_RX_PFC_STATS_XOFF_RCVD_COUNT</span><span class="p">;</span>
	<span class="n">val_xon</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">emac_base</span> <span class="o">+</span> <span class="n">EMAC_REG_RX_PFC_STATS_XON_RCVD</span><span class="p">);</span>
	<span class="n">val_xon</span> <span class="o">&amp;=</span> <span class="n">EMAC_REG_RX_PFC_STATS_XON_RCVD_COUNT</span><span class="p">;</span>

	<span class="n">pfc_frames_received</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">val_xon</span> <span class="o">+</span> <span class="n">val_xoff</span><span class="p">;</span>

	<span class="cm">/* PFC received sent */</span>
	<span class="n">val_xoff</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">emac_base</span> <span class="o">+</span>
				<span class="n">EMAC_REG_RX_PFC_STATS_XOFF_SENT</span><span class="p">);</span>
	<span class="n">val_xoff</span> <span class="o">&amp;=</span> <span class="n">EMAC_REG_RX_PFC_STATS_XOFF_SENT_COUNT</span><span class="p">;</span>
	<span class="n">val_xon</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">emac_base</span> <span class="o">+</span> <span class="n">EMAC_REG_RX_PFC_STATS_XON_SENT</span><span class="p">);</span>
	<span class="n">val_xon</span> <span class="o">&amp;=</span> <span class="n">EMAC_REG_RX_PFC_STATS_XON_SENT_COUNT</span><span class="p">;</span>

	<span class="n">pfc_frames_sent</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">val_xon</span> <span class="o">+</span> <span class="n">val_xoff</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Read pfc statistic*/</span>
<span class="kt">void</span> <span class="nf">bnx2x_pfc_statistic</span><span class="p">(</span><span class="k">struct</span> <span class="n">link_params</span> <span class="o">*</span><span class="n">params</span><span class="p">,</span> <span class="k">struct</span> <span class="n">link_vars</span> <span class="o">*</span><span class="n">vars</span><span class="p">,</span>
			 <span class="n">u32</span> <span class="n">pfc_frames_sent</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
			 <span class="n">u32</span> <span class="n">pfc_frames_received</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
<span class="p">{</span>
	<span class="cm">/* Read pfc statistic */</span>
	<span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">bp</span><span class="p">;</span>

	<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;pfc statistic</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vars</span><span class="o">-&gt;</span><span class="n">link_up</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vars</span><span class="o">-&gt;</span><span class="n">mac_type</span> <span class="o">==</span> <span class="n">MAC_TYPE_EMAC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;About to read PFC stats from EMAC</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">bnx2x_emac_get_pfc_stat</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">pfc_frames_sent</span><span class="p">,</span>
					<span class="n">pfc_frames_received</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="cm">/******************************************************************/</span>
<span class="cm">/*			MAC/PBF section				  */</span>
<span class="cm">/******************************************************************/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_set_mdio_clk</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">,</span> <span class="n">u32</span> <span class="n">chip_id</span><span class="p">,</span> <span class="n">u8</span> <span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">mode</span><span class="p">,</span> <span class="n">emac_base</span><span class="p">;</span>
	<span class="cm">/* Set clause 45 mode, slow down the MDIO clock to 2.5MHz</span>
<span class="cm">	 * (a value of 49==0x31) and make sure that the AUTO poll is off</span>
<span class="cm">	 */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">CHIP_IS_E2</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span>
		<span class="n">emac_base</span> <span class="o">=</span> <span class="n">GRCBASE_EMAC0</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">emac_base</span> <span class="o">=</span> <span class="p">(</span><span class="n">port</span><span class="p">)</span> <span class="o">?</span> <span class="n">GRCBASE_EMAC1</span> <span class="o">:</span> <span class="n">GRCBASE_EMAC0</span><span class="p">;</span>
	<span class="n">mode</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">emac_base</span> <span class="o">+</span> <span class="n">EMAC_REG_EMAC_MDIO_MODE</span><span class="p">);</span>
	<span class="n">mode</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">EMAC_MDIO_MODE_AUTO_POLL</span> <span class="o">|</span>
		  <span class="n">EMAC_MDIO_MODE_CLOCK_CNT</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">USES_WARPCORE</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span>
		<span class="n">mode</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">74L</span> <span class="o">&lt;&lt;</span> <span class="n">EMAC_MDIO_MODE_CLOCK_CNT_BITSHIFT</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">mode</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">49L</span> <span class="o">&lt;&lt;</span> <span class="n">EMAC_MDIO_MODE_CLOCK_CNT_BITSHIFT</span><span class="p">);</span>

	<span class="n">mode</span> <span class="o">|=</span> <span class="p">(</span><span class="n">EMAC_MDIO_MODE_CLAUSE_45</span><span class="p">);</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">emac_base</span> <span class="o">+</span> <span class="n">EMAC_REG_EMAC_MDIO_MODE</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>

	<span class="n">udelay</span><span class="p">(</span><span class="mi">40</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">static</span> <span class="n">u8</span> <span class="nf">bnx2x_is_4_port_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">port4mode_ovwr_val</span><span class="p">;</span>
	<span class="cm">/* Check 4-port override enabled */</span>
	<span class="n">port4mode_ovwr_val</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">MISC_REG_PORT4MODE_EN_OVWR</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">port4mode_ovwr_val</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Return 4-port mode override value */</span>
		<span class="k">return</span> <span class="p">((</span><span class="n">port4mode_ovwr_val</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">1</span><span class="p">))</span> <span class="o">==</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">1</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="cm">/* Return 4-port mode from input pin */</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">MISC_REG_PORT4MODE_EN</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_emac_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">link_params</span> <span class="o">*</span><span class="n">params</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">link_vars</span> <span class="o">*</span><span class="n">vars</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* reset and unreset the emac core */</span>
	<span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">bp</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">port</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">emac_base</span> <span class="o">=</span> <span class="n">port</span> <span class="o">?</span> <span class="n">GRCBASE_EMAC1</span> <span class="o">:</span> <span class="n">GRCBASE_EMAC0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">timeout</span><span class="p">;</span>

	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">GRCBASE_MISC</span> <span class="o">+</span> <span class="n">MISC_REGISTERS_RESET_REG_2_CLEAR</span><span class="p">,</span>
	       <span class="p">(</span><span class="n">MISC_REGISTERS_RESET_REG_2_RST_EMAC0_HARD_CORE</span> <span class="o">&lt;&lt;</span> <span class="n">port</span><span class="p">));</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">GRCBASE_MISC</span> <span class="o">+</span> <span class="n">MISC_REGISTERS_RESET_REG_2_SET</span><span class="p">,</span>
	       <span class="p">(</span><span class="n">MISC_REGISTERS_RESET_REG_2_RST_EMAC0_HARD_CORE</span> <span class="o">&lt;&lt;</span> <span class="n">port</span><span class="p">));</span>

	<span class="cm">/* init emac - use read-modify-write */</span>
	<span class="cm">/* self clear reset */</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">emac_base</span> <span class="o">+</span> <span class="n">EMAC_REG_EMAC_MODE</span><span class="p">);</span>
	<span class="n">EMAC_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">EMAC_REG_EMAC_MODE</span><span class="p">,</span> <span class="p">(</span><span class="n">val</span> <span class="o">|</span> <span class="n">EMAC_MODE_RESET</span><span class="p">));</span>

	<span class="n">timeout</span> <span class="o">=</span> <span class="mi">200</span><span class="p">;</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">emac_base</span> <span class="o">+</span> <span class="n">EMAC_REG_EMAC_MODE</span><span class="p">);</span>
		<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;EMAC reset reg is %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">timeout</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;EMAC timeout!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">timeout</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">EMAC_MODE_RESET</span><span class="p">);</span>
	<span class="n">bnx2x_set_mdio_clk</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">chip_id</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>
	<span class="cm">/* Set mac address */</span>
	<span class="n">val</span> <span class="o">=</span> <span class="p">((</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">mac_addr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span>
		<span class="n">params</span><span class="o">-&gt;</span><span class="n">mac_addr</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
	<span class="n">EMAC_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">EMAC_REG_EMAC_MAC_MATCH</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

	<span class="n">val</span> <span class="o">=</span> <span class="p">((</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">mac_addr</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">|</span>
	       <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">mac_addr</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span>
	       <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">mac_addr</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span>
		<span class="n">params</span><span class="o">-&gt;</span><span class="n">mac_addr</span><span class="p">[</span><span class="mi">5</span><span class="p">]);</span>
	<span class="n">EMAC_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">EMAC_REG_EMAC_MAC_MATCH</span> <span class="o">+</span> <span class="mi">4</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_set_xumac_nig</span><span class="p">(</span><span class="k">struct</span> <span class="n">link_params</span> <span class="o">*</span><span class="n">params</span><span class="p">,</span>
				<span class="n">u16</span> <span class="n">tx_pause_en</span><span class="p">,</span>
				<span class="n">u8</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">bp</span><span class="p">;</span>

	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">?</span> <span class="n">NIG_REG_P1_MAC_IN_EN</span> <span class="o">:</span> <span class="n">NIG_REG_P0_MAC_IN_EN</span><span class="p">,</span>
	       <span class="n">enable</span><span class="p">);</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">?</span> <span class="n">NIG_REG_P1_MAC_OUT_EN</span> <span class="o">:</span> <span class="n">NIG_REG_P0_MAC_OUT_EN</span><span class="p">,</span>
	       <span class="n">enable</span><span class="p">);</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">?</span> <span class="n">NIG_REG_P1_MAC_PAUSE_OUT_EN</span> <span class="o">:</span>
	       <span class="n">NIG_REG_P0_MAC_PAUSE_OUT_EN</span><span class="p">,</span> <span class="n">tx_pause_en</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_umac_disable</span><span class="p">(</span><span class="k">struct</span> <span class="n">link_params</span> <span class="o">*</span><span class="n">params</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">umac_base</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">?</span> <span class="n">GRCBASE_UMAC1</span> <span class="o">:</span> <span class="n">GRCBASE_UMAC0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">bp</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">MISC_REG_RESET_REG_2</span><span class="p">)</span> <span class="o">&amp;</span>
		   <span class="p">(</span><span class="n">MISC_REGISTERS_RESET_REG_2_UMAC0</span> <span class="o">&lt;&lt;</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">)))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* Disable RX and TX */</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">umac_base</span> <span class="o">+</span> <span class="n">UMAC_REG_COMMAND_CONFIG</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_umac_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">link_params</span> <span class="o">*</span><span class="n">params</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">link_vars</span> <span class="o">*</span><span class="n">vars</span><span class="p">,</span> <span class="n">u8</span> <span class="n">lb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">umac_base</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">?</span> <span class="n">GRCBASE_UMAC1</span> <span class="o">:</span> <span class="n">GRCBASE_UMAC0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">bp</span><span class="p">;</span>
	<span class="cm">/* Reset UMAC */</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">GRCBASE_MISC</span> <span class="o">+</span> <span class="n">MISC_REGISTERS_RESET_REG_2_CLEAR</span><span class="p">,</span>
	       <span class="p">(</span><span class="n">MISC_REGISTERS_RESET_REG_2_UMAC0</span> <span class="o">&lt;&lt;</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">));</span>
	<span class="n">usleep_range</span><span class="p">(</span><span class="mi">1000</span><span class="p">,</span> <span class="mi">1000</span><span class="p">);</span>

	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">GRCBASE_MISC</span> <span class="o">+</span> <span class="n">MISC_REGISTERS_RESET_REG_2_SET</span><span class="p">,</span>
	       <span class="p">(</span><span class="n">MISC_REGISTERS_RESET_REG_2_UMAC0</span> <span class="o">&lt;&lt;</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">));</span>

	<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;enabling UMAC</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* This register opens the gate for the UMAC despite its name */</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">NIG_REG_EGRESS_EMAC0_PORT</span> <span class="o">+</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">*</span><span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">UMAC_COMMAND_CONFIG_REG_PROMIS_EN</span> <span class="o">|</span>
		<span class="n">UMAC_COMMAND_CONFIG_REG_PAD_EN</span> <span class="o">|</span>
		<span class="n">UMAC_COMMAND_CONFIG_REG_SW_RESET</span> <span class="o">|</span>
		<span class="n">UMAC_COMMAND_CONFIG_REG_NO_LGTH_CHECK</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">vars</span><span class="o">-&gt;</span><span class="n">line_speed</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SPEED_10</span>:
		<span class="n">val</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">0</span><span class="o">&lt;&lt;</span><span class="mi">2</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SPEED_100</span>:
		<span class="n">val</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">2</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SPEED_1000</span>:
		<span class="n">val</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">2</span><span class="o">&lt;&lt;</span><span class="mi">2</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SPEED_2500</span>:
		<span class="n">val</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">3</span><span class="o">&lt;&lt;</span><span class="mi">2</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;Invalid speed for UMAC %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">vars</span><span class="o">-&gt;</span><span class="n">line_speed</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">vars</span><span class="o">-&gt;</span><span class="n">flow_ctrl</span> <span class="o">&amp;</span> <span class="n">BNX2X_FLOW_CTRL_TX</span><span class="p">))</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">UMAC_COMMAND_CONFIG_REG_IGNORE_TX_PAUSE</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">vars</span><span class="o">-&gt;</span><span class="n">flow_ctrl</span> <span class="o">&amp;</span> <span class="n">BNX2X_FLOW_CTRL_RX</span><span class="p">))</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">UMAC_COMMAND_CONFIG_REG_PAUSE_IGNORE</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vars</span><span class="o">-&gt;</span><span class="n">duplex</span> <span class="o">==</span> <span class="n">DUPLEX_HALF</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">UMAC_COMMAND_CONFIG_REG_HD_ENA</span><span class="p">;</span>

	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">umac_base</span> <span class="o">+</span> <span class="n">UMAC_REG_COMMAND_CONFIG</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">50</span><span class="p">);</span>

	<span class="cm">/* Set MAC address for source TX Pause/PFC frames (under SW reset) */</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">umac_base</span> <span class="o">+</span> <span class="n">UMAC_REG_MAC_ADDR0</span><span class="p">,</span>
	       <span class="p">((</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">mac_addr</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">mac_addr</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">mac_addr</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">mac_addr</span><span class="p">[</span><span class="mi">5</span><span class="p">])));</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">umac_base</span> <span class="o">+</span> <span class="n">UMAC_REG_MAC_ADDR1</span><span class="p">,</span>
	       <span class="p">((</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">mac_addr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">mac_addr</span><span class="p">[</span><span class="mi">1</span><span class="p">])));</span>

	<span class="cm">/* Enable RX and TX */</span>
	<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">UMAC_COMMAND_CONFIG_REG_PAD_EN</span><span class="p">;</span>
	<span class="n">val</span> <span class="o">|=</span> <span class="n">UMAC_COMMAND_CONFIG_REG_TX_ENA</span> <span class="o">|</span>
		<span class="n">UMAC_COMMAND_CONFIG_REG_RX_ENA</span><span class="p">;</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">umac_base</span> <span class="o">+</span> <span class="n">UMAC_REG_COMMAND_CONFIG</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">50</span><span class="p">);</span>

	<span class="cm">/* Remove SW Reset */</span>
	<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">UMAC_COMMAND_CONFIG_REG_SW_RESET</span><span class="p">;</span>

	<span class="cm">/* Check loopback mode */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lb</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">UMAC_COMMAND_CONFIG_REG_LOOP_ENA</span><span class="p">;</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">umac_base</span> <span class="o">+</span> <span class="n">UMAC_REG_COMMAND_CONFIG</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

	<span class="cm">/* Maximum Frame Length (RW). Defines a 14-Bit maximum frame</span>
<span class="cm">	 * length used by the MAC receive logic to check frames.</span>
<span class="cm">	 */</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">umac_base</span> <span class="o">+</span> <span class="n">UMAC_REG_MAXFR</span><span class="p">,</span> <span class="mh">0x2710</span><span class="p">);</span>
	<span class="n">bnx2x_set_xumac_nig</span><span class="p">(</span><span class="n">params</span><span class="p">,</span>
			    <span class="p">((</span><span class="n">vars</span><span class="o">-&gt;</span><span class="n">flow_ctrl</span> <span class="o">&amp;</span> <span class="n">BNX2X_FLOW_CTRL_TX</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">),</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">vars</span><span class="o">-&gt;</span><span class="n">mac_type</span> <span class="o">=</span> <span class="n">MAC_TYPE_UMAC</span><span class="p">;</span>

<span class="p">}</span>

<span class="cm">/* Define the XMAC mode */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_xmac_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">link_params</span> <span class="o">*</span><span class="n">params</span><span class="p">,</span> <span class="n">u32</span> <span class="n">max_speed</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">bp</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">is_port4mode</span> <span class="o">=</span> <span class="n">bnx2x_is_4_port_mode</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>

	<span class="cm">/* In 4-port mode, need to set the mode only once, so if XMAC is</span>
<span class="cm">	 * already out of reset, it means the mode has already been set,</span>
<span class="cm">	 * and it must not* reset the XMAC again, since it controls both</span>
<span class="cm">	 * ports of the path</span>
<span class="cm">	 */</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">CHIP_NUM</span><span class="p">(</span><span class="n">bp</span><span class="p">)</span> <span class="o">==</span> <span class="n">CHIP_NUM_57840</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">MISC_REG_RESET_REG_2</span><span class="p">)</span> <span class="o">&amp;</span>
	     <span class="n">MISC_REGISTERS_RESET_REG_2_XMAC</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span>
		   <span class="s">&quot;XMAC already out of reset in 4-port mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Hard reset */</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">GRCBASE_MISC</span> <span class="o">+</span> <span class="n">MISC_REGISTERS_RESET_REG_2_CLEAR</span><span class="p">,</span>
	       <span class="n">MISC_REGISTERS_RESET_REG_2_XMAC</span><span class="p">);</span>
	<span class="n">usleep_range</span><span class="p">(</span><span class="mi">1000</span><span class="p">,</span> <span class="mi">1000</span><span class="p">);</span>

	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">GRCBASE_MISC</span> <span class="o">+</span> <span class="n">MISC_REGISTERS_RESET_REG_2_SET</span><span class="p">,</span>
	       <span class="n">MISC_REGISTERS_RESET_REG_2_XMAC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is_port4mode</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;Init XMAC to 2 ports x 10G per path</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="cm">/* Set the number of ports on the system side to up to 2 */</span>
		<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">MISC_REG_XMAC_CORE_PORT_MODE</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

		<span class="cm">/* Set the number of ports on the Warp Core to 10G */</span>
		<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">MISC_REG_XMAC_PHY_PORT_MODE</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Set the number of ports on the system side to 1 */</span>
		<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">MISC_REG_XMAC_CORE_PORT_MODE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">max_speed</span> <span class="o">==</span> <span class="n">SPEED_10000</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span>
			   <span class="s">&quot;Init XMAC to 10G x 1 port per path</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="cm">/* Set the number of ports on the Warp Core to 10G */</span>
			<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">MISC_REG_XMAC_PHY_PORT_MODE</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span>
			   <span class="s">&quot;Init XMAC to 20G x 2 ports per path</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="cm">/* Set the number of ports on the Warp Core to 20G */</span>
			<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">MISC_REG_XMAC_PHY_PORT_MODE</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="cm">/* Soft reset */</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">GRCBASE_MISC</span> <span class="o">+</span> <span class="n">MISC_REGISTERS_RESET_REG_2_CLEAR</span><span class="p">,</span>
	       <span class="n">MISC_REGISTERS_RESET_REG_2_XMAC_SOFT</span><span class="p">);</span>
	<span class="n">usleep_range</span><span class="p">(</span><span class="mi">1000</span><span class="p">,</span> <span class="mi">1000</span><span class="p">);</span>

	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">GRCBASE_MISC</span> <span class="o">+</span> <span class="n">MISC_REGISTERS_RESET_REG_2_SET</span><span class="p">,</span>
	       <span class="n">MISC_REGISTERS_RESET_REG_2_XMAC_SOFT</span><span class="p">);</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_xmac_disable</span><span class="p">(</span><span class="k">struct</span> <span class="n">link_params</span> <span class="o">*</span><span class="n">params</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">port</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">bp</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">pfc_ctrl</span><span class="p">,</span> <span class="n">xmac_base</span> <span class="o">=</span> <span class="p">(</span><span class="n">port</span><span class="p">)</span> <span class="o">?</span> <span class="n">GRCBASE_XMAC1</span> <span class="o">:</span> <span class="n">GRCBASE_XMAC0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">MISC_REG_RESET_REG_2</span><span class="p">)</span> <span class="o">&amp;</span>
	    <span class="n">MISC_REGISTERS_RESET_REG_2_XMAC</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Send an indication to change the state in the NIG back to XON</span>
<span class="cm">		 * Clearing this bit enables the next set of this bit to get</span>
<span class="cm">		 * rising edge</span>
<span class="cm">		 */</span>
		<span class="n">pfc_ctrl</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">xmac_base</span> <span class="o">+</span> <span class="n">XMAC_REG_PFC_CTRL_HI</span><span class="p">);</span>
		<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">xmac_base</span> <span class="o">+</span> <span class="n">XMAC_REG_PFC_CTRL_HI</span><span class="p">,</span>
		       <span class="p">(</span><span class="n">pfc_ctrl</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">1</span><span class="p">)));</span>
		<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">xmac_base</span> <span class="o">+</span> <span class="n">XMAC_REG_PFC_CTRL_HI</span><span class="p">,</span>
		       <span class="p">(</span><span class="n">pfc_ctrl</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">1</span><span class="p">)));</span>
		<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;Disable XMAC on port %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>
		<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">xmac_base</span> <span class="o">+</span> <span class="n">XMAC_REG_CTRL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bnx2x_xmac_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">link_params</span> <span class="o">*</span><span class="n">params</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">link_vars</span> <span class="o">*</span><span class="n">vars</span><span class="p">,</span> <span class="n">u8</span> <span class="n">lb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">,</span> <span class="n">xmac_base</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">bp</span><span class="p">;</span>
	<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;enabling XMAC</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">xmac_base</span> <span class="o">=</span> <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">)</span> <span class="o">?</span> <span class="n">GRCBASE_XMAC1</span> <span class="o">:</span> <span class="n">GRCBASE_XMAC0</span><span class="p">;</span>

	<span class="n">bnx2x_xmac_init</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">vars</span><span class="o">-&gt;</span><span class="n">line_speed</span><span class="p">);</span>

	<span class="cm">/* This register determines on which events the MAC will assert</span>
<span class="cm">	 * error on the i/f to the NIG along w/ EOP.</span>
<span class="cm">	 */</span>

	<span class="cm">/* This register tells the NIG whether to send traffic to UMAC</span>
<span class="cm">	 * or XMAC</span>
<span class="cm">	 */</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">NIG_REG_EGRESS_EMAC0_PORT</span> <span class="o">+</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">*</span><span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* Set Max packet size */</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">xmac_base</span> <span class="o">+</span> <span class="n">XMAC_REG_RX_MAX_SIZE</span><span class="p">,</span> <span class="mh">0x2710</span><span class="p">);</span>

	<span class="cm">/* CRC append for Tx packets */</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">xmac_base</span> <span class="o">+</span> <span class="n">XMAC_REG_TX_CTRL</span><span class="p">,</span> <span class="mh">0xC800</span><span class="p">);</span>

	<span class="cm">/* update PFC */</span>
	<span class="n">bnx2x_update_pfc_xmac</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">vars</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* Enable TX and RX */</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">XMAC_CTRL_REG_TX_EN</span> <span class="o">|</span> <span class="n">XMAC_CTRL_REG_RX_EN</span><span class="p">;</span>

	<span class="cm">/* Check loopback mode */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lb</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">XMAC_CTRL_REG_LINE_LOCAL_LPBK</span><span class="p">;</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">xmac_base</span> <span class="o">+</span> <span class="n">XMAC_REG_CTRL</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="n">bnx2x_set_xumac_nig</span><span class="p">(</span><span class="n">params</span><span class="p">,</span>
			    <span class="p">((</span><span class="n">vars</span><span class="o">-&gt;</span><span class="n">flow_ctrl</span> <span class="o">&amp;</span> <span class="n">BNX2X_FLOW_CTRL_TX</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">),</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">vars</span><span class="o">-&gt;</span><span class="n">mac_type</span> <span class="o">=</span> <span class="n">MAC_TYPE_XMAC</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bnx2x_emac_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">link_params</span> <span class="o">*</span><span class="n">params</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">link_vars</span> <span class="o">*</span><span class="n">vars</span><span class="p">,</span> <span class="n">u8</span> <span class="n">lb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">bp</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">port</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">emac_base</span> <span class="o">=</span> <span class="n">port</span> <span class="o">?</span> <span class="n">GRCBASE_EMAC1</span> <span class="o">:</span> <span class="n">GRCBASE_EMAC0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;enabling EMAC</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* Disable BMAC */</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">GRCBASE_MISC</span> <span class="o">+</span> <span class="n">MISC_REGISTERS_RESET_REG_2_CLEAR</span><span class="p">,</span>
	       <span class="p">(</span><span class="n">MISC_REGISTERS_RESET_REG_2_RST_BMAC0</span> <span class="o">&lt;&lt;</span> <span class="n">port</span><span class="p">));</span>

	<span class="cm">/* enable emac and not bmac */</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">NIG_REG_EGRESS_EMAC0_PORT</span> <span class="o">+</span> <span class="n">port</span><span class="o">*</span><span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* ASIC */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vars</span><span class="o">-&gt;</span><span class="n">phy_flags</span> <span class="o">&amp;</span> <span class="n">PHY_XGXS_FLAG</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">ser_lane</span> <span class="o">=</span> <span class="p">((</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">lane_config</span> <span class="o">&amp;</span>
				 <span class="n">PORT_HW_CFG_LANE_SWAP_CFG_MASTER_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span>
				<span class="n">PORT_HW_CFG_LANE_SWAP_CFG_MASTER_SHIFT</span><span class="p">);</span>

		<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;XGXS</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="cm">/* select the master lanes (out of 0-3) */</span>
		<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">NIG_REG_XGXS_LANE_SEL_P0</span> <span class="o">+</span> <span class="n">port</span><span class="o">*</span><span class="mi">4</span><span class="p">,</span> <span class="n">ser_lane</span><span class="p">);</span>
		<span class="cm">/* select XGXS */</span>
		<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">NIG_REG_XGXS_SERDES0_MODE_SEL</span> <span class="o">+</span> <span class="n">port</span><span class="o">*</span><span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="cm">/* SerDes */</span>
		<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;SerDes</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="cm">/* select SerDes */</span>
		<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">NIG_REG_XGXS_SERDES0_MODE_SEL</span> <span class="o">+</span> <span class="n">port</span><span class="o">*</span><span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">bnx2x_bits_en</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">emac_base</span> <span class="o">+</span> <span class="n">EMAC_REG_EMAC_RX_MODE</span><span class="p">,</span>
		      <span class="n">EMAC_RX_MODE_RESET</span><span class="p">);</span>
	<span class="n">bnx2x_bits_en</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">emac_base</span> <span class="o">+</span> <span class="n">EMAC_REG_EMAC_TX_MODE</span><span class="p">,</span>
		      <span class="n">EMAC_TX_MODE_RESET</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">CHIP_REV_IS_SLOW</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* config GMII mode */</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">emac_base</span> <span class="o">+</span> <span class="n">EMAC_REG_EMAC_MODE</span><span class="p">);</span>
		<span class="n">EMAC_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">EMAC_REG_EMAC_MODE</span><span class="p">,</span> <span class="p">(</span><span class="n">val</span> <span class="o">|</span> <span class="n">EMAC_MODE_PORT_GMII</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="cm">/* ASIC */</span>
		<span class="cm">/* pause enable/disable */</span>
		<span class="n">bnx2x_bits_dis</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">emac_base</span> <span class="o">+</span> <span class="n">EMAC_REG_EMAC_RX_MODE</span><span class="p">,</span>
			       <span class="n">EMAC_RX_MODE_FLOW_EN</span><span class="p">);</span>

		<span class="n">bnx2x_bits_dis</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span>  <span class="n">emac_base</span> <span class="o">+</span> <span class="n">EMAC_REG_EMAC_TX_MODE</span><span class="p">,</span>
			       <span class="p">(</span><span class="n">EMAC_TX_MODE_EXT_PAUSE_EN</span> <span class="o">|</span>
				<span class="n">EMAC_TX_MODE_FLOW_EN</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">feature_config_flags</span> <span class="o">&amp;</span>
		      <span class="n">FEATURE_CONFIG_PFC_ENABLED</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">vars</span><span class="o">-&gt;</span><span class="n">flow_ctrl</span> <span class="o">&amp;</span> <span class="n">BNX2X_FLOW_CTRL_RX</span><span class="p">)</span>
				<span class="n">bnx2x_bits_en</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">emac_base</span> <span class="o">+</span>
					      <span class="n">EMAC_REG_EMAC_RX_MODE</span><span class="p">,</span>
					      <span class="n">EMAC_RX_MODE_FLOW_EN</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">vars</span><span class="o">-&gt;</span><span class="n">flow_ctrl</span> <span class="o">&amp;</span> <span class="n">BNX2X_FLOW_CTRL_TX</span><span class="p">)</span>
				<span class="n">bnx2x_bits_en</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">emac_base</span> <span class="o">+</span>
					      <span class="n">EMAC_REG_EMAC_TX_MODE</span><span class="p">,</span>
					      <span class="p">(</span><span class="n">EMAC_TX_MODE_EXT_PAUSE_EN</span> <span class="o">|</span>
					       <span class="n">EMAC_TX_MODE_FLOW_EN</span><span class="p">));</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">bnx2x_bits_en</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">emac_base</span> <span class="o">+</span> <span class="n">EMAC_REG_EMAC_TX_MODE</span><span class="p">,</span>
				      <span class="n">EMAC_TX_MODE_FLOW_EN</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* KEEP_VLAN_TAG, promiscuous */</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">emac_base</span> <span class="o">+</span> <span class="n">EMAC_REG_EMAC_RX_MODE</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">|=</span> <span class="n">EMAC_RX_MODE_KEEP_VLAN_TAG</span> <span class="o">|</span> <span class="n">EMAC_RX_MODE_PROMISCUOUS</span><span class="p">;</span>

	<span class="cm">/* Setting this bit causes MAC control frames (except for pause</span>
<span class="cm">	 * frames) to be passed on for processing. This setting has no</span>
<span class="cm">	 * affect on the operation of the pause frames. This bit effects</span>
<span class="cm">	 * all packets regardless of RX Parser packet sorting logic.</span>
<span class="cm">	 * Turn the PFC off to make sure we are in Xon state before</span>
<span class="cm">	 * enabling it.</span>
<span class="cm">	 */</span>
	<span class="n">EMAC_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">EMAC_REG_RX_PFC_MODE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">feature_config_flags</span> <span class="o">&amp;</span> <span class="n">FEATURE_CONFIG_PFC_ENABLED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;PFC is enabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="cm">/* Enable PFC again */</span>
		<span class="n">EMAC_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">EMAC_REG_RX_PFC_MODE</span><span class="p">,</span>
			<span class="n">EMAC_REG_RX_PFC_MODE_RX_EN</span> <span class="o">|</span>
			<span class="n">EMAC_REG_RX_PFC_MODE_TX_EN</span> <span class="o">|</span>
			<span class="n">EMAC_REG_RX_PFC_MODE_PRIORITIES</span><span class="p">);</span>

		<span class="n">EMAC_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">EMAC_REG_RX_PFC_PARAM</span><span class="p">,</span>
			<span class="p">((</span><span class="mh">0x0101</span> <span class="o">&lt;&lt;</span>
			  <span class="n">EMAC_REG_RX_PFC_PARAM_OPCODE_BITSHIFT</span><span class="p">)</span> <span class="o">|</span>
			 <span class="p">(</span><span class="mh">0x00ff</span> <span class="o">&lt;&lt;</span>
			  <span class="n">EMAC_REG_RX_PFC_PARAM_PRIORITY_EN_BITSHIFT</span><span class="p">)));</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">EMAC_RX_MODE_KEEP_MAC_CONTROL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">EMAC_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">EMAC_REG_EMAC_RX_MODE</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

	<span class="cm">/* Set Loopback */</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">emac_base</span> <span class="o">+</span> <span class="n">EMAC_REG_EMAC_MODE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lb</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="mh">0x810</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x810</span><span class="p">;</span>
	<span class="n">EMAC_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">EMAC_REG_EMAC_MODE</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

	<span class="cm">/* enable emac */</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">NIG_REG_NIG_EMAC0_EN</span> <span class="o">+</span> <span class="n">port</span><span class="o">*</span><span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* enable emac for jumbo packets */</span>
	<span class="n">EMAC_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">EMAC_REG_EMAC_RX_MTU_SIZE</span><span class="p">,</span>
		<span class="p">(</span><span class="n">EMAC_RX_MTU_SIZE_JUMBO_ENA</span> <span class="o">|</span>
		 <span class="p">(</span><span class="n">ETH_MAX_JUMBO_PACKET_SIZE</span> <span class="o">+</span> <span class="n">ETH_OVREHEAD</span><span class="p">)));</span>

	<span class="cm">/* strip CRC */</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">NIG_REG_NIG_INGRESS_EMAC0_NO_CRC</span> <span class="o">+</span> <span class="n">port</span><span class="o">*</span><span class="mi">4</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">);</span>

	<span class="cm">/* disable the NIG in/out to the bmac */</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">NIG_REG_BMAC0_IN_EN</span> <span class="o">+</span> <span class="n">port</span><span class="o">*</span><span class="mi">4</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">NIG_REG_BMAC0_PAUSE_OUT_EN</span> <span class="o">+</span> <span class="n">port</span><span class="o">*</span><span class="mi">4</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">NIG_REG_BMAC0_OUT_EN</span> <span class="o">+</span> <span class="n">port</span><span class="o">*</span><span class="mi">4</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>

	<span class="cm">/* enable the NIG in/out to the emac */</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">NIG_REG_EMAC0_IN_EN</span> <span class="o">+</span> <span class="n">port</span><span class="o">*</span><span class="mi">4</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">feature_config_flags</span> <span class="o">&amp;</span>
	      <span class="n">FEATURE_CONFIG_PFC_ENABLED</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">vars</span><span class="o">-&gt;</span><span class="n">flow_ctrl</span> <span class="o">&amp;</span> <span class="n">BNX2X_FLOW_CTRL_TX</span><span class="p">))</span>
		<span class="n">val</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">NIG_REG_EMAC0_PAUSE_OUT_EN</span> <span class="o">+</span> <span class="n">port</span><span class="o">*</span><span class="mi">4</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">NIG_REG_EGRESS_EMAC0_OUT_EN</span> <span class="o">+</span> <span class="n">port</span><span class="o">*</span><span class="mi">4</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">);</span>

	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">NIG_REG_BMAC0_REGS_OUT_EN</span> <span class="o">+</span> <span class="n">port</span><span class="o">*</span><span class="mi">4</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>

	<span class="n">vars</span><span class="o">-&gt;</span><span class="n">mac_type</span> <span class="o">=</span> <span class="n">MAC_TYPE_EMAC</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_update_pfc_bmac1</span><span class="p">(</span><span class="k">struct</span> <span class="n">link_params</span> <span class="o">*</span><span class="n">params</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">link_vars</span> <span class="o">*</span><span class="n">vars</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">wb_data</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">bp</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">bmac_addr</span> <span class="o">=</span>  <span class="n">params</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">?</span> <span class="n">NIG_REG_INGRESS_BMAC1_MEM</span> <span class="o">:</span>
		<span class="n">NIG_REG_INGRESS_BMAC0_MEM</span><span class="p">;</span>

	<span class="n">u32</span> <span class="n">val</span> <span class="o">=</span> <span class="mh">0x14</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">feature_config_flags</span> <span class="o">&amp;</span>
	      <span class="n">FEATURE_CONFIG_PFC_ENABLED</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
		<span class="p">(</span><span class="n">vars</span><span class="o">-&gt;</span><span class="n">flow_ctrl</span> <span class="o">&amp;</span> <span class="n">BNX2X_FLOW_CTRL_RX</span><span class="p">))</span>
		<span class="cm">/* Enable BigMAC to react on received Pause packets */</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">5</span><span class="p">);</span>
	<span class="n">wb_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
	<span class="n">wb_data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">REG_WR_DMAE</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">bmac_addr</span> <span class="o">+</span> <span class="n">BIGMAC_REGISTER_RX_CONTROL</span><span class="p">,</span> <span class="n">wb_data</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>

	<span class="cm">/* tx control */</span>
	<span class="n">val</span> <span class="o">=</span> <span class="mh">0xc0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">feature_config_flags</span> <span class="o">&amp;</span>
	      <span class="n">FEATURE_CONFIG_PFC_ENABLED</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		<span class="p">(</span><span class="n">vars</span><span class="o">-&gt;</span><span class="n">flow_ctrl</span> <span class="o">&amp;</span> <span class="n">BNX2X_FLOW_CTRL_TX</span><span class="p">))</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="mh">0x800000</span><span class="p">;</span>
	<span class="n">wb_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
	<span class="n">wb_data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">REG_WR_DMAE</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">bmac_addr</span> <span class="o">+</span> <span class="n">BIGMAC_REGISTER_TX_CONTROL</span><span class="p">,</span> <span class="n">wb_data</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_update_pfc_bmac2</span><span class="p">(</span><span class="k">struct</span> <span class="n">link_params</span> <span class="o">*</span><span class="n">params</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">link_vars</span> <span class="o">*</span><span class="n">vars</span><span class="p">,</span>
				   <span class="n">u8</span> <span class="n">is_lb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Set rx control: Strip CRC and enable BigMAC to relay</span>
<span class="cm">	 * control packets to the system as well</span>
<span class="cm">	 */</span>
	<span class="n">u32</span> <span class="n">wb_data</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">bp</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">bmac_addr</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">?</span> <span class="n">NIG_REG_INGRESS_BMAC1_MEM</span> <span class="o">:</span>
		<span class="n">NIG_REG_INGRESS_BMAC0_MEM</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">val</span> <span class="o">=</span> <span class="mh">0x14</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">feature_config_flags</span> <span class="o">&amp;</span>
	      <span class="n">FEATURE_CONFIG_PFC_ENABLED</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
		<span class="p">(</span><span class="n">vars</span><span class="o">-&gt;</span><span class="n">flow_ctrl</span> <span class="o">&amp;</span> <span class="n">BNX2X_FLOW_CTRL_RX</span><span class="p">))</span>
		<span class="cm">/* Enable BigMAC to react on received Pause packets */</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">5</span><span class="p">);</span>
	<span class="n">wb_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
	<span class="n">wb_data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">REG_WR_DMAE</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">bmac_addr</span> <span class="o">+</span> <span class="n">BIGMAC2_REGISTER_RX_CONTROL</span><span class="p">,</span> <span class="n">wb_data</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">30</span><span class="p">);</span>

	<span class="cm">/* Tx control */</span>
	<span class="n">val</span> <span class="o">=</span> <span class="mh">0xc0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">feature_config_flags</span> <span class="o">&amp;</span>
				<span class="n">FEATURE_CONFIG_PFC_ENABLED</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">vars</span><span class="o">-&gt;</span><span class="n">flow_ctrl</span> <span class="o">&amp;</span> <span class="n">BNX2X_FLOW_CTRL_TX</span><span class="p">))</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="mh">0x800000</span><span class="p">;</span>
	<span class="n">wb_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
	<span class="n">wb_data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">REG_WR_DMAE</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">bmac_addr</span> <span class="o">+</span> <span class="n">BIGMAC2_REGISTER_TX_CONTROL</span><span class="p">,</span> <span class="n">wb_data</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">feature_config_flags</span> <span class="o">&amp;</span> <span class="n">FEATURE_CONFIG_PFC_ENABLED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;PFC is enabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="cm">/* Enable PFC RX &amp; TX &amp; STATS and set 8 COS  */</span>
		<span class="n">wb_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>
		<span class="n">wb_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">0</span><span class="p">);</span>  <span class="cm">/* RX */</span>
		<span class="n">wb_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">1</span><span class="p">);</span>  <span class="cm">/* TX */</span>
		<span class="n">wb_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">2</span><span class="p">);</span>  <span class="cm">/* Force initial Xon */</span>
		<span class="n">wb_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">3</span><span class="p">);</span>  <span class="cm">/* 8 cos */</span>
		<span class="n">wb_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">5</span><span class="p">);</span>  <span class="cm">/* STATS */</span>
		<span class="n">wb_data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">REG_WR_DMAE</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">bmac_addr</span> <span class="o">+</span> <span class="n">BIGMAC2_REGISTER_PFC_CONTROL</span><span class="p">,</span>
			    <span class="n">wb_data</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
		<span class="cm">/* Clear the force Xon */</span>
		<span class="n">wb_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">2</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;PFC is disabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="cm">/* disable PFC RX &amp; TX &amp; STATS and set 8 COS */</span>
		<span class="n">wb_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x8</span><span class="p">;</span>
		<span class="n">wb_data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">REG_WR_DMAE</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">bmac_addr</span> <span class="o">+</span> <span class="n">BIGMAC2_REGISTER_PFC_CONTROL</span><span class="p">,</span> <span class="n">wb_data</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>

	<span class="cm">/* Set Time (based unit is 512 bit time) between automatic</span>
<span class="cm">	 * re-sending of PP packets amd enable automatic re-send of</span>
<span class="cm">	 * Per-Priroity Packet as long as pp_gen is asserted and</span>
<span class="cm">	 * pp_disable is low.</span>
<span class="cm">	 */</span>
	<span class="n">val</span> <span class="o">=</span> <span class="mh">0x8000</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">feature_config_flags</span> <span class="o">&amp;</span> <span class="n">FEATURE_CONFIG_PFC_ENABLED</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">16</span><span class="p">);</span> <span class="cm">/* enable automatic re-send */</span>

	<span class="n">wb_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
	<span class="n">wb_data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">REG_WR_DMAE</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">bmac_addr</span> <span class="o">+</span> <span class="n">BIGMAC2_REGISTER_TX_PAUSE_CONTROL</span><span class="p">,</span>
		    <span class="n">wb_data</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>

	<span class="cm">/* mac control */</span>
	<span class="n">val</span> <span class="o">=</span> <span class="mh">0x3</span><span class="p">;</span> <span class="cm">/* Enable RX and TX */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is_lb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="mh">0x4</span><span class="p">;</span> <span class="cm">/* Local loopback */</span>
		<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;enable bmac loopback</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/* When PFC enabled, Pass pause frames towards the NIG. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">feature_config_flags</span> <span class="o">&amp;</span> <span class="n">FEATURE_CONFIG_PFC_ENABLED</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="p">((</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">6</span><span class="p">)</span><span class="o">|</span><span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">5</span><span class="p">));</span>

	<span class="n">wb_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
	<span class="n">wb_data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">REG_WR_DMAE</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">bmac_addr</span> <span class="o">+</span> <span class="n">BIGMAC2_REGISTER_BMAC_CONTROL</span><span class="p">,</span> <span class="n">wb_data</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* PFC BRB internal port configuration params */</span>
<span class="k">struct</span> <span class="n">bnx2x_pfc_brb_threshold_val</span> <span class="p">{</span>
	<span class="n">u32</span> <span class="n">pause_xoff</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">pause_xon</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">full_xoff</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">full_xon</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">bnx2x_pfc_brb_e3b0_val</span> <span class="p">{</span>
	<span class="n">u32</span> <span class="n">per_class_guaranty_mode</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">lb_guarantied_hyst</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">full_lb_xoff_th</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">full_lb_xon_threshold</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">lb_guarantied</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">mac_0_class_t_guarantied</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">mac_0_class_t_guarantied_hyst</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">mac_1_class_t_guarantied</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">mac_1_class_t_guarantied_hyst</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">bnx2x_pfc_brb_th_val</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2x_pfc_brb_threshold_val</span> <span class="n">pauseable_th</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bnx2x_pfc_brb_threshold_val</span> <span class="n">non_pauseable_th</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bnx2x_pfc_brb_threshold_val</span> <span class="n">default_class0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bnx2x_pfc_brb_threshold_val</span> <span class="n">default_class1</span><span class="p">;</span>

<span class="p">};</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">bnx2x_pfc_brb_get_config_params</span><span class="p">(</span>
				<span class="k">struct</span> <span class="n">link_params</span> <span class="o">*</span><span class="n">params</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">bnx2x_pfc_brb_th_val</span> <span class="o">*</span><span class="n">config_val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">bp</span><span class="p">;</span>
	<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;Setting PFC BRB configuration</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">config_val</span><span class="o">-&gt;</span><span class="n">default_class1</span><span class="p">.</span><span class="n">pause_xoff</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">config_val</span><span class="o">-&gt;</span><span class="n">default_class1</span><span class="p">.</span><span class="n">pause_xon</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">config_val</span><span class="o">-&gt;</span><span class="n">default_class1</span><span class="p">.</span><span class="n">full_xoff</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">config_val</span><span class="o">-&gt;</span><span class="n">default_class1</span><span class="p">.</span><span class="n">full_xon</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">CHIP_IS_E2</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Class0 defaults */</span>
		<span class="n">config_val</span><span class="o">-&gt;</span><span class="n">default_class0</span><span class="p">.</span><span class="n">pause_xoff</span> <span class="o">=</span>
			<span class="n">DEFAULT0_E2_BRB_MAC_PAUSE_XOFF_THR</span><span class="p">;</span>
		<span class="n">config_val</span><span class="o">-&gt;</span><span class="n">default_class0</span><span class="p">.</span><span class="n">pause_xon</span> <span class="o">=</span>
			<span class="n">DEFAULT0_E2_BRB_MAC_PAUSE_XON_THR</span><span class="p">;</span>
		<span class="n">config_val</span><span class="o">-&gt;</span><span class="n">default_class0</span><span class="p">.</span><span class="n">full_xoff</span> <span class="o">=</span>
			<span class="n">DEFAULT0_E2_BRB_MAC_FULL_XOFF_THR</span><span class="p">;</span>
		<span class="n">config_val</span><span class="o">-&gt;</span><span class="n">default_class0</span><span class="p">.</span><span class="n">full_xon</span> <span class="o">=</span>
			<span class="n">DEFAULT0_E2_BRB_MAC_FULL_XON_THR</span><span class="p">;</span>
		<span class="cm">/* Pause able*/</span>
		<span class="n">config_val</span><span class="o">-&gt;</span><span class="n">pauseable_th</span><span class="p">.</span><span class="n">pause_xoff</span> <span class="o">=</span>
			<span class="n">PFC_E2_BRB_MAC_PAUSE_XOFF_THR_PAUSE</span><span class="p">;</span>
		<span class="n">config_val</span><span class="o">-&gt;</span><span class="n">pauseable_th</span><span class="p">.</span><span class="n">pause_xon</span> <span class="o">=</span>
			<span class="n">PFC_E2_BRB_MAC_PAUSE_XON_THR_PAUSE</span><span class="p">;</span>
		<span class="n">config_val</span><span class="o">-&gt;</span><span class="n">pauseable_th</span><span class="p">.</span><span class="n">full_xoff</span> <span class="o">=</span>
			<span class="n">PFC_E2_BRB_MAC_FULL_XOFF_THR_PAUSE</span><span class="p">;</span>
		<span class="n">config_val</span><span class="o">-&gt;</span><span class="n">pauseable_th</span><span class="p">.</span><span class="n">full_xon</span> <span class="o">=</span>
			<span class="n">PFC_E2_BRB_MAC_FULL_XON_THR_PAUSE</span><span class="p">;</span>
		<span class="cm">/* non pause able*/</span>
		<span class="n">config_val</span><span class="o">-&gt;</span><span class="n">non_pauseable_th</span><span class="p">.</span><span class="n">pause_xoff</span> <span class="o">=</span>
			<span class="n">PFC_E2_BRB_MAC_PAUSE_XOFF_THR_NON_PAUSE</span><span class="p">;</span>
		<span class="n">config_val</span><span class="o">-&gt;</span><span class="n">non_pauseable_th</span><span class="p">.</span><span class="n">pause_xon</span> <span class="o">=</span>
			<span class="n">PFC_E2_BRB_MAC_PAUSE_XON_THR_NON_PAUSE</span><span class="p">;</span>
		<span class="n">config_val</span><span class="o">-&gt;</span><span class="n">non_pauseable_th</span><span class="p">.</span><span class="n">full_xoff</span> <span class="o">=</span>
			<span class="n">PFC_E2_BRB_MAC_FULL_XOFF_THR_NON_PAUSE</span><span class="p">;</span>
		<span class="n">config_val</span><span class="o">-&gt;</span><span class="n">non_pauseable_th</span><span class="p">.</span><span class="n">full_xon</span> <span class="o">=</span>
			<span class="n">PFC_E2_BRB_MAC_FULL_XON_THR_NON_PAUSE</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">CHIP_IS_E3A0</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Class0 defaults */</span>
		<span class="n">config_val</span><span class="o">-&gt;</span><span class="n">default_class0</span><span class="p">.</span><span class="n">pause_xoff</span> <span class="o">=</span>
			<span class="n">DEFAULT0_E3A0_BRB_MAC_PAUSE_XOFF_THR</span><span class="p">;</span>
		<span class="n">config_val</span><span class="o">-&gt;</span><span class="n">default_class0</span><span class="p">.</span><span class="n">pause_xon</span> <span class="o">=</span>
			<span class="n">DEFAULT0_E3A0_BRB_MAC_PAUSE_XON_THR</span><span class="p">;</span>
		<span class="n">config_val</span><span class="o">-&gt;</span><span class="n">default_class0</span><span class="p">.</span><span class="n">full_xoff</span> <span class="o">=</span>
			<span class="n">DEFAULT0_E3A0_BRB_MAC_FULL_XOFF_THR</span><span class="p">;</span>
		<span class="n">config_val</span><span class="o">-&gt;</span><span class="n">default_class0</span><span class="p">.</span><span class="n">full_xon</span> <span class="o">=</span>
			<span class="n">DEFAULT0_E3A0_BRB_MAC_FULL_XON_THR</span><span class="p">;</span>
		<span class="cm">/* Pause able */</span>
		<span class="n">config_val</span><span class="o">-&gt;</span><span class="n">pauseable_th</span><span class="p">.</span><span class="n">pause_xoff</span> <span class="o">=</span>
			<span class="n">PFC_E3A0_BRB_MAC_PAUSE_XOFF_THR_PAUSE</span><span class="p">;</span>
		<span class="n">config_val</span><span class="o">-&gt;</span><span class="n">pauseable_th</span><span class="p">.</span><span class="n">pause_xon</span> <span class="o">=</span>
			<span class="n">PFC_E3A0_BRB_MAC_PAUSE_XON_THR_PAUSE</span><span class="p">;</span>
		<span class="n">config_val</span><span class="o">-&gt;</span><span class="n">pauseable_th</span><span class="p">.</span><span class="n">full_xoff</span> <span class="o">=</span>
			<span class="n">PFC_E3A0_BRB_MAC_FULL_XOFF_THR_PAUSE</span><span class="p">;</span>
		<span class="n">config_val</span><span class="o">-&gt;</span><span class="n">pauseable_th</span><span class="p">.</span><span class="n">full_xon</span> <span class="o">=</span>
			<span class="n">PFC_E3A0_BRB_MAC_FULL_XON_THR_PAUSE</span><span class="p">;</span>
		<span class="cm">/* non pause able*/</span>
		<span class="n">config_val</span><span class="o">-&gt;</span><span class="n">non_pauseable_th</span><span class="p">.</span><span class="n">pause_xoff</span> <span class="o">=</span>
			<span class="n">PFC_E3A0_BRB_MAC_PAUSE_XOFF_THR_NON_PAUSE</span><span class="p">;</span>
		<span class="n">config_val</span><span class="o">-&gt;</span><span class="n">non_pauseable_th</span><span class="p">.</span><span class="n">pause_xon</span> <span class="o">=</span>
			<span class="n">PFC_E3A0_BRB_MAC_PAUSE_XON_THR_NON_PAUSE</span><span class="p">;</span>
		<span class="n">config_val</span><span class="o">-&gt;</span><span class="n">non_pauseable_th</span><span class="p">.</span><span class="n">full_xoff</span> <span class="o">=</span>
			<span class="n">PFC_E3A0_BRB_MAC_FULL_XOFF_THR_NON_PAUSE</span><span class="p">;</span>
		<span class="n">config_val</span><span class="o">-&gt;</span><span class="n">non_pauseable_th</span><span class="p">.</span><span class="n">full_xon</span> <span class="o">=</span>
			<span class="n">PFC_E3A0_BRB_MAC_FULL_XON_THR_NON_PAUSE</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">CHIP_IS_E3B0</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Class0 defaults */</span>
		<span class="n">config_val</span><span class="o">-&gt;</span><span class="n">default_class0</span><span class="p">.</span><span class="n">pause_xoff</span> <span class="o">=</span>
			<span class="n">DEFAULT0_E3B0_BRB_MAC_PAUSE_XOFF_THR</span><span class="p">;</span>
		<span class="n">config_val</span><span class="o">-&gt;</span><span class="n">default_class0</span><span class="p">.</span><span class="n">pause_xon</span> <span class="o">=</span>
		    <span class="n">DEFAULT0_E3B0_BRB_MAC_PAUSE_XON_THR</span><span class="p">;</span>
		<span class="n">config_val</span><span class="o">-&gt;</span><span class="n">default_class0</span><span class="p">.</span><span class="n">full_xoff</span> <span class="o">=</span>
		    <span class="n">DEFAULT0_E3B0_BRB_MAC_FULL_XOFF_THR</span><span class="p">;</span>
		<span class="n">config_val</span><span class="o">-&gt;</span><span class="n">default_class0</span><span class="p">.</span><span class="n">full_xon</span> <span class="o">=</span>
		    <span class="n">DEFAULT0_E3B0_BRB_MAC_FULL_XON_THR</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">[</span><span class="n">INT_PHY</span><span class="p">].</span><span class="n">flags</span> <span class="o">&amp;</span>
		    <span class="n">FLAGS_4_PORT_MODE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">config_val</span><span class="o">-&gt;</span><span class="n">pauseable_th</span><span class="p">.</span><span class="n">pause_xoff</span> <span class="o">=</span>
				<span class="n">PFC_E3B0_4P_BRB_MAC_PAUSE_XOFF_THR_PAUSE</span><span class="p">;</span>
			<span class="n">config_val</span><span class="o">-&gt;</span><span class="n">pauseable_th</span><span class="p">.</span><span class="n">pause_xon</span> <span class="o">=</span>
				<span class="n">PFC_E3B0_4P_BRB_MAC_PAUSE_XON_THR_PAUSE</span><span class="p">;</span>
			<span class="n">config_val</span><span class="o">-&gt;</span><span class="n">pauseable_th</span><span class="p">.</span><span class="n">full_xoff</span> <span class="o">=</span>
				<span class="n">PFC_E3B0_4P_BRB_MAC_FULL_XOFF_THR_PAUSE</span><span class="p">;</span>
			<span class="n">config_val</span><span class="o">-&gt;</span><span class="n">pauseable_th</span><span class="p">.</span><span class="n">full_xon</span> <span class="o">=</span>
				<span class="n">PFC_E3B0_4P_BRB_MAC_FULL_XON_THR_PAUSE</span><span class="p">;</span>
			<span class="cm">/* non pause able*/</span>
			<span class="n">config_val</span><span class="o">-&gt;</span><span class="n">non_pauseable_th</span><span class="p">.</span><span class="n">pause_xoff</span> <span class="o">=</span>
			<span class="n">PFC_E3B0_4P_BRB_MAC_PAUSE_XOFF_THR_NON_PAUSE</span><span class="p">;</span>
			<span class="n">config_val</span><span class="o">-&gt;</span><span class="n">non_pauseable_th</span><span class="p">.</span><span class="n">pause_xon</span> <span class="o">=</span>
			<span class="n">PFC_E3B0_4P_BRB_MAC_PAUSE_XON_THR_NON_PAUSE</span><span class="p">;</span>
			<span class="n">config_val</span><span class="o">-&gt;</span><span class="n">non_pauseable_th</span><span class="p">.</span><span class="n">full_xoff</span> <span class="o">=</span>
			<span class="n">PFC_E3B0_4P_BRB_MAC_FULL_XOFF_THR_NON_PAUSE</span><span class="p">;</span>
			<span class="n">config_val</span><span class="o">-&gt;</span><span class="n">non_pauseable_th</span><span class="p">.</span><span class="n">full_xon</span> <span class="o">=</span>
			<span class="n">PFC_E3B0_4P_BRB_MAC_FULL_XON_THR_NON_PAUSE</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">config_val</span><span class="o">-&gt;</span><span class="n">pauseable_th</span><span class="p">.</span><span class="n">pause_xoff</span> <span class="o">=</span>
				<span class="n">PFC_E3B0_2P_BRB_MAC_PAUSE_XOFF_THR_PAUSE</span><span class="p">;</span>
			<span class="n">config_val</span><span class="o">-&gt;</span><span class="n">pauseable_th</span><span class="p">.</span><span class="n">pause_xon</span> <span class="o">=</span>
				<span class="n">PFC_E3B0_2P_BRB_MAC_PAUSE_XON_THR_PAUSE</span><span class="p">;</span>
			<span class="n">config_val</span><span class="o">-&gt;</span><span class="n">pauseable_th</span><span class="p">.</span><span class="n">full_xoff</span> <span class="o">=</span>
				<span class="n">PFC_E3B0_2P_BRB_MAC_FULL_XOFF_THR_PAUSE</span><span class="p">;</span>
			<span class="n">config_val</span><span class="o">-&gt;</span><span class="n">pauseable_th</span><span class="p">.</span><span class="n">full_xon</span> <span class="o">=</span>
				<span class="n">PFC_E3B0_2P_BRB_MAC_FULL_XON_THR_PAUSE</span><span class="p">;</span>
			<span class="cm">/* non pause able*/</span>
			<span class="n">config_val</span><span class="o">-&gt;</span><span class="n">non_pauseable_th</span><span class="p">.</span><span class="n">pause_xoff</span> <span class="o">=</span>
				<span class="n">PFC_E3B0_2P_BRB_MAC_PAUSE_XOFF_THR_NON_PAUSE</span><span class="p">;</span>
			<span class="n">config_val</span><span class="o">-&gt;</span><span class="n">non_pauseable_th</span><span class="p">.</span><span class="n">pause_xon</span> <span class="o">=</span>
				<span class="n">PFC_E3B0_2P_BRB_MAC_PAUSE_XON_THR_NON_PAUSE</span><span class="p">;</span>
			<span class="n">config_val</span><span class="o">-&gt;</span><span class="n">non_pauseable_th</span><span class="p">.</span><span class="n">full_xoff</span> <span class="o">=</span>
				<span class="n">PFC_E3B0_2P_BRB_MAC_FULL_XOFF_THR_NON_PAUSE</span><span class="p">;</span>
			<span class="n">config_val</span><span class="o">-&gt;</span><span class="n">non_pauseable_th</span><span class="p">.</span><span class="n">full_xon</span> <span class="o">=</span>
				<span class="n">PFC_E3B0_2P_BRB_MAC_FULL_XON_THR_NON_PAUSE</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span>
	    <span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_pfc_brb_get_e3b0_config_params</span><span class="p">(</span>
		<span class="k">struct</span> <span class="n">link_params</span> <span class="o">*</span><span class="n">params</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">bnx2x_pfc_brb_e3b0_val</span>
		<span class="o">*</span><span class="n">e3b0_val</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">bnx2x_nig_brb_pfc_port_params</span> <span class="o">*</span><span class="n">pfc_params</span><span class="p">,</span>
		<span class="k">const</span> <span class="n">u8</span> <span class="n">pfc_enabled</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pfc_enabled</span> <span class="o">&amp;&amp;</span> <span class="n">pfc_params</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">e3b0_val</span><span class="o">-&gt;</span><span class="n">per_class_guaranty_mode</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">e3b0_val</span><span class="o">-&gt;</span><span class="n">lb_guarantied_hyst</span> <span class="o">=</span> <span class="mi">80</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">[</span><span class="n">INT_PHY</span><span class="p">].</span><span class="n">flags</span> <span class="o">&amp;</span>
		    <span class="n">FLAGS_4_PORT_MODE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">e3b0_val</span><span class="o">-&gt;</span><span class="n">full_lb_xoff_th</span> <span class="o">=</span>
				<span class="n">PFC_E3B0_4P_BRB_FULL_LB_XOFF_THR</span><span class="p">;</span>
			<span class="n">e3b0_val</span><span class="o">-&gt;</span><span class="n">full_lb_xon_threshold</span> <span class="o">=</span>
				<span class="n">PFC_E3B0_4P_BRB_FULL_LB_XON_THR</span><span class="p">;</span>
			<span class="n">e3b0_val</span><span class="o">-&gt;</span><span class="n">lb_guarantied</span> <span class="o">=</span>
				<span class="n">PFC_E3B0_4P_LB_GUART</span><span class="p">;</span>
			<span class="n">e3b0_val</span><span class="o">-&gt;</span><span class="n">mac_0_class_t_guarantied</span> <span class="o">=</span>
				<span class="n">PFC_E3B0_4P_BRB_MAC_0_CLASS_T_GUART</span><span class="p">;</span>
			<span class="n">e3b0_val</span><span class="o">-&gt;</span><span class="n">mac_0_class_t_guarantied_hyst</span> <span class="o">=</span>
				<span class="n">PFC_E3B0_4P_BRB_MAC_0_CLASS_T_GUART_HYST</span><span class="p">;</span>
			<span class="n">e3b0_val</span><span class="o">-&gt;</span><span class="n">mac_1_class_t_guarantied</span> <span class="o">=</span>
				<span class="n">PFC_E3B0_4P_BRB_MAC_1_CLASS_T_GUART</span><span class="p">;</span>
			<span class="n">e3b0_val</span><span class="o">-&gt;</span><span class="n">mac_1_class_t_guarantied_hyst</span> <span class="o">=</span>
				<span class="n">PFC_E3B0_4P_BRB_MAC_1_CLASS_T_GUART_HYST</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">e3b0_val</span><span class="o">-&gt;</span><span class="n">full_lb_xoff_th</span> <span class="o">=</span>
				<span class="n">PFC_E3B0_2P_BRB_FULL_LB_XOFF_THR</span><span class="p">;</span>
			<span class="n">e3b0_val</span><span class="o">-&gt;</span><span class="n">full_lb_xon_threshold</span> <span class="o">=</span>
				<span class="n">PFC_E3B0_2P_BRB_FULL_LB_XON_THR</span><span class="p">;</span>
			<span class="n">e3b0_val</span><span class="o">-&gt;</span><span class="n">mac_0_class_t_guarantied_hyst</span> <span class="o">=</span>
				<span class="n">PFC_E3B0_2P_BRB_MAC_0_CLASS_T_GUART_HYST</span><span class="p">;</span>
			<span class="n">e3b0_val</span><span class="o">-&gt;</span><span class="n">mac_1_class_t_guarantied</span> <span class="o">=</span>
				<span class="n">PFC_E3B0_2P_BRB_MAC_1_CLASS_T_GUART</span><span class="p">;</span>
			<span class="n">e3b0_val</span><span class="o">-&gt;</span><span class="n">mac_1_class_t_guarantied_hyst</span> <span class="o">=</span>
				<span class="n">PFC_E3B0_2P_BRB_MAC_1_CLASS_T_GUART_HYST</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">pfc_params</span><span class="o">-&gt;</span><span class="n">cos0_pauseable</span> <span class="o">!=</span>
				<span class="n">pfc_params</span><span class="o">-&gt;</span><span class="n">cos1_pauseable</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* nonpauseable= Lossy + pauseable = Lossless*/</span>
				<span class="n">e3b0_val</span><span class="o">-&gt;</span><span class="n">lb_guarantied</span> <span class="o">=</span>
					<span class="n">PFC_E3B0_2P_MIX_PAUSE_LB_GUART</span><span class="p">;</span>
				<span class="n">e3b0_val</span><span class="o">-&gt;</span><span class="n">mac_0_class_t_guarantied</span> <span class="o">=</span>
			       <span class="n">PFC_E3B0_2P_MIX_PAUSE_MAC_0_CLASS_T_GUART</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pfc_params</span><span class="o">-&gt;</span><span class="n">cos0_pauseable</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* Lossless +Lossless*/</span>
				<span class="n">e3b0_val</span><span class="o">-&gt;</span><span class="n">lb_guarantied</span> <span class="o">=</span>
					<span class="n">PFC_E3B0_2P_PAUSE_LB_GUART</span><span class="p">;</span>
				<span class="n">e3b0_val</span><span class="o">-&gt;</span><span class="n">mac_0_class_t_guarantied</span> <span class="o">=</span>
				   <span class="n">PFC_E3B0_2P_PAUSE_MAC_0_CLASS_T_GUART</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="cm">/* Lossy +Lossy*/</span>
				<span class="n">e3b0_val</span><span class="o">-&gt;</span><span class="n">lb_guarantied</span> <span class="o">=</span>
					<span class="n">PFC_E3B0_2P_NON_PAUSE_LB_GUART</span><span class="p">;</span>
				<span class="n">e3b0_val</span><span class="o">-&gt;</span><span class="n">mac_0_class_t_guarantied</span> <span class="o">=</span>
			       <span class="n">PFC_E3B0_2P_NON_PAUSE_MAC_0_CLASS_T_GUART</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">e3b0_val</span><span class="o">-&gt;</span><span class="n">per_class_guaranty_mode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">e3b0_val</span><span class="o">-&gt;</span><span class="n">lb_guarantied_hyst</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">e3b0_val</span><span class="o">-&gt;</span><span class="n">full_lb_xoff_th</span> <span class="o">=</span>
			<span class="n">DEFAULT_E3B0_BRB_FULL_LB_XOFF_THR</span><span class="p">;</span>
		<span class="n">e3b0_val</span><span class="o">-&gt;</span><span class="n">full_lb_xon_threshold</span> <span class="o">=</span>
			<span class="n">DEFAULT_E3B0_BRB_FULL_LB_XON_THR</span><span class="p">;</span>
		<span class="n">e3b0_val</span><span class="o">-&gt;</span><span class="n">lb_guarantied</span> <span class="o">=</span>
			<span class="n">DEFAULT_E3B0_LB_GUART</span><span class="p">;</span>
		<span class="n">e3b0_val</span><span class="o">-&gt;</span><span class="n">mac_0_class_t_guarantied</span> <span class="o">=</span>
			<span class="n">DEFAULT_E3B0_BRB_MAC_0_CLASS_T_GUART</span><span class="p">;</span>
		<span class="n">e3b0_val</span><span class="o">-&gt;</span><span class="n">mac_0_class_t_guarantied_hyst</span> <span class="o">=</span>
			<span class="n">DEFAULT_E3B0_BRB_MAC_0_CLASS_T_GUART_HYST</span><span class="p">;</span>
		<span class="n">e3b0_val</span><span class="o">-&gt;</span><span class="n">mac_1_class_t_guarantied</span> <span class="o">=</span>
			<span class="n">DEFAULT_E3B0_BRB_MAC_1_CLASS_T_GUART</span><span class="p">;</span>
		<span class="n">e3b0_val</span><span class="o">-&gt;</span><span class="n">mac_1_class_t_guarantied_hyst</span> <span class="o">=</span>
			<span class="n">DEFAULT_E3B0_BRB_MAC_1_CLASS_T_GUART_HYST</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">bnx2x_update_pfc_brb</span><span class="p">(</span><span class="k">struct</span> <span class="n">link_params</span> <span class="o">*</span><span class="n">params</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">link_vars</span> <span class="o">*</span><span class="n">vars</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">bnx2x_nig_brb_pfc_port_params</span>
				<span class="o">*</span><span class="n">pfc_params</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">bp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bnx2x_pfc_brb_th_val</span> <span class="n">config_val</span> <span class="o">=</span> <span class="p">{</span> <span class="p">{</span><span class="mi">0</span><span class="p">}</span> <span class="p">};</span>
	<span class="k">struct</span> <span class="n">bnx2x_pfc_brb_threshold_val</span> <span class="o">*</span><span class="n">reg_th_config</span> <span class="o">=</span>
		<span class="o">&amp;</span><span class="n">config_val</span><span class="p">.</span><span class="n">pauseable_th</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bnx2x_pfc_brb_e3b0_val</span> <span class="n">e3b0_val</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
	<span class="k">const</span> <span class="kt">int</span> <span class="n">set_pfc</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">feature_config_flags</span> <span class="o">&amp;</span>
		<span class="n">FEATURE_CONFIG_PFC_ENABLED</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">u8</span> <span class="n">pfc_enabled</span> <span class="o">=</span> <span class="p">(</span><span class="n">set_pfc</span> <span class="o">&amp;&amp;</span> <span class="n">pfc_params</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">bnx2x_status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">port</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>

	<span class="cm">/* default - pause configuration */</span>
	<span class="n">reg_th_config</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">config_val</span><span class="p">.</span><span class="n">pauseable_th</span><span class="p">;</span>
	<span class="n">bnx2x_status</span> <span class="o">=</span> <span class="n">bnx2x_pfc_brb_get_config_params</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">config_val</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bnx2x_status</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">bnx2x_status</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pfc_enabled</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* First COS */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pfc_params</span><span class="o">-&gt;</span><span class="n">cos0_pauseable</span><span class="p">)</span>
			<span class="n">reg_th_config</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">config_val</span><span class="p">.</span><span class="n">pauseable_th</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">reg_th_config</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">config_val</span><span class="p">.</span><span class="n">non_pauseable_th</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">reg_th_config</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">config_val</span><span class="p">.</span><span class="n">default_class0</span><span class="p">;</span>
	<span class="cm">/* The number of free blocks below which the pause signal to class 0</span>
<span class="cm">	 * of MAC #n is asserted. n=0,1</span>
<span class="cm">	 */</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="p">(</span><span class="n">port</span><span class="p">)</span> <span class="o">?</span> <span class="n">BRB1_REG_PAUSE_0_XOFF_THRESHOLD_1</span> <span class="o">:</span>
	       <span class="n">BRB1_REG_PAUSE_0_XOFF_THRESHOLD_0</span> <span class="p">,</span>
	       <span class="n">reg_th_config</span><span class="o">-&gt;</span><span class="n">pause_xoff</span><span class="p">);</span>
	<span class="cm">/* The number of free blocks above which the pause signal to class 0</span>
<span class="cm">	 * of MAC #n is de-asserted. n=0,1</span>
<span class="cm">	 */</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="p">(</span><span class="n">port</span><span class="p">)</span> <span class="o">?</span> <span class="n">BRB1_REG_PAUSE_0_XON_THRESHOLD_1</span> <span class="o">:</span>
	       <span class="n">BRB1_REG_PAUSE_0_XON_THRESHOLD_0</span> <span class="p">,</span> <span class="n">reg_th_config</span><span class="o">-&gt;</span><span class="n">pause_xon</span><span class="p">);</span>
	<span class="cm">/* The number of free blocks below which the full signal to class 0</span>
<span class="cm">	 * of MAC #n is asserted. n=0,1</span>
<span class="cm">	 */</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="p">(</span><span class="n">port</span><span class="p">)</span> <span class="o">?</span> <span class="n">BRB1_REG_FULL_0_XOFF_THRESHOLD_1</span> <span class="o">:</span>
	       <span class="n">BRB1_REG_FULL_0_XOFF_THRESHOLD_0</span> <span class="p">,</span> <span class="n">reg_th_config</span><span class="o">-&gt;</span><span class="n">full_xoff</span><span class="p">);</span>
	<span class="cm">/* The number of free blocks above which the full signal to class 0</span>
<span class="cm">	 * of MAC #n is de-asserted. n=0,1</span>
<span class="cm">	 */</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="p">(</span><span class="n">port</span><span class="p">)</span> <span class="o">?</span> <span class="n">BRB1_REG_FULL_0_XON_THRESHOLD_1</span> <span class="o">:</span>
	       <span class="n">BRB1_REG_FULL_0_XON_THRESHOLD_0</span> <span class="p">,</span> <span class="n">reg_th_config</span><span class="o">-&gt;</span><span class="n">full_xon</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pfc_enabled</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Second COS */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pfc_params</span><span class="o">-&gt;</span><span class="n">cos1_pauseable</span><span class="p">)</span>
			<span class="n">reg_th_config</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">config_val</span><span class="p">.</span><span class="n">pauseable_th</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">reg_th_config</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">config_val</span><span class="p">.</span><span class="n">non_pauseable_th</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">reg_th_config</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">config_val</span><span class="p">.</span><span class="n">default_class1</span><span class="p">;</span>
	<span class="cm">/* The number of free blocks below which the pause signal to</span>
<span class="cm">	 * class 1 of MAC #n is asserted. n=0,1</span>
<span class="cm">	 */</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="p">(</span><span class="n">port</span><span class="p">)</span> <span class="o">?</span> <span class="n">BRB1_REG_PAUSE_1_XOFF_THRESHOLD_1</span> <span class="o">:</span>
	       <span class="n">BRB1_REG_PAUSE_1_XOFF_THRESHOLD_0</span><span class="p">,</span>
	       <span class="n">reg_th_config</span><span class="o">-&gt;</span><span class="n">pause_xoff</span><span class="p">);</span>

	<span class="cm">/* The number of free blocks above which the pause signal to</span>
<span class="cm">	 * class 1 of MAC #n is de-asserted. n=0,1</span>
<span class="cm">	 */</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="p">(</span><span class="n">port</span><span class="p">)</span> <span class="o">?</span> <span class="n">BRB1_REG_PAUSE_1_XON_THRESHOLD_1</span> <span class="o">:</span>
	       <span class="n">BRB1_REG_PAUSE_1_XON_THRESHOLD_0</span><span class="p">,</span>
	       <span class="n">reg_th_config</span><span class="o">-&gt;</span><span class="n">pause_xon</span><span class="p">);</span>
	<span class="cm">/* The number of free blocks below which the full signal to</span>
<span class="cm">	 * class 1 of MAC #n is asserted. n=0,1</span>
<span class="cm">	 */</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="p">(</span><span class="n">port</span><span class="p">)</span> <span class="o">?</span> <span class="n">BRB1_REG_FULL_1_XOFF_THRESHOLD_1</span> <span class="o">:</span>
	       <span class="n">BRB1_REG_FULL_1_XOFF_THRESHOLD_0</span><span class="p">,</span>
	       <span class="n">reg_th_config</span><span class="o">-&gt;</span><span class="n">full_xoff</span><span class="p">);</span>
	<span class="cm">/* The number of free blocks above which the full signal to</span>
<span class="cm">	 * class 1 of MAC #n is de-asserted. n=0,1</span>
<span class="cm">	 */</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="p">(</span><span class="n">port</span><span class="p">)</span> <span class="o">?</span> <span class="n">BRB1_REG_FULL_1_XON_THRESHOLD_1</span> <span class="o">:</span>
	       <span class="n">BRB1_REG_FULL_1_XON_THRESHOLD_0</span><span class="p">,</span>
	       <span class="n">reg_th_config</span><span class="o">-&gt;</span><span class="n">full_xon</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">CHIP_IS_E3B0</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">bnx2x_pfc_brb_get_e3b0_config_params</span><span class="p">(</span>
			<span class="n">params</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">e3b0_val</span><span class="p">,</span>
			<span class="n">pfc_params</span><span class="p">,</span>
			<span class="n">pfc_enabled</span><span class="p">);</span>

		<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">BRB1_REG_PER_CLASS_GUARANTY_MODE</span><span class="p">,</span>
			   <span class="n">e3b0_val</span><span class="p">.</span><span class="n">per_class_guaranty_mode</span><span class="p">);</span>

		<span class="cm">/* The hysteresis on the guarantied buffer space for the Lb</span>
<span class="cm">		 * port before signaling XON.</span>
<span class="cm">		 */</span>
		<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">BRB1_REG_LB_GUARANTIED_HYST</span><span class="p">,</span>
			   <span class="n">e3b0_val</span><span class="p">.</span><span class="n">lb_guarantied_hyst</span><span class="p">);</span>

		<span class="cm">/* The number of free blocks below which the full signal to the</span>
<span class="cm">		 * LB port is asserted.</span>
<span class="cm">		 */</span>
		<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">BRB1_REG_FULL_LB_XOFF_THRESHOLD</span><span class="p">,</span>
		       <span class="n">e3b0_val</span><span class="p">.</span><span class="n">full_lb_xoff_th</span><span class="p">);</span>
		<span class="cm">/* The number of free blocks above which the full signal to the</span>
<span class="cm">		 * LB port is de-asserted.</span>
<span class="cm">		 */</span>
		<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">BRB1_REG_FULL_LB_XON_THRESHOLD</span><span class="p">,</span>
		       <span class="n">e3b0_val</span><span class="p">.</span><span class="n">full_lb_xon_threshold</span><span class="p">);</span>
		<span class="cm">/* The number of blocks guarantied for the MAC #n port. n=0,1</span>
<span class="cm">		 */</span>

		<span class="cm">/* The number of blocks guarantied for the LB port. */</span>
		<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">BRB1_REG_LB_GUARANTIED</span><span class="p">,</span>
		       <span class="n">e3b0_val</span><span class="p">.</span><span class="n">lb_guarantied</span><span class="p">);</span>

		<span class="cm">/* The number of blocks guarantied for the MAC #n port. */</span>
		<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">BRB1_REG_MAC_GUARANTIED_0</span><span class="p">,</span>
		       <span class="mi">2</span> <span class="o">*</span> <span class="n">e3b0_val</span><span class="p">.</span><span class="n">mac_0_class_t_guarantied</span><span class="p">);</span>
		<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">BRB1_REG_MAC_GUARANTIED_1</span><span class="p">,</span>
		       <span class="mi">2</span> <span class="o">*</span> <span class="n">e3b0_val</span><span class="p">.</span><span class="n">mac_1_class_t_guarantied</span><span class="p">);</span>
		<span class="cm">/* The number of blocks guarantied for class #t in MAC0. t=0,1</span>
<span class="cm">		 */</span>
		<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">BRB1_REG_MAC_0_CLASS_0_GUARANTIED</span><span class="p">,</span>
		       <span class="n">e3b0_val</span><span class="p">.</span><span class="n">mac_0_class_t_guarantied</span><span class="p">);</span>
		<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">BRB1_REG_MAC_0_CLASS_1_GUARANTIED</span><span class="p">,</span>
		       <span class="n">e3b0_val</span><span class="p">.</span><span class="n">mac_0_class_t_guarantied</span><span class="p">);</span>
		<span class="cm">/* The hysteresis on the guarantied buffer space for class in</span>
<span class="cm">		 * MAC0.  t=0,1</span>
<span class="cm">		 */</span>
		<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">BRB1_REG_MAC_0_CLASS_0_GUARANTIED_HYST</span><span class="p">,</span>
		       <span class="n">e3b0_val</span><span class="p">.</span><span class="n">mac_0_class_t_guarantied_hyst</span><span class="p">);</span>
		<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">BRB1_REG_MAC_0_CLASS_1_GUARANTIED_HYST</span><span class="p">,</span>
		       <span class="n">e3b0_val</span><span class="p">.</span><span class="n">mac_0_class_t_guarantied_hyst</span><span class="p">);</span>

		<span class="cm">/* The number of blocks guarantied for class #t in MAC1.t=0,1</span>
<span class="cm">		 */</span>
		<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">BRB1_REG_MAC_1_CLASS_0_GUARANTIED</span><span class="p">,</span>
		       <span class="n">e3b0_val</span><span class="p">.</span><span class="n">mac_1_class_t_guarantied</span><span class="p">);</span>
		<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">BRB1_REG_MAC_1_CLASS_1_GUARANTIED</span><span class="p">,</span>
		       <span class="n">e3b0_val</span><span class="p">.</span><span class="n">mac_1_class_t_guarantied</span><span class="p">);</span>
		<span class="cm">/* The hysteresis on the guarantied buffer space for class #t</span>
<span class="cm">		 * in MAC1.  t=0,1</span>
<span class="cm">		 */</span>
		<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">BRB1_REG_MAC_1_CLASS_0_GUARANTIED_HYST</span><span class="p">,</span>
		       <span class="n">e3b0_val</span><span class="p">.</span><span class="n">mac_1_class_t_guarantied_hyst</span><span class="p">);</span>
		<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">BRB1_REG_MAC_1_CLASS_1_GUARANTIED_HYST</span><span class="p">,</span>
		       <span class="n">e3b0_val</span><span class="p">.</span><span class="n">mac_1_class_t_guarantied_hyst</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">bnx2x_status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/******************************************************************************</span>
<span class="cm">* Description:</span>
<span class="cm">*  This function is needed because NIG ARB_CREDIT_WEIGHT_X are</span>
<span class="cm">*  not continues and ARB_CREDIT_WEIGHT_0 + offset is suitable.</span>
<span class="cm">******************************************************************************/</span>
<span class="kt">int</span> <span class="nf">bnx2x_pfc_nig_rx_priority_mask</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">,</span>
					      <span class="n">u8</span> <span class="n">cos_entry</span><span class="p">,</span>
					      <span class="n">u32</span> <span class="n">priority_mask</span><span class="p">,</span> <span class="n">u8</span> <span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">nig_reg_rx_priority_mask_add</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cos_entry</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
	     <span class="n">nig_reg_rx_priority_mask_add</span> <span class="o">=</span> <span class="p">(</span><span class="n">port</span><span class="p">)</span> <span class="o">?</span>
		 <span class="n">NIG_REG_P1_RX_COS0_PRIORITY_MASK</span> <span class="o">:</span>
		 <span class="n">NIG_REG_P0_RX_COS0_PRIORITY_MASK</span><span class="p">;</span>
	     <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1</span>:
	    <span class="n">nig_reg_rx_priority_mask_add</span> <span class="o">=</span> <span class="p">(</span><span class="n">port</span><span class="p">)</span> <span class="o">?</span>
		<span class="n">NIG_REG_P1_RX_COS1_PRIORITY_MASK</span> <span class="o">:</span>
		<span class="n">NIG_REG_P0_RX_COS1_PRIORITY_MASK</span><span class="p">;</span>
	    <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>:
	    <span class="n">nig_reg_rx_priority_mask_add</span> <span class="o">=</span> <span class="p">(</span><span class="n">port</span><span class="p">)</span> <span class="o">?</span>
		<span class="n">NIG_REG_P1_RX_COS2_PRIORITY_MASK</span> <span class="o">:</span>
		<span class="n">NIG_REG_P0_RX_COS2_PRIORITY_MASK</span><span class="p">;</span>
	    <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">3</span>:
	    <span class="k">if</span> <span class="p">(</span><span class="n">port</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	    <span class="n">nig_reg_rx_priority_mask_add</span> <span class="o">=</span> <span class="n">NIG_REG_P0_RX_COS3_PRIORITY_MASK</span><span class="p">;</span>
	    <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">4</span>:
	    <span class="k">if</span> <span class="p">(</span><span class="n">port</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	    <span class="n">nig_reg_rx_priority_mask_add</span> <span class="o">=</span> <span class="n">NIG_REG_P0_RX_COS4_PRIORITY_MASK</span><span class="p">;</span>
	    <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">5</span>:
	    <span class="k">if</span> <span class="p">(</span><span class="n">port</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	    <span class="n">nig_reg_rx_priority_mask_add</span> <span class="o">=</span> <span class="n">NIG_REG_P0_RX_COS5_PRIORITY_MASK</span><span class="p">;</span>
	    <span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">nig_reg_rx_priority_mask_add</span><span class="p">,</span> <span class="n">priority_mask</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_update_mng</span><span class="p">(</span><span class="k">struct</span> <span class="n">link_params</span> <span class="o">*</span><span class="n">params</span><span class="p">,</span> <span class="n">u32</span> <span class="n">link_status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">bp</span><span class="p">;</span>

	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">shmem_base</span> <span class="o">+</span>
	       <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">shmem_region</span><span class="p">,</span>
			<span class="n">port_mb</span><span class="p">[</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">].</span><span class="n">link_status</span><span class="p">),</span> <span class="n">link_status</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_update_pfc_nig</span><span class="p">(</span><span class="k">struct</span> <span class="n">link_params</span> <span class="o">*</span><span class="n">params</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">link_vars</span> <span class="o">*</span><span class="n">vars</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">bnx2x_nig_brb_pfc_port_params</span> <span class="o">*</span><span class="n">nig_params</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">xcm_mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ppp_enable</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">pause_enable</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">llfc_out_en</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">llfc_enable</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">xcm_out_en</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">hwpfc_enable</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">pkt_priority_to_cos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">bp</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">port</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>

	<span class="kt">int</span> <span class="n">set_pfc</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">feature_config_flags</span> <span class="o">&amp;</span>
		<span class="n">FEATURE_CONFIG_PFC_ENABLED</span><span class="p">;</span>
	<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;updating pfc nig parameters</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* When NIG_LLH0_XCM_MASK_REG_LLHX_XCM_MASK_BCN bit is set</span>
<span class="cm">	 * MAC control frames (that are not pause packets)</span>
<span class="cm">	 * will be forwarded to the XCM.</span>
<span class="cm">	 */</span>
	<span class="n">xcm_mask</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">port</span> <span class="o">?</span> <span class="n">NIG_REG_LLH1_XCM_MASK</span> <span class="o">:</span>
			  <span class="n">NIG_REG_LLH0_XCM_MASK</span><span class="p">);</span>
	<span class="cm">/* NIG params will override non PFC params, since it&#39;s possible to</span>
<span class="cm">	 * do transition from PFC to SAFC</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">set_pfc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pause_enable</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">llfc_out_en</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">llfc_enable</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">CHIP_IS_E3</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span>
			<span class="n">ppp_enable</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">else</span>
		<span class="n">ppp_enable</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">xcm_mask</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">port</span> <span class="o">?</span> <span class="n">NIG_LLH1_XCM_MASK_REG_LLH1_XCM_MASK_BCN</span> <span class="o">:</span>
				     <span class="n">NIG_LLH0_XCM_MASK_REG_LLH0_XCM_MASK_BCN</span><span class="p">);</span>
		<span class="n">xcm_out_en</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">hwpfc_enable</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>  <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">nig_params</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">llfc_out_en</span> <span class="o">=</span> <span class="n">nig_params</span><span class="o">-&gt;</span><span class="n">llfc_out_en</span><span class="p">;</span>
			<span class="n">llfc_enable</span> <span class="o">=</span> <span class="n">nig_params</span><span class="o">-&gt;</span><span class="n">llfc_enable</span><span class="p">;</span>
			<span class="n">pause_enable</span> <span class="o">=</span> <span class="n">nig_params</span><span class="o">-&gt;</span><span class="n">pause_enable</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>  <span class="cm">/* Default non PFC mode - PAUSE */</span>
			<span class="n">pause_enable</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="n">xcm_mask</span> <span class="o">|=</span> <span class="p">(</span><span class="n">port</span> <span class="o">?</span> <span class="n">NIG_LLH1_XCM_MASK_REG_LLH1_XCM_MASK_BCN</span> <span class="o">:</span>
			<span class="n">NIG_LLH0_XCM_MASK_REG_LLH0_XCM_MASK_BCN</span><span class="p">);</span>
		<span class="n">xcm_out_en</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">CHIP_IS_E3</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span>
		<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">port</span> <span class="o">?</span> <span class="n">NIG_REG_BRB1_PAUSE_IN_EN</span> <span class="o">:</span>
		       <span class="n">NIG_REG_BRB0_PAUSE_IN_EN</span><span class="p">,</span> <span class="n">pause_enable</span><span class="p">);</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">port</span> <span class="o">?</span> <span class="n">NIG_REG_LLFC_OUT_EN_1</span> <span class="o">:</span>
	       <span class="n">NIG_REG_LLFC_OUT_EN_0</span><span class="p">,</span> <span class="n">llfc_out_en</span><span class="p">);</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">port</span> <span class="o">?</span> <span class="n">NIG_REG_LLFC_ENABLE_1</span> <span class="o">:</span>
	       <span class="n">NIG_REG_LLFC_ENABLE_0</span><span class="p">,</span> <span class="n">llfc_enable</span><span class="p">);</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">port</span> <span class="o">?</span> <span class="n">NIG_REG_PAUSE_ENABLE_1</span> <span class="o">:</span>
	       <span class="n">NIG_REG_PAUSE_ENABLE_0</span><span class="p">,</span> <span class="n">pause_enable</span><span class="p">);</span>

	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">port</span> <span class="o">?</span> <span class="n">NIG_REG_PPP_ENABLE_1</span> <span class="o">:</span>
	       <span class="n">NIG_REG_PPP_ENABLE_0</span><span class="p">,</span> <span class="n">ppp_enable</span><span class="p">);</span>

	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">port</span> <span class="o">?</span> <span class="n">NIG_REG_LLH1_XCM_MASK</span> <span class="o">:</span>
	       <span class="n">NIG_REG_LLH0_XCM_MASK</span><span class="p">,</span> <span class="n">xcm_mask</span><span class="p">);</span>

	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">port</span> <span class="o">?</span> <span class="n">NIG_REG_LLFC_EGRESS_SRC_ENABLE_1</span> <span class="o">:</span>
	       <span class="n">NIG_REG_LLFC_EGRESS_SRC_ENABLE_0</span><span class="p">,</span> <span class="mh">0x7</span><span class="p">);</span>

	<span class="cm">/* output enable for RX_XCM # IF */</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">port</span> <span class="o">?</span> <span class="n">NIG_REG_XCM1_OUT_EN</span> <span class="o">:</span>
	       <span class="n">NIG_REG_XCM0_OUT_EN</span><span class="p">,</span> <span class="n">xcm_out_en</span><span class="p">);</span>

	<span class="cm">/* HW PFC TX enable */</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">port</span> <span class="o">?</span> <span class="n">NIG_REG_P1_HWPFC_ENABLE</span> <span class="o">:</span>
	       <span class="n">NIG_REG_P0_HWPFC_ENABLE</span><span class="p">,</span> <span class="n">hwpfc_enable</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nig_params</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">pkt_priority_to_cos</span> <span class="o">=</span> <span class="n">nig_params</span><span class="o">-&gt;</span><span class="n">pkt_priority_to_cos</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nig_params</span><span class="o">-&gt;</span><span class="n">num_of_rx_cos_priority_mask</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">bnx2x_pfc_nig_rx_priority_mask</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span>
		<span class="n">nig_params</span><span class="o">-&gt;</span><span class="n">rx_cos_priority_mask</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">port</span><span class="p">);</span>

		<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">port</span> <span class="o">?</span> <span class="n">NIG_REG_LLFC_HIGH_PRIORITY_CLASSES_1</span> <span class="o">:</span>
		       <span class="n">NIG_REG_LLFC_HIGH_PRIORITY_CLASSES_0</span><span class="p">,</span>
		       <span class="n">nig_params</span><span class="o">-&gt;</span><span class="n">llfc_high_priority_classes</span><span class="p">);</span>

		<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">port</span> <span class="o">?</span> <span class="n">NIG_REG_LLFC_LOW_PRIORITY_CLASSES_1</span> <span class="o">:</span>
		       <span class="n">NIG_REG_LLFC_LOW_PRIORITY_CLASSES_0</span><span class="p">,</span>
		       <span class="n">nig_params</span><span class="o">-&gt;</span><span class="n">llfc_low_priority_classes</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">port</span> <span class="o">?</span> <span class="n">NIG_REG_P1_PKT_PRIORITY_TO_COS</span> <span class="o">:</span>
	       <span class="n">NIG_REG_P0_PKT_PRIORITY_TO_COS</span><span class="p">,</span>
	       <span class="n">pkt_priority_to_cos</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">bnx2x_update_pfc</span><span class="p">(</span><span class="k">struct</span> <span class="n">link_params</span> <span class="o">*</span><span class="n">params</span><span class="p">,</span>
		      <span class="k">struct</span> <span class="n">link_vars</span> <span class="o">*</span><span class="n">vars</span><span class="p">,</span>
		      <span class="k">struct</span> <span class="n">bnx2x_nig_brb_pfc_port_params</span> <span class="o">*</span><span class="n">pfc_params</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* The PFC and pause are orthogonal to one another, meaning when</span>
<span class="cm">	 * PFC is enabled, the pause are disabled, and when PFC is</span>
<span class="cm">	 * disabled, pause are set according to the pause result.</span>
<span class="cm">	 */</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">bp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bnx2x_status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">bmac_loopback</span> <span class="o">=</span> <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">loopback_mode</span> <span class="o">==</span> <span class="n">LOOPBACK_BMAC</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">feature_config_flags</span> <span class="o">&amp;</span> <span class="n">FEATURE_CONFIG_PFC_ENABLED</span><span class="p">)</span>
		<span class="n">vars</span><span class="o">-&gt;</span><span class="n">link_status</span> <span class="o">|=</span> <span class="n">LINK_STATUS_PFC_ENABLED</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">vars</span><span class="o">-&gt;</span><span class="n">link_status</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">LINK_STATUS_PFC_ENABLED</span><span class="p">;</span>

	<span class="n">bnx2x_update_mng</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">vars</span><span class="o">-&gt;</span><span class="n">link_status</span><span class="p">);</span>

	<span class="cm">/* update NIG params */</span>
	<span class="n">bnx2x_update_pfc_nig</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">vars</span><span class="p">,</span> <span class="n">pfc_params</span><span class="p">);</span>

	<span class="cm">/* update BRB params */</span>
	<span class="n">bnx2x_status</span> <span class="o">=</span> <span class="n">bnx2x_update_pfc_brb</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">vars</span><span class="p">,</span> <span class="n">pfc_params</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bnx2x_status</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">bnx2x_status</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vars</span><span class="o">-&gt;</span><span class="n">link_up</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">bnx2x_status</span><span class="p">;</span>

	<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;About to update PFC in BMAC</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">CHIP_IS_E3</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span>
		<span class="n">bnx2x_update_pfc_xmac</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">vars</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">MISC_REG_RESET_REG_2</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">val</span> <span class="o">&amp;</span>
		     <span class="p">(</span><span class="n">MISC_REGISTERS_RESET_REG_2_RST_BMAC0</span> <span class="o">&lt;&lt;</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">))</span>
		    <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;About to update PFC in EMAC</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">bnx2x_emac_enable</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">vars</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">bnx2x_status</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">CHIP_IS_E2</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span>
			<span class="n">bnx2x_update_pfc_bmac2</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">vars</span><span class="p">,</span> <span class="n">bmac_loopback</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">bnx2x_update_pfc_bmac1</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">vars</span><span class="p">);</span>

		<span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">feature_config_flags</span> <span class="o">&amp;</span>
		     <span class="n">FEATURE_CONFIG_PFC_ENABLED</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">vars</span><span class="o">-&gt;</span><span class="n">flow_ctrl</span> <span class="o">&amp;</span> <span class="n">BNX2X_FLOW_CTRL_TX</span><span class="p">))</span>
			<span class="n">val</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">NIG_REG_BMAC0_PAUSE_OUT_EN</span> <span class="o">+</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">*</span><span class="mi">4</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">bnx2x_status</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">bnx2x_bmac1_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">link_params</span> <span class="o">*</span><span class="n">params</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">link_vars</span> <span class="o">*</span><span class="n">vars</span><span class="p">,</span>
			      <span class="n">u8</span> <span class="n">is_lb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">bp</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">port</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">bmac_addr</span> <span class="o">=</span> <span class="n">port</span> <span class="o">?</span> <span class="n">NIG_REG_INGRESS_BMAC1_MEM</span> <span class="o">:</span>
			       <span class="n">NIG_REG_INGRESS_BMAC0_MEM</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">wb_data</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;Enabling BigMAC1</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* XGXS control */</span>
	<span class="n">wb_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x3c</span><span class="p">;</span>
	<span class="n">wb_data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">REG_WR_DMAE</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">bmac_addr</span> <span class="o">+</span> <span class="n">BIGMAC_REGISTER_BMAC_XGXS_CONTROL</span><span class="p">,</span>
		    <span class="n">wb_data</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>

	<span class="cm">/* tx MAC SA */</span>
	<span class="n">wb_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">mac_addr</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">|</span>
		       <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">mac_addr</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span>
		       <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">mac_addr</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span>
			<span class="n">params</span><span class="o">-&gt;</span><span class="n">mac_addr</span><span class="p">[</span><span class="mi">5</span><span class="p">]);</span>
	<span class="n">wb_data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">mac_addr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span>
			<span class="n">params</span><span class="o">-&gt;</span><span class="n">mac_addr</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
	<span class="n">REG_WR_DMAE</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">bmac_addr</span> <span class="o">+</span> <span class="n">BIGMAC_REGISTER_TX_SOURCE_ADDR</span><span class="p">,</span> <span class="n">wb_data</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>

	<span class="cm">/* mac control */</span>
	<span class="n">val</span> <span class="o">=</span> <span class="mh">0x3</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is_lb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="mh">0x4</span><span class="p">;</span>
		<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;enable bmac loopback</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">wb_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
	<span class="n">wb_data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">REG_WR_DMAE</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">bmac_addr</span> <span class="o">+</span> <span class="n">BIGMAC_REGISTER_BMAC_CONTROL</span><span class="p">,</span> <span class="n">wb_data</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>

	<span class="cm">/* set rx mtu */</span>
	<span class="n">wb_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">ETH_MAX_JUMBO_PACKET_SIZE</span> <span class="o">+</span> <span class="n">ETH_OVREHEAD</span><span class="p">;</span>
	<span class="n">wb_data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">REG_WR_DMAE</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">bmac_addr</span> <span class="o">+</span> <span class="n">BIGMAC_REGISTER_RX_MAX_SIZE</span><span class="p">,</span> <span class="n">wb_data</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>

	<span class="n">bnx2x_update_pfc_bmac1</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">vars</span><span class="p">);</span>

	<span class="cm">/* set tx mtu */</span>
	<span class="n">wb_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">ETH_MAX_JUMBO_PACKET_SIZE</span> <span class="o">+</span> <span class="n">ETH_OVREHEAD</span><span class="p">;</span>
	<span class="n">wb_data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">REG_WR_DMAE</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">bmac_addr</span> <span class="o">+</span> <span class="n">BIGMAC_REGISTER_TX_MAX_SIZE</span><span class="p">,</span> <span class="n">wb_data</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>

	<span class="cm">/* set cnt max size */</span>
	<span class="n">wb_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">ETH_MAX_JUMBO_PACKET_SIZE</span> <span class="o">+</span> <span class="n">ETH_OVREHEAD</span><span class="p">;</span>
	<span class="n">wb_data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">REG_WR_DMAE</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">bmac_addr</span> <span class="o">+</span> <span class="n">BIGMAC_REGISTER_CNT_MAX_SIZE</span><span class="p">,</span> <span class="n">wb_data</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>

	<span class="cm">/* configure safc */</span>
	<span class="n">wb_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x1000200</span><span class="p">;</span>
	<span class="n">wb_data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">REG_WR_DMAE</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">bmac_addr</span> <span class="o">+</span> <span class="n">BIGMAC_REGISTER_RX_LLFC_MSG_FLDS</span><span class="p">,</span>
		    <span class="n">wb_data</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bnx2x_bmac2_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">link_params</span> <span class="o">*</span><span class="n">params</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">link_vars</span> <span class="o">*</span><span class="n">vars</span><span class="p">,</span>
			      <span class="n">u8</span> <span class="n">is_lb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">bp</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">port</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">bmac_addr</span> <span class="o">=</span> <span class="n">port</span> <span class="o">?</span> <span class="n">NIG_REG_INGRESS_BMAC1_MEM</span> <span class="o">:</span>
			       <span class="n">NIG_REG_INGRESS_BMAC0_MEM</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">wb_data</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>

	<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;Enabling BigMAC2</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">wb_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">wb_data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">REG_WR_DMAE</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">bmac_addr</span> <span class="o">+</span> <span class="n">BIGMAC2_REGISTER_BMAC_CONTROL</span><span class="p">,</span> <span class="n">wb_data</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">30</span><span class="p">);</span>

	<span class="cm">/* XGXS control: Reset phy HW, MDIO registers, PHY PLL and BMAC */</span>
	<span class="n">wb_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x3c</span><span class="p">;</span>
	<span class="n">wb_data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">REG_WR_DMAE</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">bmac_addr</span> <span class="o">+</span> <span class="n">BIGMAC2_REGISTER_BMAC_XGXS_CONTROL</span><span class="p">,</span>
		    <span class="n">wb_data</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>

	<span class="n">udelay</span><span class="p">(</span><span class="mi">30</span><span class="p">);</span>

	<span class="cm">/* tx MAC SA */</span>
	<span class="n">wb_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">mac_addr</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">|</span>
		       <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">mac_addr</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span>
		       <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">mac_addr</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span>
			<span class="n">params</span><span class="o">-&gt;</span><span class="n">mac_addr</span><span class="p">[</span><span class="mi">5</span><span class="p">]);</span>
	<span class="n">wb_data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">mac_addr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span>
			<span class="n">params</span><span class="o">-&gt;</span><span class="n">mac_addr</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
	<span class="n">REG_WR_DMAE</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">bmac_addr</span> <span class="o">+</span> <span class="n">BIGMAC2_REGISTER_TX_SOURCE_ADDR</span><span class="p">,</span>
		    <span class="n">wb_data</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>

	<span class="n">udelay</span><span class="p">(</span><span class="mi">30</span><span class="p">);</span>

	<span class="cm">/* Configure SAFC */</span>
	<span class="n">wb_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x1000200</span><span class="p">;</span>
	<span class="n">wb_data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">REG_WR_DMAE</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">bmac_addr</span> <span class="o">+</span> <span class="n">BIGMAC2_REGISTER_RX_LLFC_MSG_FLDS</span><span class="p">,</span>
		    <span class="n">wb_data</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">30</span><span class="p">);</span>

	<span class="cm">/* set rx mtu */</span>
	<span class="n">wb_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">ETH_MAX_JUMBO_PACKET_SIZE</span> <span class="o">+</span> <span class="n">ETH_OVREHEAD</span><span class="p">;</span>
	<span class="n">wb_data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">REG_WR_DMAE</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">bmac_addr</span> <span class="o">+</span> <span class="n">BIGMAC2_REGISTER_RX_MAX_SIZE</span><span class="p">,</span> <span class="n">wb_data</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">30</span><span class="p">);</span>

	<span class="cm">/* set tx mtu */</span>
	<span class="n">wb_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">ETH_MAX_JUMBO_PACKET_SIZE</span> <span class="o">+</span> <span class="n">ETH_OVREHEAD</span><span class="p">;</span>
	<span class="n">wb_data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">REG_WR_DMAE</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">bmac_addr</span> <span class="o">+</span> <span class="n">BIGMAC2_REGISTER_TX_MAX_SIZE</span><span class="p">,</span> <span class="n">wb_data</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">30</span><span class="p">);</span>
	<span class="cm">/* set cnt max size */</span>
	<span class="n">wb_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">ETH_MAX_JUMBO_PACKET_SIZE</span> <span class="o">+</span> <span class="n">ETH_OVREHEAD</span> <span class="o">-</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">wb_data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">REG_WR_DMAE</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">bmac_addr</span> <span class="o">+</span> <span class="n">BIGMAC2_REGISTER_CNT_MAX_SIZE</span><span class="p">,</span> <span class="n">wb_data</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">30</span><span class="p">);</span>
	<span class="n">bnx2x_update_pfc_bmac2</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">vars</span><span class="p">,</span> <span class="n">is_lb</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bnx2x_bmac_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">link_params</span> <span class="o">*</span><span class="n">params</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">link_vars</span> <span class="o">*</span><span class="n">vars</span><span class="p">,</span>
			     <span class="n">u8</span> <span class="n">is_lb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">port</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">bp</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>
	<span class="cm">/* reset and unreset the BigMac */</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">GRCBASE_MISC</span> <span class="o">+</span> <span class="n">MISC_REGISTERS_RESET_REG_2_CLEAR</span><span class="p">,</span>
	       <span class="p">(</span><span class="n">MISC_REGISTERS_RESET_REG_2_RST_BMAC0</span> <span class="o">&lt;&lt;</span> <span class="n">port</span><span class="p">));</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">GRCBASE_MISC</span> <span class="o">+</span> <span class="n">MISC_REGISTERS_RESET_REG_2_SET</span><span class="p">,</span>
	       <span class="p">(</span><span class="n">MISC_REGISTERS_RESET_REG_2_RST_BMAC0</span> <span class="o">&lt;&lt;</span> <span class="n">port</span><span class="p">));</span>

	<span class="cm">/* enable access for bmac registers */</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">NIG_REG_BMAC0_REGS_OUT_EN</span> <span class="o">+</span> <span class="n">port</span><span class="o">*</span><span class="mi">4</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">);</span>

	<span class="cm">/* Enable BMAC according to BMAC type*/</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">CHIP_IS_E2</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">bnx2x_bmac2_enable</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">vars</span><span class="p">,</span> <span class="n">is_lb</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">bnx2x_bmac1_enable</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">vars</span><span class="p">,</span> <span class="n">is_lb</span><span class="p">);</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">NIG_REG_XGXS_SERDES0_MODE_SEL</span> <span class="o">+</span> <span class="n">port</span><span class="o">*</span><span class="mi">4</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">);</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">NIG_REG_XGXS_LANE_SEL_P0</span> <span class="o">+</span> <span class="n">port</span><span class="o">*</span><span class="mi">4</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">NIG_REG_EGRESS_EMAC0_PORT</span> <span class="o">+</span> <span class="n">port</span><span class="o">*</span><span class="mi">4</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">feature_config_flags</span> <span class="o">&amp;</span>
	      <span class="n">FEATURE_CONFIG_PFC_ENABLED</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">vars</span><span class="o">-&gt;</span><span class="n">flow_ctrl</span> <span class="o">&amp;</span> <span class="n">BNX2X_FLOW_CTRL_TX</span><span class="p">))</span>
		<span class="n">val</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">NIG_REG_BMAC0_PAUSE_OUT_EN</span> <span class="o">+</span> <span class="n">port</span><span class="o">*</span><span class="mi">4</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">NIG_REG_EGRESS_EMAC0_OUT_EN</span> <span class="o">+</span> <span class="n">port</span><span class="o">*</span><span class="mi">4</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">NIG_REG_EMAC0_IN_EN</span> <span class="o">+</span> <span class="n">port</span><span class="o">*</span><span class="mi">4</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">NIG_REG_EMAC0_PAUSE_OUT_EN</span> <span class="o">+</span> <span class="n">port</span><span class="o">*</span><span class="mi">4</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">NIG_REG_BMAC0_IN_EN</span> <span class="o">+</span> <span class="n">port</span><span class="o">*</span><span class="mi">4</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">);</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">NIG_REG_BMAC0_OUT_EN</span> <span class="o">+</span> <span class="n">port</span><span class="o">*</span><span class="mi">4</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">);</span>

	<span class="n">vars</span><span class="o">-&gt;</span><span class="n">mac_type</span> <span class="o">=</span> <span class="n">MAC_TYPE_BMAC</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_bmac_rx_disable</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">,</span> <span class="n">u8</span> <span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">bmac_addr</span> <span class="o">=</span> <span class="n">port</span> <span class="o">?</span> <span class="n">NIG_REG_INGRESS_BMAC1_MEM</span> <span class="o">:</span>
			<span class="n">NIG_REG_INGRESS_BMAC0_MEM</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">wb_data</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="n">u32</span> <span class="n">nig_bmac_enable</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">NIG_REG_BMAC0_REGS_OUT_EN</span> <span class="o">+</span> <span class="n">port</span><span class="o">*</span><span class="mi">4</span><span class="p">);</span>

	<span class="cm">/* Only if the bmac is out of reset */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">MISC_REG_RESET_REG_2</span><span class="p">)</span> <span class="o">&amp;</span>
			<span class="p">(</span><span class="n">MISC_REGISTERS_RESET_REG_2_RST_BMAC0</span> <span class="o">&lt;&lt;</span> <span class="n">port</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">nig_bmac_enable</span><span class="p">)</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">CHIP_IS_E2</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* Clear Rx Enable bit in BMAC_CONTROL register */</span>
			<span class="n">REG_RD_DMAE</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">bmac_addr</span> <span class="o">+</span>
				    <span class="n">BIGMAC2_REGISTER_BMAC_CONTROL</span><span class="p">,</span>
				    <span class="n">wb_data</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
			<span class="n">wb_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">BMAC_CONTROL_RX_ENABLE</span><span class="p">;</span>
			<span class="n">REG_WR_DMAE</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">bmac_addr</span> <span class="o">+</span>
				    <span class="n">BIGMAC2_REGISTER_BMAC_CONTROL</span><span class="p">,</span>
				    <span class="n">wb_data</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* Clear Rx Enable bit in BMAC_CONTROL register */</span>
			<span class="n">REG_RD_DMAE</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">bmac_addr</span> <span class="o">+</span>
					<span class="n">BIGMAC_REGISTER_BMAC_CONTROL</span><span class="p">,</span>
					<span class="n">wb_data</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
			<span class="n">wb_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">BMAC_CONTROL_RX_ENABLE</span><span class="p">;</span>
			<span class="n">REG_WR_DMAE</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">bmac_addr</span> <span class="o">+</span>
					<span class="n">BIGMAC_REGISTER_BMAC_CONTROL</span><span class="p">,</span>
					<span class="n">wb_data</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bnx2x_pbf_update</span><span class="p">(</span><span class="k">struct</span> <span class="n">link_params</span> <span class="o">*</span><span class="n">params</span><span class="p">,</span> <span class="n">u32</span> <span class="n">flow_ctrl</span><span class="p">,</span>
			    <span class="n">u32</span> <span class="n">line_speed</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">bp</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">port</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">init_crd</span><span class="p">,</span> <span class="n">crd</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">;</span>

	<span class="cm">/* disable port */</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">PBF_REG_DISABLE_NEW_TASK_PROC_P0</span> <span class="o">+</span> <span class="n">port</span><span class="o">*</span><span class="mi">4</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">);</span>

	<span class="cm">/* wait for init credit */</span>
	<span class="n">init_crd</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">PBF_REG_P0_INIT_CRD</span> <span class="o">+</span> <span class="n">port</span><span class="o">*</span><span class="mi">4</span><span class="p">);</span>
	<span class="n">crd</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">PBF_REG_P0_CREDIT</span> <span class="o">+</span> <span class="n">port</span><span class="o">*</span><span class="mi">8</span><span class="p">);</span>
	<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;init_crd 0x%x  crd 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">init_crd</span><span class="p">,</span> <span class="n">crd</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">((</span><span class="n">init_crd</span> <span class="o">!=</span> <span class="n">crd</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">count</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>

		<span class="n">crd</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">PBF_REG_P0_CREDIT</span> <span class="o">+</span> <span class="n">port</span><span class="o">*</span><span class="mi">8</span><span class="p">);</span>
		<span class="n">count</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">crd</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">PBF_REG_P0_CREDIT</span> <span class="o">+</span> <span class="n">port</span><span class="o">*</span><span class="mi">8</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">init_crd</span> <span class="o">!=</span> <span class="n">crd</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;BUG! init_crd 0x%x != crd 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">init_crd</span><span class="p">,</span> <span class="n">crd</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">flow_ctrl</span> <span class="o">&amp;</span> <span class="n">BNX2X_FLOW_CTRL_RX</span> <span class="o">||</span>
	    <span class="n">line_speed</span> <span class="o">==</span> <span class="n">SPEED_10</span> <span class="o">||</span>
	    <span class="n">line_speed</span> <span class="o">==</span> <span class="n">SPEED_100</span> <span class="o">||</span>
	    <span class="n">line_speed</span> <span class="o">==</span> <span class="n">SPEED_1000</span> <span class="o">||</span>
	    <span class="n">line_speed</span> <span class="o">==</span> <span class="n">SPEED_2500</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">PBF_REG_P0_PAUSE_ENABLE</span> <span class="o">+</span> <span class="n">port</span><span class="o">*</span><span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="cm">/* update threshold */</span>
		<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">PBF_REG_P0_ARB_THRSH</span> <span class="o">+</span> <span class="n">port</span><span class="o">*</span><span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="cm">/* update init credit */</span>
		<span class="n">init_crd</span> <span class="o">=</span> <span class="mi">778</span><span class="p">;</span>		<span class="cm">/* (800-18-4) */</span>

	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">thresh</span> <span class="o">=</span> <span class="p">(</span><span class="n">ETH_MAX_JUMBO_PACKET_SIZE</span> <span class="o">+</span>
			      <span class="n">ETH_OVREHEAD</span><span class="p">)</span><span class="o">/</span><span class="mi">16</span><span class="p">;</span>
		<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">PBF_REG_P0_PAUSE_ENABLE</span> <span class="o">+</span> <span class="n">port</span><span class="o">*</span><span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="cm">/* update threshold */</span>
		<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">PBF_REG_P0_ARB_THRSH</span> <span class="o">+</span> <span class="n">port</span><span class="o">*</span><span class="mi">4</span><span class="p">,</span> <span class="n">thresh</span><span class="p">);</span>
		<span class="cm">/* update init credit */</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">line_speed</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">SPEED_10000</span>:
			<span class="n">init_crd</span> <span class="o">=</span> <span class="n">thresh</span> <span class="o">+</span> <span class="mi">553</span> <span class="o">-</span> <span class="mi">22</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;Invalid line_speed 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				  <span class="n">line_speed</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">PBF_REG_P0_INIT_CRD</span> <span class="o">+</span> <span class="n">port</span><span class="o">*</span><span class="mi">4</span><span class="p">,</span> <span class="n">init_crd</span><span class="p">);</span>
	<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;PBF updated to speed %d credit %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">line_speed</span><span class="p">,</span> <span class="n">init_crd</span><span class="p">);</span>

	<span class="cm">/* probe the credit changes */</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">PBF_REG_INIT_P0</span> <span class="o">+</span> <span class="n">port</span><span class="o">*</span><span class="mi">4</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">);</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">PBF_REG_INIT_P0</span> <span class="o">+</span> <span class="n">port</span><span class="o">*</span><span class="mi">4</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>

	<span class="cm">/* enable port */</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">PBF_REG_DISABLE_NEW_TASK_PROC_P0</span> <span class="o">+</span> <span class="n">port</span><span class="o">*</span><span class="mi">4</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * bnx2x_get_emac_base - retrive emac base address</span>
<span class="cm"> *</span>
<span class="cm"> * @bp:			driver handle</span>
<span class="cm"> * @mdc_mdio_access:	access type</span>
<span class="cm"> * @port:		port id</span>
<span class="cm"> *</span>
<span class="cm"> * This function selects the MDC/MDIO access (through emac0 or</span>
<span class="cm"> * emac1) depend on the mdc_mdio_access, port, port swapped. Each</span>
<span class="cm"> * phy has a default access mode, which could also be overridden</span>
<span class="cm"> * by nvram configuration. This parameter, whether this is the</span>
<span class="cm"> * default phy configuration, or the nvram overrun</span>
<span class="cm"> * configuration, is passed here as mdc_mdio_access and selects</span>
<span class="cm"> * the emac_base for the CL45 read/writes operations</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">u32</span> <span class="nf">bnx2x_get_emac_base</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">,</span>
			       <span class="n">u32</span> <span class="n">mdc_mdio_access</span><span class="p">,</span> <span class="n">u8</span> <span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">emac_base</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">mdc_mdio_access</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SHARED_HW_CFG_MDC_MDIO_ACCESS1_PHY_TYPE</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SHARED_HW_CFG_MDC_MDIO_ACCESS1_EMAC0</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">NIG_REG_PORT_SWAP</span><span class="p">))</span>
			<span class="n">emac_base</span> <span class="o">=</span> <span class="n">GRCBASE_EMAC1</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">emac_base</span> <span class="o">=</span> <span class="n">GRCBASE_EMAC0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SHARED_HW_CFG_MDC_MDIO_ACCESS1_EMAC1</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">NIG_REG_PORT_SWAP</span><span class="p">))</span>
			<span class="n">emac_base</span> <span class="o">=</span> <span class="n">GRCBASE_EMAC0</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">emac_base</span> <span class="o">=</span> <span class="n">GRCBASE_EMAC1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SHARED_HW_CFG_MDC_MDIO_ACCESS1_BOTH</span>:
		<span class="n">emac_base</span> <span class="o">=</span> <span class="p">(</span><span class="n">port</span><span class="p">)</span> <span class="o">?</span> <span class="n">GRCBASE_EMAC1</span> <span class="o">:</span> <span class="n">GRCBASE_EMAC0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SHARED_HW_CFG_MDC_MDIO_ACCESS1_SWAPPED</span>:
		<span class="n">emac_base</span> <span class="o">=</span> <span class="p">(</span><span class="n">port</span><span class="p">)</span> <span class="o">?</span> <span class="n">GRCBASE_EMAC0</span> <span class="o">:</span> <span class="n">GRCBASE_EMAC1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">emac_base</span><span class="p">;</span>

<span class="p">}</span>

<span class="cm">/******************************************************************/</span>
<span class="cm">/*			CL22 access functions			  */</span>
<span class="cm">/******************************************************************/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">bnx2x_cl22_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">bnx2x_phy</span> <span class="o">*</span><span class="n">phy</span><span class="p">,</span>
				       <span class="n">u16</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u16</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">mode</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="cm">/* Switch to CL22 */</span>
	<span class="n">mode</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">mdio_ctrl</span> <span class="o">+</span> <span class="n">EMAC_REG_EMAC_MDIO_MODE</span><span class="p">);</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">mdio_ctrl</span> <span class="o">+</span> <span class="n">EMAC_REG_EMAC_MDIO_MODE</span><span class="p">,</span>
	       <span class="n">mode</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">EMAC_MDIO_MODE_CLAUSE_45</span><span class="p">);</span>

	<span class="cm">/* address */</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="p">((</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">&lt;&lt;</span> <span class="mi">21</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="n">val</span> <span class="o">|</span>
	       <span class="n">EMAC_MDIO_COMM_COMMAND_WRITE_22</span> <span class="o">|</span>
	       <span class="n">EMAC_MDIO_COMM_START_BUSY</span><span class="p">);</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">mdio_ctrl</span> <span class="o">+</span> <span class="n">EMAC_REG_EMAC_MDIO_COMM</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">50</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>

		<span class="n">tmp</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">mdio_ctrl</span> <span class="o">+</span> <span class="n">EMAC_REG_EMAC_MDIO_COMM</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">EMAC_MDIO_COMM_START_BUSY</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">EMAC_MDIO_COMM_START_BUSY</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;write phy register failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">mdio_ctrl</span> <span class="o">+</span> <span class="n">EMAC_REG_EMAC_MDIO_MODE</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bnx2x_cl22_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">bnx2x_phy</span> <span class="o">*</span><span class="n">phy</span><span class="p">,</span>
				      <span class="n">u16</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u16</span> <span class="o">*</span><span class="n">ret_val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">,</span> <span class="n">mode</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Switch to CL22 */</span>
	<span class="n">mode</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">mdio_ctrl</span> <span class="o">+</span> <span class="n">EMAC_REG_EMAC_MDIO_MODE</span><span class="p">);</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">mdio_ctrl</span> <span class="o">+</span> <span class="n">EMAC_REG_EMAC_MDIO_MODE</span><span class="p">,</span>
	       <span class="n">mode</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">EMAC_MDIO_MODE_CLAUSE_45</span><span class="p">);</span>

	<span class="cm">/* address */</span>
	<span class="n">val</span> <span class="o">=</span> <span class="p">((</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">&lt;&lt;</span> <span class="mi">21</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span>
	       <span class="n">EMAC_MDIO_COMM_COMMAND_READ_22</span> <span class="o">|</span>
	       <span class="n">EMAC_MDIO_COMM_START_BUSY</span><span class="p">);</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">mdio_ctrl</span> <span class="o">+</span> <span class="n">EMAC_REG_EMAC_MDIO_COMM</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">50</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>

		<span class="n">val</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">mdio_ctrl</span> <span class="o">+</span> <span class="n">EMAC_REG_EMAC_MDIO_COMM</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">EMAC_MDIO_COMM_START_BUSY</span><span class="p">))</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">ret_val</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">EMAC_MDIO_COMM_DATA</span><span class="p">);</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">EMAC_MDIO_COMM_START_BUSY</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;read phy register failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="o">*</span><span class="n">ret_val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">mdio_ctrl</span> <span class="o">+</span> <span class="n">EMAC_REG_EMAC_MDIO_MODE</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/******************************************************************/</span>
<span class="cm">/*			CL45 access functions			  */</span>
<span class="cm">/******************************************************************/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">bnx2x_cl45_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bnx2x_phy</span> <span class="o">*</span><span class="n">phy</span><span class="p">,</span>
			   <span class="n">u8</span> <span class="n">devad</span><span class="p">,</span> <span class="n">u16</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u16</span> <span class="o">*</span><span class="n">ret_val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">FLAGS_MDC_MDIO_WA_B0</span><span class="p">)</span>
		<span class="n">bnx2x_bits_en</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">mdio_ctrl</span> <span class="o">+</span> <span class="n">EMAC_REG_EMAC_MDIO_STATUS</span><span class="p">,</span>
			      <span class="n">EMAC_MDIO_STATUS_10MB</span><span class="p">);</span>
	<span class="cm">/* address */</span>
	<span class="n">val</span> <span class="o">=</span> <span class="p">((</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">&lt;&lt;</span> <span class="mi">21</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">devad</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="n">reg</span> <span class="o">|</span>
	       <span class="n">EMAC_MDIO_COMM_COMMAND_ADDRESS</span> <span class="o">|</span>
	       <span class="n">EMAC_MDIO_COMM_START_BUSY</span><span class="p">);</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">mdio_ctrl</span> <span class="o">+</span> <span class="n">EMAC_REG_EMAC_MDIO_COMM</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">50</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>

		<span class="n">val</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">mdio_ctrl</span> <span class="o">+</span> <span class="n">EMAC_REG_EMAC_MDIO_COMM</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">EMAC_MDIO_COMM_START_BUSY</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">EMAC_MDIO_COMM_START_BUSY</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;read phy register failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">netdev_err</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>  <span class="s">&quot;MDC/MDIO access timeout</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="o">*</span><span class="n">ret_val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* data */</span>
		<span class="n">val</span> <span class="o">=</span> <span class="p">((</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">&lt;&lt;</span> <span class="mi">21</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">devad</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span>
		       <span class="n">EMAC_MDIO_COMM_COMMAND_READ_45</span> <span class="o">|</span>
		       <span class="n">EMAC_MDIO_COMM_START_BUSY</span><span class="p">);</span>
		<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">mdio_ctrl</span> <span class="o">+</span> <span class="n">EMAC_REG_EMAC_MDIO_COMM</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">50</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>

			<span class="n">val</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">mdio_ctrl</span> <span class="o">+</span>
				     <span class="n">EMAC_REG_EMAC_MDIO_COMM</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">EMAC_MDIO_COMM_START_BUSY</span><span class="p">))</span> <span class="p">{</span>
				<span class="o">*</span><span class="n">ret_val</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">EMAC_MDIO_COMM_DATA</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">EMAC_MDIO_COMM_START_BUSY</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;read phy register failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">netdev_err</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>  <span class="s">&quot;MDC/MDIO access timeout</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="o">*</span><span class="n">ret_val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="cm">/* Work around for E3 A0 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">FLAGS_MDC_MDIO_WA</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">phy</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">^=</span> <span class="n">FLAGS_DUMMY_READ</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">FLAGS_DUMMY_READ</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u16</span> <span class="n">temp_val</span><span class="p">;</span>
			<span class="n">bnx2x_cl45_read</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">devad</span><span class="p">,</span> <span class="mh">0xf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">temp_val</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">FLAGS_MDC_MDIO_WA_B0</span><span class="p">)</span>
		<span class="n">bnx2x_bits_dis</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">mdio_ctrl</span> <span class="o">+</span> <span class="n">EMAC_REG_EMAC_MDIO_STATUS</span><span class="p">,</span>
			       <span class="n">EMAC_MDIO_STATUS_10MB</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bnx2x_cl45_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bnx2x_phy</span> <span class="o">*</span><span class="n">phy</span><span class="p">,</span>
			    <span class="n">u8</span> <span class="n">devad</span><span class="p">,</span> <span class="n">u16</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u16</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">FLAGS_MDC_MDIO_WA_B0</span><span class="p">)</span>
		<span class="n">bnx2x_bits_en</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">mdio_ctrl</span> <span class="o">+</span> <span class="n">EMAC_REG_EMAC_MDIO_STATUS</span><span class="p">,</span>
			      <span class="n">EMAC_MDIO_STATUS_10MB</span><span class="p">);</span>

	<span class="cm">/* address */</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="p">((</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">&lt;&lt;</span> <span class="mi">21</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">devad</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="n">reg</span> <span class="o">|</span>
	       <span class="n">EMAC_MDIO_COMM_COMMAND_ADDRESS</span> <span class="o">|</span>
	       <span class="n">EMAC_MDIO_COMM_START_BUSY</span><span class="p">);</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">mdio_ctrl</span> <span class="o">+</span> <span class="n">EMAC_REG_EMAC_MDIO_COMM</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">50</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>

		<span class="n">tmp</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">mdio_ctrl</span> <span class="o">+</span> <span class="n">EMAC_REG_EMAC_MDIO_COMM</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">EMAC_MDIO_COMM_START_BUSY</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">EMAC_MDIO_COMM_START_BUSY</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;write phy register failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">netdev_err</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>  <span class="s">&quot;MDC/MDIO access timeout</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* data */</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="p">((</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">&lt;&lt;</span> <span class="mi">21</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">devad</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="n">val</span> <span class="o">|</span>
		       <span class="n">EMAC_MDIO_COMM_COMMAND_WRITE_45</span> <span class="o">|</span>
		       <span class="n">EMAC_MDIO_COMM_START_BUSY</span><span class="p">);</span>
		<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">mdio_ctrl</span> <span class="o">+</span> <span class="n">EMAC_REG_EMAC_MDIO_COMM</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">50</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>

			<span class="n">tmp</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">mdio_ctrl</span> <span class="o">+</span>
				     <span class="n">EMAC_REG_EMAC_MDIO_COMM</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">EMAC_MDIO_COMM_START_BUSY</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">udelay</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">EMAC_MDIO_COMM_START_BUSY</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;write phy register failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">netdev_err</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>  <span class="s">&quot;MDC/MDIO access timeout</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="cm">/* Work around for E3 A0 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">FLAGS_MDC_MDIO_WA</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">phy</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">^=</span> <span class="n">FLAGS_DUMMY_READ</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">FLAGS_DUMMY_READ</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u16</span> <span class="n">temp_val</span><span class="p">;</span>
			<span class="n">bnx2x_cl45_read</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">devad</span><span class="p">,</span> <span class="mh">0xf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">temp_val</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">FLAGS_MDC_MDIO_WA_B0</span><span class="p">)</span>
		<span class="n">bnx2x_bits_dis</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">mdio_ctrl</span> <span class="o">+</span> <span class="n">EMAC_REG_EMAC_MDIO_STATUS</span><span class="p">,</span>
			       <span class="n">EMAC_MDIO_STATUS_10MB</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>
<span class="cm">/******************************************************************/</span>
<span class="cm">/*			BSC access functions from E3	          */</span>
<span class="cm">/******************************************************************/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_bsc_module_sel</span><span class="p">(</span><span class="k">struct</span> <span class="n">link_params</span> <span class="o">*</span><span class="n">params</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">idx</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">board_cfg</span><span class="p">,</span> <span class="n">sfp_ctrl</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">i2c_pins</span><span class="p">[</span><span class="n">I2C_SWITCH_WIDTH</span><span class="p">],</span> <span class="n">i2c_val</span><span class="p">[</span><span class="n">I2C_SWITCH_WIDTH</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">bp</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">port</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>
	<span class="cm">/* Read I2C output PINs */</span>
	<span class="n">board_cfg</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">shmem_base</span> <span class="o">+</span>
			   <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">shmem_region</span><span class="p">,</span>
				    <span class="n">dev_info</span><span class="p">.</span><span class="n">shared_hw_config</span><span class="p">.</span><span class="n">board</span><span class="p">));</span>
	<span class="n">i2c_pins</span><span class="p">[</span><span class="n">I2C_BSC0</span><span class="p">]</span> <span class="o">=</span> <span class="n">board_cfg</span> <span class="o">&amp;</span> <span class="n">SHARED_HW_CFG_E3_I2C_MUX0_MASK</span><span class="p">;</span>
	<span class="n">i2c_pins</span><span class="p">[</span><span class="n">I2C_BSC1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">board_cfg</span> <span class="o">&amp;</span> <span class="n">SHARED_HW_CFG_E3_I2C_MUX1_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span>
			<span class="n">SHARED_HW_CFG_E3_I2C_MUX1_SHIFT</span><span class="p">;</span>

	<span class="cm">/* Read I2C output value */</span>
	<span class="n">sfp_ctrl</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">shmem_base</span> <span class="o">+</span>
			  <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">shmem_region</span><span class="p">,</span>
				 <span class="n">dev_info</span><span class="p">.</span><span class="n">port_hw_config</span><span class="p">[</span><span class="n">port</span><span class="p">].</span><span class="n">e3_cmn_pin_cfg</span><span class="p">));</span>
	<span class="n">i2c_val</span><span class="p">[</span><span class="n">I2C_BSC0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">sfp_ctrl</span> <span class="o">&amp;</span> <span class="n">PORT_HW_CFG_E3_I2C_MUX0_MASK</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">i2c_val</span><span class="p">[</span><span class="n">I2C_BSC1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">sfp_ctrl</span> <span class="o">&amp;</span> <span class="n">PORT_HW_CFG_E3_I2C_MUX1_MASK</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;Setting BSC switch</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">I2C_SWITCH_WIDTH</span><span class="p">;</span> <span class="n">idx</span><span class="o">++</span><span class="p">)</span>
		<span class="n">bnx2x_set_cfg_pin</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">i2c_pins</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">i2c_val</span><span class="p">[</span><span class="n">idx</span><span class="p">]);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bnx2x_bsc_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">link_params</span> <span class="o">*</span><span class="n">params</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">bnx2x_phy</span> <span class="o">*</span><span class="n">phy</span><span class="p">,</span>
			  <span class="n">u8</span> <span class="n">sl_devid</span><span class="p">,</span>
			  <span class="n">u16</span> <span class="n">sl_addr</span><span class="p">,</span>
			  <span class="n">u8</span> <span class="n">lc_addr</span><span class="p">,</span>
			  <span class="n">u8</span> <span class="n">xfer_cnt</span><span class="p">,</span>
			  <span class="n">u32</span> <span class="o">*</span><span class="n">data_array</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">bp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">sl_devid</span> <span class="o">!=</span> <span class="mh">0xa0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">sl_devid</span> <span class="o">!=</span> <span class="mh">0xa2</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;invalid sl_devid 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sl_devid</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">xfer_cnt</span> <span class="o">&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;invalid xfer_cnt %d. Max is 16 bytes</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">xfer_cnt</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">bnx2x_bsc_module_sel</span><span class="p">(</span><span class="n">params</span><span class="p">);</span>

	<span class="n">xfer_cnt</span> <span class="o">=</span> <span class="mi">16</span> <span class="o">-</span> <span class="n">lc_addr</span><span class="p">;</span>

	<span class="cm">/* enable the engine */</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">MCP_REG_MCPR_IMC_COMMAND</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">|=</span> <span class="n">MCPR_IMC_COMMAND_ENABLE</span><span class="p">;</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">MCP_REG_MCPR_IMC_COMMAND</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

	<span class="cm">/* program slave device ID */</span>
	<span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">sl_devid</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="n">sl_addr</span><span class="p">;</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">MCP_REG_MCPR_IMC_SLAVE_CONTROL</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

	<span class="cm">/* start xfer with 0 byte to update the address pointer ???*/</span>
	<span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">MCPR_IMC_COMMAND_ENABLE</span><span class="p">)</span> <span class="o">|</span>
	      <span class="p">(</span><span class="n">MCPR_IMC_COMMAND_WRITE_OP</span> <span class="o">&lt;&lt;</span>
		<span class="n">MCPR_IMC_COMMAND_OPERATION_BITSHIFT</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">(</span><span class="n">lc_addr</span> <span class="o">&lt;&lt;</span> <span class="n">MCPR_IMC_COMMAND_TRANSFER_ADDRESS_BITSHIFT</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">MCP_REG_MCPR_IMC_COMMAND</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

	<span class="cm">/* poll for completion */</span>
	<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">MCP_REG_MCPR_IMC_COMMAND</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(((</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="n">MCPR_IMC_COMMAND_IMC_STATUS_BITSHIFT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">MCP_REG_MCPR_IMC_COMMAND</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="o">++</span> <span class="o">&gt;</span> <span class="mi">1000</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;wr 0 byte timed out after %d try</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
								<span class="n">i</span><span class="p">);</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="cm">/* start xfer with read op */</span>
	<span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">MCPR_IMC_COMMAND_ENABLE</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">(</span><span class="n">MCPR_IMC_COMMAND_READ_OP</span> <span class="o">&lt;&lt;</span>
		<span class="n">MCPR_IMC_COMMAND_OPERATION_BITSHIFT</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">(</span><span class="n">lc_addr</span> <span class="o">&lt;&lt;</span> <span class="n">MCPR_IMC_COMMAND_TRANSFER_ADDRESS_BITSHIFT</span><span class="p">)</span> <span class="o">|</span>
		  <span class="p">(</span><span class="n">xfer_cnt</span><span class="p">);</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">MCP_REG_MCPR_IMC_COMMAND</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

	<span class="cm">/* poll for completion */</span>
	<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">MCP_REG_MCPR_IMC_COMMAND</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(((</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="n">MCPR_IMC_COMMAND_IMC_STATUS_BITSHIFT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">MCP_REG_MCPR_IMC_COMMAND</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="o">++</span> <span class="o">&gt;</span> <span class="mi">1000</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;rd op timed out after %d try</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="p">(</span><span class="n">lc_addr</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">);</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">data_array</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="p">(</span><span class="n">MCP_REG_MCPR_IMC_DATAREG0</span> <span class="o">+</span> <span class="n">i</span><span class="o">*</span><span class="mi">4</span><span class="p">));</span>
<span class="cp">#ifdef __BIG_ENDIAN</span>
		<span class="n">data_array</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">data_array</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x000000ff</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">|</span>
				<span class="p">((</span><span class="n">data_array</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x0000ff00</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span>
				<span class="p">((</span><span class="n">data_array</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x00ff0000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span>
				<span class="p">((</span><span class="n">data_array</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xff000000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_cl45_read_or_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bnx2x_phy</span> <span class="o">*</span><span class="n">phy</span><span class="p">,</span>
				     <span class="n">u8</span> <span class="n">devad</span><span class="p">,</span> <span class="n">u16</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u16</span> <span class="n">or_val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">val</span><span class="p">;</span>
	<span class="n">bnx2x_cl45_read</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">devad</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
	<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">devad</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">val</span> <span class="o">|</span> <span class="n">or_val</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">bnx2x_phy_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">link_params</span> <span class="o">*</span><span class="n">params</span><span class="p">,</span> <span class="n">u8</span> <span class="n">phy_addr</span><span class="p">,</span>
		   <span class="n">u8</span> <span class="n">devad</span><span class="p">,</span> <span class="n">u16</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u16</span> <span class="o">*</span><span class="n">ret_val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">phy_index</span><span class="p">;</span>
	<span class="cm">/* Probe for the phy according to the given phy_addr, and execute</span>
<span class="cm">	 * the read request on it</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">phy_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">phy_index</span> <span class="o">&lt;</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">num_phys</span><span class="p">;</span> <span class="n">phy_index</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">[</span><span class="n">phy_index</span><span class="p">].</span><span class="n">addr</span> <span class="o">==</span> <span class="n">phy_addr</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">return</span> <span class="n">bnx2x_cl45_read</span><span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">bp</span><span class="p">,</span>
					       <span class="o">&amp;</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">[</span><span class="n">phy_index</span><span class="p">],</span> <span class="n">devad</span><span class="p">,</span>
					       <span class="n">reg</span><span class="p">,</span> <span class="n">ret_val</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">bnx2x_phy_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">link_params</span> <span class="o">*</span><span class="n">params</span><span class="p">,</span> <span class="n">u8</span> <span class="n">phy_addr</span><span class="p">,</span>
		    <span class="n">u8</span> <span class="n">devad</span><span class="p">,</span> <span class="n">u16</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u16</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">phy_index</span><span class="p">;</span>
	<span class="cm">/* Probe for the phy according to the given phy_addr, and execute</span>
<span class="cm">	 * the write request on it</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">phy_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">phy_index</span> <span class="o">&lt;</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">num_phys</span><span class="p">;</span> <span class="n">phy_index</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">[</span><span class="n">phy_index</span><span class="p">].</span><span class="n">addr</span> <span class="o">==</span> <span class="n">phy_addr</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">return</span> <span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">bp</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">[</span><span class="n">phy_index</span><span class="p">],</span> <span class="n">devad</span><span class="p">,</span>
						<span class="n">reg</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">static</span> <span class="n">u8</span> <span class="nf">bnx2x_get_warpcore_lane</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x_phy</span> <span class="o">*</span><span class="n">phy</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">link_params</span> <span class="o">*</span><span class="n">params</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">lane</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">bp</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">path_swap</span><span class="p">,</span> <span class="n">path_swap_ovr</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">path</span><span class="p">,</span> <span class="n">port</span><span class="p">;</span>

	<span class="n">path</span> <span class="o">=</span> <span class="n">BP_PATH</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
	<span class="n">port</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bnx2x_is_4_port_mode</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">port_swap</span><span class="p">,</span> <span class="n">port_swap_ovr</span><span class="p">;</span>

		<span class="cm">/* Figure out path swap value */</span>
		<span class="n">path_swap_ovr</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">MISC_REG_FOUR_PORT_PATH_SWAP_OVWR</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">path_swap_ovr</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">)</span>
			<span class="n">path_swap</span> <span class="o">=</span> <span class="p">(</span><span class="n">path_swap_ovr</span> <span class="o">&amp;</span> <span class="mh">0x2</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">path_swap</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">MISC_REG_FOUR_PORT_PATH_SWAP</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">path_swap</span><span class="p">)</span>
			<span class="n">path</span> <span class="o">=</span> <span class="n">path</span> <span class="o">^</span> <span class="mi">1</span><span class="p">;</span>

		<span class="cm">/* Figure out port swap value */</span>
		<span class="n">port_swap_ovr</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">MISC_REG_FOUR_PORT_PORT_SWAP_OVWR</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">port_swap_ovr</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">)</span>
			<span class="n">port_swap</span> <span class="o">=</span> <span class="p">(</span><span class="n">port_swap_ovr</span> <span class="o">&amp;</span> <span class="mh">0x2</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">port_swap</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">MISC_REG_FOUR_PORT_PORT_SWAP</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">port_swap</span><span class="p">)</span>
			<span class="n">port</span> <span class="o">=</span> <span class="n">port</span> <span class="o">^</span> <span class="mi">1</span><span class="p">;</span>

		<span class="n">lane</span> <span class="o">=</span> <span class="p">(</span><span class="n">port</span><span class="o">&lt;&lt;</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">path</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="cm">/* two port mode - no port swap */</span>

		<span class="cm">/* Figure out path swap value */</span>
		<span class="n">path_swap_ovr</span> <span class="o">=</span>
			<span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">MISC_REG_TWO_PORT_PATH_SWAP_OVWR</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">path_swap_ovr</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">path_swap</span> <span class="o">=</span> <span class="p">(</span><span class="n">path_swap_ovr</span> <span class="o">&amp;</span> <span class="mh">0x2</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">path_swap</span> <span class="o">=</span>
				<span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">MISC_REG_TWO_PORT_PATH_SWAP</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">path_swap</span><span class="p">)</span>
			<span class="n">path</span> <span class="o">=</span> <span class="n">path</span> <span class="o">^</span> <span class="mi">1</span><span class="p">;</span>

		<span class="n">lane</span> <span class="o">=</span> <span class="n">path</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span> <span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">lane</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_set_aer_mmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">link_params</span> <span class="o">*</span><span class="n">params</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">bnx2x_phy</span> <span class="o">*</span><span class="n">phy</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">ser_lane</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">offset</span><span class="p">,</span> <span class="n">aer_val</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">bp</span><span class="p">;</span>
	<span class="n">ser_lane</span> <span class="o">=</span> <span class="p">((</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">lane_config</span> <span class="o">&amp;</span>
		     <span class="n">PORT_HW_CFG_LANE_SWAP_CFG_MASTER_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span>
		     <span class="n">PORT_HW_CFG_LANE_SWAP_CFG_MASTER_SHIFT</span><span class="p">);</span>

	<span class="n">offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">PORT_HW_CFG_XGXS_EXT_PHY_TYPE_DIRECT</span><span class="p">)</span> <span class="o">?</span>
		<span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">+</span> <span class="n">ser_lane</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">USES_WARPCORE</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">aer_val</span> <span class="o">=</span> <span class="n">bnx2x_get_warpcore_lane</span><span class="p">(</span><span class="n">phy</span><span class="p">,</span> <span class="n">params</span><span class="p">);</span>
		<span class="cm">/* In Dual-lane mode, two lanes are joined together,</span>
<span class="cm">		 * so in order to configure them, the AER broadcast method is</span>
<span class="cm">		 * used here.</span>
<span class="cm">		 * 0x200 is the broadcast address for lanes 0,1</span>
<span class="cm">		 * 0x201 is the broadcast address for lanes 2,3</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">FLAGS_WC_DUAL_MODE</span><span class="p">)</span>
			<span class="n">aer_val</span> <span class="o">=</span> <span class="p">(</span><span class="n">aer_val</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x200</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">CHIP_IS_E2</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span>
		<span class="n">aer_val</span> <span class="o">=</span> <span class="mh">0x3800</span> <span class="o">+</span> <span class="n">offset</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">aer_val</span> <span class="o">=</span> <span class="mh">0x3800</span> <span class="o">+</span> <span class="n">offset</span><span class="p">;</span>

	<span class="n">CL22_WR_OVER_CL45</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_REG_BANK_AER_BLOCK</span><span class="p">,</span>
			  <span class="n">MDIO_AER_BLOCK_AER_REG</span><span class="p">,</span> <span class="n">aer_val</span><span class="p">);</span>

<span class="p">}</span>

<span class="cm">/******************************************************************/</span>
<span class="cm">/*			Internal phy section			  */</span>
<span class="cm">/******************************************************************/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_set_serdes_access</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">,</span> <span class="n">u8</span> <span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">emac_base</span> <span class="o">=</span> <span class="p">(</span><span class="n">port</span><span class="p">)</span> <span class="o">?</span> <span class="n">GRCBASE_EMAC1</span> <span class="o">:</span> <span class="n">GRCBASE_EMAC0</span><span class="p">;</span>

	<span class="cm">/* Set Clause 22 */</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">NIG_REG_SERDES0_CTRL_MD_ST</span> <span class="o">+</span> <span class="n">port</span><span class="o">*</span><span class="mh">0x10</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">emac_base</span> <span class="o">+</span> <span class="n">EMAC_REG_EMAC_MDIO_COMM</span><span class="p">,</span> <span class="mh">0x245f8000</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">500</span><span class="p">);</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">emac_base</span> <span class="o">+</span> <span class="n">EMAC_REG_EMAC_MDIO_COMM</span><span class="p">,</span> <span class="mh">0x245d000f</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">500</span><span class="p">);</span>
	 <span class="cm">/* Set Clause 45 */</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">NIG_REG_SERDES0_CTRL_MD_ST</span> <span class="o">+</span> <span class="n">port</span><span class="o">*</span><span class="mh">0x10</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_serdes_deassert</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">,</span> <span class="n">u8</span> <span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;bnx2x_serdes_deassert</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">SERDES_RESET_BITS</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">port</span><span class="o">*</span><span class="mi">16</span><span class="p">);</span>

	<span class="cm">/* reset and unreset the SerDes/XGXS */</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">GRCBASE_MISC</span> <span class="o">+</span> <span class="n">MISC_REGISTERS_RESET_REG_3_CLEAR</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">500</span><span class="p">);</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">GRCBASE_MISC</span> <span class="o">+</span> <span class="n">MISC_REGISTERS_RESET_REG_3_SET</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

	<span class="n">bnx2x_set_serdes_access</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>

	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">NIG_REG_SERDES0_CTRL_MD_DEVAD</span> <span class="o">+</span> <span class="n">port</span><span class="o">*</span><span class="mh">0x10</span><span class="p">,</span>
	       <span class="n">DEFAULT_PHY_DEV_ADDR</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_xgxs_deassert</span><span class="p">(</span><span class="k">struct</span> <span class="n">link_params</span> <span class="o">*</span><span class="n">params</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">bp</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">port</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>
	<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;bnx2x_xgxs_deassert</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">port</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">XGXS_RESET_BITS</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">port</span><span class="o">*</span><span class="mi">16</span><span class="p">);</span>

	<span class="cm">/* reset and unreset the SerDes/XGXS */</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">GRCBASE_MISC</span> <span class="o">+</span> <span class="n">MISC_REGISTERS_RESET_REG_3_CLEAR</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">500</span><span class="p">);</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">GRCBASE_MISC</span> <span class="o">+</span> <span class="n">MISC_REGISTERS_RESET_REG_3_SET</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">NIG_REG_XGXS0_CTRL_MD_ST</span> <span class="o">+</span> <span class="n">port</span><span class="o">*</span><span class="mh">0x18</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">NIG_REG_XGXS0_CTRL_MD_DEVAD</span> <span class="o">+</span> <span class="n">port</span><span class="o">*</span><span class="mh">0x18</span><span class="p">,</span>
	       <span class="n">params</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">[</span><span class="n">INT_PHY</span><span class="p">].</span><span class="n">def_md_devad</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_calc_ieee_aneg_adv</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x_phy</span> <span class="o">*</span><span class="n">phy</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">link_params</span> <span class="o">*</span><span class="n">params</span><span class="p">,</span> <span class="n">u16</span> <span class="o">*</span><span class="n">ieee_fc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">bp</span><span class="p">;</span>
	<span class="o">*</span><span class="n">ieee_fc</span> <span class="o">=</span> <span class="n">MDIO_COMBO_IEEE0_AUTO_NEG_ADV_FULL_DUPLEX</span><span class="p">;</span>
	<span class="cm">/* Resolve pause mode and advertisement Please refer to Table</span>
<span class="cm">	 * 28B-3 of the 802.3ab-1999 spec</span>
<span class="cm">	 */</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">req_flow_ctrl</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">BNX2X_FLOW_CTRL_AUTO</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">req_fc_auto_adv</span> <span class="o">==</span> <span class="n">BNX2X_FLOW_CTRL_BOTH</span><span class="p">)</span>
			<span class="o">*</span><span class="n">ieee_fc</span> <span class="o">|=</span> <span class="n">MDIO_COMBO_IEEE0_AUTO_NEG_ADV_PAUSE_BOTH</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="o">*</span><span class="n">ieee_fc</span> <span class="o">|=</span>
			<span class="n">MDIO_COMBO_IEEE0_AUTO_NEG_ADV_PAUSE_ASYMMETRIC</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BNX2X_FLOW_CTRL_TX</span>:
		<span class="o">*</span><span class="n">ieee_fc</span> <span class="o">|=</span> <span class="n">MDIO_COMBO_IEEE0_AUTO_NEG_ADV_PAUSE_ASYMMETRIC</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BNX2X_FLOW_CTRL_RX</span>:
	<span class="k">case</span> <span class="n">BNX2X_FLOW_CTRL_BOTH</span>:
		<span class="o">*</span><span class="n">ieee_fc</span> <span class="o">|=</span> <span class="n">MDIO_COMBO_IEEE0_AUTO_NEG_ADV_PAUSE_BOTH</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BNX2X_FLOW_CTRL_NONE</span>:
	<span class="nl">default:</span>
		<span class="o">*</span><span class="n">ieee_fc</span> <span class="o">|=</span> <span class="n">MDIO_COMBO_IEEE0_AUTO_NEG_ADV_PAUSE_NONE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;ieee_fc = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">ieee_fc</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">set_phy_vars</span><span class="p">(</span><span class="k">struct</span> <span class="n">link_params</span> <span class="o">*</span><span class="n">params</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">link_vars</span> <span class="o">*</span><span class="n">vars</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">bp</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">actual_phy_idx</span><span class="p">,</span> <span class="n">phy_index</span><span class="p">,</span> <span class="n">link_cfg_idx</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">phy_config_swapped</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">multi_phy_config</span> <span class="o">&amp;</span>
			<span class="n">PORT_HW_CFG_PHY_SWAPPED_ENABLED</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">phy_index</span> <span class="o">=</span> <span class="n">INT_PHY</span><span class="p">;</span> <span class="n">phy_index</span> <span class="o">&lt;</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">num_phys</span><span class="p">;</span>
	      <span class="n">phy_index</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">link_cfg_idx</span> <span class="o">=</span> <span class="n">LINK_CONFIG_IDX</span><span class="p">(</span><span class="n">phy_index</span><span class="p">);</span>
		<span class="n">actual_phy_idx</span> <span class="o">=</span> <span class="n">phy_index</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">phy_config_swapped</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">phy_index</span> <span class="o">==</span> <span class="n">EXT_PHY1</span><span class="p">)</span>
				<span class="n">actual_phy_idx</span> <span class="o">=</span> <span class="n">EXT_PHY2</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">phy_index</span> <span class="o">==</span> <span class="n">EXT_PHY2</span><span class="p">)</span>
				<span class="n">actual_phy_idx</span> <span class="o">=</span> <span class="n">EXT_PHY1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">params</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">[</span><span class="n">actual_phy_idx</span><span class="p">].</span><span class="n">req_flow_ctrl</span> <span class="o">=</span>
			<span class="n">params</span><span class="o">-&gt;</span><span class="n">req_flow_ctrl</span><span class="p">[</span><span class="n">link_cfg_idx</span><span class="p">];</span>

		<span class="n">params</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">[</span><span class="n">actual_phy_idx</span><span class="p">].</span><span class="n">req_line_speed</span> <span class="o">=</span>
			<span class="n">params</span><span class="o">-&gt;</span><span class="n">req_line_speed</span><span class="p">[</span><span class="n">link_cfg_idx</span><span class="p">];</span>

		<span class="n">params</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">[</span><span class="n">actual_phy_idx</span><span class="p">].</span><span class="n">speed_cap_mask</span> <span class="o">=</span>
			<span class="n">params</span><span class="o">-&gt;</span><span class="n">speed_cap_mask</span><span class="p">[</span><span class="n">link_cfg_idx</span><span class="p">];</span>

		<span class="n">params</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">[</span><span class="n">actual_phy_idx</span><span class="p">].</span><span class="n">req_duplex</span> <span class="o">=</span>
			<span class="n">params</span><span class="o">-&gt;</span><span class="n">req_duplex</span><span class="p">[</span><span class="n">link_cfg_idx</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">req_line_speed</span><span class="p">[</span><span class="n">link_cfg_idx</span><span class="p">]</span> <span class="o">==</span>
		    <span class="n">SPEED_AUTO_NEG</span><span class="p">)</span>
			<span class="n">vars</span><span class="o">-&gt;</span><span class="n">link_status</span> <span class="o">|=</span> <span class="n">LINK_STATUS_AUTO_NEGOTIATE_ENABLED</span><span class="p">;</span>

		<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;req_flow_ctrl %x, req_line_speed %x,&quot;</span>
			   <span class="s">&quot; speed_cap_mask %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">params</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">[</span><span class="n">actual_phy_idx</span><span class="p">].</span><span class="n">req_flow_ctrl</span><span class="p">,</span>
			   <span class="n">params</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">[</span><span class="n">actual_phy_idx</span><span class="p">].</span><span class="n">req_line_speed</span><span class="p">,</span>
			   <span class="n">params</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">[</span><span class="n">actual_phy_idx</span><span class="p">].</span><span class="n">speed_cap_mask</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_ext_phy_set_pause</span><span class="p">(</span><span class="k">struct</span> <span class="n">link_params</span> <span class="o">*</span><span class="n">params</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">bnx2x_phy</span> <span class="o">*</span><span class="n">phy</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">link_vars</span> <span class="o">*</span><span class="n">vars</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">val</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">bp</span><span class="p">;</span>
	<span class="cm">/* read modify write pause advertizing */</span>
	<span class="n">bnx2x_cl45_read</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_AN_DEVAD</span><span class="p">,</span> <span class="n">MDIO_AN_REG_ADV_PAUSE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>

	<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MDIO_AN_REG_ADV_PAUSE_BOTH</span><span class="p">;</span>

	<span class="cm">/* Please refer to Table 28B-3 of 802.3ab-1999 spec. */</span>
	<span class="n">bnx2x_calc_ieee_aneg_adv</span><span class="p">(</span><span class="n">phy</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vars</span><span class="o">-&gt;</span><span class="n">ieee_fc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">vars</span><span class="o">-&gt;</span><span class="n">ieee_fc</span> <span class="o">&amp;</span>
	    <span class="n">MDIO_COMBO_IEEE0_AUTO_NEG_ADV_PAUSE_ASYMMETRIC</span><span class="p">)</span> <span class="o">==</span>
	    <span class="n">MDIO_COMBO_IEEE0_AUTO_NEG_ADV_PAUSE_ASYMMETRIC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">MDIO_AN_REG_ADV_PAUSE_ASYMMETRIC</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">vars</span><span class="o">-&gt;</span><span class="n">ieee_fc</span> <span class="o">&amp;</span>
	    <span class="n">MDIO_COMBO_IEEE0_AUTO_NEG_ADV_PAUSE_BOTH</span><span class="p">)</span> <span class="o">==</span>
	    <span class="n">MDIO_COMBO_IEEE0_AUTO_NEG_ADV_PAUSE_BOTH</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">MDIO_AN_REG_ADV_PAUSE_PAUSE</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;Ext phy AN advertize 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_AN_DEVAD</span><span class="p">,</span> <span class="n">MDIO_AN_REG_ADV_PAUSE</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_pause_resolve</span><span class="p">(</span><span class="k">struct</span> <span class="n">link_vars</span> <span class="o">*</span><span class="n">vars</span><span class="p">,</span> <span class="n">u32</span> <span class="n">pause_result</span><span class="p">)</span>
<span class="p">{</span>						<span class="cm">/*  LD	    LP	 */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">pause_result</span><span class="p">)</span> <span class="p">{</span>			<span class="cm">/* ASYM P ASYM P */</span>
	<span class="k">case</span> <span class="mh">0xb</span>:				<span class="cm">/*   1  0   1  1 */</span>
		<span class="n">vars</span><span class="o">-&gt;</span><span class="n">flow_ctrl</span> <span class="o">=</span> <span class="n">BNX2X_FLOW_CTRL_TX</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mh">0xe</span>:				<span class="cm">/*   1  1   1  0 */</span>
		<span class="n">vars</span><span class="o">-&gt;</span><span class="n">flow_ctrl</span> <span class="o">=</span> <span class="n">BNX2X_FLOW_CTRL_RX</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mh">0x5</span>:				<span class="cm">/*   0  1   0  1 */</span>
	<span class="k">case</span> <span class="mh">0x7</span>:				<span class="cm">/*   0  1   1  1 */</span>
	<span class="k">case</span> <span class="mh">0xd</span>:				<span class="cm">/*   1  1   0  1 */</span>
	<span class="k">case</span> <span class="mh">0xf</span>:				<span class="cm">/*   1  1   1  1 */</span>
		<span class="n">vars</span><span class="o">-&gt;</span><span class="n">flow_ctrl</span> <span class="o">=</span> <span class="n">BNX2X_FLOW_CTRL_BOTH</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pause_result</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">0</span><span class="p">))</span>
		<span class="n">vars</span><span class="o">-&gt;</span><span class="n">link_status</span> <span class="o">|=</span> <span class="n">LINK_STATUS_LINK_PARTNER_SYMMETRIC_PAUSE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pause_result</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">1</span><span class="p">))</span>
		<span class="n">vars</span><span class="o">-&gt;</span><span class="n">link_status</span> <span class="o">|=</span> <span class="n">LINK_STATUS_LINK_PARTNER_ASYMMETRIC_PAUSE</span><span class="p">;</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_ext_phy_update_adv_fc</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x_phy</span> <span class="o">*</span><span class="n">phy</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">link_params</span> <span class="o">*</span><span class="n">params</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">link_vars</span> <span class="o">*</span><span class="n">vars</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">ld_pause</span><span class="p">;</span>		<span class="cm">/* local */</span>
	<span class="n">u16</span> <span class="n">lp_pause</span><span class="p">;</span>		<span class="cm">/* link partner */</span>
	<span class="n">u16</span> <span class="n">pause_result</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">bp</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">PORT_HW_CFG_XGXS_EXT_PHY_TYPE_BCM54618SE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bnx2x_cl22_read</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="mh">0x4</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ld_pause</span><span class="p">);</span>
		<span class="n">bnx2x_cl22_read</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="mh">0x5</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lp_pause</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">CHIP_IS_E3</span><span class="p">(</span><span class="n">bp</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		<span class="n">SINGLE_MEDIA_DIRECT</span><span class="p">(</span><span class="n">params</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="n">lane</span> <span class="o">=</span> <span class="n">bnx2x_get_warpcore_lane</span><span class="p">(</span><span class="n">phy</span><span class="p">,</span> <span class="n">params</span><span class="p">);</span>
		<span class="n">u16</span> <span class="n">gp_status</span><span class="p">,</span> <span class="n">gp_mask</span><span class="p">;</span>
		<span class="n">bnx2x_cl45_read</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
				<span class="n">MDIO_AN_DEVAD</span><span class="p">,</span> <span class="n">MDIO_WC_REG_GP2_STATUS_GP_2_4</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">gp_status</span><span class="p">);</span>
		<span class="n">gp_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">MDIO_WC_REG_GP2_STATUS_GP_2_4_CL73_AN_CMPL</span> <span class="o">|</span>
			   <span class="n">MDIO_WC_REG_GP2_STATUS_GP_2_4_CL37_LP_AN_CAP</span><span class="p">)</span> <span class="o">&lt;&lt;</span>
			<span class="n">lane</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">gp_status</span> <span class="o">&amp;</span> <span class="n">gp_mask</span><span class="p">)</span> <span class="o">==</span> <span class="n">gp_mask</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">bnx2x_cl45_read</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_AN_DEVAD</span><span class="p">,</span>
					<span class="n">MDIO_AN_REG_ADV_PAUSE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ld_pause</span><span class="p">);</span>
			<span class="n">bnx2x_cl45_read</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_AN_DEVAD</span><span class="p">,</span>
					<span class="n">MDIO_AN_REG_LP_AUTO_NEG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lp_pause</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">bnx2x_cl45_read</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_AN_DEVAD</span><span class="p">,</span>
					<span class="n">MDIO_AN_REG_CL37_FC_LD</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ld_pause</span><span class="p">);</span>
			<span class="n">bnx2x_cl45_read</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_AN_DEVAD</span><span class="p">,</span>
					<span class="n">MDIO_AN_REG_CL37_FC_LP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lp_pause</span><span class="p">);</span>
			<span class="n">ld_pause</span> <span class="o">=</span> <span class="p">((</span><span class="n">ld_pause</span> <span class="o">&amp;</span>
				     <span class="n">MDIO_COMBO_IEEE0_AUTO_NEG_ADV_PAUSE_BOTH</span><span class="p">)</span>
				    <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">);</span>
			<span class="n">lp_pause</span> <span class="o">=</span> <span class="p">((</span><span class="n">lp_pause</span> <span class="o">&amp;</span>
				     <span class="n">MDIO_COMBO_IEEE0_AUTO_NEG_ADV_PAUSE_BOTH</span><span class="p">)</span>
				    <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">bnx2x_cl45_read</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
				<span class="n">MDIO_AN_DEVAD</span><span class="p">,</span>
				<span class="n">MDIO_AN_REG_ADV_PAUSE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ld_pause</span><span class="p">);</span>
		<span class="n">bnx2x_cl45_read</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
				<span class="n">MDIO_AN_DEVAD</span><span class="p">,</span>
				<span class="n">MDIO_AN_REG_LP_AUTO_NEG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lp_pause</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">pause_result</span> <span class="o">=</span> <span class="p">(</span><span class="n">ld_pause</span> <span class="o">&amp;</span>
			<span class="n">MDIO_AN_REG_ADV_PAUSE_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">pause_result</span> <span class="o">|=</span> <span class="p">(</span><span class="n">lp_pause</span> <span class="o">&amp;</span>
			 <span class="n">MDIO_AN_REG_ADV_PAUSE_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">10</span><span class="p">;</span>
	<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;Ext PHY pause result 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pause_result</span><span class="p">);</span>
	<span class="n">bnx2x_pause_resolve</span><span class="p">(</span><span class="n">vars</span><span class="p">,</span> <span class="n">pause_result</span><span class="p">);</span>

<span class="p">}</span>

<span class="k">static</span> <span class="n">u8</span> <span class="nf">bnx2x_ext_phy_resolve_fc</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x_phy</span> <span class="o">*</span><span class="n">phy</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">link_params</span> <span class="o">*</span><span class="n">params</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">link_vars</span> <span class="o">*</span><span class="n">vars</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">vars</span><span class="o">-&gt;</span><span class="n">flow_ctrl</span> <span class="o">=</span> <span class="n">BNX2X_FLOW_CTRL_NONE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">req_flow_ctrl</span> <span class="o">!=</span> <span class="n">BNX2X_FLOW_CTRL_AUTO</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Update the advertised flow-controled of LD/LP in AN */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">req_line_speed</span> <span class="o">==</span> <span class="n">SPEED_AUTO_NEG</span><span class="p">)</span>
			<span class="n">bnx2x_ext_phy_update_adv_fc</span><span class="p">(</span><span class="n">phy</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">vars</span><span class="p">);</span>
		<span class="cm">/* But set the flow-control result as the requested one */</span>
		<span class="n">vars</span><span class="o">-&gt;</span><span class="n">flow_ctrl</span> <span class="o">=</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">req_flow_ctrl</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">req_line_speed</span> <span class="o">!=</span> <span class="n">SPEED_AUTO_NEG</span><span class="p">)</span>
		<span class="n">vars</span><span class="o">-&gt;</span><span class="n">flow_ctrl</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">req_fc_auto_adv</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">vars</span><span class="o">-&gt;</span><span class="n">link_status</span> <span class="o">&amp;</span> <span class="n">LINK_STATUS_AUTO_NEGOTIATE_COMPLETE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">bnx2x_ext_phy_update_adv_fc</span><span class="p">(</span><span class="n">phy</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">vars</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
<span class="cm">/******************************************************************/</span>
<span class="cm">/*			Warpcore section			  */</span>
<span class="cm">/******************************************************************/</span>
<span class="cm">/* The init_internal_warpcore should mirror the xgxs,</span>
<span class="cm"> * i.e. reset the lane (if needed), set aer for the</span>
<span class="cm"> * init configuration, and set/clear SGMII flag. Internal</span>
<span class="cm"> * phy init is done purely in phy_init stage.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_warpcore_enable_AN_KR</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x_phy</span> <span class="o">*</span><span class="n">phy</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">link_params</span> <span class="o">*</span><span class="n">params</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">link_vars</span> <span class="o">*</span><span class="n">vars</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">u16</span> <span class="n">val16</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">lane</span><span class="p">,</span> <span class="n">bam37</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">bp</span><span class="p">;</span>
	<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;Enable Auto Negotiation for KR</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="cm">/* Set to default registers that may be overriden by 10G force */</span>
	<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_WC_DEVAD</span><span class="p">,</span>
			 <span class="n">MDIO_WC_REG_SERDESDIGITAL_CONTROL1000X2</span><span class="p">,</span> <span class="mh">0x7</span><span class="p">);</span>
	<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_AN_DEVAD</span><span class="p">,</span>
			 <span class="n">MDIO_WC_REG_PAR_DET_10G_CTRL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_WC_DEVAD</span><span class="p">,</span>
			 <span class="n">MDIO_WC_REG_CL72_USERB0_CL72_MISC1_CONTROL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_WC_DEVAD</span><span class="p">,</span>
			<span class="n">MDIO_WC_REG_XGXSBLK1_LANECTRL0</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_WC_DEVAD</span><span class="p">,</span>
			<span class="n">MDIO_WC_REG_XGXSBLK1_LANECTRL1</span><span class="p">,</span> <span class="mh">0x5555</span><span class="p">);</span>
	<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_PMA_DEVAD</span><span class="p">,</span>
			 <span class="n">MDIO_WC_REG_IEEE0BLK_AUTONEGNP</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>
	<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_WC_DEVAD</span><span class="p">,</span>
			 <span class="n">MDIO_WC_REG_RX66_CONTROL</span><span class="p">,</span> <span class="mh">0x7415</span><span class="p">);</span>
	<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_WC_DEVAD</span><span class="p">,</span>
			 <span class="n">MDIO_WC_REG_SERDESDIGITAL_MISC2</span><span class="p">,</span> <span class="mh">0x6190</span><span class="p">);</span>
	<span class="cm">/* Disable Autoneg: re-enable it after adv is done. */</span>
	<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_AN_DEVAD</span><span class="p">,</span>
			 <span class="n">MDIO_WC_REG_IEEE0BLK_MIICNTL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* Check adding advertisement for 1G KX */</span>
	<span class="k">if</span> <span class="p">(((</span><span class="n">vars</span><span class="o">-&gt;</span><span class="n">line_speed</span> <span class="o">==</span> <span class="n">SPEED_AUTO_NEG</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	     <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">speed_cap_mask</span> <span class="o">&amp;</span> <span class="n">PORT_HW_CFG_SPEED_CAPABILITY_D0_1G</span><span class="p">))</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">vars</span><span class="o">-&gt;</span><span class="n">line_speed</span> <span class="o">==</span> <span class="n">SPEED_1000</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">u16</span> <span class="n">sd_digital</span><span class="p">;</span>
		<span class="n">val16</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">5</span><span class="p">);</span>

		<span class="cm">/* Enable CL37 1G Parallel Detect */</span>
		<span class="n">bnx2x_cl45_read</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_WC_DEVAD</span><span class="p">,</span>
			<span class="n">MDIO_WC_REG_SERDESDIGITAL_CONTROL1000X2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sd_digital</span><span class="p">);</span>
		<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_WC_DEVAD</span><span class="p">,</span>
			 <span class="n">MDIO_WC_REG_SERDESDIGITAL_CONTROL1000X2</span><span class="p">,</span>
				 <span class="p">(</span><span class="n">sd_digital</span> <span class="o">|</span> <span class="mh">0x1</span><span class="p">));</span>

		<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;Advertize 1G</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(((</span><span class="n">vars</span><span class="o">-&gt;</span><span class="n">line_speed</span> <span class="o">==</span> <span class="n">SPEED_AUTO_NEG</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	     <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">speed_cap_mask</span> <span class="o">&amp;</span> <span class="n">PORT_HW_CFG_SPEED_CAPABILITY_D0_10G</span><span class="p">))</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">vars</span><span class="o">-&gt;</span><span class="n">line_speed</span> <span class="o">==</span>  <span class="n">SPEED_10000</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Check adding advertisement for 10G KR */</span>
		<span class="n">val16</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">7</span><span class="p">);</span>
		<span class="cm">/* Enable 10G Parallel Detect */</span>
		<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_AN_DEVAD</span><span class="p">,</span>
				<span class="n">MDIO_WC_REG_PAR_DET_10G_CTRL</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

		<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;Advertize 10G</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Set Transmit PMD settings */</span>
	<span class="n">lane</span> <span class="o">=</span> <span class="n">bnx2x_get_warpcore_lane</span><span class="p">(</span><span class="n">phy</span><span class="p">,</span> <span class="n">params</span><span class="p">);</span>
	<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_WC_DEVAD</span><span class="p">,</span>
		      <span class="n">MDIO_WC_REG_TX0_TX_DRIVER</span> <span class="o">+</span> <span class="mh">0x10</span><span class="o">*</span><span class="n">lane</span><span class="p">,</span>
		     <span class="p">((</span><span class="mh">0x02</span> <span class="o">&lt;&lt;</span> <span class="n">MDIO_WC_REG_TX0_TX_DRIVER_POST2_COEFF_OFFSET</span><span class="p">)</span> <span class="o">|</span>
		      <span class="p">(</span><span class="mh">0x06</span> <span class="o">&lt;&lt;</span> <span class="n">MDIO_WC_REG_TX0_TX_DRIVER_IDRIVER_OFFSET</span><span class="p">)</span> <span class="o">|</span>
		      <span class="p">(</span><span class="mh">0x09</span> <span class="o">&lt;&lt;</span> <span class="n">MDIO_WC_REG_TX0_TX_DRIVER_IPRE_DRIVER_OFFSET</span><span class="p">)));</span>
	<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_WC_DEVAD</span><span class="p">,</span>
			 <span class="n">MDIO_WC_REG_CL72_USERB0_CL72_OS_DEF_CTRL</span><span class="p">,</span>
			 <span class="mh">0x03f0</span><span class="p">);</span>
	<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_WC_DEVAD</span><span class="p">,</span>
			 <span class="n">MDIO_WC_REG_CL72_USERB0_CL72_2P5_DEF_CTRL</span><span class="p">,</span>
			 <span class="mh">0x03f0</span><span class="p">);</span>

	<span class="cm">/* Advertised speeds */</span>
	<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_AN_DEVAD</span><span class="p">,</span>
			 <span class="n">MDIO_WC_REG_AN_IEEE1BLK_AN_ADVERTISEMENT1</span><span class="p">,</span> <span class="n">val16</span><span class="p">);</span>

	<span class="cm">/* Advertised and set FEC (Forward Error Correction) */</span>
	<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_AN_DEVAD</span><span class="p">,</span>
			 <span class="n">MDIO_WC_REG_AN_IEEE1BLK_AN_ADVERTISEMENT2</span><span class="p">,</span>
			 <span class="p">(</span><span class="n">MDIO_WC_REG_AN_IEEE1BLK_AN_ADV2_FEC_ABILITY</span> <span class="o">|</span>
			  <span class="n">MDIO_WC_REG_AN_IEEE1BLK_AN_ADV2_FEC_REQ</span><span class="p">));</span>

	<span class="cm">/* Enable CL37 BAM */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">shmem_base</span> <span class="o">+</span>
		   <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">shmem_region</span><span class="p">,</span> <span class="n">dev_info</span><span class="p">.</span>
			    <span class="n">port_hw_config</span><span class="p">[</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">].</span><span class="n">default_cfg</span><span class="p">))</span> <span class="o">&amp;</span>
	    <span class="n">PORT_HW_CFG_ENABLE_BAM_ON_KR_ENABLED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bnx2x_cl45_read</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_WC_DEVAD</span><span class="p">,</span>
				<span class="n">MDIO_WC_REG_DIGITAL6_MP5_NEXTPAGECTRL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bam37</span><span class="p">);</span>
		<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_WC_DEVAD</span><span class="p">,</span>
			<span class="n">MDIO_WC_REG_DIGITAL6_MP5_NEXTPAGECTRL</span><span class="p">,</span> <span class="n">bam37</span> <span class="o">|</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;Enable CL37 BAM on KR</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Advertise pause */</span>
	<span class="n">bnx2x_ext_phy_set_pause</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">vars</span><span class="p">);</span>
	<span class="cm">/* Set KR Autoneg Work-Around flag for Warpcore version older than D108</span>
<span class="cm">	 */</span>
	<span class="n">bnx2x_cl45_read</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_WC_DEVAD</span><span class="p">,</span>
			<span class="n">MDIO_WC_REG_UC_INFO_B1_VERSION</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val16</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val16</span> <span class="o">&lt;</span> <span class="mh">0xd108</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;Enable AN KR work-around</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">vars</span><span class="o">-&gt;</span><span class="n">rx_tx_asic_rst</span> <span class="o">=</span> <span class="n">MAX_KR_LINK_RETRY</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">bnx2x_cl45_read</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_WC_DEVAD</span><span class="p">,</span>
			<span class="n">MDIO_WC_REG_DIGITAL5_MISC7</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val16</span><span class="p">);</span>

	<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_WC_DEVAD</span><span class="p">,</span>
			 <span class="n">MDIO_WC_REG_DIGITAL5_MISC7</span><span class="p">,</span> <span class="n">val16</span> <span class="o">|</span> <span class="mh">0x100</span><span class="p">);</span>

	<span class="cm">/* Over 1G - AN local device user page 1 */</span>
	<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_WC_DEVAD</span><span class="p">,</span>
			<span class="n">MDIO_WC_REG_DIGITAL3_UP1</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">);</span>

	<span class="cm">/* Enable Autoneg */</span>
	<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_AN_DEVAD</span><span class="p">,</span>
			 <span class="n">MDIO_WC_REG_IEEE0BLK_MIICNTL</span><span class="p">,</span> <span class="mh">0x1200</span><span class="p">);</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_warpcore_set_10G_KR</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x_phy</span> <span class="o">*</span><span class="n">phy</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">link_params</span> <span class="o">*</span><span class="n">params</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">link_vars</span> <span class="o">*</span><span class="n">vars</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">bp</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">val</span><span class="p">;</span>

	<span class="cm">/* Disable Autoneg */</span>
	<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_WC_DEVAD</span><span class="p">,</span>
			 <span class="n">MDIO_WC_REG_SERDESDIGITAL_CONTROL1000X2</span><span class="p">,</span> <span class="mh">0x7</span><span class="p">);</span>

	<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_AN_DEVAD</span><span class="p">,</span>
			 <span class="n">MDIO_WC_REG_PAR_DET_10G_CTRL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_WC_DEVAD</span><span class="p">,</span>
			 <span class="n">MDIO_WC_REG_CL72_USERB0_CL72_MISC1_CONTROL</span><span class="p">,</span> <span class="mh">0x3f00</span><span class="p">);</span>

	<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_AN_DEVAD</span><span class="p">,</span>
			 <span class="n">MDIO_WC_REG_AN_IEEE1BLK_AN_ADVERTISEMENT1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_AN_DEVAD</span><span class="p">,</span>
			 <span class="n">MDIO_WC_REG_IEEE0BLK_MIICNTL</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>

	<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_WC_DEVAD</span><span class="p">,</span>
			<span class="n">MDIO_WC_REG_DIGITAL3_UP1</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">);</span>

	<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_WC_DEVAD</span><span class="p">,</span>
			 <span class="n">MDIO_WC_REG_DIGITAL5_MISC7</span><span class="p">,</span> <span class="mh">0xa</span><span class="p">);</span>

	<span class="cm">/* Disable CL36 PCS Tx */</span>
	<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_WC_DEVAD</span><span class="p">,</span>
			<span class="n">MDIO_WC_REG_XGXSBLK1_LANECTRL0</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>

	<span class="cm">/* Double Wide Single Data Rate @ pll rate */</span>
	<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_WC_DEVAD</span><span class="p">,</span>
			<span class="n">MDIO_WC_REG_XGXSBLK1_LANECTRL1</span><span class="p">,</span> <span class="mh">0xFFFF</span><span class="p">);</span>

	<span class="cm">/* Leave cl72 training enable, needed for KR */</span>
	<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_PMA_DEVAD</span><span class="p">,</span>
		<span class="n">MDIO_WC_REG_PMD_IEEE9BLK_TENGBASE_KR_PMD_CONTROL_REGISTER_150</span><span class="p">,</span>
		<span class="mh">0x2</span><span class="p">);</span>

	<span class="cm">/* Leave CL72 enabled */</span>
	<span class="n">bnx2x_cl45_read</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_WC_DEVAD</span><span class="p">,</span>
			 <span class="n">MDIO_WC_REG_CL72_USERB0_CL72_MISC1_CONTROL</span><span class="p">,</span>
			 <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
	<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_WC_DEVAD</span><span class="p">,</span>
			 <span class="n">MDIO_WC_REG_CL72_USERB0_CL72_MISC1_CONTROL</span><span class="p">,</span>
			 <span class="n">val</span> <span class="o">|</span> <span class="mh">0x3800</span><span class="p">);</span>

	<span class="cm">/* Set speed via PMA/PMD register */</span>
	<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_PMA_DEVAD</span><span class="p">,</span>
			 <span class="n">MDIO_WC_REG_IEEE0BLK_MIICNTL</span><span class="p">,</span> <span class="mh">0x2040</span><span class="p">);</span>

	<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_PMA_DEVAD</span><span class="p">,</span>
			 <span class="n">MDIO_WC_REG_IEEE0BLK_AUTONEGNP</span><span class="p">,</span> <span class="mh">0xB</span><span class="p">);</span>

	<span class="cm">/* Enable encoded forced speed */</span>
	<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_WC_DEVAD</span><span class="p">,</span>
			 <span class="n">MDIO_WC_REG_SERDESDIGITAL_MISC2</span><span class="p">,</span> <span class="mh">0x30</span><span class="p">);</span>

	<span class="cm">/* Turn TX scramble payload only the 64/66 scrambler */</span>
	<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_WC_DEVAD</span><span class="p">,</span>
			 <span class="n">MDIO_WC_REG_TX66_CONTROL</span><span class="p">,</span> <span class="mh">0x9</span><span class="p">);</span>

	<span class="cm">/* Turn RX scramble payload only the 64/66 scrambler */</span>
	<span class="n">bnx2x_cl45_read_or_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_WC_DEVAD</span><span class="p">,</span>
				 <span class="n">MDIO_WC_REG_RX66_CONTROL</span><span class="p">,</span> <span class="mh">0xF9</span><span class="p">);</span>

	<span class="cm">/* set and clear loopback to cause a reset to 64/66 decoder */</span>
	<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_WC_DEVAD</span><span class="p">,</span>
			 <span class="n">MDIO_WC_REG_IEEE0BLK_MIICNTL</span><span class="p">,</span> <span class="mh">0x4000</span><span class="p">);</span>
	<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_WC_DEVAD</span><span class="p">,</span>
			 <span class="n">MDIO_WC_REG_IEEE0BLK_MIICNTL</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_warpcore_set_10G_XFI</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x_phy</span> <span class="o">*</span><span class="n">phy</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">link_params</span> <span class="o">*</span><span class="n">params</span><span class="p">,</span>
				       <span class="n">u8</span> <span class="n">is_xfi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">bp</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">misc1_val</span><span class="p">,</span> <span class="n">tap_val</span><span class="p">,</span> <span class="n">tx_driver_val</span><span class="p">,</span> <span class="n">lane</span><span class="p">,</span> <span class="n">val</span><span class="p">;</span>
	<span class="cm">/* Hold rxSeqStart */</span>
	<span class="n">bnx2x_cl45_read</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_WC_DEVAD</span><span class="p">,</span>
			<span class="n">MDIO_WC_REG_DSC2B0_DSC_MISC_CTRL0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
	<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_WC_DEVAD</span><span class="p">,</span>
			 <span class="n">MDIO_WC_REG_DSC2B0_DSC_MISC_CTRL0</span><span class="p">,</span> <span class="p">(</span><span class="n">val</span> <span class="o">|</span> <span class="mh">0x8000</span><span class="p">));</span>

	<span class="cm">/* Hold tx_fifo_reset */</span>
	<span class="n">bnx2x_cl45_read</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_WC_DEVAD</span><span class="p">,</span>
			<span class="n">MDIO_WC_REG_SERDESDIGITAL_CONTROL1000X3</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
	<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_WC_DEVAD</span><span class="p">,</span>
			 <span class="n">MDIO_WC_REG_SERDESDIGITAL_CONTROL1000X3</span><span class="p">,</span> <span class="p">(</span><span class="n">val</span> <span class="o">|</span> <span class="mh">0x1</span><span class="p">));</span>

	<span class="cm">/* Disable CL73 AN */</span>
	<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_AN_DEVAD</span><span class="p">,</span> <span class="n">MDIO_AN_REG_CTRL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* Disable 100FX Enable and Auto-Detect */</span>
	<span class="n">bnx2x_cl45_read</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_WC_DEVAD</span><span class="p">,</span>
			<span class="n">MDIO_WC_REG_FX100_CTRL1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
	<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_WC_DEVAD</span><span class="p">,</span>
			 <span class="n">MDIO_WC_REG_FX100_CTRL1</span><span class="p">,</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0xFFFA</span><span class="p">));</span>

	<span class="cm">/* Disable 100FX Idle detect */</span>
	<span class="n">bnx2x_cl45_read</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_WC_DEVAD</span><span class="p">,</span>
			<span class="n">MDIO_WC_REG_FX100_CTRL3</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
	<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_WC_DEVAD</span><span class="p">,</span>
			 <span class="n">MDIO_WC_REG_FX100_CTRL3</span><span class="p">,</span> <span class="p">(</span><span class="n">val</span> <span class="o">|</span> <span class="mh">0x0080</span><span class="p">));</span>

	<span class="cm">/* Set Block address to Remote PHY &amp; Clear forced_speed[5] */</span>
	<span class="n">bnx2x_cl45_read</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_WC_DEVAD</span><span class="p">,</span>
			<span class="n">MDIO_WC_REG_DIGITAL4_MISC3</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
	<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_WC_DEVAD</span><span class="p">,</span>
			 <span class="n">MDIO_WC_REG_DIGITAL4_MISC3</span><span class="p">,</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0xFF7F</span><span class="p">));</span>

	<span class="cm">/* Turn off auto-detect &amp; fiber mode */</span>
	<span class="n">bnx2x_cl45_read</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_WC_DEVAD</span><span class="p">,</span>
			<span class="n">MDIO_WC_REG_SERDESDIGITAL_CONTROL1000X1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
	<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_WC_DEVAD</span><span class="p">,</span>
			 <span class="n">MDIO_WC_REG_SERDESDIGITAL_CONTROL1000X1</span><span class="p">,</span>
			 <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0xFFEE</span><span class="p">));</span>

	<span class="cm">/* Set filter_force_link, disable_false_link and parallel_detect */</span>
	<span class="n">bnx2x_cl45_read</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_WC_DEVAD</span><span class="p">,</span>
			<span class="n">MDIO_WC_REG_SERDESDIGITAL_CONTROL1000X2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
	<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_WC_DEVAD</span><span class="p">,</span>
			 <span class="n">MDIO_WC_REG_SERDESDIGITAL_CONTROL1000X2</span><span class="p">,</span>
			 <span class="p">((</span><span class="n">val</span> <span class="o">|</span> <span class="mh">0x0006</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFFFE</span><span class="p">));</span>

	<span class="cm">/* Set XFI / SFI */</span>
	<span class="n">bnx2x_cl45_read</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_WC_DEVAD</span><span class="p">,</span>
			<span class="n">MDIO_WC_REG_SERDESDIGITAL_MISC1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">misc1_val</span><span class="p">);</span>

	<span class="n">misc1_val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mh">0x1f</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_xfi</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">misc1_val</span> <span class="o">|=</span> <span class="mh">0x5</span><span class="p">;</span>
		<span class="n">tap_val</span> <span class="o">=</span> <span class="p">((</span><span class="mh">0x08</span> <span class="o">&lt;&lt;</span> <span class="n">MDIO_WC_REG_TX_FIR_TAP_POST_TAP_OFFSET</span><span class="p">)</span> <span class="o">|</span>
			   <span class="p">(</span><span class="mh">0x37</span> <span class="o">&lt;&lt;</span> <span class="n">MDIO_WC_REG_TX_FIR_TAP_MAIN_TAP_OFFSET</span><span class="p">)</span> <span class="o">|</span>
			   <span class="p">(</span><span class="mh">0x00</span> <span class="o">&lt;&lt;</span> <span class="n">MDIO_WC_REG_TX_FIR_TAP_PRE_TAP_OFFSET</span><span class="p">));</span>
		<span class="n">tx_driver_val</span> <span class="o">=</span>
		      <span class="p">((</span><span class="mh">0x00</span> <span class="o">&lt;&lt;</span> <span class="n">MDIO_WC_REG_TX0_TX_DRIVER_POST2_COEFF_OFFSET</span><span class="p">)</span> <span class="o">|</span>
		       <span class="p">(</span><span class="mh">0x02</span> <span class="o">&lt;&lt;</span> <span class="n">MDIO_WC_REG_TX0_TX_DRIVER_IDRIVER_OFFSET</span><span class="p">)</span> <span class="o">|</span>
		       <span class="p">(</span><span class="mh">0x03</span> <span class="o">&lt;&lt;</span> <span class="n">MDIO_WC_REG_TX0_TX_DRIVER_IPRE_DRIVER_OFFSET</span><span class="p">));</span>

	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">misc1_val</span> <span class="o">|=</span> <span class="mh">0x9</span><span class="p">;</span>
		<span class="n">tap_val</span> <span class="o">=</span> <span class="p">((</span><span class="mh">0x0f</span> <span class="o">&lt;&lt;</span> <span class="n">MDIO_WC_REG_TX_FIR_TAP_POST_TAP_OFFSET</span><span class="p">)</span> <span class="o">|</span>
			   <span class="p">(</span><span class="mh">0x2b</span> <span class="o">&lt;&lt;</span> <span class="n">MDIO_WC_REG_TX_FIR_TAP_MAIN_TAP_OFFSET</span><span class="p">)</span> <span class="o">|</span>
			   <span class="p">(</span><span class="mh">0x02</span> <span class="o">&lt;&lt;</span> <span class="n">MDIO_WC_REG_TX_FIR_TAP_PRE_TAP_OFFSET</span><span class="p">));</span>
		<span class="n">tx_driver_val</span> <span class="o">=</span>
		      <span class="p">((</span><span class="mh">0x03</span> <span class="o">&lt;&lt;</span> <span class="n">MDIO_WC_REG_TX0_TX_DRIVER_POST2_COEFF_OFFSET</span><span class="p">)</span> <span class="o">|</span>
		       <span class="p">(</span><span class="mh">0x02</span> <span class="o">&lt;&lt;</span> <span class="n">MDIO_WC_REG_TX0_TX_DRIVER_IDRIVER_OFFSET</span><span class="p">)</span> <span class="o">|</span>
		       <span class="p">(</span><span class="mh">0x06</span> <span class="o">&lt;&lt;</span> <span class="n">MDIO_WC_REG_TX0_TX_DRIVER_IPRE_DRIVER_OFFSET</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_WC_DEVAD</span><span class="p">,</span>
			 <span class="n">MDIO_WC_REG_SERDESDIGITAL_MISC1</span><span class="p">,</span> <span class="n">misc1_val</span><span class="p">);</span>

	<span class="cm">/* Set Transmit PMD settings */</span>
	<span class="n">lane</span> <span class="o">=</span> <span class="n">bnx2x_get_warpcore_lane</span><span class="p">(</span><span class="n">phy</span><span class="p">,</span> <span class="n">params</span><span class="p">);</span>
	<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_WC_DEVAD</span><span class="p">,</span>
			 <span class="n">MDIO_WC_REG_TX_FIR_TAP</span><span class="p">,</span>
			 <span class="n">tap_val</span> <span class="o">|</span> <span class="n">MDIO_WC_REG_TX_FIR_TAP_ENABLE</span><span class="p">);</span>
	<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_WC_DEVAD</span><span class="p">,</span>
			 <span class="n">MDIO_WC_REG_TX0_TX_DRIVER</span> <span class="o">+</span> <span class="mh">0x10</span><span class="o">*</span><span class="n">lane</span><span class="p">,</span>
			 <span class="n">tx_driver_val</span><span class="p">);</span>

	<span class="cm">/* Enable fiber mode, enable and invert sig_det */</span>
	<span class="n">bnx2x_cl45_read</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_WC_DEVAD</span><span class="p">,</span>
			<span class="n">MDIO_WC_REG_SERDESDIGITAL_CONTROL1000X1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
	<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_WC_DEVAD</span><span class="p">,</span>
			 <span class="n">MDIO_WC_REG_SERDESDIGITAL_CONTROL1000X1</span><span class="p">,</span> <span class="n">val</span> <span class="o">|</span> <span class="mh">0xd</span><span class="p">);</span>

	<span class="cm">/* Set Block address to Remote PHY &amp; Set forced_speed[5], 40bit mode */</span>
	<span class="n">bnx2x_cl45_read</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_WC_DEVAD</span><span class="p">,</span>
			<span class="n">MDIO_WC_REG_DIGITAL4_MISC3</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
	<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_WC_DEVAD</span><span class="p">,</span>
			 <span class="n">MDIO_WC_REG_DIGITAL4_MISC3</span><span class="p">,</span> <span class="n">val</span> <span class="o">|</span> <span class="mh">0x8080</span><span class="p">);</span>

	<span class="cm">/* 10G XFI Full Duplex */</span>
	<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_WC_DEVAD</span><span class="p">,</span>
			 <span class="n">MDIO_WC_REG_IEEE0BLK_MIICNTL</span><span class="p">,</span> <span class="mh">0x100</span><span class="p">);</span>

	<span class="cm">/* Release tx_fifo_reset */</span>
	<span class="n">bnx2x_cl45_read</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_WC_DEVAD</span><span class="p">,</span>
			<span class="n">MDIO_WC_REG_SERDESDIGITAL_CONTROL1000X3</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
	<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_WC_DEVAD</span><span class="p">,</span>
			 <span class="n">MDIO_WC_REG_SERDESDIGITAL_CONTROL1000X3</span><span class="p">,</span> <span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0xFFFE</span><span class="p">);</span>

	<span class="cm">/* Release rxSeqStart */</span>
	<span class="n">bnx2x_cl45_read</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_WC_DEVAD</span><span class="p">,</span>
			<span class="n">MDIO_WC_REG_DSC2B0_DSC_MISC_CTRL0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
	<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_WC_DEVAD</span><span class="p">,</span>
			 <span class="n">MDIO_WC_REG_DSC2B0_DSC_MISC_CTRL0</span><span class="p">,</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0x7FFF</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_warpcore_set_20G_KR2</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">bnx2x_phy</span> <span class="o">*</span><span class="n">phy</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;KR2 still not supported !!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_warpcore_set_20G_DXGXS</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">,</span>
					 <span class="k">struct</span> <span class="n">bnx2x_phy</span> <span class="o">*</span><span class="n">phy</span><span class="p">,</span>
					 <span class="n">u16</span> <span class="n">lane</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Rx0 anaRxControl1G */</span>
	<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_WC_DEVAD</span><span class="p">,</span>
			 <span class="n">MDIO_WC_REG_RX0_ANARXCONTROL1G</span><span class="p">,</span> <span class="mh">0x90</span><span class="p">);</span>

	<span class="cm">/* Rx2 anaRxControl1G */</span>
	<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_WC_DEVAD</span><span class="p">,</span>
			 <span class="n">MDIO_WC_REG_RX2_ANARXCONTROL1G</span><span class="p">,</span> <span class="mh">0x90</span><span class="p">);</span>

	<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_WC_DEVAD</span><span class="p">,</span>
			 <span class="n">MDIO_WC_REG_RX66_SCW0</span><span class="p">,</span> <span class="mh">0xE070</span><span class="p">);</span>

	<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_WC_DEVAD</span><span class="p">,</span>
			 <span class="n">MDIO_WC_REG_RX66_SCW1</span><span class="p">,</span> <span class="mh">0xC0D0</span><span class="p">);</span>

	<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_WC_DEVAD</span><span class="p">,</span>
			 <span class="n">MDIO_WC_REG_RX66_SCW2</span><span class="p">,</span> <span class="mh">0xA0B0</span><span class="p">);</span>

	<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_WC_DEVAD</span><span class="p">,</span>
			 <span class="n">MDIO_WC_REG_RX66_SCW3</span><span class="p">,</span> <span class="mh">0x8090</span><span class="p">);</span>

	<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_WC_DEVAD</span><span class="p">,</span>
			 <span class="n">MDIO_WC_REG_RX66_SCW0_MASK</span><span class="p">,</span> <span class="mh">0xF0F0</span><span class="p">);</span>

	<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_WC_DEVAD</span><span class="p">,</span>
			 <span class="n">MDIO_WC_REG_RX66_SCW1_MASK</span><span class="p">,</span> <span class="mh">0xF0F0</span><span class="p">);</span>

	<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_WC_DEVAD</span><span class="p">,</span>
			 <span class="n">MDIO_WC_REG_RX66_SCW2_MASK</span><span class="p">,</span> <span class="mh">0xF0F0</span><span class="p">);</span>

	<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_WC_DEVAD</span><span class="p">,</span>
			 <span class="n">MDIO_WC_REG_RX66_SCW3_MASK</span><span class="p">,</span> <span class="mh">0xF0F0</span><span class="p">);</span>

	<span class="cm">/* Serdes Digital Misc1 */</span>
	<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_WC_DEVAD</span><span class="p">,</span>
			 <span class="n">MDIO_WC_REG_SERDESDIGITAL_MISC1</span><span class="p">,</span> <span class="mh">0x6008</span><span class="p">);</span>

	<span class="cm">/* Serdes Digital4 Misc3 */</span>
	<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_WC_DEVAD</span><span class="p">,</span>
			 <span class="n">MDIO_WC_REG_DIGITAL4_MISC3</span><span class="p">,</span> <span class="mh">0x8088</span><span class="p">);</span>

	<span class="cm">/* Set Transmit PMD settings */</span>
	<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_WC_DEVAD</span><span class="p">,</span>
			 <span class="n">MDIO_WC_REG_TX_FIR_TAP</span><span class="p">,</span>
			<span class="p">((</span><span class="mh">0x12</span> <span class="o">&lt;&lt;</span> <span class="n">MDIO_WC_REG_TX_FIR_TAP_POST_TAP_OFFSET</span><span class="p">)</span> <span class="o">|</span>
			 <span class="p">(</span><span class="mh">0x2d</span> <span class="o">&lt;&lt;</span> <span class="n">MDIO_WC_REG_TX_FIR_TAP_MAIN_TAP_OFFSET</span><span class="p">)</span> <span class="o">|</span>
			 <span class="p">(</span><span class="mh">0x00</span> <span class="o">&lt;&lt;</span> <span class="n">MDIO_WC_REG_TX_FIR_TAP_PRE_TAP_OFFSET</span><span class="p">)</span> <span class="o">|</span>
			 <span class="n">MDIO_WC_REG_TX_FIR_TAP_ENABLE</span><span class="p">));</span>
	<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_WC_DEVAD</span><span class="p">,</span>
		      <span class="n">MDIO_WC_REG_TX0_TX_DRIVER</span> <span class="o">+</span> <span class="mh">0x10</span><span class="o">*</span><span class="n">lane</span><span class="p">,</span>
		     <span class="p">((</span><span class="mh">0x02</span> <span class="o">&lt;&lt;</span> <span class="n">MDIO_WC_REG_TX0_TX_DRIVER_POST2_COEFF_OFFSET</span><span class="p">)</span> <span class="o">|</span>
		      <span class="p">(</span><span class="mh">0x02</span> <span class="o">&lt;&lt;</span> <span class="n">MDIO_WC_REG_TX0_TX_DRIVER_IDRIVER_OFFSET</span><span class="p">)</span> <span class="o">|</span>
		      <span class="p">(</span><span class="mh">0x02</span> <span class="o">&lt;&lt;</span> <span class="n">MDIO_WC_REG_TX0_TX_DRIVER_IPRE_DRIVER_OFFSET</span><span class="p">)));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_warpcore_set_sgmii_speed</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x_phy</span> <span class="o">*</span><span class="n">phy</span><span class="p">,</span>
					   <span class="k">struct</span> <span class="n">link_params</span> <span class="o">*</span><span class="n">params</span><span class="p">,</span>
					   <span class="n">u8</span> <span class="n">fiber_mode</span><span class="p">,</span>
					   <span class="n">u8</span> <span class="n">always_autoneg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">bp</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">val16</span><span class="p">,</span> <span class="n">digctrl_kx1</span><span class="p">,</span> <span class="n">digctrl_kx2</span><span class="p">;</span>

	<span class="cm">/* Clear XFI clock comp in non-10G single lane mode. */</span>
	<span class="n">bnx2x_cl45_read</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_WC_DEVAD</span><span class="p">,</span>
			<span class="n">MDIO_WC_REG_RX66_CONTROL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val16</span><span class="p">);</span>
	<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_WC_DEVAD</span><span class="p">,</span>
			 <span class="n">MDIO_WC_REG_RX66_CONTROL</span><span class="p">,</span> <span class="n">val16</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="mi">3</span><span class="o">&lt;&lt;</span><span class="mi">13</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">always_autoneg</span> <span class="o">||</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">req_line_speed</span> <span class="o">==</span> <span class="n">SPEED_AUTO_NEG</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* SGMII Autoneg */</span>
		<span class="n">bnx2x_cl45_read</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_WC_DEVAD</span><span class="p">,</span>
				<span class="n">MDIO_WC_REG_COMBO_IEEE0_MIICTRL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val16</span><span class="p">);</span>
		<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_WC_DEVAD</span><span class="p">,</span>
				 <span class="n">MDIO_WC_REG_COMBO_IEEE0_MIICTRL</span><span class="p">,</span>
				 <span class="n">val16</span> <span class="o">|</span> <span class="mh">0x1000</span><span class="p">);</span>
		<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;set SGMII AUTONEG</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">bnx2x_cl45_read</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_WC_DEVAD</span><span class="p">,</span>
				<span class="n">MDIO_WC_REG_COMBO_IEEE0_MIICTRL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val16</span><span class="p">);</span>
		<span class="n">val16</span> <span class="o">&amp;=</span> <span class="mh">0xcebf</span><span class="p">;</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">req_line_speed</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">SPEED_10</span>:
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">SPEED_100</span>:
			<span class="n">val16</span> <span class="o">|=</span> <span class="mh">0x2000</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">SPEED_1000</span>:
			<span class="n">val16</span> <span class="o">|=</span> <span class="mh">0x0040</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span>
			   <span class="s">&quot;Speed not supported: 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">req_line_speed</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">req_duplex</span> <span class="o">==</span> <span class="n">DUPLEX_FULL</span><span class="p">)</span>
			<span class="n">val16</span> <span class="o">|=</span> <span class="mh">0x0100</span><span class="p">;</span>

		<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_WC_DEVAD</span><span class="p">,</span>
				<span class="n">MDIO_WC_REG_COMBO_IEEE0_MIICTRL</span><span class="p">,</span> <span class="n">val16</span><span class="p">);</span>

		<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;set SGMII force speed %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">phy</span><span class="o">-&gt;</span><span class="n">req_line_speed</span><span class="p">);</span>
		<span class="n">bnx2x_cl45_read</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_WC_DEVAD</span><span class="p">,</span>
				<span class="n">MDIO_WC_REG_COMBO_IEEE0_MIICTRL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val16</span><span class="p">);</span>
		<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;  (readback) %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">val16</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* SGMII Slave mode and disable signal detect */</span>
	<span class="n">bnx2x_cl45_read</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_WC_DEVAD</span><span class="p">,</span>
			<span class="n">MDIO_WC_REG_SERDESDIGITAL_CONTROL1000X1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">digctrl_kx1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fiber_mode</span><span class="p">)</span>
		<span class="n">digctrl_kx1</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">digctrl_kx1</span> <span class="o">&amp;=</span> <span class="mh">0xff4a</span><span class="p">;</span>

	<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_WC_DEVAD</span><span class="p">,</span>
			<span class="n">MDIO_WC_REG_SERDESDIGITAL_CONTROL1000X1</span><span class="p">,</span>
			<span class="n">digctrl_kx1</span><span class="p">);</span>

	<span class="cm">/* Turn off parallel detect */</span>
	<span class="n">bnx2x_cl45_read</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_WC_DEVAD</span><span class="p">,</span>
			<span class="n">MDIO_WC_REG_SERDESDIGITAL_CONTROL1000X2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">digctrl_kx2</span><span class="p">);</span>
	<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_WC_DEVAD</span><span class="p">,</span>
			<span class="n">MDIO_WC_REG_SERDESDIGITAL_CONTROL1000X2</span><span class="p">,</span>
			<span class="p">(</span><span class="n">digctrl_kx2</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">2</span><span class="p">)));</span>

	<span class="cm">/* Re-enable parallel detect */</span>
	<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_WC_DEVAD</span><span class="p">,</span>
			<span class="n">MDIO_WC_REG_SERDESDIGITAL_CONTROL1000X2</span><span class="p">,</span>
			<span class="p">(</span><span class="n">digctrl_kx2</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">2</span><span class="p">)));</span>

	<span class="cm">/* Enable autodet */</span>
	<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_WC_DEVAD</span><span class="p">,</span>
			<span class="n">MDIO_WC_REG_SERDESDIGITAL_CONTROL1000X1</span><span class="p">,</span>
			<span class="p">(</span><span class="n">digctrl_kx1</span> <span class="o">|</span> <span class="mh">0x10</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_warpcore_reset_lane</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">bnx2x_phy</span> <span class="o">*</span><span class="n">phy</span><span class="p">,</span>
				      <span class="n">u8</span> <span class="n">reset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">val</span><span class="p">;</span>
	<span class="cm">/* Take lane out of reset after configuration is finished */</span>
	<span class="n">bnx2x_cl45_read</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_WC_DEVAD</span><span class="p">,</span>
			<span class="n">MDIO_WC_REG_DIGITAL5_MISC6</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reset</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="mh">0xC000</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">val</span> <span class="o">&amp;=</span> <span class="mh">0x3FFF</span><span class="p">;</span>
	<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_WC_DEVAD</span><span class="p">,</span>
			 <span class="n">MDIO_WC_REG_DIGITAL5_MISC6</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="n">bnx2x_cl45_read</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_WC_DEVAD</span><span class="p">,</span>
			 <span class="n">MDIO_WC_REG_DIGITAL5_MISC6</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
<span class="p">}</span>
<span class="cm">/* Clear SFI/XFI link settings registers */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_warpcore_clear_regs</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x_phy</span> <span class="o">*</span><span class="n">phy</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">link_params</span> <span class="o">*</span><span class="n">params</span><span class="p">,</span>
				      <span class="n">u16</span> <span class="n">lane</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">bp</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">val16</span><span class="p">;</span>

	<span class="cm">/* Set XFI clock comp as default. */</span>
	<span class="n">bnx2x_cl45_read</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_WC_DEVAD</span><span class="p">,</span>
			<span class="n">MDIO_WC_REG_RX66_CONTROL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val16</span><span class="p">);</span>
	<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_WC_DEVAD</span><span class="p">,</span>
			 <span class="n">MDIO_WC_REG_RX66_CONTROL</span><span class="p">,</span> <span class="n">val16</span> <span class="o">|</span> <span class="p">(</span><span class="mi">3</span><span class="o">&lt;&lt;</span><span class="mi">13</span><span class="p">));</span>

	<span class="n">bnx2x_warpcore_reset_lane</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_AN_DEVAD</span><span class="p">,</span> <span class="n">MDIO_AN_REG_CTRL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_WC_DEVAD</span><span class="p">,</span>
			 <span class="n">MDIO_WC_REG_FX100_CTRL1</span><span class="p">,</span> <span class="mh">0x014a</span><span class="p">);</span>
	<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_WC_DEVAD</span><span class="p">,</span>
			 <span class="n">MDIO_WC_REG_FX100_CTRL3</span><span class="p">,</span> <span class="mh">0x0800</span><span class="p">);</span>
	<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_WC_DEVAD</span><span class="p">,</span>
			 <span class="n">MDIO_WC_REG_DIGITAL4_MISC3</span><span class="p">,</span> <span class="mh">0x8008</span><span class="p">);</span>
	<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_WC_DEVAD</span><span class="p">,</span>
			 <span class="n">MDIO_WC_REG_SERDESDIGITAL_CONTROL1000X1</span><span class="p">,</span> <span class="mh">0x0195</span><span class="p">);</span>
	<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_WC_DEVAD</span><span class="p">,</span>
			 <span class="n">MDIO_WC_REG_SERDESDIGITAL_CONTROL1000X2</span><span class="p">,</span> <span class="mh">0x0007</span><span class="p">);</span>
	<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_WC_DEVAD</span><span class="p">,</span>
			 <span class="n">MDIO_WC_REG_SERDESDIGITAL_CONTROL1000X3</span><span class="p">,</span> <span class="mh">0x0002</span><span class="p">);</span>
	<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_WC_DEVAD</span><span class="p">,</span>
			 <span class="n">MDIO_WC_REG_SERDESDIGITAL_MISC1</span><span class="p">,</span> <span class="mh">0x6000</span><span class="p">);</span>
	<span class="n">lane</span> <span class="o">=</span> <span class="n">bnx2x_get_warpcore_lane</span><span class="p">(</span><span class="n">phy</span><span class="p">,</span> <span class="n">params</span><span class="p">);</span>
	<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_WC_DEVAD</span><span class="p">,</span>
			 <span class="n">MDIO_WC_REG_TX_FIR_TAP</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
	<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_WC_DEVAD</span><span class="p">,</span>
			 <span class="n">MDIO_WC_REG_TX0_TX_DRIVER</span> <span class="o">+</span> <span class="mh">0x10</span><span class="o">*</span><span class="n">lane</span><span class="p">,</span> <span class="mh">0x0990</span><span class="p">);</span>
	<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_WC_DEVAD</span><span class="p">,</span>
			 <span class="n">MDIO_WC_REG_IEEE0BLK_MIICNTL</span><span class="p">,</span> <span class="mh">0x2040</span><span class="p">);</span>
	<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_WC_DEVAD</span><span class="p">,</span>
			 <span class="n">MDIO_WC_REG_COMBO_IEEE0_MIICTRL</span><span class="p">,</span> <span class="mh">0x0140</span><span class="p">);</span>
	<span class="n">bnx2x_warpcore_reset_lane</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bnx2x_get_mod_abs_int_cfg</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">,</span>
						<span class="n">u32</span> <span class="n">chip_id</span><span class="p">,</span>
						<span class="n">u32</span> <span class="n">shmem_base</span><span class="p">,</span> <span class="n">u8</span> <span class="n">port</span><span class="p">,</span>
						<span class="n">u8</span> <span class="o">*</span><span class="n">gpio_num</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">gpio_port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">cfg_pin</span><span class="p">;</span>
	<span class="o">*</span><span class="n">gpio_num</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="o">*</span><span class="n">gpio_port</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">CHIP_IS_E3</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">cfg_pin</span> <span class="o">=</span> <span class="p">(</span><span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">shmem_base</span> <span class="o">+</span>
				<span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">shmem_region</span><span class="p">,</span>
				<span class="n">dev_info</span><span class="p">.</span><span class="n">port_hw_config</span><span class="p">[</span><span class="n">port</span><span class="p">].</span><span class="n">e3_sfp_ctrl</span><span class="p">))</span> <span class="o">&amp;</span>
				<span class="n">PORT_HW_CFG_E3_MOD_ABS_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span>
				<span class="n">PORT_HW_CFG_E3_MOD_ABS_SHIFT</span><span class="p">;</span>

		<span class="cm">/* Should not happen. This function called upon interrupt</span>
<span class="cm">		 * triggered by GPIO ( since EPIO can only generate interrupts</span>
<span class="cm">		 * to MCP).</span>
<span class="cm">		 * So if this function was called and none of the GPIOs was set,</span>
<span class="cm">		 * it means the shit hit the fan.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">cfg_pin</span> <span class="o">&lt;</span> <span class="n">PIN_CFG_GPIO0_P0</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">cfg_pin</span> <span class="o">&gt;</span> <span class="n">PIN_CFG_GPIO3_P1</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span>
			   <span class="s">&quot;ERROR: Invalid cfg pin %x for module detect indication</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">cfg_pin</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="o">*</span><span class="n">gpio_num</span> <span class="o">=</span> <span class="p">(</span><span class="n">cfg_pin</span> <span class="o">-</span> <span class="n">PIN_CFG_GPIO0_P0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3</span><span class="p">;</span>
		<span class="o">*</span><span class="n">gpio_port</span> <span class="o">=</span> <span class="p">(</span><span class="n">cfg_pin</span> <span class="o">-</span> <span class="n">PIN_CFG_GPIO0_P0</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">gpio_num</span> <span class="o">=</span> <span class="n">MISC_REGISTERS_GPIO_3</span><span class="p">;</span>
		<span class="o">*</span><span class="n">gpio_port</span> <span class="o">=</span> <span class="n">port</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;MOD_ABS int GPIO%d_P%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">gpio_num</span><span class="p">,</span> <span class="o">*</span><span class="n">gpio_port</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bnx2x_is_sfp_module_plugged</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x_phy</span> <span class="o">*</span><span class="n">phy</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">link_params</span> <span class="o">*</span><span class="n">params</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">bp</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">gpio_num</span><span class="p">,</span> <span class="n">gpio_port</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">gpio_val</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bnx2x_get_mod_abs_int_cfg</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">chip_id</span><span class="p">,</span>
				      <span class="n">params</span><span class="o">-&gt;</span><span class="n">shmem_base</span><span class="p">,</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span>
				      <span class="o">&amp;</span><span class="n">gpio_num</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gpio_port</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">gpio_val</span> <span class="o">=</span> <span class="n">bnx2x_get_gpio</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">gpio_num</span><span class="p">,</span> <span class="n">gpio_port</span><span class="p">);</span>

	<span class="cm">/* Call the handling function in case module is detected */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">gpio_val</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">bnx2x_warpcore_get_sigdet</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x_phy</span> <span class="o">*</span><span class="n">phy</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">link_params</span> <span class="o">*</span><span class="n">params</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">gp2_status_reg0</span><span class="p">,</span> <span class="n">lane</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">bp</span><span class="p">;</span>

	<span class="n">lane</span> <span class="o">=</span> <span class="n">bnx2x_get_warpcore_lane</span><span class="p">(</span><span class="n">phy</span><span class="p">,</span> <span class="n">params</span><span class="p">);</span>

	<span class="n">bnx2x_cl45_read</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_WC_DEVAD</span><span class="p">,</span> <span class="n">MDIO_WC_REG_GP2_STATUS_GP_2_0</span><span class="p">,</span>
				 <span class="o">&amp;</span><span class="n">gp2_status_reg0</span><span class="p">);</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">gp2_status_reg0</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="mi">8</span><span class="o">+</span><span class="n">lane</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_warpcore_config_runtime</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x_phy</span> <span class="o">*</span><span class="n">phy</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">link_params</span> <span class="o">*</span><span class="n">params</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">link_vars</span> <span class="o">*</span><span class="n">vars</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">bp</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">serdes_net_if</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">gp_status1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">lnkup</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">lnkup_kr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">lane</span> <span class="o">=</span> <span class="n">bnx2x_get_warpcore_lane</span><span class="p">(</span><span class="n">phy</span><span class="p">,</span> <span class="n">params</span><span class="p">);</span>

	<span class="n">vars</span><span class="o">-&gt;</span><span class="n">turn_to_run_wc_rt</span> <span class="o">=</span> <span class="n">vars</span><span class="o">-&gt;</span><span class="n">turn_to_run_wc_rt</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vars</span><span class="o">-&gt;</span><span class="n">turn_to_run_wc_rt</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* return if there is no link partner */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">bnx2x_warpcore_get_sigdet</span><span class="p">(</span><span class="n">phy</span><span class="p">,</span> <span class="n">params</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;bnx2x_warpcore_get_sigdet false</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vars</span><span class="o">-&gt;</span><span class="n">rx_tx_asic_rst</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">serdes_net_if</span> <span class="o">=</span> <span class="p">(</span><span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">shmem_base</span> <span class="o">+</span>
				<span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">shmem_region</span><span class="p">,</span> <span class="n">dev_info</span><span class="p">.</span>
				<span class="n">port_hw_config</span><span class="p">[</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">].</span><span class="n">default_cfg</span><span class="p">))</span> <span class="o">&amp;</span>
				<span class="n">PORT_HW_CFG_NET_SERDES_IF_MASK</span><span class="p">);</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">serdes_net_if</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">PORT_HW_CFG_NET_SERDES_IF_KR</span>:
			<span class="cm">/* Do we get link yet? */</span>
			<span class="n">bnx2x_cl45_read</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_WC_DEVAD</span><span class="p">,</span> <span class="mh">0x81d1</span><span class="p">,</span>
								<span class="o">&amp;</span><span class="n">gp_status1</span><span class="p">);</span>
			<span class="n">lnkup</span> <span class="o">=</span> <span class="p">(</span><span class="n">gp_status1</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="mi">8</span><span class="o">+</span><span class="n">lane</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">;</span><span class="cm">/* 1G */</span>
				<span class="cm">/*10G KR*/</span>
			<span class="n">lnkup_kr</span> <span class="o">=</span> <span class="p">(</span><span class="n">gp_status1</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="mi">12</span><span class="o">+</span><span class="n">lane</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">;</span>

			<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span>
				<span class="s">&quot;gp_status1 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">gp_status1</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">lnkup_kr</span> <span class="o">||</span> <span class="n">lnkup</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">vars</span><span class="o">-&gt;</span><span class="n">rx_tx_asic_rst</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
					<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span>
					<span class="s">&quot;link up, rx_tx_asic_rst 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">vars</span><span class="o">-&gt;</span><span class="n">rx_tx_asic_rst</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="cm">/* Reset the lane to see if link comes up.*/</span>
				<span class="n">bnx2x_warpcore_reset_lane</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
				<span class="n">bnx2x_warpcore_reset_lane</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

				<span class="cm">/* restart Autoneg */</span>
				<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_AN_DEVAD</span><span class="p">,</span>
					<span class="n">MDIO_WC_REG_IEEE0BLK_MIICNTL</span><span class="p">,</span> <span class="mh">0x1200</span><span class="p">);</span>

				<span class="n">vars</span><span class="o">-&gt;</span><span class="n">rx_tx_asic_rst</span><span class="o">--</span><span class="p">;</span>
				<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;0x%x retry left</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">vars</span><span class="o">-&gt;</span><span class="n">rx_tx_asic_rst</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="nl">default:</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

	<span class="p">}</span> <span class="cm">/*params-&gt;rx_tx_asic_rst*/</span>

<span class="p">}</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_warpcore_config_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x_phy</span> <span class="o">*</span><span class="n">phy</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">link_params</span> <span class="o">*</span><span class="n">params</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">link_vars</span> <span class="o">*</span><span class="n">vars</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">bp</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">serdes_net_if</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">fiber_mode</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">lane</span> <span class="o">=</span> <span class="n">bnx2x_get_warpcore_lane</span><span class="p">(</span><span class="n">phy</span><span class="p">,</span> <span class="n">params</span><span class="p">);</span>
	<span class="n">serdes_net_if</span> <span class="o">=</span> <span class="p">(</span><span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">shmem_base</span> <span class="o">+</span>
			 <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">shmem_region</span><span class="p">,</span> <span class="n">dev_info</span><span class="p">.</span>
				  <span class="n">port_hw_config</span><span class="p">[</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">].</span><span class="n">default_cfg</span><span class="p">))</span> <span class="o">&amp;</span>
			 <span class="n">PORT_HW_CFG_NET_SERDES_IF_MASK</span><span class="p">);</span>
	<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;Begin Warpcore init, link_speed %d, &quot;</span>
			   <span class="s">&quot;serdes_net_if = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">vars</span><span class="o">-&gt;</span><span class="n">line_speed</span><span class="p">,</span> <span class="n">serdes_net_if</span><span class="p">);</span>
	<span class="n">bnx2x_set_aer_mmd</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">phy</span><span class="p">);</span>

	<span class="n">vars</span><span class="o">-&gt;</span><span class="n">phy_flags</span> <span class="o">|=</span> <span class="n">PHY_XGXS_FLAG</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">serdes_net_if</span> <span class="o">==</span> <span class="n">PORT_HW_CFG_NET_SERDES_IF_SGMII</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">req_line_speed</span> <span class="o">&amp;&amp;</span>
	     <span class="p">((</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">req_line_speed</span> <span class="o">==</span> <span class="n">SPEED_100</span><span class="p">)</span> <span class="o">||</span>
	      <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">req_line_speed</span> <span class="o">==</span> <span class="n">SPEED_10</span><span class="p">))))</span> <span class="p">{</span>
		<span class="n">vars</span><span class="o">-&gt;</span><span class="n">phy_flags</span> <span class="o">|=</span> <span class="n">PHY_SGMII_FLAG</span><span class="p">;</span>
		<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;Setting SGMII mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">bnx2x_warpcore_clear_regs</span><span class="p">(</span><span class="n">phy</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">lane</span><span class="p">);</span>
		<span class="n">bnx2x_warpcore_set_sgmii_speed</span><span class="p">(</span><span class="n">phy</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">serdes_net_if</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">PORT_HW_CFG_NET_SERDES_IF_KR</span>:
			<span class="cm">/* Enable KR Auto Neg */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">loopback_mode</span> <span class="o">!=</span> <span class="n">LOOPBACK_EXT</span><span class="p">)</span>
				<span class="n">bnx2x_warpcore_enable_AN_KR</span><span class="p">(</span><span class="n">phy</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">vars</span><span class="p">);</span>
			<span class="k">else</span> <span class="p">{</span>
				<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;Setting KR 10G-Force</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">bnx2x_warpcore_set_10G_KR</span><span class="p">(</span><span class="n">phy</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">vars</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">PORT_HW_CFG_NET_SERDES_IF_XFI</span>:
			<span class="n">bnx2x_warpcore_clear_regs</span><span class="p">(</span><span class="n">phy</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">lane</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">vars</span><span class="o">-&gt;</span><span class="n">line_speed</span> <span class="o">==</span> <span class="n">SPEED_10000</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;Setting 10G XFI</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">bnx2x_warpcore_set_10G_XFI</span><span class="p">(</span><span class="n">phy</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">SINGLE_MEDIA_DIRECT</span><span class="p">(</span><span class="n">params</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;1G Fiber</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
					<span class="n">fiber_mode</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;10/100/1G SGMII</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
					<span class="n">fiber_mode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">bnx2x_warpcore_set_sgmii_speed</span><span class="p">(</span><span class="n">phy</span><span class="p">,</span>
								<span class="n">params</span><span class="p">,</span>
								<span class="n">fiber_mode</span><span class="p">,</span>
								<span class="mi">0</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">PORT_HW_CFG_NET_SERDES_IF_SFI</span>:

			<span class="n">bnx2x_warpcore_clear_regs</span><span class="p">(</span><span class="n">phy</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">lane</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">vars</span><span class="o">-&gt;</span><span class="n">line_speed</span> <span class="o">==</span> <span class="n">SPEED_10000</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;Setting 10G SFI</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">bnx2x_warpcore_set_10G_XFI</span><span class="p">(</span><span class="n">phy</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">vars</span><span class="o">-&gt;</span><span class="n">line_speed</span> <span class="o">==</span> <span class="n">SPEED_1000</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;Setting 1G Fiber</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">bnx2x_warpcore_set_sgmii_speed</span><span class="p">(</span>
						<span class="n">phy</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="cm">/* Issue Module detection */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">bnx2x_is_sfp_module_plugged</span><span class="p">(</span><span class="n">phy</span><span class="p">,</span> <span class="n">params</span><span class="p">))</span>
				<span class="n">bnx2x_sfp_module_detection</span><span class="p">(</span><span class="n">phy</span><span class="p">,</span> <span class="n">params</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">PORT_HW_CFG_NET_SERDES_IF_DXGXS</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">vars</span><span class="o">-&gt;</span><span class="n">line_speed</span> <span class="o">!=</span> <span class="n">SPEED_20000</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;Speed not supported yet</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">return</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;Setting 20G DXGXS</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">bnx2x_warpcore_set_20G_DXGXS</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">lane</span><span class="p">);</span>
			<span class="cm">/* Issue Module detection */</span>

			<span class="n">bnx2x_sfp_module_detection</span><span class="p">(</span><span class="n">phy</span><span class="p">,</span> <span class="n">params</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">PORT_HW_CFG_NET_SERDES_IF_KR2</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">vars</span><span class="o">-&gt;</span><span class="n">line_speed</span> <span class="o">!=</span> <span class="n">SPEED_20000</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;Speed not supported yet</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">return</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;Setting 20G KR2</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">bnx2x_warpcore_set_20G_KR2</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="nl">default:</span>
			<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span>
			   <span class="s">&quot;Unsupported Serdes Net Interface 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">serdes_net_if</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Take lane out of reset after configuration is finished */</span>
	<span class="n">bnx2x_warpcore_reset_lane</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;Exit config init</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_sfp_e3_set_transmitter</span><span class="p">(</span><span class="k">struct</span> <span class="n">link_params</span> <span class="o">*</span><span class="n">params</span><span class="p">,</span>
					 <span class="k">struct</span> <span class="n">bnx2x_phy</span> <span class="o">*</span><span class="n">phy</span><span class="p">,</span>
					 <span class="n">u8</span> <span class="n">tx_en</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">bp</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">cfg_pin</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">port</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>

	<span class="n">cfg_pin</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">shmem_base</span> <span class="o">+</span>
				<span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">shmem_region</span><span class="p">,</span>
				<span class="n">dev_info</span><span class="p">.</span><span class="n">port_hw_config</span><span class="p">[</span><span class="n">port</span><span class="p">].</span><span class="n">e3_sfp_ctrl</span><span class="p">))</span> <span class="o">&amp;</span>
				<span class="n">PORT_HW_CFG_TX_LASER_MASK</span><span class="p">;</span>
	<span class="cm">/* Set the !tx_en since this pin is DISABLE_TX_LASER */</span>
	<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;Setting WC TX to %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tx_en</span><span class="p">);</span>
	<span class="cm">/* For 20G, the expected pin to be used is 3 pins after the current */</span>

	<span class="n">bnx2x_set_cfg_pin</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">cfg_pin</span><span class="p">,</span> <span class="n">tx_en</span> <span class="o">^</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">speed_cap_mask</span> <span class="o">&amp;</span> <span class="n">PORT_HW_CFG_SPEED_CAPABILITY_D0_20G</span><span class="p">)</span>
		<span class="n">bnx2x_set_cfg_pin</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">cfg_pin</span> <span class="o">+</span> <span class="mi">3</span><span class="p">,</span> <span class="n">tx_en</span> <span class="o">^</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_warpcore_link_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x_phy</span> <span class="o">*</span><span class="n">phy</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">link_params</span> <span class="o">*</span><span class="n">params</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">bp</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">val16</span><span class="p">;</span>
	<span class="n">bnx2x_sfp_e3_set_transmitter</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">bnx2x_set_mdio_clk</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">chip_id</span><span class="p">,</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">);</span>
	<span class="n">bnx2x_set_aer_mmd</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">phy</span><span class="p">);</span>
	<span class="cm">/* Global register */</span>
	<span class="n">bnx2x_warpcore_reset_lane</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* Clear loopback settings (if any) */</span>
	<span class="cm">/* 10G &amp; 20G */</span>
	<span class="n">bnx2x_cl45_read</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_WC_DEVAD</span><span class="p">,</span>
			<span class="n">MDIO_WC_REG_COMBO_IEEE0_MIICTRL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val16</span><span class="p">);</span>
	<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_WC_DEVAD</span><span class="p">,</span>
			 <span class="n">MDIO_WC_REG_COMBO_IEEE0_MIICTRL</span><span class="p">,</span> <span class="n">val16</span> <span class="o">&amp;</span>
			 <span class="mh">0xBFFF</span><span class="p">);</span>

	<span class="n">bnx2x_cl45_read</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_WC_DEVAD</span><span class="p">,</span>
			<span class="n">MDIO_WC_REG_IEEE0BLK_MIICNTL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val16</span><span class="p">);</span>
	<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_WC_DEVAD</span><span class="p">,</span>
			<span class="n">MDIO_WC_REG_IEEE0BLK_MIICNTL</span><span class="p">,</span> <span class="n">val16</span> <span class="o">&amp;</span> <span class="mh">0xfffe</span><span class="p">);</span>

	<span class="cm">/* Update those 1-copy registers */</span>
	<span class="n">CL22_WR_OVER_CL45</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_REG_BANK_AER_BLOCK</span><span class="p">,</span>
			  <span class="n">MDIO_AER_BLOCK_AER_REG</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="cm">/* Enable 1G MDIO (1-copy) */</span>
	<span class="n">bnx2x_cl45_read</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_WC_DEVAD</span><span class="p">,</span>
			<span class="n">MDIO_WC_REG_XGXSBLK0_XGXSCONTROL</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">val16</span><span class="p">);</span>
	<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_WC_DEVAD</span><span class="p">,</span>
			 <span class="n">MDIO_WC_REG_XGXSBLK0_XGXSCONTROL</span><span class="p">,</span>
			 <span class="n">val16</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x10</span><span class="p">);</span>

	<span class="n">bnx2x_cl45_read</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_WC_DEVAD</span><span class="p">,</span>
			<span class="n">MDIO_WC_REG_XGXSBLK1_LANECTRL2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val16</span><span class="p">);</span>
	<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_WC_DEVAD</span><span class="p">,</span>
			 <span class="n">MDIO_WC_REG_XGXSBLK1_LANECTRL2</span><span class="p">,</span>
			 <span class="n">val16</span> <span class="o">&amp;</span> <span class="mh">0xff00</span><span class="p">);</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_set_warpcore_loopback</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x_phy</span> <span class="o">*</span><span class="n">phy</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">link_params</span> <span class="o">*</span><span class="n">params</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">bp</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">val16</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">lane</span><span class="p">;</span>
	<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;Setting Warpcore loopback type %x, speed %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">params</span><span class="o">-&gt;</span><span class="n">loopback_mode</span><span class="p">,</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">req_line_speed</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">req_line_speed</span> <span class="o">&lt;</span> <span class="n">SPEED_10000</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* 10/100/1000 */</span>

		<span class="cm">/* Update those 1-copy registers */</span>
		<span class="n">CL22_WR_OVER_CL45</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_REG_BANK_AER_BLOCK</span><span class="p">,</span>
				  <span class="n">MDIO_AER_BLOCK_AER_REG</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="cm">/* Enable 1G MDIO (1-copy) */</span>
		<span class="n">bnx2x_cl45_read</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_WC_DEVAD</span><span class="p">,</span>
				<span class="n">MDIO_WC_REG_XGXSBLK0_XGXSCONTROL</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">val16</span><span class="p">);</span>
		<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_WC_DEVAD</span><span class="p">,</span>
				<span class="n">MDIO_WC_REG_XGXSBLK0_XGXSCONTROL</span><span class="p">,</span>
				<span class="n">val16</span> <span class="o">|</span> <span class="mh">0x10</span><span class="p">);</span>
		<span class="cm">/* Set 1G loopback based on lane (1-copy) */</span>
		<span class="n">lane</span> <span class="o">=</span> <span class="n">bnx2x_get_warpcore_lane</span><span class="p">(</span><span class="n">phy</span><span class="p">,</span> <span class="n">params</span><span class="p">);</span>
		<span class="n">bnx2x_cl45_read</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_WC_DEVAD</span><span class="p">,</span>
				<span class="n">MDIO_WC_REG_XGXSBLK1_LANECTRL2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val16</span><span class="p">);</span>
		<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_WC_DEVAD</span><span class="p">,</span>
				<span class="n">MDIO_WC_REG_XGXSBLK1_LANECTRL2</span><span class="p">,</span>
				<span class="n">val16</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">lane</span><span class="p">));</span>

		<span class="cm">/* Switch back to 4-copy registers */</span>
		<span class="n">bnx2x_set_aer_mmd</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">phy</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* 10G &amp; 20G */</span>
		<span class="n">bnx2x_cl45_read</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_WC_DEVAD</span><span class="p">,</span>
				<span class="n">MDIO_WC_REG_COMBO_IEEE0_MIICTRL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val16</span><span class="p">);</span>
		<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_WC_DEVAD</span><span class="p">,</span>
				<span class="n">MDIO_WC_REG_COMBO_IEEE0_MIICTRL</span><span class="p">,</span> <span class="n">val16</span> <span class="o">|</span>
				 <span class="mh">0x4000</span><span class="p">);</span>

		<span class="n">bnx2x_cl45_read</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_WC_DEVAD</span><span class="p">,</span>
				<span class="n">MDIO_WC_REG_IEEE0BLK_MIICNTL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val16</span><span class="p">);</span>
		<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_WC_DEVAD</span><span class="p">,</span>
				<span class="n">MDIO_WC_REG_IEEE0BLK_MIICNTL</span><span class="p">,</span> <span class="n">val16</span> <span class="o">|</span> <span class="mh">0x1</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="kt">void</span> <span class="nf">bnx2x_sync_link</span><span class="p">(</span><span class="k">struct</span> <span class="n">link_params</span> <span class="o">*</span><span class="n">params</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">link_vars</span> <span class="o">*</span><span class="n">vars</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">bp</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">link_10g_plus</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vars</span><span class="o">-&gt;</span><span class="n">link_status</span> <span class="o">&amp;</span> <span class="n">LINK_STATUS_PHYSICAL_LINK_FLAG</span><span class="p">)</span>
		<span class="n">vars</span><span class="o">-&gt;</span><span class="n">phy_flags</span> <span class="o">|=</span> <span class="n">PHY_PHYSICAL_LINK_FLAG</span><span class="p">;</span>
	<span class="n">vars</span><span class="o">-&gt;</span><span class="n">link_up</span> <span class="o">=</span> <span class="p">(</span><span class="n">vars</span><span class="o">-&gt;</span><span class="n">link_status</span> <span class="o">&amp;</span> <span class="n">LINK_STATUS_LINK_UP</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vars</span><span class="o">-&gt;</span><span class="n">link_up</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;phy link up</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="n">vars</span><span class="o">-&gt;</span><span class="n">phy_link_up</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">vars</span><span class="o">-&gt;</span><span class="n">duplex</span> <span class="o">=</span> <span class="n">DUPLEX_FULL</span><span class="p">;</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">vars</span><span class="o">-&gt;</span><span class="n">link_status</span> <span class="o">&amp;</span>
			<span class="n">LINK_STATUS_SPEED_AND_DUPLEX_MASK</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">LINK_10THD</span>:
			<span class="n">vars</span><span class="o">-&gt;</span><span class="n">duplex</span> <span class="o">=</span> <span class="n">DUPLEX_HALF</span><span class="p">;</span>
			<span class="cm">/* Fall thru */</span>
		<span class="k">case</span> <span class="n">LINK_10TFD</span>:
			<span class="n">vars</span><span class="o">-&gt;</span><span class="n">line_speed</span> <span class="o">=</span> <span class="n">SPEED_10</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">LINK_100TXHD</span>:
			<span class="n">vars</span><span class="o">-&gt;</span><span class="n">duplex</span> <span class="o">=</span> <span class="n">DUPLEX_HALF</span><span class="p">;</span>
			<span class="cm">/* Fall thru */</span>
		<span class="k">case</span> <span class="n">LINK_100T4</span>:
		<span class="k">case</span> <span class="n">LINK_100TXFD</span>:
			<span class="n">vars</span><span class="o">-&gt;</span><span class="n">line_speed</span> <span class="o">=</span> <span class="n">SPEED_100</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">LINK_1000THD</span>:
			<span class="n">vars</span><span class="o">-&gt;</span><span class="n">duplex</span> <span class="o">=</span> <span class="n">DUPLEX_HALF</span><span class="p">;</span>
			<span class="cm">/* Fall thru */</span>
		<span class="k">case</span> <span class="n">LINK_1000TFD</span>:
			<span class="n">vars</span><span class="o">-&gt;</span><span class="n">line_speed</span> <span class="o">=</span> <span class="n">SPEED_1000</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">LINK_2500THD</span>:
			<span class="n">vars</span><span class="o">-&gt;</span><span class="n">duplex</span> <span class="o">=</span> <span class="n">DUPLEX_HALF</span><span class="p">;</span>
			<span class="cm">/* Fall thru */</span>
		<span class="k">case</span> <span class="n">LINK_2500TFD</span>:
			<span class="n">vars</span><span class="o">-&gt;</span><span class="n">line_speed</span> <span class="o">=</span> <span class="n">SPEED_2500</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">LINK_10GTFD</span>:
			<span class="n">vars</span><span class="o">-&gt;</span><span class="n">line_speed</span> <span class="o">=</span> <span class="n">SPEED_10000</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">LINK_20GTFD</span>:
			<span class="n">vars</span><span class="o">-&gt;</span><span class="n">line_speed</span> <span class="o">=</span> <span class="n">SPEED_20000</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">vars</span><span class="o">-&gt;</span><span class="n">flow_ctrl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vars</span><span class="o">-&gt;</span><span class="n">link_status</span> <span class="o">&amp;</span> <span class="n">LINK_STATUS_TX_FLOW_CONTROL_ENABLED</span><span class="p">)</span>
			<span class="n">vars</span><span class="o">-&gt;</span><span class="n">flow_ctrl</span> <span class="o">|=</span> <span class="n">BNX2X_FLOW_CTRL_TX</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">vars</span><span class="o">-&gt;</span><span class="n">link_status</span> <span class="o">&amp;</span> <span class="n">LINK_STATUS_RX_FLOW_CONTROL_ENABLED</span><span class="p">)</span>
			<span class="n">vars</span><span class="o">-&gt;</span><span class="n">flow_ctrl</span> <span class="o">|=</span> <span class="n">BNX2X_FLOW_CTRL_RX</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vars</span><span class="o">-&gt;</span><span class="n">flow_ctrl</span><span class="p">)</span>
			<span class="n">vars</span><span class="o">-&gt;</span><span class="n">flow_ctrl</span> <span class="o">=</span> <span class="n">BNX2X_FLOW_CTRL_NONE</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">vars</span><span class="o">-&gt;</span><span class="n">line_speed</span> <span class="o">&amp;&amp;</span>
		    <span class="p">((</span><span class="n">vars</span><span class="o">-&gt;</span><span class="n">line_speed</span> <span class="o">==</span> <span class="n">SPEED_10</span><span class="p">)</span> <span class="o">||</span>
		     <span class="p">(</span><span class="n">vars</span><span class="o">-&gt;</span><span class="n">line_speed</span> <span class="o">==</span> <span class="n">SPEED_100</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">vars</span><span class="o">-&gt;</span><span class="n">phy_flags</span> <span class="o">|=</span> <span class="n">PHY_SGMII_FLAG</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">vars</span><span class="o">-&gt;</span><span class="n">phy_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PHY_SGMII_FLAG</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vars</span><span class="o">-&gt;</span><span class="n">line_speed</span> <span class="o">&amp;&amp;</span>
		    <span class="n">USES_WARPCORE</span><span class="p">(</span><span class="n">bp</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">vars</span><span class="o">-&gt;</span><span class="n">line_speed</span> <span class="o">==</span> <span class="n">SPEED_1000</span><span class="p">))</span>
			<span class="n">vars</span><span class="o">-&gt;</span><span class="n">phy_flags</span> <span class="o">|=</span> <span class="n">PHY_SGMII_FLAG</span><span class="p">;</span>
		<span class="cm">/* anything 10 and over uses the bmac */</span>
		<span class="n">link_10g_plus</span> <span class="o">=</span> <span class="p">(</span><span class="n">vars</span><span class="o">-&gt;</span><span class="n">line_speed</span> <span class="o">&gt;=</span> <span class="n">SPEED_10000</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">link_10g_plus</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">USES_WARPCORE</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span>
				<span class="n">vars</span><span class="o">-&gt;</span><span class="n">mac_type</span> <span class="o">=</span> <span class="n">MAC_TYPE_XMAC</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">vars</span><span class="o">-&gt;</span><span class="n">mac_type</span> <span class="o">=</span> <span class="n">MAC_TYPE_BMAC</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">USES_WARPCORE</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span>
				<span class="n">vars</span><span class="o">-&gt;</span><span class="n">mac_type</span> <span class="o">=</span> <span class="n">MAC_TYPE_UMAC</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">vars</span><span class="o">-&gt;</span><span class="n">mac_type</span> <span class="o">=</span> <span class="n">MAC_TYPE_EMAC</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="cm">/* link down */</span>
		<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;phy link down</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="n">vars</span><span class="o">-&gt;</span><span class="n">phy_link_up</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">vars</span><span class="o">-&gt;</span><span class="n">line_speed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">vars</span><span class="o">-&gt;</span><span class="n">duplex</span> <span class="o">=</span> <span class="n">DUPLEX_FULL</span><span class="p">;</span>
		<span class="n">vars</span><span class="o">-&gt;</span><span class="n">flow_ctrl</span> <span class="o">=</span> <span class="n">BNX2X_FLOW_CTRL_NONE</span><span class="p">;</span>

		<span class="cm">/* indicate no mac active */</span>
		<span class="n">vars</span><span class="o">-&gt;</span><span class="n">mac_type</span> <span class="o">=</span> <span class="n">MAC_TYPE_NONE</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vars</span><span class="o">-&gt;</span><span class="n">link_status</span> <span class="o">&amp;</span> <span class="n">LINK_STATUS_PHYSICAL_LINK_FLAG</span><span class="p">)</span>
			<span class="n">vars</span><span class="o">-&gt;</span><span class="n">phy_flags</span> <span class="o">|=</span> <span class="n">PHY_HALF_OPEN_CONN_FLAG</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">bnx2x_link_status_update</span><span class="p">(</span><span class="k">struct</span> <span class="n">link_params</span> <span class="o">*</span><span class="n">params</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">link_vars</span> <span class="o">*</span><span class="n">vars</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">bp</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">port</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">sync_offset</span><span class="p">,</span> <span class="n">media_types</span><span class="p">;</span>
	<span class="cm">/* Update PHY configuration */</span>
	<span class="n">set_phy_vars</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">vars</span><span class="p">);</span>

	<span class="n">vars</span><span class="o">-&gt;</span><span class="n">link_status</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">shmem_base</span> <span class="o">+</span>
				   <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">shmem_region</span><span class="p">,</span>
					    <span class="n">port_mb</span><span class="p">[</span><span class="n">port</span><span class="p">].</span><span class="n">link_status</span><span class="p">));</span>

	<span class="n">vars</span><span class="o">-&gt;</span><span class="n">phy_flags</span> <span class="o">=</span> <span class="n">PHY_XGXS_FLAG</span><span class="p">;</span>
	<span class="n">bnx2x_sync_link</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">vars</span><span class="p">);</span>
	<span class="cm">/* Sync media type */</span>
	<span class="n">sync_offset</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">shmem_base</span> <span class="o">+</span>
			<span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">shmem_region</span><span class="p">,</span>
				 <span class="n">dev_info</span><span class="p">.</span><span class="n">port_hw_config</span><span class="p">[</span><span class="n">port</span><span class="p">].</span><span class="n">media_type</span><span class="p">);</span>
	<span class="n">media_types</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">sync_offset</span><span class="p">);</span>

	<span class="n">params</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">[</span><span class="n">INT_PHY</span><span class="p">].</span><span class="n">media_type</span> <span class="o">=</span>
		<span class="p">(</span><span class="n">media_types</span> <span class="o">&amp;</span> <span class="n">PORT_HW_CFG_MEDIA_TYPE_PHY0_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span>
		<span class="n">PORT_HW_CFG_MEDIA_TYPE_PHY0_SHIFT</span><span class="p">;</span>
	<span class="n">params</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">[</span><span class="n">EXT_PHY1</span><span class="p">].</span><span class="n">media_type</span> <span class="o">=</span>
		<span class="p">(</span><span class="n">media_types</span> <span class="o">&amp;</span> <span class="n">PORT_HW_CFG_MEDIA_TYPE_PHY1_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span>
		<span class="n">PORT_HW_CFG_MEDIA_TYPE_PHY1_SHIFT</span><span class="p">;</span>
	<span class="n">params</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">[</span><span class="n">EXT_PHY2</span><span class="p">].</span><span class="n">media_type</span> <span class="o">=</span>
		<span class="p">(</span><span class="n">media_types</span> <span class="o">&amp;</span> <span class="n">PORT_HW_CFG_MEDIA_TYPE_PHY2_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span>
		<span class="n">PORT_HW_CFG_MEDIA_TYPE_PHY2_SHIFT</span><span class="p">;</span>
	<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;media_types = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">media_types</span><span class="p">);</span>

	<span class="cm">/* Sync AEU offset */</span>
	<span class="n">sync_offset</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">shmem_base</span> <span class="o">+</span>
			<span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">shmem_region</span><span class="p">,</span>
				 <span class="n">dev_info</span><span class="p">.</span><span class="n">port_hw_config</span><span class="p">[</span><span class="n">port</span><span class="p">].</span><span class="n">aeu_int_mask</span><span class="p">);</span>

	<span class="n">vars</span><span class="o">-&gt;</span><span class="n">aeu_int_mask</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">sync_offset</span><span class="p">);</span>

	<span class="cm">/* Sync PFC status */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vars</span><span class="o">-&gt;</span><span class="n">link_status</span> <span class="o">&amp;</span> <span class="n">LINK_STATUS_PFC_ENABLED</span><span class="p">)</span>
		<span class="n">params</span><span class="o">-&gt;</span><span class="n">feature_config_flags</span> <span class="o">|=</span>
					<span class="n">FEATURE_CONFIG_PFC_ENABLED</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">params</span><span class="o">-&gt;</span><span class="n">feature_config_flags</span> <span class="o">&amp;=</span>
					<span class="o">~</span><span class="n">FEATURE_CONFIG_PFC_ENABLED</span><span class="p">;</span>

	<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;link_status 0x%x  phy_link_up %x int_mask 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">vars</span><span class="o">-&gt;</span><span class="n">link_status</span><span class="p">,</span> <span class="n">vars</span><span class="o">-&gt;</span><span class="n">phy_link_up</span><span class="p">,</span> <span class="n">vars</span><span class="o">-&gt;</span><span class="n">aeu_int_mask</span><span class="p">);</span>
	<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;line_speed %x  duplex %x  flow_ctrl 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">vars</span><span class="o">-&gt;</span><span class="n">line_speed</span><span class="p">,</span> <span class="n">vars</span><span class="o">-&gt;</span><span class="n">duplex</span><span class="p">,</span> <span class="n">vars</span><span class="o">-&gt;</span><span class="n">flow_ctrl</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_set_master_ln</span><span class="p">(</span><span class="k">struct</span> <span class="n">link_params</span> <span class="o">*</span><span class="n">params</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">bnx2x_phy</span> <span class="o">*</span><span class="n">phy</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">bp</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">new_master_ln</span><span class="p">,</span> <span class="n">ser_lane</span><span class="p">;</span>
	<span class="n">ser_lane</span> <span class="o">=</span> <span class="p">((</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">lane_config</span> <span class="o">&amp;</span>
		     <span class="n">PORT_HW_CFG_LANE_SWAP_CFG_MASTER_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span>
		    <span class="n">PORT_HW_CFG_LANE_SWAP_CFG_MASTER_SHIFT</span><span class="p">);</span>

	<span class="cm">/* set the master_ln for AN */</span>
	<span class="n">CL22_RD_OVER_CL45</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
			  <span class="n">MDIO_REG_BANK_XGXS_BLOCK2</span><span class="p">,</span>
			  <span class="n">MDIO_XGXS_BLOCK2_TEST_MODE_LANE</span><span class="p">,</span>
			  <span class="o">&amp;</span><span class="n">new_master_ln</span><span class="p">);</span>

	<span class="n">CL22_WR_OVER_CL45</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
			  <span class="n">MDIO_REG_BANK_XGXS_BLOCK2</span> <span class="p">,</span>
			  <span class="n">MDIO_XGXS_BLOCK2_TEST_MODE_LANE</span><span class="p">,</span>
			  <span class="p">(</span><span class="n">new_master_ln</span> <span class="o">|</span> <span class="n">ser_lane</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bnx2x_reset_unicore</span><span class="p">(</span><span class="k">struct</span> <span class="n">link_params</span> <span class="o">*</span><span class="n">params</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">bnx2x_phy</span> <span class="o">*</span><span class="n">phy</span><span class="p">,</span>
			       <span class="n">u8</span> <span class="n">set_serdes</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">bp</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">mii_control</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">CL22_RD_OVER_CL45</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
			  <span class="n">MDIO_REG_BANK_COMBO_IEEE0</span><span class="p">,</span>
			  <span class="n">MDIO_COMBO_IEEE0_MII_CONTROL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mii_control</span><span class="p">);</span>

	<span class="cm">/* reset the unicore */</span>
	<span class="n">CL22_WR_OVER_CL45</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
			  <span class="n">MDIO_REG_BANK_COMBO_IEEE0</span><span class="p">,</span>
			  <span class="n">MDIO_COMBO_IEEE0_MII_CONTROL</span><span class="p">,</span>
			  <span class="p">(</span><span class="n">mii_control</span> <span class="o">|</span>
			   <span class="n">MDIO_COMBO_IEEO_MII_CONTROL_RESET</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">set_serdes</span><span class="p">)</span>
		<span class="n">bnx2x_set_serdes_access</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">);</span>

	<span class="cm">/* wait for the reset to self clear */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MDIO_ACCESS_TIMEOUT</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>

		<span class="cm">/* the reset erased the previous bank value */</span>
		<span class="n">CL22_RD_OVER_CL45</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
				  <span class="n">MDIO_REG_BANK_COMBO_IEEE0</span><span class="p">,</span>
				  <span class="n">MDIO_COMBO_IEEE0_MII_CONTROL</span><span class="p">,</span>
				  <span class="o">&amp;</span><span class="n">mii_control</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">mii_control</span> <span class="o">&amp;</span> <span class="n">MDIO_COMBO_IEEO_MII_CONTROL_RESET</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">netdev_err</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>  <span class="s">&quot;Warning: PHY was not initialized,&quot;</span>
			      <span class="s">&quot; Port %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">params</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">);</span>
	<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;BUG! XGXS is still in reset!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_set_swap_lanes</span><span class="p">(</span><span class="k">struct</span> <span class="n">link_params</span> <span class="o">*</span><span class="n">params</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">bnx2x_phy</span> <span class="o">*</span><span class="n">phy</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">bp</span><span class="p">;</span>
	<span class="cm">/* Each two bits represents a lane number:</span>
<span class="cm">	 * No swap is 0123 =&gt; 0x1b no need to enable the swap</span>
<span class="cm">	 */</span>
	<span class="n">u16</span> <span class="n">rx_lane_swap</span><span class="p">,</span> <span class="n">tx_lane_swap</span><span class="p">;</span>

	<span class="n">rx_lane_swap</span> <span class="o">=</span> <span class="p">((</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">lane_config</span> <span class="o">&amp;</span>
			 <span class="n">PORT_HW_CFG_LANE_SWAP_CFG_RX_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span>
			<span class="n">PORT_HW_CFG_LANE_SWAP_CFG_RX_SHIFT</span><span class="p">);</span>
	<span class="n">tx_lane_swap</span> <span class="o">=</span> <span class="p">((</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">lane_config</span> <span class="o">&amp;</span>
			 <span class="n">PORT_HW_CFG_LANE_SWAP_CFG_TX_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span>
			<span class="n">PORT_HW_CFG_LANE_SWAP_CFG_TX_SHIFT</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rx_lane_swap</span> <span class="o">!=</span> <span class="mh">0x1b</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">CL22_WR_OVER_CL45</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
				  <span class="n">MDIO_REG_BANK_XGXS_BLOCK2</span><span class="p">,</span>
				  <span class="n">MDIO_XGXS_BLOCK2_RX_LN_SWAP</span><span class="p">,</span>
				  <span class="p">(</span><span class="n">rx_lane_swap</span> <span class="o">|</span>
				   <span class="n">MDIO_XGXS_BLOCK2_RX_LN_SWAP_ENABLE</span> <span class="o">|</span>
				   <span class="n">MDIO_XGXS_BLOCK2_RX_LN_SWAP_FORCE_ENABLE</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">CL22_WR_OVER_CL45</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
				  <span class="n">MDIO_REG_BANK_XGXS_BLOCK2</span><span class="p">,</span>
				  <span class="n">MDIO_XGXS_BLOCK2_RX_LN_SWAP</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tx_lane_swap</span> <span class="o">!=</span> <span class="mh">0x1b</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">CL22_WR_OVER_CL45</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
				  <span class="n">MDIO_REG_BANK_XGXS_BLOCK2</span><span class="p">,</span>
				  <span class="n">MDIO_XGXS_BLOCK2_TX_LN_SWAP</span><span class="p">,</span>
				  <span class="p">(</span><span class="n">tx_lane_swap</span> <span class="o">|</span>
				   <span class="n">MDIO_XGXS_BLOCK2_TX_LN_SWAP_ENABLE</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">CL22_WR_OVER_CL45</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
				  <span class="n">MDIO_REG_BANK_XGXS_BLOCK2</span><span class="p">,</span>
				  <span class="n">MDIO_XGXS_BLOCK2_TX_LN_SWAP</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_set_parallel_detection</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x_phy</span> <span class="o">*</span><span class="n">phy</span><span class="p">,</span>
					 <span class="k">struct</span> <span class="n">link_params</span> <span class="o">*</span><span class="n">params</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">bp</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">control2</span><span class="p">;</span>
	<span class="n">CL22_RD_OVER_CL45</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
			  <span class="n">MDIO_REG_BANK_SERDES_DIGITAL</span><span class="p">,</span>
			  <span class="n">MDIO_SERDES_DIGITAL_A_1000X_CONTROL2</span><span class="p">,</span>
			  <span class="o">&amp;</span><span class="n">control2</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">speed_cap_mask</span> <span class="o">&amp;</span> <span class="n">PORT_HW_CFG_SPEED_CAPABILITY_D0_1G</span><span class="p">)</span>
		<span class="n">control2</span> <span class="o">|=</span> <span class="n">MDIO_SERDES_DIGITAL_A_1000X_CONTROL2_PRL_DT_EN</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">control2</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MDIO_SERDES_DIGITAL_A_1000X_CONTROL2_PRL_DT_EN</span><span class="p">;</span>
	<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;phy-&gt;speed_cap_mask = 0x%x, control2 = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">phy</span><span class="o">-&gt;</span><span class="n">speed_cap_mask</span><span class="p">,</span> <span class="n">control2</span><span class="p">);</span>
	<span class="n">CL22_WR_OVER_CL45</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
			  <span class="n">MDIO_REG_BANK_SERDES_DIGITAL</span><span class="p">,</span>
			  <span class="n">MDIO_SERDES_DIGITAL_A_1000X_CONTROL2</span><span class="p">,</span>
			  <span class="n">control2</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">PORT_HW_CFG_XGXS_EXT_PHY_TYPE_DIRECT</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	     <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">speed_cap_mask</span> <span class="o">&amp;</span>
		    <span class="n">PORT_HW_CFG_SPEED_CAPABILITY_D0_10G</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;XGXS</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="n">CL22_WR_OVER_CL45</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
				 <span class="n">MDIO_REG_BANK_10G_PARALLEL_DETECT</span><span class="p">,</span>
				 <span class="n">MDIO_10G_PARALLEL_DETECT_PAR_DET_10G_LINK</span><span class="p">,</span>
				 <span class="n">MDIO_10G_PARALLEL_DETECT_PAR_DET_10G_LINK_CNT</span><span class="p">);</span>

		<span class="n">CL22_RD_OVER_CL45</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
				  <span class="n">MDIO_REG_BANK_10G_PARALLEL_DETECT</span><span class="p">,</span>
				  <span class="n">MDIO_10G_PARALLEL_DETECT_PAR_DET_10G_CONTROL</span><span class="p">,</span>
				  <span class="o">&amp;</span><span class="n">control2</span><span class="p">);</span>


		<span class="n">control2</span> <span class="o">|=</span>
		    <span class="n">MDIO_10G_PARALLEL_DETECT_PAR_DET_10G_CONTROL_PARDET10G_EN</span><span class="p">;</span>

		<span class="n">CL22_WR_OVER_CL45</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
				  <span class="n">MDIO_REG_BANK_10G_PARALLEL_DETECT</span><span class="p">,</span>
				  <span class="n">MDIO_10G_PARALLEL_DETECT_PAR_DET_10G_CONTROL</span><span class="p">,</span>
				  <span class="n">control2</span><span class="p">);</span>

		<span class="cm">/* Disable parallel detection of HiG */</span>
		<span class="n">CL22_WR_OVER_CL45</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
				  <span class="n">MDIO_REG_BANK_XGXS_BLOCK2</span><span class="p">,</span>
				  <span class="n">MDIO_XGXS_BLOCK2_UNICORE_MODE_10G</span><span class="p">,</span>
				  <span class="n">MDIO_XGXS_BLOCK2_UNICORE_MODE_10G_CX4_XGXS</span> <span class="o">|</span>
				  <span class="n">MDIO_XGXS_BLOCK2_UNICORE_MODE_10G_HIGIG_XGXS</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_set_autoneg</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x_phy</span> <span class="o">*</span><span class="n">phy</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">link_params</span> <span class="o">*</span><span class="n">params</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">link_vars</span> <span class="o">*</span><span class="n">vars</span><span class="p">,</span>
			      <span class="n">u8</span> <span class="n">enable_cl73</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">bp</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">reg_val</span><span class="p">;</span>

	<span class="cm">/* CL37 Autoneg */</span>
	<span class="n">CL22_RD_OVER_CL45</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
			  <span class="n">MDIO_REG_BANK_COMBO_IEEE0</span><span class="p">,</span>
			  <span class="n">MDIO_COMBO_IEEE0_MII_CONTROL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg_val</span><span class="p">);</span>

	<span class="cm">/* CL37 Autoneg Enabled */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vars</span><span class="o">-&gt;</span><span class="n">line_speed</span> <span class="o">==</span> <span class="n">SPEED_AUTO_NEG</span><span class="p">)</span>
		<span class="n">reg_val</span> <span class="o">|=</span> <span class="n">MDIO_COMBO_IEEO_MII_CONTROL_AN_EN</span><span class="p">;</span>
	<span class="k">else</span> <span class="cm">/* CL37 Autoneg Disabled */</span>
		<span class="n">reg_val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">MDIO_COMBO_IEEO_MII_CONTROL_AN_EN</span> <span class="o">|</span>
			     <span class="n">MDIO_COMBO_IEEO_MII_CONTROL_RESTART_AN</span><span class="p">);</span>

	<span class="n">CL22_WR_OVER_CL45</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
			  <span class="n">MDIO_REG_BANK_COMBO_IEEE0</span><span class="p">,</span>
			  <span class="n">MDIO_COMBO_IEEE0_MII_CONTROL</span><span class="p">,</span> <span class="n">reg_val</span><span class="p">);</span>

	<span class="cm">/* Enable/Disable Autodetection */</span>

	<span class="n">CL22_RD_OVER_CL45</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
			  <span class="n">MDIO_REG_BANK_SERDES_DIGITAL</span><span class="p">,</span>
			  <span class="n">MDIO_SERDES_DIGITAL_A_1000X_CONTROL1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg_val</span><span class="p">);</span>
	<span class="n">reg_val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">MDIO_SERDES_DIGITAL_A_1000X_CONTROL1_SIGNAL_DETECT_EN</span> <span class="o">|</span>
		    <span class="n">MDIO_SERDES_DIGITAL_A_1000X_CONTROL1_INVERT_SIGNAL_DETECT</span><span class="p">);</span>
	<span class="n">reg_val</span> <span class="o">|=</span> <span class="n">MDIO_SERDES_DIGITAL_A_1000X_CONTROL1_FIBER_MODE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vars</span><span class="o">-&gt;</span><span class="n">line_speed</span> <span class="o">==</span> <span class="n">SPEED_AUTO_NEG</span><span class="p">)</span>
		<span class="n">reg_val</span> <span class="o">|=</span> <span class="n">MDIO_SERDES_DIGITAL_A_1000X_CONTROL1_AUTODET</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">reg_val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MDIO_SERDES_DIGITAL_A_1000X_CONTROL1_AUTODET</span><span class="p">;</span>

	<span class="n">CL22_WR_OVER_CL45</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
			  <span class="n">MDIO_REG_BANK_SERDES_DIGITAL</span><span class="p">,</span>
			  <span class="n">MDIO_SERDES_DIGITAL_A_1000X_CONTROL1</span><span class="p">,</span> <span class="n">reg_val</span><span class="p">);</span>

	<span class="cm">/* Enable TetonII and BAM autoneg */</span>
	<span class="n">CL22_RD_OVER_CL45</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
			  <span class="n">MDIO_REG_BANK_BAM_NEXT_PAGE</span><span class="p">,</span>
			  <span class="n">MDIO_BAM_NEXT_PAGE_MP5_NEXT_PAGE_CTRL</span><span class="p">,</span>
			  <span class="o">&amp;</span><span class="n">reg_val</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vars</span><span class="o">-&gt;</span><span class="n">line_speed</span> <span class="o">==</span> <span class="n">SPEED_AUTO_NEG</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Enable BAM aneg Mode and TetonII aneg Mode */</span>
		<span class="n">reg_val</span> <span class="o">|=</span> <span class="p">(</span><span class="n">MDIO_BAM_NEXT_PAGE_MP5_NEXT_PAGE_CTRL_BAM_MODE</span> <span class="o">|</span>
			    <span class="n">MDIO_BAM_NEXT_PAGE_MP5_NEXT_PAGE_CTRL_TETON_AN</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* TetonII and BAM Autoneg Disabled */</span>
		<span class="n">reg_val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">MDIO_BAM_NEXT_PAGE_MP5_NEXT_PAGE_CTRL_BAM_MODE</span> <span class="o">|</span>
			     <span class="n">MDIO_BAM_NEXT_PAGE_MP5_NEXT_PAGE_CTRL_TETON_AN</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">CL22_WR_OVER_CL45</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
			  <span class="n">MDIO_REG_BANK_BAM_NEXT_PAGE</span><span class="p">,</span>
			  <span class="n">MDIO_BAM_NEXT_PAGE_MP5_NEXT_PAGE_CTRL</span><span class="p">,</span>
			  <span class="n">reg_val</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">enable_cl73</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Enable Cl73 FSM status bits */</span>
		<span class="n">CL22_WR_OVER_CL45</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
				  <span class="n">MDIO_REG_BANK_CL73_USERB0</span><span class="p">,</span>
				  <span class="n">MDIO_CL73_USERB0_CL73_UCTRL</span><span class="p">,</span>
				  <span class="mh">0xe</span><span class="p">);</span>

		<span class="cm">/* Enable BAM Station Manager*/</span>
		<span class="n">CL22_WR_OVER_CL45</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
			<span class="n">MDIO_REG_BANK_CL73_USERB0</span><span class="p">,</span>
			<span class="n">MDIO_CL73_USERB0_CL73_BAM_CTRL1</span><span class="p">,</span>
			<span class="n">MDIO_CL73_USERB0_CL73_BAM_CTRL1_BAM_EN</span> <span class="o">|</span>
			<span class="n">MDIO_CL73_USERB0_CL73_BAM_CTRL1_BAM_STATION_MNGR_EN</span> <span class="o">|</span>
			<span class="n">MDIO_CL73_USERB0_CL73_BAM_CTRL1_BAM_NP_AFTER_BP_EN</span><span class="p">);</span>

		<span class="cm">/* Advertise CL73 link speeds */</span>
		<span class="n">CL22_RD_OVER_CL45</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
				  <span class="n">MDIO_REG_BANK_CL73_IEEEB1</span><span class="p">,</span>
				  <span class="n">MDIO_CL73_IEEEB1_AN_ADV2</span><span class="p">,</span>
				  <span class="o">&amp;</span><span class="n">reg_val</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">speed_cap_mask</span> <span class="o">&amp;</span>
		    <span class="n">PORT_HW_CFG_SPEED_CAPABILITY_D0_10G</span><span class="p">)</span>
			<span class="n">reg_val</span> <span class="o">|=</span> <span class="n">MDIO_CL73_IEEEB1_AN_ADV2_ADVR_10G_KX4</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">speed_cap_mask</span> <span class="o">&amp;</span>
		    <span class="n">PORT_HW_CFG_SPEED_CAPABILITY_D0_1G</span><span class="p">)</span>
			<span class="n">reg_val</span> <span class="o">|=</span> <span class="n">MDIO_CL73_IEEEB1_AN_ADV2_ADVR_1000M_KX</span><span class="p">;</span>

		<span class="n">CL22_WR_OVER_CL45</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
				  <span class="n">MDIO_REG_BANK_CL73_IEEEB1</span><span class="p">,</span>
				  <span class="n">MDIO_CL73_IEEEB1_AN_ADV2</span><span class="p">,</span>
				  <span class="n">reg_val</span><span class="p">);</span>

		<span class="cm">/* CL73 Autoneg Enabled */</span>
		<span class="n">reg_val</span> <span class="o">=</span> <span class="n">MDIO_CL73_IEEEB0_CL73_AN_CONTROL_AN_EN</span><span class="p">;</span>

	<span class="p">}</span> <span class="k">else</span> <span class="cm">/* CL73 Autoneg Disabled */</span>
		<span class="n">reg_val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">CL22_WR_OVER_CL45</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
			  <span class="n">MDIO_REG_BANK_CL73_IEEEB0</span><span class="p">,</span>
			  <span class="n">MDIO_CL73_IEEEB0_CL73_AN_CONTROL</span><span class="p">,</span> <span class="n">reg_val</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* program SerDes, forced speed */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_program_serdes</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x_phy</span> <span class="o">*</span><span class="n">phy</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">link_params</span> <span class="o">*</span><span class="n">params</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">link_vars</span> <span class="o">*</span><span class="n">vars</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">bp</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">reg_val</span><span class="p">;</span>

	<span class="cm">/* program duplex, disable autoneg and sgmii*/</span>
	<span class="n">CL22_RD_OVER_CL45</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
			  <span class="n">MDIO_REG_BANK_COMBO_IEEE0</span><span class="p">,</span>
			  <span class="n">MDIO_COMBO_IEEE0_MII_CONTROL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg_val</span><span class="p">);</span>
	<span class="n">reg_val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">MDIO_COMBO_IEEO_MII_CONTROL_FULL_DUPLEX</span> <span class="o">|</span>
		     <span class="n">MDIO_COMBO_IEEO_MII_CONTROL_AN_EN</span> <span class="o">|</span>
		     <span class="n">MDIO_COMBO_IEEO_MII_CONTROL_MAN_SGMII_SP_MASK</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">req_duplex</span> <span class="o">==</span> <span class="n">DUPLEX_FULL</span><span class="p">)</span>
		<span class="n">reg_val</span> <span class="o">|=</span> <span class="n">MDIO_COMBO_IEEO_MII_CONTROL_FULL_DUPLEX</span><span class="p">;</span>
	<span class="n">CL22_WR_OVER_CL45</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
			  <span class="n">MDIO_REG_BANK_COMBO_IEEE0</span><span class="p">,</span>
			  <span class="n">MDIO_COMBO_IEEE0_MII_CONTROL</span><span class="p">,</span> <span class="n">reg_val</span><span class="p">);</span>

	<span class="cm">/* Program speed</span>
<span class="cm">	 *  - needed only if the speed is greater than 1G (2.5G or 10G)</span>
<span class="cm">	 */</span>
	<span class="n">CL22_RD_OVER_CL45</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
			  <span class="n">MDIO_REG_BANK_SERDES_DIGITAL</span><span class="p">,</span>
			  <span class="n">MDIO_SERDES_DIGITAL_MISC1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg_val</span><span class="p">);</span>
	<span class="cm">/* clearing the speed value before setting the right speed */</span>
	<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;MDIO_REG_BANK_SERDES_DIGITAL = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">reg_val</span><span class="p">);</span>

	<span class="n">reg_val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">MDIO_SERDES_DIGITAL_MISC1_FORCE_SPEED_MASK</span> <span class="o">|</span>
		     <span class="n">MDIO_SERDES_DIGITAL_MISC1_FORCE_SPEED_SEL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">((</span><span class="n">vars</span><span class="o">-&gt;</span><span class="n">line_speed</span> <span class="o">==</span> <span class="n">SPEED_1000</span><span class="p">)</span> <span class="o">||</span>
	      <span class="p">(</span><span class="n">vars</span><span class="o">-&gt;</span><span class="n">line_speed</span> <span class="o">==</span> <span class="n">SPEED_100</span><span class="p">)</span> <span class="o">||</span>
	      <span class="p">(</span><span class="n">vars</span><span class="o">-&gt;</span><span class="n">line_speed</span> <span class="o">==</span> <span class="n">SPEED_10</span><span class="p">)))</span> <span class="p">{</span>

		<span class="n">reg_val</span> <span class="o">|=</span> <span class="p">(</span><span class="n">MDIO_SERDES_DIGITAL_MISC1_REFCLK_SEL_156_25M</span> <span class="o">|</span>
			    <span class="n">MDIO_SERDES_DIGITAL_MISC1_FORCE_SPEED_SEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vars</span><span class="o">-&gt;</span><span class="n">line_speed</span> <span class="o">==</span> <span class="n">SPEED_10000</span><span class="p">)</span>
			<span class="n">reg_val</span> <span class="o">|=</span>
				<span class="n">MDIO_SERDES_DIGITAL_MISC1_FORCE_SPEED_10G_CX4</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">CL22_WR_OVER_CL45</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
			  <span class="n">MDIO_REG_BANK_SERDES_DIGITAL</span><span class="p">,</span>
			  <span class="n">MDIO_SERDES_DIGITAL_MISC1</span><span class="p">,</span> <span class="n">reg_val</span><span class="p">);</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_set_brcm_cl37_advertisement</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x_phy</span> <span class="o">*</span><span class="n">phy</span><span class="p">,</span>
					      <span class="k">struct</span> <span class="n">link_params</span> <span class="o">*</span><span class="n">params</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">bp</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* set extended capabilities */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">speed_cap_mask</span> <span class="o">&amp;</span> <span class="n">PORT_HW_CFG_SPEED_CAPABILITY_D0_2_5G</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">MDIO_OVER_1G_UP1_2_5G</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">speed_cap_mask</span> <span class="o">&amp;</span> <span class="n">PORT_HW_CFG_SPEED_CAPABILITY_D0_10G</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">MDIO_OVER_1G_UP1_10G</span><span class="p">;</span>
	<span class="n">CL22_WR_OVER_CL45</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
			  <span class="n">MDIO_REG_BANK_OVER_1G</span><span class="p">,</span>
			  <span class="n">MDIO_OVER_1G_UP1</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

	<span class="n">CL22_WR_OVER_CL45</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
			  <span class="n">MDIO_REG_BANK_OVER_1G</span><span class="p">,</span>
			  <span class="n">MDIO_OVER_1G_UP3</span><span class="p">,</span> <span class="mh">0x400</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_set_ieee_aneg_advertisement</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x_phy</span> <span class="o">*</span><span class="n">phy</span><span class="p">,</span>
					      <span class="k">struct</span> <span class="n">link_params</span> <span class="o">*</span><span class="n">params</span><span class="p">,</span>
					      <span class="n">u16</span> <span class="n">ieee_fc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">bp</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">val</span><span class="p">;</span>
	<span class="cm">/* for AN, we are always publishing full duplex */</span>

	<span class="n">CL22_WR_OVER_CL45</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
			  <span class="n">MDIO_REG_BANK_COMBO_IEEE0</span><span class="p">,</span>
			  <span class="n">MDIO_COMBO_IEEE0_AUTO_NEG_ADV</span><span class="p">,</span> <span class="n">ieee_fc</span><span class="p">);</span>
	<span class="n">CL22_RD_OVER_CL45</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
			  <span class="n">MDIO_REG_BANK_CL73_IEEEB1</span><span class="p">,</span>
			  <span class="n">MDIO_CL73_IEEEB1_AN_ADV1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MDIO_CL73_IEEEB1_AN_ADV1_PAUSE_BOTH</span><span class="p">;</span>
	<span class="n">val</span> <span class="o">|=</span> <span class="p">((</span><span class="n">ieee_fc</span><span class="o">&lt;&lt;</span><span class="mi">3</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">MDIO_CL73_IEEEB1_AN_ADV1_PAUSE_MASK</span><span class="p">);</span>
	<span class="n">CL22_WR_OVER_CL45</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
			  <span class="n">MDIO_REG_BANK_CL73_IEEEB1</span><span class="p">,</span>
			  <span class="n">MDIO_CL73_IEEEB1_AN_ADV1</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_restart_autoneg</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x_phy</span> <span class="o">*</span><span class="n">phy</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">link_params</span> <span class="o">*</span><span class="n">params</span><span class="p">,</span>
				  <span class="n">u8</span> <span class="n">enable_cl73</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">bp</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">mii_control</span><span class="p">;</span>

	<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;bnx2x_restart_autoneg</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="cm">/* Enable and restart BAM/CL37 aneg */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">enable_cl73</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">CL22_RD_OVER_CL45</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
				  <span class="n">MDIO_REG_BANK_CL73_IEEEB0</span><span class="p">,</span>
				  <span class="n">MDIO_CL73_IEEEB0_CL73_AN_CONTROL</span><span class="p">,</span>
				  <span class="o">&amp;</span><span class="n">mii_control</span><span class="p">);</span>

		<span class="n">CL22_WR_OVER_CL45</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
				  <span class="n">MDIO_REG_BANK_CL73_IEEEB0</span><span class="p">,</span>
				  <span class="n">MDIO_CL73_IEEEB0_CL73_AN_CONTROL</span><span class="p">,</span>
				  <span class="p">(</span><span class="n">mii_control</span> <span class="o">|</span>
				  <span class="n">MDIO_CL73_IEEEB0_CL73_AN_CONTROL_AN_EN</span> <span class="o">|</span>
				  <span class="n">MDIO_CL73_IEEEB0_CL73_AN_CONTROL_RESTART_AN</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>

		<span class="n">CL22_RD_OVER_CL45</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
				  <span class="n">MDIO_REG_BANK_COMBO_IEEE0</span><span class="p">,</span>
				  <span class="n">MDIO_COMBO_IEEE0_MII_CONTROL</span><span class="p">,</span>
				  <span class="o">&amp;</span><span class="n">mii_control</span><span class="p">);</span>
		<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span>
			 <span class="s">&quot;bnx2x_restart_autoneg mii_control before = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">mii_control</span><span class="p">);</span>
		<span class="n">CL22_WR_OVER_CL45</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
				  <span class="n">MDIO_REG_BANK_COMBO_IEEE0</span><span class="p">,</span>
				  <span class="n">MDIO_COMBO_IEEE0_MII_CONTROL</span><span class="p">,</span>
				  <span class="p">(</span><span class="n">mii_control</span> <span class="o">|</span>
				   <span class="n">MDIO_COMBO_IEEO_MII_CONTROL_AN_EN</span> <span class="o">|</span>
				   <span class="n">MDIO_COMBO_IEEO_MII_CONTROL_RESTART_AN</span><span class="p">));</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_initialize_sgmii_process</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x_phy</span> <span class="o">*</span><span class="n">phy</span><span class="p">,</span>
					   <span class="k">struct</span> <span class="n">link_params</span> <span class="o">*</span><span class="n">params</span><span class="p">,</span>
					   <span class="k">struct</span> <span class="n">link_vars</span> <span class="o">*</span><span class="n">vars</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">bp</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">control1</span><span class="p">;</span>

	<span class="cm">/* in SGMII mode, the unicore is always slave */</span>

	<span class="n">CL22_RD_OVER_CL45</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
			  <span class="n">MDIO_REG_BANK_SERDES_DIGITAL</span><span class="p">,</span>
			  <span class="n">MDIO_SERDES_DIGITAL_A_1000X_CONTROL1</span><span class="p">,</span>
			  <span class="o">&amp;</span><span class="n">control1</span><span class="p">);</span>
	<span class="n">control1</span> <span class="o">|=</span> <span class="n">MDIO_SERDES_DIGITAL_A_1000X_CONTROL1_INVERT_SIGNAL_DETECT</span><span class="p">;</span>
	<span class="cm">/* set sgmii mode (and not fiber) */</span>
	<span class="n">control1</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">MDIO_SERDES_DIGITAL_A_1000X_CONTROL1_FIBER_MODE</span> <span class="o">|</span>
		      <span class="n">MDIO_SERDES_DIGITAL_A_1000X_CONTROL1_AUTODET</span> <span class="o">|</span>
		      <span class="n">MDIO_SERDES_DIGITAL_A_1000X_CONTROL1_MSTR_MODE</span><span class="p">);</span>
	<span class="n">CL22_WR_OVER_CL45</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
			  <span class="n">MDIO_REG_BANK_SERDES_DIGITAL</span><span class="p">,</span>
			  <span class="n">MDIO_SERDES_DIGITAL_A_1000X_CONTROL1</span><span class="p">,</span>
			  <span class="n">control1</span><span class="p">);</span>

	<span class="cm">/* if forced speed */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">vars</span><span class="o">-&gt;</span><span class="n">line_speed</span> <span class="o">==</span> <span class="n">SPEED_AUTO_NEG</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* set speed, disable autoneg */</span>
		<span class="n">u16</span> <span class="n">mii_control</span><span class="p">;</span>

		<span class="n">CL22_RD_OVER_CL45</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
				  <span class="n">MDIO_REG_BANK_COMBO_IEEE0</span><span class="p">,</span>
				  <span class="n">MDIO_COMBO_IEEE0_MII_CONTROL</span><span class="p">,</span>
				  <span class="o">&amp;</span><span class="n">mii_control</span><span class="p">);</span>
		<span class="n">mii_control</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">MDIO_COMBO_IEEO_MII_CONTROL_AN_EN</span> <span class="o">|</span>
				 <span class="n">MDIO_COMBO_IEEO_MII_CONTROL_MAN_SGMII_SP_MASK</span><span class="o">|</span>
				 <span class="n">MDIO_COMBO_IEEO_MII_CONTROL_FULL_DUPLEX</span><span class="p">);</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">vars</span><span class="o">-&gt;</span><span class="n">line_speed</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">SPEED_100</span>:
			<span class="n">mii_control</span> <span class="o">|=</span>
				<span class="n">MDIO_COMBO_IEEO_MII_CONTROL_MAN_SGMII_SP_100</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">SPEED_1000</span>:
			<span class="n">mii_control</span> <span class="o">|=</span>
				<span class="n">MDIO_COMBO_IEEO_MII_CONTROL_MAN_SGMII_SP_1000</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">SPEED_10</span>:
			<span class="cm">/* there is nothing to set for 10M */</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="cm">/* invalid speed for SGMII */</span>
			<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;Invalid line_speed 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				  <span class="n">vars</span><span class="o">-&gt;</span><span class="n">line_speed</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* setting the full duplex */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">req_duplex</span> <span class="o">==</span> <span class="n">DUPLEX_FULL</span><span class="p">)</span>
			<span class="n">mii_control</span> <span class="o">|=</span>
				<span class="n">MDIO_COMBO_IEEO_MII_CONTROL_FULL_DUPLEX</span><span class="p">;</span>
		<span class="n">CL22_WR_OVER_CL45</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
				  <span class="n">MDIO_REG_BANK_COMBO_IEEE0</span><span class="p">,</span>
				  <span class="n">MDIO_COMBO_IEEE0_MII_CONTROL</span><span class="p">,</span>
				  <span class="n">mii_control</span><span class="p">);</span>

	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="cm">/* AN mode */</span>
		<span class="cm">/* enable and restart AN */</span>
		<span class="n">bnx2x_restart_autoneg</span><span class="p">(</span><span class="n">phy</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* Link management</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">bnx2x_direct_parallel_detect_used</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x_phy</span> <span class="o">*</span><span class="n">phy</span><span class="p">,</span>
					     <span class="k">struct</span> <span class="n">link_params</span> <span class="o">*</span><span class="n">params</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">bp</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">pd_10g</span><span class="p">,</span> <span class="n">status2_1000x</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">req_line_speed</span> <span class="o">!=</span> <span class="n">SPEED_AUTO_NEG</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">CL22_RD_OVER_CL45</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
			  <span class="n">MDIO_REG_BANK_SERDES_DIGITAL</span><span class="p">,</span>
			  <span class="n">MDIO_SERDES_DIGITAL_A_1000X_STATUS2</span><span class="p">,</span>
			  <span class="o">&amp;</span><span class="n">status2_1000x</span><span class="p">);</span>
	<span class="n">CL22_RD_OVER_CL45</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
			  <span class="n">MDIO_REG_BANK_SERDES_DIGITAL</span><span class="p">,</span>
			  <span class="n">MDIO_SERDES_DIGITAL_A_1000X_STATUS2</span><span class="p">,</span>
			  <span class="o">&amp;</span><span class="n">status2_1000x</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status2_1000x</span> <span class="o">&amp;</span> <span class="n">MDIO_SERDES_DIGITAL_A_1000X_STATUS2_AN_DISABLED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;1G parallel detect link on port %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">params</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">CL22_RD_OVER_CL45</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
			  <span class="n">MDIO_REG_BANK_10G_PARALLEL_DETECT</span><span class="p">,</span>
			  <span class="n">MDIO_10G_PARALLEL_DETECT_PAR_DET_10G_STATUS</span><span class="p">,</span>
			  <span class="o">&amp;</span><span class="n">pd_10g</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pd_10g</span> <span class="o">&amp;</span> <span class="n">MDIO_10G_PARALLEL_DETECT_PAR_DET_10G_STATUS_PD_LINK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;10G parallel detect link on port %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">params</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_update_adv_fc</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x_phy</span> <span class="o">*</span><span class="n">phy</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">link_params</span> <span class="o">*</span><span class="n">params</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">link_vars</span> <span class="o">*</span><span class="n">vars</span><span class="p">,</span>
				<span class="n">u32</span> <span class="n">gp_status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">ld_pause</span><span class="p">;</span>   <span class="cm">/* local driver */</span>
	<span class="n">u16</span> <span class="n">lp_pause</span><span class="p">;</span>   <span class="cm">/* link partner */</span>
	<span class="n">u16</span> <span class="n">pause_result</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">bp</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">gp_status</span> <span class="o">&amp;</span>
	     <span class="p">(</span><span class="n">MDIO_GP_STATUS_TOP_AN_STATUS1_CL73_AUTONEG_COMPLETE</span> <span class="o">|</span>
	      <span class="n">MDIO_GP_STATUS_TOP_AN_STATUS1_CL73_MR_LP_NP_AN_ABLE</span><span class="p">))</span> <span class="o">==</span>
	    <span class="p">(</span><span class="n">MDIO_GP_STATUS_TOP_AN_STATUS1_CL73_AUTONEG_COMPLETE</span> <span class="o">|</span>
	     <span class="n">MDIO_GP_STATUS_TOP_AN_STATUS1_CL73_MR_LP_NP_AN_ABLE</span><span class="p">))</span> <span class="p">{</span>

		<span class="n">CL22_RD_OVER_CL45</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
				  <span class="n">MDIO_REG_BANK_CL73_IEEEB1</span><span class="p">,</span>
				  <span class="n">MDIO_CL73_IEEEB1_AN_ADV1</span><span class="p">,</span>
				  <span class="o">&amp;</span><span class="n">ld_pause</span><span class="p">);</span>
		<span class="n">CL22_RD_OVER_CL45</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
				  <span class="n">MDIO_REG_BANK_CL73_IEEEB1</span><span class="p">,</span>
				  <span class="n">MDIO_CL73_IEEEB1_AN_LP_ADV1</span><span class="p">,</span>
				  <span class="o">&amp;</span><span class="n">lp_pause</span><span class="p">);</span>
		<span class="n">pause_result</span> <span class="o">=</span> <span class="p">(</span><span class="n">ld_pause</span> <span class="o">&amp;</span>
				<span class="n">MDIO_CL73_IEEEB1_AN_ADV1_PAUSE_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">pause_result</span> <span class="o">|=</span> <span class="p">(</span><span class="n">lp_pause</span> <span class="o">&amp;</span>
				 <span class="n">MDIO_CL73_IEEEB1_AN_LP_ADV1_PAUSE_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">10</span><span class="p">;</span>
		<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;pause_result CL73 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pause_result</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">CL22_RD_OVER_CL45</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
				  <span class="n">MDIO_REG_BANK_COMBO_IEEE0</span><span class="p">,</span>
				  <span class="n">MDIO_COMBO_IEEE0_AUTO_NEG_ADV</span><span class="p">,</span>
				  <span class="o">&amp;</span><span class="n">ld_pause</span><span class="p">);</span>
		<span class="n">CL22_RD_OVER_CL45</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
			<span class="n">MDIO_REG_BANK_COMBO_IEEE0</span><span class="p">,</span>
			<span class="n">MDIO_COMBO_IEEE0_AUTO_NEG_LINK_PARTNER_ABILITY1</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">lp_pause</span><span class="p">);</span>
		<span class="n">pause_result</span> <span class="o">=</span> <span class="p">(</span><span class="n">ld_pause</span> <span class="o">&amp;</span>
				<span class="n">MDIO_COMBO_IEEE0_AUTO_NEG_ADV_PAUSE_MASK</span><span class="p">)</span><span class="o">&gt;&gt;</span><span class="mi">5</span><span class="p">;</span>
		<span class="n">pause_result</span> <span class="o">|=</span> <span class="p">(</span><span class="n">lp_pause</span> <span class="o">&amp;</span>
				 <span class="n">MDIO_COMBO_IEEE0_AUTO_NEG_ADV_PAUSE_MASK</span><span class="p">)</span><span class="o">&gt;&gt;</span><span class="mi">7</span><span class="p">;</span>
		<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;pause_result CL37 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pause_result</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">bnx2x_pause_resolve</span><span class="p">(</span><span class="n">vars</span><span class="p">,</span> <span class="n">pause_result</span><span class="p">);</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_flow_ctrl_resolve</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x_phy</span> <span class="o">*</span><span class="n">phy</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">link_params</span> <span class="o">*</span><span class="n">params</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">link_vars</span> <span class="o">*</span><span class="n">vars</span><span class="p">,</span>
				    <span class="n">u32</span> <span class="n">gp_status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">bp</span><span class="p">;</span>
	<span class="n">vars</span><span class="o">-&gt;</span><span class="n">flow_ctrl</span> <span class="o">=</span> <span class="n">BNX2X_FLOW_CTRL_NONE</span><span class="p">;</span>

	<span class="cm">/* resolve from gp_status in case of AN complete and not sgmii */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">req_flow_ctrl</span> <span class="o">!=</span> <span class="n">BNX2X_FLOW_CTRL_AUTO</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Update the advertised flow-controled of LD/LP in AN */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">req_line_speed</span> <span class="o">==</span> <span class="n">SPEED_AUTO_NEG</span><span class="p">)</span>
			<span class="n">bnx2x_update_adv_fc</span><span class="p">(</span><span class="n">phy</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">vars</span><span class="p">,</span> <span class="n">gp_status</span><span class="p">);</span>
		<span class="cm">/* But set the flow-control result as the requested one */</span>
		<span class="n">vars</span><span class="o">-&gt;</span><span class="n">flow_ctrl</span> <span class="o">=</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">req_flow_ctrl</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">req_line_speed</span> <span class="o">!=</span> <span class="n">SPEED_AUTO_NEG</span><span class="p">)</span>
		<span class="n">vars</span><span class="o">-&gt;</span><span class="n">flow_ctrl</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">req_fc_auto_adv</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">gp_status</span> <span class="o">&amp;</span> <span class="n">MDIO_AN_CL73_OR_37_COMPLETE</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		 <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">vars</span><span class="o">-&gt;</span><span class="n">phy_flags</span> <span class="o">&amp;</span> <span class="n">PHY_SGMII_FLAG</span><span class="p">)))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bnx2x_direct_parallel_detect_used</span><span class="p">(</span><span class="n">phy</span><span class="p">,</span> <span class="n">params</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">vars</span><span class="o">-&gt;</span><span class="n">flow_ctrl</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">req_fc_auto_adv</span><span class="p">;</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">bnx2x_update_adv_fc</span><span class="p">(</span><span class="n">phy</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">vars</span><span class="p">,</span> <span class="n">gp_status</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;flow_ctrl 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">vars</span><span class="o">-&gt;</span><span class="n">flow_ctrl</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_check_fallback_to_cl37</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x_phy</span> <span class="o">*</span><span class="n">phy</span><span class="p">,</span>
					 <span class="k">struct</span> <span class="n">link_params</span> <span class="o">*</span><span class="n">params</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">bp</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">rx_status</span><span class="p">,</span> <span class="n">ustat_val</span><span class="p">,</span> <span class="n">cl37_fsm_received</span><span class="p">;</span>
	<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;bnx2x_check_fallback_to_cl37</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="cm">/* Step 1: Make sure signal is detected */</span>
	<span class="n">CL22_RD_OVER_CL45</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
			  <span class="n">MDIO_REG_BANK_RX0</span><span class="p">,</span>
			  <span class="n">MDIO_RX0_RX_STATUS</span><span class="p">,</span>
			  <span class="o">&amp;</span><span class="n">rx_status</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">rx_status</span> <span class="o">&amp;</span> <span class="n">MDIO_RX0_RX_STATUS_SIGDET</span><span class="p">)</span> <span class="o">!=</span>
	    <span class="p">(</span><span class="n">MDIO_RX0_RX_STATUS_SIGDET</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;Signal is not detected. Restoring CL73.&quot;</span>
			     <span class="s">&quot;rx_status(0x80b0) = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rx_status</span><span class="p">);</span>
		<span class="n">CL22_WR_OVER_CL45</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
				  <span class="n">MDIO_REG_BANK_CL73_IEEEB0</span><span class="p">,</span>
				  <span class="n">MDIO_CL73_IEEEB0_CL73_AN_CONTROL</span><span class="p">,</span>
				  <span class="n">MDIO_CL73_IEEEB0_CL73_AN_CONTROL_AN_EN</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* Step 2: Check CL73 state machine */</span>
	<span class="n">CL22_RD_OVER_CL45</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
			  <span class="n">MDIO_REG_BANK_CL73_USERB0</span><span class="p">,</span>
			  <span class="n">MDIO_CL73_USERB0_CL73_USTAT1</span><span class="p">,</span>
			  <span class="o">&amp;</span><span class="n">ustat_val</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ustat_val</span> <span class="o">&amp;</span>
	     <span class="p">(</span><span class="n">MDIO_CL73_USERB0_CL73_USTAT1_LINK_STATUS_CHECK</span> <span class="o">|</span>
	      <span class="n">MDIO_CL73_USERB0_CL73_USTAT1_AN_GOOD_CHECK_BAM37</span><span class="p">))</span> <span class="o">!=</span>
	    <span class="p">(</span><span class="n">MDIO_CL73_USERB0_CL73_USTAT1_LINK_STATUS_CHECK</span> <span class="o">|</span>
	      <span class="n">MDIO_CL73_USERB0_CL73_USTAT1_AN_GOOD_CHECK_BAM37</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;CL73 state-machine is not stable. &quot;</span>
			     <span class="s">&quot;ustat_val(0x8371) = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ustat_val</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* Step 3: Check CL37 Message Pages received to indicate LP</span>
<span class="cm">	 * supports only CL37</span>
<span class="cm">	 */</span>
	<span class="n">CL22_RD_OVER_CL45</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
			  <span class="n">MDIO_REG_BANK_REMOTE_PHY</span><span class="p">,</span>
			  <span class="n">MDIO_REMOTE_PHY_MISC_RX_STATUS</span><span class="p">,</span>
			  <span class="o">&amp;</span><span class="n">cl37_fsm_received</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">cl37_fsm_received</span> <span class="o">&amp;</span>
	     <span class="p">(</span><span class="n">MDIO_REMOTE_PHY_MISC_RX_STATUS_CL37_FSM_RECEIVED_OVER1G_MSG</span> <span class="o">|</span>
	     <span class="n">MDIO_REMOTE_PHY_MISC_RX_STATUS_CL37_FSM_RECEIVED_BRCM_OUI_MSG</span><span class="p">))</span> <span class="o">!=</span>
	    <span class="p">(</span><span class="n">MDIO_REMOTE_PHY_MISC_RX_STATUS_CL37_FSM_RECEIVED_OVER1G_MSG</span> <span class="o">|</span>
	      <span class="n">MDIO_REMOTE_PHY_MISC_RX_STATUS_CL37_FSM_RECEIVED_BRCM_OUI_MSG</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;No CL37 FSM were received. &quot;</span>
			     <span class="s">&quot;misc_rx_status(0x8330) = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">cl37_fsm_received</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* The combined cl37/cl73 fsm state information indicating that</span>
<span class="cm">	 * we are connected to a device which does not support cl73, but</span>
<span class="cm">	 * does support cl37 BAM. In this case we disable cl73 and</span>
<span class="cm">	 * restart cl37 auto-neg</span>
<span class="cm">	 */</span>

	<span class="cm">/* Disable CL73 */</span>
	<span class="n">CL22_WR_OVER_CL45</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
			  <span class="n">MDIO_REG_BANK_CL73_IEEEB0</span><span class="p">,</span>
			  <span class="n">MDIO_CL73_IEEEB0_CL73_AN_CONTROL</span><span class="p">,</span>
			  <span class="mi">0</span><span class="p">);</span>
	<span class="cm">/* Restart CL37 autoneg */</span>
	<span class="n">bnx2x_restart_autoneg</span><span class="p">(</span><span class="n">phy</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;Disabling CL73, and restarting CL37 autoneg</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_xgxs_an_resolve</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x_phy</span> <span class="o">*</span><span class="n">phy</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">link_params</span> <span class="o">*</span><span class="n">params</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">link_vars</span> <span class="o">*</span><span class="n">vars</span><span class="p">,</span>
				  <span class="n">u32</span> <span class="n">gp_status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">gp_status</span> <span class="o">&amp;</span> <span class="n">MDIO_AN_CL73_OR_37_COMPLETE</span><span class="p">)</span>
		<span class="n">vars</span><span class="o">-&gt;</span><span class="n">link_status</span> <span class="o">|=</span>
			<span class="n">LINK_STATUS_AUTO_NEGOTIATE_COMPLETE</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bnx2x_direct_parallel_detect_used</span><span class="p">(</span><span class="n">phy</span><span class="p">,</span> <span class="n">params</span><span class="p">))</span>
		<span class="n">vars</span><span class="o">-&gt;</span><span class="n">link_status</span> <span class="o">|=</span>
			<span class="n">LINK_STATUS_PARALLEL_DETECTION_USED</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">bnx2x_get_link_speed_duplex</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x_phy</span> <span class="o">*</span><span class="n">phy</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">link_params</span> <span class="o">*</span><span class="n">params</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">link_vars</span> <span class="o">*</span><span class="n">vars</span><span class="p">,</span>
				      <span class="n">u16</span> <span class="n">is_link_up</span><span class="p">,</span>
				      <span class="n">u16</span> <span class="n">speed_mask</span><span class="p">,</span>
				      <span class="n">u16</span> <span class="n">is_duplex</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">bp</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">req_line_speed</span> <span class="o">==</span> <span class="n">SPEED_AUTO_NEG</span><span class="p">)</span>
		<span class="n">vars</span><span class="o">-&gt;</span><span class="n">link_status</span> <span class="o">|=</span> <span class="n">LINK_STATUS_AUTO_NEGOTIATE_ENABLED</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is_link_up</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;phy link up</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="n">vars</span><span class="o">-&gt;</span><span class="n">phy_link_up</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">vars</span><span class="o">-&gt;</span><span class="n">link_status</span> <span class="o">|=</span> <span class="n">LINK_STATUS_LINK_UP</span><span class="p">;</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">speed_mask</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">GP_STATUS_10M</span>:
			<span class="n">vars</span><span class="o">-&gt;</span><span class="n">line_speed</span> <span class="o">=</span> <span class="n">SPEED_10</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">vars</span><span class="o">-&gt;</span><span class="n">duplex</span> <span class="o">==</span> <span class="n">DUPLEX_FULL</span><span class="p">)</span>
				<span class="n">vars</span><span class="o">-&gt;</span><span class="n">link_status</span> <span class="o">|=</span> <span class="n">LINK_10TFD</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">vars</span><span class="o">-&gt;</span><span class="n">link_status</span> <span class="o">|=</span> <span class="n">LINK_10THD</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">GP_STATUS_100M</span>:
			<span class="n">vars</span><span class="o">-&gt;</span><span class="n">line_speed</span> <span class="o">=</span> <span class="n">SPEED_100</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">vars</span><span class="o">-&gt;</span><span class="n">duplex</span> <span class="o">==</span> <span class="n">DUPLEX_FULL</span><span class="p">)</span>
				<span class="n">vars</span><span class="o">-&gt;</span><span class="n">link_status</span> <span class="o">|=</span> <span class="n">LINK_100TXFD</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">vars</span><span class="o">-&gt;</span><span class="n">link_status</span> <span class="o">|=</span> <span class="n">LINK_100TXHD</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">GP_STATUS_1G</span>:
		<span class="k">case</span> <span class="n">GP_STATUS_1G_KX</span>:
			<span class="n">vars</span><span class="o">-&gt;</span><span class="n">line_speed</span> <span class="o">=</span> <span class="n">SPEED_1000</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">vars</span><span class="o">-&gt;</span><span class="n">duplex</span> <span class="o">==</span> <span class="n">DUPLEX_FULL</span><span class="p">)</span>
				<span class="n">vars</span><span class="o">-&gt;</span><span class="n">link_status</span> <span class="o">|=</span> <span class="n">LINK_1000TFD</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">vars</span><span class="o">-&gt;</span><span class="n">link_status</span> <span class="o">|=</span> <span class="n">LINK_1000THD</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">GP_STATUS_2_5G</span>:
			<span class="n">vars</span><span class="o">-&gt;</span><span class="n">line_speed</span> <span class="o">=</span> <span class="n">SPEED_2500</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">vars</span><span class="o">-&gt;</span><span class="n">duplex</span> <span class="o">==</span> <span class="n">DUPLEX_FULL</span><span class="p">)</span>
				<span class="n">vars</span><span class="o">-&gt;</span><span class="n">link_status</span> <span class="o">|=</span> <span class="n">LINK_2500TFD</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">vars</span><span class="o">-&gt;</span><span class="n">link_status</span> <span class="o">|=</span> <span class="n">LINK_2500THD</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">GP_STATUS_5G</span>:
		<span class="k">case</span> <span class="n">GP_STATUS_6G</span>:
			<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span>
				 <span class="s">&quot;link speed unsupported  gp_status 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				  <span class="n">speed_mask</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">GP_STATUS_10G_KX4</span>:
		<span class="k">case</span> <span class="n">GP_STATUS_10G_HIG</span>:
		<span class="k">case</span> <span class="n">GP_STATUS_10G_CX4</span>:
		<span class="k">case</span> <span class="n">GP_STATUS_10G_KR</span>:
		<span class="k">case</span> <span class="n">GP_STATUS_10G_SFI</span>:
		<span class="k">case</span> <span class="n">GP_STATUS_10G_XFI</span>:
			<span class="n">vars</span><span class="o">-&gt;</span><span class="n">line_speed</span> <span class="o">=</span> <span class="n">SPEED_10000</span><span class="p">;</span>
			<span class="n">vars</span><span class="o">-&gt;</span><span class="n">link_status</span> <span class="o">|=</span> <span class="n">LINK_10GTFD</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">GP_STATUS_20G_DXGXS</span>:
			<span class="n">vars</span><span class="o">-&gt;</span><span class="n">line_speed</span> <span class="o">=</span> <span class="n">SPEED_20000</span><span class="p">;</span>
			<span class="n">vars</span><span class="o">-&gt;</span><span class="n">link_status</span> <span class="o">|=</span> <span class="n">LINK_20GTFD</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span>
				  <span class="s">&quot;link speed unsupported gp_status 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				  <span class="n">speed_mask</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="cm">/* link_down */</span>
		<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;phy link down</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="n">vars</span><span class="o">-&gt;</span><span class="n">phy_link_up</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">vars</span><span class="o">-&gt;</span><span class="n">duplex</span> <span class="o">=</span> <span class="n">DUPLEX_FULL</span><span class="p">;</span>
		<span class="n">vars</span><span class="o">-&gt;</span><span class="n">flow_ctrl</span> <span class="o">=</span> <span class="n">BNX2X_FLOW_CTRL_NONE</span><span class="p">;</span>
		<span class="n">vars</span><span class="o">-&gt;</span><span class="n">mac_type</span> <span class="o">=</span> <span class="n">MAC_TYPE_NONE</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot; phy_link_up %x line_speed %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">vars</span><span class="o">-&gt;</span><span class="n">phy_link_up</span><span class="p">,</span> <span class="n">vars</span><span class="o">-&gt;</span><span class="n">line_speed</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bnx2x_link_settings_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x_phy</span> <span class="o">*</span><span class="n">phy</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">link_params</span> <span class="o">*</span><span class="n">params</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">link_vars</span> <span class="o">*</span><span class="n">vars</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">bp</span><span class="p">;</span>

	<span class="n">u16</span> <span class="n">gp_status</span><span class="p">,</span> <span class="n">duplex</span> <span class="o">=</span> <span class="n">DUPLEX_HALF</span><span class="p">,</span> <span class="n">link_up</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">speed_mask</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Read gp_status */</span>
	<span class="n">CL22_RD_OVER_CL45</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
			  <span class="n">MDIO_REG_BANK_GP_STATUS</span><span class="p">,</span>
			  <span class="n">MDIO_GP_STATUS_TOP_AN_STATUS1</span><span class="p">,</span>
			  <span class="o">&amp;</span><span class="n">gp_status</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">gp_status</span> <span class="o">&amp;</span> <span class="n">MDIO_GP_STATUS_TOP_AN_STATUS1_DUPLEX_STATUS</span><span class="p">)</span>
		<span class="n">duplex</span> <span class="o">=</span> <span class="n">DUPLEX_FULL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">gp_status</span> <span class="o">&amp;</span> <span class="n">MDIO_GP_STATUS_TOP_AN_STATUS1_LINK_STATUS</span><span class="p">)</span>
		<span class="n">link_up</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">speed_mask</span> <span class="o">=</span> <span class="n">gp_status</span> <span class="o">&amp;</span> <span class="n">GP_STATUS_SPEED_MASK</span><span class="p">;</span>
	<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;gp_status 0x%x, is_link_up %d, speed_mask 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">gp_status</span><span class="p">,</span> <span class="n">link_up</span><span class="p">,</span> <span class="n">speed_mask</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">bnx2x_get_link_speed_duplex</span><span class="p">(</span><span class="n">phy</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">vars</span><span class="p">,</span> <span class="n">link_up</span><span class="p">,</span> <span class="n">speed_mask</span><span class="p">,</span>
					 <span class="n">duplex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">gp_status</span> <span class="o">&amp;</span> <span class="n">MDIO_GP_STATUS_TOP_AN_STATUS1_LINK_STATUS</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">SINGLE_MEDIA_DIRECT</span><span class="p">(</span><span class="n">params</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">bnx2x_flow_ctrl_resolve</span><span class="p">(</span><span class="n">phy</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">vars</span><span class="p">,</span> <span class="n">gp_status</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">req_line_speed</span> <span class="o">==</span> <span class="n">SPEED_AUTO_NEG</span><span class="p">)</span>
				<span class="n">bnx2x_xgxs_an_resolve</span><span class="p">(</span><span class="n">phy</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">vars</span><span class="p">,</span>
						      <span class="n">gp_status</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="cm">/* link_down */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">req_line_speed</span> <span class="o">==</span> <span class="n">SPEED_AUTO_NEG</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="n">SINGLE_MEDIA_DIRECT</span><span class="p">(</span><span class="n">params</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* Check signal is detected */</span>
			<span class="n">bnx2x_check_fallback_to_cl37</span><span class="p">(</span><span class="n">phy</span><span class="p">,</span> <span class="n">params</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Read LP advertised speeds*/</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">SINGLE_MEDIA_DIRECT</span><span class="p">(</span><span class="n">params</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">vars</span><span class="o">-&gt;</span><span class="n">link_status</span> <span class="o">&amp;</span> <span class="n">LINK_STATUS_AUTO_NEGOTIATE_COMPLETE</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">u16</span> <span class="n">val</span><span class="p">;</span>

		<span class="n">CL22_RD_OVER_CL45</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_REG_BANK_CL73_IEEEB1</span><span class="p">,</span>
				  <span class="n">MDIO_CL73_IEEEB1_AN_LP_ADV2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">MDIO_CL73_IEEEB1_AN_ADV2_ADVR_1000M_KX</span><span class="p">)</span>
			<span class="n">vars</span><span class="o">-&gt;</span><span class="n">link_status</span> <span class="o">|=</span>
				<span class="n">LINK_STATUS_LINK_PARTNER_1000TFD_CAPABLE</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">MDIO_CL73_IEEEB1_AN_ADV2_ADVR_10G_KX4</span> <span class="o">|</span>
			   <span class="n">MDIO_CL73_IEEEB1_AN_ADV2_ADVR_10G_KR</span><span class="p">))</span>
			<span class="n">vars</span><span class="o">-&gt;</span><span class="n">link_status</span> <span class="o">|=</span>
				<span class="n">LINK_STATUS_LINK_PARTNER_10GXFD_CAPABLE</span><span class="p">;</span>

		<span class="n">CL22_RD_OVER_CL45</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_REG_BANK_OVER_1G</span><span class="p">,</span>
				  <span class="n">MDIO_OVER_1G_LP_UP1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">MDIO_OVER_1G_UP1_2_5G</span><span class="p">)</span>
			<span class="n">vars</span><span class="o">-&gt;</span><span class="n">link_status</span> <span class="o">|=</span>
				<span class="n">LINK_STATUS_LINK_PARTNER_2500XFD_CAPABLE</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">MDIO_OVER_1G_UP1_10G</span> <span class="o">|</span> <span class="n">MDIO_OVER_1G_UP1_10GH</span><span class="p">))</span>
			<span class="n">vars</span><span class="o">-&gt;</span><span class="n">link_status</span> <span class="o">|=</span>
				<span class="n">LINK_STATUS_LINK_PARTNER_10GXFD_CAPABLE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;duplex %x  flow_ctrl 0x%x link_status 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">vars</span><span class="o">-&gt;</span><span class="n">duplex</span><span class="p">,</span> <span class="n">vars</span><span class="o">-&gt;</span><span class="n">flow_ctrl</span><span class="p">,</span> <span class="n">vars</span><span class="o">-&gt;</span><span class="n">link_status</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bnx2x_warpcore_read_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x_phy</span> <span class="o">*</span><span class="n">phy</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">link_params</span> <span class="o">*</span><span class="n">params</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">link_vars</span> <span class="o">*</span><span class="n">vars</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">bp</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">lane</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">gp_status1</span><span class="p">,</span> <span class="n">gp_speed</span><span class="p">,</span> <span class="n">link_up</span><span class="p">,</span> <span class="n">duplex</span> <span class="o">=</span> <span class="n">DUPLEX_FULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">lane</span> <span class="o">=</span> <span class="n">bnx2x_get_warpcore_lane</span><span class="p">(</span><span class="n">phy</span><span class="p">,</span> <span class="n">params</span><span class="p">);</span>
	<span class="cm">/* Read gp_status */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">req_line_speed</span> <span class="o">&gt;</span> <span class="n">SPEED_10000</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u16</span> <span class="n">temp_link_up</span><span class="p">;</span>
		<span class="n">bnx2x_cl45_read</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_WC_DEVAD</span><span class="p">,</span>
				<span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">temp_link_up</span><span class="p">);</span>
		<span class="n">bnx2x_cl45_read</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_WC_DEVAD</span><span class="p">,</span>
				<span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">link_up</span><span class="p">);</span>
		<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;PCS RX link status = 0x%x--&gt;0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">temp_link_up</span><span class="p">,</span> <span class="n">link_up</span><span class="p">);</span>
		<span class="n">link_up</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">2</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">link_up</span><span class="p">)</span>
			<span class="n">bnx2x_ext_phy_resolve_fc</span><span class="p">(</span><span class="n">phy</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">vars</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">bnx2x_cl45_read</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_WC_DEVAD</span><span class="p">,</span>
				<span class="n">MDIO_WC_REG_GP2_STATUS_GP_2_1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gp_status1</span><span class="p">);</span>
		<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;0x81d1 = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">gp_status1</span><span class="p">);</span>
		<span class="cm">/* Check for either KR or generic link up. */</span>
		<span class="n">gp_status1</span> <span class="o">=</span> <span class="p">((</span><span class="n">gp_status1</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">((</span><span class="n">gp_status1</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">);</span>
		<span class="n">link_up</span> <span class="o">=</span> <span class="n">gp_status1</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">lane</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">link_up</span> <span class="o">&amp;&amp;</span> <span class="n">SINGLE_MEDIA_DIRECT</span><span class="p">(</span><span class="n">params</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">u16</span> <span class="n">pd</span><span class="p">,</span> <span class="n">gp_status4</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">req_line_speed</span> <span class="o">==</span> <span class="n">SPEED_AUTO_NEG</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* Check Autoneg complete */</span>
				<span class="n">bnx2x_cl45_read</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_WC_DEVAD</span><span class="p">,</span>
						<span class="n">MDIO_WC_REG_GP2_STATUS_GP_2_4</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">gp_status4</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">gp_status4</span> <span class="o">&amp;</span> <span class="p">((</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">12</span><span class="p">)</span><span class="o">&lt;&lt;</span><span class="n">lane</span><span class="p">))</span>
					<span class="n">vars</span><span class="o">-&gt;</span><span class="n">link_status</span> <span class="o">|=</span>
					<span class="n">LINK_STATUS_AUTO_NEGOTIATE_COMPLETE</span><span class="p">;</span>

				<span class="cm">/* Check parallel detect used */</span>
				<span class="n">bnx2x_cl45_read</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_WC_DEVAD</span><span class="p">,</span>
						<span class="n">MDIO_WC_REG_PAR_DET_10G_STATUS</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">pd</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">pd</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">15</span><span class="p">))</span>
					<span class="n">vars</span><span class="o">-&gt;</span><span class="n">link_status</span> <span class="o">|=</span>
					<span class="n">LINK_STATUS_PARALLEL_DETECTION_USED</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">bnx2x_ext_phy_resolve_fc</span><span class="p">(</span><span class="n">phy</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">vars</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">vars</span><span class="o">-&gt;</span><span class="n">link_status</span> <span class="o">&amp;</span> <span class="n">LINK_STATUS_AUTO_NEGOTIATE_COMPLETE</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">SINGLE_MEDIA_DIRECT</span><span class="p">(</span><span class="n">params</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">u16</span> <span class="n">val</span><span class="p">;</span>

		<span class="n">bnx2x_cl45_read</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_AN_DEVAD</span><span class="p">,</span>
				<span class="n">MDIO_AN_REG_LP_AUTO_NEG2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">MDIO_CL73_IEEEB1_AN_ADV2_ADVR_1000M_KX</span><span class="p">)</span>
			<span class="n">vars</span><span class="o">-&gt;</span><span class="n">link_status</span> <span class="o">|=</span>
				<span class="n">LINK_STATUS_LINK_PARTNER_1000TFD_CAPABLE</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">MDIO_CL73_IEEEB1_AN_ADV2_ADVR_10G_KX4</span> <span class="o">|</span>
			   <span class="n">MDIO_CL73_IEEEB1_AN_ADV2_ADVR_10G_KR</span><span class="p">))</span>
			<span class="n">vars</span><span class="o">-&gt;</span><span class="n">link_status</span> <span class="o">|=</span>
				<span class="n">LINK_STATUS_LINK_PARTNER_10GXFD_CAPABLE</span><span class="p">;</span>

		<span class="n">bnx2x_cl45_read</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_WC_DEVAD</span><span class="p">,</span>
				<span class="n">MDIO_WC_REG_DIGITAL3_LP_UP1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">MDIO_OVER_1G_UP1_2_5G</span><span class="p">)</span>
			<span class="n">vars</span><span class="o">-&gt;</span><span class="n">link_status</span> <span class="o">|=</span>
				<span class="n">LINK_STATUS_LINK_PARTNER_2500XFD_CAPABLE</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">MDIO_OVER_1G_UP1_10G</span> <span class="o">|</span> <span class="n">MDIO_OVER_1G_UP1_10GH</span><span class="p">))</span>
			<span class="n">vars</span><span class="o">-&gt;</span><span class="n">link_status</span> <span class="o">|=</span>
				<span class="n">LINK_STATUS_LINK_PARTNER_10GXFD_CAPABLE</span><span class="p">;</span>

	<span class="p">}</span>


	<span class="k">if</span> <span class="p">(</span><span class="n">lane</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bnx2x_cl45_read</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_WC_DEVAD</span><span class="p">,</span>
				<span class="n">MDIO_WC_REG_GP2_STATUS_GP_2_2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gp_speed</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">bnx2x_cl45_read</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_WC_DEVAD</span><span class="p">,</span>
				<span class="n">MDIO_WC_REG_GP2_STATUS_GP_2_3</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gp_speed</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;lane %d gp_speed 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">lane</span><span class="p">,</span> <span class="n">gp_speed</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">lane</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">gp_speed</span> <span class="o">&lt;&lt;=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">gp_speed</span> <span class="o">&amp;=</span> <span class="mh">0x3f00</span><span class="p">;</span>


	<span class="n">rc</span> <span class="o">=</span> <span class="n">bnx2x_get_link_speed_duplex</span><span class="p">(</span><span class="n">phy</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">vars</span><span class="p">,</span> <span class="n">link_up</span><span class="p">,</span> <span class="n">gp_speed</span><span class="p">,</span>
					 <span class="n">duplex</span><span class="p">);</span>

	<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;duplex %x  flow_ctrl 0x%x link_status 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">vars</span><span class="o">-&gt;</span><span class="n">duplex</span><span class="p">,</span> <span class="n">vars</span><span class="o">-&gt;</span><span class="n">flow_ctrl</span><span class="p">,</span> <span class="n">vars</span><span class="o">-&gt;</span><span class="n">link_status</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_set_gmii_tx_driver</span><span class="p">(</span><span class="k">struct</span> <span class="n">link_params</span> <span class="o">*</span><span class="n">params</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">bp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bnx2x_phy</span> <span class="o">*</span><span class="n">phy</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">[</span><span class="n">INT_PHY</span><span class="p">];</span>
	<span class="n">u16</span> <span class="n">lp_up2</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">tx_driver</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">bank</span><span class="p">;</span>

	<span class="cm">/* read precomp */</span>
	<span class="n">CL22_RD_OVER_CL45</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
			  <span class="n">MDIO_REG_BANK_OVER_1G</span><span class="p">,</span>
			  <span class="n">MDIO_OVER_1G_LP_UP2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lp_up2</span><span class="p">);</span>

	<span class="cm">/* bits [10:7] at lp_up2, positioned at [15:12] */</span>
	<span class="n">lp_up2</span> <span class="o">=</span> <span class="p">(((</span><span class="n">lp_up2</span> <span class="o">&amp;</span> <span class="n">MDIO_OVER_1G_LP_UP2_PREEMPHASIS_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span>
		   <span class="n">MDIO_OVER_1G_LP_UP2_PREEMPHASIS_SHIFT</span><span class="p">)</span> <span class="o">&lt;&lt;</span>
		  <span class="n">MDIO_TX0_TX_DRIVER_PREEMPHASIS_SHIFT</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lp_up2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">bank</span> <span class="o">=</span> <span class="n">MDIO_REG_BANK_TX0</span><span class="p">;</span> <span class="n">bank</span> <span class="o">&lt;=</span> <span class="n">MDIO_REG_BANK_TX3</span><span class="p">;</span>
	      <span class="n">bank</span> <span class="o">+=</span> <span class="p">(</span><span class="n">MDIO_REG_BANK_TX1</span> <span class="o">-</span> <span class="n">MDIO_REG_BANK_TX0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">CL22_RD_OVER_CL45</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
				  <span class="n">bank</span><span class="p">,</span>
				  <span class="n">MDIO_TX0_TX_DRIVER</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tx_driver</span><span class="p">);</span>

		<span class="cm">/* replace tx_driver bits [15:12] */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lp_up2</span> <span class="o">!=</span>
		    <span class="p">(</span><span class="n">tx_driver</span> <span class="o">&amp;</span> <span class="n">MDIO_TX0_TX_DRIVER_PREEMPHASIS_MASK</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">tx_driver</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MDIO_TX0_TX_DRIVER_PREEMPHASIS_MASK</span><span class="p">;</span>
			<span class="n">tx_driver</span> <span class="o">|=</span> <span class="n">lp_up2</span><span class="p">;</span>
			<span class="n">CL22_WR_OVER_CL45</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
					  <span class="n">bank</span><span class="p">,</span>
					  <span class="n">MDIO_TX0_TX_DRIVER</span><span class="p">,</span> <span class="n">tx_driver</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bnx2x_emac_program</span><span class="p">(</span><span class="k">struct</span> <span class="n">link_params</span> <span class="o">*</span><span class="n">params</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">link_vars</span> <span class="o">*</span><span class="n">vars</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">bp</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">port</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">mode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;setting link speed &amp; duplex</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">bnx2x_bits_dis</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">GRCBASE_EMAC0</span> <span class="o">+</span> <span class="n">port</span><span class="o">*</span><span class="mh">0x400</span> <span class="o">+</span>
		       <span class="n">EMAC_REG_EMAC_MODE</span><span class="p">,</span>
		       <span class="p">(</span><span class="n">EMAC_MODE_25G_MODE</span> <span class="o">|</span>
			<span class="n">EMAC_MODE_PORT_MII_10M</span> <span class="o">|</span>
			<span class="n">EMAC_MODE_HALF_DUPLEX</span><span class="p">));</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">vars</span><span class="o">-&gt;</span><span class="n">line_speed</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SPEED_10</span>:
		<span class="n">mode</span> <span class="o">|=</span> <span class="n">EMAC_MODE_PORT_MII_10M</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SPEED_100</span>:
		<span class="n">mode</span> <span class="o">|=</span> <span class="n">EMAC_MODE_PORT_MII</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SPEED_1000</span>:
		<span class="n">mode</span> <span class="o">|=</span> <span class="n">EMAC_MODE_PORT_GMII</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SPEED_2500</span>:
		<span class="n">mode</span> <span class="o">|=</span> <span class="p">(</span><span class="n">EMAC_MODE_25G_MODE</span> <span class="o">|</span> <span class="n">EMAC_MODE_PORT_GMII</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="cm">/* 10G not valid for EMAC */</span>
		<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;Invalid line_speed 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">vars</span><span class="o">-&gt;</span><span class="n">line_speed</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vars</span><span class="o">-&gt;</span><span class="n">duplex</span> <span class="o">==</span> <span class="n">DUPLEX_HALF</span><span class="p">)</span>
		<span class="n">mode</span> <span class="o">|=</span> <span class="n">EMAC_MODE_HALF_DUPLEX</span><span class="p">;</span>
	<span class="n">bnx2x_bits_en</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span>
		      <span class="n">GRCBASE_EMAC0</span> <span class="o">+</span> <span class="n">port</span><span class="o">*</span><span class="mh">0x400</span> <span class="o">+</span> <span class="n">EMAC_REG_EMAC_MODE</span><span class="p">,</span>
		      <span class="n">mode</span><span class="p">);</span>

	<span class="n">bnx2x_set_led</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">vars</span><span class="p">,</span> <span class="n">LED_MODE_OPER</span><span class="p">,</span> <span class="n">vars</span><span class="o">-&gt;</span><span class="n">line_speed</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_set_preemphasis</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x_phy</span> <span class="o">*</span><span class="n">phy</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">link_params</span> <span class="o">*</span><span class="n">params</span><span class="p">)</span>
<span class="p">{</span>

	<span class="n">u16</span> <span class="n">bank</span><span class="p">,</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">bp</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">bank</span> <span class="o">=</span> <span class="n">MDIO_REG_BANK_RX0</span><span class="p">,</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">bank</span> <span class="o">&lt;=</span> <span class="n">MDIO_REG_BANK_RX3</span><span class="p">;</span>
	      <span class="n">bank</span> <span class="o">+=</span> <span class="p">(</span><span class="n">MDIO_REG_BANK_RX1</span><span class="o">-</span><span class="n">MDIO_REG_BANK_RX0</span><span class="p">),</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">CL22_WR_OVER_CL45</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
					  <span class="n">bank</span><span class="p">,</span>
					  <span class="n">MDIO_RX0_RX_EQ_BOOST</span><span class="p">,</span>
					  <span class="n">phy</span><span class="o">-&gt;</span><span class="n">rx_preemphasis</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">bank</span> <span class="o">=</span> <span class="n">MDIO_REG_BANK_TX0</span><span class="p">,</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">bank</span> <span class="o">&lt;=</span> <span class="n">MDIO_REG_BANK_TX3</span><span class="p">;</span>
		      <span class="n">bank</span> <span class="o">+=</span> <span class="p">(</span><span class="n">MDIO_REG_BANK_TX1</span> <span class="o">-</span> <span class="n">MDIO_REG_BANK_TX0</span><span class="p">),</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">CL22_WR_OVER_CL45</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
					  <span class="n">bank</span><span class="p">,</span>
					  <span class="n">MDIO_TX0_TX_DRIVER</span><span class="p">,</span>
					  <span class="n">phy</span><span class="o">-&gt;</span><span class="n">tx_preemphasis</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_xgxs_config_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x_phy</span> <span class="o">*</span><span class="n">phy</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">link_params</span> <span class="o">*</span><span class="n">params</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">link_vars</span> <span class="o">*</span><span class="n">vars</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">bp</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">enable_cl73</span> <span class="o">=</span> <span class="p">(</span><span class="n">SINGLE_MEDIA_DIRECT</span><span class="p">(</span><span class="n">params</span><span class="p">)</span> <span class="o">||</span>
			  <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">loopback_mode</span> <span class="o">==</span> <span class="n">LOOPBACK_XGXS</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">vars</span><span class="o">-&gt;</span><span class="n">phy_flags</span> <span class="o">&amp;</span> <span class="n">PHY_SGMII_FLAG</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">SINGLE_MEDIA_DIRECT</span><span class="p">(</span><span class="n">params</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">feature_config_flags</span> <span class="o">&amp;</span>
		     <span class="n">FEATURE_CONFIG_OVERRIDE_PREEMPHASIS_ENABLED</span><span class="p">))</span>
			<span class="n">bnx2x_set_preemphasis</span><span class="p">(</span><span class="n">phy</span><span class="p">,</span> <span class="n">params</span><span class="p">);</span>

		<span class="cm">/* forced speed requested? */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vars</span><span class="o">-&gt;</span><span class="n">line_speed</span> <span class="o">!=</span> <span class="n">SPEED_AUTO_NEG</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">SINGLE_MEDIA_DIRECT</span><span class="p">(</span><span class="n">params</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		     <span class="n">params</span><span class="o">-&gt;</span><span class="n">loopback_mode</span> <span class="o">==</span> <span class="n">LOOPBACK_EXT</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;not SGMII, no AN</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

			<span class="cm">/* disable autoneg */</span>
			<span class="n">bnx2x_set_autoneg</span><span class="p">(</span><span class="n">phy</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">vars</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

			<span class="cm">/* program speed and duplex */</span>
			<span class="n">bnx2x_program_serdes</span><span class="p">(</span><span class="n">phy</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">vars</span><span class="p">);</span>

		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="cm">/* AN_mode */</span>
			<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;not SGMII, AN</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

			<span class="cm">/* AN enabled */</span>
			<span class="n">bnx2x_set_brcm_cl37_advertisement</span><span class="p">(</span><span class="n">phy</span><span class="p">,</span> <span class="n">params</span><span class="p">);</span>

			<span class="cm">/* program duplex &amp; pause advertisement (for aneg) */</span>
			<span class="n">bnx2x_set_ieee_aneg_advertisement</span><span class="p">(</span><span class="n">phy</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span>
							  <span class="n">vars</span><span class="o">-&gt;</span><span class="n">ieee_fc</span><span class="p">);</span>

			<span class="cm">/* enable autoneg */</span>
			<span class="n">bnx2x_set_autoneg</span><span class="p">(</span><span class="n">phy</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">vars</span><span class="p">,</span> <span class="n">enable_cl73</span><span class="p">);</span>

			<span class="cm">/* enable and restart AN */</span>
			<span class="n">bnx2x_restart_autoneg</span><span class="p">(</span><span class="n">phy</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">enable_cl73</span><span class="p">);</span>
		<span class="p">}</span>

	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="cm">/* SGMII mode */</span>
		<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;SGMII</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="n">bnx2x_initialize_sgmii_process</span><span class="p">(</span><span class="n">phy</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">vars</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bnx2x_prepare_xgxs</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x_phy</span> <span class="o">*</span><span class="n">phy</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">link_params</span> <span class="o">*</span><span class="n">params</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">link_vars</span> <span class="o">*</span><span class="n">vars</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="n">vars</span><span class="o">-&gt;</span><span class="n">phy_flags</span> <span class="o">|=</span> <span class="n">PHY_XGXS_FLAG</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">req_line_speed</span> <span class="o">&amp;&amp;</span>
	     <span class="p">((</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">req_line_speed</span> <span class="o">==</span> <span class="n">SPEED_100</span><span class="p">)</span> <span class="o">||</span>
	      <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">req_line_speed</span> <span class="o">==</span> <span class="n">SPEED_10</span><span class="p">)))</span> <span class="o">||</span>
	    <span class="p">(</span><span class="o">!</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">req_line_speed</span> <span class="o">&amp;&amp;</span>
	     <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">speed_cap_mask</span> <span class="o">&gt;=</span>
	      <span class="n">PORT_HW_CFG_SPEED_CAPABILITY_D0_10M_FULL</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	     <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">speed_cap_mask</span> <span class="o">&lt;</span>
	      <span class="n">PORT_HW_CFG_SPEED_CAPABILITY_D0_1G</span><span class="p">))</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">PORT_HW_CFG_SERDES_EXT_PHY_TYPE_DIRECT_SD</span><span class="p">))</span>
		<span class="n">vars</span><span class="o">-&gt;</span><span class="n">phy_flags</span> <span class="o">|=</span> <span class="n">PHY_SGMII_FLAG</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">vars</span><span class="o">-&gt;</span><span class="n">phy_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PHY_SGMII_FLAG</span><span class="p">;</span>

	<span class="n">bnx2x_calc_ieee_aneg_adv</span><span class="p">(</span><span class="n">phy</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vars</span><span class="o">-&gt;</span><span class="n">ieee_fc</span><span class="p">);</span>
	<span class="n">bnx2x_set_aer_mmd</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">phy</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">PORT_HW_CFG_XGXS_EXT_PHY_TYPE_DIRECT</span><span class="p">)</span>
		<span class="n">bnx2x_set_master_ln</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">phy</span><span class="p">);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">bnx2x_reset_unicore</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="cm">/* reset the SerDes and wait for reset bit return low */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">bnx2x_set_aer_mmd</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">phy</span><span class="p">);</span>
	<span class="cm">/* setting the masterLn_def again after the reset */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">PORT_HW_CFG_XGXS_EXT_PHY_TYPE_DIRECT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bnx2x_set_master_ln</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">phy</span><span class="p">);</span>
		<span class="n">bnx2x_set_swap_lanes</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">phy</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u16</span> <span class="nf">bnx2x_wait_reset_complete</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">bnx2x_phy</span> <span class="o">*</span><span class="n">phy</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">link_params</span> <span class="o">*</span><span class="n">params</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">cnt</span><span class="p">,</span> <span class="n">ctrl</span><span class="p">;</span>
	<span class="cm">/* Wait for soft reset to get cleared up to 1 sec */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">cnt</span> <span class="o">&lt;</span> <span class="mi">1000</span><span class="p">;</span> <span class="n">cnt</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">PORT_HW_CFG_XGXS_EXT_PHY_TYPE_BCM54618SE</span><span class="p">)</span>
			<span class="n">bnx2x_cl22_read</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
				<span class="n">MDIO_PMA_REG_CTRL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ctrl</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">bnx2x_cl45_read</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
				<span class="n">MDIO_PMA_DEVAD</span><span class="p">,</span>
				<span class="n">MDIO_PMA_REG_CTRL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ctrl</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ctrl</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">15</span><span class="p">)))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">==</span> <span class="mi">1000</span><span class="p">)</span>
		<span class="n">netdev_err</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>  <span class="s">&quot;Warning: PHY was not initialized,&quot;</span>
				      <span class="s">&quot; Port %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">params</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">);</span>
	<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;control reg 0x%x (after %d ms)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ctrl</span><span class="p">,</span> <span class="n">cnt</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">cnt</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_link_int_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">link_params</span> <span class="o">*</span><span class="n">params</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">port</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">mask</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">bp</span><span class="p">;</span>

	<span class="cm">/* Setting the status to report on link up for either XGXS or SerDes */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">CHIP_IS_E3</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">mask</span> <span class="o">=</span> <span class="n">NIG_MASK_XGXS0_LINK_STATUS</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">SINGLE_MEDIA_DIRECT</span><span class="p">(</span><span class="n">params</span><span class="p">)))</span>
			<span class="n">mask</span> <span class="o">|=</span> <span class="n">NIG_MASK_MI_INT</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">switch_cfg</span> <span class="o">==</span> <span class="n">SWITCH_CFG_10G</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">NIG_MASK_XGXS0_LINK10G</span> <span class="o">|</span>
			<span class="n">NIG_MASK_XGXS0_LINK_STATUS</span><span class="p">);</span>
		<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;enabled XGXS interrupt</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">SINGLE_MEDIA_DIRECT</span><span class="p">(</span><span class="n">params</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
			<span class="n">params</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">[</span><span class="n">INT_PHY</span><span class="p">].</span><span class="n">type</span> <span class="o">!=</span>
				<span class="n">PORT_HW_CFG_XGXS_EXT_PHY_TYPE_FAILURE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mask</span> <span class="o">|=</span> <span class="n">NIG_MASK_MI_INT</span><span class="p">;</span>
			<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;enabled external phy int</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>

	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="cm">/* SerDes */</span>
		<span class="n">mask</span> <span class="o">=</span> <span class="n">NIG_MASK_SERDES0_LINK_STATUS</span><span class="p">;</span>
		<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;enabled SerDes interrupt</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">SINGLE_MEDIA_DIRECT</span><span class="p">(</span><span class="n">params</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
			<span class="n">params</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">[</span><span class="n">INT_PHY</span><span class="p">].</span><span class="n">type</span> <span class="o">!=</span>
				<span class="n">PORT_HW_CFG_SERDES_EXT_PHY_TYPE_NOT_CONN</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mask</span> <span class="o">|=</span> <span class="n">NIG_MASK_MI_INT</span><span class="p">;</span>
			<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;enabled external phy int</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">bnx2x_bits_en</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span>
		      <span class="n">NIG_REG_MASK_INTERRUPT_PORT0</span> <span class="o">+</span> <span class="n">port</span><span class="o">*</span><span class="mi">4</span><span class="p">,</span>
		      <span class="n">mask</span><span class="p">);</span>

	<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;port %x, is_xgxs %x, int_status 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span>
		 <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">switch_cfg</span> <span class="o">==</span> <span class="n">SWITCH_CFG_10G</span><span class="p">),</span>
		 <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">NIG_REG_STATUS_INTERRUPT_PORT0</span> <span class="o">+</span> <span class="n">port</span><span class="o">*</span><span class="mi">4</span><span class="p">));</span>
	<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot; int_mask 0x%x, MI_INT %x, SERDES_LINK %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">NIG_REG_MASK_INTERRUPT_PORT0</span> <span class="o">+</span> <span class="n">port</span><span class="o">*</span><span class="mi">4</span><span class="p">),</span>
		 <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">NIG_REG_EMAC0_STATUS_MISC_MI_INT</span> <span class="o">+</span> <span class="n">port</span><span class="o">*</span><span class="mh">0x18</span><span class="p">),</span>
		 <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">NIG_REG_SERDES0_STATUS_LINK_STATUS</span><span class="o">+</span><span class="n">port</span><span class="o">*</span><span class="mh">0x3c</span><span class="p">));</span>
	<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot; 10G %x, XGXS_LINK %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	   <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">NIG_REG_XGXS0_STATUS_LINK10G</span> <span class="o">+</span> <span class="n">port</span><span class="o">*</span><span class="mh">0x68</span><span class="p">),</span>
	   <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">NIG_REG_XGXS0_STATUS_LINK_STATUS</span> <span class="o">+</span> <span class="n">port</span><span class="o">*</span><span class="mh">0x68</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_rearm_latch_signal</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">,</span> <span class="n">u8</span> <span class="n">port</span><span class="p">,</span>
				     <span class="n">u8</span> <span class="n">exp_mi_int</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">latch_status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Disable the MI INT ( external phy int ) by writing 1 to the</span>
<span class="cm">	 * status register. Link down indication is high-active-signal,</span>
<span class="cm">	 * so in this case we need to write the status to clear the XOR</span>
<span class="cm">	 */</span>
	<span class="cm">/* Read Latched signals */</span>
	<span class="n">latch_status</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span>
				    <span class="n">NIG_REG_LATCH_STATUS_0</span> <span class="o">+</span> <span class="n">port</span><span class="o">*</span><span class="mi">8</span><span class="p">);</span>
	<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;latch_status = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">latch_status</span><span class="p">);</span>
	<span class="cm">/* Handle only those with latched-signal=up.*/</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">exp_mi_int</span><span class="p">)</span>
		<span class="n">bnx2x_bits_en</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span>
			      <span class="n">NIG_REG_STATUS_INTERRUPT_PORT0</span>
			      <span class="o">+</span> <span class="n">port</span><span class="o">*</span><span class="mi">4</span><span class="p">,</span>
			      <span class="n">NIG_STATUS_EMAC0_MI_INT</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">bnx2x_bits_dis</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span>
			       <span class="n">NIG_REG_STATUS_INTERRUPT_PORT0</span>
			       <span class="o">+</span> <span class="n">port</span><span class="o">*</span><span class="mi">4</span><span class="p">,</span>
			       <span class="n">NIG_STATUS_EMAC0_MI_INT</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">latch_status</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>

		<span class="cm">/* For all latched-signal=up : Re-Arm Latch signals */</span>
		<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">NIG_REG_LATCH_STATUS_0</span> <span class="o">+</span> <span class="n">port</span><span class="o">*</span><span class="mi">8</span><span class="p">,</span>
		       <span class="p">(</span><span class="n">latch_status</span> <span class="o">&amp;</span> <span class="mh">0xfffe</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">latch_status</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="cm">/* For all latched-signal=up,Write original_signal to status */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_link_int_ack</span><span class="p">(</span><span class="k">struct</span> <span class="n">link_params</span> <span class="o">*</span><span class="n">params</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">link_vars</span> <span class="o">*</span><span class="n">vars</span><span class="p">,</span> <span class="n">u8</span> <span class="n">is_10g_plus</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">bp</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">port</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">mask</span><span class="p">;</span>
	<span class="cm">/* First reset all status we assume only one line will be</span>
<span class="cm">	 * change at a time</span>
<span class="cm">	 */</span>
	<span class="n">bnx2x_bits_dis</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">NIG_REG_STATUS_INTERRUPT_PORT0</span> <span class="o">+</span> <span class="n">port</span><span class="o">*</span><span class="mi">4</span><span class="p">,</span>
		       <span class="p">(</span><span class="n">NIG_STATUS_XGXS0_LINK10G</span> <span class="o">|</span>
			<span class="n">NIG_STATUS_XGXS0_LINK_STATUS</span> <span class="o">|</span>
			<span class="n">NIG_STATUS_SERDES0_LINK_STATUS</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vars</span><span class="o">-&gt;</span><span class="n">phy_link_up</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">USES_WARPCORE</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span>
			<span class="n">mask</span> <span class="o">=</span> <span class="n">NIG_STATUS_XGXS0_LINK_STATUS</span><span class="p">;</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">is_10g_plus</span><span class="p">)</span>
				<span class="n">mask</span> <span class="o">=</span> <span class="n">NIG_STATUS_XGXS0_LINK10G</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">switch_cfg</span> <span class="o">==</span> <span class="n">SWITCH_CFG_10G</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* Disable the link interrupt by writing 1 to</span>
<span class="cm">				 * the relevant lane in the status register</span>
<span class="cm">				 */</span>
				<span class="n">u32</span> <span class="n">ser_lane</span> <span class="o">=</span>
					<span class="p">((</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">lane_config</span> <span class="o">&amp;</span>
				    <span class="n">PORT_HW_CFG_LANE_SWAP_CFG_MASTER_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span>
				    <span class="n">PORT_HW_CFG_LANE_SWAP_CFG_MASTER_SHIFT</span><span class="p">);</span>
				<span class="n">mask</span> <span class="o">=</span> <span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">ser_lane</span><span class="p">)</span> <span class="o">&lt;&lt;</span>
				       <span class="n">NIG_STATUS_XGXS0_LINK_STATUS_SIZE</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="n">mask</span> <span class="o">=</span> <span class="n">NIG_STATUS_SERDES0_LINK_STATUS</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;Ack link up interrupt with mask 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">mask</span><span class="p">);</span>
		<span class="n">bnx2x_bits_en</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span>
			      <span class="n">NIG_REG_STATUS_INTERRUPT_PORT0</span> <span class="o">+</span> <span class="n">port</span><span class="o">*</span><span class="mi">4</span><span class="p">,</span>
			      <span class="n">mask</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bnx2x_format_ver</span><span class="p">(</span><span class="n">u32</span> <span class="n">num</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">str</span><span class="p">,</span> <span class="n">u16</span> <span class="o">*</span><span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">str_ptr</span> <span class="o">=</span> <span class="n">str</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">mask</span> <span class="o">=</span> <span class="mh">0xf0000000</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">shift</span> <span class="o">=</span> <span class="mi">8</span><span class="o">*</span><span class="mi">4</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">digit</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">remove_leading_zeros</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">len</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Need more than 10chars for this format */</span>
		<span class="o">*</span><span class="n">str_ptr</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
		<span class="p">(</span><span class="o">*</span><span class="n">len</span><span class="p">)</span><span class="o">--</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">shift</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">shift</span> <span class="o">-=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">digit</span> <span class="o">=</span> <span class="p">((</span><span class="n">num</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">shift</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">digit</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">remove_leading_zeros</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">;</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">digit</span> <span class="o">&lt;</span> <span class="mh">0xa</span><span class="p">)</span>
			<span class="o">*</span><span class="n">str_ptr</span> <span class="o">=</span> <span class="n">digit</span> <span class="o">+</span> <span class="sc">&#39;0&#39;</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="o">*</span><span class="n">str_ptr</span> <span class="o">=</span> <span class="n">digit</span> <span class="o">-</span> <span class="mh">0xa</span> <span class="o">+</span> <span class="sc">&#39;a&#39;</span><span class="p">;</span>
		<span class="n">remove_leading_zeros</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">str_ptr</span><span class="o">++</span><span class="p">;</span>
		<span class="p">(</span><span class="o">*</span><span class="n">len</span><span class="p">)</span><span class="o">--</span><span class="p">;</span>
		<span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">shift</span> <span class="o">==</span> <span class="mi">4</span><span class="o">*</span><span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">str_ptr</span> <span class="o">=</span> <span class="sc">&#39;.&#39;</span><span class="p">;</span>
			<span class="n">str_ptr</span><span class="o">++</span><span class="p">;</span>
			<span class="p">(</span><span class="o">*</span><span class="n">len</span><span class="p">)</span><span class="o">--</span><span class="p">;</span>
			<span class="n">remove_leading_zeros</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">bnx2x_null_format_ver</span><span class="p">(</span><span class="n">u32</span> <span class="n">spirom_ver</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">str</span><span class="p">,</span> <span class="n">u16</span> <span class="o">*</span><span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">str</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
	<span class="p">(</span><span class="o">*</span><span class="n">len</span><span class="p">)</span><span class="o">--</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">bnx2x_get_ext_phy_fw_version</span><span class="p">(</span><span class="k">struct</span> <span class="n">link_params</span> <span class="o">*</span><span class="n">params</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">version</span><span class="p">,</span>
				 <span class="n">u16</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">spirom_ver</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">ver_p</span> <span class="o">=</span> <span class="n">version</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">remain_len</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">version</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">params</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">bp</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">bp</span><span class="p">;</span>

	<span class="cm">/* Extract first external phy*/</span>
	<span class="n">version</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
	<span class="n">spirom_ver</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">[</span><span class="n">EXT_PHY1</span><span class="p">].</span><span class="n">ver_addr</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">[</span><span class="n">EXT_PHY1</span><span class="p">].</span><span class="n">format_fw_ver</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">|=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">[</span><span class="n">EXT_PHY1</span><span class="p">].</span><span class="n">format_fw_ver</span><span class="p">(</span><span class="n">spirom_ver</span><span class="p">,</span>
							      <span class="n">ver_p</span><span class="p">,</span>
							      <span class="o">&amp;</span><span class="n">remain_len</span><span class="p">);</span>
		<span class="n">ver_p</span> <span class="o">+=</span> <span class="p">(</span><span class="n">len</span> <span class="o">-</span> <span class="n">remain_len</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">num_phys</span> <span class="o">==</span> <span class="n">MAX_PHYS</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">[</span><span class="n">EXT_PHY2</span><span class="p">].</span><span class="n">ver_addr</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">spirom_ver</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">[</span><span class="n">EXT_PHY2</span><span class="p">].</span><span class="n">ver_addr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">[</span><span class="n">EXT_PHY2</span><span class="p">].</span><span class="n">format_fw_ver</span><span class="p">)</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">ver_p</span> <span class="o">=</span> <span class="sc">&#39;/&#39;</span><span class="p">;</span>
			<span class="n">ver_p</span><span class="o">++</span><span class="p">;</span>
			<span class="n">remain_len</span><span class="o">--</span><span class="p">;</span>
			<span class="n">status</span> <span class="o">|=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">[</span><span class="n">EXT_PHY2</span><span class="p">].</span><span class="n">format_fw_ver</span><span class="p">(</span>
				<span class="n">spirom_ver</span><span class="p">,</span>
				<span class="n">ver_p</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">remain_len</span><span class="p">);</span>
			<span class="n">ver_p</span> <span class="o">=</span> <span class="n">version</span> <span class="o">+</span> <span class="p">(</span><span class="n">len</span> <span class="o">-</span> <span class="n">remain_len</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="o">*</span><span class="n">ver_p</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_set_xgxs_loopback</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x_phy</span> <span class="o">*</span><span class="n">phy</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">link_params</span> <span class="o">*</span><span class="n">params</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">port</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">bp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">req_line_speed</span> <span class="o">!=</span> <span class="n">SPEED_1000</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">md_devad</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;XGXS 10G loopback enable</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CHIP_IS_E3</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* change the uni_phy_addr in the nig */</span>
			<span class="n">md_devad</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="p">(</span><span class="n">NIG_REG_XGXS0_CTRL_MD_DEVAD</span> <span class="o">+</span>
					       <span class="n">port</span><span class="o">*</span><span class="mh">0x18</span><span class="p">));</span>

			<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">NIG_REG_XGXS0_CTRL_MD_DEVAD</span> <span class="o">+</span> <span class="n">port</span><span class="o">*</span><span class="mh">0x18</span><span class="p">,</span>
			       <span class="mh">0x5</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
				 <span class="mi">5</span><span class="p">,</span>
				 <span class="p">(</span><span class="n">MDIO_REG_BANK_AER_BLOCK</span> <span class="o">+</span>
				  <span class="p">(</span><span class="n">MDIO_AER_BLOCK_AER_REG</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">)),</span>
				 <span class="mh">0x2800</span><span class="p">);</span>

		<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
				 <span class="mi">5</span><span class="p">,</span>
				 <span class="p">(</span><span class="n">MDIO_REG_BANK_CL73_IEEEB0</span> <span class="o">+</span>
				  <span class="p">(</span><span class="n">MDIO_CL73_IEEEB0_CL73_AN_CONTROL</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">)),</span>
				 <span class="mh">0x6041</span><span class="p">);</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">200</span><span class="p">);</span>
		<span class="cm">/* set aer mmd back */</span>
		<span class="n">bnx2x_set_aer_mmd</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">phy</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CHIP_IS_E3</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* and md_devad */</span>
			<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">NIG_REG_XGXS0_CTRL_MD_DEVAD</span> <span class="o">+</span> <span class="n">port</span><span class="o">*</span><span class="mh">0x18</span><span class="p">,</span>
			       <span class="n">md_devad</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">u16</span> <span class="n">mii_ctrl</span><span class="p">;</span>
		<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;XGXS 1G loopback enable</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">bnx2x_cl45_read</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span>
				<span class="p">(</span><span class="n">MDIO_REG_BANK_COMBO_IEEE0</span> <span class="o">+</span>
				<span class="p">(</span><span class="n">MDIO_COMBO_IEEE0_MII_CONTROL</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">)),</span>
				<span class="o">&amp;</span><span class="n">mii_ctrl</span><span class="p">);</span>
		<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span>
				 <span class="p">(</span><span class="n">MDIO_REG_BANK_COMBO_IEEE0</span> <span class="o">+</span>
				 <span class="p">(</span><span class="n">MDIO_COMBO_IEEE0_MII_CONTROL</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">)),</span>
				 <span class="n">mii_ctrl</span> <span class="o">|</span>
				 <span class="n">MDIO_COMBO_IEEO_MII_CONTROL_LOOPBACK</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">bnx2x_set_led</span><span class="p">(</span><span class="k">struct</span> <span class="n">link_params</span> <span class="o">*</span><span class="n">params</span><span class="p">,</span>
		  <span class="k">struct</span> <span class="n">link_vars</span> <span class="o">*</span><span class="n">vars</span><span class="p">,</span> <span class="n">u8</span> <span class="n">mode</span><span class="p">,</span> <span class="n">u32</span> <span class="n">speed</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">port</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">hw_led_mode</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">hw_led_mode</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">phy_idx</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">emac_base</span> <span class="o">=</span> <span class="n">port</span> <span class="o">?</span> <span class="n">GRCBASE_EMAC1</span> <span class="o">:</span> <span class="n">GRCBASE_EMAC0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">bp</span><span class="p">;</span>
	<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;bnx2x_set_led: port %x, mode %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>
	<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;speed 0x%x, hw_led_mode 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">speed</span><span class="p">,</span> <span class="n">hw_led_mode</span><span class="p">);</span>
	<span class="cm">/* In case */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">phy_idx</span> <span class="o">=</span> <span class="n">EXT_PHY1</span><span class="p">;</span> <span class="n">phy_idx</span> <span class="o">&lt;</span> <span class="n">MAX_PHYS</span><span class="p">;</span> <span class="n">phy_idx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">[</span><span class="n">phy_idx</span><span class="p">].</span><span class="n">set_link_led</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">params</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">[</span><span class="n">phy_idx</span><span class="p">].</span><span class="n">set_link_led</span><span class="p">(</span>
				<span class="o">&amp;</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">[</span><span class="n">phy_idx</span><span class="p">],</span> <span class="n">params</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">LED_MODE_FRONT_PANEL_OFF</span>:
	<span class="k">case</span> <span class="n">LED_MODE_OFF</span>:
		<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">NIG_REG_LED_10G_P0</span> <span class="o">+</span> <span class="n">port</span><span class="o">*</span><span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">NIG_REG_LED_MODE_P0</span> <span class="o">+</span> <span class="n">port</span><span class="o">*</span><span class="mi">4</span><span class="p">,</span>
		       <span class="n">SHARED_HW_CFG_LED_MAC1</span><span class="p">);</span>

		<span class="n">tmp</span> <span class="o">=</span> <span class="n">EMAC_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">EMAC_REG_EMAC_LED</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">[</span><span class="n">EXT_PHY1</span><span class="p">].</span><span class="n">type</span> <span class="o">==</span>
			<span class="n">PORT_HW_CFG_XGXS_EXT_PHY_TYPE_BCM54618SE</span><span class="p">)</span>
			<span class="n">tmp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">EMAC_LED_1000MB_OVERRIDE</span> <span class="o">|</span>
				<span class="n">EMAC_LED_100MB_OVERRIDE</span> <span class="o">|</span>
				<span class="n">EMAC_LED_10MB_OVERRIDE</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">tmp</span> <span class="o">|=</span> <span class="n">EMAC_LED_OVERRIDE</span><span class="p">;</span>

		<span class="n">EMAC_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">EMAC_REG_EMAC_LED</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">LED_MODE_OPER</span>:
		<span class="cm">/* For all other phys, OPER mode is same as ON, so in case</span>
<span class="cm">		 * link is down, do nothing</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vars</span><span class="o">-&gt;</span><span class="n">link_up</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">LED_MODE_ON</span>:
		<span class="k">if</span> <span class="p">(((</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">[</span><span class="n">EXT_PHY1</span><span class="p">].</span><span class="n">type</span> <span class="o">==</span>
			  <span class="n">PORT_HW_CFG_XGXS_EXT_PHY_TYPE_BCM8727</span><span class="p">)</span> <span class="o">||</span>
			 <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">[</span><span class="n">EXT_PHY1</span><span class="p">].</span><span class="n">type</span> <span class="o">==</span>
			  <span class="n">PORT_HW_CFG_XGXS_EXT_PHY_TYPE_BCM8722</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
		    <span class="n">CHIP_IS_E2</span><span class="p">(</span><span class="n">bp</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">num_phys</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* This is a work-around for E2+8727 Configurations */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="n">LED_MODE_ON</span> <span class="o">||</span>
				<span class="n">speed</span> <span class="o">==</span> <span class="n">SPEED_10000</span><span class="p">){</span>
				<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">NIG_REG_LED_MODE_P0</span> <span class="o">+</span> <span class="n">port</span><span class="o">*</span><span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
				<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">NIG_REG_LED_10G_P0</span> <span class="o">+</span> <span class="n">port</span><span class="o">*</span><span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

				<span class="n">tmp</span> <span class="o">=</span> <span class="n">EMAC_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">EMAC_REG_EMAC_LED</span><span class="p">);</span>
				<span class="n">EMAC_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">EMAC_REG_EMAC_LED</span><span class="p">,</span>
					<span class="p">(</span><span class="n">tmp</span> <span class="o">|</span> <span class="n">EMAC_LED_OVERRIDE</span><span class="p">));</span>
				<span class="cm">/* Return here without enabling traffic</span>
<span class="cm">				 * LED blink and setting rate in ON mode.</span>
<span class="cm">				 * In oper mode, enabling LED blink</span>
<span class="cm">				 * and setting rate is needed.</span>
<span class="cm">				 */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="n">LED_MODE_ON</span><span class="p">)</span>
					<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">SINGLE_MEDIA_DIRECT</span><span class="p">(</span><span class="n">params</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* This is a work-around for HW issue found when link</span>
<span class="cm">			 * is up in CL73</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="n">CHIP_IS_E3</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span> <span class="o">||</span>
			    <span class="p">(</span><span class="n">CHIP_IS_E3</span><span class="p">(</span><span class="n">bp</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			     <span class="n">mode</span> <span class="o">==</span> <span class="n">LED_MODE_ON</span><span class="p">))</span>
				<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">NIG_REG_LED_10G_P0</span> <span class="o">+</span> <span class="n">port</span><span class="o">*</span><span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">CHIP_IS_E1x</span><span class="p">(</span><span class="n">bp</span><span class="p">)</span> <span class="o">||</span>
			    <span class="n">CHIP_IS_E2</span><span class="p">(</span><span class="n">bp</span><span class="p">)</span> <span class="o">||</span>
			    <span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="n">LED_MODE_ON</span><span class="p">))</span>
				<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">NIG_REG_LED_MODE_P0</span> <span class="o">+</span> <span class="n">port</span><span class="o">*</span><span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">NIG_REG_LED_MODE_P0</span> <span class="o">+</span> <span class="n">port</span><span class="o">*</span><span class="mi">4</span><span class="p">,</span>
				       <span class="n">hw_led_mode</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">[</span><span class="n">EXT_PHY1</span><span class="p">].</span><span class="n">type</span> <span class="o">==</span>
			    <span class="n">PORT_HW_CFG_XGXS_EXT_PHY_TYPE_BCM54618SE</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			   <span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="n">LED_MODE_ON</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">NIG_REG_LED_MODE_P0</span> <span class="o">+</span> <span class="n">port</span><span class="o">*</span><span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">tmp</span> <span class="o">=</span> <span class="n">EMAC_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">EMAC_REG_EMAC_LED</span><span class="p">);</span>
			<span class="n">EMAC_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">EMAC_REG_EMAC_LED</span><span class="p">,</span> <span class="n">tmp</span> <span class="o">|</span>
				<span class="n">EMAC_LED_OVERRIDE</span> <span class="o">|</span> <span class="n">EMAC_LED_1000MB_OVERRIDE</span><span class="p">);</span>
			<span class="cm">/* Break here; otherwise, it&#39;ll disable the</span>
<span class="cm">			 * intended override.</span>
<span class="cm">			 */</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">NIG_REG_LED_MODE_P0</span> <span class="o">+</span> <span class="n">port</span><span class="o">*</span><span class="mi">4</span><span class="p">,</span>
			       <span class="n">hw_led_mode</span><span class="p">);</span>

		<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">NIG_REG_LED_CONTROL_OVERRIDE_TRAFFIC_P0</span> <span class="o">+</span> <span class="n">port</span><span class="o">*</span><span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="cm">/* Set blinking rate to ~15.9Hz */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">CHIP_IS_E3</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span>
			<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">NIG_REG_LED_CONTROL_BLINK_RATE_P0</span> <span class="o">+</span> <span class="n">port</span><span class="o">*</span><span class="mi">4</span><span class="p">,</span>
			       <span class="n">LED_BLINK_RATE_VAL_E3</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">NIG_REG_LED_CONTROL_BLINK_RATE_P0</span> <span class="o">+</span> <span class="n">port</span><span class="o">*</span><span class="mi">4</span><span class="p">,</span>
			       <span class="n">LED_BLINK_RATE_VAL_E1X_E2</span><span class="p">);</span>
		<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">NIG_REG_LED_CONTROL_BLINK_RATE_ENA_P0</span> <span class="o">+</span>
		       <span class="n">port</span><span class="o">*</span><span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">EMAC_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">EMAC_REG_EMAC_LED</span><span class="p">);</span>
		<span class="n">EMAC_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">EMAC_REG_EMAC_LED</span><span class="p">,</span>
			<span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="n">EMAC_LED_OVERRIDE</span><span class="p">)));</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">CHIP_IS_E1</span><span class="p">(</span><span class="n">bp</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">((</span><span class="n">speed</span> <span class="o">==</span> <span class="n">SPEED_2500</span><span class="p">)</span> <span class="o">||</span>
		     <span class="p">(</span><span class="n">speed</span> <span class="o">==</span> <span class="n">SPEED_1000</span><span class="p">)</span> <span class="o">||</span>
		     <span class="p">(</span><span class="n">speed</span> <span class="o">==</span> <span class="n">SPEED_100</span><span class="p">)</span> <span class="o">||</span>
		     <span class="p">(</span><span class="n">speed</span> <span class="o">==</span> <span class="n">SPEED_10</span><span class="p">)))</span> <span class="p">{</span>
			<span class="cm">/* For speeds less than 10G LED scheme is different */</span>
			<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">NIG_REG_LED_CONTROL_OVERRIDE_TRAFFIC_P0</span>
			       <span class="o">+</span> <span class="n">port</span><span class="o">*</span><span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">NIG_REG_LED_CONTROL_TRAFFIC_P0</span> <span class="o">+</span>
			       <span class="n">port</span><span class="o">*</span><span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">NIG_REG_LED_CONTROL_BLINK_TRAFFIC_P0</span> <span class="o">+</span>
			       <span class="n">port</span><span class="o">*</span><span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;bnx2x_set_led: Invalid led mode %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">mode</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

<span class="p">}</span>

<span class="cm">/* This function comes to reflect the actual link state read DIRECTLY from the</span>
<span class="cm"> * HW</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">bnx2x_test_link</span><span class="p">(</span><span class="k">struct</span> <span class="n">link_params</span> <span class="o">*</span><span class="n">params</span><span class="p">,</span> <span class="k">struct</span> <span class="n">link_vars</span> <span class="o">*</span><span class="n">vars</span><span class="p">,</span>
		    <span class="n">u8</span> <span class="n">is_serdes</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">bp</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">gp_status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">phy_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">ext_phy_link_up</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">serdes_phy_type</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">link_vars</span> <span class="n">temp_vars</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bnx2x_phy</span> <span class="o">*</span><span class="n">int_phy</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">[</span><span class="n">INT_PHY</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">CHIP_IS_E3</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">u16</span> <span class="n">link_up</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">req_line_speed</span><span class="p">[</span><span class="n">LINK_CONFIG_IDX</span><span class="p">(</span><span class="n">INT_PHY</span><span class="p">)]</span>
		    <span class="o">&gt;</span> <span class="n">SPEED_10000</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Check 20G link */</span>
			<span class="n">bnx2x_cl45_read</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">int_phy</span><span class="p">,</span> <span class="n">MDIO_WC_DEVAD</span><span class="p">,</span>
					<span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">link_up</span><span class="p">);</span>
			<span class="n">bnx2x_cl45_read</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">int_phy</span><span class="p">,</span> <span class="n">MDIO_WC_DEVAD</span><span class="p">,</span>
					<span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">link_up</span><span class="p">);</span>
			<span class="n">link_up</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">2</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* Check 10G link and below*/</span>
			<span class="n">u8</span> <span class="n">lane</span> <span class="o">=</span> <span class="n">bnx2x_get_warpcore_lane</span><span class="p">(</span><span class="n">int_phy</span><span class="p">,</span> <span class="n">params</span><span class="p">);</span>
			<span class="n">bnx2x_cl45_read</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">int_phy</span><span class="p">,</span> <span class="n">MDIO_WC_DEVAD</span><span class="p">,</span>
					<span class="n">MDIO_WC_REG_GP2_STATUS_GP_2_1</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">gp_status</span><span class="p">);</span>
			<span class="n">gp_status</span> <span class="o">=</span> <span class="p">((</span><span class="n">gp_status</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">)</span> <span class="o">|</span>
				<span class="p">((</span><span class="n">gp_status</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">);</span>
			<span class="n">link_up</span> <span class="o">=</span> <span class="n">gp_status</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">lane</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">link_up</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ESRCH</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">CL22_RD_OVER_CL45</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">int_phy</span><span class="p">,</span>
			  <span class="n">MDIO_REG_BANK_GP_STATUS</span><span class="p">,</span>
			  <span class="n">MDIO_GP_STATUS_TOP_AN_STATUS1</span><span class="p">,</span>
			  <span class="o">&amp;</span><span class="n">gp_status</span><span class="p">);</span>
	<span class="cm">/* link is up only if both local phy and external phy are up */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">gp_status</span> <span class="o">&amp;</span> <span class="n">MDIO_GP_STATUS_TOP_AN_STATUS1_LINK_STATUS</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ESRCH</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* In XGXS loopback mode, do not check external PHY */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">loopback_mode</span> <span class="o">==</span> <span class="n">LOOPBACK_XGXS</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">num_phys</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="cm">/* No external PHY */</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="n">ext_phy_link_up</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">[</span><span class="n">EXT_PHY1</span><span class="p">].</span><span class="n">read_status</span><span class="p">(</span>
			<span class="o">&amp;</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">[</span><span class="n">EXT_PHY1</span><span class="p">],</span>
			<span class="n">params</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">temp_vars</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">3</span>: <span class="cm">/* Dual Media */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">phy_index</span> <span class="o">=</span> <span class="n">EXT_PHY1</span><span class="p">;</span> <span class="n">phy_index</span> <span class="o">&lt;</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">num_phys</span><span class="p">;</span>
		      <span class="n">phy_index</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">serdes_phy_type</span> <span class="o">=</span> <span class="p">((</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">[</span><span class="n">phy_index</span><span class="p">].</span><span class="n">media_type</span> <span class="o">==</span>
					    <span class="n">ETH_PHY_SFP_FIBER</span><span class="p">)</span> <span class="o">||</span>
					   <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">[</span><span class="n">phy_index</span><span class="p">].</span><span class="n">media_type</span> <span class="o">==</span>
					    <span class="n">ETH_PHY_XFP_FIBER</span><span class="p">)</span> <span class="o">||</span>
					   <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">[</span><span class="n">phy_index</span><span class="p">].</span><span class="n">media_type</span> <span class="o">==</span>
					    <span class="n">ETH_PHY_DA_TWINAX</span><span class="p">));</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">is_serdes</span> <span class="o">!=</span> <span class="n">serdes_phy_type</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">[</span><span class="n">phy_index</span><span class="p">].</span><span class="n">read_status</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ext_phy_link_up</span> <span class="o">|=</span>
					<span class="n">params</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">[</span><span class="n">phy_index</span><span class="p">].</span><span class="n">read_status</span><span class="p">(</span>
						<span class="o">&amp;</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">[</span><span class="n">phy_index</span><span class="p">],</span>
						<span class="n">params</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">temp_vars</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ext_phy_link_up</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ESRCH</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bnx2x_link_initialize</span><span class="p">(</span><span class="k">struct</span> <span class="n">link_params</span> <span class="o">*</span><span class="n">params</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">link_vars</span> <span class="o">*</span><span class="n">vars</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">phy_index</span><span class="p">,</span> <span class="n">non_ext_phy</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">bp</span><span class="p">;</span>
	<span class="cm">/* In case of external phy existence, the line speed would be the</span>
<span class="cm">	 * line speed linked up by the external phy. In case it is direct</span>
<span class="cm">	 * only, then the line_speed during initialization will be</span>
<span class="cm">	 * equal to the req_line_speed</span>
<span class="cm">	 */</span>
	<span class="n">vars</span><span class="o">-&gt;</span><span class="n">line_speed</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">[</span><span class="n">INT_PHY</span><span class="p">].</span><span class="n">req_line_speed</span><span class="p">;</span>

	<span class="cm">/* Initialize the internal phy in case this is a direct board</span>
<span class="cm">	 * (no external phys), or this board has external phy which requires</span>
<span class="cm">	 * to first.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">USES_WARPCORE</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span>
		<span class="n">bnx2x_prepare_xgxs</span><span class="p">(</span><span class="o">&amp;</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">[</span><span class="n">INT_PHY</span><span class="p">],</span> <span class="n">params</span><span class="p">,</span> <span class="n">vars</span><span class="p">);</span>
	<span class="cm">/* init ext phy and enable link state int */</span>
	<span class="n">non_ext_phy</span> <span class="o">=</span> <span class="p">(</span><span class="n">SINGLE_MEDIA_DIRECT</span><span class="p">(</span><span class="n">params</span><span class="p">)</span> <span class="o">||</span>
		       <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">loopback_mode</span> <span class="o">==</span> <span class="n">LOOPBACK_XGXS</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">non_ext_phy</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">[</span><span class="n">EXT_PHY1</span><span class="p">].</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">FLAGS_INIT_XGXS_FIRST</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">loopback_mode</span> <span class="o">==</span> <span class="n">LOOPBACK_EXT_PHY</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">bnx2x_phy</span> <span class="o">*</span><span class="n">phy</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">[</span><span class="n">INT_PHY</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vars</span><span class="o">-&gt;</span><span class="n">line_speed</span> <span class="o">==</span> <span class="n">SPEED_AUTO_NEG</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">CHIP_IS_E1x</span><span class="p">(</span><span class="n">bp</span><span class="p">)</span> <span class="o">||</span>
		     <span class="n">CHIP_IS_E2</span><span class="p">(</span><span class="n">bp</span><span class="p">)))</span>
			<span class="n">bnx2x_set_parallel_detection</span><span class="p">(</span><span class="n">phy</span><span class="p">,</span> <span class="n">params</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">[</span><span class="n">INT_PHY</span><span class="p">].</span><span class="n">config_init</span><span class="p">)</span>
				<span class="n">params</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">[</span><span class="n">INT_PHY</span><span class="p">].</span><span class="n">config_init</span><span class="p">(</span><span class="n">phy</span><span class="p">,</span>
								 <span class="n">params</span><span class="p">,</span>
								 <span class="n">vars</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Init external phy*/</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">non_ext_phy</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">[</span><span class="n">INT_PHY</span><span class="p">].</span><span class="n">supported</span> <span class="o">&amp;</span>
		    <span class="n">SUPPORTED_FIBRE</span><span class="p">)</span>
			<span class="n">vars</span><span class="o">-&gt;</span><span class="n">link_status</span> <span class="o">|=</span> <span class="n">LINK_STATUS_SERDES_LINK</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">phy_index</span> <span class="o">=</span> <span class="n">EXT_PHY1</span><span class="p">;</span> <span class="n">phy_index</span> <span class="o">&lt;</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">num_phys</span><span class="p">;</span>
		      <span class="n">phy_index</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* No need to initialize second phy in case of first</span>
<span class="cm">			 * phy only selection. In case of second phy, we do</span>
<span class="cm">			 * need to initialize the first phy, since they are</span>
<span class="cm">			 * connected.</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">[</span><span class="n">phy_index</span><span class="p">].</span><span class="n">supported</span> <span class="o">&amp;</span>
			    <span class="n">SUPPORTED_FIBRE</span><span class="p">)</span>
				<span class="n">vars</span><span class="o">-&gt;</span><span class="n">link_status</span> <span class="o">|=</span> <span class="n">LINK_STATUS_SERDES_LINK</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">phy_index</span> <span class="o">==</span> <span class="n">EXT_PHY2</span> <span class="o">&amp;&amp;</span>
			    <span class="p">(</span><span class="n">bnx2x_phy_selection</span><span class="p">(</span><span class="n">params</span><span class="p">)</span> <span class="o">==</span>
			     <span class="n">PORT_HW_CFG_PHY_SELECTION_FIRST_PHY</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span>
				   <span class="s">&quot;Not initializing second phy</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">params</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">[</span><span class="n">phy_index</span><span class="p">].</span><span class="n">config_init</span><span class="p">(</span>
				<span class="o">&amp;</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">[</span><span class="n">phy_index</span><span class="p">],</span>
				<span class="n">params</span><span class="p">,</span> <span class="n">vars</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="cm">/* Reset the interrupt indication after phy was initialized */</span>
	<span class="n">bnx2x_bits_dis</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">NIG_REG_STATUS_INTERRUPT_PORT0</span> <span class="o">+</span>
		       <span class="n">params</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">*</span><span class="mi">4</span><span class="p">,</span>
		       <span class="p">(</span><span class="n">NIG_STATUS_XGXS0_LINK10G</span> <span class="o">|</span>
			<span class="n">NIG_STATUS_XGXS0_LINK_STATUS</span> <span class="o">|</span>
			<span class="n">NIG_STATUS_SERDES0_LINK_STATUS</span> <span class="o">|</span>
			<span class="n">NIG_MASK_MI_INT</span><span class="p">));</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_int_link_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x_phy</span> <span class="o">*</span><span class="n">phy</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">link_params</span> <span class="o">*</span><span class="n">params</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* reset the SerDes/XGXS */</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">bp</span><span class="p">,</span> <span class="n">GRCBASE_MISC</span> <span class="o">+</span> <span class="n">MISC_REGISTERS_RESET_REG_3_CLEAR</span><span class="p">,</span>
	       <span class="p">(</span><span class="mh">0x1ff</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">*</span><span class="mi">16</span><span class="p">)));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_common_ext_link_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x_phy</span> <span class="o">*</span><span class="n">phy</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">link_params</span> <span class="o">*</span><span class="n">params</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">bp</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">gpio_port</span><span class="p">;</span>
	<span class="cm">/* HW reset */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">CHIP_IS_E2</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span>
		<span class="n">gpio_port</span> <span class="o">=</span> <span class="n">BP_PATH</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">gpio_port</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>
	<span class="n">bnx2x_set_gpio</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">MISC_REGISTERS_GPIO_1</span><span class="p">,</span>
		       <span class="n">MISC_REGISTERS_GPIO_OUTPUT_LOW</span><span class="p">,</span>
		       <span class="n">gpio_port</span><span class="p">);</span>
	<span class="n">bnx2x_set_gpio</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">MISC_REGISTERS_GPIO_2</span><span class="p">,</span>
		       <span class="n">MISC_REGISTERS_GPIO_OUTPUT_LOW</span><span class="p">,</span>
		       <span class="n">gpio_port</span><span class="p">);</span>
	<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;reset external PHY</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bnx2x_update_link_down</span><span class="p">(</span><span class="k">struct</span> <span class="n">link_params</span> <span class="o">*</span><span class="n">params</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">link_vars</span> <span class="o">*</span><span class="n">vars</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">bp</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">port</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>

	<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;Port %x: Link is down</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>
	<span class="n">bnx2x_set_led</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">vars</span><span class="p">,</span> <span class="n">LED_MODE_OFF</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">vars</span><span class="o">-&gt;</span><span class="n">phy_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PHY_PHYSICAL_LINK_FLAG</span><span class="p">;</span>
	<span class="cm">/* indicate no mac active */</span>
	<span class="n">vars</span><span class="o">-&gt;</span><span class="n">mac_type</span> <span class="o">=</span> <span class="n">MAC_TYPE_NONE</span><span class="p">;</span>

	<span class="cm">/* update shared memory */</span>
	<span class="n">vars</span><span class="o">-&gt;</span><span class="n">link_status</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">LINK_STATUS_SPEED_AND_DUPLEX_MASK</span> <span class="o">|</span>
			       <span class="n">LINK_STATUS_LINK_UP</span> <span class="o">|</span>
			       <span class="n">LINK_STATUS_PHYSICAL_LINK_FLAG</span> <span class="o">|</span>
			       <span class="n">LINK_STATUS_AUTO_NEGOTIATE_COMPLETE</span> <span class="o">|</span>
			       <span class="n">LINK_STATUS_RX_FLOW_CONTROL_FLAG_MASK</span> <span class="o">|</span>
			       <span class="n">LINK_STATUS_TX_FLOW_CONTROL_FLAG_MASK</span> <span class="o">|</span>
			       <span class="n">LINK_STATUS_PARALLEL_DETECTION_FLAG_MASK</span> <span class="o">|</span>
			       <span class="n">LINK_STATUS_LINK_PARTNER_SYMMETRIC_PAUSE</span> <span class="o">|</span>
			       <span class="n">LINK_STATUS_LINK_PARTNER_ASYMMETRIC_PAUSE</span><span class="p">);</span>
	<span class="n">vars</span><span class="o">-&gt;</span><span class="n">line_speed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">bnx2x_update_mng</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">vars</span><span class="o">-&gt;</span><span class="n">link_status</span><span class="p">);</span>

	<span class="cm">/* activate nig drain */</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">NIG_REG_EGRESS_DRAIN0_MODE</span> <span class="o">+</span> <span class="n">port</span><span class="o">*</span><span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* disable emac */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CHIP_IS_E3</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span>
		<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">NIG_REG_NIG_EMAC0_EN</span> <span class="o">+</span> <span class="n">port</span><span class="o">*</span><span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">msleep</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="cm">/* reset BigMac/Xmac */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">CHIP_IS_E1x</span><span class="p">(</span><span class="n">bp</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">CHIP_IS_E2</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">bnx2x_bmac_rx_disable</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">);</span>
		<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">GRCBASE_MISC</span> <span class="o">+</span>
		       <span class="n">MISC_REGISTERS_RESET_REG_2_CLEAR</span><span class="p">,</span>
	       <span class="p">(</span><span class="n">MISC_REGISTERS_RESET_REG_2_RST_BMAC0</span> <span class="o">&lt;&lt;</span> <span class="n">port</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">CHIP_IS_E3</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">bnx2x_xmac_disable</span><span class="p">(</span><span class="n">params</span><span class="p">);</span>
		<span class="n">bnx2x_umac_disable</span><span class="p">(</span><span class="n">params</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bnx2x_update_link_up</span><span class="p">(</span><span class="k">struct</span> <span class="n">link_params</span> <span class="o">*</span><span class="n">params</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">link_vars</span> <span class="o">*</span><span class="n">vars</span><span class="p">,</span>
				<span class="n">u8</span> <span class="n">link_10g</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">bp</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">phy_idx</span><span class="p">,</span> <span class="n">port</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">vars</span><span class="o">-&gt;</span><span class="n">link_status</span> <span class="o">|=</span> <span class="p">(</span><span class="n">LINK_STATUS_LINK_UP</span> <span class="o">|</span>
			      <span class="n">LINK_STATUS_PHYSICAL_LINK_FLAG</span><span class="p">);</span>
	<span class="n">vars</span><span class="o">-&gt;</span><span class="n">phy_flags</span> <span class="o">|=</span> <span class="n">PHY_PHYSICAL_LINK_FLAG</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vars</span><span class="o">-&gt;</span><span class="n">flow_ctrl</span> <span class="o">&amp;</span> <span class="n">BNX2X_FLOW_CTRL_TX</span><span class="p">)</span>
		<span class="n">vars</span><span class="o">-&gt;</span><span class="n">link_status</span> <span class="o">|=</span>
			<span class="n">LINK_STATUS_TX_FLOW_CONTROL_ENABLED</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vars</span><span class="o">-&gt;</span><span class="n">flow_ctrl</span> <span class="o">&amp;</span> <span class="n">BNX2X_FLOW_CTRL_RX</span><span class="p">)</span>
		<span class="n">vars</span><span class="o">-&gt;</span><span class="n">link_status</span> <span class="o">|=</span>
			<span class="n">LINK_STATUS_RX_FLOW_CONTROL_ENABLED</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">USES_WARPCORE</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">link_10g</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">bnx2x_xmac_enable</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">vars</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">==</span>
			    <span class="o">-</span><span class="n">ESRCH</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;Found errors on XMAC</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">vars</span><span class="o">-&gt;</span><span class="n">link_up</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">vars</span><span class="o">-&gt;</span><span class="n">phy_flags</span> <span class="o">|=</span> <span class="n">PHY_HALF_OPEN_CONN_FLAG</span><span class="p">;</span>
				<span class="n">vars</span><span class="o">-&gt;</span><span class="n">link_status</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">LINK_STATUS_LINK_UP</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">bnx2x_umac_enable</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">vars</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">bnx2x_set_led</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">vars</span><span class="p">,</span>
			      <span class="n">LED_MODE_OPER</span><span class="p">,</span> <span class="n">vars</span><span class="o">-&gt;</span><span class="n">line_speed</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">CHIP_IS_E1x</span><span class="p">(</span><span class="n">bp</span><span class="p">)</span> <span class="o">||</span>
	     <span class="n">CHIP_IS_E2</span><span class="p">(</span><span class="n">bp</span><span class="p">)))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">link_10g</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">bnx2x_bmac_enable</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">vars</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">==</span>
			    <span class="o">-</span><span class="n">ESRCH</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;Found errors on BMAC</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">vars</span><span class="o">-&gt;</span><span class="n">link_up</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">vars</span><span class="o">-&gt;</span><span class="n">phy_flags</span> <span class="o">|=</span> <span class="n">PHY_HALF_OPEN_CONN_FLAG</span><span class="p">;</span>
				<span class="n">vars</span><span class="o">-&gt;</span><span class="n">link_status</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">LINK_STATUS_LINK_UP</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">bnx2x_set_led</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">vars</span><span class="p">,</span>
				      <span class="n">LED_MODE_OPER</span><span class="p">,</span> <span class="n">SPEED_10000</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">bnx2x_emac_program</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">vars</span><span class="p">);</span>
			<span class="n">bnx2x_emac_enable</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">vars</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

			<span class="cm">/* AN complete? */</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">vars</span><span class="o">-&gt;</span><span class="n">link_status</span> <span class="o">&amp;</span>
			     <span class="n">LINK_STATUS_AUTO_NEGOTIATE_COMPLETE</span><span class="p">)</span>
			    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">vars</span><span class="o">-&gt;</span><span class="n">phy_flags</span> <span class="o">&amp;</span> <span class="n">PHY_SGMII_FLAG</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
			    <span class="n">SINGLE_MEDIA_DIRECT</span><span class="p">(</span><span class="n">params</span><span class="p">))</span>
				<span class="n">bnx2x_set_gmii_tx_driver</span><span class="p">(</span><span class="n">params</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* PBF - link up */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">CHIP_IS_E1x</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span>
		<span class="n">rc</span> <span class="o">|=</span> <span class="n">bnx2x_pbf_update</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">vars</span><span class="o">-&gt;</span><span class="n">flow_ctrl</span><span class="p">,</span>
				       <span class="n">vars</span><span class="o">-&gt;</span><span class="n">line_speed</span><span class="p">);</span>

	<span class="cm">/* disable drain */</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">NIG_REG_EGRESS_DRAIN0_MODE</span> <span class="o">+</span> <span class="n">port</span><span class="o">*</span><span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* update shared memory */</span>
	<span class="n">bnx2x_update_mng</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">vars</span><span class="o">-&gt;</span><span class="n">link_status</span><span class="p">);</span>

	<span class="cm">/* Check remote fault */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">phy_idx</span> <span class="o">=</span> <span class="n">INT_PHY</span><span class="p">;</span> <span class="n">phy_idx</span> <span class="o">&lt;</span> <span class="n">MAX_PHYS</span><span class="p">;</span> <span class="n">phy_idx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">[</span><span class="n">phy_idx</span><span class="p">].</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">FLAGS_TX_ERROR_CHECK</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">bnx2x_check_half_open_conn</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">vars</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>
<span class="cm">/* The bnx2x_link_update function should be called upon link</span>
<span class="cm"> * interrupt.</span>
<span class="cm"> * Link is considered up as follows:</span>
<span class="cm"> * - DIRECT_SINGLE_MEDIA - Only XGXS link (internal link) needs</span>
<span class="cm"> *   to be up</span>
<span class="cm"> * - SINGLE_MEDIA - The link between the 577xx and the external</span>
<span class="cm"> *   phy (XGXS) need to up as well as the external link of the</span>
<span class="cm"> *   phy (PHY_EXT1)</span>
<span class="cm"> * - DUAL_MEDIA - The link between the 577xx and the first</span>
<span class="cm"> *   external phy needs to be up, and at least one of the 2</span>
<span class="cm"> *   external phy link must be up.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">bnx2x_link_update</span><span class="p">(</span><span class="k">struct</span> <span class="n">link_params</span> <span class="o">*</span><span class="n">params</span><span class="p">,</span> <span class="k">struct</span> <span class="n">link_vars</span> <span class="o">*</span><span class="n">vars</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">bp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">link_vars</span> <span class="n">phy_vars</span><span class="p">[</span><span class="n">MAX_PHYS</span><span class="p">];</span>
	<span class="n">u8</span> <span class="n">port</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">link_10g_plus</span><span class="p">,</span> <span class="n">phy_index</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">ext_phy_link_up</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">cur_link_up</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">is_mi_int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">ext_phy_line_speed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">prev_line_speed</span> <span class="o">=</span> <span class="n">vars</span><span class="o">-&gt;</span><span class="n">line_speed</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">active_external_phy</span> <span class="o">=</span> <span class="n">INT_PHY</span><span class="p">;</span>
	<span class="n">vars</span><span class="o">-&gt;</span><span class="n">phy_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PHY_HALF_OPEN_CONN_FLAG</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">phy_index</span> <span class="o">=</span> <span class="n">INT_PHY</span><span class="p">;</span> <span class="n">phy_index</span> <span class="o">&lt;</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">num_phys</span><span class="p">;</span>
	      <span class="n">phy_index</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">phy_vars</span><span class="p">[</span><span class="n">phy_index</span><span class="p">].</span><span class="n">flow_ctrl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">phy_vars</span><span class="p">[</span><span class="n">phy_index</span><span class="p">].</span><span class="n">link_status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">phy_vars</span><span class="p">[</span><span class="n">phy_index</span><span class="p">].</span><span class="n">line_speed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">phy_vars</span><span class="p">[</span><span class="n">phy_index</span><span class="p">].</span><span class="n">duplex</span> <span class="o">=</span> <span class="n">DUPLEX_FULL</span><span class="p">;</span>
		<span class="n">phy_vars</span><span class="p">[</span><span class="n">phy_index</span><span class="p">].</span><span class="n">phy_link_up</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">phy_vars</span><span class="p">[</span><span class="n">phy_index</span><span class="p">].</span><span class="n">link_up</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">phy_vars</span><span class="p">[</span><span class="n">phy_index</span><span class="p">].</span><span class="n">fault_detected</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">USES_WARPCORE</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span>
		<span class="n">bnx2x_set_aer_mmd</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">[</span><span class="n">INT_PHY</span><span class="p">]);</span>

	<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;port %x, XGXS?%x, int_status 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">port</span><span class="p">,</span> <span class="p">(</span><span class="n">vars</span><span class="o">-&gt;</span><span class="n">phy_flags</span> <span class="o">&amp;</span> <span class="n">PHY_XGXS_FLAG</span><span class="p">),</span>
		 <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">NIG_REG_STATUS_INTERRUPT_PORT0</span> <span class="o">+</span> <span class="n">port</span><span class="o">*</span><span class="mi">4</span><span class="p">));</span>

	<span class="n">is_mi_int</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)(</span><span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">NIG_REG_EMAC0_STATUS_MISC_MI_INT</span> <span class="o">+</span>
				<span class="n">port</span><span class="o">*</span><span class="mh">0x18</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;int_mask 0x%x MI_INT %x, SERDES_LINK %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">NIG_REG_MASK_INTERRUPT_PORT0</span> <span class="o">+</span> <span class="n">port</span><span class="o">*</span><span class="mi">4</span><span class="p">),</span>
		 <span class="n">is_mi_int</span><span class="p">,</span>
		 <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">NIG_REG_SERDES0_STATUS_LINK_STATUS</span> <span class="o">+</span> <span class="n">port</span><span class="o">*</span><span class="mh">0x3c</span><span class="p">));</span>

	<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot; 10G %x, XGXS_LINK %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	  <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">NIG_REG_XGXS0_STATUS_LINK10G</span> <span class="o">+</span> <span class="n">port</span><span class="o">*</span><span class="mh">0x68</span><span class="p">),</span>
	  <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">NIG_REG_XGXS0_STATUS_LINK_STATUS</span> <span class="o">+</span> <span class="n">port</span><span class="o">*</span><span class="mh">0x68</span><span class="p">));</span>

	<span class="cm">/* disable emac */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CHIP_IS_E3</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span>
		<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">NIG_REG_NIG_EMAC0_EN</span> <span class="o">+</span> <span class="n">port</span><span class="o">*</span><span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* Step 1:</span>
<span class="cm">	 * Check external link change only for external phys, and apply</span>
<span class="cm">	 * priority selection between them in case the link on both phys</span>
<span class="cm">	 * is up. Note that instead of the common vars, a temporary</span>
<span class="cm">	 * vars argument is used since each phy may have different link/</span>
<span class="cm">	 * speed/duplex result</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">phy_index</span> <span class="o">=</span> <span class="n">EXT_PHY1</span><span class="p">;</span> <span class="n">phy_index</span> <span class="o">&lt;</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">num_phys</span><span class="p">;</span>
	      <span class="n">phy_index</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">bnx2x_phy</span> <span class="o">*</span><span class="n">phy</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">[</span><span class="n">phy_index</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">read_status</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="cm">/* Read link status and params of this ext phy */</span>
		<span class="n">cur_link_up</span> <span class="o">=</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">read_status</span><span class="p">(</span><span class="n">phy</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span>
					       <span class="o">&amp;</span><span class="n">phy_vars</span><span class="p">[</span><span class="n">phy_index</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cur_link_up</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;phy in index %d link is up</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				   <span class="n">phy_index</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;phy in index %d link is down</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				   <span class="n">phy_index</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ext_phy_link_up</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ext_phy_link_up</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">active_external_phy</span> <span class="o">=</span> <span class="n">phy_index</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">bnx2x_phy_selection</span><span class="p">(</span><span class="n">params</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">PORT_HW_CFG_PHY_SELECTION_HARDWARE_DEFAULT</span>:
			<span class="k">case</span> <span class="n">PORT_HW_CFG_PHY_SELECTION_FIRST_PHY_PRIORITY</span>:
			<span class="cm">/* In this option, the first PHY makes sure to pass the</span>
<span class="cm">			 * traffic through itself only.</span>
<span class="cm">			 * Its not clear how to reset the link on the second phy</span>
<span class="cm">			 */</span>
				<span class="n">active_external_phy</span> <span class="o">=</span> <span class="n">EXT_PHY1</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">PORT_HW_CFG_PHY_SELECTION_SECOND_PHY_PRIORITY</span>:
			<span class="cm">/* In this option, the first PHY makes sure to pass the</span>
<span class="cm">			 * traffic through the second PHY.</span>
<span class="cm">			 */</span>
				<span class="n">active_external_phy</span> <span class="o">=</span> <span class="n">EXT_PHY2</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span>
			<span class="cm">/* Link indication on both PHYs with the following cases</span>
<span class="cm">			 * is invalid:</span>
<span class="cm">			 * - FIRST_PHY means that second phy wasn&#39;t initialized,</span>
<span class="cm">			 * hence its link is expected to be down</span>
<span class="cm">			 * - SECOND_PHY means that first phy should not be able</span>
<span class="cm">			 * to link up by itself (using configuration)</span>
<span class="cm">			 * - DEFAULT should be overriden during initialiazation</span>
<span class="cm">			 */</span>
				<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;Invalid link indication&quot;</span>
					   <span class="s">&quot;mpc=0x%x. DISABLING LINK !!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					   <span class="n">params</span><span class="o">-&gt;</span><span class="n">multi_phy_config</span><span class="p">);</span>
				<span class="n">ext_phy_link_up</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">prev_line_speed</span> <span class="o">=</span> <span class="n">vars</span><span class="o">-&gt;</span><span class="n">line_speed</span><span class="p">;</span>
	<span class="cm">/* Step 2:</span>
<span class="cm">	 * Read the status of the internal phy. In case of</span>
<span class="cm">	 * DIRECT_SINGLE_MEDIA board, this link is the external link,</span>
<span class="cm">	 * otherwise this is the link between the 577xx and the first</span>
<span class="cm">	 * external phy</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">[</span><span class="n">INT_PHY</span><span class="p">].</span><span class="n">read_status</span><span class="p">)</span>
		<span class="n">params</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">[</span><span class="n">INT_PHY</span><span class="p">].</span><span class="n">read_status</span><span class="p">(</span>
			<span class="o">&amp;</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">[</span><span class="n">INT_PHY</span><span class="p">],</span>
			<span class="n">params</span><span class="p">,</span> <span class="n">vars</span><span class="p">);</span>
	<span class="cm">/* The INT_PHY flow control reside in the vars. This include the</span>
<span class="cm">	 * case where the speed or flow control are not set to AUTO.</span>
<span class="cm">	 * Otherwise, the active external phy flow control result is set</span>
<span class="cm">	 * to the vars. The ext_phy_line_speed is needed to check if the</span>
<span class="cm">	 * speed is different between the internal phy and external phy.</span>
<span class="cm">	 * This case may be result of intermediate link speed change.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">active_external_phy</span> <span class="o">&gt;</span> <span class="n">INT_PHY</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vars</span><span class="o">-&gt;</span><span class="n">flow_ctrl</span> <span class="o">=</span> <span class="n">phy_vars</span><span class="p">[</span><span class="n">active_external_phy</span><span class="p">].</span><span class="n">flow_ctrl</span><span class="p">;</span>
		<span class="cm">/* Link speed is taken from the XGXS. AN and FC result from</span>
<span class="cm">		 * the external phy.</span>
<span class="cm">		 */</span>
		<span class="n">vars</span><span class="o">-&gt;</span><span class="n">link_status</span> <span class="o">|=</span> <span class="n">phy_vars</span><span class="p">[</span><span class="n">active_external_phy</span><span class="p">].</span><span class="n">link_status</span><span class="p">;</span>

		<span class="cm">/* if active_external_phy is first PHY and link is up - disable</span>
<span class="cm">		 * disable TX on second external PHY</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">active_external_phy</span> <span class="o">==</span> <span class="n">EXT_PHY1</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">[</span><span class="n">EXT_PHY2</span><span class="p">].</span><span class="n">phy_specific_func</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span>
				   <span class="s">&quot;Disabling TX on EXT_PHY2</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">params</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">[</span><span class="n">EXT_PHY2</span><span class="p">].</span><span class="n">phy_specific_func</span><span class="p">(</span>
					<span class="o">&amp;</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">[</span><span class="n">EXT_PHY2</span><span class="p">],</span>
					<span class="n">params</span><span class="p">,</span> <span class="n">DISABLE_TX</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="n">ext_phy_line_speed</span> <span class="o">=</span> <span class="n">phy_vars</span><span class="p">[</span><span class="n">active_external_phy</span><span class="p">].</span><span class="n">line_speed</span><span class="p">;</span>
		<span class="n">vars</span><span class="o">-&gt;</span><span class="n">duplex</span> <span class="o">=</span> <span class="n">phy_vars</span><span class="p">[</span><span class="n">active_external_phy</span><span class="p">].</span><span class="n">duplex</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">[</span><span class="n">active_external_phy</span><span class="p">].</span><span class="n">supported</span> <span class="o">&amp;</span>
		    <span class="n">SUPPORTED_FIBRE</span><span class="p">)</span>
			<span class="n">vars</span><span class="o">-&gt;</span><span class="n">link_status</span> <span class="o">|=</span> <span class="n">LINK_STATUS_SERDES_LINK</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">vars</span><span class="o">-&gt;</span><span class="n">link_status</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">LINK_STATUS_SERDES_LINK</span><span class="p">;</span>
		<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;Active external phy selected: %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">active_external_phy</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">phy_index</span> <span class="o">=</span> <span class="n">EXT_PHY1</span><span class="p">;</span> <span class="n">phy_index</span> <span class="o">&lt;</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">num_phys</span><span class="p">;</span>
	      <span class="n">phy_index</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">[</span><span class="n">phy_index</span><span class="p">].</span><span class="n">flags</span> <span class="o">&amp;</span>
		    <span class="n">FLAGS_REARM_LATCH_SIGNAL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">bnx2x_rearm_latch_signal</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span>
						 <span class="n">phy_index</span> <span class="o">==</span>
						 <span class="n">active_external_phy</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;vars-&gt;flow_ctrl = 0x%x, vars-&gt;link_status = 0x%x,&quot;</span>
		   <span class="s">&quot; ext_phy_line_speed = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">vars</span><span class="o">-&gt;</span><span class="n">flow_ctrl</span><span class="p">,</span>
		   <span class="n">vars</span><span class="o">-&gt;</span><span class="n">link_status</span><span class="p">,</span> <span class="n">ext_phy_line_speed</span><span class="p">);</span>
	<span class="cm">/* Upon link speed change set the NIG into drain mode. Comes to</span>
<span class="cm">	 * deals with possible FIFO glitch due to clk change when speed</span>
<span class="cm">	 * is decreased without link down indicator</span>
<span class="cm">	 */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vars</span><span class="o">-&gt;</span><span class="n">phy_link_up</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">SINGLE_MEDIA_DIRECT</span><span class="p">(</span><span class="n">params</span><span class="p">))</span> <span class="o">&amp;&amp;</span> <span class="n">ext_phy_link_up</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">ext_phy_line_speed</span> <span class="o">!=</span> <span class="n">vars</span><span class="o">-&gt;</span><span class="n">line_speed</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;Internal link speed %d is&quot;</span>
				   <span class="s">&quot; different than the external&quot;</span>
				   <span class="s">&quot; link speed %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">vars</span><span class="o">-&gt;</span><span class="n">line_speed</span><span class="p">,</span>
				   <span class="n">ext_phy_line_speed</span><span class="p">);</span>
			<span class="n">vars</span><span class="o">-&gt;</span><span class="n">phy_link_up</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">prev_line_speed</span> <span class="o">!=</span> <span class="n">vars</span><span class="o">-&gt;</span><span class="n">line_speed</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">NIG_REG_EGRESS_DRAIN0_MODE</span> <span class="o">+</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">*</span><span class="mi">4</span><span class="p">,</span>
			       <span class="mi">0</span><span class="p">);</span>
			<span class="n">msleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* anything 10 and over uses the bmac */</span>
	<span class="n">link_10g_plus</span> <span class="o">=</span> <span class="p">(</span><span class="n">vars</span><span class="o">-&gt;</span><span class="n">line_speed</span> <span class="o">&gt;=</span> <span class="n">SPEED_10000</span><span class="p">);</span>

	<span class="n">bnx2x_link_int_ack</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">vars</span><span class="p">,</span> <span class="n">link_10g_plus</span><span class="p">);</span>

	<span class="cm">/* In case external phy link is up, and internal link is down</span>
<span class="cm">	 * (not initialized yet probably after link initialization, it</span>
<span class="cm">	 * needs to be initialized.</span>
<span class="cm">	 * Note that after link down-up as result of cable plug, the xgxs</span>
<span class="cm">	 * link would probably become up again without the need</span>
<span class="cm">	 * initialize it</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">SINGLE_MEDIA_DIRECT</span><span class="p">(</span><span class="n">params</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;ext_phy_link_up = %d, int_link_up = %d,&quot;</span>
			   <span class="s">&quot; init_preceding = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ext_phy_link_up</span><span class="p">,</span>
			   <span class="n">vars</span><span class="o">-&gt;</span><span class="n">phy_link_up</span><span class="p">,</span>
			   <span class="n">params</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">[</span><span class="n">EXT_PHY1</span><span class="p">].</span><span class="n">flags</span> <span class="o">&amp;</span>
			   <span class="n">FLAGS_INIT_XGXS_FIRST</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">[</span><span class="n">EXT_PHY1</span><span class="p">].</span><span class="n">flags</span> <span class="o">&amp;</span>
		      <span class="n">FLAGS_INIT_XGXS_FIRST</span><span class="p">)</span>
		    <span class="o">&amp;&amp;</span> <span class="n">ext_phy_link_up</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">vars</span><span class="o">-&gt;</span><span class="n">phy_link_up</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">vars</span><span class="o">-&gt;</span><span class="n">line_speed</span> <span class="o">=</span> <span class="n">ext_phy_line_speed</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">vars</span><span class="o">-&gt;</span><span class="n">line_speed</span> <span class="o">&lt;</span> <span class="n">SPEED_1000</span><span class="p">)</span>
				<span class="n">vars</span><span class="o">-&gt;</span><span class="n">phy_flags</span> <span class="o">|=</span> <span class="n">PHY_SGMII_FLAG</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">vars</span><span class="o">-&gt;</span><span class="n">phy_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PHY_SGMII_FLAG</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">[</span><span class="n">INT_PHY</span><span class="p">].</span><span class="n">config_init</span><span class="p">)</span>
				<span class="n">params</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">[</span><span class="n">INT_PHY</span><span class="p">].</span><span class="n">config_init</span><span class="p">(</span>
					<span class="o">&amp;</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">[</span><span class="n">INT_PHY</span><span class="p">],</span> <span class="n">params</span><span class="p">,</span>
						<span class="n">vars</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="cm">/* Link is up only if both local phy and external phy (in case of</span>
<span class="cm">	 * non-direct board) are up and no fault detected on active PHY.</span>
<span class="cm">	 */</span>
	<span class="n">vars</span><span class="o">-&gt;</span><span class="n">link_up</span> <span class="o">=</span> <span class="p">(</span><span class="n">vars</span><span class="o">-&gt;</span><span class="n">phy_link_up</span> <span class="o">&amp;&amp;</span>
			 <span class="p">(</span><span class="n">ext_phy_link_up</span> <span class="o">||</span>
			  <span class="n">SINGLE_MEDIA_DIRECT</span><span class="p">(</span><span class="n">params</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
			 <span class="p">(</span><span class="n">phy_vars</span><span class="p">[</span><span class="n">active_external_phy</span><span class="p">].</span><span class="n">fault_detected</span> <span class="o">==</span> <span class="mi">0</span><span class="p">));</span>

	<span class="cm">/* Update the PFC configuration in case it was changed */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">feature_config_flags</span> <span class="o">&amp;</span> <span class="n">FEATURE_CONFIG_PFC_ENABLED</span><span class="p">)</span>
		<span class="n">vars</span><span class="o">-&gt;</span><span class="n">link_status</span> <span class="o">|=</span> <span class="n">LINK_STATUS_PFC_ENABLED</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">vars</span><span class="o">-&gt;</span><span class="n">link_status</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">LINK_STATUS_PFC_ENABLED</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vars</span><span class="o">-&gt;</span><span class="n">link_up</span><span class="p">)</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">bnx2x_update_link_up</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">vars</span><span class="p">,</span> <span class="n">link_10g_plus</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">bnx2x_update_link_down</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">vars</span><span class="p">);</span>

	<span class="cm">/* Update MCP link status was changed */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">feature_config_flags</span> <span class="o">&amp;</span> <span class="n">FEATURE_CONFIG_BC_SUPPORTS_AFEX</span><span class="p">)</span>
		<span class="n">bnx2x_fw_command</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">DRV_MSG_CODE_LINK_STATUS_CHANGED</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*****************************************************************************/</span>
<span class="cm">/*			    External Phy section			     */</span>
<span class="cm">/*****************************************************************************/</span>
<span class="kt">void</span> <span class="nf">bnx2x_ext_phy_hw_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">,</span> <span class="n">u8</span> <span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bnx2x_set_gpio</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">MISC_REGISTERS_GPIO_1</span><span class="p">,</span>
		       <span class="n">MISC_REGISTERS_GPIO_OUTPUT_LOW</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">bnx2x_set_gpio</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">MISC_REGISTERS_GPIO_1</span><span class="p">,</span>
		       <span class="n">MISC_REGISTERS_GPIO_OUTPUT_HIGH</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_save_spirom_version</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">,</span> <span class="n">u8</span> <span class="n">port</span><span class="p">,</span>
				      <span class="n">u32</span> <span class="n">spirom_ver</span><span class="p">,</span> <span class="n">u32</span> <span class="n">ver_addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;FW version 0x%x:0x%x for port %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="p">(</span><span class="n">u16</span><span class="p">)(</span><span class="n">spirom_ver</span><span class="o">&gt;&gt;</span><span class="mi">16</span><span class="p">),</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span><span class="n">spirom_ver</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ver_addr</span><span class="p">)</span>
		<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">ver_addr</span><span class="p">,</span> <span class="n">spirom_ver</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_save_bcm_spirom_ver</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">bnx2x_phy</span> <span class="o">*</span><span class="n">phy</span><span class="p">,</span>
				      <span class="n">u8</span> <span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">fw_ver1</span><span class="p">,</span> <span class="n">fw_ver2</span><span class="p">;</span>

	<span class="n">bnx2x_cl45_read</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_PMA_DEVAD</span><span class="p">,</span>
			<span class="n">MDIO_PMA_REG_ROM_VER1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fw_ver1</span><span class="p">);</span>
	<span class="n">bnx2x_cl45_read</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_PMA_DEVAD</span><span class="p">,</span>
			<span class="n">MDIO_PMA_REG_ROM_VER2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fw_ver2</span><span class="p">);</span>
	<span class="n">bnx2x_save_spirom_version</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span><span class="p">)(</span><span class="n">fw_ver1</span><span class="o">&lt;&lt;</span><span class="mi">16</span> <span class="o">|</span> <span class="n">fw_ver2</span><span class="p">),</span>
				  <span class="n">phy</span><span class="o">-&gt;</span><span class="n">ver_addr</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_ext_phy_10G_an_resolve</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">bnx2x_phy</span> <span class="o">*</span><span class="n">phy</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">link_vars</span> <span class="o">*</span><span class="n">vars</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">val</span><span class="p">;</span>
	<span class="n">bnx2x_cl45_read</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
			<span class="n">MDIO_AN_DEVAD</span><span class="p">,</span>
			<span class="n">MDIO_AN_REG_STATUS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
	<span class="n">bnx2x_cl45_read</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
			<span class="n">MDIO_AN_DEVAD</span><span class="p">,</span>
			<span class="n">MDIO_AN_REG_STATUS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">5</span><span class="p">))</span>
		<span class="n">vars</span><span class="o">-&gt;</span><span class="n">link_status</span> <span class="o">|=</span> <span class="n">LINK_STATUS_AUTO_NEGOTIATE_COMPLETE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">val</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">0</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">vars</span><span class="o">-&gt;</span><span class="n">link_status</span> <span class="o">|=</span> <span class="n">LINK_STATUS_PARALLEL_DETECTION_USED</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/******************************************************************/</span>
<span class="cm">/*		common BCM8073/BCM8727 PHY SECTION		  */</span>
<span class="cm">/******************************************************************/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_8073_resolve_fc</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x_phy</span> <span class="o">*</span><span class="n">phy</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">link_params</span> <span class="o">*</span><span class="n">params</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">link_vars</span> <span class="o">*</span><span class="n">vars</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">bp</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">req_line_speed</span> <span class="o">==</span> <span class="n">SPEED_10</span> <span class="o">||</span>
	    <span class="n">phy</span><span class="o">-&gt;</span><span class="n">req_line_speed</span> <span class="o">==</span> <span class="n">SPEED_100</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vars</span><span class="o">-&gt;</span><span class="n">flow_ctrl</span> <span class="o">=</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">req_flow_ctrl</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bnx2x_ext_phy_resolve_fc</span><span class="p">(</span><span class="n">phy</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">vars</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">vars</span><span class="o">-&gt;</span><span class="n">flow_ctrl</span> <span class="o">==</span> <span class="n">BNX2X_FLOW_CTRL_NONE</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">u16</span> <span class="n">pause_result</span><span class="p">;</span>
		<span class="n">u16</span> <span class="n">ld_pause</span><span class="p">;</span>		<span class="cm">/* local */</span>
		<span class="n">u16</span> <span class="n">lp_pause</span><span class="p">;</span>		<span class="cm">/* link partner */</span>
		<span class="n">bnx2x_cl45_read</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
				<span class="n">MDIO_AN_DEVAD</span><span class="p">,</span>
				<span class="n">MDIO_AN_REG_CL37_FC_LD</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ld_pause</span><span class="p">);</span>

		<span class="n">bnx2x_cl45_read</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
				<span class="n">MDIO_AN_DEVAD</span><span class="p">,</span>
				<span class="n">MDIO_AN_REG_CL37_FC_LP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lp_pause</span><span class="p">);</span>
		<span class="n">pause_result</span> <span class="o">=</span> <span class="p">(</span><span class="n">ld_pause</span> <span class="o">&amp;</span>
				<span class="n">MDIO_COMBO_IEEE0_AUTO_NEG_ADV_PAUSE_BOTH</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span><span class="p">;</span>
		<span class="n">pause_result</span> <span class="o">|=</span> <span class="p">(</span><span class="n">lp_pause</span> <span class="o">&amp;</span>
				 <span class="n">MDIO_COMBO_IEEE0_AUTO_NEG_ADV_PAUSE_BOTH</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">7</span><span class="p">;</span>

		<span class="n">bnx2x_pause_resolve</span><span class="p">(</span><span class="n">vars</span><span class="p">,</span> <span class="n">pause_result</span><span class="p">);</span>
		<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;Ext PHY CL37 pause result 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">pause_result</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">bnx2x_8073_8727_external_rom_boot</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">,</span>
					     <span class="k">struct</span> <span class="n">bnx2x_phy</span> <span class="o">*</span><span class="n">phy</span><span class="p">,</span>
					     <span class="n">u8</span> <span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">fw_ver1</span><span class="p">,</span> <span class="n">fw_msgout</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Boot port from external ROM  */</span>
	<span class="cm">/* EDC grst */</span>
	<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
			 <span class="n">MDIO_PMA_DEVAD</span><span class="p">,</span>
			 <span class="n">MDIO_PMA_REG_GEN_CTRL</span><span class="p">,</span>
			 <span class="mh">0x0001</span><span class="p">);</span>

	<span class="cm">/* ucode reboot and rst */</span>
	<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
			 <span class="n">MDIO_PMA_DEVAD</span><span class="p">,</span>
			 <span class="n">MDIO_PMA_REG_GEN_CTRL</span><span class="p">,</span>
			 <span class="mh">0x008c</span><span class="p">);</span>

	<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
			 <span class="n">MDIO_PMA_DEVAD</span><span class="p">,</span>
			 <span class="n">MDIO_PMA_REG_MISC_CTRL1</span><span class="p">,</span> <span class="mh">0x0001</span><span class="p">);</span>

	<span class="cm">/* Reset internal microprocessor */</span>
	<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
			 <span class="n">MDIO_PMA_DEVAD</span><span class="p">,</span>
			 <span class="n">MDIO_PMA_REG_GEN_CTRL</span><span class="p">,</span>
			 <span class="n">MDIO_PMA_REG_GEN_CTRL_ROM_MICRO_RESET</span><span class="p">);</span>

	<span class="cm">/* Release srst bit */</span>
	<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
			 <span class="n">MDIO_PMA_DEVAD</span><span class="p">,</span>
			 <span class="n">MDIO_PMA_REG_GEN_CTRL</span><span class="p">,</span>
			 <span class="n">MDIO_PMA_REG_GEN_CTRL_ROM_RESET_INTERNAL_MP</span><span class="p">);</span>

	<span class="cm">/* Delay 100ms per the PHY specifications */</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>

	<span class="cm">/* 8073 sometimes taking longer to download */</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">count</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&gt;</span> <span class="mi">300</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span>
				 <span class="s">&quot;bnx2x_8073_8727_external_rom_boot port %x:&quot;</span>
				 <span class="s">&quot;Download failed. fw version = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="n">port</span><span class="p">,</span> <span class="n">fw_ver1</span><span class="p">);</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">bnx2x_cl45_read</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
				<span class="n">MDIO_PMA_DEVAD</span><span class="p">,</span>
				<span class="n">MDIO_PMA_REG_ROM_VER1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fw_ver1</span><span class="p">);</span>
		<span class="n">bnx2x_cl45_read</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
				<span class="n">MDIO_PMA_DEVAD</span><span class="p">,</span>
				<span class="n">MDIO_PMA_REG_M8051_MSGOUT_REG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fw_msgout</span><span class="p">);</span>

		<span class="n">msleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">fw_ver1</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">fw_ver1</span> <span class="o">==</span> <span class="mh">0x4321</span> <span class="o">||</span>
			<span class="p">((</span><span class="n">fw_msgout</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x03</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span>
			<span class="n">PORT_HW_CFG_XGXS_EXT_PHY_TYPE_BCM8073</span><span class="p">)));</span>

	<span class="cm">/* Clear ser_boot_ctl bit */</span>
	<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
			 <span class="n">MDIO_PMA_DEVAD</span><span class="p">,</span>
			 <span class="n">MDIO_PMA_REG_MISC_CTRL1</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
	<span class="n">bnx2x_save_bcm_spirom_ver</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>

	<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span>
		 <span class="s">&quot;bnx2x_8073_8727_external_rom_boot port %x:&quot;</span>
		 <span class="s">&quot;Download complete. fw version = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">port</span><span class="p">,</span> <span class="n">fw_ver1</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/******************************************************************/</span>
<span class="cm">/*			BCM8073 PHY SECTION			  */</span>
<span class="cm">/******************************************************************/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">bnx2x_8073_is_snr_needed</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bnx2x_phy</span> <span class="o">*</span><span class="n">phy</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* This is only required for 8073A1, version 102 only */</span>
	<span class="n">u16</span> <span class="n">val</span><span class="p">;</span>

	<span class="cm">/* Read 8073 HW revision*/</span>
	<span class="n">bnx2x_cl45_read</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
			<span class="n">MDIO_PMA_DEVAD</span><span class="p">,</span>
			<span class="n">MDIO_PMA_REG_8073_CHIP_REV</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* No need to workaround in 8073 A1 */</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">bnx2x_cl45_read</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
			<span class="n">MDIO_PMA_DEVAD</span><span class="p">,</span>
			<span class="n">MDIO_PMA_REG_ROM_VER2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>

	<span class="cm">/* SNR should be applied only for version 0x102 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">!=</span> <span class="mh">0x102</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bnx2x_8073_xaui_wa</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bnx2x_phy</span> <span class="o">*</span><span class="n">phy</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">val</span><span class="p">,</span> <span class="n">cnt</span><span class="p">,</span> <span class="n">cnt1</span> <span class="p">;</span>

	<span class="n">bnx2x_cl45_read</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
			<span class="n">MDIO_PMA_DEVAD</span><span class="p">,</span>
			<span class="n">MDIO_PMA_REG_8073_CHIP_REV</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* No need to workaround in 8073 A1 */</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* XAUI workaround in 8073 A0: */</span>

	<span class="cm">/* After loading the boot ROM and restarting Autoneg, poll</span>
<span class="cm">	 * Dev1, Reg $C820:</span>
<span class="cm">	 */</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">cnt</span> <span class="o">&lt;</span> <span class="mi">1000</span><span class="p">;</span> <span class="n">cnt</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bnx2x_cl45_read</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
				<span class="n">MDIO_PMA_DEVAD</span><span class="p">,</span>
				<span class="n">MDIO_PMA_REG_8073_SPEED_LINK_STATUS</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
		  <span class="cm">/* If bit [14] = 0 or bit [13] = 0, continue on with</span>
<span class="cm">		   * system initialization (XAUI work-around not required, as</span>
<span class="cm">		   * these bits indicate 2.5G or 1G link up).</span>
<span class="cm">		   */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">14</span><span class="p">))</span> <span class="o">||</span> <span class="o">!</span><span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">13</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;XAUI work-around not required</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">15</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;bit 15 went off</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="cm">/* If bit 15 is 0, then poll Dev1, Reg $C841 until it&#39;s</span>
<span class="cm">			 * MSB (bit15) goes to 1 (indicating that the XAUI</span>
<span class="cm">			 * workaround has completed), then continue on with</span>
<span class="cm">			 * system initialization.</span>
<span class="cm">			 */</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">cnt1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">cnt1</span> <span class="o">&lt;</span> <span class="mi">1000</span><span class="p">;</span> <span class="n">cnt1</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">bnx2x_cl45_read</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
					<span class="n">MDIO_PMA_DEVAD</span><span class="p">,</span>
					<span class="n">MDIO_PMA_REG_8073_XAUI_WA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">15</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span>
					  <span class="s">&quot;XAUI workaround has completed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
					<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
				 <span class="p">}</span>
				 <span class="n">msleep</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;Warning: XAUI work-around timeout !!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_807x_force_10G</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bnx2x_phy</span> <span class="o">*</span><span class="n">phy</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Force KR or KX */</span>
	<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
			 <span class="n">MDIO_PMA_DEVAD</span><span class="p">,</span> <span class="n">MDIO_PMA_REG_CTRL</span><span class="p">,</span> <span class="mh">0x2040</span><span class="p">);</span>
	<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
			 <span class="n">MDIO_PMA_DEVAD</span><span class="p">,</span> <span class="n">MDIO_PMA_REG_10G_CTRL2</span><span class="p">,</span> <span class="mh">0x000b</span><span class="p">);</span>
	<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
			 <span class="n">MDIO_PMA_DEVAD</span><span class="p">,</span> <span class="n">MDIO_PMA_REG_BCM_CTRL</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
	<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
			 <span class="n">MDIO_AN_DEVAD</span><span class="p">,</span> <span class="n">MDIO_AN_REG_CTRL</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_8073_set_pause_cl37</span><span class="p">(</span><span class="k">struct</span> <span class="n">link_params</span> <span class="o">*</span><span class="n">params</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">bnx2x_phy</span> <span class="o">*</span><span class="n">phy</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">link_vars</span> <span class="o">*</span><span class="n">vars</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">cl37_val</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">bp</span><span class="p">;</span>
	<span class="n">bnx2x_cl45_read</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
			<span class="n">MDIO_AN_DEVAD</span><span class="p">,</span> <span class="n">MDIO_AN_REG_CL37_FC_LD</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cl37_val</span><span class="p">);</span>

	<span class="n">cl37_val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MDIO_COMBO_IEEE0_AUTO_NEG_ADV_PAUSE_BOTH</span><span class="p">;</span>
	<span class="cm">/* Please refer to Table 28B-3 of 802.3ab-1999 spec. */</span>
	<span class="n">bnx2x_calc_ieee_aneg_adv</span><span class="p">(</span><span class="n">phy</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vars</span><span class="o">-&gt;</span><span class="n">ieee_fc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">vars</span><span class="o">-&gt;</span><span class="n">ieee_fc</span> <span class="o">&amp;</span>
	    <span class="n">MDIO_COMBO_IEEE0_AUTO_NEG_ADV_PAUSE_SYMMETRIC</span><span class="p">)</span> <span class="o">==</span>
	    <span class="n">MDIO_COMBO_IEEE0_AUTO_NEG_ADV_PAUSE_SYMMETRIC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cl37_val</span> <span class="o">|=</span>  <span class="n">MDIO_COMBO_IEEE0_AUTO_NEG_ADV_PAUSE_SYMMETRIC</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">vars</span><span class="o">-&gt;</span><span class="n">ieee_fc</span> <span class="o">&amp;</span>
	    <span class="n">MDIO_COMBO_IEEE0_AUTO_NEG_ADV_PAUSE_ASYMMETRIC</span><span class="p">)</span> <span class="o">==</span>
	    <span class="n">MDIO_COMBO_IEEE0_AUTO_NEG_ADV_PAUSE_ASYMMETRIC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cl37_val</span> <span class="o">|=</span>  <span class="n">MDIO_COMBO_IEEE0_AUTO_NEG_ADV_PAUSE_ASYMMETRIC</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">vars</span><span class="o">-&gt;</span><span class="n">ieee_fc</span> <span class="o">&amp;</span>
	    <span class="n">MDIO_COMBO_IEEE0_AUTO_NEG_ADV_PAUSE_BOTH</span><span class="p">)</span> <span class="o">==</span>
	    <span class="n">MDIO_COMBO_IEEE0_AUTO_NEG_ADV_PAUSE_BOTH</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cl37_val</span> <span class="o">|=</span> <span class="n">MDIO_COMBO_IEEE0_AUTO_NEG_ADV_PAUSE_BOTH</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span>
		 <span class="s">&quot;Ext phy AN advertize cl37 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cl37_val</span><span class="p">);</span>

	<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
			 <span class="n">MDIO_AN_DEVAD</span><span class="p">,</span> <span class="n">MDIO_AN_REG_CL37_FC_LD</span><span class="p">,</span> <span class="n">cl37_val</span><span class="p">);</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">500</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bnx2x_8073_config_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x_phy</span> <span class="o">*</span><span class="n">phy</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">link_params</span> <span class="o">*</span><span class="n">params</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">link_vars</span> <span class="o">*</span><span class="n">vars</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">bp</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">tmp1</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">gpio_port</span><span class="p">;</span>
	<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;Init 8073</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">CHIP_IS_E2</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span>
		<span class="n">gpio_port</span> <span class="o">=</span> <span class="n">BP_PATH</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">gpio_port</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>
	<span class="cm">/* Restore normal power mode*/</span>
	<span class="n">bnx2x_set_gpio</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">MISC_REGISTERS_GPIO_2</span><span class="p">,</span>
		       <span class="n">MISC_REGISTERS_GPIO_OUTPUT_HIGH</span><span class="p">,</span> <span class="n">gpio_port</span><span class="p">);</span>

	<span class="n">bnx2x_set_gpio</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">MISC_REGISTERS_GPIO_1</span><span class="p">,</span>
		       <span class="n">MISC_REGISTERS_GPIO_OUTPUT_HIGH</span><span class="p">,</span> <span class="n">gpio_port</span><span class="p">);</span>

	<span class="cm">/* enable LASI */</span>
	<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
			 <span class="n">MDIO_PMA_DEVAD</span><span class="p">,</span> <span class="n">MDIO_PMA_LASI_RXCTRL</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">2</span><span class="p">));</span>
	<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
			 <span class="n">MDIO_PMA_DEVAD</span><span class="p">,</span> <span class="n">MDIO_PMA_LASI_CTRL</span><span class="p">,</span>  <span class="mh">0x0004</span><span class="p">);</span>

	<span class="n">bnx2x_8073_set_pause_cl37</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">vars</span><span class="p">);</span>

	<span class="n">bnx2x_cl45_read</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
			<span class="n">MDIO_PMA_DEVAD</span><span class="p">,</span> <span class="n">MDIO_PMA_REG_M8051_MSGOUT_REG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp1</span><span class="p">);</span>

	<span class="n">bnx2x_cl45_read</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
			<span class="n">MDIO_PMA_DEVAD</span><span class="p">,</span> <span class="n">MDIO_PMA_LASI_RXSTAT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp1</span><span class="p">);</span>

	<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;Before rom RX_ALARM(port1): 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tmp1</span><span class="p">);</span>

	<span class="cm">/* Swap polarity if required - Must be done only in non-1G mode */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">lane_config</span> <span class="o">&amp;</span> <span class="n">PORT_HW_CFG_SWAP_PHY_POLARITY_ENABLED</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Configure the 8073 to swap _P and _N of the KR lines */</span>
		<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;Swapping polarity for the 8073</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="cm">/* 10G Rx/Tx and 1G Tx signal polarity swap */</span>
		<span class="n">bnx2x_cl45_read</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
				<span class="n">MDIO_PMA_DEVAD</span><span class="p">,</span>
				<span class="n">MDIO_PMA_REG_8073_OPT_DIGITAL_CTRL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
		<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
				 <span class="n">MDIO_PMA_DEVAD</span><span class="p">,</span>
				 <span class="n">MDIO_PMA_REG_8073_OPT_DIGITAL_CTRL</span><span class="p">,</span>
				 <span class="p">(</span><span class="n">val</span> <span class="o">|</span> <span class="p">(</span><span class="mi">3</span><span class="o">&lt;&lt;</span><span class="mi">9</span><span class="p">)));</span>
	<span class="p">}</span>


	<span class="cm">/* Enable CL37 BAM */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">shmem_base</span> <span class="o">+</span>
			 <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">shmem_region</span><span class="p">,</span> <span class="n">dev_info</span><span class="p">.</span>
				  <span class="n">port_hw_config</span><span class="p">[</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">].</span><span class="n">default_cfg</span><span class="p">))</span> <span class="o">&amp;</span>
	    <span class="n">PORT_HW_CFG_ENABLE_BAM_ON_KR_ENABLED</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">bnx2x_cl45_read</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
				<span class="n">MDIO_AN_DEVAD</span><span class="p">,</span>
				<span class="n">MDIO_AN_REG_8073_BAM</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
		<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
				 <span class="n">MDIO_AN_DEVAD</span><span class="p">,</span>
				 <span class="n">MDIO_AN_REG_8073_BAM</span><span class="p">,</span> <span class="n">val</span> <span class="o">|</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;Enable CL37 BAM on KR</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">loopback_mode</span> <span class="o">==</span> <span class="n">LOOPBACK_EXT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bnx2x_807x_force_10G</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">);</span>
		<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;Forced speed 10G on 807X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
				 <span class="n">MDIO_PMA_DEVAD</span><span class="p">,</span> <span class="n">MDIO_PMA_REG_BCM_CTRL</span><span class="p">,</span> <span class="mh">0x0002</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">req_line_speed</span> <span class="o">!=</span> <span class="n">SPEED_AUTO_NEG</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">req_line_speed</span> <span class="o">==</span> <span class="n">SPEED_10000</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">7</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">req_line_speed</span> <span class="o">==</span>  <span class="n">SPEED_2500</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">5</span><span class="p">);</span>
			<span class="cm">/* Note that 2.5G works only when used with 1G</span>
<span class="cm">			 * advertisement</span>
<span class="cm">			 */</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">5</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">speed_cap_mask</span> <span class="o">&amp;</span>
			<span class="n">PORT_HW_CFG_SPEED_CAPABILITY_D0_10G</span><span class="p">)</span>
			<span class="n">val</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">7</span><span class="p">);</span>

		<span class="cm">/* Note that 2.5G works only when used with 1G advertisement */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">speed_cap_mask</span> <span class="o">&amp;</span>
			<span class="p">(</span><span class="n">PORT_HW_CFG_SPEED_CAPABILITY_D0_1G</span> <span class="o">|</span>
			 <span class="n">PORT_HW_CFG_SPEED_CAPABILITY_D0_2_5G</span><span class="p">))</span>
			<span class="n">val</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">5</span><span class="p">);</span>
		<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;807x autoneg val = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_AN_DEVAD</span><span class="p">,</span> <span class="n">MDIO_AN_REG_ADV</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="n">bnx2x_cl45_read</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_AN_DEVAD</span><span class="p">,</span> <span class="n">MDIO_AN_REG_8073_2_5G</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(((</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">speed_cap_mask</span> <span class="o">&amp;</span> <span class="n">PORT_HW_CFG_SPEED_CAPABILITY_D0_2_5G</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	     <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">req_line_speed</span> <span class="o">==</span> <span class="n">SPEED_AUTO_NEG</span><span class="p">))</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">req_line_speed</span> <span class="o">==</span> <span class="n">SPEED_2500</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">u16</span> <span class="n">phy_ver</span><span class="p">;</span>
		<span class="cm">/* Allow 2.5G for A1 and above */</span>
		<span class="n">bnx2x_cl45_read</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
				<span class="n">MDIO_PMA_DEVAD</span><span class="p">,</span> <span class="n">MDIO_PMA_REG_8073_CHIP_REV</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">phy_ver</span><span class="p">);</span>
		<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;Add 2.5G</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">phy_ver</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">tmp1</span> <span class="o">|=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">tmp1</span> <span class="o">&amp;=</span> <span class="mh">0xfffe</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;Disable 2.5G</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">tmp1</span> <span class="o">&amp;=</span> <span class="mh">0xfffe</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_AN_DEVAD</span><span class="p">,</span> <span class="n">MDIO_AN_REG_8073_2_5G</span><span class="p">,</span> <span class="n">tmp1</span><span class="p">);</span>
	<span class="cm">/* Add support for CL37 (passive mode) II */</span>

	<span class="n">bnx2x_cl45_read</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_AN_DEVAD</span><span class="p">,</span> <span class="n">MDIO_AN_REG_CL37_FC_LD</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp1</span><span class="p">);</span>
	<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_AN_DEVAD</span><span class="p">,</span> <span class="n">MDIO_AN_REG_CL37_FC_LD</span><span class="p">,</span>
			 <span class="p">(</span><span class="n">tmp1</span> <span class="o">|</span> <span class="p">((</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">req_duplex</span> <span class="o">==</span> <span class="n">DUPLEX_FULL</span><span class="p">)</span> <span class="o">?</span>
				  <span class="mh">0x20</span> <span class="o">:</span> <span class="mh">0x40</span><span class="p">)));</span>

	<span class="cm">/* Add support for CL37 (passive mode) III */</span>
	<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_AN_DEVAD</span><span class="p">,</span> <span class="n">MDIO_AN_REG_CL37_AN</span><span class="p">,</span> <span class="mh">0x1000</span><span class="p">);</span>

	<span class="cm">/* The SNR will improve about 2db by changing BW and FEE main</span>
<span class="cm">	 * tap. Rest commands are executed after link is up</span>
<span class="cm">	 * Change FFE main cursor to 5 in EDC register</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bnx2x_8073_is_snr_needed</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">))</span>
		<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
				 <span class="n">MDIO_PMA_DEVAD</span><span class="p">,</span> <span class="n">MDIO_PMA_REG_EDC_FFE_MAIN</span><span class="p">,</span>
				 <span class="mh">0xFB0C</span><span class="p">);</span>

	<span class="cm">/* Enable FEC (Forware Error Correction) Request in the AN */</span>
	<span class="n">bnx2x_cl45_read</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_AN_DEVAD</span><span class="p">,</span> <span class="n">MDIO_AN_REG_ADV2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp1</span><span class="p">);</span>
	<span class="n">tmp1</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">15</span><span class="p">);</span>
	<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_AN_DEVAD</span><span class="p">,</span> <span class="n">MDIO_AN_REG_ADV2</span><span class="p">,</span> <span class="n">tmp1</span><span class="p">);</span>

	<span class="n">bnx2x_ext_phy_set_pause</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">vars</span><span class="p">);</span>

	<span class="cm">/* Restart autoneg */</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">500</span><span class="p">);</span>
	<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_AN_DEVAD</span><span class="p">,</span> <span class="n">MDIO_AN_REG_CTRL</span><span class="p">,</span> <span class="mh">0x1200</span><span class="p">);</span>
	<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;807x Autoneg Restart: Advertise 1G=%x, 10G=%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="p">((</span><span class="n">val</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">5</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">),</span> <span class="p">((</span><span class="n">val</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">7</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">));</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u8</span> <span class="nf">bnx2x_8073_read_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x_phy</span> <span class="o">*</span><span class="n">phy</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">link_params</span> <span class="o">*</span><span class="n">params</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">link_vars</span> <span class="o">*</span><span class="n">vars</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">bp</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">link_up</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">val1</span><span class="p">,</span> <span class="n">val2</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">link_status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">an1000_status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">bnx2x_cl45_read</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
			<span class="n">MDIO_PMA_DEVAD</span><span class="p">,</span> <span class="n">MDIO_PMA_LASI_STAT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val1</span><span class="p">);</span>

	<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;8703 LASI status 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">val1</span><span class="p">);</span>

	<span class="cm">/* clear the interrupt LASI status register */</span>
	<span class="n">bnx2x_cl45_read</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
			<span class="n">MDIO_PCS_DEVAD</span><span class="p">,</span> <span class="n">MDIO_PCS_REG_STATUS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val2</span><span class="p">);</span>
	<span class="n">bnx2x_cl45_read</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
			<span class="n">MDIO_PCS_DEVAD</span><span class="p">,</span> <span class="n">MDIO_PCS_REG_STATUS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val1</span><span class="p">);</span>
	<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;807x PCS status 0x%x-&gt;0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">val2</span><span class="p">,</span> <span class="n">val1</span><span class="p">);</span>
	<span class="cm">/* Clear MSG-OUT */</span>
	<span class="n">bnx2x_cl45_read</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
			<span class="n">MDIO_PMA_DEVAD</span><span class="p">,</span> <span class="n">MDIO_PMA_REG_M8051_MSGOUT_REG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val1</span><span class="p">);</span>

	<span class="cm">/* Check the LASI */</span>
	<span class="n">bnx2x_cl45_read</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
			<span class="n">MDIO_PMA_DEVAD</span><span class="p">,</span> <span class="n">MDIO_PMA_LASI_RXSTAT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val2</span><span class="p">);</span>

	<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;KR 0x9003 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">val2</span><span class="p">);</span>

	<span class="cm">/* Check the link status */</span>
	<span class="n">bnx2x_cl45_read</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
			<span class="n">MDIO_PCS_DEVAD</span><span class="p">,</span> <span class="n">MDIO_PCS_REG_STATUS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val2</span><span class="p">);</span>
	<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;KR PCS status 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">val2</span><span class="p">);</span>

	<span class="n">bnx2x_cl45_read</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
			<span class="n">MDIO_PMA_DEVAD</span><span class="p">,</span> <span class="n">MDIO_PMA_REG_STATUS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val2</span><span class="p">);</span>
	<span class="n">bnx2x_cl45_read</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
			<span class="n">MDIO_PMA_DEVAD</span><span class="p">,</span> <span class="n">MDIO_PMA_REG_STATUS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val1</span><span class="p">);</span>
	<span class="n">link_up</span> <span class="o">=</span> <span class="p">((</span><span class="n">val1</span> <span class="o">&amp;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;PMA_REG_STATUS=0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">val1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">link_up</span> <span class="o">&amp;&amp;</span>
	     <span class="p">((</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">req_line_speed</span> <span class="o">!=</span> <span class="n">SPEED_10000</span><span class="p">)))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bnx2x_8073_xaui_wa</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">bnx2x_cl45_read</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
			<span class="n">MDIO_AN_DEVAD</span><span class="p">,</span> <span class="n">MDIO_AN_REG_LINK_STATUS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">an1000_status</span><span class="p">);</span>
	<span class="n">bnx2x_cl45_read</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
			<span class="n">MDIO_AN_DEVAD</span><span class="p">,</span> <span class="n">MDIO_AN_REG_LINK_STATUS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">an1000_status</span><span class="p">);</span>

	<span class="cm">/* Check the link status on 1.1.2 */</span>
	<span class="n">bnx2x_cl45_read</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
			<span class="n">MDIO_PMA_DEVAD</span><span class="p">,</span> <span class="n">MDIO_PMA_REG_STATUS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val2</span><span class="p">);</span>
	<span class="n">bnx2x_cl45_read</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
			<span class="n">MDIO_PMA_DEVAD</span><span class="p">,</span> <span class="n">MDIO_PMA_REG_STATUS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val1</span><span class="p">);</span>
	<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;KR PMA status 0x%x-&gt;0x%x,&quot;</span>
		   <span class="s">&quot;an_link_status=0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">val2</span><span class="p">,</span> <span class="n">val1</span><span class="p">,</span> <span class="n">an1000_status</span><span class="p">);</span>

	<span class="n">link_up</span> <span class="o">=</span> <span class="p">(((</span><span class="n">val1</span> <span class="o">&amp;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">an1000_status</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">1</span><span class="p">)));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">link_up</span> <span class="o">&amp;&amp;</span> <span class="n">bnx2x_8073_is_snr_needed</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* The SNR will improve about 2dbby changing the BW and FEE main</span>
<span class="cm">		 * tap. The 1st write to change FFE main tap is set before</span>
<span class="cm">		 * restart AN. Change PLL Bandwidth in EDC register</span>
<span class="cm">		 */</span>
		<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
				 <span class="n">MDIO_PMA_DEVAD</span><span class="p">,</span> <span class="n">MDIO_PMA_REG_PLL_BANDWIDTH</span><span class="p">,</span>
				 <span class="mh">0x26BC</span><span class="p">);</span>

		<span class="cm">/* Change CDR Bandwidth in EDC register */</span>
		<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
				 <span class="n">MDIO_PMA_DEVAD</span><span class="p">,</span> <span class="n">MDIO_PMA_REG_CDR_BANDWIDTH</span><span class="p">,</span>
				 <span class="mh">0x0333</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">bnx2x_cl45_read</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
			<span class="n">MDIO_PMA_DEVAD</span><span class="p">,</span> <span class="n">MDIO_PMA_REG_8073_SPEED_LINK_STATUS</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">link_status</span><span class="p">);</span>

	<span class="cm">/* Bits 0..2 --&gt; speed detected, bits 13..15--&gt; link is down */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">link_status</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">2</span><span class="p">))</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">link_status</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">15</span><span class="p">))))</span> <span class="p">{</span>
		<span class="n">link_up</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">vars</span><span class="o">-&gt;</span><span class="n">line_speed</span> <span class="o">=</span> <span class="n">SPEED_10000</span><span class="p">;</span>
		<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;port %x: External link up in 10G</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">params</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">link_status</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">1</span><span class="p">))</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">link_status</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">14</span><span class="p">))))</span> <span class="p">{</span>
		<span class="n">link_up</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">vars</span><span class="o">-&gt;</span><span class="n">line_speed</span> <span class="o">=</span> <span class="n">SPEED_2500</span><span class="p">;</span>
		<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;port %x: External link up in 2.5G</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">params</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">link_status</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">0</span><span class="p">))</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">link_status</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">13</span><span class="p">))))</span> <span class="p">{</span>
		<span class="n">link_up</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">vars</span><span class="o">-&gt;</span><span class="n">line_speed</span> <span class="o">=</span> <span class="n">SPEED_1000</span><span class="p">;</span>
		<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;port %x: External link up in 1G</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">params</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">link_up</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;port %x: External link is down</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">params</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">link_up</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Swap polarity if required */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">lane_config</span> <span class="o">&amp;</span>
		    <span class="n">PORT_HW_CFG_SWAP_PHY_POLARITY_ENABLED</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Configure the 8073 to swap P and N of the KR lines */</span>
			<span class="n">bnx2x_cl45_read</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
					<span class="n">MDIO_XS_DEVAD</span><span class="p">,</span>
					<span class="n">MDIO_XS_REG_8073_RX_CTRL_PCIE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val1</span><span class="p">);</span>
			<span class="cm">/* Set bit 3 to invert Rx in 1G mode and clear this bit</span>
<span class="cm">			 * when it`s in 10G mode.</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">vars</span><span class="o">-&gt;</span><span class="n">line_speed</span> <span class="o">==</span> <span class="n">SPEED_1000</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;Swapping 1G polarity for&quot;</span>
					      <span class="s">&quot;the 8073</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">val1</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">3</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="n">val1</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">3</span><span class="p">);</span>

			<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
					 <span class="n">MDIO_XS_DEVAD</span><span class="p">,</span>
					 <span class="n">MDIO_XS_REG_8073_RX_CTRL_PCIE</span><span class="p">,</span>
					 <span class="n">val1</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">bnx2x_ext_phy_10G_an_resolve</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">vars</span><span class="p">);</span>
		<span class="n">bnx2x_8073_resolve_fc</span><span class="p">(</span><span class="n">phy</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">vars</span><span class="p">);</span>
		<span class="n">vars</span><span class="o">-&gt;</span><span class="n">duplex</span> <span class="o">=</span> <span class="n">DUPLEX_FULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vars</span><span class="o">-&gt;</span><span class="n">link_status</span> <span class="o">&amp;</span> <span class="n">LINK_STATUS_AUTO_NEGOTIATE_COMPLETE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bnx2x_cl45_read</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_AN_DEVAD</span><span class="p">,</span>
				<span class="n">MDIO_AN_REG_LP_AUTO_NEG2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val1</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">val1</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">5</span><span class="p">))</span>
			<span class="n">vars</span><span class="o">-&gt;</span><span class="n">link_status</span> <span class="o">|=</span>
				<span class="n">LINK_STATUS_LINK_PARTNER_1000TFD_CAPABLE</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">val1</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">7</span><span class="p">))</span>
			<span class="n">vars</span><span class="o">-&gt;</span><span class="n">link_status</span> <span class="o">|=</span>
				<span class="n">LINK_STATUS_LINK_PARTNER_10GXFD_CAPABLE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">link_up</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_8073_link_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x_phy</span> <span class="o">*</span><span class="n">phy</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">link_params</span> <span class="o">*</span><span class="n">params</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">bp</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">gpio_port</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">CHIP_IS_E2</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span>
		<span class="n">gpio_port</span> <span class="o">=</span> <span class="n">BP_PATH</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">gpio_port</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>
	<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;Setting 8073 port %d into low power mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	   <span class="n">gpio_port</span><span class="p">);</span>
	<span class="n">bnx2x_set_gpio</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">MISC_REGISTERS_GPIO_2</span><span class="p">,</span>
		       <span class="n">MISC_REGISTERS_GPIO_OUTPUT_LOW</span><span class="p">,</span>
		       <span class="n">gpio_port</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/******************************************************************/</span>
<span class="cm">/*			BCM8705 PHY SECTION			  */</span>
<span class="cm">/******************************************************************/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">bnx2x_8705_config_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x_phy</span> <span class="o">*</span><span class="n">phy</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">link_params</span> <span class="o">*</span><span class="n">params</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">link_vars</span> <span class="o">*</span><span class="n">vars</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">bp</span><span class="p">;</span>
	<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;init 8705</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="cm">/* Restore normal power mode*/</span>
	<span class="n">bnx2x_set_gpio</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">MISC_REGISTERS_GPIO_2</span><span class="p">,</span>
		       <span class="n">MISC_REGISTERS_GPIO_OUTPUT_HIGH</span><span class="p">,</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">);</span>
	<span class="cm">/* HW reset */</span>
	<span class="n">bnx2x_ext_phy_hw_reset</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">);</span>
	<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_PMA_DEVAD</span><span class="p">,</span> <span class="n">MDIO_PMA_REG_CTRL</span><span class="p">,</span> <span class="mh">0xa040</span><span class="p">);</span>
	<span class="n">bnx2x_wait_reset_complete</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">params</span><span class="p">);</span>

	<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
			 <span class="n">MDIO_PMA_DEVAD</span><span class="p">,</span> <span class="n">MDIO_PMA_REG_MISC_CTRL</span><span class="p">,</span> <span class="mh">0x8288</span><span class="p">);</span>
	<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
			 <span class="n">MDIO_PMA_DEVAD</span><span class="p">,</span> <span class="n">MDIO_PMA_REG_PHY_IDENTIFIER</span><span class="p">,</span> <span class="mh">0x7fbf</span><span class="p">);</span>
	<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
			 <span class="n">MDIO_PMA_DEVAD</span><span class="p">,</span> <span class="n">MDIO_PMA_REG_CMU_PLL_BYPASS</span><span class="p">,</span> <span class="mh">0x0100</span><span class="p">);</span>
	<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
			 <span class="n">MDIO_WIS_DEVAD</span><span class="p">,</span> <span class="n">MDIO_WIS_REG_LASI_CNTL</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">);</span>
	<span class="cm">/* BCM8705 doesn&#39;t have microcode, hence the 0 */</span>
	<span class="n">bnx2x_save_spirom_version</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">shmem_base</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u8</span> <span class="nf">bnx2x_8705_read_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x_phy</span> <span class="o">*</span><span class="n">phy</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">link_params</span> <span class="o">*</span><span class="n">params</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">link_vars</span> <span class="o">*</span><span class="n">vars</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">link_up</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">val1</span><span class="p">,</span> <span class="n">rx_sd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">bp</span><span class="p">;</span>
	<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;read status 8705</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">bnx2x_cl45_read</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
		      <span class="n">MDIO_WIS_DEVAD</span><span class="p">,</span> <span class="n">MDIO_WIS_REG_LASI_STATUS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val1</span><span class="p">);</span>
	<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;8705 LASI status 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">val1</span><span class="p">);</span>

	<span class="n">bnx2x_cl45_read</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
		      <span class="n">MDIO_WIS_DEVAD</span><span class="p">,</span> <span class="n">MDIO_WIS_REG_LASI_STATUS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val1</span><span class="p">);</span>
	<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;8705 LASI status 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">val1</span><span class="p">);</span>

	<span class="n">bnx2x_cl45_read</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
		      <span class="n">MDIO_PMA_DEVAD</span><span class="p">,</span> <span class="n">MDIO_PMA_REG_RX_SD</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rx_sd</span><span class="p">);</span>

	<span class="n">bnx2x_cl45_read</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
		      <span class="n">MDIO_PMA_DEVAD</span><span class="p">,</span> <span class="mh">0xc809</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val1</span><span class="p">);</span>
	<span class="n">bnx2x_cl45_read</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
		      <span class="n">MDIO_PMA_DEVAD</span><span class="p">,</span> <span class="mh">0xc809</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val1</span><span class="p">);</span>

	<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;8705 1.c809 val=0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">val1</span><span class="p">);</span>
	<span class="n">link_up</span> <span class="o">=</span> <span class="p">((</span><span class="n">rx_sd</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">val1</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">9</span><span class="p">))</span> <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="n">val1</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">8</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">link_up</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vars</span><span class="o">-&gt;</span><span class="n">line_speed</span> <span class="o">=</span> <span class="n">SPEED_10000</span><span class="p">;</span>
		<span class="n">bnx2x_ext_phy_resolve_fc</span><span class="p">(</span><span class="n">phy</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">vars</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">link_up</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/******************************************************************/</span>
<span class="cm">/*			SFP+ module Section			  */</span>
<span class="cm">/******************************************************************/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_set_disable_pmd_transmit</span><span class="p">(</span><span class="k">struct</span> <span class="n">link_params</span> <span class="o">*</span><span class="n">params</span><span class="p">,</span>
					   <span class="k">struct</span> <span class="n">bnx2x_phy</span> <span class="o">*</span><span class="n">phy</span><span class="p">,</span>
					   <span class="n">u8</span> <span class="n">pmd_dis</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">bp</span><span class="p">;</span>
	<span class="cm">/* Disable transmitter only for bootcodes which can enable it afterwards</span>
<span class="cm">	 * (for D3 link)</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pmd_dis</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">feature_config_flags</span> <span class="o">&amp;</span>
		     <span class="n">FEATURE_CONFIG_BC_SUPPORTS_SFP_TX_DISABLED</span><span class="p">)</span>
			<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;Disabling PMD transmitter</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;NOT disabling PMD transmitter</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;Enabling PMD transmitter</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
			 <span class="n">MDIO_PMA_DEVAD</span><span class="p">,</span>
			 <span class="n">MDIO_PMA_REG_TX_DISABLE</span><span class="p">,</span> <span class="n">pmd_dis</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u8</span> <span class="nf">bnx2x_get_gpio_port</span><span class="p">(</span><span class="k">struct</span> <span class="n">link_params</span> <span class="o">*</span><span class="n">params</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">gpio_port</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">swap_val</span><span class="p">,</span> <span class="n">swap_override</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">bp</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">CHIP_IS_E2</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span>
		<span class="n">gpio_port</span> <span class="o">=</span> <span class="n">BP_PATH</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">gpio_port</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>
	<span class="n">swap_val</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">NIG_REG_PORT_SWAP</span><span class="p">);</span>
	<span class="n">swap_override</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">NIG_REG_STRAP_OVERRIDE</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">gpio_port</span> <span class="o">^</span> <span class="p">(</span><span class="n">swap_val</span> <span class="o">&amp;&amp;</span> <span class="n">swap_override</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_sfp_e1e2_set_transmitter</span><span class="p">(</span><span class="k">struct</span> <span class="n">link_params</span> <span class="o">*</span><span class="n">params</span><span class="p">,</span>
					   <span class="k">struct</span> <span class="n">bnx2x_phy</span> <span class="o">*</span><span class="n">phy</span><span class="p">,</span>
					   <span class="n">u8</span> <span class="n">tx_en</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">val</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">port</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">bp</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tx_en_mode</span><span class="p">;</span>

	<span class="cm">/* Disable/Enable transmitter ( TX laser of the SFP+ module.)*/</span>
	<span class="n">tx_en_mode</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">shmem_base</span> <span class="o">+</span>
			    <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">shmem_region</span><span class="p">,</span>
				     <span class="n">dev_info</span><span class="p">.</span><span class="n">port_hw_config</span><span class="p">[</span><span class="n">port</span><span class="p">].</span><span class="n">sfp_ctrl</span><span class="p">))</span> <span class="o">&amp;</span>
		<span class="n">PORT_HW_CFG_TX_LASER_MASK</span><span class="p">;</span>
	<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;Setting transmitter tx_en=%x for port %x &quot;</span>
			   <span class="s">&quot;mode = %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tx_en</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">tx_en_mode</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">tx_en_mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PORT_HW_CFG_TX_LASER_MDIO</span>:

		<span class="n">bnx2x_cl45_read</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
				<span class="n">MDIO_PMA_DEVAD</span><span class="p">,</span>
				<span class="n">MDIO_PMA_REG_PHY_IDENTIFIER</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">tx_en</span><span class="p">)</span>
			<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">15</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">val</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">15</span><span class="p">);</span>

		<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
				 <span class="n">MDIO_PMA_DEVAD</span><span class="p">,</span>
				 <span class="n">MDIO_PMA_REG_PHY_IDENTIFIER</span><span class="p">,</span>
				 <span class="n">val</span><span class="p">);</span>
	<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PORT_HW_CFG_TX_LASER_GPIO0</span>:
	<span class="k">case</span> <span class="n">PORT_HW_CFG_TX_LASER_GPIO1</span>:
	<span class="k">case</span> <span class="n">PORT_HW_CFG_TX_LASER_GPIO2</span>:
	<span class="k">case</span> <span class="n">PORT_HW_CFG_TX_LASER_GPIO3</span>:
	<span class="p">{</span>
		<span class="n">u16</span> <span class="n">gpio_pin</span><span class="p">;</span>
		<span class="n">u8</span> <span class="n">gpio_port</span><span class="p">,</span> <span class="n">gpio_mode</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tx_en</span><span class="p">)</span>
			<span class="n">gpio_mode</span> <span class="o">=</span> <span class="n">MISC_REGISTERS_GPIO_OUTPUT_HIGH</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">gpio_mode</span> <span class="o">=</span> <span class="n">MISC_REGISTERS_GPIO_OUTPUT_LOW</span><span class="p">;</span>

		<span class="n">gpio_pin</span> <span class="o">=</span> <span class="n">tx_en_mode</span> <span class="o">-</span> <span class="n">PORT_HW_CFG_TX_LASER_GPIO0</span><span class="p">;</span>
		<span class="n">gpio_port</span> <span class="o">=</span> <span class="n">bnx2x_get_gpio_port</span><span class="p">(</span><span class="n">params</span><span class="p">);</span>
		<span class="n">bnx2x_set_gpio</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">gpio_pin</span><span class="p">,</span> <span class="n">gpio_mode</span><span class="p">,</span> <span class="n">gpio_port</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="nl">default:</span>
		<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;Invalid TX_LASER_MDIO 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tx_en_mode</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_sfp_set_transmitter</span><span class="p">(</span><span class="k">struct</span> <span class="n">link_params</span> <span class="o">*</span><span class="n">params</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">bnx2x_phy</span> <span class="o">*</span><span class="n">phy</span><span class="p">,</span>
				      <span class="n">u8</span> <span class="n">tx_en</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">bp</span><span class="p">;</span>
	<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;Setting SFP+ transmitter to %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tx_en</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">CHIP_IS_E3</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span>
		<span class="n">bnx2x_sfp_e3_set_transmitter</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">tx_en</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">bnx2x_sfp_e1e2_set_transmitter</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">tx_en</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bnx2x_8726_read_sfp_module_eeprom</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x_phy</span> <span class="o">*</span><span class="n">phy</span><span class="p">,</span>
					     <span class="k">struct</span> <span class="n">link_params</span> <span class="o">*</span><span class="n">params</span><span class="p">,</span>
					     <span class="n">u16</span> <span class="n">addr</span><span class="p">,</span> <span class="n">u8</span> <span class="n">byte_cnt</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">o_buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">bp</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">byte_cnt</span> <span class="o">&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span>
		   <span class="s">&quot;Reading from eeprom is limited to 0xf</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* Set the read command byte count */</span>
	<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
			 <span class="n">MDIO_PMA_DEVAD</span><span class="p">,</span> <span class="n">MDIO_PMA_REG_SFP_TWO_WIRE_BYTE_CNT</span><span class="p">,</span>
			 <span class="p">(</span><span class="n">byte_cnt</span> <span class="o">|</span> <span class="mh">0xa000</span><span class="p">));</span>

	<span class="cm">/* Set the read command address */</span>
	<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
			 <span class="n">MDIO_PMA_DEVAD</span><span class="p">,</span> <span class="n">MDIO_PMA_REG_SFP_TWO_WIRE_MEM_ADDR</span><span class="p">,</span>
			 <span class="n">addr</span><span class="p">);</span>

	<span class="cm">/* Activate read command */</span>
	<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
			 <span class="n">MDIO_PMA_DEVAD</span><span class="p">,</span> <span class="n">MDIO_PMA_REG_SFP_TWO_WIRE_CTRL</span><span class="p">,</span>
			 <span class="mh">0x2c0f</span><span class="p">);</span>

	<span class="cm">/* Wait up to 500us for command complete status */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bnx2x_cl45_read</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
				<span class="n">MDIO_PMA_DEVAD</span><span class="p">,</span>
				<span class="n">MDIO_PMA_REG_SFP_TWO_WIRE_CTRL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">MDIO_PMA_REG_SFP_TWO_WIRE_CTRL_STATUS_MASK</span><span class="p">)</span> <span class="o">==</span>
		    <span class="n">MDIO_PMA_REG_SFP_TWO_WIRE_STATUS_COMPLETE</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">MDIO_PMA_REG_SFP_TWO_WIRE_CTRL_STATUS_MASK</span><span class="p">)</span> <span class="o">!=</span>
		    <span class="n">MDIO_PMA_REG_SFP_TWO_WIRE_STATUS_COMPLETE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span>
			 <span class="s">&quot;Got bad status 0x%x when reading from SFP+ EEPROM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">MDIO_PMA_REG_SFP_TWO_WIRE_CTRL_STATUS_MASK</span><span class="p">));</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Read the buffer */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">byte_cnt</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bnx2x_cl45_read</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
				<span class="n">MDIO_PMA_DEVAD</span><span class="p">,</span>
				<span class="n">MDIO_PMA_REG_8726_TWO_WIRE_DATA_BUF</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
		<span class="n">o_buf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">MDIO_PMA_REG_8726_TWO_WIRE_DATA_MASK</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bnx2x_cl45_read</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
				<span class="n">MDIO_PMA_DEVAD</span><span class="p">,</span>
				<span class="n">MDIO_PMA_REG_SFP_TWO_WIRE_CTRL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">MDIO_PMA_REG_SFP_TWO_WIRE_CTRL_STATUS_MASK</span><span class="p">)</span> <span class="o">==</span>
		    <span class="n">MDIO_PMA_REG_SFP_TWO_WIRE_STATUS_IDLE</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_warpcore_power_module</span><span class="p">(</span><span class="k">struct</span> <span class="n">link_params</span> <span class="o">*</span><span class="n">params</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">bnx2x_phy</span> <span class="o">*</span><span class="n">phy</span><span class="p">,</span>
					<span class="n">u8</span> <span class="n">power</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">pin_cfg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">bp</span><span class="p">;</span>

	<span class="n">pin_cfg</span> <span class="o">=</span> <span class="p">(</span><span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">shmem_base</span> <span class="o">+</span>
			  <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">shmem_region</span><span class="p">,</span>
			<span class="n">dev_info</span><span class="p">.</span><span class="n">port_hw_config</span><span class="p">[</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">].</span><span class="n">e3_sfp_ctrl</span><span class="p">))</span> <span class="o">&amp;</span>
			<span class="n">PORT_HW_CFG_E3_PWR_DIS_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span>
			<span class="n">PORT_HW_CFG_E3_PWR_DIS_SHIFT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pin_cfg</span> <span class="o">==</span> <span class="n">PIN_CFG_NA</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;Setting SFP+ module power to %d using pin cfg %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">power</span><span class="p">,</span> <span class="n">pin_cfg</span><span class="p">);</span>
	<span class="cm">/* Low ==&gt; corresponding SFP+ module is powered</span>
<span class="cm">	 * high ==&gt; the SFP+ module is powered down</span>
<span class="cm">	 */</span>
	<span class="n">bnx2x_set_cfg_pin</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">pin_cfg</span><span class="p">,</span> <span class="n">power</span> <span class="o">^</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">bnx2x_warpcore_read_sfp_module_eeprom</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x_phy</span> <span class="o">*</span><span class="n">phy</span><span class="p">,</span>
						 <span class="k">struct</span> <span class="n">link_params</span> <span class="o">*</span><span class="n">params</span><span class="p">,</span>
						 <span class="n">u16</span> <span class="n">addr</span><span class="p">,</span> <span class="n">u8</span> <span class="n">byte_cnt</span><span class="p">,</span>
						 <span class="n">u8</span> <span class="o">*</span><span class="n">o_buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">data_array</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="n">u16</span> <span class="n">addr32</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">bp</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">byte_cnt</span> <span class="o">&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span>
		   <span class="s">&quot;Reading from eeprom is limited to 16 bytes</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* 4 byte aligned address */</span>
	<span class="n">addr32</span> <span class="o">=</span> <span class="n">addr</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="mh">0x3</span><span class="p">);</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">==</span> <span class="n">I2C_WA_PWR_ITER</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">bnx2x_warpcore_power_module</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="cm">/* Note that 100us are not enough here */</span>
			<span class="n">usleep_range</span><span class="p">(</span><span class="mi">1000</span><span class="p">,</span><span class="mi">1000</span><span class="p">);</span>
			<span class="n">bnx2x_warpcore_power_module</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">bnx2x_bsc_read</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="mh">0xa0</span><span class="p">,</span> <span class="n">addr32</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">byte_cnt</span><span class="p">,</span>
				    <span class="n">data_array</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">((</span><span class="n">rc</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">++</span><span class="n">cnt</span> <span class="o">&lt;</span> <span class="n">I2C_WA_RETRY_CNT</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="p">(</span><span class="n">addr</span> <span class="o">-</span> <span class="n">addr32</span><span class="p">);</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">byte_cnt</span> <span class="o">+</span> <span class="p">(</span><span class="n">addr</span> <span class="o">-</span> <span class="n">addr32</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">o_buf</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="o">*</span><span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">data_array</span> <span class="o">+</span> <span class="n">i</span><span class="p">);</span>
			<span class="n">j</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bnx2x_8727_read_sfp_module_eeprom</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x_phy</span> <span class="o">*</span><span class="n">phy</span><span class="p">,</span>
					     <span class="k">struct</span> <span class="n">link_params</span> <span class="o">*</span><span class="n">params</span><span class="p">,</span>
					     <span class="n">u16</span> <span class="n">addr</span><span class="p">,</span> <span class="n">u8</span> <span class="n">byte_cnt</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">o_buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">bp</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">val</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">byte_cnt</span> <span class="o">&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span>
		   <span class="s">&quot;Reading from eeprom is limited to 0xf</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Need to read from 1.8000 to clear it */</span>
	<span class="n">bnx2x_cl45_read</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
			<span class="n">MDIO_PMA_DEVAD</span><span class="p">,</span>
			<span class="n">MDIO_PMA_REG_SFP_TWO_WIRE_CTRL</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>

	<span class="cm">/* Set the read command byte count */</span>
	<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
			 <span class="n">MDIO_PMA_DEVAD</span><span class="p">,</span>
			 <span class="n">MDIO_PMA_REG_SFP_TWO_WIRE_BYTE_CNT</span><span class="p">,</span>
			 <span class="p">((</span><span class="n">byte_cnt</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">?</span> <span class="mi">2</span> <span class="o">:</span> <span class="n">byte_cnt</span><span class="p">));</span>

	<span class="cm">/* Set the read command address */</span>
	<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
			 <span class="n">MDIO_PMA_DEVAD</span><span class="p">,</span>
			 <span class="n">MDIO_PMA_REG_SFP_TWO_WIRE_MEM_ADDR</span><span class="p">,</span>
			 <span class="n">addr</span><span class="p">);</span>
	<span class="cm">/* Set the destination address */</span>
	<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
			 <span class="n">MDIO_PMA_DEVAD</span><span class="p">,</span>
			 <span class="mh">0x8004</span><span class="p">,</span>
			 <span class="n">MDIO_PMA_REG_8727_TWO_WIRE_DATA_BUF</span><span class="p">);</span>

	<span class="cm">/* Activate read command */</span>
	<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
			 <span class="n">MDIO_PMA_DEVAD</span><span class="p">,</span>
			 <span class="n">MDIO_PMA_REG_SFP_TWO_WIRE_CTRL</span><span class="p">,</span>
			 <span class="mh">0x8002</span><span class="p">);</span>
	<span class="cm">/* Wait appropriate time for two-wire command to finish before</span>
<span class="cm">	 * polling the status register</span>
<span class="cm">	 */</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* Wait up to 500us for command complete status */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bnx2x_cl45_read</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
				<span class="n">MDIO_PMA_DEVAD</span><span class="p">,</span>
				<span class="n">MDIO_PMA_REG_SFP_TWO_WIRE_CTRL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">MDIO_PMA_REG_SFP_TWO_WIRE_CTRL_STATUS_MASK</span><span class="p">)</span> <span class="o">==</span>
		    <span class="n">MDIO_PMA_REG_SFP_TWO_WIRE_STATUS_COMPLETE</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">MDIO_PMA_REG_SFP_TWO_WIRE_CTRL_STATUS_MASK</span><span class="p">)</span> <span class="o">!=</span>
		    <span class="n">MDIO_PMA_REG_SFP_TWO_WIRE_STATUS_COMPLETE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span>
			 <span class="s">&quot;Got bad status 0x%x when reading from SFP+ EEPROM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">MDIO_PMA_REG_SFP_TWO_WIRE_CTRL_STATUS_MASK</span><span class="p">));</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Read the buffer */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">byte_cnt</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bnx2x_cl45_read</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
				<span class="n">MDIO_PMA_DEVAD</span><span class="p">,</span>
				<span class="n">MDIO_PMA_REG_8727_TWO_WIRE_DATA_BUF</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
		<span class="n">o_buf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">MDIO_PMA_REG_8727_TWO_WIRE_DATA_MASK</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bnx2x_cl45_read</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
				<span class="n">MDIO_PMA_DEVAD</span><span class="p">,</span>
				<span class="n">MDIO_PMA_REG_SFP_TWO_WIRE_CTRL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">MDIO_PMA_REG_SFP_TWO_WIRE_CTRL_STATUS_MASK</span><span class="p">)</span> <span class="o">==</span>
		    <span class="n">MDIO_PMA_REG_SFP_TWO_WIRE_STATUS_IDLE</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">bnx2x_read_sfp_module_eeprom</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x_phy</span> <span class="o">*</span><span class="n">phy</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">link_params</span> <span class="o">*</span><span class="n">params</span><span class="p">,</span> <span class="n">u16</span> <span class="n">addr</span><span class="p">,</span>
				 <span class="n">u8</span> <span class="n">byte_cnt</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">o_buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PORT_HW_CFG_XGXS_EXT_PHY_TYPE_BCM8726</span>:
		<span class="n">rc</span> <span class="o">=</span> <span class="n">bnx2x_8726_read_sfp_module_eeprom</span><span class="p">(</span><span class="n">phy</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span>
						       <span class="n">byte_cnt</span><span class="p">,</span> <span class="n">o_buf</span><span class="p">);</span>
	<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PORT_HW_CFG_XGXS_EXT_PHY_TYPE_BCM8727</span>:
	<span class="k">case</span> <span class="n">PORT_HW_CFG_XGXS_EXT_PHY_TYPE_BCM8722</span>:
		<span class="n">rc</span> <span class="o">=</span> <span class="n">bnx2x_8727_read_sfp_module_eeprom</span><span class="p">(</span><span class="n">phy</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span>
						       <span class="n">byte_cnt</span><span class="p">,</span> <span class="n">o_buf</span><span class="p">);</span>
	<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PORT_HW_CFG_XGXS_EXT_PHY_TYPE_DIRECT</span>:
		<span class="n">rc</span> <span class="o">=</span> <span class="n">bnx2x_warpcore_read_sfp_module_eeprom</span><span class="p">(</span><span class="n">phy</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span>
							   <span class="n">byte_cnt</span><span class="p">,</span> <span class="n">o_buf</span><span class="p">);</span>
	<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bnx2x_get_edc_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x_phy</span> <span class="o">*</span><span class="n">phy</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">link_params</span> <span class="o">*</span><span class="n">params</span><span class="p">,</span>
			      <span class="n">u16</span> <span class="o">*</span><span class="n">edc_mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">bp</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">sync_offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">phy_idx</span><span class="p">,</span> <span class="n">media_types</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">val</span><span class="p">,</span> <span class="n">check_limiting_mode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="o">*</span><span class="n">edc_mode</span> <span class="o">=</span> <span class="n">EDC_MODE_LIMITING</span><span class="p">;</span>

	<span class="n">phy</span><span class="o">-&gt;</span><span class="n">media_type</span> <span class="o">=</span> <span class="n">ETH_PHY_UNSPECIFIED</span><span class="p">;</span>
	<span class="cm">/* First check for copper cable */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bnx2x_read_sfp_module_eeprom</span><span class="p">(</span><span class="n">phy</span><span class="p">,</span>
					 <span class="n">params</span><span class="p">,</span>
					 <span class="n">SFP_EEPROM_CON_TYPE_ADDR</span><span class="p">,</span>
					 <span class="mi">1</span><span class="p">,</span>
					 <span class="o">&amp;</span><span class="n">val</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;Failed to read from SFP+ module EEPROM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SFP_EEPROM_CON_TYPE_VAL_COPPER</span>:
	<span class="p">{</span>
		<span class="n">u8</span> <span class="n">copper_module_type</span><span class="p">;</span>
		<span class="n">phy</span><span class="o">-&gt;</span><span class="n">media_type</span> <span class="o">=</span> <span class="n">ETH_PHY_DA_TWINAX</span><span class="p">;</span>
		<span class="cm">/* Check if its active cable (includes SFP+ module)</span>
<span class="cm">		 * of passive cable</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bnx2x_read_sfp_module_eeprom</span><span class="p">(</span><span class="n">phy</span><span class="p">,</span>
					       <span class="n">params</span><span class="p">,</span>
					       <span class="n">SFP_EEPROM_FC_TX_TECH_ADDR</span><span class="p">,</span>
					       <span class="mi">1</span><span class="p">,</span>
					       <span class="o">&amp;</span><span class="n">copper_module_type</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span>
				<span class="s">&quot;Failed to read copper-cable-type&quot;</span>
				<span class="s">&quot; from SFP+ EEPROM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">copper_module_type</span> <span class="o">&amp;</span>
		    <span class="n">SFP_EEPROM_FC_TX_TECH_BITMASK_COPPER_ACTIVE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;Active Copper cable detected</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">check_limiting_mode</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">copper_module_type</span> <span class="o">&amp;</span>
			<span class="n">SFP_EEPROM_FC_TX_TECH_BITMASK_COPPER_PASSIVE</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span>
				   <span class="s">&quot;Passive Copper cable detected</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="o">*</span><span class="n">edc_mode</span> <span class="o">=</span>
				      <span class="n">EDC_MODE_PASSIVE_DAC</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span>
			   <span class="s">&quot;Unknown copper-cable-type 0x%x !!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">copper_module_type</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">case</span> <span class="n">SFP_EEPROM_CON_TYPE_VAL_LC</span>:
		<span class="n">phy</span><span class="o">-&gt;</span><span class="n">media_type</span> <span class="o">=</span> <span class="n">ETH_PHY_SFP_FIBER</span><span class="p">;</span>
		<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;Optic module detected</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">check_limiting_mode</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;Unable to determine module type 0x%x !!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">val</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">sync_offset</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">shmem_base</span> <span class="o">+</span>
		<span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">shmem_region</span><span class="p">,</span>
			 <span class="n">dev_info</span><span class="p">.</span><span class="n">port_hw_config</span><span class="p">[</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">].</span><span class="n">media_type</span><span class="p">);</span>
	<span class="n">media_types</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">sync_offset</span><span class="p">);</span>
	<span class="cm">/* Update media type for non-PMF sync */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">phy_idx</span> <span class="o">=</span> <span class="n">INT_PHY</span><span class="p">;</span> <span class="n">phy_idx</span> <span class="o">&lt;</span> <span class="n">MAX_PHYS</span><span class="p">;</span> <span class="n">phy_idx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">[</span><span class="n">phy_idx</span><span class="p">])</span> <span class="o">==</span> <span class="n">phy</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">media_types</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">PORT_HW_CFG_MEDIA_TYPE_PHY0_MASK</span> <span class="o">&lt;&lt;</span>
				<span class="p">(</span><span class="n">PORT_HW_CFG_MEDIA_TYPE_PHY1_SHIFT</span> <span class="o">*</span> <span class="n">phy_idx</span><span class="p">));</span>
			<span class="n">media_types</span> <span class="o">|=</span> <span class="p">((</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">media_type</span> <span class="o">&amp;</span>
					<span class="n">PORT_HW_CFG_MEDIA_TYPE_PHY0_MASK</span><span class="p">)</span> <span class="o">&lt;&lt;</span>
				<span class="p">(</span><span class="n">PORT_HW_CFG_MEDIA_TYPE_PHY1_SHIFT</span> <span class="o">*</span> <span class="n">phy_idx</span><span class="p">));</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">sync_offset</span><span class="p">,</span> <span class="n">media_types</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">check_limiting_mode</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="n">options</span><span class="p">[</span><span class="n">SFP_EEPROM_OPTIONS_SIZE</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bnx2x_read_sfp_module_eeprom</span><span class="p">(</span><span class="n">phy</span><span class="p">,</span>
						 <span class="n">params</span><span class="p">,</span>
						 <span class="n">SFP_EEPROM_OPTIONS_ADDR</span><span class="p">,</span>
						 <span class="n">SFP_EEPROM_OPTIONS_SIZE</span><span class="p">,</span>
						 <span class="n">options</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span>
			   <span class="s">&quot;Failed to read Option field from module EEPROM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">options</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">SFP_EEPROM_OPTIONS_LINEAR_RX_OUT_MASK</span><span class="p">))</span>
			<span class="o">*</span><span class="n">edc_mode</span> <span class="o">=</span> <span class="n">EDC_MODE_LINEAR</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="o">*</span><span class="n">edc_mode</span> <span class="o">=</span> <span class="n">EDC_MODE_LIMITING</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;EDC mode is set to 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">edc_mode</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cm">/* This function read the relevant field from the module (SFP+), and verify it</span>
<span class="cm"> * is compliant with this board</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">bnx2x_verify_sfp_module</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x_phy</span> <span class="o">*</span><span class="n">phy</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">link_params</span> <span class="o">*</span><span class="n">params</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">bp</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">,</span> <span class="n">cmd</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">fw_resp</span><span class="p">,</span> <span class="n">fw_cmd_param</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">vendor_name</span><span class="p">[</span><span class="n">SFP_EEPROM_VENDOR_NAME_SIZE</span><span class="o">+</span><span class="mi">1</span><span class="p">];</span>
	<span class="kt">char</span> <span class="n">vendor_pn</span><span class="p">[</span><span class="n">SFP_EEPROM_PART_NO_SIZE</span><span class="o">+</span><span class="mi">1</span><span class="p">];</span>
	<span class="n">phy</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">FLAGS_SFP_NOT_APPROVED</span><span class="p">;</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">shmem_base</span> <span class="o">+</span>
			 <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">shmem_region</span><span class="p">,</span> <span class="n">dev_info</span><span class="p">.</span>
				  <span class="n">port_feature_config</span><span class="p">[</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">].</span><span class="n">config</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">PORT_FEAT_CFG_OPT_MDL_ENFRCMNT_MASK</span><span class="p">)</span> <span class="o">==</span>
	    <span class="n">PORT_FEAT_CFG_OPT_MDL_ENFRCMNT_NO_ENFORCEMENT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;NOT enforcing module verification</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">feature_config_flags</span> <span class="o">&amp;</span>
	    <span class="n">FEATURE_CONFIG_BC_SUPPORTS_DUAL_PHY_OPT_MDL_VRFY</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Use specific phy request */</span>
		<span class="n">cmd</span> <span class="o">=</span> <span class="n">DRV_MSG_CODE_VRFY_SPECIFIC_PHY_OPT_MDL</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">feature_config_flags</span> <span class="o">&amp;</span>
		   <span class="n">FEATURE_CONFIG_BC_SUPPORTS_OPT_MDL_VRFY</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Use first phy request only in case of non-dual media*/</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">DUAL_MEDIA</span><span class="p">(</span><span class="n">params</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span>
			   <span class="s">&quot;FW does not support OPT MDL verification</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">cmd</span> <span class="o">=</span> <span class="n">DRV_MSG_CODE_VRFY_FIRST_PHY_OPT_MDL</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* No support in OPT MDL detection */</span>
		<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span>
		   <span class="s">&quot;FW does not support OPT MDL verification</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">fw_cmd_param</span> <span class="o">=</span> <span class="n">FW_PARAM_SET</span><span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">,</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">mdio_ctrl</span><span class="p">);</span>
	<span class="n">fw_resp</span> <span class="o">=</span> <span class="n">bnx2x_fw_command</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">fw_cmd_param</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fw_resp</span> <span class="o">==</span> <span class="n">FW_MSG_CODE_VRFY_OPT_MDL_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;Approved module</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* format the warning message */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bnx2x_read_sfp_module_eeprom</span><span class="p">(</span><span class="n">phy</span><span class="p">,</span>
					 <span class="n">params</span><span class="p">,</span>
					 <span class="n">SFP_EEPROM_VENDOR_NAME_ADDR</span><span class="p">,</span>
					 <span class="n">SFP_EEPROM_VENDOR_NAME_SIZE</span><span class="p">,</span>
					 <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">vendor_name</span><span class="p">))</span>
		<span class="n">vendor_name</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">vendor_name</span><span class="p">[</span><span class="n">SFP_EEPROM_VENDOR_NAME_SIZE</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bnx2x_read_sfp_module_eeprom</span><span class="p">(</span><span class="n">phy</span><span class="p">,</span>
					 <span class="n">params</span><span class="p">,</span>
					 <span class="n">SFP_EEPROM_PART_NO_ADDR</span><span class="p">,</span>
					 <span class="n">SFP_EEPROM_PART_NO_SIZE</span><span class="p">,</span>
					 <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">vendor_pn</span><span class="p">))</span>
		<span class="n">vendor_pn</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">vendor_pn</span><span class="p">[</span><span class="n">SFP_EEPROM_PART_NO_SIZE</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>

	<span class="n">netdev_err</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>  <span class="s">&quot;Warning: Unqualified SFP+ module detected,&quot;</span>
			      <span class="s">&quot; Port %d from %s part number %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">params</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span> <span class="n">vendor_name</span><span class="p">,</span> <span class="n">vendor_pn</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">PORT_FEAT_CFG_OPT_MDL_ENFRCMNT_MASK</span><span class="p">)</span> <span class="o">!=</span>
	    <span class="n">PORT_FEAT_CFG_OPT_MDL_ENFRCMNT_WARNING_MSG</span><span class="p">)</span>
		<span class="n">phy</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">FLAGS_SFP_NOT_APPROVED</span><span class="p">;</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bnx2x_wait_for_sfp_module_initialized</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x_phy</span> <span class="o">*</span><span class="n">phy</span><span class="p">,</span>
						 <span class="k">struct</span> <span class="n">link_params</span> <span class="o">*</span><span class="n">params</span><span class="p">)</span>

<span class="p">{</span>
	<span class="n">u8</span> <span class="n">val</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">bp</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">timeout</span><span class="p">;</span>
	<span class="cm">/* Initialization time after hot-plug may take up to 300ms for</span>
<span class="cm">	 * some phys type ( e.g. JDSU )</span>
<span class="cm">	 */</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">timeout</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">timeout</span> <span class="o">&lt;</span> <span class="mi">60</span><span class="p">;</span> <span class="n">timeout</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bnx2x_read_sfp_module_eeprom</span><span class="p">(</span><span class="n">phy</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">)</span>
		    <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span>
			   <span class="s">&quot;SFP+ module initialization took %d ms</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">timeout</span> <span class="o">*</span> <span class="mi">5</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_8727_power_module</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">bnx2x_phy</span> <span class="o">*</span><span class="n">phy</span><span class="p">,</span>
				    <span class="n">u8</span> <span class="n">is_power_up</span><span class="p">)</span> <span class="p">{</span>
	<span class="cm">/* Make sure GPIOs are not using for LED mode */</span>
	<span class="n">u16</span> <span class="n">val</span><span class="p">;</span>
	<span class="cm">/* In the GPIO register, bit 4 is use to determine if the GPIOs are</span>
<span class="cm">	 * operating as INPUT or as OUTPUT. Bit 1 is for input, and 0 for</span>
<span class="cm">	 * output</span>
<span class="cm">	 * Bits 0-1 determine the GPIOs value for OUTPUT in case bit 4 val is 0</span>
<span class="cm">	 * Bits 8-9 determine the GPIOs value for INPUT in case bit 4 val is 1</span>
<span class="cm">	 * where the 1st bit is the over-current(only input), and 2nd bit is</span>
<span class="cm">	 * for power( only output )</span>
<span class="cm">	 *</span>
<span class="cm">	 * In case of NOC feature is disabled and power is up, set GPIO control</span>
<span class="cm">	 *  as input to enable listening of over-current indication</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">FLAGS_NOC</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is_power_up</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">4</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="cm">/* Set GPIO control to OUTPUT, and set the power bit</span>
<span class="cm">		 * to according to the is_power_up</span>
<span class="cm">		 */</span>
		<span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">1</span><span class="p">);</span>

	<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
			 <span class="n">MDIO_PMA_DEVAD</span><span class="p">,</span>
			 <span class="n">MDIO_PMA_REG_8727_GPIO_CTRL</span><span class="p">,</span>
			 <span class="n">val</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bnx2x_8726_set_limiting_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">bnx2x_phy</span> <span class="o">*</span><span class="n">phy</span><span class="p">,</span>
					<span class="n">u16</span> <span class="n">edc_mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">cur_limiting_mode</span><span class="p">;</span>

	<span class="n">bnx2x_cl45_read</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
			<span class="n">MDIO_PMA_DEVAD</span><span class="p">,</span>
			<span class="n">MDIO_PMA_REG_ROM_VER2</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">cur_limiting_mode</span><span class="p">);</span>
	<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;Current Limiting mode is 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">cur_limiting_mode</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">edc_mode</span> <span class="o">==</span> <span class="n">EDC_MODE_LIMITING</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;Setting LIMITING MODE</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
				 <span class="n">MDIO_PMA_DEVAD</span><span class="p">,</span>
				 <span class="n">MDIO_PMA_REG_ROM_VER2</span><span class="p">,</span>
				 <span class="n">EDC_MODE_LIMITING</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="cm">/* LRM mode ( default )*/</span>

		<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;Setting LRM MODE</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="cm">/* Changing to LRM mode takes quite few seconds. So do it only</span>
<span class="cm">		 * if current mode is limiting (default is LRM)</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cur_limiting_mode</span> <span class="o">!=</span> <span class="n">EDC_MODE_LIMITING</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
				 <span class="n">MDIO_PMA_DEVAD</span><span class="p">,</span>
				 <span class="n">MDIO_PMA_REG_LRM_MODE</span><span class="p">,</span>
				 <span class="mi">0</span><span class="p">);</span>
		<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
				 <span class="n">MDIO_PMA_DEVAD</span><span class="p">,</span>
				 <span class="n">MDIO_PMA_REG_ROM_VER2</span><span class="p">,</span>
				 <span class="mh">0x128</span><span class="p">);</span>
		<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
				 <span class="n">MDIO_PMA_DEVAD</span><span class="p">,</span>
				 <span class="n">MDIO_PMA_REG_MISC_CTRL0</span><span class="p">,</span>
				 <span class="mh">0x4008</span><span class="p">);</span>
		<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
				 <span class="n">MDIO_PMA_DEVAD</span><span class="p">,</span>
				 <span class="n">MDIO_PMA_REG_LRM_MODE</span><span class="p">,</span>
				 <span class="mh">0xaaaa</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bnx2x_8727_set_limiting_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">bnx2x_phy</span> <span class="o">*</span><span class="n">phy</span><span class="p">,</span>
					<span class="n">u16</span> <span class="n">edc_mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">phy_identifier</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">rom_ver2_val</span><span class="p">;</span>
	<span class="n">bnx2x_cl45_read</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
			<span class="n">MDIO_PMA_DEVAD</span><span class="p">,</span>
			<span class="n">MDIO_PMA_REG_PHY_IDENTIFIER</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">phy_identifier</span><span class="p">);</span>

	<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
			 <span class="n">MDIO_PMA_DEVAD</span><span class="p">,</span>
			 <span class="n">MDIO_PMA_REG_PHY_IDENTIFIER</span><span class="p">,</span>
			 <span class="p">(</span><span class="n">phy_identifier</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">9</span><span class="p">)));</span>

	<span class="n">bnx2x_cl45_read</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
			<span class="n">MDIO_PMA_DEVAD</span><span class="p">,</span>
			<span class="n">MDIO_PMA_REG_ROM_VER2</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">rom_ver2_val</span><span class="p">);</span>
	<span class="cm">/* Keep the MSB 8-bits, and set the LSB 8-bits with the edc_mode */</span>
	<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
			 <span class="n">MDIO_PMA_DEVAD</span><span class="p">,</span>
			 <span class="n">MDIO_PMA_REG_ROM_VER2</span><span class="p">,</span>
			 <span class="p">(</span><span class="n">rom_ver2_val</span> <span class="o">&amp;</span> <span class="mh">0xff00</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">edc_mode</span> <span class="o">&amp;</span> <span class="mh">0x00ff</span><span class="p">));</span>

	<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
			 <span class="n">MDIO_PMA_DEVAD</span><span class="p">,</span>
			 <span class="n">MDIO_PMA_REG_PHY_IDENTIFIER</span><span class="p">,</span>
			 <span class="p">(</span><span class="n">phy_identifier</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">9</span><span class="p">)));</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_8727_specific_func</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x_phy</span> <span class="o">*</span><span class="n">phy</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">link_params</span> <span class="o">*</span><span class="n">params</span><span class="p">,</span>
				     <span class="n">u32</span> <span class="n">action</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">bp</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">action</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">DISABLE_TX</span>:
		<span class="n">bnx2x_sfp_set_transmitter</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ENABLE_TX</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">FLAGS_SFP_NOT_APPROVED</span><span class="p">))</span>
			<span class="n">bnx2x_sfp_set_transmitter</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;Function 0x%x not supported by 8727</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">action</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_set_e1e2_module_fault_led</span><span class="p">(</span><span class="k">struct</span> <span class="n">link_params</span> <span class="o">*</span><span class="n">params</span><span class="p">,</span>
					   <span class="n">u8</span> <span class="n">gpio_mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">bp</span><span class="p">;</span>

	<span class="n">u32</span> <span class="n">fault_led_gpio</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">shmem_base</span> <span class="o">+</span>
			    <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">shmem_region</span><span class="p">,</span>
			<span class="n">dev_info</span><span class="p">.</span><span class="n">port_hw_config</span><span class="p">[</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">].</span><span class="n">sfp_ctrl</span><span class="p">))</span> <span class="o">&amp;</span>
		<span class="n">PORT_HW_CFG_FAULT_MODULE_LED_MASK</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">fault_led_gpio</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PORT_HW_CFG_FAULT_MODULE_LED_DISABLED</span>:
		<span class="k">return</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PORT_HW_CFG_FAULT_MODULE_LED_GPIO0</span>:
	<span class="k">case</span> <span class="n">PORT_HW_CFG_FAULT_MODULE_LED_GPIO1</span>:
	<span class="k">case</span> <span class="n">PORT_HW_CFG_FAULT_MODULE_LED_GPIO2</span>:
	<span class="k">case</span> <span class="n">PORT_HW_CFG_FAULT_MODULE_LED_GPIO3</span>:
	<span class="p">{</span>
		<span class="n">u8</span> <span class="n">gpio_port</span> <span class="o">=</span> <span class="n">bnx2x_get_gpio_port</span><span class="p">(</span><span class="n">params</span><span class="p">);</span>
		<span class="n">u16</span> <span class="n">gpio_pin</span> <span class="o">=</span> <span class="n">fault_led_gpio</span> <span class="o">-</span>
			<span class="n">PORT_HW_CFG_FAULT_MODULE_LED_GPIO0</span><span class="p">;</span>
		<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;Set fault module-detected led &quot;</span>
				   <span class="s">&quot;pin %x port %x mode %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">gpio_pin</span><span class="p">,</span> <span class="n">gpio_port</span><span class="p">,</span> <span class="n">gpio_mode</span><span class="p">);</span>
		<span class="n">bnx2x_set_gpio</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">gpio_pin</span><span class="p">,</span> <span class="n">gpio_mode</span><span class="p">,</span> <span class="n">gpio_port</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;Error: Invalid fault led mode 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">fault_led_gpio</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_set_e3_module_fault_led</span><span class="p">(</span><span class="k">struct</span> <span class="n">link_params</span> <span class="o">*</span><span class="n">params</span><span class="p">,</span>
					  <span class="n">u8</span> <span class="n">gpio_mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">pin_cfg</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">port</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">bp</span><span class="p">;</span>
	<span class="n">pin_cfg</span> <span class="o">=</span> <span class="p">(</span><span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">shmem_base</span> <span class="o">+</span>
			 <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">shmem_region</span><span class="p">,</span>
				  <span class="n">dev_info</span><span class="p">.</span><span class="n">port_hw_config</span><span class="p">[</span><span class="n">port</span><span class="p">].</span><span class="n">e3_sfp_ctrl</span><span class="p">))</span> <span class="o">&amp;</span>
		<span class="n">PORT_HW_CFG_E3_FAULT_MDL_LED_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span>
		<span class="n">PORT_HW_CFG_E3_FAULT_MDL_LED_SHIFT</span><span class="p">;</span>
	<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;Setting Fault LED to %d using pin cfg %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">gpio_mode</span><span class="p">,</span> <span class="n">pin_cfg</span><span class="p">);</span>
	<span class="n">bnx2x_set_cfg_pin</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">pin_cfg</span><span class="p">,</span> <span class="n">gpio_mode</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_set_sfp_module_fault_led</span><span class="p">(</span><span class="k">struct</span> <span class="n">link_params</span> <span class="o">*</span><span class="n">params</span><span class="p">,</span>
					   <span class="n">u8</span> <span class="n">gpio_mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">bp</span><span class="p">;</span>
	<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;Setting SFP+ module fault LED to %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">gpio_mode</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">CHIP_IS_E3</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Low ==&gt; if SFP+ module is supported otherwise</span>
<span class="cm">		 * High ==&gt; if SFP+ module is not on the approved vendor list</span>
<span class="cm">		 */</span>
		<span class="n">bnx2x_set_e3_module_fault_led</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">gpio_mode</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">bnx2x_set_e1e2_module_fault_led</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">gpio_mode</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_warpcore_hw_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x_phy</span> <span class="o">*</span><span class="n">phy</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">link_params</span> <span class="o">*</span><span class="n">params</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">bp</span><span class="p">;</span>
	<span class="n">bnx2x_warpcore_power_module</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="cm">/* Put Warpcore in low power mode */</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">MISC_REG_WC0_RESET</span><span class="p">,</span> <span class="mh">0x0c0e</span><span class="p">);</span>

	<span class="cm">/* Put LCPLL in low power mode */</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">MISC_REG_LCPLL_E40_PWRDWN</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">MISC_REG_LCPLL_E40_RESETB_ANA</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">MISC_REG_LCPLL_E40_RESETB_DIG</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_power_sfp_module</span><span class="p">(</span><span class="k">struct</span> <span class="n">link_params</span> <span class="o">*</span><span class="n">params</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">bnx2x_phy</span> <span class="o">*</span><span class="n">phy</span><span class="p">,</span>
				   <span class="n">u8</span> <span class="n">power</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">bp</span><span class="p">;</span>
	<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;Setting SFP+ power to %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">power</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PORT_HW_CFG_XGXS_EXT_PHY_TYPE_BCM8727</span>:
	<span class="k">case</span> <span class="n">PORT_HW_CFG_XGXS_EXT_PHY_TYPE_BCM8722</span>:
		<span class="n">bnx2x_8727_power_module</span><span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">power</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PORT_HW_CFG_XGXS_EXT_PHY_TYPE_DIRECT</span>:
		<span class="n">bnx2x_warpcore_power_module</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">power</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_warpcore_set_limiting_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">link_params</span> <span class="o">*</span><span class="n">params</span><span class="p">,</span>
					     <span class="k">struct</span> <span class="n">bnx2x_phy</span> <span class="o">*</span><span class="n">phy</span><span class="p">,</span>
					     <span class="n">u16</span> <span class="n">edc_mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">mode</span> <span class="o">=</span> <span class="n">MDIO_WC_REG_UC_INFO_B1_FIRMWARE_MODE_DEFAULT</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">bp</span><span class="p">;</span>

	<span class="n">u8</span> <span class="n">lane</span> <span class="o">=</span> <span class="n">bnx2x_get_warpcore_lane</span><span class="p">(</span><span class="n">phy</span><span class="p">,</span> <span class="n">params</span><span class="p">);</span>
	<span class="cm">/* This is a global register which controls all lanes */</span>
	<span class="n">bnx2x_cl45_read</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_WC_DEVAD</span><span class="p">,</span>
			<span class="n">MDIO_WC_REG_UC_INFO_B1_FIRMWARE_MODE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mh">0xf</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">lane</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">));</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">edc_mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">EDC_MODE_LINEAR</span>:
	<span class="k">case</span> <span class="n">EDC_MODE_LIMITING</span>:
		<span class="n">mode</span> <span class="o">=</span> <span class="n">MDIO_WC_REG_UC_INFO_B1_FIRMWARE_MODE_DEFAULT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">EDC_MODE_PASSIVE_DAC</span>:
		<span class="n">mode</span> <span class="o">=</span> <span class="n">MDIO_WC_REG_UC_INFO_B1_FIRMWARE_MODE_SFP_DAC</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">val</span> <span class="o">|=</span> <span class="p">(</span><span class="n">mode</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">lane</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">));</span>
	<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_WC_DEVAD</span><span class="p">,</span>
			 <span class="n">MDIO_WC_REG_UC_INFO_B1_FIRMWARE_MODE</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="cm">/* A must read */</span>
	<span class="n">bnx2x_cl45_read</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_WC_DEVAD</span><span class="p">,</span>
			<span class="n">MDIO_WC_REG_UC_INFO_B1_FIRMWARE_MODE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>

	<span class="cm">/* Restart microcode to re-read the new mode */</span>
	<span class="n">bnx2x_warpcore_reset_lane</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">bnx2x_warpcore_reset_lane</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_set_limiting_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">link_params</span> <span class="o">*</span><span class="n">params</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">bnx2x_phy</span> <span class="o">*</span><span class="n">phy</span><span class="p">,</span>
				    <span class="n">u16</span> <span class="n">edc_mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PORT_HW_CFG_XGXS_EXT_PHY_TYPE_BCM8726</span>:
		<span class="n">bnx2x_8726_set_limiting_mode</span><span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">edc_mode</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PORT_HW_CFG_XGXS_EXT_PHY_TYPE_BCM8727</span>:
	<span class="k">case</span> <span class="n">PORT_HW_CFG_XGXS_EXT_PHY_TYPE_BCM8722</span>:
		<span class="n">bnx2x_8727_set_limiting_mode</span><span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">edc_mode</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PORT_HW_CFG_XGXS_EXT_PHY_TYPE_DIRECT</span>:
		<span class="n">bnx2x_warpcore_set_limiting_mode</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">edc_mode</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">bnx2x_sfp_module_detection</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x_phy</span> <span class="o">*</span><span class="n">phy</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">link_params</span> <span class="o">*</span><span class="n">params</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">bp</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">edc_mode</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">u32</span> <span class="n">val</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">shmem_base</span> <span class="o">+</span>
			     <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">shmem_region</span><span class="p">,</span> <span class="n">dev_info</span><span class="p">.</span>
				     <span class="n">port_feature_config</span><span class="p">[</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">].</span><span class="n">config</span><span class="p">));</span>

	<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;SFP+ module plugged in/out detected on port %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">params</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">);</span>
	<span class="cm">/* Power up module */</span>
	<span class="n">bnx2x_power_sfp_module</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bnx2x_get_edc_mode</span><span class="p">(</span><span class="n">phy</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">edc_mode</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;Failed to get valid module type</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">bnx2x_verify_sfp_module</span><span class="p">(</span><span class="n">phy</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* check SFP+ module compatibility */</span>
		<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;Module verification failed!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="cm">/* Turn on fault module-detected led */</span>
		<span class="n">bnx2x_set_sfp_module_fault_led</span><span class="p">(</span><span class="n">params</span><span class="p">,</span>
					       <span class="n">MISC_REGISTERS_GPIO_HIGH</span><span class="p">);</span>

		<span class="cm">/* Check if need to power down the SFP+ module */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">PORT_FEAT_CFG_OPT_MDL_ENFRCMNT_MASK</span><span class="p">)</span> <span class="o">==</span>
		     <span class="n">PORT_FEAT_CFG_OPT_MDL_ENFRCMNT_POWER_DOWN</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;Shutdown SFP+ module!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">bnx2x_power_sfp_module</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Turn off fault module-detected led */</span>
		<span class="n">bnx2x_set_sfp_module_fault_led</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">MISC_REGISTERS_GPIO_LOW</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Check and set limiting mode / LRM mode on 8726. On 8727 it</span>
<span class="cm">	 * is done automatically</span>
<span class="cm">	 */</span>
	<span class="n">bnx2x_set_limiting_mode</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">edc_mode</span><span class="p">);</span>

	<span class="cm">/* Enable transmit for this module if the module is approved, or</span>
<span class="cm">	 * if unapproved modules should also enable the Tx laser</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">PORT_FEAT_CFG_OPT_MDL_ENFRCMNT_MASK</span><span class="p">)</span> <span class="o">!=</span>
	    <span class="n">PORT_FEAT_CFG_OPT_MDL_ENFRCMNT_DISABLE_TX_LASER</span><span class="p">)</span>
		<span class="n">bnx2x_sfp_set_transmitter</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">bnx2x_sfp_set_transmitter</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">bnx2x_handle_module_detect_int</span><span class="p">(</span><span class="k">struct</span> <span class="n">link_params</span> <span class="o">*</span><span class="n">params</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">bp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bnx2x_phy</span> <span class="o">*</span><span class="n">phy</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">gpio_val</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">gpio_num</span><span class="p">,</span> <span class="n">gpio_port</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">CHIP_IS_E3</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span>
		<span class="n">phy</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">[</span><span class="n">INT_PHY</span><span class="p">];</span>
	<span class="k">else</span>
		<span class="n">phy</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">[</span><span class="n">EXT_PHY1</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bnx2x_get_mod_abs_int_cfg</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">chip_id</span><span class="p">,</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">shmem_base</span><span class="p">,</span>
				      <span class="n">params</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gpio_num</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gpio_port</span><span class="p">)</span> <span class="o">==</span>
	    <span class="o">-</span><span class="n">EINVAL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;Failed to get MOD_ABS interrupt config</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Set valid module led off */</span>
	<span class="n">bnx2x_set_sfp_module_fault_led</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">MISC_REGISTERS_GPIO_HIGH</span><span class="p">);</span>

	<span class="cm">/* Get current gpio val reflecting module plugged in / out*/</span>
	<span class="n">gpio_val</span> <span class="o">=</span> <span class="n">bnx2x_get_gpio</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">gpio_num</span><span class="p">,</span> <span class="n">gpio_port</span><span class="p">);</span>

	<span class="cm">/* Call the handling function in case module is detected */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">gpio_val</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bnx2x_power_sfp_module</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">bnx2x_set_gpio_int</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">gpio_num</span><span class="p">,</span>
				   <span class="n">MISC_REGISTERS_GPIO_INT_OUTPUT_CLR</span><span class="p">,</span>
				   <span class="n">gpio_port</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bnx2x_wait_for_sfp_module_initialized</span><span class="p">(</span><span class="n">phy</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">bnx2x_sfp_module_detection</span><span class="p">(</span><span class="n">phy</span><span class="p">,</span> <span class="n">params</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;SFP+ module is not initialized</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">val</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">shmem_base</span> <span class="o">+</span>
				 <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">shmem_region</span><span class="p">,</span> <span class="n">dev_info</span><span class="p">.</span>
					  <span class="n">port_feature_config</span><span class="p">[</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">].</span>
					  <span class="n">config</span><span class="p">));</span>
		<span class="n">bnx2x_set_gpio_int</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">gpio_num</span><span class="p">,</span>
				   <span class="n">MISC_REGISTERS_GPIO_INT_OUTPUT_SET</span><span class="p">,</span>
				   <span class="n">gpio_port</span><span class="p">);</span>
		<span class="cm">/* Module was plugged out.</span>
<span class="cm">		 * Disable transmit for this module</span>
<span class="cm">		 */</span>
		<span class="n">phy</span><span class="o">-&gt;</span><span class="n">media_type</span> <span class="o">=</span> <span class="n">ETH_PHY_NOT_PRESENT</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(((</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">PORT_FEAT_CFG_OPT_MDL_ENFRCMNT_MASK</span><span class="p">)</span> <span class="o">==</span>
		     <span class="n">PORT_FEAT_CFG_OPT_MDL_ENFRCMNT_DISABLE_TX_LASER</span><span class="p">)</span> <span class="o">||</span>
		    <span class="n">CHIP_IS_E3</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span>
			<span class="n">bnx2x_sfp_set_transmitter</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/******************************************************************/</span>
<span class="cm">/*		Used by 8706 and 8727                             */</span>
<span class="cm">/******************************************************************/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_sfp_mask_fault</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">bnx2x_phy</span> <span class="o">*</span><span class="n">phy</span><span class="p">,</span>
				 <span class="n">u16</span> <span class="n">alarm_status_offset</span><span class="p">,</span>
				 <span class="n">u16</span> <span class="n">alarm_ctrl_offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">alarm_status</span><span class="p">,</span> <span class="n">val</span><span class="p">;</span>
	<span class="n">bnx2x_cl45_read</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
			<span class="n">MDIO_PMA_DEVAD</span><span class="p">,</span> <span class="n">alarm_status_offset</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">alarm_status</span><span class="p">);</span>
	<span class="n">bnx2x_cl45_read</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
			<span class="n">MDIO_PMA_DEVAD</span><span class="p">,</span> <span class="n">alarm_status_offset</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">alarm_status</span><span class="p">);</span>
	<span class="cm">/* Mask or enable the fault event. */</span>
	<span class="n">bnx2x_cl45_read</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_PMA_DEVAD</span><span class="p">,</span> <span class="n">alarm_ctrl_offset</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">alarm_status</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">0</span><span class="p">))</span>
		<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">0</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">0</span><span class="p">);</span>
	<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_PMA_DEVAD</span><span class="p">,</span> <span class="n">alarm_ctrl_offset</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
<span class="p">}</span>
<span class="cm">/******************************************************************/</span>
<span class="cm">/*		common BCM8706/BCM8726 PHY SECTION		  */</span>
<span class="cm">/******************************************************************/</span>
<span class="k">static</span> <span class="n">u8</span> <span class="nf">bnx2x_8706_8726_read_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x_phy</span> <span class="o">*</span><span class="n">phy</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">link_params</span> <span class="o">*</span><span class="n">params</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">link_vars</span> <span class="o">*</span><span class="n">vars</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">link_up</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">val1</span><span class="p">,</span> <span class="n">val2</span><span class="p">,</span> <span class="n">rx_sd</span><span class="p">,</span> <span class="n">pcs_status</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">bp</span><span class="p">;</span>
	<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;XGXS 8706/8726</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="cm">/* Clear RX Alarm*/</span>
	<span class="n">bnx2x_cl45_read</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
			<span class="n">MDIO_PMA_DEVAD</span><span class="p">,</span> <span class="n">MDIO_PMA_LASI_RXSTAT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val2</span><span class="p">);</span>

	<span class="n">bnx2x_sfp_mask_fault</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_PMA_LASI_TXSTAT</span><span class="p">,</span>
			     <span class="n">MDIO_PMA_LASI_TXCTRL</span><span class="p">);</span>

	<span class="cm">/* clear LASI indication*/</span>
	<span class="n">bnx2x_cl45_read</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
			<span class="n">MDIO_PMA_DEVAD</span><span class="p">,</span> <span class="n">MDIO_PMA_LASI_STAT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val1</span><span class="p">);</span>
	<span class="n">bnx2x_cl45_read</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
			<span class="n">MDIO_PMA_DEVAD</span><span class="p">,</span> <span class="n">MDIO_PMA_LASI_STAT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val2</span><span class="p">);</span>
	<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;8706/8726 LASI status 0x%x--&gt; 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">val1</span><span class="p">,</span> <span class="n">val2</span><span class="p">);</span>

	<span class="n">bnx2x_cl45_read</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
			<span class="n">MDIO_PMA_DEVAD</span><span class="p">,</span> <span class="n">MDIO_PMA_REG_RX_SD</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rx_sd</span><span class="p">);</span>
	<span class="n">bnx2x_cl45_read</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
			<span class="n">MDIO_PCS_DEVAD</span><span class="p">,</span> <span class="n">MDIO_PCS_REG_STATUS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pcs_status</span><span class="p">);</span>
	<span class="n">bnx2x_cl45_read</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
			<span class="n">MDIO_AN_DEVAD</span><span class="p">,</span> <span class="n">MDIO_AN_REG_LINK_STATUS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val2</span><span class="p">);</span>
	<span class="n">bnx2x_cl45_read</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
			<span class="n">MDIO_AN_DEVAD</span><span class="p">,</span> <span class="n">MDIO_AN_REG_LINK_STATUS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val2</span><span class="p">);</span>

	<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;8706/8726 rx_sd 0x%x pcs_status 0x%x 1Gbps&quot;</span>
			<span class="s">&quot; link_status 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rx_sd</span><span class="p">,</span> <span class="n">pcs_status</span><span class="p">,</span> <span class="n">val2</span><span class="p">);</span>
	<span class="cm">/* Link is up if both bit 0 of pmd_rx_sd and bit 0 of pcs_status</span>
<span class="cm">	 * are set, or if the autoneg bit 1 is set</span>
<span class="cm">	 */</span>
	<span class="n">link_up</span> <span class="o">=</span> <span class="p">((</span><span class="n">rx_sd</span> <span class="o">&amp;</span> <span class="n">pcs_status</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">val2</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">1</span><span class="p">)));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">link_up</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">val2</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">1</span><span class="p">))</span>
			<span class="n">vars</span><span class="o">-&gt;</span><span class="n">line_speed</span> <span class="o">=</span> <span class="n">SPEED_1000</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">vars</span><span class="o">-&gt;</span><span class="n">line_speed</span> <span class="o">=</span> <span class="n">SPEED_10000</span><span class="p">;</span>
		<span class="n">bnx2x_ext_phy_resolve_fc</span><span class="p">(</span><span class="n">phy</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">vars</span><span class="p">);</span>
		<span class="n">vars</span><span class="o">-&gt;</span><span class="n">duplex</span> <span class="o">=</span> <span class="n">DUPLEX_FULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Capture 10G link fault. Read twice to clear stale value. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vars</span><span class="o">-&gt;</span><span class="n">line_speed</span> <span class="o">==</span> <span class="n">SPEED_10000</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bnx2x_cl45_read</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_PMA_DEVAD</span><span class="p">,</span>
			    <span class="n">MDIO_PMA_LASI_TXSTAT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val1</span><span class="p">);</span>
		<span class="n">bnx2x_cl45_read</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_PMA_DEVAD</span><span class="p">,</span>
			    <span class="n">MDIO_PMA_LASI_TXSTAT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">val1</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">0</span><span class="p">))</span>
			<span class="n">vars</span><span class="o">-&gt;</span><span class="n">fault_detected</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">link_up</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/******************************************************************/</span>
<span class="cm">/*			BCM8706 PHY SECTION			  */</span>
<span class="cm">/******************************************************************/</span>
<span class="k">static</span> <span class="n">u8</span> <span class="nf">bnx2x_8706_config_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x_phy</span> <span class="o">*</span><span class="n">phy</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">link_params</span> <span class="o">*</span><span class="n">params</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">link_vars</span> <span class="o">*</span><span class="n">vars</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">tx_en_mode</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">cnt</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">tmp1</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">bp</span><span class="p">;</span>

	<span class="n">bnx2x_set_gpio</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">MISC_REGISTERS_GPIO_2</span><span class="p">,</span>
		       <span class="n">MISC_REGISTERS_GPIO_OUTPUT_HIGH</span><span class="p">,</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">);</span>
	<span class="cm">/* HW reset */</span>
	<span class="n">bnx2x_ext_phy_hw_reset</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">);</span>
	<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_PMA_DEVAD</span><span class="p">,</span> <span class="n">MDIO_PMA_REG_CTRL</span><span class="p">,</span> <span class="mh">0xa040</span><span class="p">);</span>
	<span class="n">bnx2x_wait_reset_complete</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">params</span><span class="p">);</span>

	<span class="cm">/* Wait until fw is loaded */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">cnt</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">;</span> <span class="n">cnt</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bnx2x_cl45_read</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
				<span class="n">MDIO_PMA_DEVAD</span><span class="p">,</span> <span class="n">MDIO_PMA_REG_ROM_VER1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">val</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;XGXS 8706 is initialized after %d ms</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cnt</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">feature_config_flags</span> <span class="o">&amp;</span>
	     <span class="n">FEATURE_CONFIG_OVERRIDE_PREEMPHASIS_ENABLED</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">u16</span> <span class="n">reg</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">reg</span> <span class="o">=</span> <span class="n">MDIO_XS_8706_REG_BANK_RX0</span> <span class="o">+</span>
				<span class="n">i</span><span class="o">*</span><span class="p">(</span><span class="n">MDIO_XS_8706_REG_BANK_RX1</span> <span class="o">-</span>
				   <span class="n">MDIO_XS_8706_REG_BANK_RX0</span><span class="p">);</span>
			<span class="n">bnx2x_cl45_read</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_XS_DEVAD</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
			<span class="cm">/* Clear first 3 bits of the control */</span>
			<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x7</span><span class="p">;</span>
			<span class="cm">/* Set control bits according to configuration */</span>
			<span class="n">val</span> <span class="o">|=</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">rx_preemphasis</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x7</span><span class="p">);</span>
			<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;Setting RX Equalizer to BCM8706&quot;</span>
				   <span class="s">&quot; reg 0x%x &lt;-- val 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
			<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_XS_DEVAD</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="cm">/* Force speed */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">req_line_speed</span> <span class="o">==</span> <span class="n">SPEED_10000</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;XGXS 8706 force 10Gbps</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
				 <span class="n">MDIO_PMA_DEVAD</span><span class="p">,</span>
				 <span class="n">MDIO_PMA_REG_DIGITAL_CTRL</span><span class="p">,</span> <span class="mh">0x400</span><span class="p">);</span>
		<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
				 <span class="n">MDIO_PMA_DEVAD</span><span class="p">,</span> <span class="n">MDIO_PMA_LASI_TXCTRL</span><span class="p">,</span>
				 <span class="mi">0</span><span class="p">);</span>
		<span class="cm">/* Arm LASI for link and Tx fault. */</span>
		<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
				 <span class="n">MDIO_PMA_DEVAD</span><span class="p">,</span> <span class="n">MDIO_PMA_LASI_CTRL</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Force 1Gbps using autoneg with 1G advertisement */</span>

		<span class="cm">/* Allow CL37 through CL73 */</span>
		<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;XGXS 8706 AutoNeg</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
				 <span class="n">MDIO_AN_DEVAD</span><span class="p">,</span> <span class="n">MDIO_AN_REG_CL37_CL73</span><span class="p">,</span> <span class="mh">0x040c</span><span class="p">);</span>

		<span class="cm">/* Enable Full-Duplex advertisement on CL37 */</span>
		<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
				 <span class="n">MDIO_AN_DEVAD</span><span class="p">,</span> <span class="n">MDIO_AN_REG_CL37_FC_LP</span><span class="p">,</span> <span class="mh">0x0020</span><span class="p">);</span>
		<span class="cm">/* Enable CL37 AN */</span>
		<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
				 <span class="n">MDIO_AN_DEVAD</span><span class="p">,</span> <span class="n">MDIO_AN_REG_CL37_AN</span><span class="p">,</span> <span class="mh">0x1000</span><span class="p">);</span>
		<span class="cm">/* 1G support */</span>
		<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
				 <span class="n">MDIO_AN_DEVAD</span><span class="p">,</span> <span class="n">MDIO_AN_REG_ADV</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">5</span><span class="p">));</span>

		<span class="cm">/* Enable clause 73 AN */</span>
		<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
				 <span class="n">MDIO_AN_DEVAD</span><span class="p">,</span> <span class="n">MDIO_AN_REG_CTRL</span><span class="p">,</span> <span class="mh">0x1200</span><span class="p">);</span>
		<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
				 <span class="n">MDIO_PMA_DEVAD</span><span class="p">,</span> <span class="n">MDIO_PMA_LASI_RXCTRL</span><span class="p">,</span>
				 <span class="mh">0x0400</span><span class="p">);</span>
		<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
				 <span class="n">MDIO_PMA_DEVAD</span><span class="p">,</span> <span class="n">MDIO_PMA_LASI_CTRL</span><span class="p">,</span>
				 <span class="mh">0x0004</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">bnx2x_save_bcm_spirom_ver</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">);</span>

	<span class="cm">/* If TX Laser is controlled by GPIO_0, do not let PHY go into low</span>
<span class="cm">	 * power mode, if TX Laser is disabled</span>
<span class="cm">	 */</span>

	<span class="n">tx_en_mode</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">shmem_base</span> <span class="o">+</span>
			    <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">shmem_region</span><span class="p">,</span>
				<span class="n">dev_info</span><span class="p">.</span><span class="n">port_hw_config</span><span class="p">[</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">].</span><span class="n">sfp_ctrl</span><span class="p">))</span>
			<span class="o">&amp;</span> <span class="n">PORT_HW_CFG_TX_LASER_MASK</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tx_en_mode</span> <span class="o">==</span> <span class="n">PORT_HW_CFG_TX_LASER_GPIO0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;Enabling TXONOFF_PWRDN_DIS</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">bnx2x_cl45_read</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
			<span class="n">MDIO_PMA_DEVAD</span><span class="p">,</span> <span class="n">MDIO_PMA_REG_DIGITAL_CTRL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp1</span><span class="p">);</span>
		<span class="n">tmp1</span> <span class="o">|=</span> <span class="mh">0x1</span><span class="p">;</span>
		<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
			<span class="n">MDIO_PMA_DEVAD</span><span class="p">,</span> <span class="n">MDIO_PMA_REG_DIGITAL_CTRL</span><span class="p">,</span> <span class="n">tmp1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bnx2x_8706_read_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x_phy</span> <span class="o">*</span><span class="n">phy</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">link_params</span> <span class="o">*</span><span class="n">params</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">link_vars</span> <span class="o">*</span><span class="n">vars</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">bnx2x_8706_8726_read_status</span><span class="p">(</span><span class="n">phy</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">vars</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/******************************************************************/</span>
<span class="cm">/*			BCM8726 PHY SECTION			  */</span>
<span class="cm">/******************************************************************/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_8726_config_loopback</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x_phy</span> <span class="o">*</span><span class="n">phy</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">link_params</span> <span class="o">*</span><span class="n">params</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">bp</span><span class="p">;</span>
	<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;PMA/PMD ext_phy_loopback: 8726</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_PMA_DEVAD</span><span class="p">,</span> <span class="n">MDIO_PMA_REG_CTRL</span><span class="p">,</span> <span class="mh">0x0001</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_8726_external_rom_boot</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x_phy</span> <span class="o">*</span><span class="n">phy</span><span class="p">,</span>
					 <span class="k">struct</span> <span class="n">link_params</span> <span class="o">*</span><span class="n">params</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">bp</span><span class="p">;</span>
	<span class="cm">/* Need to wait 100ms after reset */</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>

	<span class="cm">/* Micro controller re-boot */</span>
	<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
			 <span class="n">MDIO_PMA_DEVAD</span><span class="p">,</span> <span class="n">MDIO_PMA_REG_GEN_CTRL</span><span class="p">,</span> <span class="mh">0x018B</span><span class="p">);</span>

	<span class="cm">/* Set soft reset */</span>
	<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
			 <span class="n">MDIO_PMA_DEVAD</span><span class="p">,</span>
			 <span class="n">MDIO_PMA_REG_GEN_CTRL</span><span class="p">,</span>
			 <span class="n">MDIO_PMA_REG_GEN_CTRL_ROM_MICRO_RESET</span><span class="p">);</span>

	<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
			 <span class="n">MDIO_PMA_DEVAD</span><span class="p">,</span>
			 <span class="n">MDIO_PMA_REG_MISC_CTRL1</span><span class="p">,</span> <span class="mh">0x0001</span><span class="p">);</span>

	<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
			 <span class="n">MDIO_PMA_DEVAD</span><span class="p">,</span>
			 <span class="n">MDIO_PMA_REG_GEN_CTRL</span><span class="p">,</span>
			 <span class="n">MDIO_PMA_REG_GEN_CTRL_ROM_RESET_INTERNAL_MP</span><span class="p">);</span>

	<span class="cm">/* wait for 150ms for microcode load */</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">150</span><span class="p">);</span>

	<span class="cm">/* Disable serial boot control, tristates pins SS_N, SCK, MOSI, MISO */</span>
	<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
			 <span class="n">MDIO_PMA_DEVAD</span><span class="p">,</span>
			 <span class="n">MDIO_PMA_REG_MISC_CTRL1</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>

	<span class="n">msleep</span><span class="p">(</span><span class="mi">200</span><span class="p">);</span>
	<span class="n">bnx2x_save_bcm_spirom_ver</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u8</span> <span class="nf">bnx2x_8726_read_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x_phy</span> <span class="o">*</span><span class="n">phy</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">link_params</span> <span class="o">*</span><span class="n">params</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">link_vars</span> <span class="o">*</span><span class="n">vars</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">bp</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">val1</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">link_up</span> <span class="o">=</span> <span class="n">bnx2x_8706_8726_read_status</span><span class="p">(</span><span class="n">phy</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">vars</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">link_up</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bnx2x_cl45_read</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
				<span class="n">MDIO_PMA_DEVAD</span><span class="p">,</span> <span class="n">MDIO_PMA_REG_PHY_IDENTIFIER</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">val1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">val1</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">15</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;Tx is disabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">link_up</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">vars</span><span class="o">-&gt;</span><span class="n">line_speed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">link_up</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">bnx2x_8726_config_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x_phy</span> <span class="o">*</span><span class="n">phy</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">link_params</span> <span class="o">*</span><span class="n">params</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">link_vars</span> <span class="o">*</span><span class="n">vars</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">bp</span><span class="p">;</span>
	<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;Initializing BCM8726</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_PMA_DEVAD</span><span class="p">,</span> <span class="n">MDIO_PMA_REG_CTRL</span><span class="p">,</span> <span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">15</span><span class="p">);</span>
	<span class="n">bnx2x_wait_reset_complete</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">params</span><span class="p">);</span>

	<span class="n">bnx2x_8726_external_rom_boot</span><span class="p">(</span><span class="n">phy</span><span class="p">,</span> <span class="n">params</span><span class="p">);</span>

	<span class="cm">/* Need to call module detected on initialization since the module</span>
<span class="cm">	 * detection triggered by actual module insertion might occur before</span>
<span class="cm">	 * driver is loaded, and when driver is loaded, it reset all</span>
<span class="cm">	 * registers, including the transmitter</span>
<span class="cm">	 */</span>
	<span class="n">bnx2x_sfp_module_detection</span><span class="p">(</span><span class="n">phy</span><span class="p">,</span> <span class="n">params</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">req_line_speed</span> <span class="o">==</span> <span class="n">SPEED_1000</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;Setting 1G force</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
				 <span class="n">MDIO_PMA_DEVAD</span><span class="p">,</span> <span class="n">MDIO_PMA_REG_CTRL</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">);</span>
		<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
				 <span class="n">MDIO_PMA_DEVAD</span><span class="p">,</span> <span class="n">MDIO_PMA_REG_10G_CTRL2</span><span class="p">,</span> <span class="mh">0xD</span><span class="p">);</span>
		<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
				 <span class="n">MDIO_PMA_DEVAD</span><span class="p">,</span> <span class="n">MDIO_PMA_LASI_CTRL</span><span class="p">,</span> <span class="mh">0x5</span><span class="p">);</span>
		<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
				 <span class="n">MDIO_PMA_DEVAD</span><span class="p">,</span> <span class="n">MDIO_PMA_LASI_RXCTRL</span><span class="p">,</span>
				 <span class="mh">0x400</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">req_line_speed</span> <span class="o">==</span> <span class="n">SPEED_AUTO_NEG</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		   <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">speed_cap_mask</span> <span class="o">&amp;</span>
		      <span class="n">PORT_HW_CFG_SPEED_CAPABILITY_D0_1G</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		   <span class="p">((</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">speed_cap_mask</span> <span class="o">&amp;</span>
		      <span class="n">PORT_HW_CFG_SPEED_CAPABILITY_D0_10G</span><span class="p">)</span> <span class="o">!=</span>
		    <span class="n">PORT_HW_CFG_SPEED_CAPABILITY_D0_10G</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;Setting 1G clause37</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="cm">/* Set Flow control */</span>
		<span class="n">bnx2x_ext_phy_set_pause</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">vars</span><span class="p">);</span>
		<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
				 <span class="n">MDIO_AN_DEVAD</span><span class="p">,</span> <span class="n">MDIO_AN_REG_ADV</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">);</span>
		<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
				 <span class="n">MDIO_AN_DEVAD</span><span class="p">,</span> <span class="n">MDIO_AN_REG_CL37_CL73</span><span class="p">,</span> <span class="mh">0x040c</span><span class="p">);</span>
		<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
				 <span class="n">MDIO_AN_DEVAD</span><span class="p">,</span> <span class="n">MDIO_AN_REG_CL37_FC_LD</span><span class="p">,</span> <span class="mh">0x0020</span><span class="p">);</span>
		<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
				 <span class="n">MDIO_AN_DEVAD</span><span class="p">,</span> <span class="n">MDIO_AN_REG_CL37_AN</span><span class="p">,</span> <span class="mh">0x1000</span><span class="p">);</span>
		<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
				<span class="n">MDIO_AN_DEVAD</span><span class="p">,</span> <span class="n">MDIO_AN_REG_CTRL</span><span class="p">,</span> <span class="mh">0x1200</span><span class="p">);</span>
		<span class="cm">/* Enable RX-ALARM control to receive interrupt for 1G speed</span>
<span class="cm">		 * change</span>
<span class="cm">		 */</span>
		<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
				 <span class="n">MDIO_PMA_DEVAD</span><span class="p">,</span> <span class="n">MDIO_PMA_LASI_CTRL</span><span class="p">,</span> <span class="mh">0x4</span><span class="p">);</span>
		<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
				 <span class="n">MDIO_PMA_DEVAD</span><span class="p">,</span> <span class="n">MDIO_PMA_LASI_RXCTRL</span><span class="p">,</span>
				 <span class="mh">0x400</span><span class="p">);</span>

	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="cm">/* Default 10G. Set only LASI control */</span>
		<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
				 <span class="n">MDIO_PMA_DEVAD</span><span class="p">,</span> <span class="n">MDIO_PMA_LASI_CTRL</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Set TX PreEmphasis if needed */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">feature_config_flags</span> <span class="o">&amp;</span>
	     <span class="n">FEATURE_CONFIG_OVERRIDE_PREEMPHASIS_ENABLED</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span>
		   <span class="s">&quot;Setting TX_CTRL1 0x%x, TX_CTRL2 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">phy</span><span class="o">-&gt;</span><span class="n">tx_preemphasis</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
			 <span class="n">phy</span><span class="o">-&gt;</span><span class="n">tx_preemphasis</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
		<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
				 <span class="n">MDIO_PMA_DEVAD</span><span class="p">,</span>
				 <span class="n">MDIO_PMA_REG_8726_TX_CTRL1</span><span class="p">,</span>
				 <span class="n">phy</span><span class="o">-&gt;</span><span class="n">tx_preemphasis</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>

		<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
				 <span class="n">MDIO_PMA_DEVAD</span><span class="p">,</span>
				 <span class="n">MDIO_PMA_REG_8726_TX_CTRL2</span><span class="p">,</span>
				 <span class="n">phy</span><span class="o">-&gt;</span><span class="n">tx_preemphasis</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_8726_link_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x_phy</span> <span class="o">*</span><span class="n">phy</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">link_params</span> <span class="o">*</span><span class="n">params</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">bp</span><span class="p">;</span>
	<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;bnx2x_8726_link_reset port %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">);</span>
	<span class="cm">/* Set serial boot control for external load */</span>
	<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
			 <span class="n">MDIO_PMA_DEVAD</span><span class="p">,</span>
			 <span class="n">MDIO_PMA_REG_GEN_CTRL</span><span class="p">,</span> <span class="mh">0x0001</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/******************************************************************/</span>
<span class="cm">/*			BCM8727 PHY SECTION			  */</span>
<span class="cm">/******************************************************************/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_8727_set_link_led</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x_phy</span> <span class="o">*</span><span class="n">phy</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">link_params</span> <span class="o">*</span><span class="n">params</span><span class="p">,</span> <span class="n">u8</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">bp</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">led_mode_bitmask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">gpio_pins_bitmask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">val</span><span class="p">;</span>
	<span class="cm">/* Only NOC flavor requires to set the LED specifically */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">FLAGS_NOC</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">LED_MODE_FRONT_PANEL_OFF</span>:
	<span class="k">case</span> <span class="n">LED_MODE_OFF</span>:
		<span class="n">led_mode_bitmask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">gpio_pins_bitmask</span> <span class="o">=</span> <span class="mh">0x03</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">LED_MODE_ON</span>:
		<span class="n">led_mode_bitmask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">gpio_pins_bitmask</span> <span class="o">=</span> <span class="mh">0x02</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">LED_MODE_OPER</span>:
		<span class="n">led_mode_bitmask</span> <span class="o">=</span> <span class="mh">0x60</span><span class="p">;</span>
		<span class="n">gpio_pins_bitmask</span> <span class="o">=</span> <span class="mh">0x11</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">bnx2x_cl45_read</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
			<span class="n">MDIO_PMA_DEVAD</span><span class="p">,</span>
			<span class="n">MDIO_PMA_REG_8727_PCS_OPT_CTRL</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">&amp;=</span> <span class="mh">0xff8f</span><span class="p">;</span>
	<span class="n">val</span> <span class="o">|=</span> <span class="n">led_mode_bitmask</span><span class="p">;</span>
	<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
			 <span class="n">MDIO_PMA_DEVAD</span><span class="p">,</span>
			 <span class="n">MDIO_PMA_REG_8727_PCS_OPT_CTRL</span><span class="p">,</span>
			 <span class="n">val</span><span class="p">);</span>
	<span class="n">bnx2x_cl45_read</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
			<span class="n">MDIO_PMA_DEVAD</span><span class="p">,</span>
			<span class="n">MDIO_PMA_REG_8727_GPIO_CTRL</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">&amp;=</span> <span class="mh">0xffe0</span><span class="p">;</span>
	<span class="n">val</span> <span class="o">|=</span> <span class="n">gpio_pins_bitmask</span><span class="p">;</span>
	<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
			 <span class="n">MDIO_PMA_DEVAD</span><span class="p">,</span>
			 <span class="n">MDIO_PMA_REG_8727_GPIO_CTRL</span><span class="p">,</span>
			 <span class="n">val</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_8727_hw_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x_phy</span> <span class="o">*</span><span class="n">phy</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">link_params</span> <span class="o">*</span><span class="n">params</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">u32</span> <span class="n">swap_val</span><span class="p">,</span> <span class="n">swap_override</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">port</span><span class="p">;</span>
	<span class="cm">/* The PHY reset is controlled by GPIO 1. Fake the port number</span>
<span class="cm">	 * to cancel the swap done in set_gpio()</span>
<span class="cm">	 */</span>
	<span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">bp</span><span class="p">;</span>
	<span class="n">swap_val</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">NIG_REG_PORT_SWAP</span><span class="p">);</span>
	<span class="n">swap_override</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">NIG_REG_STRAP_OVERRIDE</span><span class="p">);</span>
	<span class="n">port</span> <span class="o">=</span> <span class="p">(</span><span class="n">swap_val</span> <span class="o">&amp;&amp;</span> <span class="n">swap_override</span><span class="p">)</span> <span class="o">^</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">bnx2x_set_gpio</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">MISC_REGISTERS_GPIO_1</span><span class="p">,</span>
		       <span class="n">MISC_REGISTERS_GPIO_OUTPUT_LOW</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bnx2x_8727_config_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x_phy</span> <span class="o">*</span><span class="n">phy</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">link_params</span> <span class="o">*</span><span class="n">params</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">link_vars</span> <span class="o">*</span><span class="n">vars</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">tx_en_mode</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">tmp1</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">mod_abs</span><span class="p">,</span> <span class="n">tmp2</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">rx_alarm_ctrl_val</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">lasi_ctrl_val</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">bp</span><span class="p">;</span>
	<span class="cm">/* Enable PMD link, MOD_ABS_FLT, and 1G link alarm */</span>

	<span class="n">bnx2x_wait_reset_complete</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">params</span><span class="p">);</span>
	<span class="n">rx_alarm_ctrl_val</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">2</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">5</span><span class="p">)</span> <span class="p">;</span>
	<span class="cm">/* Should be 0x6 to enable XS on Tx side. */</span>
	<span class="n">lasi_ctrl_val</span> <span class="o">=</span> <span class="mh">0x0006</span><span class="p">;</span>

	<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;Initializing BCM8727</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="cm">/* enable LASI */</span>
	<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
			 <span class="n">MDIO_PMA_DEVAD</span><span class="p">,</span> <span class="n">MDIO_PMA_LASI_RXCTRL</span><span class="p">,</span>
			 <span class="n">rx_alarm_ctrl_val</span><span class="p">);</span>
	<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
			 <span class="n">MDIO_PMA_DEVAD</span><span class="p">,</span> <span class="n">MDIO_PMA_LASI_TXCTRL</span><span class="p">,</span>
			 <span class="mi">0</span><span class="p">);</span>
	<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
			 <span class="n">MDIO_PMA_DEVAD</span><span class="p">,</span> <span class="n">MDIO_PMA_LASI_CTRL</span><span class="p">,</span> <span class="n">lasi_ctrl_val</span><span class="p">);</span>

	<span class="cm">/* Initially configure MOD_ABS to interrupt when module is</span>
<span class="cm">	 * presence( bit 8)</span>
<span class="cm">	 */</span>
	<span class="n">bnx2x_cl45_read</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
			<span class="n">MDIO_PMA_DEVAD</span><span class="p">,</span> <span class="n">MDIO_PMA_REG_PHY_IDENTIFIER</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mod_abs</span><span class="p">);</span>
	<span class="cm">/* Set EDC off by setting OPTXLOS signal input to low (bit 9).</span>
<span class="cm">	 * When the EDC is off it locks onto a reference clock and avoids</span>
<span class="cm">	 * becoming &#39;lost&#39;</span>
<span class="cm">	 */</span>
	<span class="n">mod_abs</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">8</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">FLAGS_NOC</span><span class="p">))</span>
		<span class="n">mod_abs</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">9</span><span class="p">);</span>
	<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
			 <span class="n">MDIO_PMA_DEVAD</span><span class="p">,</span> <span class="n">MDIO_PMA_REG_PHY_IDENTIFIER</span><span class="p">,</span> <span class="n">mod_abs</span><span class="p">);</span>


	<span class="cm">/* Enable/Disable PHY transmitter output */</span>
	<span class="n">bnx2x_set_disable_pmd_transmit</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* Make MOD_ABS give interrupt on change */</span>
	<span class="n">bnx2x_cl45_read</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_PMA_DEVAD</span><span class="p">,</span> <span class="n">MDIO_PMA_REG_8727_PCS_OPT_CTRL</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">12</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">FLAGS_NOC</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">3</span><span class="o">&lt;&lt;</span><span class="mi">5</span><span class="p">);</span>

	<span class="cm">/* Set 8727 GPIOs to input to allow reading from the 8727 GPIO0</span>
<span class="cm">	 * status which reflect SFP+ module over-current</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">FLAGS_NOC</span><span class="p">))</span>
		<span class="n">val</span> <span class="o">&amp;=</span> <span class="mh">0xff8f</span><span class="p">;</span> <span class="cm">/* Reset bits 4-6 */</span>
	<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
			 <span class="n">MDIO_PMA_DEVAD</span><span class="p">,</span> <span class="n">MDIO_PMA_REG_8727_PCS_OPT_CTRL</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

	<span class="n">bnx2x_8727_power_module</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">bnx2x_cl45_read</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
			<span class="n">MDIO_PMA_DEVAD</span><span class="p">,</span> <span class="n">MDIO_PMA_REG_M8051_MSGOUT_REG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp1</span><span class="p">);</span>

	<span class="n">bnx2x_cl45_read</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
			<span class="n">MDIO_PMA_DEVAD</span><span class="p">,</span> <span class="n">MDIO_PMA_LASI_RXSTAT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp1</span><span class="p">);</span>

	<span class="cm">/* Set option 1G speed */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">req_line_speed</span> <span class="o">==</span> <span class="n">SPEED_1000</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;Setting 1G force</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
				 <span class="n">MDIO_PMA_DEVAD</span><span class="p">,</span> <span class="n">MDIO_PMA_REG_CTRL</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">);</span>
		<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
				 <span class="n">MDIO_PMA_DEVAD</span><span class="p">,</span> <span class="n">MDIO_PMA_REG_10G_CTRL2</span><span class="p">,</span> <span class="mh">0xD</span><span class="p">);</span>
		<span class="n">bnx2x_cl45_read</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
				<span class="n">MDIO_PMA_DEVAD</span><span class="p">,</span> <span class="n">MDIO_PMA_REG_10G_CTRL2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp1</span><span class="p">);</span>
		<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;1.7 = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tmp1</span><span class="p">);</span>
		<span class="cm">/* Power down the XAUI until link is up in case of dual-media</span>
<span class="cm">		 * and 1G</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">DUAL_MEDIA</span><span class="p">(</span><span class="n">params</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">bnx2x_cl45_read</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
					<span class="n">MDIO_PMA_DEVAD</span><span class="p">,</span>
					<span class="n">MDIO_PMA_REG_8727_PCS_GP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
			<span class="n">val</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">3</span><span class="o">&lt;&lt;</span><span class="mi">10</span><span class="p">);</span>
			<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
					 <span class="n">MDIO_PMA_DEVAD</span><span class="p">,</span>
					 <span class="n">MDIO_PMA_REG_8727_PCS_GP</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">req_line_speed</span> <span class="o">==</span> <span class="n">SPEED_AUTO_NEG</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		   <span class="p">((</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">speed_cap_mask</span> <span class="o">&amp;</span>
		     <span class="n">PORT_HW_CFG_SPEED_CAPABILITY_D0_1G</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
		   <span class="p">((</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">speed_cap_mask</span> <span class="o">&amp;</span>
		      <span class="n">PORT_HW_CFG_SPEED_CAPABILITY_D0_10G</span><span class="p">)</span> <span class="o">!=</span>
		   <span class="n">PORT_HW_CFG_SPEED_CAPABILITY_D0_10G</span><span class="p">))</span> <span class="p">{</span>

		<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;Setting 1G clause37</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
				 <span class="n">MDIO_AN_DEVAD</span><span class="p">,</span> <span class="n">MDIO_AN_REG_8727_MISC_CTRL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
				 <span class="n">MDIO_AN_DEVAD</span><span class="p">,</span> <span class="n">MDIO_AN_REG_CL37_AN</span><span class="p">,</span> <span class="mh">0x1300</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Since the 8727 has only single reset pin, need to set the 10G</span>
<span class="cm">		 * registers although it is default</span>
<span class="cm">		 */</span>
		<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
				 <span class="n">MDIO_AN_DEVAD</span><span class="p">,</span> <span class="n">MDIO_AN_REG_8727_MISC_CTRL</span><span class="p">,</span>
				 <span class="mh">0x0020</span><span class="p">);</span>
		<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
				 <span class="n">MDIO_AN_DEVAD</span><span class="p">,</span> <span class="n">MDIO_AN_REG_CL37_AN</span><span class="p">,</span> <span class="mh">0x0100</span><span class="p">);</span>
		<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
				 <span class="n">MDIO_PMA_DEVAD</span><span class="p">,</span> <span class="n">MDIO_PMA_REG_CTRL</span><span class="p">,</span> <span class="mh">0x2040</span><span class="p">);</span>
		<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
				 <span class="n">MDIO_PMA_DEVAD</span><span class="p">,</span> <span class="n">MDIO_PMA_REG_10G_CTRL2</span><span class="p">,</span>
				 <span class="mh">0x0008</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Set 2-wire transfer rate of SFP+ module EEPROM</span>
<span class="cm">	 * to 100Khz since some DACs(direct attached cables) do</span>
<span class="cm">	 * not work at 400Khz.</span>
<span class="cm">	 */</span>
	<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
			 <span class="n">MDIO_PMA_DEVAD</span><span class="p">,</span> <span class="n">MDIO_PMA_REG_8727_TWO_WIRE_SLAVE_ADDR</span><span class="p">,</span>
			 <span class="mh">0xa001</span><span class="p">);</span>

	<span class="cm">/* Set TX PreEmphasis if needed */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">feature_config_flags</span> <span class="o">&amp;</span>
	     <span class="n">FEATURE_CONFIG_OVERRIDE_PREEMPHASIS_ENABLED</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;Setting TX_CTRL1 0x%x, TX_CTRL2 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">phy</span><span class="o">-&gt;</span><span class="n">tx_preemphasis</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
			   <span class="n">phy</span><span class="o">-&gt;</span><span class="n">tx_preemphasis</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
		<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
				 <span class="n">MDIO_PMA_DEVAD</span><span class="p">,</span> <span class="n">MDIO_PMA_REG_8727_TX_CTRL1</span><span class="p">,</span>
				 <span class="n">phy</span><span class="o">-&gt;</span><span class="n">tx_preemphasis</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>

		<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
				 <span class="n">MDIO_PMA_DEVAD</span><span class="p">,</span> <span class="n">MDIO_PMA_REG_8727_TX_CTRL2</span><span class="p">,</span>
				 <span class="n">phy</span><span class="o">-&gt;</span><span class="n">tx_preemphasis</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
	<span class="p">}</span>

	<span class="cm">/* If TX Laser is controlled by GPIO_0, do not let PHY go into low</span>
<span class="cm">	 * power mode, if TX Laser is disabled</span>
<span class="cm">	 */</span>
	<span class="n">tx_en_mode</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">shmem_base</span> <span class="o">+</span>
			    <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">shmem_region</span><span class="p">,</span>
				<span class="n">dev_info</span><span class="p">.</span><span class="n">port_hw_config</span><span class="p">[</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">].</span><span class="n">sfp_ctrl</span><span class="p">))</span>
			<span class="o">&amp;</span> <span class="n">PORT_HW_CFG_TX_LASER_MASK</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tx_en_mode</span> <span class="o">==</span> <span class="n">PORT_HW_CFG_TX_LASER_GPIO0</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;Enabling TXONOFF_PWRDN_DIS</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">bnx2x_cl45_read</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
			<span class="n">MDIO_PMA_DEVAD</span><span class="p">,</span> <span class="n">MDIO_PMA_REG_8727_OPT_CFG_REG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp2</span><span class="p">);</span>
		<span class="n">tmp2</span> <span class="o">|=</span> <span class="mh">0x1000</span><span class="p">;</span>
		<span class="n">tmp2</span> <span class="o">&amp;=</span> <span class="mh">0xFFEF</span><span class="p">;</span>
		<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
			<span class="n">MDIO_PMA_DEVAD</span><span class="p">,</span> <span class="n">MDIO_PMA_REG_8727_OPT_CFG_REG</span><span class="p">,</span> <span class="n">tmp2</span><span class="p">);</span>
		<span class="n">bnx2x_cl45_read</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
				<span class="n">MDIO_PMA_DEVAD</span><span class="p">,</span> <span class="n">MDIO_PMA_REG_PHY_IDENTIFIER</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">tmp2</span><span class="p">);</span>
		<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
				 <span class="n">MDIO_PMA_DEVAD</span><span class="p">,</span> <span class="n">MDIO_PMA_REG_PHY_IDENTIFIER</span><span class="p">,</span>
				 <span class="p">(</span><span class="n">tmp2</span> <span class="o">&amp;</span> <span class="mh">0x7fff</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_8727_handle_mod_abs</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x_phy</span> <span class="o">*</span><span class="n">phy</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">link_params</span> <span class="o">*</span><span class="n">params</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">bp</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">mod_abs</span><span class="p">,</span> <span class="n">rx_alarm_status</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">val</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">shmem_base</span> <span class="o">+</span>
			     <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">shmem_region</span><span class="p">,</span> <span class="n">dev_info</span><span class="p">.</span>
				      <span class="n">port_feature_config</span><span class="p">[</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">].</span>
				      <span class="n">config</span><span class="p">));</span>
	<span class="n">bnx2x_cl45_read</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
			<span class="n">MDIO_PMA_DEVAD</span><span class="p">,</span>
			<span class="n">MDIO_PMA_REG_PHY_IDENTIFIER</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mod_abs</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mod_abs</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">8</span><span class="p">))</span> <span class="p">{</span>

		<span class="cm">/* Module is absent */</span>
		<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span>
		   <span class="s">&quot;MOD_ABS indication show module is absent</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">phy</span><span class="o">-&gt;</span><span class="n">media_type</span> <span class="o">=</span> <span class="n">ETH_PHY_NOT_PRESENT</span><span class="p">;</span>
		<span class="cm">/* 1. Set mod_abs to detect next module</span>
<span class="cm">		 *    presence event</span>
<span class="cm">		 * 2. Set EDC off by setting OPTXLOS signal input to low</span>
<span class="cm">		 *    (bit 9).</span>
<span class="cm">		 *    When the EDC is off it locks onto a reference clock and</span>
<span class="cm">		 *    avoids becoming &#39;lost&#39;.</span>
<span class="cm">		 */</span>
		<span class="n">mod_abs</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">8</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">FLAGS_NOC</span><span class="p">))</span>
			<span class="n">mod_abs</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">9</span><span class="p">);</span>
		<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
				 <span class="n">MDIO_PMA_DEVAD</span><span class="p">,</span>
				 <span class="n">MDIO_PMA_REG_PHY_IDENTIFIER</span><span class="p">,</span> <span class="n">mod_abs</span><span class="p">);</span>

		<span class="cm">/* Clear RX alarm since it stays up as long as</span>
<span class="cm">		 * the mod_abs wasn&#39;t changed</span>
<span class="cm">		 */</span>
		<span class="n">bnx2x_cl45_read</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
				<span class="n">MDIO_PMA_DEVAD</span><span class="p">,</span>
				<span class="n">MDIO_PMA_LASI_RXSTAT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rx_alarm_status</span><span class="p">);</span>

	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Module is present */</span>
		<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span>
		   <span class="s">&quot;MOD_ABS indication show module is present</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="cm">/* First disable transmitter, and if the module is ok, the</span>
<span class="cm">		 * module_detection will enable it</span>
<span class="cm">		 * 1. Set mod_abs to detect next module absent event ( bit 8)</span>
<span class="cm">		 * 2. Restore the default polarity of the OPRXLOS signal and</span>
<span class="cm">		 * this signal will then correctly indicate the presence or</span>
<span class="cm">		 * absence of the Rx signal. (bit 9)</span>
<span class="cm">		 */</span>
		<span class="n">mod_abs</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">8</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">FLAGS_NOC</span><span class="p">))</span>
			<span class="n">mod_abs</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">9</span><span class="p">);</span>
		<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
				 <span class="n">MDIO_PMA_DEVAD</span><span class="p">,</span>
				 <span class="n">MDIO_PMA_REG_PHY_IDENTIFIER</span><span class="p">,</span> <span class="n">mod_abs</span><span class="p">);</span>

		<span class="cm">/* Clear RX alarm since it stays up as long as the mod_abs</span>
<span class="cm">		 * wasn&#39;t changed. This is need to be done before calling the</span>
<span class="cm">		 * module detection, otherwise it will clear* the link update</span>
<span class="cm">		 * alarm</span>
<span class="cm">		 */</span>
		<span class="n">bnx2x_cl45_read</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
				<span class="n">MDIO_PMA_DEVAD</span><span class="p">,</span>
				<span class="n">MDIO_PMA_LASI_RXSTAT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rx_alarm_status</span><span class="p">);</span>


		<span class="k">if</span> <span class="p">((</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">PORT_FEAT_CFG_OPT_MDL_ENFRCMNT_MASK</span><span class="p">)</span> <span class="o">==</span>
		    <span class="n">PORT_FEAT_CFG_OPT_MDL_ENFRCMNT_DISABLE_TX_LASER</span><span class="p">)</span>
			<span class="n">bnx2x_sfp_set_transmitter</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">bnx2x_wait_for_sfp_module_initialized</span><span class="p">(</span><span class="n">phy</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">bnx2x_sfp_module_detection</span><span class="p">(</span><span class="n">phy</span><span class="p">,</span> <span class="n">params</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;SFP+ module is not initialized</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;8727 RX_ALARM_STATUS 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">rx_alarm_status</span><span class="p">);</span>
	<span class="cm">/* No need to check link status in case of module plugged in/out */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u8</span> <span class="nf">bnx2x_8727_read_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x_phy</span> <span class="o">*</span><span class="n">phy</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">link_params</span> <span class="o">*</span><span class="n">params</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">link_vars</span> <span class="o">*</span><span class="n">vars</span><span class="p">)</span>

<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">bp</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">link_up</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">oc_port</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">link_status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">rx_alarm_status</span><span class="p">,</span> <span class="n">lasi_ctrl</span><span class="p">,</span> <span class="n">val1</span><span class="p">;</span>

	<span class="cm">/* If PHY is not initialized, do not check link status */</span>
	<span class="n">bnx2x_cl45_read</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
			<span class="n">MDIO_PMA_DEVAD</span><span class="p">,</span> <span class="n">MDIO_PMA_LASI_CTRL</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">lasi_ctrl</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lasi_ctrl</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Check the LASI on Rx */</span>
	<span class="n">bnx2x_cl45_read</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
			<span class="n">MDIO_PMA_DEVAD</span><span class="p">,</span> <span class="n">MDIO_PMA_LASI_RXSTAT</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">rx_alarm_status</span><span class="p">);</span>
	<span class="n">vars</span><span class="o">-&gt;</span><span class="n">line_speed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;8727 RX_ALARM_STATUS  0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rx_alarm_status</span><span class="p">);</span>

	<span class="n">bnx2x_sfp_mask_fault</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_PMA_LASI_TXSTAT</span><span class="p">,</span>
			     <span class="n">MDIO_PMA_LASI_TXCTRL</span><span class="p">);</span>

	<span class="n">bnx2x_cl45_read</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
			<span class="n">MDIO_PMA_DEVAD</span><span class="p">,</span> <span class="n">MDIO_PMA_LASI_STAT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val1</span><span class="p">);</span>

	<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;8727 LASI status 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">val1</span><span class="p">);</span>

	<span class="cm">/* Clear MSG-OUT */</span>
	<span class="n">bnx2x_cl45_read</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
			<span class="n">MDIO_PMA_DEVAD</span><span class="p">,</span> <span class="n">MDIO_PMA_REG_M8051_MSGOUT_REG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val1</span><span class="p">);</span>

	<span class="cm">/* If a module is present and there is need to check</span>
<span class="cm">	 * for over current</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">FLAGS_NOC</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">rx_alarm_status</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">5</span><span class="p">)))</span> <span class="p">{</span>
		<span class="cm">/* Check over-current using 8727 GPIO0 input*/</span>
		<span class="n">bnx2x_cl45_read</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
				<span class="n">MDIO_PMA_DEVAD</span><span class="p">,</span> <span class="n">MDIO_PMA_REG_8727_GPIO_CTRL</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">val1</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">val1</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">8</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CHIP_IS_E1x</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span>
				<span class="n">oc_port</span> <span class="o">=</span> <span class="n">BP_PATH</span><span class="p">(</span><span class="n">bp</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span>
			   <span class="s">&quot;8727 Power fault has been detected on port %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">oc_port</span><span class="p">);</span>
			<span class="n">netdev_err</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Error: Power fault on Port %d has &quot;</span>
					    <span class="s">&quot;been detected and the power to &quot;</span>
					    <span class="s">&quot;that SFP+ module has been removed &quot;</span>
					    <span class="s">&quot;to prevent failure of the card. &quot;</span>
					    <span class="s">&quot;Please remove the SFP+ module and &quot;</span>
					    <span class="s">&quot;restart the system to clear this &quot;</span>
					    <span class="s">&quot;error.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">oc_port</span><span class="p">);</span>
			<span class="cm">/* Disable all RX_ALARMs except for mod_abs */</span>
			<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
					 <span class="n">MDIO_PMA_DEVAD</span><span class="p">,</span>
					 <span class="n">MDIO_PMA_LASI_RXCTRL</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">5</span><span class="p">));</span>

			<span class="n">bnx2x_cl45_read</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
					<span class="n">MDIO_PMA_DEVAD</span><span class="p">,</span>
					<span class="n">MDIO_PMA_REG_PHY_IDENTIFIER</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val1</span><span class="p">);</span>
			<span class="cm">/* Wait for module_absent_event */</span>
			<span class="n">val1</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">8</span><span class="p">);</span>
			<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
					 <span class="n">MDIO_PMA_DEVAD</span><span class="p">,</span>
					 <span class="n">MDIO_PMA_REG_PHY_IDENTIFIER</span><span class="p">,</span> <span class="n">val1</span><span class="p">);</span>
			<span class="cm">/* Clear RX alarm */</span>
			<span class="n">bnx2x_cl45_read</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
				<span class="n">MDIO_PMA_DEVAD</span><span class="p">,</span>
				<span class="n">MDIO_PMA_LASI_RXSTAT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rx_alarm_status</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="cm">/* Over current check */</span>

	<span class="cm">/* When module absent bit is set, check module */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rx_alarm_status</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">5</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">bnx2x_8727_handle_mod_abs</span><span class="p">(</span><span class="n">phy</span><span class="p">,</span> <span class="n">params</span><span class="p">);</span>
		<span class="cm">/* Enable all mod_abs and link detection bits */</span>
		<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
				 <span class="n">MDIO_PMA_DEVAD</span><span class="p">,</span> <span class="n">MDIO_PMA_LASI_RXCTRL</span><span class="p">,</span>
				 <span class="p">((</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">2</span><span class="p">)));</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">FLAGS_SFP_NOT_APPROVED</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;Enabling 8727 TX laser</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">bnx2x_sfp_set_transmitter</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;Tx is disabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">bnx2x_cl45_read</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
			<span class="n">MDIO_PMA_DEVAD</span><span class="p">,</span>
			<span class="n">MDIO_PMA_REG_8073_SPEED_LINK_STATUS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">link_status</span><span class="p">);</span>

	<span class="cm">/* Bits 0..2 --&gt; speed detected,</span>
<span class="cm">	 * Bits 13..15--&gt; link is down</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">link_status</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">2</span><span class="p">))</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">link_status</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">15</span><span class="p">))))</span> <span class="p">{</span>
		<span class="n">link_up</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">vars</span><span class="o">-&gt;</span><span class="n">line_speed</span> <span class="o">=</span> <span class="n">SPEED_10000</span><span class="p">;</span>
		<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;port %x: External link up in 10G</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">params</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">link_status</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">0</span><span class="p">))</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">link_status</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">13</span><span class="p">))))</span> <span class="p">{</span>
		<span class="n">link_up</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">vars</span><span class="o">-&gt;</span><span class="n">line_speed</span> <span class="o">=</span> <span class="n">SPEED_1000</span><span class="p">;</span>
		<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;port %x: External link up in 1G</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">params</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">link_up</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;port %x: External link is down</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">params</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Capture 10G link fault. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vars</span><span class="o">-&gt;</span><span class="n">line_speed</span> <span class="o">==</span> <span class="n">SPEED_10000</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bnx2x_cl45_read</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_PMA_DEVAD</span><span class="p">,</span>
			    <span class="n">MDIO_PMA_LASI_TXSTAT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val1</span><span class="p">);</span>

		<span class="n">bnx2x_cl45_read</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_PMA_DEVAD</span><span class="p">,</span>
			    <span class="n">MDIO_PMA_LASI_TXSTAT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val1</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">val1</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">vars</span><span class="o">-&gt;</span><span class="n">fault_detected</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">link_up</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bnx2x_ext_phy_resolve_fc</span><span class="p">(</span><span class="n">phy</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">vars</span><span class="p">);</span>
		<span class="n">vars</span><span class="o">-&gt;</span><span class="n">duplex</span> <span class="o">=</span> <span class="n">DUPLEX_FULL</span><span class="p">;</span>
		<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;duplex = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">vars</span><span class="o">-&gt;</span><span class="n">duplex</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">DUAL_MEDIA</span><span class="p">(</span><span class="n">params</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">req_line_speed</span> <span class="o">==</span> <span class="n">SPEED_1000</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">bnx2x_cl45_read</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
				<span class="n">MDIO_PMA_DEVAD</span><span class="p">,</span>
				<span class="n">MDIO_PMA_REG_8727_PCS_GP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val1</span><span class="p">);</span>
		<span class="cm">/* In case of dual-media board and 1G, power up the XAUI side,</span>
<span class="cm">		 * otherwise power it down. For 10G it is done automatically</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">link_up</span><span class="p">)</span>
			<span class="n">val1</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">3</span><span class="o">&lt;&lt;</span><span class="mi">10</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">val1</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">3</span><span class="o">&lt;&lt;</span><span class="mi">10</span><span class="p">);</span>
		<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
				 <span class="n">MDIO_PMA_DEVAD</span><span class="p">,</span>
				 <span class="n">MDIO_PMA_REG_8727_PCS_GP</span><span class="p">,</span> <span class="n">val1</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">link_up</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_8727_link_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x_phy</span> <span class="o">*</span><span class="n">phy</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">link_params</span> <span class="o">*</span><span class="n">params</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">bp</span><span class="p">;</span>

	<span class="cm">/* Enable/Disable PHY transmitter output */</span>
	<span class="n">bnx2x_set_disable_pmd_transmit</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* Disable Transmitter */</span>
	<span class="n">bnx2x_sfp_set_transmitter</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="cm">/* Clear LASI */</span>
	<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_PMA_DEVAD</span><span class="p">,</span> <span class="n">MDIO_PMA_LASI_CTRL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

<span class="p">}</span>

<span class="cm">/******************************************************************/</span>
<span class="cm">/*		BCM8481/BCM84823/BCM84833 PHY SECTION	          */</span>
<span class="cm">/******************************************************************/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_save_848xx_spirom_version</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x_phy</span> <span class="o">*</span><span class="n">phy</span><span class="p">,</span>
					    <span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">,</span>
					    <span class="n">u8</span> <span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">val</span><span class="p">,</span> <span class="n">fw_ver1</span><span class="p">,</span> <span class="n">fw_ver2</span><span class="p">,</span> <span class="n">cnt</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">PORT_HW_CFG_XGXS_EXT_PHY_TYPE_BCM84833</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bnx2x_cl45_read</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_CTL_DEVAD</span><span class="p">,</span> <span class="mh">0x400f</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fw_ver1</span><span class="p">);</span>
		<span class="n">bnx2x_save_spirom_version</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">fw_ver1</span> <span class="o">&amp;</span> <span class="mh">0xfff</span><span class="p">,</span>
				<span class="n">phy</span><span class="o">-&gt;</span><span class="n">ver_addr</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* For 32-bit registers in 848xx, access via MDIO2ARM i/f. */</span>
		<span class="cm">/* (1) set reg 0xc200_0014(SPI_BRIDGE_CTRL_2) to 0x03000000 */</span>
		<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_PMA_DEVAD</span><span class="p">,</span> <span class="mh">0xA819</span><span class="p">,</span> <span class="mh">0x0014</span><span class="p">);</span>
		<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_PMA_DEVAD</span><span class="p">,</span> <span class="mh">0xA81A</span><span class="p">,</span> <span class="mh">0xc200</span><span class="p">);</span>
		<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_PMA_DEVAD</span><span class="p">,</span> <span class="mh">0xA81B</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
		<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_PMA_DEVAD</span><span class="p">,</span> <span class="mh">0xA81C</span><span class="p">,</span> <span class="mh">0x0300</span><span class="p">);</span>
		<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_PMA_DEVAD</span><span class="p">,</span> <span class="mh">0xA817</span><span class="p">,</span> <span class="mh">0x0009</span><span class="p">);</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">cnt</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">;</span> <span class="n">cnt</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">bnx2x_cl45_read</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_PMA_DEVAD</span><span class="p">,</span> <span class="mh">0xA818</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">==</span> <span class="mi">100</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;Unable to read 848xx &quot;</span>
					<span class="s">&quot;phy fw version(1)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">bnx2x_save_spirom_version</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
						  <span class="n">phy</span><span class="o">-&gt;</span><span class="n">ver_addr</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>


		<span class="cm">/* 2) read register 0xc200_0000 (SPI_FW_STATUS) */</span>
		<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_PMA_DEVAD</span><span class="p">,</span> <span class="mh">0xA819</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
		<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_PMA_DEVAD</span><span class="p">,</span> <span class="mh">0xA81A</span><span class="p">,</span> <span class="mh">0xc200</span><span class="p">);</span>
		<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_PMA_DEVAD</span><span class="p">,</span> <span class="mh">0xA817</span><span class="p">,</span> <span class="mh">0x000A</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">cnt</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">;</span> <span class="n">cnt</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">bnx2x_cl45_read</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_PMA_DEVAD</span><span class="p">,</span> <span class="mh">0xA818</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">==</span> <span class="mi">100</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;Unable to read 848xx phy fw &quot;</span>
					<span class="s">&quot;version(2)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">bnx2x_save_spirom_version</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
						  <span class="n">phy</span><span class="o">-&gt;</span><span class="n">ver_addr</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* lower 16 bits of the register SPI_FW_STATUS */</span>
		<span class="n">bnx2x_cl45_read</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_PMA_DEVAD</span><span class="p">,</span> <span class="mh">0xA81B</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fw_ver1</span><span class="p">);</span>
		<span class="cm">/* upper 16 bits of register SPI_FW_STATUS */</span>
		<span class="n">bnx2x_cl45_read</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_PMA_DEVAD</span><span class="p">,</span> <span class="mh">0xA81C</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fw_ver2</span><span class="p">);</span>

		<span class="n">bnx2x_save_spirom_version</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="p">(</span><span class="n">fw_ver2</span><span class="o">&lt;&lt;</span><span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="n">fw_ver1</span><span class="p">,</span>
					  <span class="n">phy</span><span class="o">-&gt;</span><span class="n">ver_addr</span><span class="p">);</span>
	<span class="p">}</span>

<span class="p">}</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_848xx_set_led</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">bnx2x_phy</span> <span class="o">*</span><span class="n">phy</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">val</span><span class="p">,</span> <span class="n">offset</span><span class="p">;</span>

	<span class="cm">/* PHYC_CTL_LED_CTL */</span>
	<span class="n">bnx2x_cl45_read</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
			<span class="n">MDIO_PMA_DEVAD</span><span class="p">,</span>
			<span class="n">MDIO_PMA_REG_8481_LINK_SIGNAL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">&amp;=</span> <span class="mh">0xFE00</span><span class="p">;</span>
	<span class="n">val</span> <span class="o">|=</span> <span class="mh">0x0092</span><span class="p">;</span>

	<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
			 <span class="n">MDIO_PMA_DEVAD</span><span class="p">,</span>
			 <span class="n">MDIO_PMA_REG_8481_LINK_SIGNAL</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

	<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
			 <span class="n">MDIO_PMA_DEVAD</span><span class="p">,</span>
			 <span class="n">MDIO_PMA_REG_8481_LED1_MASK</span><span class="p">,</span>
			 <span class="mh">0x80</span><span class="p">);</span>

	<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
			 <span class="n">MDIO_PMA_DEVAD</span><span class="p">,</span>
			 <span class="n">MDIO_PMA_REG_8481_LED2_MASK</span><span class="p">,</span>
			 <span class="mh">0x18</span><span class="p">);</span>

	<span class="cm">/* Select activity source by Tx and Rx, as suggested by PHY AE */</span>
	<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
			 <span class="n">MDIO_PMA_DEVAD</span><span class="p">,</span>
			 <span class="n">MDIO_PMA_REG_8481_LED3_MASK</span><span class="p">,</span>
			 <span class="mh">0x0006</span><span class="p">);</span>

	<span class="cm">/* Select the closest activity blink rate to that in 10/100/1000 */</span>
	<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
			<span class="n">MDIO_PMA_DEVAD</span><span class="p">,</span>
			<span class="n">MDIO_PMA_REG_8481_LED3_BLINK</span><span class="p">,</span>
			<span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* Configure the blink rate to ~15.9 Hz */</span>
	<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
			<span class="n">MDIO_PMA_DEVAD</span><span class="p">,</span>
			<span class="n">MDIO_PMA_REG_84823_CTL_SLOW_CLK_CNT_HIGH</span><span class="p">,</span>
			<span class="n">MDIO_PMA_REG_84823_BLINK_RATE_VAL_15P9HZ</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">PORT_HW_CFG_XGXS_EXT_PHY_TYPE_BCM84833</span><span class="p">)</span>
		<span class="n">offset</span> <span class="o">=</span> <span class="n">MDIO_PMA_REG_84833_CTL_LED_CTL_1</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">offset</span> <span class="o">=</span> <span class="n">MDIO_PMA_REG_84823_CTL_LED_CTL_1</span><span class="p">;</span>

	<span class="n">bnx2x_cl45_read</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
			<span class="n">MDIO_PMA_DEVAD</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">|=</span> <span class="n">MDIO_PMA_REG_84823_LED3_STRETCH_EN</span><span class="p">;</span> <span class="cm">/* stretch_en for LED3*/</span>
	<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
			 <span class="n">MDIO_PMA_DEVAD</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

	<span class="cm">/* &#39;Interrupt Mask&#39; */</span>
	<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
			 <span class="n">MDIO_AN_DEVAD</span><span class="p">,</span>
			 <span class="mh">0xFFFB</span><span class="p">,</span> <span class="mh">0xFFFD</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bnx2x_848xx_cmn_config_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x_phy</span> <span class="o">*</span><span class="n">phy</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">link_params</span> <span class="o">*</span><span class="n">params</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">link_vars</span> <span class="o">*</span><span class="n">vars</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">bp</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">autoneg_val</span><span class="p">,</span> <span class="n">an_1000_val</span><span class="p">,</span> <span class="n">an_10_100_val</span><span class="p">,</span> <span class="n">an_10g_val</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">PORT_HW_CFG_XGXS_EXT_PHY_TYPE_BCM84833</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Save spirom version */</span>
		<span class="n">bnx2x_save_848xx_spirom_version</span><span class="p">(</span><span class="n">phy</span><span class="p">,</span> <span class="n">bp</span><span class="p">,</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/* This phy uses the NIG latch mechanism since link indication</span>
<span class="cm">	 * arrives through its LED4 and not via its LASI signal, so we</span>
<span class="cm">	 * get steady signal instead of clear on read</span>
<span class="cm">	 */</span>
	<span class="n">bnx2x_bits_en</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">NIG_REG_LATCH_BC_0</span> <span class="o">+</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">*</span><span class="mi">4</span><span class="p">,</span>
		      <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">NIG_LATCH_BC_ENABLE_MI_INT</span><span class="p">);</span>

	<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
			 <span class="n">MDIO_PMA_DEVAD</span><span class="p">,</span> <span class="n">MDIO_PMA_REG_CTRL</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>

	<span class="n">bnx2x_848xx_set_led</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">);</span>

	<span class="cm">/* set 1000 speed advertisement */</span>
	<span class="n">bnx2x_cl45_read</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
			<span class="n">MDIO_AN_DEVAD</span><span class="p">,</span> <span class="n">MDIO_AN_REG_8481_1000T_CTRL</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">an_1000_val</span><span class="p">);</span>

	<span class="n">bnx2x_ext_phy_set_pause</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">vars</span><span class="p">);</span>
	<span class="n">bnx2x_cl45_read</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
			<span class="n">MDIO_AN_DEVAD</span><span class="p">,</span>
			<span class="n">MDIO_AN_REG_8481_LEGACY_AN_ADV</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">an_10_100_val</span><span class="p">);</span>
	<span class="n">bnx2x_cl45_read</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
			<span class="n">MDIO_AN_DEVAD</span><span class="p">,</span> <span class="n">MDIO_AN_REG_8481_LEGACY_MII_CTRL</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">autoneg_val</span><span class="p">);</span>
	<span class="cm">/* Disable forced speed */</span>
	<span class="n">autoneg_val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">((</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">6</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">9</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">12</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">13</span><span class="p">));</span>
	<span class="n">an_10_100_val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">((</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">6</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">7</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">8</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(((</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">req_line_speed</span> <span class="o">==</span> <span class="n">SPEED_AUTO_NEG</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	     <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">speed_cap_mask</span> <span class="o">&amp;</span>
	     <span class="n">PORT_HW_CFG_SPEED_CAPABILITY_D0_1G</span><span class="p">))</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">req_line_speed</span> <span class="o">==</span> <span class="n">SPEED_1000</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">an_1000_val</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">8</span><span class="p">);</span>
		<span class="n">autoneg_val</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">9</span> <span class="o">|</span> <span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">12</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">req_duplex</span> <span class="o">==</span> <span class="n">DUPLEX_FULL</span><span class="p">)</span>
			<span class="n">an_1000_val</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">9</span><span class="p">);</span>
		<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;Advertising 1G</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">an_1000_val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">((</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">9</span><span class="p">));</span>

	<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
			 <span class="n">MDIO_AN_DEVAD</span><span class="p">,</span> <span class="n">MDIO_AN_REG_8481_1000T_CTRL</span><span class="p">,</span>
			 <span class="n">an_1000_val</span><span class="p">);</span>

	<span class="cm">/* set 100 speed advertisement */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">req_line_speed</span> <span class="o">==</span> <span class="n">SPEED_AUTO_NEG</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	     <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">speed_cap_mask</span> <span class="o">&amp;</span>
	      <span class="p">(</span><span class="n">PORT_HW_CFG_SPEED_CAPABILITY_D0_100M_FULL</span> <span class="o">|</span>
	       <span class="n">PORT_HW_CFG_SPEED_CAPABILITY_D0_100M_HALF</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">an_10_100_val</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">7</span><span class="p">);</span>
		<span class="cm">/* Enable autoneg and restart autoneg for legacy speeds */</span>
		<span class="n">autoneg_val</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">9</span> <span class="o">|</span> <span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">12</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">req_duplex</span> <span class="o">==</span> <span class="n">DUPLEX_FULL</span><span class="p">)</span>
			<span class="n">an_10_100_val</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">8</span><span class="p">);</span>
		<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;Advertising 100M</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/* set 10 speed advertisement */</span>
	<span class="k">if</span> <span class="p">(((</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">req_line_speed</span> <span class="o">==</span> <span class="n">SPEED_AUTO_NEG</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	     <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">speed_cap_mask</span> <span class="o">&amp;</span>
	      <span class="p">(</span><span class="n">PORT_HW_CFG_SPEED_CAPABILITY_D0_10M_FULL</span> <span class="o">|</span>
	       <span class="n">PORT_HW_CFG_SPEED_CAPABILITY_D0_10M_HALF</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
	     <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">supported</span> <span class="o">&amp;</span>
	      <span class="p">(</span><span class="n">SUPPORTED_10baseT_Half</span> <span class="o">|</span>
	       <span class="n">SUPPORTED_10baseT_Full</span><span class="p">))))</span> <span class="p">{</span>
		<span class="n">an_10_100_val</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">5</span><span class="p">);</span>
		<span class="n">autoneg_val</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">9</span> <span class="o">|</span> <span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">12</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">req_duplex</span> <span class="o">==</span> <span class="n">DUPLEX_FULL</span><span class="p">)</span>
			<span class="n">an_10_100_val</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">6</span><span class="p">);</span>
		<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;Advertising 10M</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Only 10/100 are allowed to work in FORCE mode */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">req_line_speed</span> <span class="o">==</span> <span class="n">SPEED_100</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">supported</span> <span class="o">&amp;</span>
	     <span class="p">(</span><span class="n">SUPPORTED_100baseT_Half</span> <span class="o">|</span>
	      <span class="n">SUPPORTED_100baseT_Full</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">autoneg_val</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">13</span><span class="p">);</span>
		<span class="cm">/* Enabled AUTO-MDIX when autoneg is disabled */</span>
		<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
				 <span class="n">MDIO_AN_DEVAD</span><span class="p">,</span> <span class="n">MDIO_AN_REG_8481_AUX_CTRL</span><span class="p">,</span>
				 <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">15</span> <span class="o">|</span> <span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">9</span> <span class="o">|</span> <span class="mi">7</span><span class="o">&lt;&lt;</span><span class="mi">0</span><span class="p">));</span>
		<span class="cm">/* The PHY needs this set even for forced link. */</span>
		<span class="n">an_10_100_val</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">7</span><span class="p">);</span>
		<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;Setting 100M force</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">req_line_speed</span> <span class="o">==</span> <span class="n">SPEED_10</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">supported</span> <span class="o">&amp;</span>
	     <span class="p">(</span><span class="n">SUPPORTED_10baseT_Half</span> <span class="o">|</span>
	      <span class="n">SUPPORTED_10baseT_Full</span><span class="p">)))</span> <span class="p">{</span>
		<span class="cm">/* Enabled AUTO-MDIX when autoneg is disabled */</span>
		<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
				 <span class="n">MDIO_AN_DEVAD</span><span class="p">,</span> <span class="n">MDIO_AN_REG_8481_AUX_CTRL</span><span class="p">,</span>
				 <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">15</span> <span class="o">|</span> <span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">9</span> <span class="o">|</span> <span class="mi">7</span><span class="o">&lt;&lt;</span><span class="mi">0</span><span class="p">));</span>
		<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;Setting 10M force</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
			 <span class="n">MDIO_AN_DEVAD</span><span class="p">,</span> <span class="n">MDIO_AN_REG_8481_LEGACY_AN_ADV</span><span class="p">,</span>
			 <span class="n">an_10_100_val</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">req_duplex</span> <span class="o">==</span> <span class="n">DUPLEX_FULL</span><span class="p">)</span>
		<span class="n">autoneg_val</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">8</span><span class="p">);</span>

	<span class="cm">/* Always write this if this is not 84833.</span>
<span class="cm">	 * For 84833, write it only when it&#39;s a forced speed.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">PORT_HW_CFG_XGXS_EXT_PHY_TYPE_BCM84833</span><span class="p">)</span> <span class="o">||</span>
		<span class="p">((</span><span class="n">autoneg_val</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">12</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span>
		<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
			 <span class="n">MDIO_AN_DEVAD</span><span class="p">,</span>
			 <span class="n">MDIO_AN_REG_8481_LEGACY_MII_CTRL</span><span class="p">,</span> <span class="n">autoneg_val</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(((</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">req_line_speed</span> <span class="o">==</span> <span class="n">SPEED_AUTO_NEG</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">speed_cap_mask</span> <span class="o">&amp;</span>
	     <span class="n">PORT_HW_CFG_SPEED_CAPABILITY_D0_10G</span><span class="p">))</span> <span class="o">||</span>
		<span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">req_line_speed</span> <span class="o">==</span> <span class="n">SPEED_10000</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;Advertising 10G</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="cm">/* Restart autoneg for 10G*/</span>

			<span class="n">bnx2x_cl45_read</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
					<span class="n">MDIO_AN_DEVAD</span><span class="p">,</span>
					<span class="n">MDIO_AN_REG_8481_10GBASE_T_AN_CTRL</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">an_10g_val</span><span class="p">);</span>
			<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
					 <span class="n">MDIO_AN_DEVAD</span><span class="p">,</span>
					 <span class="n">MDIO_AN_REG_8481_10GBASE_T_AN_CTRL</span><span class="p">,</span>
					 <span class="n">an_10g_val</span> <span class="o">|</span> <span class="mh">0x1000</span><span class="p">);</span>
			<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
					 <span class="n">MDIO_AN_DEVAD</span><span class="p">,</span> <span class="n">MDIO_AN_REG_CTRL</span><span class="p">,</span>
					 <span class="mh">0x3200</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
				 <span class="n">MDIO_AN_DEVAD</span><span class="p">,</span>
				 <span class="n">MDIO_AN_REG_8481_10GBASE_T_AN_CTRL</span><span class="p">,</span>
				 <span class="mi">1</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bnx2x_8481_config_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x_phy</span> <span class="o">*</span><span class="n">phy</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">link_params</span> <span class="o">*</span><span class="n">params</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">link_vars</span> <span class="o">*</span><span class="n">vars</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">bp</span><span class="p">;</span>
	<span class="cm">/* Restore normal power mode*/</span>
	<span class="n">bnx2x_set_gpio</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">MISC_REGISTERS_GPIO_2</span><span class="p">,</span>
		       <span class="n">MISC_REGISTERS_GPIO_OUTPUT_HIGH</span><span class="p">,</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">);</span>

	<span class="cm">/* HW reset */</span>
	<span class="n">bnx2x_ext_phy_hw_reset</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">);</span>
	<span class="n">bnx2x_wait_reset_complete</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">params</span><span class="p">);</span>

	<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_PMA_DEVAD</span><span class="p">,</span> <span class="n">MDIO_PMA_REG_CTRL</span><span class="p">,</span> <span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">15</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">bnx2x_848xx_cmn_config_init</span><span class="p">(</span><span class="n">phy</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">vars</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#define PHY84833_CMDHDLR_WAIT 300</span>
<span class="cp">#define PHY84833_CMDHDLR_MAX_ARGS 5</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">bnx2x_84833_cmd_hdlr</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x_phy</span> <span class="o">*</span><span class="n">phy</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">link_params</span> <span class="o">*</span><span class="n">params</span><span class="p">,</span>
		   <span class="n">u16</span> <span class="n">fw_cmd</span><span class="p">,</span>
		   <span class="n">u16</span> <span class="n">cmd_args</span><span class="p">[])</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">idx</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">val</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">bp</span><span class="p">;</span>
	<span class="cm">/* Write CMD_OPEN_OVERRIDE to STATUS reg */</span>
	<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_CTL_DEVAD</span><span class="p">,</span>
			<span class="n">MDIO_84833_CMD_HDLR_STATUS</span><span class="p">,</span>
			<span class="n">PHY84833_STATUS_CMD_OPEN_OVERRIDE</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">PHY84833_CMDHDLR_WAIT</span><span class="p">;</span> <span class="n">idx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bnx2x_cl45_read</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_CTL_DEVAD</span><span class="p">,</span>
				<span class="n">MDIO_84833_CMD_HDLR_STATUS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">==</span> <span class="n">PHY84833_STATUS_CMD_OPEN_FOR_CMDS</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">idx</span> <span class="o">&gt;=</span> <span class="n">PHY84833_CMDHDLR_WAIT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;FW cmd: FW not ready.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Prepare argument(s) and issue command */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">PHY84833_CMDHDLR_MAX_ARGS</span><span class="p">;</span> <span class="n">idx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_CTL_DEVAD</span><span class="p">,</span>
				<span class="n">MDIO_84833_CMD_HDLR_DATA1</span> <span class="o">+</span> <span class="n">idx</span><span class="p">,</span>
				<span class="n">cmd_args</span><span class="p">[</span><span class="n">idx</span><span class="p">]);</span>
	<span class="p">}</span>
	<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_CTL_DEVAD</span><span class="p">,</span>
			<span class="n">MDIO_84833_CMD_HDLR_COMMAND</span><span class="p">,</span> <span class="n">fw_cmd</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">PHY84833_CMDHDLR_WAIT</span><span class="p">;</span> <span class="n">idx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bnx2x_cl45_read</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_CTL_DEVAD</span><span class="p">,</span>
				<span class="n">MDIO_84833_CMD_HDLR_STATUS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">val</span> <span class="o">==</span> <span class="n">PHY84833_STATUS_CMD_COMPLETE_PASS</span><span class="p">)</span> <span class="o">||</span>
			<span class="p">(</span><span class="n">val</span> <span class="o">==</span> <span class="n">PHY84833_STATUS_CMD_COMPLETE_ERROR</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">idx</span> <span class="o">&gt;=</span> <span class="n">PHY84833_CMDHDLR_WAIT</span><span class="p">)</span> <span class="o">||</span>
		<span class="p">(</span><span class="n">val</span> <span class="o">==</span> <span class="n">PHY84833_STATUS_CMD_COMPLETE_ERROR</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;FW cmd failed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* Gather returning data */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">PHY84833_CMDHDLR_MAX_ARGS</span><span class="p">;</span> <span class="n">idx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bnx2x_cl45_read</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_CTL_DEVAD</span><span class="p">,</span>
				<span class="n">MDIO_84833_CMD_HDLR_DATA1</span> <span class="o">+</span> <span class="n">idx</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">cmd_args</span><span class="p">[</span><span class="n">idx</span><span class="p">]);</span>
	<span class="p">}</span>
	<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_CTL_DEVAD</span><span class="p">,</span>
			<span class="n">MDIO_84833_CMD_HDLR_STATUS</span><span class="p">,</span>
			<span class="n">PHY84833_STATUS_CMD_CLEAR_COMPLETE</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">bnx2x_84833_pair_swap_cfg</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x_phy</span> <span class="o">*</span><span class="n">phy</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">link_params</span> <span class="o">*</span><span class="n">params</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">link_vars</span> <span class="o">*</span><span class="n">vars</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">pair_swap</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">data</span><span class="p">[</span><span class="n">PHY84833_CMDHDLR_MAX_ARGS</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">bp</span><span class="p">;</span>

	<span class="cm">/* Check for configuration. */</span>
	<span class="n">pair_swap</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">shmem_base</span> <span class="o">+</span>
			   <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">shmem_region</span><span class="p">,</span>
			<span class="n">dev_info</span><span class="p">.</span><span class="n">port_hw_config</span><span class="p">[</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">].</span><span class="n">xgbt_phy_cfg</span><span class="p">))</span> <span class="o">&amp;</span>
		<span class="n">PORT_HW_CFG_RJ45_PAIR_SWAP_MASK</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pair_swap</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Only the second argument is used for this command */</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span><span class="n">pair_swap</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">bnx2x_84833_cmd_hdlr</span><span class="p">(</span><span class="n">phy</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span>
		<span class="n">PHY84833_CMD_SET_PAIR_SWAP</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;Pairswap OK, val=0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u8</span> <span class="nf">bnx2x_84833_get_reset_gpios</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">,</span>
				      <span class="n">u32</span> <span class="n">shmem_base_path</span><span class="p">[],</span>
				      <span class="n">u32</span> <span class="n">chip_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">reset_pin</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="n">u32</span> <span class="n">idx</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">reset_gpios</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">CHIP_IS_E3</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Assume that these will be GPIOs, not EPIOs. */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">idx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Map config param to register bit. */</span>
			<span class="n">reset_pin</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">shmem_base_path</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">+</span>
				<span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">shmem_region</span><span class="p">,</span>
				<span class="n">dev_info</span><span class="p">.</span><span class="n">port_hw_config</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">e3_cmn_pin_cfg</span><span class="p">));</span>
			<span class="n">reset_pin</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">reset_pin</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">&amp;</span>
				<span class="n">PORT_HW_CFG_E3_PHY_RESET_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span>
				<span class="n">PORT_HW_CFG_E3_PHY_RESET_SHIFT</span><span class="p">;</span>
			<span class="n">reset_pin</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">-=</span> <span class="n">PIN_CFG_GPIO0_P0</span><span class="p">;</span>
			<span class="n">reset_pin</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">reset_pin</span><span class="p">[</span><span class="n">idx</span><span class="p">]);</span>
		<span class="p">}</span>
		<span class="n">reset_gpios</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)(</span><span class="n">reset_pin</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|</span> <span class="n">reset_pin</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* E2, look from diff place of shmem. */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">idx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">reset_pin</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">shmem_base_path</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">+</span>
				<span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">shmem_region</span><span class="p">,</span>
				<span class="n">dev_info</span><span class="p">.</span><span class="n">port_hw_config</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">default_cfg</span><span class="p">));</span>
			<span class="n">reset_pin</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="n">PORT_HW_CFG_EXT_PHY_GPIO_RST_MASK</span><span class="p">;</span>
			<span class="n">reset_pin</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">-=</span> <span class="n">PORT_HW_CFG_EXT_PHY_GPIO_RST_GPIO0_P0</span><span class="p">;</span>
			<span class="n">reset_pin</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">&gt;&gt;=</span> <span class="n">PORT_HW_CFG_EXT_PHY_GPIO_RST_SHIFT</span><span class="p">;</span>
			<span class="n">reset_pin</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">reset_pin</span><span class="p">[</span><span class="n">idx</span><span class="p">]);</span>
		<span class="p">}</span>
		<span class="n">reset_gpios</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)(</span><span class="n">reset_pin</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|</span> <span class="n">reset_pin</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">reset_gpios</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bnx2x_84833_hw_reset_phy</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x_phy</span> <span class="o">*</span><span class="n">phy</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">link_params</span> <span class="o">*</span><span class="n">params</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">bp</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">reset_gpios</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">other_shmem_base_addr</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">shmem2_base</span> <span class="o">+</span>
				<span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">shmem2_region</span><span class="p">,</span>
				<span class="n">other_shmem_base_addr</span><span class="p">));</span>

	<span class="n">u32</span> <span class="n">shmem_base_path</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>

	<span class="cm">/* Work around for 84833 LED failure inside RESET status */</span>
	<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_AN_DEVAD</span><span class="p">,</span>
		<span class="n">MDIO_AN_REG_8481_LEGACY_MII_CTRL</span><span class="p">,</span>
		<span class="n">MDIO_AN_REG_8481_MII_CTRL_FORCE_1G</span><span class="p">);</span>
	<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_AN_DEVAD</span><span class="p">,</span>
		<span class="n">MDIO_AN_REG_8481_1G_100T_EXT_CTRL</span><span class="p">,</span>
		<span class="n">MIDO_AN_REG_8481_EXT_CTRL_FORCE_LEDS_OFF</span><span class="p">);</span>

	<span class="n">shmem_base_path</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">shmem_base</span><span class="p">;</span>
	<span class="n">shmem_base_path</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">other_shmem_base_addr</span><span class="p">;</span>

	<span class="n">reset_gpios</span> <span class="o">=</span> <span class="n">bnx2x_84833_get_reset_gpios</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">shmem_base_path</span><span class="p">,</span>
						  <span class="n">params</span><span class="o">-&gt;</span><span class="n">chip_id</span><span class="p">);</span>

	<span class="n">bnx2x_set_mult_gpio</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">reset_gpios</span><span class="p">,</span> <span class="n">MISC_REGISTERS_GPIO_OUTPUT_LOW</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;84833 hw reset on pin values 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">reset_gpios</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define PHY84833_CONSTANT_LATENCY 1193</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">bnx2x_848x3_config_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x_phy</span> <span class="o">*</span><span class="n">phy</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">link_params</span> <span class="o">*</span><span class="n">params</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">link_vars</span> <span class="o">*</span><span class="n">vars</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">bp</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">port</span><span class="p">,</span> <span class="n">initialize</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">val</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">actual_phy_selection</span><span class="p">,</span> <span class="n">cms_enable</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">cmd_args</span><span class="p">[</span><span class="n">PHY84833_CMDHDLR_MAX_ARGS</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">msleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">CHIP_IS_E1x</span><span class="p">(</span><span class="n">bp</span><span class="p">)))</span>
		<span class="n">port</span> <span class="o">=</span> <span class="n">BP_PATH</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">port</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">PORT_HW_CFG_XGXS_EXT_PHY_TYPE_BCM84823</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bnx2x_set_gpio</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">MISC_REGISTERS_GPIO_3</span><span class="p">,</span>
			       <span class="n">MISC_REGISTERS_GPIO_OUTPUT_HIGH</span><span class="p">,</span>
			       <span class="n">port</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* MDIO reset */</span>
		<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
				<span class="n">MDIO_PMA_DEVAD</span><span class="p">,</span>
				<span class="n">MDIO_PMA_REG_CTRL</span><span class="p">,</span> <span class="mh">0x8000</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">bnx2x_wait_reset_complete</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">params</span><span class="p">);</span>

	<span class="cm">/* Wait for GPHY to come out of reset */</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">50</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">PORT_HW_CFG_XGXS_EXT_PHY_TYPE_BCM84833</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* BCM84823 requires that XGXS links up first @ 10G for normal</span>
<span class="cm">		 * behavior.</span>
<span class="cm">		 */</span>
		<span class="n">u16</span> <span class="n">temp</span><span class="p">;</span>
		<span class="n">temp</span> <span class="o">=</span> <span class="n">vars</span><span class="o">-&gt;</span><span class="n">line_speed</span><span class="p">;</span>
		<span class="n">vars</span><span class="o">-&gt;</span><span class="n">line_speed</span> <span class="o">=</span> <span class="n">SPEED_10000</span><span class="p">;</span>
		<span class="n">bnx2x_set_autoneg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">[</span><span class="n">INT_PHY</span><span class="p">],</span> <span class="n">params</span><span class="p">,</span> <span class="n">vars</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">bnx2x_program_serdes</span><span class="p">(</span><span class="o">&amp;</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">[</span><span class="n">INT_PHY</span><span class="p">],</span> <span class="n">params</span><span class="p">,</span> <span class="n">vars</span><span class="p">);</span>
		<span class="n">vars</span><span class="o">-&gt;</span><span class="n">line_speed</span> <span class="o">=</span> <span class="n">temp</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">bnx2x_cl45_read</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_CTL_DEVAD</span><span class="p">,</span>
			<span class="n">MDIO_CTL_REG_84823_MEDIA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">MDIO_CTL_REG_84823_MEDIA_MAC_MASK</span> <span class="o">|</span>
		 <span class="n">MDIO_CTL_REG_84823_MEDIA_LINE_MASK</span> <span class="o">|</span>
		 <span class="n">MDIO_CTL_REG_84823_MEDIA_COPPER_CORE_DOWN</span> <span class="o">|</span>
		 <span class="n">MDIO_CTL_REG_84823_MEDIA_PRIORITY_MASK</span> <span class="o">|</span>
		 <span class="n">MDIO_CTL_REG_84823_MEDIA_FIBER_1G</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">CHIP_IS_E3</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">MDIO_CTL_REG_84823_MEDIA_MAC_MASK</span> <span class="o">|</span>
			 <span class="n">MDIO_CTL_REG_84823_MEDIA_LINE_MASK</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="p">(</span><span class="n">MDIO_CTL_REG_84823_CTRL_MAC_XFI</span> <span class="o">|</span>
			<span class="n">MDIO_CTL_REG_84823_MEDIA_LINE_XAUI_L</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">actual_phy_selection</span> <span class="o">=</span> <span class="n">bnx2x_phy_selection</span><span class="p">(</span><span class="n">params</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">actual_phy_selection</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PORT_HW_CFG_PHY_SELECTION_HARDWARE_DEFAULT</span>:
		<span class="cm">/* Do nothing. Essentially this is like the priority copper */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PORT_HW_CFG_PHY_SELECTION_FIRST_PHY_PRIORITY</span>:
		<span class="n">val</span> <span class="o">|=</span> <span class="n">MDIO_CTL_REG_84823_MEDIA_PRIORITY_COPPER</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PORT_HW_CFG_PHY_SELECTION_SECOND_PHY_PRIORITY</span>:
		<span class="n">val</span> <span class="o">|=</span> <span class="n">MDIO_CTL_REG_84823_MEDIA_PRIORITY_FIBER</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PORT_HW_CFG_PHY_SELECTION_FIRST_PHY</span>:
		<span class="cm">/* Do nothing here. The first PHY won&#39;t be initialized at all */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PORT_HW_CFG_PHY_SELECTION_SECOND_PHY</span>:
		<span class="n">val</span> <span class="o">|=</span> <span class="n">MDIO_CTL_REG_84823_MEDIA_COPPER_CORE_DOWN</span><span class="p">;</span>
		<span class="n">initialize</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">[</span><span class="n">EXT_PHY2</span><span class="p">].</span><span class="n">req_line_speed</span> <span class="o">==</span> <span class="n">SPEED_1000</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">MDIO_CTL_REG_84823_MEDIA_FIBER_1G</span><span class="p">;</span>

	<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_CTL_DEVAD</span><span class="p">,</span>
			 <span class="n">MDIO_CTL_REG_84823_MEDIA</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;Multi_phy config = 0x%x, Media control = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">params</span><span class="o">-&gt;</span><span class="n">multi_phy_config</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">PORT_HW_CFG_XGXS_EXT_PHY_TYPE_BCM84833</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bnx2x_84833_pair_swap_cfg</span><span class="p">(</span><span class="n">phy</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">vars</span><span class="p">);</span>

		<span class="cm">/* Keep AutogrEEEn disabled. */</span>
		<span class="n">cmd_args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>
		<span class="n">cmd_args</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>
		<span class="n">cmd_args</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">PHY84833_CONSTANT_LATENCY</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">cmd_args</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">PHY84833_CONSTANT_LATENCY</span><span class="p">;</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">bnx2x_84833_cmd_hdlr</span><span class="p">(</span><span class="n">phy</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span>
			<span class="n">PHY84833_CMD_SET_EEE_MODE</span><span class="p">,</span> <span class="n">cmd_args</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;Cfg AutogrEEEn failed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">initialize</span><span class="p">)</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">bnx2x_848xx_cmn_config_init</span><span class="p">(</span><span class="n">phy</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">vars</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">bnx2x_save_848xx_spirom_version</span><span class="p">(</span><span class="n">phy</span><span class="p">,</span> <span class="n">bp</span><span class="p">,</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">);</span>
	<span class="cm">/* 84833 PHY has a better feature and doesn&#39;t need to support this. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">PORT_HW_CFG_XGXS_EXT_PHY_TYPE_BCM84823</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cms_enable</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">shmem_base</span> <span class="o">+</span>
			<span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">shmem_region</span><span class="p">,</span>
			<span class="n">dev_info</span><span class="p">.</span><span class="n">port_hw_config</span><span class="p">[</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">].</span><span class="n">default_cfg</span><span class="p">))</span> <span class="o">&amp;</span>
			<span class="n">PORT_HW_CFG_ENABLE_CMS_MASK</span><span class="p">;</span>

		<span class="n">bnx2x_cl45_read</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_CTL_DEVAD</span><span class="p">,</span>
				<span class="n">MDIO_CTL_REG_84823_USER_CTRL_REG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cms_enable</span><span class="p">)</span>
			<span class="n">val</span> <span class="o">|=</span> <span class="n">MDIO_CTL_REG_84823_USER_CTRL_CMS</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MDIO_CTL_REG_84823_USER_CTRL_CMS</span><span class="p">;</span>
		<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_CTL_DEVAD</span><span class="p">,</span>
				 <span class="n">MDIO_CTL_REG_84823_USER_CTRL_REG</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">PORT_HW_CFG_XGXS_EXT_PHY_TYPE_BCM84833</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Bring PHY out of super isolate mode as the final step. */</span>
		<span class="n">bnx2x_cl45_read</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
				<span class="n">MDIO_CTL_DEVAD</span><span class="p">,</span>
				<span class="n">MDIO_84833_TOP_CFG_XGPHY_STRAP1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
		<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MDIO_84833_SUPER_ISOLATE</span><span class="p">;</span>
		<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
				<span class="n">MDIO_CTL_DEVAD</span><span class="p">,</span>
				<span class="n">MDIO_84833_TOP_CFG_XGPHY_STRAP1</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u8</span> <span class="nf">bnx2x_848xx_read_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x_phy</span> <span class="o">*</span><span class="n">phy</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">link_params</span> <span class="o">*</span><span class="n">params</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">link_vars</span> <span class="o">*</span><span class="n">vars</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">bp</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">val</span><span class="p">,</span> <span class="n">val1</span><span class="p">,</span> <span class="n">val2</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">link_up</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>


	<span class="cm">/* Check 10G-BaseT link status */</span>
	<span class="cm">/* Check PMD signal ok */</span>
	<span class="n">bnx2x_cl45_read</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
			<span class="n">MDIO_AN_DEVAD</span><span class="p">,</span> <span class="mh">0xFFFA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val1</span><span class="p">);</span>
	<span class="n">bnx2x_cl45_read</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
			<span class="n">MDIO_PMA_DEVAD</span><span class="p">,</span> <span class="n">MDIO_PMA_REG_8481_PMD_SIGNAL</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">val2</span><span class="p">);</span>
	<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;BCM848xx: PMD_SIGNAL 1.a811 = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">val2</span><span class="p">);</span>

	<span class="cm">/* Check link 10G */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val2</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">11</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">vars</span><span class="o">-&gt;</span><span class="n">line_speed</span> <span class="o">=</span> <span class="n">SPEED_10000</span><span class="p">;</span>
		<span class="n">vars</span><span class="o">-&gt;</span><span class="n">duplex</span> <span class="o">=</span> <span class="n">DUPLEX_FULL</span><span class="p">;</span>
		<span class="n">link_up</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">bnx2x_ext_phy_10G_an_resolve</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">vars</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="cm">/* Check Legacy speed link */</span>
		<span class="n">u16</span> <span class="n">legacy_status</span><span class="p">,</span> <span class="n">legacy_speed</span><span class="p">;</span>

		<span class="cm">/* Enable expansion register 0x42 (Operation mode status) */</span>
		<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
				 <span class="n">MDIO_AN_DEVAD</span><span class="p">,</span>
				 <span class="n">MDIO_AN_REG_8481_EXPANSION_REG_ACCESS</span><span class="p">,</span> <span class="mh">0xf42</span><span class="p">);</span>

		<span class="cm">/* Get legacy speed operation status */</span>
		<span class="n">bnx2x_cl45_read</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
				<span class="n">MDIO_AN_DEVAD</span><span class="p">,</span>
				<span class="n">MDIO_AN_REG_8481_EXPANSION_REG_RD_RW</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">legacy_status</span><span class="p">);</span>

		<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;Legacy speed status = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">legacy_status</span><span class="p">);</span>
		<span class="n">link_up</span> <span class="o">=</span> <span class="p">((</span><span class="n">legacy_status</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">11</span><span class="p">))</span> <span class="o">==</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">11</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">link_up</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">legacy_speed</span> <span class="o">=</span> <span class="p">(</span><span class="n">legacy_status</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">3</span><span class="o">&lt;&lt;</span><span class="mi">9</span><span class="p">));</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">legacy_speed</span> <span class="o">==</span> <span class="p">(</span><span class="mi">0</span><span class="o">&lt;&lt;</span><span class="mi">9</span><span class="p">))</span>
				<span class="n">vars</span><span class="o">-&gt;</span><span class="n">line_speed</span> <span class="o">=</span> <span class="n">SPEED_10</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">legacy_speed</span> <span class="o">==</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">9</span><span class="p">))</span>
				<span class="n">vars</span><span class="o">-&gt;</span><span class="n">line_speed</span> <span class="o">=</span> <span class="n">SPEED_100</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">legacy_speed</span> <span class="o">==</span> <span class="p">(</span><span class="mi">2</span><span class="o">&lt;&lt;</span><span class="mi">9</span><span class="p">))</span>
				<span class="n">vars</span><span class="o">-&gt;</span><span class="n">line_speed</span> <span class="o">=</span> <span class="n">SPEED_1000</span><span class="p">;</span>
			<span class="k">else</span> <span class="cm">/* Should not happen */</span>
				<span class="n">vars</span><span class="o">-&gt;</span><span class="n">line_speed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">legacy_status</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">8</span><span class="p">))</span>
				<span class="n">vars</span><span class="o">-&gt;</span><span class="n">duplex</span> <span class="o">=</span> <span class="n">DUPLEX_FULL</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">vars</span><span class="o">-&gt;</span><span class="n">duplex</span> <span class="o">=</span> <span class="n">DUPLEX_HALF</span><span class="p">;</span>

			<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span>
			   <span class="s">&quot;Link is up in %dMbps, is_duplex_full= %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">vars</span><span class="o">-&gt;</span><span class="n">line_speed</span><span class="p">,</span>
			   <span class="p">(</span><span class="n">vars</span><span class="o">-&gt;</span><span class="n">duplex</span> <span class="o">==</span> <span class="n">DUPLEX_FULL</span><span class="p">));</span>
			<span class="cm">/* Check legacy speed AN resolution */</span>
			<span class="n">bnx2x_cl45_read</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
					<span class="n">MDIO_AN_DEVAD</span><span class="p">,</span>
					<span class="n">MDIO_AN_REG_8481_LEGACY_MII_STATUS</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">5</span><span class="p">))</span>
				<span class="n">vars</span><span class="o">-&gt;</span><span class="n">link_status</span> <span class="o">|=</span>
					<span class="n">LINK_STATUS_AUTO_NEGOTIATE_COMPLETE</span><span class="p">;</span>
			<span class="n">bnx2x_cl45_read</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
					<span class="n">MDIO_AN_DEVAD</span><span class="p">,</span>
					<span class="n">MDIO_AN_REG_8481_LEGACY_AN_EXPANSION</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">val</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">0</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">vars</span><span class="o">-&gt;</span><span class="n">link_status</span> <span class="o">|=</span>
					<span class="n">LINK_STATUS_PARALLEL_DETECTION_USED</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">link_up</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;BCM84823: link speed is %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">vars</span><span class="o">-&gt;</span><span class="n">line_speed</span><span class="p">);</span>
		<span class="n">bnx2x_ext_phy_resolve_fc</span><span class="p">(</span><span class="n">phy</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">vars</span><span class="p">);</span>

		<span class="cm">/* Read LP advertised speeds */</span>
		<span class="n">bnx2x_cl45_read</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_AN_DEVAD</span><span class="p">,</span>
				<span class="n">MDIO_AN_REG_CL37_FC_LP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">5</span><span class="p">))</span>
			<span class="n">vars</span><span class="o">-&gt;</span><span class="n">link_status</span> <span class="o">|=</span>
				<span class="n">LINK_STATUS_LINK_PARTNER_10THD_CAPABLE</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">6</span><span class="p">))</span>
			<span class="n">vars</span><span class="o">-&gt;</span><span class="n">link_status</span> <span class="o">|=</span>
				<span class="n">LINK_STATUS_LINK_PARTNER_10TFD_CAPABLE</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">7</span><span class="p">))</span>
			<span class="n">vars</span><span class="o">-&gt;</span><span class="n">link_status</span> <span class="o">|=</span>
				<span class="n">LINK_STATUS_LINK_PARTNER_100TXHD_CAPABLE</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">8</span><span class="p">))</span>
			<span class="n">vars</span><span class="o">-&gt;</span><span class="n">link_status</span> <span class="o">|=</span>
				<span class="n">LINK_STATUS_LINK_PARTNER_100TXFD_CAPABLE</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">9</span><span class="p">))</span>
			<span class="n">vars</span><span class="o">-&gt;</span><span class="n">link_status</span> <span class="o">|=</span>
				<span class="n">LINK_STATUS_LINK_PARTNER_100T4_CAPABLE</span><span class="p">;</span>

		<span class="n">bnx2x_cl45_read</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_AN_DEVAD</span><span class="p">,</span>
				<span class="n">MDIO_AN_REG_1000T_STATUS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">10</span><span class="p">))</span>
			<span class="n">vars</span><span class="o">-&gt;</span><span class="n">link_status</span> <span class="o">|=</span>
				<span class="n">LINK_STATUS_LINK_PARTNER_1000THD_CAPABLE</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">11</span><span class="p">))</span>
			<span class="n">vars</span><span class="o">-&gt;</span><span class="n">link_status</span> <span class="o">|=</span>
				<span class="n">LINK_STATUS_LINK_PARTNER_1000TFD_CAPABLE</span><span class="p">;</span>

		<span class="n">bnx2x_cl45_read</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_AN_DEVAD</span><span class="p">,</span>
				<span class="n">MDIO_AN_REG_MASTER_STATUS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">11</span><span class="p">))</span>
			<span class="n">vars</span><span class="o">-&gt;</span><span class="n">link_status</span> <span class="o">|=</span>
				<span class="n">LINK_STATUS_LINK_PARTNER_10GXFD_CAPABLE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">link_up</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">bnx2x_848xx_format_ver</span><span class="p">(</span><span class="n">u32</span> <span class="n">raw_ver</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">str</span><span class="p">,</span> <span class="n">u16</span> <span class="o">*</span><span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">spirom_ver</span><span class="p">;</span>
	<span class="n">spirom_ver</span> <span class="o">=</span> <span class="p">((</span><span class="n">raw_ver</span> <span class="o">&amp;</span> <span class="mh">0xF80</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span> <span class="o">|</span> <span class="p">(</span><span class="n">raw_ver</span> <span class="o">&amp;</span> <span class="mh">0x7F</span><span class="p">);</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">bnx2x_format_ver</span><span class="p">(</span><span class="n">spirom_ver</span><span class="p">,</span> <span class="n">str</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_8481_hw_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x_phy</span> <span class="o">*</span><span class="n">phy</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">link_params</span> <span class="o">*</span><span class="n">params</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bnx2x_set_gpio</span><span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">bp</span><span class="p">,</span> <span class="n">MISC_REGISTERS_GPIO_1</span><span class="p">,</span>
		       <span class="n">MISC_REGISTERS_GPIO_OUTPUT_LOW</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">bnx2x_set_gpio</span><span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">bp</span><span class="p">,</span> <span class="n">MISC_REGISTERS_GPIO_1</span><span class="p">,</span>
		       <span class="n">MISC_REGISTERS_GPIO_OUTPUT_LOW</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_8481_link_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x_phy</span> <span class="o">*</span><span class="n">phy</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">link_params</span> <span class="o">*</span><span class="n">params</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
			 <span class="n">MDIO_AN_DEVAD</span><span class="p">,</span> <span class="n">MDIO_AN_REG_CTRL</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
	<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
			 <span class="n">MDIO_PMA_DEVAD</span><span class="p">,</span> <span class="n">MDIO_PMA_REG_CTRL</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_848x3_link_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x_phy</span> <span class="o">*</span><span class="n">phy</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">link_params</span> <span class="o">*</span><span class="n">params</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">bp</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">port</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">val16</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">CHIP_IS_E1x</span><span class="p">(</span><span class="n">bp</span><span class="p">)))</span>
		<span class="n">port</span> <span class="o">=</span> <span class="n">BP_PATH</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">port</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">PORT_HW_CFG_XGXS_EXT_PHY_TYPE_BCM84823</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bnx2x_set_gpio</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">MISC_REGISTERS_GPIO_3</span><span class="p">,</span>
			       <span class="n">MISC_REGISTERS_GPIO_OUTPUT_LOW</span><span class="p">,</span>
			       <span class="n">port</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">bnx2x_cl45_read</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
				<span class="n">MDIO_CTL_DEVAD</span><span class="p">,</span>
				<span class="n">MDIO_84833_TOP_CFG_XGPHY_STRAP1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val16</span><span class="p">);</span>
		<span class="n">val16</span> <span class="o">|=</span> <span class="n">MDIO_84833_SUPER_ISOLATE</span><span class="p">;</span>
		<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
				 <span class="n">MDIO_CTL_DEVAD</span><span class="p">,</span>
				 <span class="n">MDIO_84833_TOP_CFG_XGPHY_STRAP1</span><span class="p">,</span> <span class="n">val16</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_848xx_set_link_led</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x_phy</span> <span class="o">*</span><span class="n">phy</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">link_params</span> <span class="o">*</span><span class="n">params</span><span class="p">,</span> <span class="n">u8</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">bp</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">val</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">port</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">CHIP_IS_E1x</span><span class="p">(</span><span class="n">bp</span><span class="p">)))</span>
		<span class="n">port</span> <span class="o">=</span> <span class="n">BP_PATH</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">port</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">LED_MODE_OFF</span>:

		<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;Port 0x%x: LED MODE OFF</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">hw_led_mode</span> <span class="o">&lt;&lt;</span> <span class="n">SHARED_HW_CFG_LED_MODE_SHIFT</span><span class="p">)</span> <span class="o">==</span>
		    <span class="n">SHARED_HW_CFG_LED_EXTPHY1</span><span class="p">)</span> <span class="p">{</span>

			<span class="cm">/* Set LED masks */</span>
			<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
					<span class="n">MDIO_PMA_DEVAD</span><span class="p">,</span>
					<span class="n">MDIO_PMA_REG_8481_LED1_MASK</span><span class="p">,</span>
					<span class="mh">0x0</span><span class="p">);</span>

			<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
					<span class="n">MDIO_PMA_DEVAD</span><span class="p">,</span>
					<span class="n">MDIO_PMA_REG_8481_LED2_MASK</span><span class="p">,</span>
					<span class="mh">0x0</span><span class="p">);</span>

			<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
					<span class="n">MDIO_PMA_DEVAD</span><span class="p">,</span>
					<span class="n">MDIO_PMA_REG_8481_LED3_MASK</span><span class="p">,</span>
					<span class="mh">0x0</span><span class="p">);</span>

			<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
					<span class="n">MDIO_PMA_DEVAD</span><span class="p">,</span>
					<span class="n">MDIO_PMA_REG_8481_LED5_MASK</span><span class="p">,</span>
					<span class="mh">0x0</span><span class="p">);</span>

		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
					 <span class="n">MDIO_PMA_DEVAD</span><span class="p">,</span>
					 <span class="n">MDIO_PMA_REG_8481_LED1_MASK</span><span class="p">,</span>
					 <span class="mh">0x0</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">LED_MODE_FRONT_PANEL_OFF</span>:

		<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;Port 0x%x: LED MODE FRONT PANEL OFF</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">port</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">hw_led_mode</span> <span class="o">&lt;&lt;</span> <span class="n">SHARED_HW_CFG_LED_MODE_SHIFT</span><span class="p">)</span> <span class="o">==</span>
		    <span class="n">SHARED_HW_CFG_LED_EXTPHY1</span><span class="p">)</span> <span class="p">{</span>

			<span class="cm">/* Set LED masks */</span>
			<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
					 <span class="n">MDIO_PMA_DEVAD</span><span class="p">,</span>
					 <span class="n">MDIO_PMA_REG_8481_LED1_MASK</span><span class="p">,</span>
					 <span class="mh">0x0</span><span class="p">);</span>

			<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
					 <span class="n">MDIO_PMA_DEVAD</span><span class="p">,</span>
					 <span class="n">MDIO_PMA_REG_8481_LED2_MASK</span><span class="p">,</span>
					 <span class="mh">0x0</span><span class="p">);</span>

			<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
					 <span class="n">MDIO_PMA_DEVAD</span><span class="p">,</span>
					 <span class="n">MDIO_PMA_REG_8481_LED3_MASK</span><span class="p">,</span>
					 <span class="mh">0x0</span><span class="p">);</span>

			<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
					 <span class="n">MDIO_PMA_DEVAD</span><span class="p">,</span>
					 <span class="n">MDIO_PMA_REG_8481_LED5_MASK</span><span class="p">,</span>
					 <span class="mh">0x20</span><span class="p">);</span>

		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
					 <span class="n">MDIO_PMA_DEVAD</span><span class="p">,</span>
					 <span class="n">MDIO_PMA_REG_8481_LED1_MASK</span><span class="p">,</span>
					 <span class="mh">0x0</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">LED_MODE_ON</span>:

		<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;Port 0x%x: LED MODE ON</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">hw_led_mode</span> <span class="o">&lt;&lt;</span> <span class="n">SHARED_HW_CFG_LED_MODE_SHIFT</span><span class="p">)</span> <span class="o">==</span>
		    <span class="n">SHARED_HW_CFG_LED_EXTPHY1</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Set control reg */</span>
			<span class="n">bnx2x_cl45_read</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
					<span class="n">MDIO_PMA_DEVAD</span><span class="p">,</span>
					<span class="n">MDIO_PMA_REG_8481_LINK_SIGNAL</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
			<span class="n">val</span> <span class="o">&amp;=</span> <span class="mh">0x8000</span><span class="p">;</span>
			<span class="n">val</span> <span class="o">|=</span> <span class="mh">0x2492</span><span class="p">;</span>

			<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
					 <span class="n">MDIO_PMA_DEVAD</span><span class="p">,</span>
					 <span class="n">MDIO_PMA_REG_8481_LINK_SIGNAL</span><span class="p">,</span>
					 <span class="n">val</span><span class="p">);</span>

			<span class="cm">/* Set LED masks */</span>
			<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
					 <span class="n">MDIO_PMA_DEVAD</span><span class="p">,</span>
					 <span class="n">MDIO_PMA_REG_8481_LED1_MASK</span><span class="p">,</span>
					 <span class="mh">0x0</span><span class="p">);</span>

			<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
					 <span class="n">MDIO_PMA_DEVAD</span><span class="p">,</span>
					 <span class="n">MDIO_PMA_REG_8481_LED2_MASK</span><span class="p">,</span>
					 <span class="mh">0x20</span><span class="p">);</span>

			<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
					 <span class="n">MDIO_PMA_DEVAD</span><span class="p">,</span>
					 <span class="n">MDIO_PMA_REG_8481_LED3_MASK</span><span class="p">,</span>
					 <span class="mh">0x20</span><span class="p">);</span>

			<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
					 <span class="n">MDIO_PMA_DEVAD</span><span class="p">,</span>
					 <span class="n">MDIO_PMA_REG_8481_LED5_MASK</span><span class="p">,</span>
					 <span class="mh">0x0</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
					 <span class="n">MDIO_PMA_DEVAD</span><span class="p">,</span>
					 <span class="n">MDIO_PMA_REG_8481_LED1_MASK</span><span class="p">,</span>
					 <span class="mh">0x20</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">LED_MODE_OPER</span>:

		<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;Port 0x%x: LED MODE OPER</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">hw_led_mode</span> <span class="o">&lt;&lt;</span> <span class="n">SHARED_HW_CFG_LED_MODE_SHIFT</span><span class="p">)</span> <span class="o">==</span>
		    <span class="n">SHARED_HW_CFG_LED_EXTPHY1</span><span class="p">)</span> <span class="p">{</span>

			<span class="cm">/* Set control reg */</span>
			<span class="n">bnx2x_cl45_read</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
					<span class="n">MDIO_PMA_DEVAD</span><span class="p">,</span>
					<span class="n">MDIO_PMA_REG_8481_LINK_SIGNAL</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">((</span><span class="n">val</span> <span class="o">&amp;</span>
			       <span class="n">MDIO_PMA_REG_8481_LINK_SIGNAL_LED4_ENABLE_MASK</span><span class="p">)</span>
			  <span class="o">&gt;&gt;</span> <span class="n">MDIO_PMA_REG_8481_LINK_SIGNAL_LED4_ENABLE_SHIFT</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;Setting LINK_SIGNAL</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
						 <span class="n">MDIO_PMA_DEVAD</span><span class="p">,</span>
						 <span class="n">MDIO_PMA_REG_8481_LINK_SIGNAL</span><span class="p">,</span>
						 <span class="mh">0xa492</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="cm">/* Set LED masks */</span>
			<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
					 <span class="n">MDIO_PMA_DEVAD</span><span class="p">,</span>
					 <span class="n">MDIO_PMA_REG_8481_LED1_MASK</span><span class="p">,</span>
					 <span class="mh">0x10</span><span class="p">);</span>

			<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
					 <span class="n">MDIO_PMA_DEVAD</span><span class="p">,</span>
					 <span class="n">MDIO_PMA_REG_8481_LED2_MASK</span><span class="p">,</span>
					 <span class="mh">0x80</span><span class="p">);</span>

			<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
					 <span class="n">MDIO_PMA_DEVAD</span><span class="p">,</span>
					 <span class="n">MDIO_PMA_REG_8481_LED3_MASK</span><span class="p">,</span>
					 <span class="mh">0x98</span><span class="p">);</span>

			<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
					 <span class="n">MDIO_PMA_DEVAD</span><span class="p">,</span>
					 <span class="n">MDIO_PMA_REG_8481_LED5_MASK</span><span class="p">,</span>
					 <span class="mh">0x40</span><span class="p">);</span>

		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
					 <span class="n">MDIO_PMA_DEVAD</span><span class="p">,</span>
					 <span class="n">MDIO_PMA_REG_8481_LED1_MASK</span><span class="p">,</span>
					 <span class="mh">0x80</span><span class="p">);</span>

			<span class="cm">/* Tell LED3 to blink on source */</span>
			<span class="n">bnx2x_cl45_read</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
					<span class="n">MDIO_PMA_DEVAD</span><span class="p">,</span>
					<span class="n">MDIO_PMA_REG_8481_LINK_SIGNAL</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
			<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">7</span><span class="o">&lt;&lt;</span><span class="mi">6</span><span class="p">);</span>
			<span class="n">val</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">6</span><span class="p">);</span> <span class="cm">/* A83B[8:6]= 1 */</span>
			<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
					 <span class="n">MDIO_PMA_DEVAD</span><span class="p">,</span>
					 <span class="n">MDIO_PMA_REG_8481_LINK_SIGNAL</span><span class="p">,</span>
					 <span class="n">val</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* This is a workaround for E3+84833 until autoneg</span>
<span class="cm">	 * restart is fixed in f/w</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">CHIP_IS_E3</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">bnx2x_cl45_read</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_WC_DEVAD</span><span class="p">,</span>
				<span class="n">MDIO_WC_REG_GP2_STATUS_GP_2_1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/******************************************************************/</span>
<span class="cm">/*			54618SE PHY SECTION			  */</span>
<span class="cm">/******************************************************************/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">bnx2x_54618se_config_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x_phy</span> <span class="o">*</span><span class="n">phy</span><span class="p">,</span>
					       <span class="k">struct</span> <span class="n">link_params</span> <span class="o">*</span><span class="n">params</span><span class="p">,</span>
					       <span class="k">struct</span> <span class="n">link_vars</span> <span class="o">*</span><span class="n">vars</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">bp</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">port</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">autoneg_val</span><span class="p">,</span> <span class="n">an_1000_val</span><span class="p">,</span> <span class="n">an_10_100_val</span><span class="p">,</span> <span class="n">fc_val</span><span class="p">,</span> <span class="n">temp</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">cfg_pin</span><span class="p">;</span>

	<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;54618SE cfg init</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">usleep_range</span><span class="p">(</span><span class="mi">1000</span><span class="p">,</span> <span class="mi">1000</span><span class="p">);</span>

	<span class="cm">/* This works with E3 only, no need to check the chip</span>
<span class="cm">	 * before determining the port.</span>
<span class="cm">	 */</span>
	<span class="n">port</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>

	<span class="n">cfg_pin</span> <span class="o">=</span> <span class="p">(</span><span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">shmem_base</span> <span class="o">+</span>
			<span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">shmem_region</span><span class="p">,</span>
			<span class="n">dev_info</span><span class="p">.</span><span class="n">port_hw_config</span><span class="p">[</span><span class="n">port</span><span class="p">].</span><span class="n">e3_cmn_pin_cfg</span><span class="p">))</span> <span class="o">&amp;</span>
			<span class="n">PORT_HW_CFG_E3_PHY_RESET_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span>
			<span class="n">PORT_HW_CFG_E3_PHY_RESET_SHIFT</span><span class="p">;</span>

	<span class="cm">/* Drive pin high to bring the GPHY out of reset. */</span>
	<span class="n">bnx2x_set_cfg_pin</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">cfg_pin</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* wait for GPHY to reset */</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">50</span><span class="p">);</span>

	<span class="cm">/* reset phy */</span>
	<span class="n">bnx2x_cl22_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
			 <span class="n">MDIO_PMA_REG_CTRL</span><span class="p">,</span> <span class="mh">0x8000</span><span class="p">);</span>
	<span class="n">bnx2x_wait_reset_complete</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">params</span><span class="p">);</span>

	<span class="cm">/* Wait for GPHY to reset */</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">50</span><span class="p">);</span>

	<span class="cm">/* Configure LED4: set to INTR (0x6). */</span>
	<span class="cm">/* Accessing shadow register 0xe. */</span>
	<span class="n">bnx2x_cl22_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
			<span class="n">MDIO_REG_GPHY_SHADOW</span><span class="p">,</span>
			<span class="n">MDIO_REG_GPHY_SHADOW_LED_SEL2</span><span class="p">);</span>
	<span class="n">bnx2x_cl22_read</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
			<span class="n">MDIO_REG_GPHY_SHADOW</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">temp</span><span class="p">);</span>
	<span class="n">temp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mh">0xf</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">temp</span> <span class="o">|=</span> <span class="p">(</span><span class="mh">0x6</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">bnx2x_cl22_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
			<span class="n">MDIO_REG_GPHY_SHADOW</span><span class="p">,</span>
			<span class="n">MDIO_REG_GPHY_SHADOW_WR_ENA</span> <span class="o">|</span> <span class="n">temp</span><span class="p">);</span>
	<span class="cm">/* Configure INTR based on link status change. */</span>
	<span class="n">bnx2x_cl22_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
			<span class="n">MDIO_REG_INTR_MASK</span><span class="p">,</span>
			<span class="o">~</span><span class="n">MDIO_REG_INTR_MASK_LINK_STATUS</span><span class="p">);</span>

	<span class="cm">/* Flip the signal detect polarity (set 0x1c.0x1e[8]). */</span>
	<span class="n">bnx2x_cl22_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
			<span class="n">MDIO_REG_GPHY_SHADOW</span><span class="p">,</span>
			<span class="n">MDIO_REG_GPHY_SHADOW_AUTO_DET_MED</span><span class="p">);</span>
	<span class="n">bnx2x_cl22_read</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
			<span class="n">MDIO_REG_GPHY_SHADOW</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">temp</span><span class="p">);</span>
	<span class="n">temp</span> <span class="o">|=</span> <span class="n">MDIO_REG_GPHY_SHADOW_INVERT_FIB_SD</span><span class="p">;</span>
	<span class="n">bnx2x_cl22_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
			<span class="n">MDIO_REG_GPHY_SHADOW</span><span class="p">,</span>
			<span class="n">MDIO_REG_GPHY_SHADOW_WR_ENA</span> <span class="o">|</span> <span class="n">temp</span><span class="p">);</span>

	<span class="cm">/* Set up fc */</span>
	<span class="cm">/* Please refer to Table 28B-3 of 802.3ab-1999 spec. */</span>
	<span class="n">bnx2x_calc_ieee_aneg_adv</span><span class="p">(</span><span class="n">phy</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vars</span><span class="o">-&gt;</span><span class="n">ieee_fc</span><span class="p">);</span>
	<span class="n">fc_val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">vars</span><span class="o">-&gt;</span><span class="n">ieee_fc</span> <span class="o">&amp;</span> <span class="n">MDIO_COMBO_IEEE0_AUTO_NEG_ADV_PAUSE_ASYMMETRIC</span><span class="p">)</span> <span class="o">==</span>
			<span class="n">MDIO_COMBO_IEEE0_AUTO_NEG_ADV_PAUSE_ASYMMETRIC</span><span class="p">)</span>
		<span class="n">fc_val</span> <span class="o">|=</span> <span class="n">MDIO_AN_REG_ADV_PAUSE_ASYMMETRIC</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">vars</span><span class="o">-&gt;</span><span class="n">ieee_fc</span> <span class="o">&amp;</span> <span class="n">MDIO_COMBO_IEEE0_AUTO_NEG_ADV_PAUSE_BOTH</span><span class="p">)</span> <span class="o">==</span>
			<span class="n">MDIO_COMBO_IEEE0_AUTO_NEG_ADV_PAUSE_BOTH</span><span class="p">)</span>
		<span class="n">fc_val</span> <span class="o">|=</span> <span class="n">MDIO_AN_REG_ADV_PAUSE_PAUSE</span><span class="p">;</span>

	<span class="cm">/* read all advertisement */</span>
	<span class="n">bnx2x_cl22_read</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
			<span class="mh">0x09</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">an_1000_val</span><span class="p">);</span>

	<span class="n">bnx2x_cl22_read</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
			<span class="mh">0x04</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">an_10_100_val</span><span class="p">);</span>

	<span class="n">bnx2x_cl22_read</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
			<span class="n">MDIO_PMA_REG_CTRL</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">autoneg_val</span><span class="p">);</span>

	<span class="cm">/* Disable forced speed */</span>
	<span class="n">autoneg_val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">((</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">6</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">9</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">12</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">13</span><span class="p">));</span>
	<span class="n">an_10_100_val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">((</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">6</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">7</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">10</span><span class="p">)</span> <span class="o">|</span>
			   <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">11</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(((</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">req_line_speed</span> <span class="o">==</span> <span class="n">SPEED_AUTO_NEG</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			<span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">speed_cap_mask</span> <span class="o">&amp;</span>
			<span class="n">PORT_HW_CFG_SPEED_CAPABILITY_D0_1G</span><span class="p">))</span> <span class="o">||</span>
			<span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">req_line_speed</span> <span class="o">==</span> <span class="n">SPEED_1000</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">an_1000_val</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">8</span><span class="p">);</span>
		<span class="n">autoneg_val</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">9</span> <span class="o">|</span> <span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">12</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">req_duplex</span> <span class="o">==</span> <span class="n">DUPLEX_FULL</span><span class="p">)</span>
			<span class="n">an_1000_val</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">9</span><span class="p">);</span>
		<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;Advertising 1G</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">an_1000_val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">((</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">9</span><span class="p">));</span>

	<span class="n">bnx2x_cl22_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
			<span class="mh">0x09</span><span class="p">,</span>
			<span class="n">an_1000_val</span><span class="p">);</span>
	<span class="n">bnx2x_cl22_read</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
			<span class="mh">0x09</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">an_1000_val</span><span class="p">);</span>

	<span class="cm">/* set 100 speed advertisement */</span>
	<span class="k">if</span> <span class="p">(((</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">req_line_speed</span> <span class="o">==</span> <span class="n">SPEED_AUTO_NEG</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			<span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">speed_cap_mask</span> <span class="o">&amp;</span>
			<span class="p">(</span><span class="n">PORT_HW_CFG_SPEED_CAPABILITY_D0_100M_FULL</span> <span class="o">|</span>
			<span class="n">PORT_HW_CFG_SPEED_CAPABILITY_D0_100M_HALF</span><span class="p">))))</span> <span class="p">{</span>
		<span class="n">an_10_100_val</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">7</span><span class="p">);</span>
		<span class="cm">/* Enable autoneg and restart autoneg for legacy speeds */</span>
		<span class="n">autoneg_val</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">9</span> <span class="o">|</span> <span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">12</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">req_duplex</span> <span class="o">==</span> <span class="n">DUPLEX_FULL</span><span class="p">)</span>
			<span class="n">an_10_100_val</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">8</span><span class="p">);</span>
		<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;Advertising 100M</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* set 10 speed advertisement */</span>
	<span class="k">if</span> <span class="p">(((</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">req_line_speed</span> <span class="o">==</span> <span class="n">SPEED_AUTO_NEG</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			<span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">speed_cap_mask</span> <span class="o">&amp;</span>
			<span class="p">(</span><span class="n">PORT_HW_CFG_SPEED_CAPABILITY_D0_10M_FULL</span> <span class="o">|</span>
			<span class="n">PORT_HW_CFG_SPEED_CAPABILITY_D0_10M_HALF</span><span class="p">))))</span> <span class="p">{</span>
		<span class="n">an_10_100_val</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">5</span><span class="p">);</span>
		<span class="n">autoneg_val</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">9</span> <span class="o">|</span> <span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">12</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">req_duplex</span> <span class="o">==</span> <span class="n">DUPLEX_FULL</span><span class="p">)</span>
			<span class="n">an_10_100_val</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">6</span><span class="p">);</span>
		<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;Advertising 10M</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Only 10/100 are allowed to work in FORCE mode */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">req_line_speed</span> <span class="o">==</span> <span class="n">SPEED_100</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">autoneg_val</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">13</span><span class="p">);</span>
		<span class="cm">/* Enabled AUTO-MDIX when autoneg is disabled */</span>
		<span class="n">bnx2x_cl22_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
				<span class="mh">0x18</span><span class="p">,</span>
				<span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">15</span> <span class="o">|</span> <span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">9</span> <span class="o">|</span> <span class="mi">7</span><span class="o">&lt;&lt;</span><span class="mi">0</span><span class="p">));</span>
		<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;Setting 100M force</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">req_line_speed</span> <span class="o">==</span> <span class="n">SPEED_10</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Enabled AUTO-MDIX when autoneg is disabled */</span>
		<span class="n">bnx2x_cl22_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
				<span class="mh">0x18</span><span class="p">,</span>
				<span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">15</span> <span class="o">|</span> <span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">9</span> <span class="o">|</span> <span class="mi">7</span><span class="o">&lt;&lt;</span><span class="mi">0</span><span class="p">));</span>
		<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;Setting 10M force</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Check if we should turn on Auto-GrEEEn */</span>
	<span class="n">bnx2x_cl22_read</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_REG_GPHY_PHYID_LSB</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">temp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">temp</span> <span class="o">==</span> <span class="n">MDIO_REG_GPHY_ID_54618SE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">feature_config_flags</span> <span class="o">&amp;</span>
		    <span class="n">FEATURE_CONFIG_AUTOGREEEN_ENABLED</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">temp</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
			<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;Enabling Auto-GrEEEn</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">temp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;Disabling Auto-GrEEEn</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">bnx2x_cl22_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
				 <span class="n">MDIO_REG_GPHY_CL45_ADDR_REG</span><span class="p">,</span> <span class="n">MDIO_AN_DEVAD</span><span class="p">);</span>
		<span class="n">bnx2x_cl22_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
				 <span class="n">MDIO_REG_GPHY_CL45_DATA_REG</span><span class="p">,</span>
				 <span class="n">MDIO_REG_GPHY_EEE_ADV</span><span class="p">);</span>
		<span class="n">bnx2x_cl22_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
				 <span class="n">MDIO_REG_GPHY_CL45_ADDR_REG</span><span class="p">,</span>
				 <span class="p">(</span><span class="mh">0x1</span> <span class="o">&lt;&lt;</span> <span class="mi">14</span><span class="p">)</span> <span class="o">|</span> <span class="n">MDIO_AN_DEVAD</span><span class="p">);</span>
		<span class="n">bnx2x_cl22_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
				 <span class="n">MDIO_REG_GPHY_CL45_DATA_REG</span><span class="p">,</span>
				 <span class="n">temp</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">bnx2x_cl22_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
			<span class="mh">0x04</span><span class="p">,</span>
			<span class="n">an_10_100_val</span> <span class="o">|</span> <span class="n">fc_val</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">req_duplex</span> <span class="o">==</span> <span class="n">DUPLEX_FULL</span><span class="p">)</span>
		<span class="n">autoneg_val</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">8</span><span class="p">);</span>

	<span class="n">bnx2x_cl22_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
			<span class="n">MDIO_PMA_REG_CTRL</span><span class="p">,</span> <span class="n">autoneg_val</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_5461x_set_link_led</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x_phy</span> <span class="o">*</span><span class="n">phy</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">link_params</span> <span class="o">*</span><span class="n">params</span><span class="p">,</span> <span class="n">u8</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">bp</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">temp</span><span class="p">;</span>

	<span class="n">bnx2x_cl22_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
		<span class="n">MDIO_REG_GPHY_SHADOW</span><span class="p">,</span>
		<span class="n">MDIO_REG_GPHY_SHADOW_LED_SEL1</span><span class="p">);</span>
	<span class="n">bnx2x_cl22_read</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
		<span class="n">MDIO_REG_GPHY_SHADOW</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="n">temp</span><span class="p">);</span>
	<span class="n">temp</span> <span class="o">&amp;=</span> <span class="mh">0xff00</span><span class="p">;</span>

	<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;54618x set link led (mode=%x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">LED_MODE_FRONT_PANEL_OFF</span>:
	<span class="k">case</span> <span class="n">LED_MODE_OFF</span>:
		<span class="n">temp</span> <span class="o">|=</span> <span class="mh">0x00ee</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">LED_MODE_OPER</span>:
		<span class="n">temp</span> <span class="o">|=</span> <span class="mh">0x0001</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">LED_MODE_ON</span>:
		<span class="n">temp</span> <span class="o">|=</span> <span class="mh">0x00ff</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">bnx2x_cl22_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
		<span class="n">MDIO_REG_GPHY_SHADOW</span><span class="p">,</span>
		<span class="n">MDIO_REG_GPHY_SHADOW_WR_ENA</span> <span class="o">|</span> <span class="n">temp</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_54618se_link_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x_phy</span> <span class="o">*</span><span class="n">phy</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">link_params</span> <span class="o">*</span><span class="n">params</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">bp</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">cfg_pin</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">port</span><span class="p">;</span>

	<span class="cm">/* In case of no EPIO routed to reset the GPHY, put it</span>
<span class="cm">	 * in low power mode.</span>
<span class="cm">	 */</span>
	<span class="n">bnx2x_cl22_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_PMA_REG_CTRL</span><span class="p">,</span> <span class="mh">0x800</span><span class="p">);</span>
	<span class="cm">/* This works with E3 only, no need to check the chip</span>
<span class="cm">	 * before determining the port.</span>
<span class="cm">	 */</span>
	<span class="n">port</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>
	<span class="n">cfg_pin</span> <span class="o">=</span> <span class="p">(</span><span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">shmem_base</span> <span class="o">+</span>
			<span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">shmem_region</span><span class="p">,</span>
			<span class="n">dev_info</span><span class="p">.</span><span class="n">port_hw_config</span><span class="p">[</span><span class="n">port</span><span class="p">].</span><span class="n">e3_cmn_pin_cfg</span><span class="p">))</span> <span class="o">&amp;</span>
			<span class="n">PORT_HW_CFG_E3_PHY_RESET_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span>
			<span class="n">PORT_HW_CFG_E3_PHY_RESET_SHIFT</span><span class="p">;</span>

	<span class="cm">/* Drive pin low to put GPHY in reset. */</span>
	<span class="n">bnx2x_set_cfg_pin</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">cfg_pin</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u8</span> <span class="nf">bnx2x_54618se_read_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x_phy</span> <span class="o">*</span><span class="n">phy</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">link_params</span> <span class="o">*</span><span class="n">params</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">link_vars</span> <span class="o">*</span><span class="n">vars</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">bp</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">val</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">link_up</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">legacy_status</span><span class="p">,</span> <span class="n">legacy_speed</span><span class="p">;</span>

	<span class="cm">/* Get speed operation status */</span>
	<span class="n">bnx2x_cl22_read</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
			<span class="mh">0x19</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">legacy_status</span><span class="p">);</span>
	<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;54618SE read_status: 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">legacy_status</span><span class="p">);</span>

	<span class="cm">/* Read status to clear the PHY interrupt. */</span>
	<span class="n">bnx2x_cl22_read</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
			<span class="n">MDIO_REG_INTR_STATUS</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>

	<span class="n">link_up</span> <span class="o">=</span> <span class="p">((</span><span class="n">legacy_status</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">2</span><span class="p">))</span> <span class="o">==</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">2</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">link_up</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">legacy_speed</span> <span class="o">=</span> <span class="p">(</span><span class="n">legacy_status</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">7</span><span class="o">&lt;&lt;</span><span class="mi">8</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">legacy_speed</span> <span class="o">==</span> <span class="p">(</span><span class="mi">7</span><span class="o">&lt;&lt;</span><span class="mi">8</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">vars</span><span class="o">-&gt;</span><span class="n">line_speed</span> <span class="o">=</span> <span class="n">SPEED_1000</span><span class="p">;</span>
			<span class="n">vars</span><span class="o">-&gt;</span><span class="n">duplex</span> <span class="o">=</span> <span class="n">DUPLEX_FULL</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">legacy_speed</span> <span class="o">==</span> <span class="p">(</span><span class="mi">6</span><span class="o">&lt;&lt;</span><span class="mi">8</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">vars</span><span class="o">-&gt;</span><span class="n">line_speed</span> <span class="o">=</span> <span class="n">SPEED_1000</span><span class="p">;</span>
			<span class="n">vars</span><span class="o">-&gt;</span><span class="n">duplex</span> <span class="o">=</span> <span class="n">DUPLEX_HALF</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">legacy_speed</span> <span class="o">==</span> <span class="p">(</span><span class="mi">5</span><span class="o">&lt;&lt;</span><span class="mi">8</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">vars</span><span class="o">-&gt;</span><span class="n">line_speed</span> <span class="o">=</span> <span class="n">SPEED_100</span><span class="p">;</span>
			<span class="n">vars</span><span class="o">-&gt;</span><span class="n">duplex</span> <span class="o">=</span> <span class="n">DUPLEX_FULL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* Omitting 100Base-T4 for now */</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">legacy_speed</span> <span class="o">==</span> <span class="p">(</span><span class="mi">3</span><span class="o">&lt;&lt;</span><span class="mi">8</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">vars</span><span class="o">-&gt;</span><span class="n">line_speed</span> <span class="o">=</span> <span class="n">SPEED_100</span><span class="p">;</span>
			<span class="n">vars</span><span class="o">-&gt;</span><span class="n">duplex</span> <span class="o">=</span> <span class="n">DUPLEX_HALF</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">legacy_speed</span> <span class="o">==</span> <span class="p">(</span><span class="mi">2</span><span class="o">&lt;&lt;</span><span class="mi">8</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">vars</span><span class="o">-&gt;</span><span class="n">line_speed</span> <span class="o">=</span> <span class="n">SPEED_10</span><span class="p">;</span>
			<span class="n">vars</span><span class="o">-&gt;</span><span class="n">duplex</span> <span class="o">=</span> <span class="n">DUPLEX_FULL</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">legacy_speed</span> <span class="o">==</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">8</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">vars</span><span class="o">-&gt;</span><span class="n">line_speed</span> <span class="o">=</span> <span class="n">SPEED_10</span><span class="p">;</span>
			<span class="n">vars</span><span class="o">-&gt;</span><span class="n">duplex</span> <span class="o">=</span> <span class="n">DUPLEX_HALF</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="cm">/* Should not happen */</span>
			<span class="n">vars</span><span class="o">-&gt;</span><span class="n">line_speed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span>
		   <span class="s">&quot;Link is up in %dMbps, is_duplex_full= %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">vars</span><span class="o">-&gt;</span><span class="n">line_speed</span><span class="p">,</span>
		   <span class="p">(</span><span class="n">vars</span><span class="o">-&gt;</span><span class="n">duplex</span> <span class="o">==</span> <span class="n">DUPLEX_FULL</span><span class="p">));</span>

		<span class="cm">/* Check legacy speed AN resolution */</span>
		<span class="n">bnx2x_cl22_read</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
				<span class="mh">0x01</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">5</span><span class="p">))</span>
			<span class="n">vars</span><span class="o">-&gt;</span><span class="n">link_status</span> <span class="o">|=</span>
				<span class="n">LINK_STATUS_AUTO_NEGOTIATE_COMPLETE</span><span class="p">;</span>
		<span class="n">bnx2x_cl22_read</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
				<span class="mh">0x06</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">val</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">0</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">vars</span><span class="o">-&gt;</span><span class="n">link_status</span> <span class="o">|=</span>
				<span class="n">LINK_STATUS_PARALLEL_DETECTION_USED</span><span class="p">;</span>

		<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;BCM54618SE: link speed is %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">vars</span><span class="o">-&gt;</span><span class="n">line_speed</span><span class="p">);</span>

		<span class="cm">/* Report whether EEE is resolved. */</span>
		<span class="n">bnx2x_cl22_read</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">MDIO_REG_GPHY_PHYID_LSB</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">==</span> <span class="n">MDIO_REG_GPHY_ID_54618SE</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">vars</span><span class="o">-&gt;</span><span class="n">link_status</span> <span class="o">&amp;</span>
			    <span class="n">LINK_STATUS_AUTO_NEGOTIATE_COMPLETE</span><span class="p">)</span>
				<span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">else</span> <span class="p">{</span>
				<span class="n">bnx2x_cl22_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
					<span class="n">MDIO_REG_GPHY_CL45_ADDR_REG</span><span class="p">,</span>
					<span class="n">MDIO_AN_DEVAD</span><span class="p">);</span>
				<span class="n">bnx2x_cl22_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
					<span class="n">MDIO_REG_GPHY_CL45_DATA_REG</span><span class="p">,</span>
					<span class="n">MDIO_REG_GPHY_EEE_RESOLVED</span><span class="p">);</span>
				<span class="n">bnx2x_cl22_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
					<span class="n">MDIO_REG_GPHY_CL45_ADDR_REG</span><span class="p">,</span>
					<span class="p">(</span><span class="mh">0x1</span> <span class="o">&lt;&lt;</span> <span class="mi">14</span><span class="p">)</span> <span class="o">|</span> <span class="n">MDIO_AN_DEVAD</span><span class="p">);</span>
				<span class="n">bnx2x_cl22_read</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
					<span class="n">MDIO_REG_GPHY_CL45_DATA_REG</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;EEE resolution: 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">bnx2x_ext_phy_resolve_fc</span><span class="p">(</span><span class="n">phy</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">vars</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">vars</span><span class="o">-&gt;</span><span class="n">link_status</span> <span class="o">&amp;</span> <span class="n">LINK_STATUS_AUTO_NEGOTIATE_COMPLETE</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Report LP advertised speeds */</span>
			<span class="n">bnx2x_cl22_read</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="mh">0x5</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">5</span><span class="p">))</span>
				<span class="n">vars</span><span class="o">-&gt;</span><span class="n">link_status</span> <span class="o">|=</span>
				  <span class="n">LINK_STATUS_LINK_PARTNER_10THD_CAPABLE</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">6</span><span class="p">))</span>
				<span class="n">vars</span><span class="o">-&gt;</span><span class="n">link_status</span> <span class="o">|=</span>
				  <span class="n">LINK_STATUS_LINK_PARTNER_10TFD_CAPABLE</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">7</span><span class="p">))</span>
				<span class="n">vars</span><span class="o">-&gt;</span><span class="n">link_status</span> <span class="o">|=</span>
				  <span class="n">LINK_STATUS_LINK_PARTNER_100TXHD_CAPABLE</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">8</span><span class="p">))</span>
				<span class="n">vars</span><span class="o">-&gt;</span><span class="n">link_status</span> <span class="o">|=</span>
				  <span class="n">LINK_STATUS_LINK_PARTNER_100TXFD_CAPABLE</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">9</span><span class="p">))</span>
				<span class="n">vars</span><span class="o">-&gt;</span><span class="n">link_status</span> <span class="o">|=</span>
				  <span class="n">LINK_STATUS_LINK_PARTNER_100T4_CAPABLE</span><span class="p">;</span>

			<span class="n">bnx2x_cl22_read</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="mh">0xa</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">10</span><span class="p">))</span>
				<span class="n">vars</span><span class="o">-&gt;</span><span class="n">link_status</span> <span class="o">|=</span>
				  <span class="n">LINK_STATUS_LINK_PARTNER_1000THD_CAPABLE</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">11</span><span class="p">))</span>
				<span class="n">vars</span><span class="o">-&gt;</span><span class="n">link_status</span> <span class="o">|=</span>
				  <span class="n">LINK_STATUS_LINK_PARTNER_1000TFD_CAPABLE</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">link_up</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_54618se_config_loopback</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x_phy</span> <span class="o">*</span><span class="n">phy</span><span class="p">,</span>
					  <span class="k">struct</span> <span class="n">link_params</span> <span class="o">*</span><span class="n">params</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">bp</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">val</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">umac_base</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">?</span> <span class="n">GRCBASE_UMAC1</span> <span class="o">:</span> <span class="n">GRCBASE_UMAC0</span><span class="p">;</span>

	<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;2PMA/PMD ext_phy_loopback: 54618se</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* Enable master/slave manual mmode and set to master */</span>
	<span class="cm">/* mii write 9 [bits set 11 12] */</span>
	<span class="n">bnx2x_cl22_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="mh">0x09</span><span class="p">,</span> <span class="mi">3</span><span class="o">&lt;&lt;</span><span class="mi">11</span><span class="p">);</span>

	<span class="cm">/* forced 1G and disable autoneg */</span>
	<span class="cm">/* set val [mii read 0] */</span>
	<span class="cm">/* set val [expr $val &amp; [bits clear 6 12 13]] */</span>
	<span class="cm">/* set val [expr $val | [bits set 6 8]] */</span>
	<span class="cm">/* mii write 0 $val */</span>
	<span class="n">bnx2x_cl22_read</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">((</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">6</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">12</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">13</span><span class="p">));</span>
	<span class="n">val</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">6</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">8</span><span class="p">);</span>
	<span class="n">bnx2x_cl22_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

	<span class="cm">/* Set external loopback and Tx using 6dB coding */</span>
	<span class="cm">/* mii write 0x18 7 */</span>
	<span class="cm">/* set val [mii read 0x18] */</span>
	<span class="cm">/* mii write 0x18 [expr $val | [bits set 10 15]] */</span>
	<span class="n">bnx2x_cl22_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">,</span> <span class="mi">7</span><span class="p">);</span>
	<span class="n">bnx2x_cl22_read</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
	<span class="n">bnx2x_cl22_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">,</span> <span class="n">val</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">10</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">15</span><span class="p">));</span>

	<span class="cm">/* This register opens the gate for the UMAC despite its name */</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">NIG_REG_EGRESS_EMAC0_PORT</span> <span class="o">+</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">*</span><span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* Maximum Frame Length (RW). Defines a 14-Bit maximum frame</span>
<span class="cm">	 * length used by the MAC receive logic to check frames.</span>
<span class="cm">	 */</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">umac_base</span> <span class="o">+</span> <span class="n">UMAC_REG_MAXFR</span><span class="p">,</span> <span class="mh">0x2710</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/******************************************************************/</span>
<span class="cm">/*			SFX7101 PHY SECTION			  */</span>
<span class="cm">/******************************************************************/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_7101_config_loopback</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x_phy</span> <span class="o">*</span><span class="n">phy</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">link_params</span> <span class="o">*</span><span class="n">params</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">bp</span><span class="p">;</span>
	<span class="cm">/* SFX7101_XGXS_TEST1 */</span>
	<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
			 <span class="n">MDIO_XS_DEVAD</span><span class="p">,</span> <span class="n">MDIO_XS_SFX7101_XGXS_TEST1</span><span class="p">,</span> <span class="mh">0x100</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bnx2x_7101_config_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x_phy</span> <span class="o">*</span><span class="n">phy</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">link_params</span> <span class="o">*</span><span class="n">params</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">link_vars</span> <span class="o">*</span><span class="n">vars</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">fw_ver1</span><span class="p">,</span> <span class="n">fw_ver2</span><span class="p">,</span> <span class="n">val</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">bp</span><span class="p">;</span>
	<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;Setting the SFX7101 LASI indication</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* Restore normal power mode*/</span>
	<span class="n">bnx2x_set_gpio</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">MISC_REGISTERS_GPIO_2</span><span class="p">,</span>
		       <span class="n">MISC_REGISTERS_GPIO_OUTPUT_HIGH</span><span class="p">,</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">);</span>
	<span class="cm">/* HW reset */</span>
	<span class="n">bnx2x_ext_phy_hw_reset</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">);</span>
	<span class="n">bnx2x_wait_reset_complete</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">params</span><span class="p">);</span>

	<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
			 <span class="n">MDIO_PMA_DEVAD</span><span class="p">,</span> <span class="n">MDIO_PMA_LASI_CTRL</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">);</span>
	<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;Setting the SFX7101 LED to blink on traffic</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
			 <span class="n">MDIO_PMA_DEVAD</span><span class="p">,</span> <span class="n">MDIO_PMA_REG_7107_LED_CNTL</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">3</span><span class="p">));</span>

	<span class="n">bnx2x_ext_phy_set_pause</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">vars</span><span class="p">);</span>
	<span class="cm">/* Restart autoneg */</span>
	<span class="n">bnx2x_cl45_read</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
			<span class="n">MDIO_AN_DEVAD</span><span class="p">,</span> <span class="n">MDIO_AN_REG_CTRL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">|=</span> <span class="mh">0x200</span><span class="p">;</span>
	<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
			 <span class="n">MDIO_AN_DEVAD</span><span class="p">,</span> <span class="n">MDIO_AN_REG_CTRL</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

	<span class="cm">/* Save spirom version */</span>
	<span class="n">bnx2x_cl45_read</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
			<span class="n">MDIO_PMA_DEVAD</span><span class="p">,</span> <span class="n">MDIO_PMA_REG_7101_VER1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fw_ver1</span><span class="p">);</span>

	<span class="n">bnx2x_cl45_read</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
			<span class="n">MDIO_PMA_DEVAD</span><span class="p">,</span> <span class="n">MDIO_PMA_REG_7101_VER2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fw_ver2</span><span class="p">);</span>
	<span class="n">bnx2x_save_spirom_version</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span>
				  <span class="p">(</span><span class="n">u32</span><span class="p">)(</span><span class="n">fw_ver1</span><span class="o">&lt;&lt;</span><span class="mi">16</span> <span class="o">|</span> <span class="n">fw_ver2</span><span class="p">),</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">ver_addr</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u8</span> <span class="nf">bnx2x_7101_read_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x_phy</span> <span class="o">*</span><span class="n">phy</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">link_params</span> <span class="o">*</span><span class="n">params</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">link_vars</span> <span class="o">*</span><span class="n">vars</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">bp</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">link_up</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">val1</span><span class="p">,</span> <span class="n">val2</span><span class="p">;</span>
	<span class="n">bnx2x_cl45_read</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
			<span class="n">MDIO_PMA_DEVAD</span><span class="p">,</span> <span class="n">MDIO_PMA_LASI_STAT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val2</span><span class="p">);</span>
	<span class="n">bnx2x_cl45_read</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
			<span class="n">MDIO_PMA_DEVAD</span><span class="p">,</span> <span class="n">MDIO_PMA_LASI_STAT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val1</span><span class="p">);</span>
	<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;10G-base-T LASI status 0x%x-&gt;0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">val2</span><span class="p">,</span> <span class="n">val1</span><span class="p">);</span>
	<span class="n">bnx2x_cl45_read</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
			<span class="n">MDIO_PMA_DEVAD</span><span class="p">,</span> <span class="n">MDIO_PMA_REG_STATUS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val2</span><span class="p">);</span>
	<span class="n">bnx2x_cl45_read</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
			<span class="n">MDIO_PMA_DEVAD</span><span class="p">,</span> <span class="n">MDIO_PMA_REG_STATUS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val1</span><span class="p">);</span>
	<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;10G-base-T PMA status 0x%x-&gt;0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">val2</span><span class="p">,</span> <span class="n">val1</span><span class="p">);</span>
	<span class="n">link_up</span> <span class="o">=</span> <span class="p">((</span><span class="n">val1</span> <span class="o">&amp;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">);</span>
	<span class="cm">/* if link is up print the AN outcome of the SFX7101 PHY */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">link_up</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bnx2x_cl45_read</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
				<span class="n">MDIO_AN_DEVAD</span><span class="p">,</span> <span class="n">MDIO_AN_REG_MASTER_STATUS</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">val2</span><span class="p">);</span>
		<span class="n">vars</span><span class="o">-&gt;</span><span class="n">line_speed</span> <span class="o">=</span> <span class="n">SPEED_10000</span><span class="p">;</span>
		<span class="n">vars</span><span class="o">-&gt;</span><span class="n">duplex</span> <span class="o">=</span> <span class="n">DUPLEX_FULL</span><span class="p">;</span>
		<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;SFX7101 AN status 0x%x-&gt;Master=%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">val2</span><span class="p">,</span> <span class="p">(</span><span class="n">val2</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">14</span><span class="p">)));</span>
		<span class="n">bnx2x_ext_phy_10G_an_resolve</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">vars</span><span class="p">);</span>
		<span class="n">bnx2x_ext_phy_resolve_fc</span><span class="p">(</span><span class="n">phy</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">vars</span><span class="p">);</span>

		<span class="cm">/* read LP advertised speeds */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">val2</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">11</span><span class="p">))</span>
			<span class="n">vars</span><span class="o">-&gt;</span><span class="n">link_status</span> <span class="o">|=</span>
				<span class="n">LINK_STATUS_LINK_PARTNER_10GXFD_CAPABLE</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">link_up</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bnx2x_7101_format_ver</span><span class="p">(</span><span class="n">u32</span> <span class="n">spirom_ver</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">str</span><span class="p">,</span> <span class="n">u16</span> <span class="o">*</span><span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">len</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">str</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">spirom_ver</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">);</span>
	<span class="n">str</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">spirom_ver</span> <span class="o">&amp;</span> <span class="mh">0xFF00</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">str</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">spirom_ver</span> <span class="o">&amp;</span> <span class="mh">0xFF0000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">;</span>
	<span class="n">str</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">spirom_ver</span> <span class="o">&amp;</span> <span class="mh">0xFF000000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">;</span>
	<span class="n">str</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
	<span class="o">*</span><span class="n">len</span> <span class="o">-=</span> <span class="mi">5</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">bnx2x_sfx7101_sp_sw_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bnx2x_phy</span> <span class="o">*</span><span class="n">phy</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">val</span><span class="p">,</span> <span class="n">cnt</span><span class="p">;</span>

	<span class="n">bnx2x_cl45_read</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
			<span class="n">MDIO_PMA_DEVAD</span><span class="p">,</span>
			<span class="n">MDIO_PMA_REG_7101_RESET</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">cnt</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">;</span> <span class="n">cnt</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">50</span><span class="p">);</span>
		<span class="cm">/* Writes a self-clearing reset */</span>
		<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
				 <span class="n">MDIO_PMA_DEVAD</span><span class="p">,</span>
				 <span class="n">MDIO_PMA_REG_7101_RESET</span><span class="p">,</span>
				 <span class="p">(</span><span class="n">val</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">15</span><span class="p">)));</span>
		<span class="cm">/* Wait for clear */</span>
		<span class="n">bnx2x_cl45_read</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
				<span class="n">MDIO_PMA_DEVAD</span><span class="p">,</span>
				<span class="n">MDIO_PMA_REG_7101_RESET</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">val</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">15</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_7101_hw_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x_phy</span> <span class="o">*</span><span class="n">phy</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">link_params</span> <span class="o">*</span><span class="n">params</span><span class="p">)</span> <span class="p">{</span>
	<span class="cm">/* Low power mode is controlled by GPIO 2 */</span>
	<span class="n">bnx2x_set_gpio</span><span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">bp</span><span class="p">,</span> <span class="n">MISC_REGISTERS_GPIO_2</span><span class="p">,</span>
		       <span class="n">MISC_REGISTERS_GPIO_OUTPUT_LOW</span><span class="p">,</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">);</span>
	<span class="cm">/* The PHY reset is controlled by GPIO 1 */</span>
	<span class="n">bnx2x_set_gpio</span><span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">bp</span><span class="p">,</span> <span class="n">MISC_REGISTERS_GPIO_1</span><span class="p">,</span>
		       <span class="n">MISC_REGISTERS_GPIO_OUTPUT_LOW</span><span class="p">,</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_7101_set_link_led</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x_phy</span> <span class="o">*</span><span class="n">phy</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">link_params</span> <span class="o">*</span><span class="n">params</span><span class="p">,</span> <span class="n">u8</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">bp</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">LED_MODE_FRONT_PANEL_OFF</span>:
	<span class="k">case</span> <span class="n">LED_MODE_OFF</span>:
		<span class="n">val</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">LED_MODE_ON</span>:
		<span class="n">val</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">LED_MODE_OPER</span>:
		<span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
			 <span class="n">MDIO_PMA_DEVAD</span><span class="p">,</span>
			 <span class="n">MDIO_PMA_REG_7107_LINK_LED_CNTL</span><span class="p">,</span>
			 <span class="n">val</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/******************************************************************/</span>
<span class="cm">/*			STATIC PHY DECLARATION			  */</span>
<span class="cm">/******************************************************************/</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">bnx2x_phy</span> <span class="n">phy_null</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">type</span>		<span class="o">=</span> <span class="n">PORT_HW_CFG_XGXS_EXT_PHY_TYPE_NOT_CONN</span><span class="p">,</span>
	<span class="p">.</span><span class="n">addr</span>		<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">def_md_devad</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">flags</span>		<span class="o">=</span> <span class="n">FLAGS_INIT_XGXS_FIRST</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rx_preemphasis</span>	<span class="o">=</span> <span class="p">{</span><span class="mh">0xffff</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">},</span>
	<span class="p">.</span><span class="n">tx_preemphasis</span>	<span class="o">=</span> <span class="p">{</span><span class="mh">0xffff</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">},</span>
	<span class="p">.</span><span class="n">mdio_ctrl</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">supported</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">media_type</span>	<span class="o">=</span> <span class="n">ETH_PHY_NOT_PRESENT</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ver_addr</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">req_flow_ctrl</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">req_line_speed</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">speed_cap_mask</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">req_duplex</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rsrv</span>		<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">config_init</span>	<span class="o">=</span> <span class="p">(</span><span class="n">config_init_t</span><span class="p">)</span><span class="nb">NULL</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read_status</span>	<span class="o">=</span> <span class="p">(</span><span class="n">read_status_t</span><span class="p">)</span><span class="nb">NULL</span><span class="p">,</span>
	<span class="p">.</span><span class="n">link_reset</span>	<span class="o">=</span> <span class="p">(</span><span class="n">link_reset_t</span><span class="p">)</span><span class="nb">NULL</span><span class="p">,</span>
	<span class="p">.</span><span class="n">config_loopback</span> <span class="o">=</span> <span class="p">(</span><span class="n">config_loopback_t</span><span class="p">)</span><span class="nb">NULL</span><span class="p">,</span>
	<span class="p">.</span><span class="n">format_fw_ver</span>	<span class="o">=</span> <span class="p">(</span><span class="n">format_fw_ver_t</span><span class="p">)</span><span class="nb">NULL</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hw_reset</span>	<span class="o">=</span> <span class="p">(</span><span class="n">hw_reset_t</span><span class="p">)</span><span class="nb">NULL</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_link_led</span>	<span class="o">=</span> <span class="p">(</span><span class="n">set_link_led_t</span><span class="p">)</span><span class="nb">NULL</span><span class="p">,</span>
	<span class="p">.</span><span class="n">phy_specific_func</span> <span class="o">=</span> <span class="p">(</span><span class="n">phy_specific_func_t</span><span class="p">)</span><span class="nb">NULL</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">bnx2x_phy</span> <span class="n">phy_serdes</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">type</span>		<span class="o">=</span> <span class="n">PORT_HW_CFG_SERDES_EXT_PHY_TYPE_DIRECT</span><span class="p">,</span>
	<span class="p">.</span><span class="n">addr</span>		<span class="o">=</span> <span class="mh">0xff</span><span class="p">,</span>
	<span class="p">.</span><span class="n">def_md_devad</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">flags</span>		<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rx_preemphasis</span>	<span class="o">=</span> <span class="p">{</span><span class="mh">0xffff</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">},</span>
	<span class="p">.</span><span class="n">tx_preemphasis</span>	<span class="o">=</span> <span class="p">{</span><span class="mh">0xffff</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">},</span>
	<span class="p">.</span><span class="n">mdio_ctrl</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">supported</span>	<span class="o">=</span> <span class="p">(</span><span class="n">SUPPORTED_10baseT_Half</span> <span class="o">|</span>
			   <span class="n">SUPPORTED_10baseT_Full</span> <span class="o">|</span>
			   <span class="n">SUPPORTED_100baseT_Half</span> <span class="o">|</span>
			   <span class="n">SUPPORTED_100baseT_Full</span> <span class="o">|</span>
			   <span class="n">SUPPORTED_1000baseT_Full</span> <span class="o">|</span>
			   <span class="n">SUPPORTED_2500baseX_Full</span> <span class="o">|</span>
			   <span class="n">SUPPORTED_TP</span> <span class="o">|</span>
			   <span class="n">SUPPORTED_Autoneg</span> <span class="o">|</span>
			   <span class="n">SUPPORTED_Pause</span> <span class="o">|</span>
			   <span class="n">SUPPORTED_Asym_Pause</span><span class="p">),</span>
	<span class="p">.</span><span class="n">media_type</span>	<span class="o">=</span> <span class="n">ETH_PHY_BASE_T</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ver_addr</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">req_flow_ctrl</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">req_line_speed</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">speed_cap_mask</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">req_duplex</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rsrv</span>		<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">config_init</span>	<span class="o">=</span> <span class="p">(</span><span class="n">config_init_t</span><span class="p">)</span><span class="n">bnx2x_xgxs_config_init</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read_status</span>	<span class="o">=</span> <span class="p">(</span><span class="n">read_status_t</span><span class="p">)</span><span class="n">bnx2x_link_settings_status</span><span class="p">,</span>
	<span class="p">.</span><span class="n">link_reset</span>	<span class="o">=</span> <span class="p">(</span><span class="n">link_reset_t</span><span class="p">)</span><span class="n">bnx2x_int_link_reset</span><span class="p">,</span>
	<span class="p">.</span><span class="n">config_loopback</span> <span class="o">=</span> <span class="p">(</span><span class="n">config_loopback_t</span><span class="p">)</span><span class="nb">NULL</span><span class="p">,</span>
	<span class="p">.</span><span class="n">format_fw_ver</span>	<span class="o">=</span> <span class="p">(</span><span class="n">format_fw_ver_t</span><span class="p">)</span><span class="nb">NULL</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hw_reset</span>	<span class="o">=</span> <span class="p">(</span><span class="n">hw_reset_t</span><span class="p">)</span><span class="nb">NULL</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_link_led</span>	<span class="o">=</span> <span class="p">(</span><span class="n">set_link_led_t</span><span class="p">)</span><span class="nb">NULL</span><span class="p">,</span>
	<span class="p">.</span><span class="n">phy_specific_func</span> <span class="o">=</span> <span class="p">(</span><span class="n">phy_specific_func_t</span><span class="p">)</span><span class="nb">NULL</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">bnx2x_phy</span> <span class="n">phy_xgxs</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">type</span>		<span class="o">=</span> <span class="n">PORT_HW_CFG_XGXS_EXT_PHY_TYPE_DIRECT</span><span class="p">,</span>
	<span class="p">.</span><span class="n">addr</span>		<span class="o">=</span> <span class="mh">0xff</span><span class="p">,</span>
	<span class="p">.</span><span class="n">def_md_devad</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">flags</span>		<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rx_preemphasis</span>	<span class="o">=</span> <span class="p">{</span><span class="mh">0xffff</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">},</span>
	<span class="p">.</span><span class="n">tx_preemphasis</span>	<span class="o">=</span> <span class="p">{</span><span class="mh">0xffff</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">},</span>
	<span class="p">.</span><span class="n">mdio_ctrl</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">supported</span>	<span class="o">=</span> <span class="p">(</span><span class="n">SUPPORTED_10baseT_Half</span> <span class="o">|</span>
			   <span class="n">SUPPORTED_10baseT_Full</span> <span class="o">|</span>
			   <span class="n">SUPPORTED_100baseT_Half</span> <span class="o">|</span>
			   <span class="n">SUPPORTED_100baseT_Full</span> <span class="o">|</span>
			   <span class="n">SUPPORTED_1000baseT_Full</span> <span class="o">|</span>
			   <span class="n">SUPPORTED_2500baseX_Full</span> <span class="o">|</span>
			   <span class="n">SUPPORTED_10000baseT_Full</span> <span class="o">|</span>
			   <span class="n">SUPPORTED_FIBRE</span> <span class="o">|</span>
			   <span class="n">SUPPORTED_Autoneg</span> <span class="o">|</span>
			   <span class="n">SUPPORTED_Pause</span> <span class="o">|</span>
			   <span class="n">SUPPORTED_Asym_Pause</span><span class="p">),</span>
	<span class="p">.</span><span class="n">media_type</span>	<span class="o">=</span> <span class="n">ETH_PHY_CX4</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ver_addr</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">req_flow_ctrl</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">req_line_speed</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">speed_cap_mask</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">req_duplex</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rsrv</span>		<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">config_init</span>	<span class="o">=</span> <span class="p">(</span><span class="n">config_init_t</span><span class="p">)</span><span class="n">bnx2x_xgxs_config_init</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read_status</span>	<span class="o">=</span> <span class="p">(</span><span class="n">read_status_t</span><span class="p">)</span><span class="n">bnx2x_link_settings_status</span><span class="p">,</span>
	<span class="p">.</span><span class="n">link_reset</span>	<span class="o">=</span> <span class="p">(</span><span class="n">link_reset_t</span><span class="p">)</span><span class="n">bnx2x_int_link_reset</span><span class="p">,</span>
	<span class="p">.</span><span class="n">config_loopback</span> <span class="o">=</span> <span class="p">(</span><span class="n">config_loopback_t</span><span class="p">)</span><span class="n">bnx2x_set_xgxs_loopback</span><span class="p">,</span>
	<span class="p">.</span><span class="n">format_fw_ver</span>	<span class="o">=</span> <span class="p">(</span><span class="n">format_fw_ver_t</span><span class="p">)</span><span class="nb">NULL</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hw_reset</span>	<span class="o">=</span> <span class="p">(</span><span class="n">hw_reset_t</span><span class="p">)</span><span class="nb">NULL</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_link_led</span>	<span class="o">=</span> <span class="p">(</span><span class="n">set_link_led_t</span><span class="p">)</span><span class="nb">NULL</span><span class="p">,</span>
	<span class="p">.</span><span class="n">phy_specific_func</span> <span class="o">=</span> <span class="p">(</span><span class="n">phy_specific_func_t</span><span class="p">)</span><span class="nb">NULL</span>
<span class="p">};</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">bnx2x_phy</span> <span class="n">phy_warpcore</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">type</span>		<span class="o">=</span> <span class="n">PORT_HW_CFG_XGXS_EXT_PHY_TYPE_DIRECT</span><span class="p">,</span>
	<span class="p">.</span><span class="n">addr</span>		<span class="o">=</span> <span class="mh">0xff</span><span class="p">,</span>
	<span class="p">.</span><span class="n">def_md_devad</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">flags</span>		<span class="o">=</span> <span class="p">(</span><span class="n">FLAGS_HW_LOCK_REQUIRED</span> <span class="o">|</span>
			   <span class="n">FLAGS_TX_ERROR_CHECK</span><span class="p">),</span>
	<span class="p">.</span><span class="n">rx_preemphasis</span>	<span class="o">=</span> <span class="p">{</span><span class="mh">0xffff</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">},</span>
	<span class="p">.</span><span class="n">tx_preemphasis</span>	<span class="o">=</span> <span class="p">{</span><span class="mh">0xffff</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">},</span>
	<span class="p">.</span><span class="n">mdio_ctrl</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">supported</span>	<span class="o">=</span> <span class="p">(</span><span class="n">SUPPORTED_10baseT_Half</span> <span class="o">|</span>
			   <span class="n">SUPPORTED_10baseT_Full</span> <span class="o">|</span>
			   <span class="n">SUPPORTED_100baseT_Half</span> <span class="o">|</span>
			   <span class="n">SUPPORTED_100baseT_Full</span> <span class="o">|</span>
			   <span class="n">SUPPORTED_1000baseT_Full</span> <span class="o">|</span>
			   <span class="n">SUPPORTED_10000baseT_Full</span> <span class="o">|</span>
			   <span class="n">SUPPORTED_20000baseKR2_Full</span> <span class="o">|</span>
			   <span class="n">SUPPORTED_20000baseMLD2_Full</span> <span class="o">|</span>
			   <span class="n">SUPPORTED_FIBRE</span> <span class="o">|</span>
			   <span class="n">SUPPORTED_Autoneg</span> <span class="o">|</span>
			   <span class="n">SUPPORTED_Pause</span> <span class="o">|</span>
			   <span class="n">SUPPORTED_Asym_Pause</span><span class="p">),</span>
	<span class="p">.</span><span class="n">media_type</span>	<span class="o">=</span> <span class="n">ETH_PHY_UNSPECIFIED</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ver_addr</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">req_flow_ctrl</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">req_line_speed</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">speed_cap_mask</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="cm">/* req_duplex = */</span><span class="mi">0</span><span class="p">,</span>
	<span class="cm">/* rsrv = */</span><span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">config_init</span>	<span class="o">=</span> <span class="p">(</span><span class="n">config_init_t</span><span class="p">)</span><span class="n">bnx2x_warpcore_config_init</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read_status</span>	<span class="o">=</span> <span class="p">(</span><span class="n">read_status_t</span><span class="p">)</span><span class="n">bnx2x_warpcore_read_status</span><span class="p">,</span>
	<span class="p">.</span><span class="n">link_reset</span>	<span class="o">=</span> <span class="p">(</span><span class="n">link_reset_t</span><span class="p">)</span><span class="n">bnx2x_warpcore_link_reset</span><span class="p">,</span>
	<span class="p">.</span><span class="n">config_loopback</span> <span class="o">=</span> <span class="p">(</span><span class="n">config_loopback_t</span><span class="p">)</span><span class="n">bnx2x_set_warpcore_loopback</span><span class="p">,</span>
	<span class="p">.</span><span class="n">format_fw_ver</span>	<span class="o">=</span> <span class="p">(</span><span class="n">format_fw_ver_t</span><span class="p">)</span><span class="nb">NULL</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hw_reset</span>	<span class="o">=</span> <span class="p">(</span><span class="n">hw_reset_t</span><span class="p">)</span><span class="n">bnx2x_warpcore_hw_reset</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_link_led</span>	<span class="o">=</span> <span class="p">(</span><span class="n">set_link_led_t</span><span class="p">)</span><span class="nb">NULL</span><span class="p">,</span>
	<span class="p">.</span><span class="n">phy_specific_func</span> <span class="o">=</span> <span class="p">(</span><span class="n">phy_specific_func_t</span><span class="p">)</span><span class="nb">NULL</span>
<span class="p">};</span>


<span class="k">static</span> <span class="k">struct</span> <span class="n">bnx2x_phy</span> <span class="n">phy_7101</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">type</span>		<span class="o">=</span> <span class="n">PORT_HW_CFG_XGXS_EXT_PHY_TYPE_SFX7101</span><span class="p">,</span>
	<span class="p">.</span><span class="n">addr</span>		<span class="o">=</span> <span class="mh">0xff</span><span class="p">,</span>
	<span class="p">.</span><span class="n">def_md_devad</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">flags</span>		<span class="o">=</span> <span class="n">FLAGS_FAN_FAILURE_DET_REQ</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rx_preemphasis</span>	<span class="o">=</span> <span class="p">{</span><span class="mh">0xffff</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">},</span>
	<span class="p">.</span><span class="n">tx_preemphasis</span>	<span class="o">=</span> <span class="p">{</span><span class="mh">0xffff</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">},</span>
	<span class="p">.</span><span class="n">mdio_ctrl</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">supported</span>	<span class="o">=</span> <span class="p">(</span><span class="n">SUPPORTED_10000baseT_Full</span> <span class="o">|</span>
			   <span class="n">SUPPORTED_TP</span> <span class="o">|</span>
			   <span class="n">SUPPORTED_Autoneg</span> <span class="o">|</span>
			   <span class="n">SUPPORTED_Pause</span> <span class="o">|</span>
			   <span class="n">SUPPORTED_Asym_Pause</span><span class="p">),</span>
	<span class="p">.</span><span class="n">media_type</span>	<span class="o">=</span> <span class="n">ETH_PHY_BASE_T</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ver_addr</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">req_flow_ctrl</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">req_line_speed</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">speed_cap_mask</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">req_duplex</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rsrv</span>		<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">config_init</span>	<span class="o">=</span> <span class="p">(</span><span class="n">config_init_t</span><span class="p">)</span><span class="n">bnx2x_7101_config_init</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read_status</span>	<span class="o">=</span> <span class="p">(</span><span class="n">read_status_t</span><span class="p">)</span><span class="n">bnx2x_7101_read_status</span><span class="p">,</span>
	<span class="p">.</span><span class="n">link_reset</span>	<span class="o">=</span> <span class="p">(</span><span class="n">link_reset_t</span><span class="p">)</span><span class="n">bnx2x_common_ext_link_reset</span><span class="p">,</span>
	<span class="p">.</span><span class="n">config_loopback</span> <span class="o">=</span> <span class="p">(</span><span class="n">config_loopback_t</span><span class="p">)</span><span class="n">bnx2x_7101_config_loopback</span><span class="p">,</span>
	<span class="p">.</span><span class="n">format_fw_ver</span>	<span class="o">=</span> <span class="p">(</span><span class="n">format_fw_ver_t</span><span class="p">)</span><span class="n">bnx2x_7101_format_ver</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hw_reset</span>	<span class="o">=</span> <span class="p">(</span><span class="n">hw_reset_t</span><span class="p">)</span><span class="n">bnx2x_7101_hw_reset</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_link_led</span>	<span class="o">=</span> <span class="p">(</span><span class="n">set_link_led_t</span><span class="p">)</span><span class="n">bnx2x_7101_set_link_led</span><span class="p">,</span>
	<span class="p">.</span><span class="n">phy_specific_func</span> <span class="o">=</span> <span class="p">(</span><span class="n">phy_specific_func_t</span><span class="p">)</span><span class="nb">NULL</span>
<span class="p">};</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">bnx2x_phy</span> <span class="n">phy_8073</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">type</span>		<span class="o">=</span> <span class="n">PORT_HW_CFG_XGXS_EXT_PHY_TYPE_BCM8073</span><span class="p">,</span>
	<span class="p">.</span><span class="n">addr</span>		<span class="o">=</span> <span class="mh">0xff</span><span class="p">,</span>
	<span class="p">.</span><span class="n">def_md_devad</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">flags</span>		<span class="o">=</span> <span class="n">FLAGS_HW_LOCK_REQUIRED</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rx_preemphasis</span>	<span class="o">=</span> <span class="p">{</span><span class="mh">0xffff</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">},</span>
	<span class="p">.</span><span class="n">tx_preemphasis</span>	<span class="o">=</span> <span class="p">{</span><span class="mh">0xffff</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">},</span>
	<span class="p">.</span><span class="n">mdio_ctrl</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">supported</span>	<span class="o">=</span> <span class="p">(</span><span class="n">SUPPORTED_10000baseT_Full</span> <span class="o">|</span>
			   <span class="n">SUPPORTED_2500baseX_Full</span> <span class="o">|</span>
			   <span class="n">SUPPORTED_1000baseT_Full</span> <span class="o">|</span>
			   <span class="n">SUPPORTED_FIBRE</span> <span class="o">|</span>
			   <span class="n">SUPPORTED_Autoneg</span> <span class="o">|</span>
			   <span class="n">SUPPORTED_Pause</span> <span class="o">|</span>
			   <span class="n">SUPPORTED_Asym_Pause</span><span class="p">),</span>
	<span class="p">.</span><span class="n">media_type</span>	<span class="o">=</span> <span class="n">ETH_PHY_KR</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ver_addr</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">req_flow_ctrl</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">req_line_speed</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">speed_cap_mask</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">req_duplex</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rsrv</span>		<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">config_init</span>	<span class="o">=</span> <span class="p">(</span><span class="n">config_init_t</span><span class="p">)</span><span class="n">bnx2x_8073_config_init</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read_status</span>	<span class="o">=</span> <span class="p">(</span><span class="n">read_status_t</span><span class="p">)</span><span class="n">bnx2x_8073_read_status</span><span class="p">,</span>
	<span class="p">.</span><span class="n">link_reset</span>	<span class="o">=</span> <span class="p">(</span><span class="n">link_reset_t</span><span class="p">)</span><span class="n">bnx2x_8073_link_reset</span><span class="p">,</span>
	<span class="p">.</span><span class="n">config_loopback</span> <span class="o">=</span> <span class="p">(</span><span class="n">config_loopback_t</span><span class="p">)</span><span class="nb">NULL</span><span class="p">,</span>
	<span class="p">.</span><span class="n">format_fw_ver</span>	<span class="o">=</span> <span class="p">(</span><span class="n">format_fw_ver_t</span><span class="p">)</span><span class="n">bnx2x_format_ver</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hw_reset</span>	<span class="o">=</span> <span class="p">(</span><span class="n">hw_reset_t</span><span class="p">)</span><span class="nb">NULL</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_link_led</span>	<span class="o">=</span> <span class="p">(</span><span class="n">set_link_led_t</span><span class="p">)</span><span class="nb">NULL</span><span class="p">,</span>
	<span class="p">.</span><span class="n">phy_specific_func</span> <span class="o">=</span> <span class="p">(</span><span class="n">phy_specific_func_t</span><span class="p">)</span><span class="nb">NULL</span>
<span class="p">};</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">bnx2x_phy</span> <span class="n">phy_8705</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">type</span>		<span class="o">=</span> <span class="n">PORT_HW_CFG_XGXS_EXT_PHY_TYPE_BCM8705</span><span class="p">,</span>
	<span class="p">.</span><span class="n">addr</span>		<span class="o">=</span> <span class="mh">0xff</span><span class="p">,</span>
	<span class="p">.</span><span class="n">def_md_devad</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">flags</span>		<span class="o">=</span> <span class="n">FLAGS_INIT_XGXS_FIRST</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rx_preemphasis</span>	<span class="o">=</span> <span class="p">{</span><span class="mh">0xffff</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">},</span>
	<span class="p">.</span><span class="n">tx_preemphasis</span>	<span class="o">=</span> <span class="p">{</span><span class="mh">0xffff</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">},</span>
	<span class="p">.</span><span class="n">mdio_ctrl</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">supported</span>	<span class="o">=</span> <span class="p">(</span><span class="n">SUPPORTED_10000baseT_Full</span> <span class="o">|</span>
			   <span class="n">SUPPORTED_FIBRE</span> <span class="o">|</span>
			   <span class="n">SUPPORTED_Pause</span> <span class="o">|</span>
			   <span class="n">SUPPORTED_Asym_Pause</span><span class="p">),</span>
	<span class="p">.</span><span class="n">media_type</span>	<span class="o">=</span> <span class="n">ETH_PHY_XFP_FIBER</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ver_addr</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">req_flow_ctrl</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">req_line_speed</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">speed_cap_mask</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">req_duplex</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rsrv</span>		<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">config_init</span>	<span class="o">=</span> <span class="p">(</span><span class="n">config_init_t</span><span class="p">)</span><span class="n">bnx2x_8705_config_init</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read_status</span>	<span class="o">=</span> <span class="p">(</span><span class="n">read_status_t</span><span class="p">)</span><span class="n">bnx2x_8705_read_status</span><span class="p">,</span>
	<span class="p">.</span><span class="n">link_reset</span>	<span class="o">=</span> <span class="p">(</span><span class="n">link_reset_t</span><span class="p">)</span><span class="n">bnx2x_common_ext_link_reset</span><span class="p">,</span>
	<span class="p">.</span><span class="n">config_loopback</span> <span class="o">=</span> <span class="p">(</span><span class="n">config_loopback_t</span><span class="p">)</span><span class="nb">NULL</span><span class="p">,</span>
	<span class="p">.</span><span class="n">format_fw_ver</span>	<span class="o">=</span> <span class="p">(</span><span class="n">format_fw_ver_t</span><span class="p">)</span><span class="n">bnx2x_null_format_ver</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hw_reset</span>	<span class="o">=</span> <span class="p">(</span><span class="n">hw_reset_t</span><span class="p">)</span><span class="nb">NULL</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_link_led</span>	<span class="o">=</span> <span class="p">(</span><span class="n">set_link_led_t</span><span class="p">)</span><span class="nb">NULL</span><span class="p">,</span>
	<span class="p">.</span><span class="n">phy_specific_func</span> <span class="o">=</span> <span class="p">(</span><span class="n">phy_specific_func_t</span><span class="p">)</span><span class="nb">NULL</span>
<span class="p">};</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">bnx2x_phy</span> <span class="n">phy_8706</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">type</span>		<span class="o">=</span> <span class="n">PORT_HW_CFG_XGXS_EXT_PHY_TYPE_BCM8706</span><span class="p">,</span>
	<span class="p">.</span><span class="n">addr</span>		<span class="o">=</span> <span class="mh">0xff</span><span class="p">,</span>
	<span class="p">.</span><span class="n">def_md_devad</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">flags</span>		<span class="o">=</span> <span class="n">FLAGS_INIT_XGXS_FIRST</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rx_preemphasis</span>	<span class="o">=</span> <span class="p">{</span><span class="mh">0xffff</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">},</span>
	<span class="p">.</span><span class="n">tx_preemphasis</span>	<span class="o">=</span> <span class="p">{</span><span class="mh">0xffff</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">},</span>
	<span class="p">.</span><span class="n">mdio_ctrl</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">supported</span>	<span class="o">=</span> <span class="p">(</span><span class="n">SUPPORTED_10000baseT_Full</span> <span class="o">|</span>
			   <span class="n">SUPPORTED_1000baseT_Full</span> <span class="o">|</span>
			   <span class="n">SUPPORTED_FIBRE</span> <span class="o">|</span>
			   <span class="n">SUPPORTED_Pause</span> <span class="o">|</span>
			   <span class="n">SUPPORTED_Asym_Pause</span><span class="p">),</span>
	<span class="p">.</span><span class="n">media_type</span>	<span class="o">=</span> <span class="n">ETH_PHY_SFP_FIBER</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ver_addr</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">req_flow_ctrl</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">req_line_speed</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">speed_cap_mask</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">req_duplex</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rsrv</span>		<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">config_init</span>	<span class="o">=</span> <span class="p">(</span><span class="n">config_init_t</span><span class="p">)</span><span class="n">bnx2x_8706_config_init</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read_status</span>	<span class="o">=</span> <span class="p">(</span><span class="n">read_status_t</span><span class="p">)</span><span class="n">bnx2x_8706_read_status</span><span class="p">,</span>
	<span class="p">.</span><span class="n">link_reset</span>	<span class="o">=</span> <span class="p">(</span><span class="n">link_reset_t</span><span class="p">)</span><span class="n">bnx2x_common_ext_link_reset</span><span class="p">,</span>
	<span class="p">.</span><span class="n">config_loopback</span> <span class="o">=</span> <span class="p">(</span><span class="n">config_loopback_t</span><span class="p">)</span><span class="nb">NULL</span><span class="p">,</span>
	<span class="p">.</span><span class="n">format_fw_ver</span>	<span class="o">=</span> <span class="p">(</span><span class="n">format_fw_ver_t</span><span class="p">)</span><span class="n">bnx2x_format_ver</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hw_reset</span>	<span class="o">=</span> <span class="p">(</span><span class="n">hw_reset_t</span><span class="p">)</span><span class="nb">NULL</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_link_led</span>	<span class="o">=</span> <span class="p">(</span><span class="n">set_link_led_t</span><span class="p">)</span><span class="nb">NULL</span><span class="p">,</span>
	<span class="p">.</span><span class="n">phy_specific_func</span> <span class="o">=</span> <span class="p">(</span><span class="n">phy_specific_func_t</span><span class="p">)</span><span class="nb">NULL</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">bnx2x_phy</span> <span class="n">phy_8726</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">type</span>		<span class="o">=</span> <span class="n">PORT_HW_CFG_XGXS_EXT_PHY_TYPE_BCM8726</span><span class="p">,</span>
	<span class="p">.</span><span class="n">addr</span>		<span class="o">=</span> <span class="mh">0xff</span><span class="p">,</span>
	<span class="p">.</span><span class="n">def_md_devad</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">flags</span>		<span class="o">=</span> <span class="p">(</span><span class="n">FLAGS_HW_LOCK_REQUIRED</span> <span class="o">|</span>
			   <span class="n">FLAGS_INIT_XGXS_FIRST</span> <span class="o">|</span>
			   <span class="n">FLAGS_TX_ERROR_CHECK</span><span class="p">),</span>
	<span class="p">.</span><span class="n">rx_preemphasis</span>	<span class="o">=</span> <span class="p">{</span><span class="mh">0xffff</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">},</span>
	<span class="p">.</span><span class="n">tx_preemphasis</span>	<span class="o">=</span> <span class="p">{</span><span class="mh">0xffff</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">},</span>
	<span class="p">.</span><span class="n">mdio_ctrl</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">supported</span>	<span class="o">=</span> <span class="p">(</span><span class="n">SUPPORTED_10000baseT_Full</span> <span class="o">|</span>
			   <span class="n">SUPPORTED_1000baseT_Full</span> <span class="o">|</span>
			   <span class="n">SUPPORTED_Autoneg</span> <span class="o">|</span>
			   <span class="n">SUPPORTED_FIBRE</span> <span class="o">|</span>
			   <span class="n">SUPPORTED_Pause</span> <span class="o">|</span>
			   <span class="n">SUPPORTED_Asym_Pause</span><span class="p">),</span>
	<span class="p">.</span><span class="n">media_type</span>	<span class="o">=</span> <span class="n">ETH_PHY_NOT_PRESENT</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ver_addr</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">req_flow_ctrl</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">req_line_speed</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">speed_cap_mask</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">req_duplex</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rsrv</span>		<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">config_init</span>	<span class="o">=</span> <span class="p">(</span><span class="n">config_init_t</span><span class="p">)</span><span class="n">bnx2x_8726_config_init</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read_status</span>	<span class="o">=</span> <span class="p">(</span><span class="n">read_status_t</span><span class="p">)</span><span class="n">bnx2x_8726_read_status</span><span class="p">,</span>
	<span class="p">.</span><span class="n">link_reset</span>	<span class="o">=</span> <span class="p">(</span><span class="n">link_reset_t</span><span class="p">)</span><span class="n">bnx2x_8726_link_reset</span><span class="p">,</span>
	<span class="p">.</span><span class="n">config_loopback</span> <span class="o">=</span> <span class="p">(</span><span class="n">config_loopback_t</span><span class="p">)</span><span class="n">bnx2x_8726_config_loopback</span><span class="p">,</span>
	<span class="p">.</span><span class="n">format_fw_ver</span>	<span class="o">=</span> <span class="p">(</span><span class="n">format_fw_ver_t</span><span class="p">)</span><span class="n">bnx2x_format_ver</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hw_reset</span>	<span class="o">=</span> <span class="p">(</span><span class="n">hw_reset_t</span><span class="p">)</span><span class="nb">NULL</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_link_led</span>	<span class="o">=</span> <span class="p">(</span><span class="n">set_link_led_t</span><span class="p">)</span><span class="nb">NULL</span><span class="p">,</span>
	<span class="p">.</span><span class="n">phy_specific_func</span> <span class="o">=</span> <span class="p">(</span><span class="n">phy_specific_func_t</span><span class="p">)</span><span class="nb">NULL</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">bnx2x_phy</span> <span class="n">phy_8727</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">type</span>		<span class="o">=</span> <span class="n">PORT_HW_CFG_XGXS_EXT_PHY_TYPE_BCM8727</span><span class="p">,</span>
	<span class="p">.</span><span class="n">addr</span>		<span class="o">=</span> <span class="mh">0xff</span><span class="p">,</span>
	<span class="p">.</span><span class="n">def_md_devad</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">flags</span>		<span class="o">=</span> <span class="p">(</span><span class="n">FLAGS_FAN_FAILURE_DET_REQ</span> <span class="o">|</span>
			   <span class="n">FLAGS_TX_ERROR_CHECK</span><span class="p">),</span>
	<span class="p">.</span><span class="n">rx_preemphasis</span>	<span class="o">=</span> <span class="p">{</span><span class="mh">0xffff</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">},</span>
	<span class="p">.</span><span class="n">tx_preemphasis</span>	<span class="o">=</span> <span class="p">{</span><span class="mh">0xffff</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">},</span>
	<span class="p">.</span><span class="n">mdio_ctrl</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">supported</span>	<span class="o">=</span> <span class="p">(</span><span class="n">SUPPORTED_10000baseT_Full</span> <span class="o">|</span>
			   <span class="n">SUPPORTED_1000baseT_Full</span> <span class="o">|</span>
			   <span class="n">SUPPORTED_FIBRE</span> <span class="o">|</span>
			   <span class="n">SUPPORTED_Pause</span> <span class="o">|</span>
			   <span class="n">SUPPORTED_Asym_Pause</span><span class="p">),</span>
	<span class="p">.</span><span class="n">media_type</span>	<span class="o">=</span> <span class="n">ETH_PHY_NOT_PRESENT</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ver_addr</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">req_flow_ctrl</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">req_line_speed</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">speed_cap_mask</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">req_duplex</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rsrv</span>		<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">config_init</span>	<span class="o">=</span> <span class="p">(</span><span class="n">config_init_t</span><span class="p">)</span><span class="n">bnx2x_8727_config_init</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read_status</span>	<span class="o">=</span> <span class="p">(</span><span class="n">read_status_t</span><span class="p">)</span><span class="n">bnx2x_8727_read_status</span><span class="p">,</span>
	<span class="p">.</span><span class="n">link_reset</span>	<span class="o">=</span> <span class="p">(</span><span class="n">link_reset_t</span><span class="p">)</span><span class="n">bnx2x_8727_link_reset</span><span class="p">,</span>
	<span class="p">.</span><span class="n">config_loopback</span> <span class="o">=</span> <span class="p">(</span><span class="n">config_loopback_t</span><span class="p">)</span><span class="nb">NULL</span><span class="p">,</span>
	<span class="p">.</span><span class="n">format_fw_ver</span>	<span class="o">=</span> <span class="p">(</span><span class="n">format_fw_ver_t</span><span class="p">)</span><span class="n">bnx2x_format_ver</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hw_reset</span>	<span class="o">=</span> <span class="p">(</span><span class="n">hw_reset_t</span><span class="p">)</span><span class="n">bnx2x_8727_hw_reset</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_link_led</span>	<span class="o">=</span> <span class="p">(</span><span class="n">set_link_led_t</span><span class="p">)</span><span class="n">bnx2x_8727_set_link_led</span><span class="p">,</span>
	<span class="p">.</span><span class="n">phy_specific_func</span> <span class="o">=</span> <span class="p">(</span><span class="n">phy_specific_func_t</span><span class="p">)</span><span class="n">bnx2x_8727_specific_func</span>
<span class="p">};</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">bnx2x_phy</span> <span class="n">phy_8481</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">type</span>		<span class="o">=</span> <span class="n">PORT_HW_CFG_XGXS_EXT_PHY_TYPE_BCM8481</span><span class="p">,</span>
	<span class="p">.</span><span class="n">addr</span>		<span class="o">=</span> <span class="mh">0xff</span><span class="p">,</span>
	<span class="p">.</span><span class="n">def_md_devad</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">flags</span>		<span class="o">=</span> <span class="n">FLAGS_FAN_FAILURE_DET_REQ</span> <span class="o">|</span>
			  <span class="n">FLAGS_REARM_LATCH_SIGNAL</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rx_preemphasis</span>	<span class="o">=</span> <span class="p">{</span><span class="mh">0xffff</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">},</span>
	<span class="p">.</span><span class="n">tx_preemphasis</span>	<span class="o">=</span> <span class="p">{</span><span class="mh">0xffff</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">},</span>
	<span class="p">.</span><span class="n">mdio_ctrl</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">supported</span>	<span class="o">=</span> <span class="p">(</span><span class="n">SUPPORTED_10baseT_Half</span> <span class="o">|</span>
			   <span class="n">SUPPORTED_10baseT_Full</span> <span class="o">|</span>
			   <span class="n">SUPPORTED_100baseT_Half</span> <span class="o">|</span>
			   <span class="n">SUPPORTED_100baseT_Full</span> <span class="o">|</span>
			   <span class="n">SUPPORTED_1000baseT_Full</span> <span class="o">|</span>
			   <span class="n">SUPPORTED_10000baseT_Full</span> <span class="o">|</span>
			   <span class="n">SUPPORTED_TP</span> <span class="o">|</span>
			   <span class="n">SUPPORTED_Autoneg</span> <span class="o">|</span>
			   <span class="n">SUPPORTED_Pause</span> <span class="o">|</span>
			   <span class="n">SUPPORTED_Asym_Pause</span><span class="p">),</span>
	<span class="p">.</span><span class="n">media_type</span>	<span class="o">=</span> <span class="n">ETH_PHY_BASE_T</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ver_addr</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">req_flow_ctrl</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">req_line_speed</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">speed_cap_mask</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">req_duplex</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rsrv</span>		<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">config_init</span>	<span class="o">=</span> <span class="p">(</span><span class="n">config_init_t</span><span class="p">)</span><span class="n">bnx2x_8481_config_init</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read_status</span>	<span class="o">=</span> <span class="p">(</span><span class="n">read_status_t</span><span class="p">)</span><span class="n">bnx2x_848xx_read_status</span><span class="p">,</span>
	<span class="p">.</span><span class="n">link_reset</span>	<span class="o">=</span> <span class="p">(</span><span class="n">link_reset_t</span><span class="p">)</span><span class="n">bnx2x_8481_link_reset</span><span class="p">,</span>
	<span class="p">.</span><span class="n">config_loopback</span> <span class="o">=</span> <span class="p">(</span><span class="n">config_loopback_t</span><span class="p">)</span><span class="nb">NULL</span><span class="p">,</span>
	<span class="p">.</span><span class="n">format_fw_ver</span>	<span class="o">=</span> <span class="p">(</span><span class="n">format_fw_ver_t</span><span class="p">)</span><span class="n">bnx2x_848xx_format_ver</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hw_reset</span>	<span class="o">=</span> <span class="p">(</span><span class="n">hw_reset_t</span><span class="p">)</span><span class="n">bnx2x_8481_hw_reset</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_link_led</span>	<span class="o">=</span> <span class="p">(</span><span class="n">set_link_led_t</span><span class="p">)</span><span class="n">bnx2x_848xx_set_link_led</span><span class="p">,</span>
	<span class="p">.</span><span class="n">phy_specific_func</span> <span class="o">=</span> <span class="p">(</span><span class="n">phy_specific_func_t</span><span class="p">)</span><span class="nb">NULL</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">bnx2x_phy</span> <span class="n">phy_84823</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">type</span>		<span class="o">=</span> <span class="n">PORT_HW_CFG_XGXS_EXT_PHY_TYPE_BCM84823</span><span class="p">,</span>
	<span class="p">.</span><span class="n">addr</span>		<span class="o">=</span> <span class="mh">0xff</span><span class="p">,</span>
	<span class="p">.</span><span class="n">def_md_devad</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">flags</span>		<span class="o">=</span> <span class="p">(</span><span class="n">FLAGS_FAN_FAILURE_DET_REQ</span> <span class="o">|</span>
			   <span class="n">FLAGS_REARM_LATCH_SIGNAL</span> <span class="o">|</span>
			   <span class="n">FLAGS_TX_ERROR_CHECK</span><span class="p">),</span>
	<span class="p">.</span><span class="n">rx_preemphasis</span>	<span class="o">=</span> <span class="p">{</span><span class="mh">0xffff</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">},</span>
	<span class="p">.</span><span class="n">tx_preemphasis</span>	<span class="o">=</span> <span class="p">{</span><span class="mh">0xffff</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">},</span>
	<span class="p">.</span><span class="n">mdio_ctrl</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">supported</span>	<span class="o">=</span> <span class="p">(</span><span class="n">SUPPORTED_10baseT_Half</span> <span class="o">|</span>
			   <span class="n">SUPPORTED_10baseT_Full</span> <span class="o">|</span>
			   <span class="n">SUPPORTED_100baseT_Half</span> <span class="o">|</span>
			   <span class="n">SUPPORTED_100baseT_Full</span> <span class="o">|</span>
			   <span class="n">SUPPORTED_1000baseT_Full</span> <span class="o">|</span>
			   <span class="n">SUPPORTED_10000baseT_Full</span> <span class="o">|</span>
			   <span class="n">SUPPORTED_TP</span> <span class="o">|</span>
			   <span class="n">SUPPORTED_Autoneg</span> <span class="o">|</span>
			   <span class="n">SUPPORTED_Pause</span> <span class="o">|</span>
			   <span class="n">SUPPORTED_Asym_Pause</span><span class="p">),</span>
	<span class="p">.</span><span class="n">media_type</span>	<span class="o">=</span> <span class="n">ETH_PHY_BASE_T</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ver_addr</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">req_flow_ctrl</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">req_line_speed</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">speed_cap_mask</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">req_duplex</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rsrv</span>		<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">config_init</span>	<span class="o">=</span> <span class="p">(</span><span class="n">config_init_t</span><span class="p">)</span><span class="n">bnx2x_848x3_config_init</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read_status</span>	<span class="o">=</span> <span class="p">(</span><span class="n">read_status_t</span><span class="p">)</span><span class="n">bnx2x_848xx_read_status</span><span class="p">,</span>
	<span class="p">.</span><span class="n">link_reset</span>	<span class="o">=</span> <span class="p">(</span><span class="n">link_reset_t</span><span class="p">)</span><span class="n">bnx2x_848x3_link_reset</span><span class="p">,</span>
	<span class="p">.</span><span class="n">config_loopback</span> <span class="o">=</span> <span class="p">(</span><span class="n">config_loopback_t</span><span class="p">)</span><span class="nb">NULL</span><span class="p">,</span>
	<span class="p">.</span><span class="n">format_fw_ver</span>	<span class="o">=</span> <span class="p">(</span><span class="n">format_fw_ver_t</span><span class="p">)</span><span class="n">bnx2x_848xx_format_ver</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hw_reset</span>	<span class="o">=</span> <span class="p">(</span><span class="n">hw_reset_t</span><span class="p">)</span><span class="nb">NULL</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_link_led</span>	<span class="o">=</span> <span class="p">(</span><span class="n">set_link_led_t</span><span class="p">)</span><span class="n">bnx2x_848xx_set_link_led</span><span class="p">,</span>
	<span class="p">.</span><span class="n">phy_specific_func</span> <span class="o">=</span> <span class="p">(</span><span class="n">phy_specific_func_t</span><span class="p">)</span><span class="nb">NULL</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">bnx2x_phy</span> <span class="n">phy_84833</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">type</span>		<span class="o">=</span> <span class="n">PORT_HW_CFG_XGXS_EXT_PHY_TYPE_BCM84833</span><span class="p">,</span>
	<span class="p">.</span><span class="n">addr</span>		<span class="o">=</span> <span class="mh">0xff</span><span class="p">,</span>
	<span class="p">.</span><span class="n">def_md_devad</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">flags</span>		<span class="o">=</span> <span class="p">(</span><span class="n">FLAGS_FAN_FAILURE_DET_REQ</span> <span class="o">|</span>
			   <span class="n">FLAGS_REARM_LATCH_SIGNAL</span> <span class="o">|</span>
			   <span class="n">FLAGS_TX_ERROR_CHECK</span><span class="p">),</span>
	<span class="p">.</span><span class="n">rx_preemphasis</span>	<span class="o">=</span> <span class="p">{</span><span class="mh">0xffff</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">},</span>
	<span class="p">.</span><span class="n">tx_preemphasis</span>	<span class="o">=</span> <span class="p">{</span><span class="mh">0xffff</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">},</span>
	<span class="p">.</span><span class="n">mdio_ctrl</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">supported</span>	<span class="o">=</span> <span class="p">(</span><span class="n">SUPPORTED_100baseT_Half</span> <span class="o">|</span>
			   <span class="n">SUPPORTED_100baseT_Full</span> <span class="o">|</span>
			   <span class="n">SUPPORTED_1000baseT_Full</span> <span class="o">|</span>
			   <span class="n">SUPPORTED_10000baseT_Full</span> <span class="o">|</span>
			   <span class="n">SUPPORTED_TP</span> <span class="o">|</span>
			   <span class="n">SUPPORTED_Autoneg</span> <span class="o">|</span>
			   <span class="n">SUPPORTED_Pause</span> <span class="o">|</span>
			   <span class="n">SUPPORTED_Asym_Pause</span><span class="p">),</span>
	<span class="p">.</span><span class="n">media_type</span>	<span class="o">=</span> <span class="n">ETH_PHY_BASE_T</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ver_addr</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">req_flow_ctrl</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">req_line_speed</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">speed_cap_mask</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">req_duplex</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rsrv</span>		<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">config_init</span>	<span class="o">=</span> <span class="p">(</span><span class="n">config_init_t</span><span class="p">)</span><span class="n">bnx2x_848x3_config_init</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read_status</span>	<span class="o">=</span> <span class="p">(</span><span class="n">read_status_t</span><span class="p">)</span><span class="n">bnx2x_848xx_read_status</span><span class="p">,</span>
	<span class="p">.</span><span class="n">link_reset</span>	<span class="o">=</span> <span class="p">(</span><span class="n">link_reset_t</span><span class="p">)</span><span class="n">bnx2x_848x3_link_reset</span><span class="p">,</span>
	<span class="p">.</span><span class="n">config_loopback</span> <span class="o">=</span> <span class="p">(</span><span class="n">config_loopback_t</span><span class="p">)</span><span class="nb">NULL</span><span class="p">,</span>
	<span class="p">.</span><span class="n">format_fw_ver</span>	<span class="o">=</span> <span class="p">(</span><span class="n">format_fw_ver_t</span><span class="p">)</span><span class="n">bnx2x_848xx_format_ver</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hw_reset</span>	<span class="o">=</span> <span class="p">(</span><span class="n">hw_reset_t</span><span class="p">)</span><span class="n">bnx2x_84833_hw_reset_phy</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_link_led</span>	<span class="o">=</span> <span class="p">(</span><span class="n">set_link_led_t</span><span class="p">)</span><span class="n">bnx2x_848xx_set_link_led</span><span class="p">,</span>
	<span class="p">.</span><span class="n">phy_specific_func</span> <span class="o">=</span> <span class="p">(</span><span class="n">phy_specific_func_t</span><span class="p">)</span><span class="nb">NULL</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">bnx2x_phy</span> <span class="n">phy_54618se</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">type</span>		<span class="o">=</span> <span class="n">PORT_HW_CFG_XGXS_EXT_PHY_TYPE_BCM54618SE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">addr</span>		<span class="o">=</span> <span class="mh">0xff</span><span class="p">,</span>
	<span class="p">.</span><span class="n">def_md_devad</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">flags</span>		<span class="o">=</span> <span class="n">FLAGS_INIT_XGXS_FIRST</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rx_preemphasis</span>	<span class="o">=</span> <span class="p">{</span><span class="mh">0xffff</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">},</span>
	<span class="p">.</span><span class="n">tx_preemphasis</span>	<span class="o">=</span> <span class="p">{</span><span class="mh">0xffff</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">},</span>
	<span class="p">.</span><span class="n">mdio_ctrl</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">supported</span>	<span class="o">=</span> <span class="p">(</span><span class="n">SUPPORTED_10baseT_Half</span> <span class="o">|</span>
			   <span class="n">SUPPORTED_10baseT_Full</span> <span class="o">|</span>
			   <span class="n">SUPPORTED_100baseT_Half</span> <span class="o">|</span>
			   <span class="n">SUPPORTED_100baseT_Full</span> <span class="o">|</span>
			   <span class="n">SUPPORTED_1000baseT_Full</span> <span class="o">|</span>
			   <span class="n">SUPPORTED_TP</span> <span class="o">|</span>
			   <span class="n">SUPPORTED_Autoneg</span> <span class="o">|</span>
			   <span class="n">SUPPORTED_Pause</span> <span class="o">|</span>
			   <span class="n">SUPPORTED_Asym_Pause</span><span class="p">),</span>
	<span class="p">.</span><span class="n">media_type</span>	<span class="o">=</span> <span class="n">ETH_PHY_BASE_T</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ver_addr</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">req_flow_ctrl</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">req_line_speed</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">speed_cap_mask</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="cm">/* req_duplex = */</span><span class="mi">0</span><span class="p">,</span>
	<span class="cm">/* rsrv = */</span><span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">config_init</span>	<span class="o">=</span> <span class="p">(</span><span class="n">config_init_t</span><span class="p">)</span><span class="n">bnx2x_54618se_config_init</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read_status</span>	<span class="o">=</span> <span class="p">(</span><span class="n">read_status_t</span><span class="p">)</span><span class="n">bnx2x_54618se_read_status</span><span class="p">,</span>
	<span class="p">.</span><span class="n">link_reset</span>	<span class="o">=</span> <span class="p">(</span><span class="n">link_reset_t</span><span class="p">)</span><span class="n">bnx2x_54618se_link_reset</span><span class="p">,</span>
	<span class="p">.</span><span class="n">config_loopback</span> <span class="o">=</span> <span class="p">(</span><span class="n">config_loopback_t</span><span class="p">)</span><span class="n">bnx2x_54618se_config_loopback</span><span class="p">,</span>
	<span class="p">.</span><span class="n">format_fw_ver</span>	<span class="o">=</span> <span class="p">(</span><span class="n">format_fw_ver_t</span><span class="p">)</span><span class="nb">NULL</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hw_reset</span>	<span class="o">=</span> <span class="p">(</span><span class="n">hw_reset_t</span><span class="p">)</span><span class="nb">NULL</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_link_led</span>	<span class="o">=</span> <span class="p">(</span><span class="n">set_link_led_t</span><span class="p">)</span><span class="n">bnx2x_5461x_set_link_led</span><span class="p">,</span>
	<span class="p">.</span><span class="n">phy_specific_func</span> <span class="o">=</span> <span class="p">(</span><span class="n">phy_specific_func_t</span><span class="p">)</span><span class="nb">NULL</span>
<span class="p">};</span>
<span class="cm">/*****************************************************************/</span>
<span class="cm">/*                                                               */</span>
<span class="cm">/* Populate the phy according. Main function: bnx2x_populate_phy   */</span>
<span class="cm">/*                                                               */</span>
<span class="cm">/*****************************************************************/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_populate_preemphasis</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">,</span> <span class="n">u32</span> <span class="n">shmem_base</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">bnx2x_phy</span> <span class="o">*</span><span class="n">phy</span><span class="p">,</span> <span class="n">u8</span> <span class="n">port</span><span class="p">,</span>
				     <span class="n">u8</span> <span class="n">phy_index</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Get the 4 lanes xgxs config rx and tx */</span>
	<span class="n">u32</span> <span class="n">rx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">tx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* INT_PHY and EXT_PHY1 share the same value location in</span>
<span class="cm">		 * the shmem. When num_phys is greater than 1, than this value</span>
<span class="cm">		 * applies only to EXT_PHY1</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">phy_index</span> <span class="o">==</span> <span class="n">INT_PHY</span> <span class="o">||</span> <span class="n">phy_index</span> <span class="o">==</span> <span class="n">EXT_PHY1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rx</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">shmem_base</span> <span class="o">+</span>
				    <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">shmem_region</span><span class="p">,</span>
			  <span class="n">dev_info</span><span class="p">.</span><span class="n">port_hw_config</span><span class="p">[</span><span class="n">port</span><span class="p">].</span><span class="n">xgxs_config_rx</span><span class="p">[</span><span class="n">i</span><span class="o">&lt;&lt;</span><span class="mi">1</span><span class="p">]));</span>

			<span class="n">tx</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">shmem_base</span> <span class="o">+</span>
				    <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">shmem_region</span><span class="p">,</span>
			  <span class="n">dev_info</span><span class="p">.</span><span class="n">port_hw_config</span><span class="p">[</span><span class="n">port</span><span class="p">].</span><span class="n">xgxs_config_tx</span><span class="p">[</span><span class="n">i</span><span class="o">&lt;&lt;</span><span class="mi">1</span><span class="p">]));</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">rx</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">shmem_base</span> <span class="o">+</span>
				    <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">shmem_region</span><span class="p">,</span>
			 <span class="n">dev_info</span><span class="p">.</span><span class="n">port_hw_config</span><span class="p">[</span><span class="n">port</span><span class="p">].</span><span class="n">xgxs_config2_rx</span><span class="p">[</span><span class="n">i</span><span class="o">&lt;&lt;</span><span class="mi">1</span><span class="p">]));</span>

			<span class="n">tx</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">shmem_base</span> <span class="o">+</span>
				    <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">shmem_region</span><span class="p">,</span>
			 <span class="n">dev_info</span><span class="p">.</span><span class="n">port_hw_config</span><span class="p">[</span><span class="n">port</span><span class="p">].</span><span class="n">xgxs_config2_rx</span><span class="p">[</span><span class="n">i</span><span class="o">&lt;&lt;</span><span class="mi">1</span><span class="p">]));</span>
		<span class="p">}</span>

		<span class="n">phy</span><span class="o">-&gt;</span><span class="n">rx_preemphasis</span><span class="p">[</span><span class="n">i</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">rx</span><span class="o">&gt;&gt;</span><span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">);</span>
		<span class="n">phy</span><span class="o">-&gt;</span><span class="n">rx_preemphasis</span><span class="p">[(</span><span class="n">i</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">rx</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">);</span>

		<span class="n">phy</span><span class="o">-&gt;</span><span class="n">tx_preemphasis</span><span class="p">[</span><span class="n">i</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">tx</span><span class="o">&gt;&gt;</span><span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">);</span>
		<span class="n">phy</span><span class="o">-&gt;</span><span class="n">tx_preemphasis</span><span class="p">[(</span><span class="n">i</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">tx</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">bnx2x_get_ext_phy_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">,</span> <span class="n">u32</span> <span class="n">shmem_base</span><span class="p">,</span>
				    <span class="n">u8</span> <span class="n">phy_index</span><span class="p">,</span> <span class="n">u8</span> <span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">ext_phy_config</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">phy_index</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">EXT_PHY1</span>:
		<span class="n">ext_phy_config</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">shmem_base</span> <span class="o">+</span>
					      <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">shmem_region</span><span class="p">,</span>
			<span class="n">dev_info</span><span class="p">.</span><span class="n">port_hw_config</span><span class="p">[</span><span class="n">port</span><span class="p">].</span><span class="n">external_phy_config</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">EXT_PHY2</span>:
		<span class="n">ext_phy_config</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">shmem_base</span> <span class="o">+</span>
					      <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">shmem_region</span><span class="p">,</span>
			<span class="n">dev_info</span><span class="p">.</span><span class="n">port_hw_config</span><span class="p">[</span><span class="n">port</span><span class="p">].</span><span class="n">external_phy_config2</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;Invalid phy_index %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">phy_index</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ext_phy_config</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">bnx2x_populate_int_phy</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">,</span> <span class="n">u32</span> <span class="n">shmem_base</span><span class="p">,</span> <span class="n">u8</span> <span class="n">port</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">bnx2x_phy</span> <span class="o">*</span><span class="n">phy</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">phy_addr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">chip_id</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">switch_cfg</span> <span class="o">=</span> <span class="p">(</span><span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">shmem_base</span> <span class="o">+</span>
				       <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">shmem_region</span><span class="p">,</span>
			<span class="n">dev_info</span><span class="p">.</span><span class="n">port_feature_config</span><span class="p">[</span><span class="n">port</span><span class="p">].</span><span class="n">link_config</span><span class="p">))</span> <span class="o">&amp;</span>
			  <span class="n">PORT_FEATURE_CONNECTED_SWITCH_MASK</span><span class="p">);</span>
	<span class="n">chip_id</span> <span class="o">=</span> <span class="p">(</span><span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">MISC_REG_CHIP_NUM</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">((</span><span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">MISC_REG_CHIP_REV</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">);</span>

	<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;:chip_id = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">chip_id</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">USES_WARPCORE</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">serdes_net_if</span><span class="p">;</span>
		<span class="n">phy_addr</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span>
				  <span class="n">MISC_REG_WC0_CTRL_PHY_ADDR</span><span class="p">);</span>
		<span class="o">*</span><span class="n">phy</span> <span class="o">=</span> <span class="n">phy_warpcore</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">MISC_REG_PORT4MODE_EN_OVWR</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x3</span><span class="p">)</span>
			<span class="n">phy</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">FLAGS_4_PORT_MODE</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">phy</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">FLAGS_4_PORT_MODE</span><span class="p">;</span>
			<span class="cm">/* Check Dual mode */</span>
		<span class="n">serdes_net_if</span> <span class="o">=</span> <span class="p">(</span><span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">shmem_base</span> <span class="o">+</span>
					<span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">shmem_region</span><span class="p">,</span> <span class="n">dev_info</span><span class="p">.</span>
					<span class="n">port_hw_config</span><span class="p">[</span><span class="n">port</span><span class="p">].</span><span class="n">default_cfg</span><span class="p">))</span> <span class="o">&amp;</span>
				 <span class="n">PORT_HW_CFG_NET_SERDES_IF_MASK</span><span class="p">);</span>
		<span class="cm">/* Set the appropriate supported and flags indications per</span>
<span class="cm">		 * interface type of the chip</span>
<span class="cm">		 */</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">serdes_net_if</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">PORT_HW_CFG_NET_SERDES_IF_SGMII</span>:
			<span class="n">phy</span><span class="o">-&gt;</span><span class="n">supported</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="n">SUPPORTED_10baseT_Half</span> <span class="o">|</span>
					   <span class="n">SUPPORTED_10baseT_Full</span> <span class="o">|</span>
					   <span class="n">SUPPORTED_100baseT_Half</span> <span class="o">|</span>
					   <span class="n">SUPPORTED_100baseT_Full</span> <span class="o">|</span>
					   <span class="n">SUPPORTED_1000baseT_Full</span> <span class="o">|</span>
					   <span class="n">SUPPORTED_FIBRE</span> <span class="o">|</span>
					   <span class="n">SUPPORTED_Autoneg</span> <span class="o">|</span>
					   <span class="n">SUPPORTED_Pause</span> <span class="o">|</span>
					   <span class="n">SUPPORTED_Asym_Pause</span><span class="p">);</span>
			<span class="n">phy</span><span class="o">-&gt;</span><span class="n">media_type</span> <span class="o">=</span> <span class="n">ETH_PHY_BASE_T</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">PORT_HW_CFG_NET_SERDES_IF_XFI</span>:
			<span class="n">phy</span><span class="o">-&gt;</span><span class="n">media_type</span> <span class="o">=</span> <span class="n">ETH_PHY_XFP_FIBER</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">PORT_HW_CFG_NET_SERDES_IF_SFI</span>:
			<span class="n">phy</span><span class="o">-&gt;</span><span class="n">supported</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="n">SUPPORTED_1000baseT_Full</span> <span class="o">|</span>
					   <span class="n">SUPPORTED_10000baseT_Full</span> <span class="o">|</span>
					   <span class="n">SUPPORTED_FIBRE</span> <span class="o">|</span>
					   <span class="n">SUPPORTED_Pause</span> <span class="o">|</span>
					   <span class="n">SUPPORTED_Asym_Pause</span><span class="p">);</span>
			<span class="n">phy</span><span class="o">-&gt;</span><span class="n">media_type</span> <span class="o">=</span> <span class="n">ETH_PHY_SFP_FIBER</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">PORT_HW_CFG_NET_SERDES_IF_KR</span>:
			<span class="n">phy</span><span class="o">-&gt;</span><span class="n">media_type</span> <span class="o">=</span> <span class="n">ETH_PHY_KR</span><span class="p">;</span>
			<span class="n">phy</span><span class="o">-&gt;</span><span class="n">supported</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="n">SUPPORTED_1000baseT_Full</span> <span class="o">|</span>
					   <span class="n">SUPPORTED_10000baseT_Full</span> <span class="o">|</span>
					   <span class="n">SUPPORTED_FIBRE</span> <span class="o">|</span>
					   <span class="n">SUPPORTED_Autoneg</span> <span class="o">|</span>
					   <span class="n">SUPPORTED_Pause</span> <span class="o">|</span>
					   <span class="n">SUPPORTED_Asym_Pause</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">PORT_HW_CFG_NET_SERDES_IF_DXGXS</span>:
			<span class="n">phy</span><span class="o">-&gt;</span><span class="n">media_type</span> <span class="o">=</span> <span class="n">ETH_PHY_KR</span><span class="p">;</span>
			<span class="n">phy</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">FLAGS_WC_DUAL_MODE</span><span class="p">;</span>
			<span class="n">phy</span><span class="o">-&gt;</span><span class="n">supported</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="n">SUPPORTED_20000baseMLD2_Full</span> <span class="o">|</span>
					   <span class="n">SUPPORTED_FIBRE</span> <span class="o">|</span>
					   <span class="n">SUPPORTED_Pause</span> <span class="o">|</span>
					   <span class="n">SUPPORTED_Asym_Pause</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">PORT_HW_CFG_NET_SERDES_IF_KR2</span>:
			<span class="n">phy</span><span class="o">-&gt;</span><span class="n">media_type</span> <span class="o">=</span> <span class="n">ETH_PHY_KR</span><span class="p">;</span>
			<span class="n">phy</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">FLAGS_WC_DUAL_MODE</span><span class="p">;</span>
			<span class="n">phy</span><span class="o">-&gt;</span><span class="n">supported</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="n">SUPPORTED_20000baseKR2_Full</span> <span class="o">|</span>
					   <span class="n">SUPPORTED_FIBRE</span> <span class="o">|</span>
					   <span class="n">SUPPORTED_Pause</span> <span class="o">|</span>
					   <span class="n">SUPPORTED_Asym_Pause</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;Unknown WC interface type 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">serdes_net_if</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Enable MDC/MDIO work-around for E3 A0 since free running MDC</span>
<span class="cm">		 * was not set as expected. For B0, ECO will be enabled so there</span>
<span class="cm">		 * won&#39;t be an issue there</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">CHIP_REV</span><span class="p">(</span><span class="n">bp</span><span class="p">)</span> <span class="o">==</span> <span class="n">CHIP_REV_Ax</span><span class="p">)</span>
			<span class="n">phy</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">FLAGS_MDC_MDIO_WA</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">phy</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">FLAGS_MDC_MDIO_WA_B0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">switch_cfg</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">SWITCH_CFG_1G</span>:
			<span class="n">phy_addr</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span>
					  <span class="n">NIG_REG_SERDES0_CTRL_PHY_ADDR</span> <span class="o">+</span>
					  <span class="n">port</span> <span class="o">*</span> <span class="mh">0x10</span><span class="p">);</span>
			<span class="o">*</span><span class="n">phy</span> <span class="o">=</span> <span class="n">phy_serdes</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">SWITCH_CFG_10G</span>:
			<span class="n">phy_addr</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span>
					  <span class="n">NIG_REG_XGXS0_CTRL_PHY_ADDR</span> <span class="o">+</span>
					  <span class="n">port</span> <span class="o">*</span> <span class="mh">0x18</span><span class="p">);</span>
			<span class="o">*</span><span class="n">phy</span> <span class="o">=</span> <span class="n">phy_xgxs</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;Invalid switch_cfg</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">phy</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">phy_addr</span><span class="p">;</span>
	<span class="n">phy</span><span class="o">-&gt;</span><span class="n">mdio_ctrl</span> <span class="o">=</span> <span class="n">bnx2x_get_emac_base</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span>
					    <span class="n">SHARED_HW_CFG_MDC_MDIO_ACCESS1_BOTH</span><span class="p">,</span>
					    <span class="n">port</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">CHIP_IS_E2</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span>
		<span class="n">phy</span><span class="o">-&gt;</span><span class="n">def_md_devad</span> <span class="o">=</span> <span class="n">E2_DEFAULT_PHY_DEV_ADDR</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">phy</span><span class="o">-&gt;</span><span class="n">def_md_devad</span> <span class="o">=</span> <span class="n">DEFAULT_PHY_DEV_ADDR</span><span class="p">;</span>

	<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;Internal phy port=%d, addr=0x%x, mdio_ctl=0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">port</span><span class="p">,</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">mdio_ctrl</span><span class="p">);</span>

	<span class="n">bnx2x_populate_preemphasis</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">shmem_base</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">INT_PHY</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bnx2x_populate_ext_phy</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">,</span>
				  <span class="n">u8</span> <span class="n">phy_index</span><span class="p">,</span>
				  <span class="n">u32</span> <span class="n">shmem_base</span><span class="p">,</span>
				  <span class="n">u32</span> <span class="n">shmem2_base</span><span class="p">,</span>
				  <span class="n">u8</span> <span class="n">port</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">bnx2x_phy</span> <span class="o">*</span><span class="n">phy</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">ext_phy_config</span><span class="p">,</span> <span class="n">phy_type</span><span class="p">,</span> <span class="n">config2</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">mdc_mdio_access</span> <span class="o">=</span> <span class="n">SHARED_HW_CFG_MDC_MDIO_ACCESS1_BOTH</span><span class="p">;</span>
	<span class="n">ext_phy_config</span> <span class="o">=</span> <span class="n">bnx2x_get_ext_phy_config</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">shmem_base</span><span class="p">,</span>
						  <span class="n">phy_index</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>
	<span class="n">phy_type</span> <span class="o">=</span> <span class="n">XGXS_EXT_PHY_TYPE</span><span class="p">(</span><span class="n">ext_phy_config</span><span class="p">);</span>
	<span class="cm">/* Select the phy type */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">phy_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PORT_HW_CFG_XGXS_EXT_PHY_TYPE_BCM8073</span>:
		<span class="n">mdc_mdio_access</span> <span class="o">=</span> <span class="n">SHARED_HW_CFG_MDC_MDIO_ACCESS1_SWAPPED</span><span class="p">;</span>
		<span class="o">*</span><span class="n">phy</span> <span class="o">=</span> <span class="n">phy_8073</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PORT_HW_CFG_XGXS_EXT_PHY_TYPE_BCM8705</span>:
		<span class="o">*</span><span class="n">phy</span> <span class="o">=</span> <span class="n">phy_8705</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PORT_HW_CFG_XGXS_EXT_PHY_TYPE_BCM8706</span>:
		<span class="o">*</span><span class="n">phy</span> <span class="o">=</span> <span class="n">phy_8706</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PORT_HW_CFG_XGXS_EXT_PHY_TYPE_BCM8726</span>:
		<span class="n">mdc_mdio_access</span> <span class="o">=</span> <span class="n">SHARED_HW_CFG_MDC_MDIO_ACCESS1_EMAC1</span><span class="p">;</span>
		<span class="o">*</span><span class="n">phy</span> <span class="o">=</span> <span class="n">phy_8726</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PORT_HW_CFG_XGXS_EXT_PHY_TYPE_BCM8727_NOC</span>:
		<span class="cm">/* BCM8727_NOC =&gt; BCM8727 no over current */</span>
		<span class="n">mdc_mdio_access</span> <span class="o">=</span> <span class="n">SHARED_HW_CFG_MDC_MDIO_ACCESS1_EMAC1</span><span class="p">;</span>
		<span class="o">*</span><span class="n">phy</span> <span class="o">=</span> <span class="n">phy_8727</span><span class="p">;</span>
		<span class="n">phy</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">FLAGS_NOC</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PORT_HW_CFG_XGXS_EXT_PHY_TYPE_BCM8722</span>:
	<span class="k">case</span> <span class="n">PORT_HW_CFG_XGXS_EXT_PHY_TYPE_BCM8727</span>:
		<span class="n">mdc_mdio_access</span> <span class="o">=</span> <span class="n">SHARED_HW_CFG_MDC_MDIO_ACCESS1_EMAC1</span><span class="p">;</span>
		<span class="o">*</span><span class="n">phy</span> <span class="o">=</span> <span class="n">phy_8727</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PORT_HW_CFG_XGXS_EXT_PHY_TYPE_BCM8481</span>:
		<span class="o">*</span><span class="n">phy</span> <span class="o">=</span> <span class="n">phy_8481</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PORT_HW_CFG_XGXS_EXT_PHY_TYPE_BCM84823</span>:
		<span class="o">*</span><span class="n">phy</span> <span class="o">=</span> <span class="n">phy_84823</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PORT_HW_CFG_XGXS_EXT_PHY_TYPE_BCM84833</span>:
		<span class="o">*</span><span class="n">phy</span> <span class="o">=</span> <span class="n">phy_84833</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PORT_HW_CFG_XGXS_EXT_PHY_TYPE_BCM54616</span>:
	<span class="k">case</span> <span class="n">PORT_HW_CFG_XGXS_EXT_PHY_TYPE_BCM54618SE</span>:
		<span class="o">*</span><span class="n">phy</span> <span class="o">=</span> <span class="n">phy_54618se</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PORT_HW_CFG_XGXS_EXT_PHY_TYPE_SFX7101</span>:
		<span class="o">*</span><span class="n">phy</span> <span class="o">=</span> <span class="n">phy_7101</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PORT_HW_CFG_XGXS_EXT_PHY_TYPE_FAILURE</span>:
		<span class="o">*</span><span class="n">phy</span> <span class="o">=</span> <span class="n">phy_null</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="o">*</span><span class="n">phy</span> <span class="o">=</span> <span class="n">phy_null</span><span class="p">;</span>
		<span class="cm">/* In case external PHY wasn&#39;t found */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">phy_type</span> <span class="o">!=</span> <span class="n">PORT_HW_CFG_XGXS_EXT_PHY_TYPE_DIRECT</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">phy_type</span> <span class="o">!=</span> <span class="n">PORT_HW_CFG_XGXS_EXT_PHY_TYPE_NOT_CONN</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">phy</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">=</span> <span class="n">XGXS_EXT_PHY_ADDR</span><span class="p">(</span><span class="n">ext_phy_config</span><span class="p">);</span>
	<span class="n">bnx2x_populate_preemphasis</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">shmem_base</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">phy_index</span><span class="p">);</span>

	<span class="cm">/* The shmem address of the phy version is located on different</span>
<span class="cm">	 * structures. In case this structure is too old, do not set</span>
<span class="cm">	 * the address</span>
<span class="cm">	 */</span>
	<span class="n">config2</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">shmem_base</span> <span class="o">+</span> <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">shmem_region</span><span class="p">,</span>
					<span class="n">dev_info</span><span class="p">.</span><span class="n">shared_hw_config</span><span class="p">.</span><span class="n">config2</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phy_index</span> <span class="o">==</span> <span class="n">EXT_PHY1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">phy</span><span class="o">-&gt;</span><span class="n">ver_addr</span> <span class="o">=</span> <span class="n">shmem_base</span> <span class="o">+</span> <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">shmem_region</span><span class="p">,</span>
				<span class="n">port_mb</span><span class="p">[</span><span class="n">port</span><span class="p">].</span><span class="n">ext_phy_fw_version</span><span class="p">);</span>

		<span class="cm">/* Check specific mdc mdio settings */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">config2</span> <span class="o">&amp;</span> <span class="n">SHARED_HW_CFG_MDC_MDIO_ACCESS1_MASK</span><span class="p">)</span>
			<span class="n">mdc_mdio_access</span> <span class="o">=</span> <span class="n">config2</span> <span class="o">&amp;</span>
			<span class="n">SHARED_HW_CFG_MDC_MDIO_ACCESS1_MASK</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">size</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">shmem2_base</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">&gt;</span>
		    <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">shmem2_region</span><span class="p">,</span> <span class="n">ext_phy_fw_version2</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">phy</span><span class="o">-&gt;</span><span class="n">ver_addr</span> <span class="o">=</span> <span class="n">shmem2_base</span> <span class="o">+</span>
			    <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">shmem2_region</span><span class="p">,</span>
				     <span class="n">ext_phy_fw_version2</span><span class="p">[</span><span class="n">port</span><span class="p">]);</span>
		<span class="p">}</span>
		<span class="cm">/* Check specific mdc mdio settings */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">config2</span> <span class="o">&amp;</span> <span class="n">SHARED_HW_CFG_MDC_MDIO_ACCESS2_MASK</span><span class="p">)</span>
			<span class="n">mdc_mdio_access</span> <span class="o">=</span> <span class="p">(</span><span class="n">config2</span> <span class="o">&amp;</span>
			<span class="n">SHARED_HW_CFG_MDC_MDIO_ACCESS2_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span>
			<span class="p">(</span><span class="n">SHARED_HW_CFG_MDC_MDIO_ACCESS2_SHIFT</span> <span class="o">-</span>
			 <span class="n">SHARED_HW_CFG_MDC_MDIO_ACCESS1_SHIFT</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">phy</span><span class="o">-&gt;</span><span class="n">mdio_ctrl</span> <span class="o">=</span> <span class="n">bnx2x_get_emac_base</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">mdc_mdio_access</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">PORT_HW_CFG_XGXS_EXT_PHY_TYPE_BCM84833</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">ver_addr</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Remove 100Mb link supported for BCM84833 when phy fw</span>
<span class="cm">		 * version lower than or equal to 1.39</span>
<span class="cm">		 */</span>
		<span class="n">u32</span> <span class="n">raw_ver</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">ver_addr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(((</span><span class="n">raw_ver</span> <span class="o">&amp;</span> <span class="mh">0x7F</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">39</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(((</span><span class="n">raw_ver</span> <span class="o">&amp;</span> <span class="mh">0xF80</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">))</span>
			<span class="n">phy</span><span class="o">-&gt;</span><span class="n">supported</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">SUPPORTED_100baseT_Half</span> <span class="o">|</span>
					    <span class="n">SUPPORTED_100baseT_Full</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* In case mdc/mdio_access of the external phy is different than the</span>
<span class="cm">	 * mdc/mdio access of the XGXS, a HW lock must be taken in each access</span>
<span class="cm">	 * to prevent one port interfere with another port&#39;s CL45 operations.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mdc_mdio_access</span> <span class="o">!=</span> <span class="n">SHARED_HW_CFG_MDC_MDIO_ACCESS1_BOTH</span><span class="p">)</span>
		<span class="n">phy</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">FLAGS_HW_LOCK_REQUIRED</span><span class="p">;</span>
	<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;phy_type 0x%x port %d found in index %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">phy_type</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">phy_index</span><span class="p">);</span>
	<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;             addr=0x%x, mdio_ctl=0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">phy</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">mdio_ctrl</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bnx2x_populate_phy</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">,</span> <span class="n">u8</span> <span class="n">phy_index</span><span class="p">,</span> <span class="n">u32</span> <span class="n">shmem_base</span><span class="p">,</span>
			      <span class="n">u32</span> <span class="n">shmem2_base</span><span class="p">,</span> <span class="n">u8</span> <span class="n">port</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bnx2x_phy</span> <span class="o">*</span><span class="n">phy</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">phy</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">PORT_HW_CFG_XGXS_EXT_PHY_TYPE_NOT_CONN</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phy_index</span> <span class="o">==</span> <span class="n">INT_PHY</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">bnx2x_populate_int_phy</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">shmem_base</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">phy</span><span class="p">);</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">bnx2x_populate_ext_phy</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy_index</span><span class="p">,</span> <span class="n">shmem_base</span><span class="p">,</span> <span class="n">shmem2_base</span><span class="p">,</span>
					<span class="n">port</span><span class="p">,</span> <span class="n">phy</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_phy_def_cfg</span><span class="p">(</span><span class="k">struct</span> <span class="n">link_params</span> <span class="o">*</span><span class="n">params</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">bnx2x_phy</span> <span class="o">*</span><span class="n">phy</span><span class="p">,</span>
			      <span class="n">u8</span> <span class="n">phy_index</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">bp</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">link_config</span><span class="p">;</span>
	<span class="cm">/* Populate the default phy configuration for MF mode */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phy_index</span> <span class="o">==</span> <span class="n">EXT_PHY2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">link_config</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">shmem_base</span> <span class="o">+</span>
				     <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">shmem_region</span><span class="p">,</span> <span class="n">dev_info</span><span class="p">.</span>
			<span class="n">port_feature_config</span><span class="p">[</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">].</span><span class="n">link_config2</span><span class="p">));</span>
		<span class="n">phy</span><span class="o">-&gt;</span><span class="n">speed_cap_mask</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">shmem_base</span> <span class="o">+</span>
					     <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">shmem_region</span><span class="p">,</span>
						      <span class="n">dev_info</span><span class="p">.</span>
			<span class="n">port_hw_config</span><span class="p">[</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">].</span><span class="n">speed_capability_mask2</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">link_config</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">shmem_base</span> <span class="o">+</span>
				     <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">shmem_region</span><span class="p">,</span> <span class="n">dev_info</span><span class="p">.</span>
				<span class="n">port_feature_config</span><span class="p">[</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">].</span><span class="n">link_config</span><span class="p">));</span>
		<span class="n">phy</span><span class="o">-&gt;</span><span class="n">speed_cap_mask</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">shmem_base</span> <span class="o">+</span>
					     <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">shmem_region</span><span class="p">,</span>
						      <span class="n">dev_info</span><span class="p">.</span>
			<span class="n">port_hw_config</span><span class="p">[</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">].</span><span class="n">speed_capability_mask</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span>
	   <span class="s">&quot;Default config phy idx %x cfg 0x%x speed_cap_mask 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	   <span class="n">phy_index</span><span class="p">,</span> <span class="n">link_config</span><span class="p">,</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">speed_cap_mask</span><span class="p">);</span>

	<span class="n">phy</span><span class="o">-&gt;</span><span class="n">req_duplex</span> <span class="o">=</span> <span class="n">DUPLEX_FULL</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">link_config</span>  <span class="o">&amp;</span> <span class="n">PORT_FEATURE_LINK_SPEED_MASK</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PORT_FEATURE_LINK_SPEED_10M_HALF</span>:
		<span class="n">phy</span><span class="o">-&gt;</span><span class="n">req_duplex</span> <span class="o">=</span> <span class="n">DUPLEX_HALF</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PORT_FEATURE_LINK_SPEED_10M_FULL</span>:
		<span class="n">phy</span><span class="o">-&gt;</span><span class="n">req_line_speed</span> <span class="o">=</span> <span class="n">SPEED_10</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PORT_FEATURE_LINK_SPEED_100M_HALF</span>:
		<span class="n">phy</span><span class="o">-&gt;</span><span class="n">req_duplex</span> <span class="o">=</span> <span class="n">DUPLEX_HALF</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PORT_FEATURE_LINK_SPEED_100M_FULL</span>:
		<span class="n">phy</span><span class="o">-&gt;</span><span class="n">req_line_speed</span> <span class="o">=</span> <span class="n">SPEED_100</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PORT_FEATURE_LINK_SPEED_1G</span>:
		<span class="n">phy</span><span class="o">-&gt;</span><span class="n">req_line_speed</span> <span class="o">=</span> <span class="n">SPEED_1000</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PORT_FEATURE_LINK_SPEED_2_5G</span>:
		<span class="n">phy</span><span class="o">-&gt;</span><span class="n">req_line_speed</span> <span class="o">=</span> <span class="n">SPEED_2500</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PORT_FEATURE_LINK_SPEED_10G_CX4</span>:
		<span class="n">phy</span><span class="o">-&gt;</span><span class="n">req_line_speed</span> <span class="o">=</span> <span class="n">SPEED_10000</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">phy</span><span class="o">-&gt;</span><span class="n">req_line_speed</span> <span class="o">=</span> <span class="n">SPEED_AUTO_NEG</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">link_config</span>  <span class="o">&amp;</span> <span class="n">PORT_FEATURE_FLOW_CONTROL_MASK</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PORT_FEATURE_FLOW_CONTROL_AUTO</span>:
		<span class="n">phy</span><span class="o">-&gt;</span><span class="n">req_flow_ctrl</span> <span class="o">=</span> <span class="n">BNX2X_FLOW_CTRL_AUTO</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PORT_FEATURE_FLOW_CONTROL_TX</span>:
		<span class="n">phy</span><span class="o">-&gt;</span><span class="n">req_flow_ctrl</span> <span class="o">=</span> <span class="n">BNX2X_FLOW_CTRL_TX</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PORT_FEATURE_FLOW_CONTROL_RX</span>:
		<span class="n">phy</span><span class="o">-&gt;</span><span class="n">req_flow_ctrl</span> <span class="o">=</span> <span class="n">BNX2X_FLOW_CTRL_RX</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PORT_FEATURE_FLOW_CONTROL_BOTH</span>:
		<span class="n">phy</span><span class="o">-&gt;</span><span class="n">req_flow_ctrl</span> <span class="o">=</span> <span class="n">BNX2X_FLOW_CTRL_BOTH</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">phy</span><span class="o">-&gt;</span><span class="n">req_flow_ctrl</span> <span class="o">=</span> <span class="n">BNX2X_FLOW_CTRL_NONE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="n">u32</span> <span class="nf">bnx2x_phy_selection</span><span class="p">(</span><span class="k">struct</span> <span class="n">link_params</span> <span class="o">*</span><span class="n">params</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">phy_config_swapped</span><span class="p">,</span> <span class="n">prio_cfg</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">return_cfg</span> <span class="o">=</span> <span class="n">PORT_HW_CFG_PHY_SELECTION_HARDWARE_DEFAULT</span><span class="p">;</span>

	<span class="n">phy_config_swapped</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">multi_phy_config</span> <span class="o">&amp;</span>
		<span class="n">PORT_HW_CFG_PHY_SWAPPED_ENABLED</span><span class="p">;</span>

	<span class="n">prio_cfg</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">multi_phy_config</span> <span class="o">&amp;</span>
			<span class="n">PORT_HW_CFG_PHY_SELECTION_MASK</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">phy_config_swapped</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">prio_cfg</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">PORT_HW_CFG_PHY_SELECTION_FIRST_PHY_PRIORITY</span>:
		     <span class="n">return_cfg</span> <span class="o">=</span> <span class="n">PORT_HW_CFG_PHY_SELECTION_SECOND_PHY_PRIORITY</span><span class="p">;</span>
		     <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">PORT_HW_CFG_PHY_SELECTION_SECOND_PHY_PRIORITY</span>:
		     <span class="n">return_cfg</span> <span class="o">=</span> <span class="n">PORT_HW_CFG_PHY_SELECTION_FIRST_PHY_PRIORITY</span><span class="p">;</span>
		     <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">PORT_HW_CFG_PHY_SELECTION_SECOND_PHY</span>:
		     <span class="n">return_cfg</span> <span class="o">=</span> <span class="n">PORT_HW_CFG_PHY_SELECTION_FIRST_PHY</span><span class="p">;</span>
		     <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">PORT_HW_CFG_PHY_SELECTION_FIRST_PHY</span>:
		     <span class="n">return_cfg</span> <span class="o">=</span> <span class="n">PORT_HW_CFG_PHY_SELECTION_SECOND_PHY</span><span class="p">;</span>
		     <span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">return_cfg</span> <span class="o">=</span> <span class="n">prio_cfg</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">return_cfg</span><span class="p">;</span>
<span class="p">}</span>


<span class="kt">int</span> <span class="nf">bnx2x_phy_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">link_params</span> <span class="o">*</span><span class="n">params</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">phy_index</span><span class="p">,</span> <span class="n">actual_phy_idx</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">phy_config_swapped</span><span class="p">,</span> <span class="n">sync_offset</span><span class="p">,</span> <span class="n">media_types</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">bp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bnx2x_phy</span> <span class="o">*</span><span class="n">phy</span><span class="p">;</span>
	<span class="n">params</span><span class="o">-&gt;</span><span class="n">num_phys</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;Begin phy probe</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">phy_config_swapped</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">multi_phy_config</span> <span class="o">&amp;</span>
		<span class="n">PORT_HW_CFG_PHY_SWAPPED_ENABLED</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">phy_index</span> <span class="o">=</span> <span class="n">INT_PHY</span><span class="p">;</span> <span class="n">phy_index</span> <span class="o">&lt;</span> <span class="n">MAX_PHYS</span><span class="p">;</span>
	      <span class="n">phy_index</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">actual_phy_idx</span> <span class="o">=</span> <span class="n">phy_index</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">phy_config_swapped</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">phy_index</span> <span class="o">==</span> <span class="n">EXT_PHY1</span><span class="p">)</span>
				<span class="n">actual_phy_idx</span> <span class="o">=</span> <span class="n">EXT_PHY2</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">phy_index</span> <span class="o">==</span> <span class="n">EXT_PHY2</span><span class="p">)</span>
				<span class="n">actual_phy_idx</span> <span class="o">=</span> <span class="n">EXT_PHY1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;phy_config_swapped %x, phy_index %x,&quot;</span>
			       <span class="s">&quot; actual_phy_idx %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">phy_config_swapped</span><span class="p">,</span>
			   <span class="n">phy_index</span><span class="p">,</span> <span class="n">actual_phy_idx</span><span class="p">);</span>
		<span class="n">phy</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">[</span><span class="n">actual_phy_idx</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bnx2x_populate_phy</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy_index</span><span class="p">,</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">shmem_base</span><span class="p">,</span>
				       <span class="n">params</span><span class="o">-&gt;</span><span class="n">shmem2_base</span><span class="p">,</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span>
				       <span class="n">phy</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">params</span><span class="o">-&gt;</span><span class="n">num_phys</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;phy probe failed in phy index %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				   <span class="n">phy_index</span><span class="p">);</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">phy_index</span> <span class="o">=</span> <span class="n">INT_PHY</span><span class="p">;</span>
			      <span class="n">phy_index</span> <span class="o">&lt;</span> <span class="n">MAX_PHYS</span><span class="p">;</span>
			      <span class="n">phy_index</span><span class="o">++</span><span class="p">)</span>
				<span class="o">*</span><span class="n">phy</span> <span class="o">=</span> <span class="n">phy_null</span><span class="p">;</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">PORT_HW_CFG_XGXS_EXT_PHY_TYPE_NOT_CONN</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">feature_config_flags</span> <span class="o">&amp;</span>
		    <span class="n">FEATURE_CONFIG_DISABLE_REMOTE_FAULT_DET</span><span class="p">)</span>
			<span class="n">phy</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">FLAGS_TX_ERROR_CHECK</span><span class="p">;</span>

		<span class="n">sync_offset</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">shmem_base</span> <span class="o">+</span>
			<span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">shmem_region</span><span class="p">,</span>
			<span class="n">dev_info</span><span class="p">.</span><span class="n">port_hw_config</span><span class="p">[</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">].</span><span class="n">media_type</span><span class="p">);</span>
		<span class="n">media_types</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">sync_offset</span><span class="p">);</span>

		<span class="cm">/* Update media type for non-PMF sync only for the first time</span>
<span class="cm">		 * In case the media type changes afterwards, it will be updated</span>
<span class="cm">		 * using the update_status function</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">media_types</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">PORT_HW_CFG_MEDIA_TYPE_PHY0_MASK</span> <span class="o">&lt;&lt;</span>
				    <span class="p">(</span><span class="n">PORT_HW_CFG_MEDIA_TYPE_PHY1_SHIFT</span> <span class="o">*</span>
				     <span class="n">actual_phy_idx</span><span class="p">)))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">media_types</span> <span class="o">|=</span> <span class="p">((</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">media_type</span> <span class="o">&amp;</span>
					<span class="n">PORT_HW_CFG_MEDIA_TYPE_PHY0_MASK</span><span class="p">)</span> <span class="o">&lt;&lt;</span>
				<span class="p">(</span><span class="n">PORT_HW_CFG_MEDIA_TYPE_PHY1_SHIFT</span> <span class="o">*</span>
				 <span class="n">actual_phy_idx</span><span class="p">));</span>
		<span class="p">}</span>
		<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">sync_offset</span><span class="p">,</span> <span class="n">media_types</span><span class="p">);</span>

		<span class="n">bnx2x_phy_def_cfg</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">phy_index</span><span class="p">);</span>
		<span class="n">params</span><span class="o">-&gt;</span><span class="n">num_phys</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;End phy probe. #phys found %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">num_phys</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">bnx2x_init_bmac_loopback</span><span class="p">(</span><span class="k">struct</span> <span class="n">link_params</span> <span class="o">*</span><span class="n">params</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">link_vars</span> <span class="o">*</span><span class="n">vars</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">bp</span><span class="p">;</span>
		<span class="n">vars</span><span class="o">-&gt;</span><span class="n">link_up</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">vars</span><span class="o">-&gt;</span><span class="n">line_speed</span> <span class="o">=</span> <span class="n">SPEED_10000</span><span class="p">;</span>
		<span class="n">vars</span><span class="o">-&gt;</span><span class="n">duplex</span> <span class="o">=</span> <span class="n">DUPLEX_FULL</span><span class="p">;</span>
		<span class="n">vars</span><span class="o">-&gt;</span><span class="n">flow_ctrl</span> <span class="o">=</span> <span class="n">BNX2X_FLOW_CTRL_NONE</span><span class="p">;</span>
		<span class="n">vars</span><span class="o">-&gt;</span><span class="n">mac_type</span> <span class="o">=</span> <span class="n">MAC_TYPE_BMAC</span><span class="p">;</span>

		<span class="n">vars</span><span class="o">-&gt;</span><span class="n">phy_flags</span> <span class="o">=</span> <span class="n">PHY_XGXS_FLAG</span><span class="p">;</span>

		<span class="n">bnx2x_xgxs_deassert</span><span class="p">(</span><span class="n">params</span><span class="p">);</span>

		<span class="cm">/* set bmac loopback */</span>
		<span class="n">bnx2x_bmac_enable</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">vars</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

		<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">NIG_REG_EGRESS_DRAIN0_MODE</span> <span class="o">+</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">*</span><span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">bnx2x_init_emac_loopback</span><span class="p">(</span><span class="k">struct</span> <span class="n">link_params</span> <span class="o">*</span><span class="n">params</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">link_vars</span> <span class="o">*</span><span class="n">vars</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">bp</span><span class="p">;</span>
		<span class="n">vars</span><span class="o">-&gt;</span><span class="n">link_up</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">vars</span><span class="o">-&gt;</span><span class="n">line_speed</span> <span class="o">=</span> <span class="n">SPEED_1000</span><span class="p">;</span>
		<span class="n">vars</span><span class="o">-&gt;</span><span class="n">duplex</span> <span class="o">=</span> <span class="n">DUPLEX_FULL</span><span class="p">;</span>
		<span class="n">vars</span><span class="o">-&gt;</span><span class="n">flow_ctrl</span> <span class="o">=</span> <span class="n">BNX2X_FLOW_CTRL_NONE</span><span class="p">;</span>
		<span class="n">vars</span><span class="o">-&gt;</span><span class="n">mac_type</span> <span class="o">=</span> <span class="n">MAC_TYPE_EMAC</span><span class="p">;</span>

		<span class="n">vars</span><span class="o">-&gt;</span><span class="n">phy_flags</span> <span class="o">=</span> <span class="n">PHY_XGXS_FLAG</span><span class="p">;</span>

		<span class="n">bnx2x_xgxs_deassert</span><span class="p">(</span><span class="n">params</span><span class="p">);</span>
		<span class="cm">/* set bmac loopback */</span>
		<span class="n">bnx2x_emac_enable</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">vars</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">bnx2x_emac_program</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">vars</span><span class="p">);</span>
		<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">NIG_REG_EGRESS_DRAIN0_MODE</span> <span class="o">+</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">*</span><span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">bnx2x_init_xmac_loopback</span><span class="p">(</span><span class="k">struct</span> <span class="n">link_params</span> <span class="o">*</span><span class="n">params</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">link_vars</span> <span class="o">*</span><span class="n">vars</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">bp</span><span class="p">;</span>
	<span class="n">vars</span><span class="o">-&gt;</span><span class="n">link_up</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">req_line_speed</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
		<span class="n">vars</span><span class="o">-&gt;</span><span class="n">line_speed</span> <span class="o">=</span> <span class="n">SPEED_10000</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">vars</span><span class="o">-&gt;</span><span class="n">line_speed</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">req_line_speed</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">vars</span><span class="o">-&gt;</span><span class="n">duplex</span> <span class="o">=</span> <span class="n">DUPLEX_FULL</span><span class="p">;</span>
	<span class="n">vars</span><span class="o">-&gt;</span><span class="n">flow_ctrl</span> <span class="o">=</span> <span class="n">BNX2X_FLOW_CTRL_NONE</span><span class="p">;</span>
	<span class="n">vars</span><span class="o">-&gt;</span><span class="n">mac_type</span> <span class="o">=</span> <span class="n">MAC_TYPE_XMAC</span><span class="p">;</span>
	<span class="n">vars</span><span class="o">-&gt;</span><span class="n">phy_flags</span> <span class="o">=</span> <span class="n">PHY_XGXS_FLAG</span><span class="p">;</span>
	<span class="cm">/* Set WC to loopback mode since link is required to provide clock</span>
<span class="cm">	 * to the XMAC in 20G mode</span>
<span class="cm">	 */</span>
	<span class="n">bnx2x_set_aer_mmd</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="n">bnx2x_warpcore_reset_lane</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">params</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">[</span><span class="n">INT_PHY</span><span class="p">].</span><span class="n">config_loopback</span><span class="p">(</span>
			<span class="o">&amp;</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">[</span><span class="n">INT_PHY</span><span class="p">],</span>
			<span class="n">params</span><span class="p">);</span>

	<span class="n">bnx2x_xmac_enable</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">vars</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">NIG_REG_EGRESS_DRAIN0_MODE</span> <span class="o">+</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">*</span><span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">bnx2x_init_umac_loopback</span><span class="p">(</span><span class="k">struct</span> <span class="n">link_params</span> <span class="o">*</span><span class="n">params</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">link_vars</span> <span class="o">*</span><span class="n">vars</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">bp</span><span class="p">;</span>
	<span class="n">vars</span><span class="o">-&gt;</span><span class="n">link_up</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">vars</span><span class="o">-&gt;</span><span class="n">line_speed</span> <span class="o">=</span> <span class="n">SPEED_1000</span><span class="p">;</span>
	<span class="n">vars</span><span class="o">-&gt;</span><span class="n">duplex</span> <span class="o">=</span> <span class="n">DUPLEX_FULL</span><span class="p">;</span>
	<span class="n">vars</span><span class="o">-&gt;</span><span class="n">flow_ctrl</span> <span class="o">=</span> <span class="n">BNX2X_FLOW_CTRL_NONE</span><span class="p">;</span>
	<span class="n">vars</span><span class="o">-&gt;</span><span class="n">mac_type</span> <span class="o">=</span> <span class="n">MAC_TYPE_UMAC</span><span class="p">;</span>
	<span class="n">vars</span><span class="o">-&gt;</span><span class="n">phy_flags</span> <span class="o">=</span> <span class="n">PHY_XGXS_FLAG</span><span class="p">;</span>
	<span class="n">bnx2x_umac_enable</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">vars</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">NIG_REG_EGRESS_DRAIN0_MODE</span> <span class="o">+</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">*</span><span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">bnx2x_init_xgxs_loopback</span><span class="p">(</span><span class="k">struct</span> <span class="n">link_params</span> <span class="o">*</span><span class="n">params</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">link_vars</span> <span class="o">*</span><span class="n">vars</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">bp</span><span class="p">;</span>
		<span class="n">vars</span><span class="o">-&gt;</span><span class="n">link_up</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">vars</span><span class="o">-&gt;</span><span class="n">flow_ctrl</span> <span class="o">=</span> <span class="n">BNX2X_FLOW_CTRL_NONE</span><span class="p">;</span>
		<span class="n">vars</span><span class="o">-&gt;</span><span class="n">duplex</span> <span class="o">=</span> <span class="n">DUPLEX_FULL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">req_line_speed</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">SPEED_1000</span><span class="p">)</span>
			<span class="n">vars</span><span class="o">-&gt;</span><span class="n">line_speed</span> <span class="o">=</span> <span class="n">SPEED_1000</span><span class="p">;</span>
	<span class="k">else</span>
			<span class="n">vars</span><span class="o">-&gt;</span><span class="n">line_speed</span> <span class="o">=</span> <span class="n">SPEED_10000</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">USES_WARPCORE</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span>
		<span class="n">bnx2x_xgxs_deassert</span><span class="p">(</span><span class="n">params</span><span class="p">);</span>
	<span class="n">bnx2x_link_initialize</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">vars</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">req_line_speed</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">SPEED_1000</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">USES_WARPCORE</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span>
			<span class="n">bnx2x_umac_enable</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">vars</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">bnx2x_emac_program</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">vars</span><span class="p">);</span>
			<span class="n">bnx2x_emac_enable</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">vars</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">USES_WARPCORE</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span>
			<span class="n">bnx2x_xmac_enable</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">vars</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">bnx2x_bmac_enable</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">vars</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">loopback_mode</span> <span class="o">==</span> <span class="n">LOOPBACK_XGXS</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* set 10G XGXS loopback */</span>
			<span class="n">params</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">[</span><span class="n">INT_PHY</span><span class="p">].</span><span class="n">config_loopback</span><span class="p">(</span>
				<span class="o">&amp;</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">[</span><span class="n">INT_PHY</span><span class="p">],</span>
				<span class="n">params</span><span class="p">);</span>

		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* set external phy loopback */</span>
			<span class="n">u8</span> <span class="n">phy_index</span><span class="p">;</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">phy_index</span> <span class="o">=</span> <span class="n">EXT_PHY1</span><span class="p">;</span>
			      <span class="n">phy_index</span> <span class="o">&lt;</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">num_phys</span><span class="p">;</span> <span class="n">phy_index</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">[</span><span class="n">phy_index</span><span class="p">].</span><span class="n">config_loopback</span><span class="p">)</span>
					<span class="n">params</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">[</span><span class="n">phy_index</span><span class="p">].</span><span class="n">config_loopback</span><span class="p">(</span>
						<span class="o">&amp;</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">[</span><span class="n">phy_index</span><span class="p">],</span>
						<span class="n">params</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">NIG_REG_EGRESS_DRAIN0_MODE</span> <span class="o">+</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">*</span><span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">bnx2x_set_led</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">vars</span><span class="p">,</span> <span class="n">LED_MODE_OPER</span><span class="p">,</span> <span class="n">vars</span><span class="o">-&gt;</span><span class="n">line_speed</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">bnx2x_phy_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">link_params</span> <span class="o">*</span><span class="n">params</span><span class="p">,</span> <span class="k">struct</span> <span class="n">link_vars</span> <span class="o">*</span><span class="n">vars</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">bp</span><span class="p">;</span>
	<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;Phy Initialization started</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;(1) req_speed %d, req_flowctrl %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">params</span><span class="o">-&gt;</span><span class="n">req_line_speed</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">req_flow_ctrl</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;(2) req_speed %d, req_flowctrl %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">params</span><span class="o">-&gt;</span><span class="n">req_line_speed</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">req_flow_ctrl</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
	<span class="n">vars</span><span class="o">-&gt;</span><span class="n">link_status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">vars</span><span class="o">-&gt;</span><span class="n">phy_link_up</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">vars</span><span class="o">-&gt;</span><span class="n">link_up</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">vars</span><span class="o">-&gt;</span><span class="n">line_speed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">vars</span><span class="o">-&gt;</span><span class="n">duplex</span> <span class="o">=</span> <span class="n">DUPLEX_FULL</span><span class="p">;</span>
	<span class="n">vars</span><span class="o">-&gt;</span><span class="n">flow_ctrl</span> <span class="o">=</span> <span class="n">BNX2X_FLOW_CTRL_NONE</span><span class="p">;</span>
	<span class="n">vars</span><span class="o">-&gt;</span><span class="n">mac_type</span> <span class="o">=</span> <span class="n">MAC_TYPE_NONE</span><span class="p">;</span>
	<span class="n">vars</span><span class="o">-&gt;</span><span class="n">phy_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* disable attentions */</span>
	<span class="n">bnx2x_bits_dis</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">NIG_REG_MASK_INTERRUPT_PORT0</span> <span class="o">+</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">*</span><span class="mi">4</span><span class="p">,</span>
		       <span class="p">(</span><span class="n">NIG_MASK_XGXS0_LINK_STATUS</span> <span class="o">|</span>
			<span class="n">NIG_MASK_XGXS0_LINK10G</span> <span class="o">|</span>
			<span class="n">NIG_MASK_SERDES0_LINK_STATUS</span> <span class="o">|</span>
			<span class="n">NIG_MASK_MI_INT</span><span class="p">));</span>

	<span class="n">bnx2x_emac_init</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">vars</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">feature_config_flags</span> <span class="o">&amp;</span> <span class="n">FEATURE_CONFIG_PFC_ENABLED</span><span class="p">)</span>
		<span class="n">vars</span><span class="o">-&gt;</span><span class="n">link_status</span> <span class="o">|=</span> <span class="n">LINK_STATUS_PFC_ENABLED</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">num_phys</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;No phy found for initialization !!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">set_phy_vars</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">vars</span><span class="p">);</span>

	<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;Num of phys on board: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">num_phys</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">loopback_mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">LOOPBACK_BMAC</span>:
		<span class="n">bnx2x_init_bmac_loopback</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">vars</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">LOOPBACK_EMAC</span>:
		<span class="n">bnx2x_init_emac_loopback</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">vars</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">LOOPBACK_XMAC</span>:
		<span class="n">bnx2x_init_xmac_loopback</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">vars</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">LOOPBACK_UMAC</span>:
		<span class="n">bnx2x_init_umac_loopback</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">vars</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">LOOPBACK_XGXS</span>:
	<span class="k">case</span> <span class="n">LOOPBACK_EXT_PHY</span>:
		<span class="n">bnx2x_init_xgxs_loopback</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">vars</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CHIP_IS_E3</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">switch_cfg</span> <span class="o">==</span> <span class="n">SWITCH_CFG_10G</span><span class="p">)</span>
				<span class="n">bnx2x_xgxs_deassert</span><span class="p">(</span><span class="n">params</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">bnx2x_serdes_deassert</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">bnx2x_link_initialize</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">vars</span><span class="p">);</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">30</span><span class="p">);</span>
		<span class="n">bnx2x_link_int_enable</span><span class="p">(</span><span class="n">params</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">bnx2x_update_mng</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">vars</span><span class="o">-&gt;</span><span class="n">link_status</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">bnx2x_link_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">link_params</span> <span class="o">*</span><span class="n">params</span><span class="p">,</span> <span class="k">struct</span> <span class="n">link_vars</span> <span class="o">*</span><span class="n">vars</span><span class="p">,</span>
		     <span class="n">u8</span> <span class="n">reset_ext_phy</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">bp</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">phy_index</span><span class="p">,</span> <span class="n">port</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span> <span class="n">clear_latch_ind</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;Resetting the link of port %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>
	<span class="cm">/* disable attentions */</span>
	<span class="n">vars</span><span class="o">-&gt;</span><span class="n">link_status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">bnx2x_update_mng</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">vars</span><span class="o">-&gt;</span><span class="n">link_status</span><span class="p">);</span>
	<span class="n">bnx2x_bits_dis</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">NIG_REG_MASK_INTERRUPT_PORT0</span> <span class="o">+</span> <span class="n">port</span><span class="o">*</span><span class="mi">4</span><span class="p">,</span>
		       <span class="p">(</span><span class="n">NIG_MASK_XGXS0_LINK_STATUS</span> <span class="o">|</span>
			<span class="n">NIG_MASK_XGXS0_LINK10G</span> <span class="o">|</span>
			<span class="n">NIG_MASK_SERDES0_LINK_STATUS</span> <span class="o">|</span>
			<span class="n">NIG_MASK_MI_INT</span><span class="p">));</span>

	<span class="cm">/* activate nig drain */</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">NIG_REG_EGRESS_DRAIN0_MODE</span> <span class="o">+</span> <span class="n">port</span><span class="o">*</span><span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* disable nig egress interface */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CHIP_IS_E3</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">NIG_REG_BMAC0_OUT_EN</span> <span class="o">+</span> <span class="n">port</span><span class="o">*</span><span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">NIG_REG_EGRESS_EMAC0_OUT_EN</span> <span class="o">+</span> <span class="n">port</span><span class="o">*</span><span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Stop BigMac rx */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CHIP_IS_E3</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span>
		<span class="n">bnx2x_bmac_rx_disable</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">bnx2x_xmac_disable</span><span class="p">(</span><span class="n">params</span><span class="p">);</span>
		<span class="n">bnx2x_umac_disable</span><span class="p">(</span><span class="n">params</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/* disable emac */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CHIP_IS_E3</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span>
		<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">NIG_REG_NIG_EMAC0_EN</span> <span class="o">+</span> <span class="n">port</span><span class="o">*</span><span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">msleep</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="cm">/* The PHY reset is controlled by GPIO 1</span>
<span class="cm">	 * Hold it as vars low</span>
<span class="cm">	 */</span>
	 <span class="cm">/* clear link led */</span>
	<span class="n">bnx2x_set_mdio_clk</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">chip_id</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>
	<span class="n">bnx2x_set_led</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">vars</span><span class="p">,</span> <span class="n">LED_MODE_OFF</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">reset_ext_phy</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">phy_index</span> <span class="o">=</span> <span class="n">EXT_PHY1</span><span class="p">;</span> <span class="n">phy_index</span> <span class="o">&lt;</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">num_phys</span><span class="p">;</span>
		      <span class="n">phy_index</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">[</span><span class="n">phy_index</span><span class="p">].</span><span class="n">link_reset</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">bnx2x_set_aer_mmd</span><span class="p">(</span><span class="n">params</span><span class="p">,</span>
						  <span class="o">&amp;</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">[</span><span class="n">phy_index</span><span class="p">]);</span>
				<span class="n">params</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">[</span><span class="n">phy_index</span><span class="p">].</span><span class="n">link_reset</span><span class="p">(</span>
					<span class="o">&amp;</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">[</span><span class="n">phy_index</span><span class="p">],</span>
					<span class="n">params</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">[</span><span class="n">phy_index</span><span class="p">].</span><span class="n">flags</span> <span class="o">&amp;</span>
			    <span class="n">FLAGS_REARM_LATCH_SIGNAL</span><span class="p">)</span>
				<span class="n">clear_latch_ind</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">clear_latch_ind</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Clear latching indication */</span>
		<span class="n">bnx2x_rearm_latch_signal</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">bnx2x_bits_dis</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">NIG_REG_LATCH_BC_0</span> <span class="o">+</span> <span class="n">port</span><span class="o">*</span><span class="mi">4</span><span class="p">,</span>
			       <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">NIG_LATCH_BC_ENABLE_MI_INT</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">[</span><span class="n">INT_PHY</span><span class="p">].</span><span class="n">link_reset</span><span class="p">)</span>
		<span class="n">params</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">[</span><span class="n">INT_PHY</span><span class="p">].</span><span class="n">link_reset</span><span class="p">(</span>
			<span class="o">&amp;</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">[</span><span class="n">INT_PHY</span><span class="p">],</span> <span class="n">params</span><span class="p">);</span>

	<span class="cm">/* disable nig ingress interface */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CHIP_IS_E3</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* reset BigMac */</span>
		<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">GRCBASE_MISC</span> <span class="o">+</span> <span class="n">MISC_REGISTERS_RESET_REG_2_CLEAR</span><span class="p">,</span>
		       <span class="p">(</span><span class="n">MISC_REGISTERS_RESET_REG_2_RST_BMAC0</span> <span class="o">&lt;&lt;</span> <span class="n">port</span><span class="p">));</span>
		<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">NIG_REG_BMAC0_IN_EN</span> <span class="o">+</span> <span class="n">port</span><span class="o">*</span><span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">NIG_REG_EMAC0_IN_EN</span> <span class="o">+</span> <span class="n">port</span><span class="o">*</span><span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">xmac_base</span> <span class="o">=</span> <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">)</span> <span class="o">?</span> <span class="n">GRCBASE_XMAC1</span> <span class="o">:</span> <span class="n">GRCBASE_XMAC0</span><span class="p">;</span>
		<span class="n">bnx2x_set_xumac_nig</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">MISC_REG_RESET_REG_2</span><span class="p">)</span> <span class="o">&amp;</span>
		    <span class="n">MISC_REGISTERS_RESET_REG_2_XMAC</span><span class="p">)</span>
			<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">xmac_base</span> <span class="o">+</span> <span class="n">XMAC_REG_CTRL</span><span class="p">,</span>
			       <span class="n">XMAC_CTRL_REG_SOFT_RESET</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">vars</span><span class="o">-&gt;</span><span class="n">link_up</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">vars</span><span class="o">-&gt;</span><span class="n">phy_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/****************************************************************************/</span>
<span class="cm">/*				Common function				    */</span>
<span class="cm">/****************************************************************************/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">bnx2x_8073_common_init_phy</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">,</span>
				      <span class="n">u32</span> <span class="n">shmem_base_path</span><span class="p">[],</span>
				      <span class="n">u32</span> <span class="n">shmem2_base_path</span><span class="p">[],</span> <span class="n">u8</span> <span class="n">phy_index</span><span class="p">,</span>
				      <span class="n">u32</span> <span class="n">chip_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2x_phy</span> <span class="n">phy</span><span class="p">[</span><span class="n">PORT_MAX</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">bnx2x_phy</span> <span class="o">*</span><span class="n">phy_blk</span><span class="p">[</span><span class="n">PORT_MAX</span><span class="p">];</span>
	<span class="n">u16</span> <span class="n">val</span><span class="p">;</span>
	<span class="n">s8</span> <span class="n">port</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">s8</span> <span class="n">port_of_path</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">swap_val</span><span class="p">,</span> <span class="n">swap_override</span><span class="p">;</span>
	<span class="n">swap_val</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span>  <span class="n">NIG_REG_PORT_SWAP</span><span class="p">);</span>
	<span class="n">swap_override</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span>  <span class="n">NIG_REG_STRAP_OVERRIDE</span><span class="p">);</span>
	<span class="n">port</span> <span class="o">^=</span> <span class="p">(</span><span class="n">swap_val</span> <span class="o">&amp;&amp;</span> <span class="n">swap_override</span><span class="p">);</span>
	<span class="n">bnx2x_ext_phy_hw_reset</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>
	<span class="cm">/* PART1 - Reset both phys */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">port</span> <span class="o">=</span> <span class="n">PORT_MAX</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="n">port</span> <span class="o">&gt;=</span> <span class="n">PORT_0</span><span class="p">;</span> <span class="n">port</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">shmem_base</span><span class="p">,</span> <span class="n">shmem2_base</span><span class="p">;</span>
		<span class="cm">/* In E2, same phy is using for port0 of the two paths */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">CHIP_IS_E1x</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">shmem_base</span> <span class="o">=</span> <span class="n">shmem_base_path</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
			<span class="n">shmem2_base</span> <span class="o">=</span> <span class="n">shmem2_base_path</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
			<span class="n">port_of_path</span> <span class="o">=</span> <span class="n">port</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">shmem_base</span> <span class="o">=</span> <span class="n">shmem_base_path</span><span class="p">[</span><span class="n">port</span><span class="p">];</span>
			<span class="n">shmem2_base</span> <span class="o">=</span> <span class="n">shmem2_base_path</span><span class="p">[</span><span class="n">port</span><span class="p">];</span>
			<span class="n">port_of_path</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Extract the ext phy address for the port */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bnx2x_populate_phy</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy_index</span><span class="p">,</span> <span class="n">shmem_base</span><span class="p">,</span> <span class="n">shmem2_base</span><span class="p">,</span>
				       <span class="n">port_of_path</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">phy</span><span class="p">[</span><span class="n">port</span><span class="p">])</span> <span class="o">!=</span>
		    <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;populate_phy failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* disable attentions */</span>
		<span class="n">bnx2x_bits_dis</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">NIG_REG_MASK_INTERRUPT_PORT0</span> <span class="o">+</span>
			       <span class="n">port_of_path</span><span class="o">*</span><span class="mi">4</span><span class="p">,</span>
			       <span class="p">(</span><span class="n">NIG_MASK_XGXS0_LINK_STATUS</span> <span class="o">|</span>
				<span class="n">NIG_MASK_XGXS0_LINK10G</span> <span class="o">|</span>
				<span class="n">NIG_MASK_SERDES0_LINK_STATUS</span> <span class="o">|</span>
				<span class="n">NIG_MASK_MI_INT</span><span class="p">));</span>

		<span class="cm">/* Need to take the phy out of low power mode in order</span>
<span class="cm">		 * to write to access its registers</span>
<span class="cm">		 */</span>
		<span class="n">bnx2x_set_gpio</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">MISC_REGISTERS_GPIO_2</span><span class="p">,</span>
			       <span class="n">MISC_REGISTERS_GPIO_OUTPUT_HIGH</span><span class="p">,</span>
			       <span class="n">port</span><span class="p">);</span>

		<span class="cm">/* Reset the phy */</span>
		<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">phy</span><span class="p">[</span><span class="n">port</span><span class="p">],</span>
				 <span class="n">MDIO_PMA_DEVAD</span><span class="p">,</span>
				 <span class="n">MDIO_PMA_REG_CTRL</span><span class="p">,</span>
				 <span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">15</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Add delay of 150ms after reset */</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">150</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="p">[</span><span class="n">PORT_0</span><span class="p">].</span><span class="n">addr</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">phy_blk</span><span class="p">[</span><span class="n">PORT_0</span><span class="p">]</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">phy</span><span class="p">[</span><span class="n">PORT_1</span><span class="p">]);</span>
		<span class="n">phy_blk</span><span class="p">[</span><span class="n">PORT_1</span><span class="p">]</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">phy</span><span class="p">[</span><span class="n">PORT_0</span><span class="p">]);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">phy_blk</span><span class="p">[</span><span class="n">PORT_0</span><span class="p">]</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">phy</span><span class="p">[</span><span class="n">PORT_0</span><span class="p">]);</span>
		<span class="n">phy_blk</span><span class="p">[</span><span class="n">PORT_1</span><span class="p">]</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">phy</span><span class="p">[</span><span class="n">PORT_1</span><span class="p">]);</span>
	<span class="p">}</span>

	<span class="cm">/* PART2 - Download firmware to both phys */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">port</span> <span class="o">=</span> <span class="n">PORT_MAX</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="n">port</span> <span class="o">&gt;=</span> <span class="n">PORT_0</span><span class="p">;</span> <span class="n">port</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">CHIP_IS_E1x</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span>
			<span class="n">port_of_path</span> <span class="o">=</span> <span class="n">port</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">port_of_path</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;Loading spirom for phy address 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">phy_blk</span><span class="p">[</span><span class="n">port</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bnx2x_8073_8727_external_rom_boot</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy_blk</span><span class="p">[</span><span class="n">port</span><span class="p">],</span>
						      <span class="n">port_of_path</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

		<span class="cm">/* Only set bit 10 = 1 (Tx power down) */</span>
		<span class="n">bnx2x_cl45_read</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy_blk</span><span class="p">[</span><span class="n">port</span><span class="p">],</span>
				<span class="n">MDIO_PMA_DEVAD</span><span class="p">,</span>
				<span class="n">MDIO_PMA_REG_TX_POWER_DOWN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>

		<span class="cm">/* Phase1 of TX_POWER_DOWN reset */</span>
		<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy_blk</span><span class="p">[</span><span class="n">port</span><span class="p">],</span>
				 <span class="n">MDIO_PMA_DEVAD</span><span class="p">,</span>
				 <span class="n">MDIO_PMA_REG_TX_POWER_DOWN</span><span class="p">,</span>
				 <span class="p">(</span><span class="n">val</span> <span class="o">|</span> <span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">10</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="cm">/* Toggle Transmitter: Power down and then up with 600ms delay</span>
<span class="cm">	 * between</span>
<span class="cm">	 */</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">600</span><span class="p">);</span>

	<span class="cm">/* PART3 - complete TX_POWER_DOWN process, and set GPIO2 back to low */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">port</span> <span class="o">=</span> <span class="n">PORT_MAX</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="n">port</span> <span class="o">&gt;=</span> <span class="n">PORT_0</span><span class="p">;</span> <span class="n">port</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Phase2 of POWER_DOWN_RESET */</span>
		<span class="cm">/* Release bit 10 (Release Tx power down) */</span>
		<span class="n">bnx2x_cl45_read</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy_blk</span><span class="p">[</span><span class="n">port</span><span class="p">],</span>
				<span class="n">MDIO_PMA_DEVAD</span><span class="p">,</span>
				<span class="n">MDIO_PMA_REG_TX_POWER_DOWN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>

		<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy_blk</span><span class="p">[</span><span class="n">port</span><span class="p">],</span>
				<span class="n">MDIO_PMA_DEVAD</span><span class="p">,</span>
				<span class="n">MDIO_PMA_REG_TX_POWER_DOWN</span><span class="p">,</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">10</span><span class="p">))));</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">15</span><span class="p">);</span>

		<span class="cm">/* Read modify write the SPI-ROM version select register */</span>
		<span class="n">bnx2x_cl45_read</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy_blk</span><span class="p">[</span><span class="n">port</span><span class="p">],</span>
				<span class="n">MDIO_PMA_DEVAD</span><span class="p">,</span>
				<span class="n">MDIO_PMA_REG_EDC_FFE_MAIN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
		<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy_blk</span><span class="p">[</span><span class="n">port</span><span class="p">],</span>
				 <span class="n">MDIO_PMA_DEVAD</span><span class="p">,</span>
				 <span class="n">MDIO_PMA_REG_EDC_FFE_MAIN</span><span class="p">,</span> <span class="p">(</span><span class="n">val</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">12</span><span class="p">)));</span>

		<span class="cm">/* set GPIO2 back to LOW */</span>
		<span class="n">bnx2x_set_gpio</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">MISC_REGISTERS_GPIO_2</span><span class="p">,</span>
			       <span class="n">MISC_REGISTERS_GPIO_OUTPUT_LOW</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">bnx2x_8726_common_init_phy</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">,</span>
				      <span class="n">u32</span> <span class="n">shmem_base_path</span><span class="p">[],</span>
				      <span class="n">u32</span> <span class="n">shmem2_base_path</span><span class="p">[],</span> <span class="n">u8</span> <span class="n">phy_index</span><span class="p">,</span>
				      <span class="n">u32</span> <span class="n">chip_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>
	<span class="n">s8</span> <span class="n">port</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bnx2x_phy</span> <span class="n">phy</span><span class="p">;</span>
	<span class="cm">/* Use port1 because of the static port-swap */</span>
	<span class="cm">/* Enable the module detection interrupt */</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">MISC_REG_GPIO_EVENT_EN</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">|=</span> <span class="p">((</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">MISC_REGISTERS_GPIO_3</span><span class="p">)</span><span class="o">|</span>
		<span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="p">(</span><span class="n">MISC_REGISTERS_GPIO_3</span> <span class="o">+</span> <span class="n">MISC_REGISTERS_GPIO_PORT_SHIFT</span><span class="p">)));</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">MISC_REG_GPIO_EVENT_EN</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

	<span class="n">bnx2x_ext_phy_hw_reset</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">port</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">port</span> <span class="o">&lt;</span> <span class="n">PORT_MAX</span><span class="p">;</span> <span class="n">port</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">shmem_base</span><span class="p">,</span> <span class="n">shmem2_base</span><span class="p">;</span>

		<span class="cm">/* In E2, same phy is using for port0 of the two paths */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">CHIP_IS_E1x</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">shmem_base</span> <span class="o">=</span> <span class="n">shmem_base_path</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
			<span class="n">shmem2_base</span> <span class="o">=</span> <span class="n">shmem2_base_path</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">shmem_base</span> <span class="o">=</span> <span class="n">shmem_base_path</span><span class="p">[</span><span class="n">port</span><span class="p">];</span>
			<span class="n">shmem2_base</span> <span class="o">=</span> <span class="n">shmem2_base_path</span><span class="p">[</span><span class="n">port</span><span class="p">];</span>
		<span class="p">}</span>
		<span class="cm">/* Extract the ext phy address for the port */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bnx2x_populate_phy</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy_index</span><span class="p">,</span> <span class="n">shmem_base</span><span class="p">,</span> <span class="n">shmem2_base</span><span class="p">,</span>
				       <span class="n">port</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">phy</span><span class="p">)</span> <span class="o">!=</span>
		    <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;populate phy failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Reset phy*/</span>
		<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">phy</span><span class="p">,</span>
				 <span class="n">MDIO_PMA_DEVAD</span><span class="p">,</span> <span class="n">MDIO_PMA_REG_GEN_CTRL</span><span class="p">,</span> <span class="mh">0x0001</span><span class="p">);</span>


		<span class="cm">/* Set fault module detected LED on */</span>
		<span class="n">bnx2x_set_gpio</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">MISC_REGISTERS_GPIO_0</span><span class="p">,</span>
			       <span class="n">MISC_REGISTERS_GPIO_HIGH</span><span class="p">,</span>
			       <span class="n">port</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_get_ext_phy_reset_gpio</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">,</span> <span class="n">u32</span> <span class="n">shmem_base</span><span class="p">,</span>
					 <span class="n">u8</span> <span class="o">*</span><span class="n">io_gpio</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">io_port</span><span class="p">)</span>
<span class="p">{</span>

	<span class="n">u32</span> <span class="n">phy_gpio_reset</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">shmem_base</span> <span class="o">+</span>
					  <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">shmem_region</span><span class="p">,</span>
				<span class="n">dev_info</span><span class="p">.</span><span class="n">port_hw_config</span><span class="p">[</span><span class="n">PORT_0</span><span class="p">].</span><span class="n">default_cfg</span><span class="p">));</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">phy_gpio_reset</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PORT_HW_CFG_EXT_PHY_GPIO_RST_GPIO0_P0</span>:
		<span class="o">*</span><span class="n">io_gpio</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="o">*</span><span class="n">io_port</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PORT_HW_CFG_EXT_PHY_GPIO_RST_GPIO1_P0</span>:
		<span class="o">*</span><span class="n">io_gpio</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="o">*</span><span class="n">io_port</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PORT_HW_CFG_EXT_PHY_GPIO_RST_GPIO2_P0</span>:
		<span class="o">*</span><span class="n">io_gpio</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="o">*</span><span class="n">io_port</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PORT_HW_CFG_EXT_PHY_GPIO_RST_GPIO3_P0</span>:
		<span class="o">*</span><span class="n">io_gpio</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
		<span class="o">*</span><span class="n">io_port</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PORT_HW_CFG_EXT_PHY_GPIO_RST_GPIO0_P1</span>:
		<span class="o">*</span><span class="n">io_gpio</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="o">*</span><span class="n">io_port</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PORT_HW_CFG_EXT_PHY_GPIO_RST_GPIO1_P1</span>:
		<span class="o">*</span><span class="n">io_gpio</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="o">*</span><span class="n">io_port</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PORT_HW_CFG_EXT_PHY_GPIO_RST_GPIO2_P1</span>:
		<span class="o">*</span><span class="n">io_gpio</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="o">*</span><span class="n">io_port</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PORT_HW_CFG_EXT_PHY_GPIO_RST_GPIO3_P1</span>:
		<span class="o">*</span><span class="n">io_gpio</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
		<span class="o">*</span><span class="n">io_port</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="cm">/* Don&#39;t override the io_gpio and io_port */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bnx2x_8727_common_init_phy</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">,</span>
				      <span class="n">u32</span> <span class="n">shmem_base_path</span><span class="p">[],</span>
				      <span class="n">u32</span> <span class="n">shmem2_base_path</span><span class="p">[],</span> <span class="n">u8</span> <span class="n">phy_index</span><span class="p">,</span>
				      <span class="n">u32</span> <span class="n">chip_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">s8</span> <span class="n">port</span><span class="p">,</span> <span class="n">reset_gpio</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">swap_val</span><span class="p">,</span> <span class="n">swap_override</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bnx2x_phy</span> <span class="n">phy</span><span class="p">[</span><span class="n">PORT_MAX</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">bnx2x_phy</span> <span class="o">*</span><span class="n">phy_blk</span><span class="p">[</span><span class="n">PORT_MAX</span><span class="p">];</span>
	<span class="n">s8</span> <span class="n">port_of_path</span><span class="p">;</span>
	<span class="n">swap_val</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">NIG_REG_PORT_SWAP</span><span class="p">);</span>
	<span class="n">swap_override</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">NIG_REG_STRAP_OVERRIDE</span><span class="p">);</span>

	<span class="n">reset_gpio</span> <span class="o">=</span> <span class="n">MISC_REGISTERS_GPIO_1</span><span class="p">;</span>
	<span class="n">port</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* Retrieve the reset gpio/port which control the reset.</span>
<span class="cm">	 * Default is GPIO1, PORT1</span>
<span class="cm">	 */</span>
	<span class="n">bnx2x_get_ext_phy_reset_gpio</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">shmem_base_path</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
				     <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">reset_gpio</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">port</span><span class="p">);</span>

	<span class="cm">/* Calculate the port based on port swap */</span>
	<span class="n">port</span> <span class="o">^=</span> <span class="p">(</span><span class="n">swap_val</span> <span class="o">&amp;&amp;</span> <span class="n">swap_override</span><span class="p">);</span>

	<span class="cm">/* Initiate PHY reset*/</span>
	<span class="n">bnx2x_set_gpio</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">reset_gpio</span><span class="p">,</span> <span class="n">MISC_REGISTERS_GPIO_OUTPUT_LOW</span><span class="p">,</span>
		       <span class="n">port</span><span class="p">);</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">bnx2x_set_gpio</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">reset_gpio</span><span class="p">,</span> <span class="n">MISC_REGISTERS_GPIO_OUTPUT_HIGH</span><span class="p">,</span>
		       <span class="n">port</span><span class="p">);</span>

	<span class="n">msleep</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>

	<span class="cm">/* PART1 - Reset both phys */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">port</span> <span class="o">=</span> <span class="n">PORT_MAX</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="n">port</span> <span class="o">&gt;=</span> <span class="n">PORT_0</span><span class="p">;</span> <span class="n">port</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">shmem_base</span><span class="p">,</span> <span class="n">shmem2_base</span><span class="p">;</span>

		<span class="cm">/* In E2, same phy is using for port0 of the two paths */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">CHIP_IS_E1x</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">shmem_base</span> <span class="o">=</span> <span class="n">shmem_base_path</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
			<span class="n">shmem2_base</span> <span class="o">=</span> <span class="n">shmem2_base_path</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
			<span class="n">port_of_path</span> <span class="o">=</span> <span class="n">port</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">shmem_base</span> <span class="o">=</span> <span class="n">shmem_base_path</span><span class="p">[</span><span class="n">port</span><span class="p">];</span>
			<span class="n">shmem2_base</span> <span class="o">=</span> <span class="n">shmem2_base_path</span><span class="p">[</span><span class="n">port</span><span class="p">];</span>
			<span class="n">port_of_path</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Extract the ext phy address for the port */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bnx2x_populate_phy</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy_index</span><span class="p">,</span> <span class="n">shmem_base</span><span class="p">,</span> <span class="n">shmem2_base</span><span class="p">,</span>
				       <span class="n">port_of_path</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">phy</span><span class="p">[</span><span class="n">port</span><span class="p">])</span> <span class="o">!=</span>
				       <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;populate phy failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* disable attentions */</span>
		<span class="n">bnx2x_bits_dis</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">NIG_REG_MASK_INTERRUPT_PORT0</span> <span class="o">+</span>
			       <span class="n">port_of_path</span><span class="o">*</span><span class="mi">4</span><span class="p">,</span>
			       <span class="p">(</span><span class="n">NIG_MASK_XGXS0_LINK_STATUS</span> <span class="o">|</span>
				<span class="n">NIG_MASK_XGXS0_LINK10G</span> <span class="o">|</span>
				<span class="n">NIG_MASK_SERDES0_LINK_STATUS</span> <span class="o">|</span>
				<span class="n">NIG_MASK_MI_INT</span><span class="p">));</span>


		<span class="cm">/* Reset the phy */</span>
		<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">phy</span><span class="p">[</span><span class="n">port</span><span class="p">],</span>
				 <span class="n">MDIO_PMA_DEVAD</span><span class="p">,</span> <span class="n">MDIO_PMA_REG_CTRL</span><span class="p">,</span> <span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">15</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Add delay of 150ms after reset */</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">150</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="p">[</span><span class="n">PORT_0</span><span class="p">].</span><span class="n">addr</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">phy_blk</span><span class="p">[</span><span class="n">PORT_0</span><span class="p">]</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">phy</span><span class="p">[</span><span class="n">PORT_1</span><span class="p">]);</span>
		<span class="n">phy_blk</span><span class="p">[</span><span class="n">PORT_1</span><span class="p">]</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">phy</span><span class="p">[</span><span class="n">PORT_0</span><span class="p">]);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">phy_blk</span><span class="p">[</span><span class="n">PORT_0</span><span class="p">]</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">phy</span><span class="p">[</span><span class="n">PORT_0</span><span class="p">]);</span>
		<span class="n">phy_blk</span><span class="p">[</span><span class="n">PORT_1</span><span class="p">]</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">phy</span><span class="p">[</span><span class="n">PORT_1</span><span class="p">]);</span>
	<span class="p">}</span>
	<span class="cm">/* PART2 - Download firmware to both phys */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">port</span> <span class="o">=</span> <span class="n">PORT_MAX</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="n">port</span> <span class="o">&gt;=</span> <span class="n">PORT_0</span><span class="p">;</span> <span class="n">port</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">CHIP_IS_E1x</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span>
			<span class="n">port_of_path</span> <span class="o">=</span> <span class="n">port</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">port_of_path</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;Loading spirom for phy address 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">phy_blk</span><span class="p">[</span><span class="n">port</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bnx2x_8073_8727_external_rom_boot</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy_blk</span><span class="p">[</span><span class="n">port</span><span class="p">],</span>
						      <span class="n">port_of_path</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="cm">/* Disable PHY transmitter output */</span>
		<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy_blk</span><span class="p">[</span><span class="n">port</span><span class="p">],</span>
				 <span class="n">MDIO_PMA_DEVAD</span><span class="p">,</span>
				 <span class="n">MDIO_PMA_REG_TX_DISABLE</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bnx2x_84833_common_init_phy</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">,</span>
						<span class="n">u32</span> <span class="n">shmem_base_path</span><span class="p">[],</span>
						<span class="n">u32</span> <span class="n">shmem2_base_path</span><span class="p">[],</span>
						<span class="n">u8</span> <span class="n">phy_index</span><span class="p">,</span>
						<span class="n">u32</span> <span class="n">chip_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">reset_gpios</span><span class="p">;</span>
	<span class="n">reset_gpios</span> <span class="o">=</span> <span class="n">bnx2x_84833_get_reset_gpios</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">shmem_base_path</span><span class="p">,</span> <span class="n">chip_id</span><span class="p">);</span>
	<span class="n">bnx2x_set_mult_gpio</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">reset_gpios</span><span class="p">,</span> <span class="n">MISC_REGISTERS_GPIO_OUTPUT_LOW</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="n">bnx2x_set_mult_gpio</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">reset_gpios</span><span class="p">,</span> <span class="n">MISC_REGISTERS_GPIO_OUTPUT_HIGH</span><span class="p">);</span>
	<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;84833 reset pulse on pin values 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">reset_gpios</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bnx2x_84833_pre_init_phy</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">,</span>
					       <span class="k">struct</span> <span class="n">bnx2x_phy</span> <span class="o">*</span><span class="n">phy</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">val</span><span class="p">,</span> <span class="n">cnt</span><span class="p">;</span>
	<span class="cm">/* Wait for FW completing its initialization. */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">cnt</span> <span class="o">&lt;</span> <span class="mi">1500</span><span class="p">;</span> <span class="n">cnt</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bnx2x_cl45_read</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
				<span class="n">MDIO_PMA_DEVAD</span><span class="p">,</span>
				<span class="n">MDIO_PMA_REG_CTRL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">15</span><span class="p">)))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">&gt;=</span> <span class="mi">1500</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;84833 reset timeout</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Put the port in super isolate mode. */</span>
	<span class="n">bnx2x_cl45_read</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
			<span class="n">MDIO_CTL_DEVAD</span><span class="p">,</span>
			<span class="n">MDIO_84833_TOP_CFG_XGPHY_STRAP1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">|=</span> <span class="n">MDIO_84833_SUPER_ISOLATE</span><span class="p">;</span>
	<span class="n">bnx2x_cl45_write</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>
			 <span class="n">MDIO_CTL_DEVAD</span><span class="p">,</span>
			 <span class="n">MDIO_84833_TOP_CFG_XGPHY_STRAP1</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

	<span class="cm">/* Save spirom version */</span>
	<span class="n">bnx2x_save_848xx_spirom_version</span><span class="p">(</span><span class="n">phy</span><span class="p">,</span> <span class="n">bp</span><span class="p">,</span> <span class="n">PORT_0</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">bnx2x_pre_init_phy</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">,</span>
				  <span class="n">u32</span> <span class="n">shmem_base</span><span class="p">,</span>
				  <span class="n">u32</span> <span class="n">shmem2_base</span><span class="p">,</span>
				  <span class="n">u32</span> <span class="n">chip_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bnx2x_phy</span> <span class="n">phy</span><span class="p">;</span>
	<span class="n">bnx2x_set_mdio_clk</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">chip_id</span><span class="p">,</span> <span class="n">PORT_0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bnx2x_populate_phy</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">EXT_PHY1</span><span class="p">,</span> <span class="n">shmem_base</span><span class="p">,</span> <span class="n">shmem2_base</span><span class="p">,</span>
			       <span class="n">PORT_0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">phy</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;populate_phy failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">phy</span><span class="p">.</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PORT_HW_CFG_XGXS_EXT_PHY_TYPE_BCM84833</span>:
		<span class="n">rc</span> <span class="o">=</span> <span class="n">bnx2x_84833_pre_init_phy</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">phy</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bnx2x_ext_phy_common_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">,</span> <span class="n">u32</span> <span class="n">shmem_base_path</span><span class="p">[],</span>
				     <span class="n">u32</span> <span class="n">shmem2_base_path</span><span class="p">[],</span> <span class="n">u8</span> <span class="n">phy_index</span><span class="p">,</span>
				     <span class="n">u32</span> <span class="n">ext_phy_type</span><span class="p">,</span> <span class="n">u32</span> <span class="n">chip_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">ext_phy_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PORT_HW_CFG_XGXS_EXT_PHY_TYPE_BCM8073</span>:
		<span class="n">rc</span> <span class="o">=</span> <span class="n">bnx2x_8073_common_init_phy</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">shmem_base_path</span><span class="p">,</span>
						<span class="n">shmem2_base_path</span><span class="p">,</span>
						<span class="n">phy_index</span><span class="p">,</span> <span class="n">chip_id</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PORT_HW_CFG_XGXS_EXT_PHY_TYPE_BCM8722</span>:
	<span class="k">case</span> <span class="n">PORT_HW_CFG_XGXS_EXT_PHY_TYPE_BCM8727</span>:
	<span class="k">case</span> <span class="n">PORT_HW_CFG_XGXS_EXT_PHY_TYPE_BCM8727_NOC</span>:
		<span class="n">rc</span> <span class="o">=</span> <span class="n">bnx2x_8727_common_init_phy</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">shmem_base_path</span><span class="p">,</span>
						<span class="n">shmem2_base_path</span><span class="p">,</span>
						<span class="n">phy_index</span><span class="p">,</span> <span class="n">chip_id</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">PORT_HW_CFG_XGXS_EXT_PHY_TYPE_BCM8726</span>:
		<span class="cm">/* GPIO1 affects both ports, so there&#39;s need to pull</span>
<span class="cm">		 * it for single port alone</span>
<span class="cm">		 */</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">bnx2x_8726_common_init_phy</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">shmem_base_path</span><span class="p">,</span>
						<span class="n">shmem2_base_path</span><span class="p">,</span>
						<span class="n">phy_index</span><span class="p">,</span> <span class="n">chip_id</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PORT_HW_CFG_XGXS_EXT_PHY_TYPE_BCM84833</span>:
		<span class="cm">/* GPIO3&#39;s are linked, and so both need to be toggled</span>
<span class="cm">		 * to obtain required 2us pulse.</span>
<span class="cm">		 */</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">bnx2x_84833_common_init_phy</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">shmem_base_path</span><span class="p">,</span>
						<span class="n">shmem2_base_path</span><span class="p">,</span>
						<span class="n">phy_index</span><span class="p">,</span> <span class="n">chip_id</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PORT_HW_CFG_XGXS_EXT_PHY_TYPE_FAILURE</span>:
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span>
			   <span class="s">&quot;ext_phy 0x%x common init not required</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">ext_phy_type</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">netdev_err</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>  <span class="s">&quot;Warning: PHY was not initialized,&quot;</span>
				      <span class="s">&quot; Port %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="mi">0</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">bnx2x_common_init_phy</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">,</span> <span class="n">u32</span> <span class="n">shmem_base_path</span><span class="p">[],</span>
			  <span class="n">u32</span> <span class="n">shmem2_base_path</span><span class="p">[],</span> <span class="n">u32</span> <span class="n">chip_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">phy_ver</span><span class="p">,</span> <span class="n">val</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">phy_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ext_phy_type</span><span class="p">,</span> <span class="n">ext_phy_config</span><span class="p">;</span>
	<span class="n">bnx2x_set_mdio_clk</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">chip_id</span><span class="p">,</span> <span class="n">PORT_0</span><span class="p">);</span>
	<span class="n">bnx2x_set_mdio_clk</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">chip_id</span><span class="p">,</span> <span class="n">PORT_1</span><span class="p">);</span>
	<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;Begin common phy init</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">CHIP_IS_E3</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Enable EPIO */</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">MISC_REG_GEN_PURP_HWG</span><span class="p">);</span>
		<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">MISC_REG_GEN_PURP_HWG</span><span class="p">,</span> <span class="n">val</span> <span class="o">|</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/* Check if common init was already done */</span>
	<span class="n">phy_ver</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">shmem_base_path</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span>
			 <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">shmem_region</span><span class="p">,</span>
				  <span class="n">port_mb</span><span class="p">[</span><span class="n">PORT_0</span><span class="p">].</span><span class="n">ext_phy_fw_version</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phy_ver</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;Not doing common init; phy ver is 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">phy_ver</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Read the ext_phy_type for arbitrary port(0) */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">phy_index</span> <span class="o">=</span> <span class="n">EXT_PHY1</span><span class="p">;</span> <span class="n">phy_index</span> <span class="o">&lt;</span> <span class="n">MAX_PHYS</span><span class="p">;</span>
	      <span class="n">phy_index</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ext_phy_config</span> <span class="o">=</span> <span class="n">bnx2x_get_ext_phy_config</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span>
							  <span class="n">shmem_base_path</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
							  <span class="n">phy_index</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">ext_phy_type</span> <span class="o">=</span> <span class="n">XGXS_EXT_PHY_TYPE</span><span class="p">(</span><span class="n">ext_phy_config</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">|=</span> <span class="n">bnx2x_ext_phy_common_init</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">shmem_base_path</span><span class="p">,</span>
						<span class="n">shmem2_base_path</span><span class="p">,</span>
						<span class="n">phy_index</span><span class="p">,</span> <span class="n">ext_phy_type</span><span class="p">,</span>
						<span class="n">chip_id</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_check_over_curr</span><span class="p">(</span><span class="k">struct</span> <span class="n">link_params</span> <span class="o">*</span><span class="n">params</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">link_vars</span> <span class="o">*</span><span class="n">vars</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">bp</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">cfg_pin</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">port</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">pin_val</span><span class="p">;</span>

	<span class="n">cfg_pin</span> <span class="o">=</span> <span class="p">(</span><span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">shmem_base</span> <span class="o">+</span>
			  <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">shmem_region</span><span class="p">,</span>
			       <span class="n">dev_info</span><span class="p">.</span><span class="n">port_hw_config</span><span class="p">[</span><span class="n">port</span><span class="p">].</span><span class="n">e3_cmn_pin_cfg1</span><span class="p">))</span> <span class="o">&amp;</span>
		   <span class="n">PORT_HW_CFG_E3_OVER_CURRENT_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span>
		<span class="n">PORT_HW_CFG_E3_OVER_CURRENT_SHIFT</span><span class="p">;</span>

	<span class="cm">/* Ignore check if no external input PIN available */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bnx2x_get_cfg_pin</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">cfg_pin</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pin_val</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pin_val</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">vars</span><span class="o">-&gt;</span><span class="n">phy_flags</span> <span class="o">&amp;</span> <span class="n">PHY_OVER_CURRENT_FLAG</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">netdev_err</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Error:  Power fault on Port %d has&quot;</span>
					    <span class="s">&quot; been detected and the power to &quot;</span>
					    <span class="s">&quot;that SFP+ module has been removed&quot;</span>
					    <span class="s">&quot; to prevent failure of the card.&quot;</span>
					    <span class="s">&quot; Please remove the SFP+ module and&quot;</span>
					    <span class="s">&quot; restart the system to clear this&quot;</span>
					    <span class="s">&quot; error.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">params</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">);</span>
			<span class="n">vars</span><span class="o">-&gt;</span><span class="n">phy_flags</span> <span class="o">|=</span> <span class="n">PHY_OVER_CURRENT_FLAG</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">vars</span><span class="o">-&gt;</span><span class="n">phy_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PHY_OVER_CURRENT_FLAG</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bnx2x_analyze_link_error</span><span class="p">(</span><span class="k">struct</span> <span class="n">link_params</span> <span class="o">*</span><span class="n">params</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">link_vars</span> <span class="o">*</span><span class="n">vars</span><span class="p">,</span> <span class="n">u32</span> <span class="n">lss_status</span><span class="p">,</span>
				     <span class="n">u8</span> <span class="n">notify</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">bp</span><span class="p">;</span>
	<span class="cm">/* Compare new value with previous value */</span>
	<span class="n">u8</span> <span class="n">led_mode</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">half_open_conn</span> <span class="o">=</span> <span class="p">(</span><span class="n">vars</span><span class="o">-&gt;</span><span class="n">phy_flags</span> <span class="o">&amp;</span> <span class="n">PHY_HALF_OPEN_CONN_FLAG</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">lss_status</span> <span class="o">^</span> <span class="n">half_open_conn</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* If values differ */</span>
	<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;Link changed:%x %x-&gt;%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">vars</span><span class="o">-&gt;</span><span class="n">link_up</span><span class="p">,</span>
		       <span class="n">half_open_conn</span><span class="p">,</span> <span class="n">lss_status</span><span class="p">);</span>

	<span class="cm">/* a. Update shmem-&gt;link_status accordingly</span>
<span class="cm">	 * b. Update link_vars-&gt;link_up</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lss_status</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;Remote Fault detected !!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">vars</span><span class="o">-&gt;</span><span class="n">link_status</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">LINK_STATUS_LINK_UP</span><span class="p">;</span>
		<span class="n">vars</span><span class="o">-&gt;</span><span class="n">link_up</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">vars</span><span class="o">-&gt;</span><span class="n">phy_flags</span> <span class="o">|=</span> <span class="n">PHY_HALF_OPEN_CONN_FLAG</span><span class="p">;</span>

		<span class="cm">/* activate nig drain */</span>
		<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">NIG_REG_EGRESS_DRAIN0_MODE</span> <span class="o">+</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">*</span><span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="cm">/* Set LED mode to off since the PHY doesn&#39;t know about these</span>
<span class="cm">		 * errors</span>
<span class="cm">		 */</span>
		<span class="n">led_mode</span> <span class="o">=</span> <span class="n">LED_MODE_OFF</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;Remote Fault cleared</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">vars</span><span class="o">-&gt;</span><span class="n">link_status</span> <span class="o">|=</span> <span class="n">LINK_STATUS_LINK_UP</span><span class="p">;</span>
		<span class="n">vars</span><span class="o">-&gt;</span><span class="n">link_up</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">vars</span><span class="o">-&gt;</span><span class="n">phy_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PHY_HALF_OPEN_CONN_FLAG</span><span class="p">;</span>
		<span class="n">led_mode</span> <span class="o">=</span> <span class="n">LED_MODE_OPER</span><span class="p">;</span>

		<span class="cm">/* Clear nig drain */</span>
		<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">NIG_REG_EGRESS_DRAIN0_MODE</span> <span class="o">+</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">*</span><span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">bnx2x_sync_link</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">vars</span><span class="p">);</span>
	<span class="cm">/* Update the LED according to the link state */</span>
	<span class="n">bnx2x_set_led</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">vars</span><span class="p">,</span> <span class="n">led_mode</span><span class="p">,</span> <span class="n">SPEED_10000</span><span class="p">);</span>

	<span class="cm">/* Update link status in the shared memory */</span>
	<span class="n">bnx2x_update_mng</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">vars</span><span class="o">-&gt;</span><span class="n">link_status</span><span class="p">);</span>

	<span class="cm">/* C. Trigger General Attention */</span>
	<span class="n">vars</span><span class="o">-&gt;</span><span class="n">periodic_flags</span> <span class="o">|=</span> <span class="n">PERIODIC_FLAGS_LINK_EVENT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">notify</span><span class="p">)</span>
		<span class="n">bnx2x_notify_link_changed</span><span class="p">(</span><span class="n">bp</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/******************************************************************************</span>
<span class="cm">* Description:</span>
<span class="cm">*	This function checks for half opened connection change indication.</span>
<span class="cm">*	When such change occurs, it calls the bnx2x_analyze_link_error</span>
<span class="cm">*	to check if Remote Fault is set or cleared. Reception of remote fault</span>
<span class="cm">*	status message in the MAC indicates that the peer&#39;s MAC has detected</span>
<span class="cm">*	a fault, for example, due to break in the TX side of fiber.</span>
<span class="cm">*</span>
<span class="cm">******************************************************************************/</span>
<span class="kt">int</span> <span class="nf">bnx2x_check_half_open_conn</span><span class="p">(</span><span class="k">struct</span> <span class="n">link_params</span> <span class="o">*</span><span class="n">params</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">link_vars</span> <span class="o">*</span><span class="n">vars</span><span class="p">,</span>
				<span class="n">u8</span> <span class="n">notify</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">bp</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">lss_status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">mac_base</span><span class="p">;</span>
	<span class="cm">/* In case link status is physically up @ 10G do */</span>
	<span class="k">if</span> <span class="p">(((</span><span class="n">vars</span><span class="o">-&gt;</span><span class="n">phy_flags</span> <span class="o">&amp;</span> <span class="n">PHY_PHYSICAL_LINK_FLAG</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">NIG_REG_EGRESS_EMAC0_PORT</span> <span class="o">+</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">*</span><span class="mi">4</span><span class="p">)))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">CHIP_IS_E3</span><span class="p">(</span><span class="n">bp</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">MISC_REG_RESET_REG_2</span><span class="p">)</span> <span class="o">&amp;</span>
	      <span class="p">(</span><span class="n">MISC_REGISTERS_RESET_REG_2_XMAC</span><span class="p">)))</span> <span class="p">{</span>
		<span class="cm">/* Check E3 XMAC */</span>
		<span class="cm">/* Note that link speed cannot be queried here, since it may be</span>
<span class="cm">		 * zero while link is down. In case UMAC is active, LSS will</span>
<span class="cm">		 * simply not be set</span>
<span class="cm">		 */</span>
		<span class="n">mac_base</span> <span class="o">=</span> <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">)</span> <span class="o">?</span> <span class="n">GRCBASE_XMAC1</span> <span class="o">:</span> <span class="n">GRCBASE_XMAC0</span><span class="p">;</span>

		<span class="cm">/* Clear stick bits (Requires rising edge) */</span>
		<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">mac_base</span> <span class="o">+</span> <span class="n">XMAC_REG_CLEAR_RX_LSS_STATUS</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">mac_base</span> <span class="o">+</span> <span class="n">XMAC_REG_CLEAR_RX_LSS_STATUS</span><span class="p">,</span>
		       <span class="n">XMAC_CLEAR_RX_LSS_STATUS_REG_CLEAR_LOCAL_FAULT_STATUS</span> <span class="o">|</span>
		       <span class="n">XMAC_CLEAR_RX_LSS_STATUS_REG_CLEAR_REMOTE_FAULT_STATUS</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">mac_base</span> <span class="o">+</span> <span class="n">XMAC_REG_RX_LSS_STATUS</span><span class="p">))</span>
			<span class="n">lss_status</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="n">bnx2x_analyze_link_error</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">vars</span><span class="p">,</span> <span class="n">lss_status</span><span class="p">,</span> <span class="n">notify</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">MISC_REG_RESET_REG_2</span><span class="p">)</span> <span class="o">&amp;</span>
		   <span class="p">(</span><span class="n">MISC_REGISTERS_RESET_REG_2_RST_BMAC0</span> <span class="o">&lt;&lt;</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Check E1X / E2 BMAC */</span>
		<span class="n">u32</span> <span class="n">lss_status_reg</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">wb_data</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
		<span class="n">mac_base</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">?</span> <span class="n">NIG_REG_INGRESS_BMAC1_MEM</span> <span class="o">:</span>
			<span class="n">NIG_REG_INGRESS_BMAC0_MEM</span><span class="p">;</span>
		<span class="cm">/*  Read BIGMAC_REGISTER_RX_LSS_STATUS */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">CHIP_IS_E2</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span>
			<span class="n">lss_status_reg</span> <span class="o">=</span> <span class="n">BIGMAC2_REGISTER_RX_LSS_STAT</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">lss_status_reg</span> <span class="o">=</span> <span class="n">BIGMAC_REGISTER_RX_LSS_STATUS</span><span class="p">;</span>

		<span class="n">REG_RD_DMAE</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">mac_base</span> <span class="o">+</span> <span class="n">lss_status_reg</span><span class="p">,</span> <span class="n">wb_data</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
		<span class="n">lss_status</span> <span class="o">=</span> <span class="p">(</span><span class="n">wb_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">);</span>

		<span class="n">bnx2x_analyze_link_error</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">vars</span><span class="p">,</span> <span class="n">lss_status</span><span class="p">,</span> <span class="n">notify</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">bnx2x_period_func</span><span class="p">(</span><span class="k">struct</span> <span class="n">link_params</span> <span class="o">*</span><span class="n">params</span><span class="p">,</span> <span class="k">struct</span> <span class="n">link_vars</span> <span class="o">*</span><span class="n">vars</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">phy_idx</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">bp</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">phy_idx</span> <span class="o">=</span> <span class="n">INT_PHY</span><span class="p">;</span> <span class="n">phy_idx</span> <span class="o">&lt;</span> <span class="n">MAX_PHYS</span><span class="p">;</span> <span class="n">phy_idx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">[</span><span class="n">phy_idx</span><span class="p">].</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">FLAGS_TX_ERROR_CHECK</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">bnx2x_set_aer_mmd</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">[</span><span class="n">phy_idx</span><span class="p">]);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">bnx2x_check_half_open_conn</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">vars</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">!=</span>
			    <span class="mi">0</span><span class="p">)</span>
				<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;Fault detection failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">CHIP_IS_E3</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">bnx2x_phy</span> <span class="o">*</span><span class="n">phy</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">[</span><span class="n">INT_PHY</span><span class="p">];</span>
		<span class="n">bnx2x_set_aer_mmd</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">phy</span><span class="p">);</span>
		<span class="n">bnx2x_check_over_curr</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">vars</span><span class="p">);</span>
		<span class="n">bnx2x_warpcore_config_runtime</span><span class="p">(</span><span class="n">phy</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">vars</span><span class="p">);</span>
	<span class="p">}</span>

<span class="p">}</span>

<span class="n">u8</span> <span class="nf">bnx2x_hw_lock_required</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">,</span> <span class="n">u32</span> <span class="n">shmem_base</span><span class="p">,</span> <span class="n">u32</span> <span class="n">shmem2_base</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">phy_index</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bnx2x_phy</span> <span class="n">phy</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">phy_index</span> <span class="o">=</span> <span class="n">INT_PHY</span><span class="p">;</span> <span class="n">phy_index</span> <span class="o">&lt;</span> <span class="n">MAX_PHYS</span><span class="p">;</span>
	      <span class="n">phy_index</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bnx2x_populate_phy</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy_index</span><span class="p">,</span> <span class="n">shmem_base</span><span class="p">,</span> <span class="n">shmem2_base</span><span class="p">,</span>
				       <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">phy</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;populate phy failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">FLAGS_HW_LOCK_REQUIRED</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">u8</span> <span class="nf">bnx2x_fan_failure_det_req</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">,</span>
			     <span class="n">u32</span> <span class="n">shmem_base</span><span class="p">,</span>
			     <span class="n">u32</span> <span class="n">shmem2_base</span><span class="p">,</span>
			     <span class="n">u8</span> <span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">phy_index</span><span class="p">,</span> <span class="n">fan_failure_det_req</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bnx2x_phy</span> <span class="n">phy</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">phy_index</span> <span class="o">=</span> <span class="n">EXT_PHY1</span><span class="p">;</span> <span class="n">phy_index</span> <span class="o">&lt;</span> <span class="n">MAX_PHYS</span><span class="p">;</span>
	      <span class="n">phy_index</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bnx2x_populate_phy</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy_index</span><span class="p">,</span> <span class="n">shmem_base</span><span class="p">,</span> <span class="n">shmem2_base</span><span class="p">,</span>
				       <span class="n">port</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">phy</span><span class="p">)</span>
		    <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;populate phy failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">fan_failure_det_req</span> <span class="o">|=</span> <span class="p">(</span><span class="n">phy</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span>
					<span class="n">FLAGS_FAN_FAILURE_DET_REQ</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">fan_failure_det_req</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">bnx2x_hw_reset_phy</span><span class="p">(</span><span class="k">struct</span> <span class="n">link_params</span> <span class="o">*</span><span class="n">params</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">phy_index</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">bp</span><span class="p">;</span>
	<span class="n">bnx2x_update_mng</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">bnx2x_bits_dis</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">NIG_REG_MASK_INTERRUPT_PORT0</span> <span class="o">+</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">*</span><span class="mi">4</span><span class="p">,</span>
		       <span class="p">(</span><span class="n">NIG_MASK_XGXS0_LINK_STATUS</span> <span class="o">|</span>
			<span class="n">NIG_MASK_XGXS0_LINK10G</span> <span class="o">|</span>
			<span class="n">NIG_MASK_SERDES0_LINK_STATUS</span> <span class="o">|</span>
			<span class="n">NIG_MASK_MI_INT</span><span class="p">));</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">phy_index</span> <span class="o">=</span> <span class="n">INT_PHY</span><span class="p">;</span> <span class="n">phy_index</span> <span class="o">&lt;</span> <span class="n">MAX_PHYS</span><span class="p">;</span>
	      <span class="n">phy_index</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">[</span><span class="n">phy_index</span><span class="p">].</span><span class="n">hw_reset</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">params</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">[</span><span class="n">phy_index</span><span class="p">].</span><span class="n">hw_reset</span><span class="p">(</span>
				<span class="o">&amp;</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">[</span><span class="n">phy_index</span><span class="p">],</span>
				<span class="n">params</span><span class="p">);</span>
			<span class="n">params</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">[</span><span class="n">phy_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">phy_null</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">bnx2x_init_mod_abs_int</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnx2x</span> <span class="o">*</span><span class="n">bp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">link_vars</span> <span class="o">*</span><span class="n">vars</span><span class="p">,</span>
			    <span class="n">u32</span> <span class="n">chip_id</span><span class="p">,</span> <span class="n">u32</span> <span class="n">shmem_base</span><span class="p">,</span> <span class="n">u32</span> <span class="n">shmem2_base</span><span class="p">,</span>
			    <span class="n">u8</span> <span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">gpio_num</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">gpio_port</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">phy_index</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">offset</span><span class="p">,</span> <span class="n">aeu_mask</span><span class="p">,</span> <span class="n">swap_val</span><span class="p">,</span> <span class="n">swap_override</span><span class="p">,</span> <span class="n">sync_offset</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">CHIP_IS_E3</span><span class="p">(</span><span class="n">bp</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bnx2x_get_mod_abs_int_cfg</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">chip_id</span><span class="p">,</span>
					      <span class="n">shmem_base</span><span class="p">,</span>
					      <span class="n">port</span><span class="p">,</span>
					      <span class="o">&amp;</span><span class="n">gpio_num</span><span class="p">,</span>
					      <span class="o">&amp;</span><span class="n">gpio_port</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">bnx2x_phy</span> <span class="n">phy</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">phy_index</span> <span class="o">=</span> <span class="n">EXT_PHY1</span><span class="p">;</span> <span class="n">phy_index</span> <span class="o">&lt;</span> <span class="n">MAX_PHYS</span><span class="p">;</span>
		      <span class="n">phy_index</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">bnx2x_populate_phy</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">phy_index</span><span class="p">,</span> <span class="n">shmem_base</span><span class="p">,</span>
					       <span class="n">shmem2_base</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">phy</span><span class="p">)</span>
			    <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;populate phy failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">return</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">PORT_HW_CFG_XGXS_EXT_PHY_TYPE_BCM8726</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">gpio_num</span> <span class="o">=</span> <span class="n">MISC_REGISTERS_GPIO_3</span><span class="p">;</span>
				<span class="n">gpio_port</span> <span class="o">=</span> <span class="n">port</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">gpio_num</span> <span class="o">==</span> <span class="mh">0xff</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* Set GPIO3 to trigger SFP+ module insertion/removal */</span>
	<span class="n">bnx2x_set_gpio</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">gpio_num</span><span class="p">,</span> <span class="n">MISC_REGISTERS_GPIO_INPUT_HI_Z</span><span class="p">,</span> <span class="n">gpio_port</span><span class="p">);</span>

	<span class="n">swap_val</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">NIG_REG_PORT_SWAP</span><span class="p">);</span>
	<span class="n">swap_override</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">NIG_REG_STRAP_OVERRIDE</span><span class="p">);</span>
	<span class="n">gpio_port</span> <span class="o">^=</span> <span class="p">(</span><span class="n">swap_val</span> <span class="o">&amp;&amp;</span> <span class="n">swap_override</span><span class="p">);</span>

	<span class="n">vars</span><span class="o">-&gt;</span><span class="n">aeu_int_mask</span> <span class="o">=</span> <span class="n">AEU_INPUTS_ATTN_BITS_GPIO0_FUNCTION_0</span> <span class="o">&lt;&lt;</span>
		<span class="p">(</span><span class="n">gpio_num</span> <span class="o">+</span> <span class="p">(</span><span class="n">gpio_port</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">));</span>

	<span class="n">sync_offset</span> <span class="o">=</span> <span class="n">shmem_base</span> <span class="o">+</span>
		<span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">shmem_region</span><span class="p">,</span>
			 <span class="n">dev_info</span><span class="p">.</span><span class="n">port_hw_config</span><span class="p">[</span><span class="n">port</span><span class="p">].</span><span class="n">aeu_int_mask</span><span class="p">);</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">sync_offset</span><span class="p">,</span> <span class="n">vars</span><span class="o">-&gt;</span><span class="n">aeu_int_mask</span><span class="p">);</span>

	<span class="n">DP</span><span class="p">(</span><span class="n">NETIF_MSG_LINK</span><span class="p">,</span> <span class="s">&quot;Setting MOD_ABS (GPIO%d_P%d) AEU to 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">gpio_num</span><span class="p">,</span> <span class="n">gpio_port</span><span class="p">,</span> <span class="n">vars</span><span class="o">-&gt;</span><span class="n">aeu_int_mask</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">port</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">offset</span> <span class="o">=</span> <span class="n">MISC_REG_AEU_ENABLE1_FUNC_0_OUT_0</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">offset</span> <span class="o">=</span> <span class="n">MISC_REG_AEU_ENABLE1_FUNC_1_OUT_0</span><span class="p">;</span>

	<span class="cm">/* Open appropriate AEU for interrupts */</span>
	<span class="n">aeu_mask</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">offset</span><span class="p">);</span>
	<span class="n">aeu_mask</span> <span class="o">|=</span> <span class="n">vars</span><span class="o">-&gt;</span><span class="n">aeu_int_mask</span><span class="p">;</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">aeu_mask</span><span class="p">);</span>

	<span class="cm">/* Enable the GPIO to trigger interrupt */</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">MISC_REG_GPIO_EVENT_EN</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">gpio_num</span> <span class="o">+</span> <span class="p">(</span><span class="n">gpio_port</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">));</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">MISC_REG_GPIO_EVENT_EN</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:5}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../../javascript/docco.min.js"></script>
</html>
