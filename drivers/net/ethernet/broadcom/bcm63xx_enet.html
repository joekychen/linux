<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › ethernet › broadcom › bcm63xx_enet.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>bcm63xx_enet.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Driver for BCM963xx builtin Ethernet mac</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2008 Maxime Bizon &lt;mbizon@freebox.fr&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License as published by</span>
<span class="cm"> * the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> * (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful,</span>
<span class="cm"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> * GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with this program; if not, write to the Free Software</span>
<span class="cm"> * Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.</span>
<span class="cm"> */</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/clk.h&gt;</span>
<span class="cp">#include &lt;linux/etherdevice.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/ethtool.h&gt;</span>
<span class="cp">#include &lt;linux/crc32.h&gt;</span>
<span class="cp">#include &lt;linux/err.h&gt;</span>
<span class="cp">#include &lt;linux/dma-mapping.h&gt;</span>
<span class="cp">#include &lt;linux/platform_device.h&gt;</span>
<span class="cp">#include &lt;linux/if_vlan.h&gt;</span>

<span class="cp">#include &lt;bcm63xx_dev_enet.h&gt;</span>
<span class="cp">#include &quot;bcm63xx_enet.h&quot;</span>

<span class="k">static</span> <span class="kt">char</span> <span class="n">bcm_enet_driver_name</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&quot;bcm63xx_enet&quot;</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">char</span> <span class="n">bcm_enet_driver_version</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&quot;1.0&quot;</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">copybreak</span> <span class="n">__read_mostly</span> <span class="o">=</span> <span class="mi">128</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">copybreak</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">copybreak</span><span class="p">,</span> <span class="s">&quot;Receive copy threshold&quot;</span><span class="p">);</span>

<span class="cm">/* io memory shared between all devices */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">bcm_enet_shared_base</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> * io helpers to access mac registers</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="n">u32</span> <span class="nf">enet_readl</span><span class="p">(</span><span class="k">struct</span> <span class="n">bcm_enet_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="n">u32</span> <span class="n">off</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">bcm_readl</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">off</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">enet_writel</span><span class="p">(</span><span class="k">struct</span> <span class="n">bcm_enet_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
			       <span class="n">u32</span> <span class="n">val</span><span class="p">,</span> <span class="n">u32</span> <span class="n">off</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bcm_writel</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">off</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * io helpers to access shared registers</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="n">u32</span> <span class="nf">enet_dma_readl</span><span class="p">(</span><span class="k">struct</span> <span class="n">bcm_enet_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="n">u32</span> <span class="n">off</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">bcm_readl</span><span class="p">(</span><span class="n">bcm_enet_shared_base</span> <span class="o">+</span> <span class="n">off</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">enet_dma_writel</span><span class="p">(</span><span class="k">struct</span> <span class="n">bcm_enet_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
				       <span class="n">u32</span> <span class="n">val</span><span class="p">,</span> <span class="n">u32</span> <span class="n">off</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bcm_writel</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">bcm_enet_shared_base</span> <span class="o">+</span> <span class="n">off</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * write given data into mii register and wait for transfer to end</span>
<span class="cm"> * with timeout (average measured transfer time is 25us)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">do_mdio_op</span><span class="p">(</span><span class="k">struct</span> <span class="n">bcm_enet_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">limit</span><span class="p">;</span>

	<span class="cm">/* make sure mii interrupt status is cleared */</span>
	<span class="n">enet_writel</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">ENET_IR_MII</span><span class="p">,</span> <span class="n">ENET_IR_REG</span><span class="p">);</span>

	<span class="n">enet_writel</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">ENET_MIIDATA_REG</span><span class="p">);</span>
	<span class="n">wmb</span><span class="p">();</span>

	<span class="cm">/* busy wait on mii interrupt bit, with timeout */</span>
	<span class="n">limit</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">;</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">enet_readl</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">ENET_IR_REG</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ENET_IR_MII</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">limit</span><span class="o">--</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">limit</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * MII internal read callback</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">bcm_enet_mdio_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">bcm_enet_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mii_id</span><span class="p">,</span>
			      <span class="kt">int</span> <span class="n">regnum</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">regnum</span> <span class="o">&lt;&lt;</span> <span class="n">ENET_MIIDATA_REG_SHIFT</span><span class="p">;</span>
	<span class="n">tmp</span> <span class="o">|=</span> <span class="mh">0x2</span> <span class="o">&lt;&lt;</span> <span class="n">ENET_MIIDATA_TA_SHIFT</span><span class="p">;</span>
	<span class="n">tmp</span> <span class="o">|=</span> <span class="n">mii_id</span> <span class="o">&lt;&lt;</span> <span class="n">ENET_MIIDATA_PHYID_SHIFT</span><span class="p">;</span>
	<span class="n">tmp</span> <span class="o">|=</span> <span class="n">ENET_MIIDATA_OP_READ_MASK</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">do_mdio_op</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">tmp</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">enet_readl</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">ENET_MIIDATA_REG</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">&amp;=</span> <span class="mh">0xffff</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">val</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * MII internal write callback</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">bcm_enet_mdio_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">bcm_enet_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mii_id</span><span class="p">,</span>
			       <span class="kt">int</span> <span class="n">regnum</span><span class="p">,</span> <span class="n">u16</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">value</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">ENET_MIIDATA_DATA_SHIFT</span><span class="p">;</span>
	<span class="n">tmp</span> <span class="o">|=</span> <span class="mh">0x2</span> <span class="o">&lt;&lt;</span> <span class="n">ENET_MIIDATA_TA_SHIFT</span><span class="p">;</span>
	<span class="n">tmp</span> <span class="o">|=</span> <span class="n">regnum</span> <span class="o">&lt;&lt;</span> <span class="n">ENET_MIIDATA_REG_SHIFT</span><span class="p">;</span>
	<span class="n">tmp</span> <span class="o">|=</span> <span class="n">mii_id</span> <span class="o">&lt;&lt;</span> <span class="n">ENET_MIIDATA_PHYID_SHIFT</span><span class="p">;</span>
	<span class="n">tmp</span> <span class="o">|=</span> <span class="n">ENET_MIIDATA_OP_WRITE_MASK</span><span class="p">;</span>

	<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">do_mdio_op</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * MII read callback from phylib</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">bcm_enet_mdio_read_phylib</span><span class="p">(</span><span class="k">struct</span> <span class="n">mii_bus</span> <span class="o">*</span><span class="n">bus</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mii_id</span><span class="p">,</span>
				     <span class="kt">int</span> <span class="n">regnum</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">bcm_enet_mdio_read</span><span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">,</span> <span class="n">mii_id</span><span class="p">,</span> <span class="n">regnum</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * MII write callback from phylib</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">bcm_enet_mdio_write_phylib</span><span class="p">(</span><span class="k">struct</span> <span class="n">mii_bus</span> <span class="o">*</span><span class="n">bus</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mii_id</span><span class="p">,</span>
				      <span class="kt">int</span> <span class="n">regnum</span><span class="p">,</span> <span class="n">u16</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">bcm_enet_mdio_write</span><span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">,</span> <span class="n">mii_id</span><span class="p">,</span> <span class="n">regnum</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * MII read callback from mii core</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">bcm_enet_mdio_read_mii</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mii_id</span><span class="p">,</span>
				  <span class="kt">int</span> <span class="n">regnum</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">bcm_enet_mdio_read</span><span class="p">(</span><span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">),</span> <span class="n">mii_id</span><span class="p">,</span> <span class="n">regnum</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * MII write callback from mii core</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">bcm_enet_mdio_write_mii</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mii_id</span><span class="p">,</span>
				    <span class="kt">int</span> <span class="n">regnum</span><span class="p">,</span> <span class="kt">int</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bcm_enet_mdio_write</span><span class="p">(</span><span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">),</span> <span class="n">mii_id</span><span class="p">,</span> <span class="n">regnum</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * refill rx queue</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">bcm_enet_refill_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bcm_enet_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">;</span>

	<span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_desc_count</span> <span class="o">&lt;</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_ring_size</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">bcm_enet_desc</span> <span class="o">*</span><span class="n">desc</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
		<span class="n">dma_addr_t</span> <span class="n">p</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">desc_idx</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">len_stat</span><span class="p">;</span>

		<span class="n">desc_idx</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_dirty_desc</span><span class="p">;</span>
		<span class="n">desc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_desc_cpu</span><span class="p">[</span><span class="n">desc_idx</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_skb</span><span class="p">[</span><span class="n">desc_idx</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">skb</span> <span class="o">=</span> <span class="n">netdev_alloc_skb</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_skb_size</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_skb</span><span class="p">[</span><span class="n">desc_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>

			<span class="n">p</span> <span class="o">=</span> <span class="n">dma_map_single</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span>
					   <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_skb_size</span><span class="p">,</span>
					   <span class="n">DMA_FROM_DEVICE</span><span class="p">);</span>
			<span class="n">desc</span><span class="o">-&gt;</span><span class="n">address</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">len_stat</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_skb_size</span> <span class="o">&lt;&lt;</span> <span class="n">DMADESC_LENGTH_SHIFT</span><span class="p">;</span>
		<span class="n">len_stat</span> <span class="o">|=</span> <span class="n">DMADESC_OWNER_MASK</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_dirty_desc</span> <span class="o">==</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_ring_size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">len_stat</span> <span class="o">|=</span> <span class="n">DMADESC_WRAP_MASK</span><span class="p">;</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_dirty_desc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_dirty_desc</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">wmb</span><span class="p">();</span>
		<span class="n">desc</span><span class="o">-&gt;</span><span class="n">len_stat</span> <span class="o">=</span> <span class="n">len_stat</span><span class="p">;</span>

		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_desc_count</span><span class="o">++</span><span class="p">;</span>

		<span class="cm">/* tell dma engine we allocated one buffer */</span>
		<span class="n">enet_dma_writel</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ENETDMA_BUFALLOC_REG</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_chan</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="cm">/* If rx ring is still empty, set a timer to try allocating</span>
<span class="cm">	 * again at a later time. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_desc_count</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">netif_running</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;unable to refill rx ring</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_timeout</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">HZ</span><span class="p">;</span>
		<span class="n">add_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_timeout</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * timer callback to defer refill rx queue in case we&#39;re OOM</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">bcm_enet_refill_rx_timer</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bcm_enet_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">;</span>

	<span class="n">dev</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">;</span>
	<span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_lock</span><span class="p">);</span>
	<span class="n">bcm_enet_refill_rx</span><span class="p">((</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * extract packet from rx queue</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">bcm_enet_receive_queue</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">budget</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bcm_enet_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">kdev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">processed</span><span class="p">;</span>

	<span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">kdev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">processed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* don&#39;t scan ring further than number of refilled</span>
<span class="cm">	 * descriptor */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">budget</span> <span class="o">&gt;</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_desc_count</span><span class="p">)</span>
		<span class="n">budget</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_desc_count</span><span class="p">;</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">bcm_enet_desc</span> <span class="o">*</span><span class="n">desc</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">desc_idx</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">len_stat</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">len</span><span class="p">;</span>

		<span class="n">desc_idx</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_curr_desc</span><span class="p">;</span>
		<span class="n">desc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_desc_cpu</span><span class="p">[</span><span class="n">desc_idx</span><span class="p">];</span>

		<span class="cm">/* make sure we actually read the descriptor status at</span>
<span class="cm">		 * each loop */</span>
		<span class="n">rmb</span><span class="p">();</span>

		<span class="n">len_stat</span> <span class="o">=</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">len_stat</span><span class="p">;</span>

		<span class="cm">/* break if dma ownership belongs to hw */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">len_stat</span> <span class="o">&amp;</span> <span class="n">DMADESC_OWNER_MASK</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">processed</span><span class="o">++</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_curr_desc</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_curr_desc</span> <span class="o">==</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_ring_size</span><span class="p">)</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_curr_desc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_desc_count</span><span class="o">--</span><span class="p">;</span>

		<span class="cm">/* if the packet does not have start of packet _and_</span>
<span class="cm">		 * end of packet flag set, then just recycle it */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">len_stat</span> <span class="o">&amp;</span> <span class="n">DMADESC_ESOP_MASK</span><span class="p">)</span> <span class="o">!=</span> <span class="n">DMADESC_ESOP_MASK</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_dropped</span><span class="o">++</span><span class="p">;</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* recycle packet if it&#39;s marked as bad */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">len_stat</span> <span class="o">&amp;</span> <span class="n">DMADESC_ERR_MASK</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_errors</span><span class="o">++</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">len_stat</span> <span class="o">&amp;</span> <span class="n">DMADESC_OVSIZE_MASK</span><span class="p">)</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_length_errors</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">len_stat</span> <span class="o">&amp;</span> <span class="n">DMADESC_CRC_MASK</span><span class="p">)</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_crc_errors</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">len_stat</span> <span class="o">&amp;</span> <span class="n">DMADESC_UNDER_MASK</span><span class="p">)</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_frame_errors</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">len_stat</span> <span class="o">&amp;</span> <span class="n">DMADESC_OV_MASK</span><span class="p">)</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_fifo_errors</span><span class="o">++</span><span class="p">;</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* valid packet */</span>
		<span class="n">skb</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_skb</span><span class="p">[</span><span class="n">desc_idx</span><span class="p">];</span>
		<span class="n">len</span> <span class="o">=</span> <span class="p">(</span><span class="n">len_stat</span> <span class="o">&amp;</span> <span class="n">DMADESC_LENGTH_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">DMADESC_LENGTH_SHIFT</span><span class="p">;</span>
		<span class="cm">/* don&#39;t include FCS */</span>
		<span class="n">len</span> <span class="o">-=</span> <span class="mi">4</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="n">copybreak</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">nskb</span><span class="p">;</span>

			<span class="n">nskb</span> <span class="o">=</span> <span class="n">netdev_alloc_skb_ip_align</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nskb</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* forget packet, just rearm desc */</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_dropped</span><span class="o">++</span><span class="p">;</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">dma_sync_single_for_cpu</span><span class="p">(</span><span class="n">kdev</span><span class="p">,</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">address</span><span class="p">,</span>
						<span class="n">len</span><span class="p">,</span> <span class="n">DMA_FROM_DEVICE</span><span class="p">);</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">nskb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
			<span class="n">dma_sync_single_for_device</span><span class="p">(</span><span class="n">kdev</span><span class="p">,</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">address</span><span class="p">,</span>
						   <span class="n">len</span><span class="p">,</span> <span class="n">DMA_FROM_DEVICE</span><span class="p">);</span>
			<span class="n">skb</span> <span class="o">=</span> <span class="n">nskb</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">dma_unmap_single</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">address</span><span class="p">,</span>
					 <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_skb_size</span><span class="p">,</span> <span class="n">DMA_FROM_DEVICE</span><span class="p">);</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_skb</span><span class="p">[</span><span class="n">desc_idx</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
		<span class="n">skb</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">eth_type_trans</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_packets</span><span class="o">++</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_bytes</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
		<span class="n">netif_receive_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">budget</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">processed</span> <span class="o">||</span> <span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_desc_count</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bcm_enet_refill_rx</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

		<span class="cm">/* kick rx dma */</span>
		<span class="n">enet_dma_writel</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">ENETDMA_CHANCFG_EN_MASK</span><span class="p">,</span>
				<span class="n">ENETDMA_CHANCFG_REG</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_chan</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">processed</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * try to or force reclaim of transmitted buffers</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">bcm_enet_tx_reclaim</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">force</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bcm_enet_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">released</span><span class="p">;</span>

	<span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">released</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_desc_count</span> <span class="o">&lt;</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_ring_size</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">bcm_enet_desc</span> <span class="o">*</span><span class="n">desc</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>

		<span class="cm">/* We run in a bh and fight against start_xmit, which</span>
<span class="cm">		 * is called with bh disabled  */</span>
		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_lock</span><span class="p">);</span>

		<span class="n">desc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_desc_cpu</span><span class="p">[</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_dirty_desc</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">force</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">len_stat</span> <span class="o">&amp;</span> <span class="n">DMADESC_OWNER_MASK</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_lock</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* ensure other field of the descriptor were not read</span>
<span class="cm">		 * before we checked ownership */</span>
		<span class="n">rmb</span><span class="p">();</span>

		<span class="n">skb</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="p">[</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_dirty_desc</span><span class="p">];</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="p">[</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_dirty_desc</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">dma_unmap_single</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">address</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span>
				 <span class="n">DMA_TO_DEVICE</span><span class="p">);</span>

		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_dirty_desc</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_dirty_desc</span> <span class="o">==</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_ring_size</span><span class="p">)</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_dirty_desc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_desc_count</span><span class="o">++</span><span class="p">;</span>

		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_lock</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">len_stat</span> <span class="o">&amp;</span> <span class="n">DMADESC_UNDER_MASK</span><span class="p">)</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_errors</span><span class="o">++</span><span class="p">;</span>

		<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="n">released</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">netif_queue_stopped</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">released</span><span class="p">)</span>
		<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">released</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * poll func, called by network core</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">bcm_enet_poll</span><span class="p">(</span><span class="k">struct</span> <span class="n">napi_struct</span> <span class="o">*</span><span class="n">napi</span><span class="p">,</span> <span class="kt">int</span> <span class="n">budget</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bcm_enet_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">tx_work_done</span><span class="p">,</span> <span class="n">rx_work_done</span><span class="p">;</span>

	<span class="n">priv</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">napi</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bcm_enet_priv</span><span class="p">,</span> <span class="n">napi</span><span class="p">);</span>
	<span class="n">dev</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">net_dev</span><span class="p">;</span>

	<span class="cm">/* ack interrupts */</span>
	<span class="n">enet_dma_writel</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">ENETDMA_IR_PKTDONE_MASK</span><span class="p">,</span>
			<span class="n">ENETDMA_IR_REG</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_chan</span><span class="p">));</span>
	<span class="n">enet_dma_writel</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">ENETDMA_IR_PKTDONE_MASK</span><span class="p">,</span>
			<span class="n">ENETDMA_IR_REG</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_chan</span><span class="p">));</span>

	<span class="cm">/* reclaim sent skb */</span>
	<span class="n">tx_work_done</span> <span class="o">=</span> <span class="n">bcm_enet_tx_reclaim</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_lock</span><span class="p">);</span>
	<span class="n">rx_work_done</span> <span class="o">=</span> <span class="n">bcm_enet_receive_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">budget</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rx_work_done</span> <span class="o">&gt;=</span> <span class="n">budget</span> <span class="o">||</span> <span class="n">tx_work_done</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* rx/tx queue is not yet empty/clean */</span>
		<span class="k">return</span> <span class="n">rx_work_done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* no more packet in rx/tx queue, remove device from poll</span>
<span class="cm">	 * queue */</span>
	<span class="n">napi_complete</span><span class="p">(</span><span class="n">napi</span><span class="p">);</span>

	<span class="cm">/* restore rx/tx interrupt */</span>
	<span class="n">enet_dma_writel</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">ENETDMA_IR_PKTDONE_MASK</span><span class="p">,</span>
			<span class="n">ENETDMA_IRMASK_REG</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_chan</span><span class="p">));</span>
	<span class="n">enet_dma_writel</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">ENETDMA_IR_PKTDONE_MASK</span><span class="p">,</span>
			<span class="n">ENETDMA_IRMASK_REG</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_chan</span><span class="p">));</span>

	<span class="k">return</span> <span class="n">rx_work_done</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * mac interrupt handler</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">bcm_enet_isr_mac</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bcm_enet_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">stat</span><span class="p">;</span>

	<span class="n">dev</span> <span class="o">=</span> <span class="n">dev_id</span><span class="p">;</span>
	<span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">stat</span> <span class="o">=</span> <span class="n">enet_readl</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">ENET_IR_REG</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="n">ENET_IR_MIB</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>

	<span class="cm">/* clear &amp; mask interrupt */</span>
	<span class="n">enet_writel</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">ENET_IR_MIB</span><span class="p">,</span> <span class="n">ENET_IR_REG</span><span class="p">);</span>
	<span class="n">enet_writel</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ENET_IRMASK_REG</span><span class="p">);</span>

	<span class="cm">/* read mib registers in workqueue */</span>
	<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mib_update_task</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * rx/tx dma interrupt handler</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">bcm_enet_isr_dma</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bcm_enet_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">;</span>

	<span class="n">dev</span> <span class="o">=</span> <span class="n">dev_id</span><span class="p">;</span>
	<span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* mask rx/tx interrupts */</span>
	<span class="n">enet_dma_writel</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ENETDMA_IRMASK_REG</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_chan</span><span class="p">));</span>
	<span class="n">enet_dma_writel</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ENETDMA_IRMASK_REG</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_chan</span><span class="p">));</span>

	<span class="n">napi_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * tx request callback</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">bcm_enet_start_xmit</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bcm_enet_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bcm_enet_desc</span> <span class="o">*</span><span class="n">desc</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">len_stat</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* lock against tx reclaim */</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_lock</span><span class="p">);</span>

	<span class="cm">/* make sure  the tx hw queue  is not full,  should not happen</span>
<span class="cm">	 * since we stop queue before it&#39;s the case */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_desc_count</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;xmit called with no tx desc &quot;</span>
			<span class="s">&quot;available?</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">NETDEV_TX_BUSY</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_unlock</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* point to the next available desc */</span>
	<span class="n">desc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_desc_cpu</span><span class="p">[</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_curr_desc</span><span class="p">];</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="p">[</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_curr_desc</span><span class="p">]</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>

	<span class="cm">/* fill descriptor */</span>
	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">address</span> <span class="o">=</span> <span class="n">dma_map_single</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span>
				       <span class="n">DMA_TO_DEVICE</span><span class="p">);</span>

	<span class="n">len_stat</span> <span class="o">=</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&lt;&lt;</span> <span class="n">DMADESC_LENGTH_SHIFT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">DMADESC_LENGTH_MASK</span><span class="p">;</span>
	<span class="n">len_stat</span> <span class="o">|=</span> <span class="n">DMADESC_ESOP_MASK</span> <span class="o">|</span>
		<span class="n">DMADESC_APPEND_CRC</span> <span class="o">|</span>
		<span class="n">DMADESC_OWNER_MASK</span><span class="p">;</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_curr_desc</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_curr_desc</span> <span class="o">==</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_ring_size</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_curr_desc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">len_stat</span> <span class="o">|=</span> <span class="n">DMADESC_WRAP_MASK</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_desc_count</span><span class="o">--</span><span class="p">;</span>

	<span class="cm">/* dma might be already polling, make sure we update desc</span>
<span class="cm">	 * fields in correct order */</span>
	<span class="n">wmb</span><span class="p">();</span>
	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">len_stat</span> <span class="o">=</span> <span class="n">len_stat</span><span class="p">;</span>
	<span class="n">wmb</span><span class="p">();</span>

	<span class="cm">/* kick tx dma */</span>
	<span class="n">enet_dma_writel</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">ENETDMA_CHANCFG_EN_MASK</span><span class="p">,</span>
			<span class="n">ENETDMA_CHANCFG_REG</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_chan</span><span class="p">));</span>

	<span class="cm">/* stop queue if no more desc available */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_desc_count</span><span class="p">)</span>
		<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_bytes</span> <span class="o">+=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_packets</span><span class="o">++</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">NETDEV_TX_OK</span><span class="p">;</span>

<span class="nl">out_unlock:</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Change the interface&#39;s mac address.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">bcm_enet_set_mac_address</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bcm_enet_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="n">addr</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">addr</span><span class="o">-&gt;</span><span class="n">sa_data</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>

	<span class="cm">/* use perfect match register 0 to store my mac address */</span>
	<span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
	<span class="n">enet_writel</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">ENET_PML_REG</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>

	<span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span> <span class="o">|</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
	<span class="n">val</span> <span class="o">|=</span> <span class="n">ENET_PMH_DATAVALID_MASK</span><span class="p">;</span>
	<span class="n">enet_writel</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">ENET_PMH_REG</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Change rx mode (promiscuous/allmulti) and update multicast list</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">bcm_enet_set_multicast_list</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bcm_enet_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">netdev_hw_addr</span> <span class="o">*</span><span class="n">ha</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">enet_readl</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">ENET_RXCFG_REG</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_PROMISC</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">ENET_RXCFG_PROMISC_MASK</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ENET_RXCFG_PROMISC_MASK</span><span class="p">;</span>

	<span class="cm">/* only 3 perfect match registers left, first one is used for</span>
<span class="cm">	 * own mac address */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_ALLMULTI</span><span class="p">)</span> <span class="o">||</span> <span class="n">netdev_mc_count</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">ENET_RXCFG_ALLMCAST_MASK</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ENET_RXCFG_ALLMCAST_MASK</span><span class="p">;</span>

	<span class="cm">/* no need to set perfect match registers if we catch all</span>
<span class="cm">	 * multicast */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">ENET_RXCFG_ALLMCAST_MASK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">enet_writel</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">ENET_RXCFG_REG</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">netdev_for_each_mc_addr</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="o">*</span><span class="n">dmi_addr</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">tmp</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="cm">/* update perfect match registers */</span>
		<span class="n">dmi_addr</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">;</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">dmi_addr</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">dmi_addr</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">(</span><span class="n">dmi_addr</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">dmi_addr</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
		<span class="n">enet_writel</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">ENET_PML_REG</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">));</span>

		<span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">dmi_addr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span> <span class="o">|</span> <span class="n">dmi_addr</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
		<span class="n">tmp</span> <span class="o">|=</span> <span class="n">ENET_PMH_DATAVALID_MASK</span><span class="p">;</span>
		<span class="n">enet_writel</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">ENET_PMH_REG</span><span class="p">(</span><span class="n">i</span><span class="o">++</span> <span class="o">+</span> <span class="mi">1</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">enet_writel</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ENET_PML_REG</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">));</span>
		<span class="n">enet_writel</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ENET_PMH_REG</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="n">enet_writel</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">ENET_RXCFG_REG</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * set mac duplex parameters</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">bcm_enet_set_duplex</span><span class="p">(</span><span class="k">struct</span> <span class="n">bcm_enet_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="kt">int</span> <span class="n">fullduplex</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">enet_readl</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">ENET_TXCTL_REG</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fullduplex</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">ENET_TXCTL_FD_MASK</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ENET_TXCTL_FD_MASK</span><span class="p">;</span>
	<span class="n">enet_writel</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">ENET_TXCTL_REG</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * set mac flow control parameters</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">bcm_enet_set_flow</span><span class="p">(</span><span class="k">struct</span> <span class="n">bcm_enet_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rx_en</span><span class="p">,</span> <span class="kt">int</span> <span class="n">tx_en</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>

	<span class="cm">/* rx flow control (pause frame handling) */</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">enet_readl</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">ENET_RXCFG_REG</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rx_en</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">ENET_RXCFG_ENFLOW_MASK</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ENET_RXCFG_ENFLOW_MASK</span><span class="p">;</span>
	<span class="n">enet_writel</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">ENET_RXCFG_REG</span><span class="p">);</span>

	<span class="cm">/* tx flow control (pause frame generation) */</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">enet_dma_readl</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">ENETDMA_CFG_REG</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tx_en</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">ENETDMA_CFG_FLOWCH_MASK</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_chan</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ENETDMA_CFG_FLOWCH_MASK</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_chan</span><span class="p">);</span>
	<span class="n">enet_dma_writel</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">ENETDMA_CFG_REG</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * link changed callback (from phylib)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">bcm_enet_adjust_phy_link</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bcm_enet_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">phy_device</span> <span class="o">*</span><span class="n">phydev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status_changed</span><span class="p">;</span>

	<span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">phydev</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">phydev</span><span class="p">;</span>
	<span class="n">status_changed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">old_link</span> <span class="o">!=</span> <span class="n">phydev</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status_changed</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">old_link</span> <span class="o">=</span> <span class="n">phydev</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* reflect duplex change in mac configuration */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phydev</span><span class="o">-&gt;</span><span class="n">link</span> <span class="o">&amp;&amp;</span> <span class="n">phydev</span><span class="o">-&gt;</span><span class="n">duplex</span> <span class="o">!=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">old_duplex</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bcm_enet_set_duplex</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span>
				    <span class="p">(</span><span class="n">phydev</span><span class="o">-&gt;</span><span class="n">duplex</span> <span class="o">==</span> <span class="n">DUPLEX_FULL</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">status_changed</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">old_duplex</span> <span class="o">=</span> <span class="n">phydev</span><span class="o">-&gt;</span><span class="n">duplex</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* enable flow control if remote advertise it (trust phylib to</span>
<span class="cm">	 * check that duplex is full */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phydev</span><span class="o">-&gt;</span><span class="n">link</span> <span class="o">&amp;&amp;</span> <span class="n">phydev</span><span class="o">-&gt;</span><span class="n">pause</span> <span class="o">!=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">old_pause</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">rx_pause_en</span><span class="p">,</span> <span class="n">tx_pause_en</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">phydev</span><span class="o">-&gt;</span><span class="n">pause</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* pause was advertised by lpa and us */</span>
			<span class="n">rx_pause_en</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">tx_pause_en</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pause_auto</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* pause setting overrided by user */</span>
			<span class="n">rx_pause_en</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">pause_rx</span><span class="p">;</span>
			<span class="n">tx_pause_en</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">pause_tx</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">rx_pause_en</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">tx_pause_en</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">bcm_enet_set_flow</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">rx_pause_en</span><span class="p">,</span> <span class="n">tx_pause_en</span><span class="p">);</span>
		<span class="n">status_changed</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">old_pause</span> <span class="o">=</span> <span class="n">phydev</span><span class="o">-&gt;</span><span class="n">pause</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status_changed</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%s: link %s&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">phydev</span><span class="o">-&gt;</span><span class="n">link</span> <span class="o">?</span>
			<span class="s">&quot;UP&quot;</span> <span class="o">:</span> <span class="s">&quot;DOWN&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">phydev</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">)</span>
			<span class="n">pr_cont</span><span class="p">(</span><span class="s">&quot; - %d/%s - flow control %s&quot;</span><span class="p">,</span> <span class="n">phydev</span><span class="o">-&gt;</span><span class="n">speed</span><span class="p">,</span>
			       <span class="n">DUPLEX_FULL</span> <span class="o">==</span> <span class="n">phydev</span><span class="o">-&gt;</span><span class="n">duplex</span> <span class="o">?</span> <span class="s">&quot;full&quot;</span> <span class="o">:</span> <span class="s">&quot;half&quot;</span><span class="p">,</span>
			       <span class="n">phydev</span><span class="o">-&gt;</span><span class="n">pause</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">?</span> <span class="s">&quot;rx&amp;tx&quot;</span> <span class="o">:</span> <span class="s">&quot;off&quot;</span><span class="p">);</span>

		<span class="n">pr_cont</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * link changed callback (if phylib is not used)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">bcm_enet_adjust_link</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bcm_enet_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">;</span>

	<span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">bcm_enet_set_duplex</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">force_duplex_full</span><span class="p">);</span>
	<span class="n">bcm_enet_set_flow</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">pause_rx</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">pause_tx</span><span class="p">);</span>
	<span class="n">netif_carrier_on</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%s: link forced UP - %d/%s - flow control %s/%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">force_speed_100</span> <span class="o">?</span> <span class="mi">100</span> <span class="o">:</span> <span class="mi">10</span><span class="p">,</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">force_duplex_full</span> <span class="o">?</span> <span class="s">&quot;full&quot;</span> <span class="o">:</span> <span class="s">&quot;half&quot;</span><span class="p">,</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">pause_rx</span> <span class="o">?</span> <span class="s">&quot;rx&quot;</span> <span class="o">:</span> <span class="s">&quot;off&quot;</span><span class="p">,</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">pause_tx</span> <span class="o">?</span> <span class="s">&quot;tx&quot;</span> <span class="o">:</span> <span class="s">&quot;off&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * open callback, allocate dma rings &amp; buffers and start rx operation</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">bcm_enet_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bcm_enet_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sockaddr</span> <span class="n">addr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">kdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">phy_device</span> <span class="o">*</span><span class="n">phydev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">size</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">phy_id</span><span class="p">[</span><span class="n">MII_BUS_ID_SIZE</span> <span class="o">+</span> <span class="mi">3</span><span class="p">];</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">kdev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">has_phy</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* connect to PHY */</span>
		<span class="n">snprintf</span><span class="p">(</span><span class="n">phy_id</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">phy_id</span><span class="p">),</span> <span class="n">PHY_ID_FMT</span><span class="p">,</span>
			 <span class="n">priv</span><span class="o">-&gt;</span><span class="n">mii_bus</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">phy_id</span><span class="p">);</span>

		<span class="n">phydev</span> <span class="o">=</span> <span class="n">phy_connect</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">phy_id</span><span class="p">,</span> <span class="n">bcm_enet_adjust_phy_link</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				     <span class="n">PHY_INTERFACE_MODE_MII</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">phydev</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">kdev</span><span class="p">,</span> <span class="s">&quot;could not attach to PHY</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">phydev</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* mask with MAC supported features */</span>
		<span class="n">phydev</span><span class="o">-&gt;</span><span class="n">supported</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="n">SUPPORTED_10baseT_Half</span> <span class="o">|</span>
				      <span class="n">SUPPORTED_10baseT_Full</span> <span class="o">|</span>
				      <span class="n">SUPPORTED_100baseT_Half</span> <span class="o">|</span>
				      <span class="n">SUPPORTED_100baseT_Full</span> <span class="o">|</span>
				      <span class="n">SUPPORTED_Autoneg</span> <span class="o">|</span>
				      <span class="n">SUPPORTED_Pause</span> <span class="o">|</span>
				      <span class="n">SUPPORTED_MII</span><span class="p">);</span>
		<span class="n">phydev</span><span class="o">-&gt;</span><span class="n">advertising</span> <span class="o">=</span> <span class="n">phydev</span><span class="o">-&gt;</span><span class="n">supported</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pause_auto</span> <span class="o">&amp;&amp;</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">pause_rx</span> <span class="o">&amp;&amp;</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">pause_tx</span><span class="p">)</span>
			<span class="n">phydev</span><span class="o">-&gt;</span><span class="n">advertising</span> <span class="o">|=</span> <span class="n">SUPPORTED_Pause</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">phydev</span><span class="o">-&gt;</span><span class="n">advertising</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SUPPORTED_Pause</span><span class="p">;</span>

		<span class="n">dev_info</span><span class="p">(</span><span class="n">kdev</span><span class="p">,</span> <span class="s">&quot;attached PHY at address %d [%s]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">phydev</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">phydev</span><span class="o">-&gt;</span><span class="n">drv</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">old_link</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">old_duplex</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">old_pause</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">phydev</span> <span class="o">=</span> <span class="n">phydev</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* mask all interrupts and request them */</span>
	<span class="n">enet_writel</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ENET_IRMASK_REG</span><span class="p">);</span>
	<span class="n">enet_dma_writel</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ENETDMA_IRMASK_REG</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_chan</span><span class="p">));</span>
	<span class="n">enet_dma_writel</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ENETDMA_IRMASK_REG</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_chan</span><span class="p">));</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">bcm_enet_isr_mac</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_phy_disconnect</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">irq_rx</span><span class="p">,</span> <span class="n">bcm_enet_isr_dma</span><span class="p">,</span> <span class="n">IRQF_DISABLED</span><span class="p">,</span>
			  <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_freeirq</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">irq_tx</span><span class="p">,</span> <span class="n">bcm_enet_isr_dma</span><span class="p">,</span>
			  <span class="n">IRQF_DISABLED</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_freeirq_rx</span><span class="p">;</span>

	<span class="cm">/* initialize perfect match registers */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">enet_writel</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ENET_PML_REG</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
		<span class="n">enet_writel</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ENET_PMH_REG</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="cm">/* write device mac address */</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">addr</span><span class="p">.</span><span class="n">sa_data</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="n">bcm_enet_set_mac_address</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">addr</span><span class="p">);</span>

	<span class="cm">/* allocate rx dma ring */</span>
	<span class="n">size</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_ring_size</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">bcm_enet_desc</span><span class="p">);</span>
	<span class="n">p</span> <span class="o">=</span> <span class="n">dma_alloc_coherent</span><span class="p">(</span><span class="n">kdev</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_desc_dma</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">p</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">kdev</span><span class="p">,</span> <span class="s">&quot;cannot allocate rx ring %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_freeirq_tx</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_desc_alloc_size</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_desc_cpu</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span>

	<span class="cm">/* allocate tx dma ring */</span>
	<span class="n">size</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_ring_size</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">bcm_enet_desc</span><span class="p">);</span>
	<span class="n">p</span> <span class="o">=</span> <span class="n">dma_alloc_coherent</span><span class="p">(</span><span class="n">kdev</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_desc_dma</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">p</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">kdev</span><span class="p">,</span> <span class="s">&quot;cannot allocate tx ring</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_free_rx_ring</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_desc_alloc_size</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_desc_cpu</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_skb</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="p">)</span> <span class="o">*</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_ring_size</span><span class="p">,</span>
			       <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">kdev</span><span class="p">,</span> <span class="s">&quot;cannot allocate rx skb queue</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_free_tx_ring</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_desc_count</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_ring_size</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_dirty_desc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_curr_desc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_lock</span><span class="p">);</span>

	<span class="cm">/* init &amp; fill rx ring with skbs */</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_skb</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="p">)</span> <span class="o">*</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_ring_size</span><span class="p">,</span>
			       <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_skb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">kdev</span><span class="p">,</span> <span class="s">&quot;cannot allocate rx skb queue</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_free_tx_skb</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_desc_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_dirty_desc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_curr_desc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* initialize flow control buffer allocation */</span>
	<span class="n">enet_dma_writel</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">ENETDMA_BUFALLOC_FORCE_MASK</span> <span class="o">|</span> <span class="mi">0</span><span class="p">,</span>
			<span class="n">ENETDMA_BUFALLOC_REG</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_chan</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bcm_enet_refill_rx</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">kdev</span><span class="p">,</span> <span class="s">&quot;cannot allocate rx skb queue</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* write rx &amp; tx ring addresses */</span>
	<span class="n">enet_dma_writel</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_desc_dma</span><span class="p">,</span>
			<span class="n">ENETDMA_RSTART_REG</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_chan</span><span class="p">));</span>
	<span class="n">enet_dma_writel</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_desc_dma</span><span class="p">,</span>
			<span class="n">ENETDMA_RSTART_REG</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_chan</span><span class="p">));</span>

	<span class="cm">/* clear remaining state ram for rx &amp; tx channel */</span>
	<span class="n">enet_dma_writel</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ENETDMA_SRAM2_REG</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_chan</span><span class="p">));</span>
	<span class="n">enet_dma_writel</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ENETDMA_SRAM2_REG</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_chan</span><span class="p">));</span>
	<span class="n">enet_dma_writel</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ENETDMA_SRAM3_REG</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_chan</span><span class="p">));</span>
	<span class="n">enet_dma_writel</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ENETDMA_SRAM3_REG</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_chan</span><span class="p">));</span>
	<span class="n">enet_dma_writel</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ENETDMA_SRAM4_REG</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_chan</span><span class="p">));</span>
	<span class="n">enet_dma_writel</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ENETDMA_SRAM4_REG</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_chan</span><span class="p">));</span>

	<span class="cm">/* set max rx/tx length */</span>
	<span class="n">enet_writel</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw_mtu</span><span class="p">,</span> <span class="n">ENET_RXMAXLEN_REG</span><span class="p">);</span>
	<span class="n">enet_writel</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw_mtu</span><span class="p">,</span> <span class="n">ENET_TXMAXLEN_REG</span><span class="p">);</span>

	<span class="cm">/* set dma maximum burst len */</span>
	<span class="n">enet_dma_writel</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">BCMENET_DMA_MAXBURST</span><span class="p">,</span>
			<span class="n">ENETDMA_MAXBURST_REG</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_chan</span><span class="p">));</span>
	<span class="n">enet_dma_writel</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">BCMENET_DMA_MAXBURST</span><span class="p">,</span>
			<span class="n">ENETDMA_MAXBURST_REG</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_chan</span><span class="p">));</span>

	<span class="cm">/* set correct transmit fifo watermark */</span>
	<span class="n">enet_writel</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">BCMENET_TX_FIFO_TRESH</span><span class="p">,</span> <span class="n">ENET_TXWMARK_REG</span><span class="p">);</span>

	<span class="cm">/* set flow control low/high threshold to 1/3 / 2/3 */</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_ring_size</span> <span class="o">/</span> <span class="mi">3</span><span class="p">;</span>
	<span class="n">enet_dma_writel</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">ENETDMA_FLOWCL_REG</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_chan</span><span class="p">));</span>
	<span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_ring_size</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="mi">3</span><span class="p">;</span>
	<span class="n">enet_dma_writel</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">ENETDMA_FLOWCH_REG</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_chan</span><span class="p">));</span>

	<span class="cm">/* all set, enable mac and interrupts, start dma engine and</span>
<span class="cm">	 * kick rx dma channel */</span>
	<span class="n">wmb</span><span class="p">();</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">enet_readl</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">ENET_CTL_REG</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">|=</span> <span class="n">ENET_CTL_ENABLE_MASK</span><span class="p">;</span>
	<span class="n">enet_writel</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">ENET_CTL_REG</span><span class="p">);</span>
	<span class="n">enet_dma_writel</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">ENETDMA_CFG_EN_MASK</span><span class="p">,</span> <span class="n">ENETDMA_CFG_REG</span><span class="p">);</span>
	<span class="n">enet_dma_writel</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">ENETDMA_CHANCFG_EN_MASK</span><span class="p">,</span>
			<span class="n">ENETDMA_CHANCFG_REG</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_chan</span><span class="p">));</span>

	<span class="cm">/* watch &quot;mib counters about to overflow&quot; interrupt */</span>
	<span class="n">enet_writel</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">ENET_IR_MIB</span><span class="p">,</span> <span class="n">ENET_IR_REG</span><span class="p">);</span>
	<span class="n">enet_writel</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">ENET_IR_MIB</span><span class="p">,</span> <span class="n">ENET_IRMASK_REG</span><span class="p">);</span>

	<span class="cm">/* watch &quot;packet transferred&quot; interrupt in rx and tx */</span>
	<span class="n">enet_dma_writel</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">ENETDMA_IR_PKTDONE_MASK</span><span class="p">,</span>
			<span class="n">ENETDMA_IR_REG</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_chan</span><span class="p">));</span>
	<span class="n">enet_dma_writel</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">ENETDMA_IR_PKTDONE_MASK</span><span class="p">,</span>
			<span class="n">ENETDMA_IR_REG</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_chan</span><span class="p">));</span>

	<span class="cm">/* make sure we enable napi before rx interrupt  */</span>
	<span class="n">napi_enable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">);</span>

	<span class="n">enet_dma_writel</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">ENETDMA_IR_PKTDONE_MASK</span><span class="p">,</span>
			<span class="n">ENETDMA_IRMASK_REG</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_chan</span><span class="p">));</span>
	<span class="n">enet_dma_writel</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">ENETDMA_IR_PKTDONE_MASK</span><span class="p">,</span>
			<span class="n">ENETDMA_IRMASK_REG</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_chan</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">has_phy</span><span class="p">)</span>
		<span class="n">phy_start</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">phydev</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">bcm_enet_adjust_link</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">netif_start_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">out:</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_ring_size</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">bcm_enet_desc</span> <span class="o">*</span><span class="n">desc</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_skb</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">desc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_desc_cpu</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">dma_unmap_single</span><span class="p">(</span><span class="n">kdev</span><span class="p">,</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">address</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_skb_size</span><span class="p">,</span>
				 <span class="n">DMA_FROM_DEVICE</span><span class="p">);</span>
		<span class="n">kfree_skb</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_skb</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="p">}</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_skb</span><span class="p">);</span>

<span class="nl">out_free_tx_skb:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="p">);</span>

<span class="nl">out_free_tx_ring:</span>
	<span class="n">dma_free_coherent</span><span class="p">(</span><span class="n">kdev</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_desc_alloc_size</span><span class="p">,</span>
			  <span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_desc_cpu</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_desc_dma</span><span class="p">);</span>

<span class="nl">out_free_rx_ring:</span>
	<span class="n">dma_free_coherent</span><span class="p">(</span><span class="n">kdev</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_desc_alloc_size</span><span class="p">,</span>
			  <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_desc_cpu</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_desc_dma</span><span class="p">);</span>

<span class="nl">out_freeirq_tx:</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">irq_tx</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>

<span class="nl">out_freeirq_rx:</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">irq_rx</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>

<span class="nl">out_freeirq:</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>

<span class="nl">out_phy_disconnect:</span>
	<span class="n">phy_disconnect</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">phydev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * disable mac</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">bcm_enet_disable_mac</span><span class="p">(</span><span class="k">struct</span> <span class="n">bcm_enet_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">limit</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">enet_readl</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">ENET_CTL_REG</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">|=</span> <span class="n">ENET_CTL_DISABLE_MASK</span><span class="p">;</span>
	<span class="n">enet_writel</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">ENET_CTL_REG</span><span class="p">);</span>

	<span class="n">limit</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">;</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>

		<span class="n">val</span> <span class="o">=</span> <span class="n">enet_readl</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">ENET_CTL_REG</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">ENET_CTL_DISABLE_MASK</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">limit</span><span class="o">--</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * disable dma in given channel</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">bcm_enet_disable_dma</span><span class="p">(</span><span class="k">struct</span> <span class="n">bcm_enet_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="kt">int</span> <span class="n">chan</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">limit</span><span class="p">;</span>

	<span class="n">enet_dma_writel</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ENETDMA_CHANCFG_REG</span><span class="p">(</span><span class="n">chan</span><span class="p">));</span>

	<span class="n">limit</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">;</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>

		<span class="n">val</span> <span class="o">=</span> <span class="n">enet_dma_readl</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">ENETDMA_CHANCFG_REG</span><span class="p">(</span><span class="n">chan</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">ENETDMA_CHANCFG_EN_MASK</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">limit</span><span class="o">--</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * stop callback</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">bcm_enet_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bcm_enet_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">kdev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">kdev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

	<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">napi_disable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">has_phy</span><span class="p">)</span>
		<span class="n">phy_stop</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">phydev</span><span class="p">);</span>
	<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_timeout</span><span class="p">);</span>

	<span class="cm">/* mask all interrupts */</span>
	<span class="n">enet_writel</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ENET_IRMASK_REG</span><span class="p">);</span>
	<span class="n">enet_dma_writel</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ENETDMA_IRMASK_REG</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_chan</span><span class="p">));</span>
	<span class="n">enet_dma_writel</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ENETDMA_IRMASK_REG</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_chan</span><span class="p">));</span>

	<span class="cm">/* make sure no mib update is scheduled */</span>
	<span class="n">cancel_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mib_update_task</span><span class="p">);</span>

	<span class="cm">/* disable dma &amp; mac */</span>
	<span class="n">bcm_enet_disable_dma</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_chan</span><span class="p">);</span>
	<span class="n">bcm_enet_disable_dma</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_chan</span><span class="p">);</span>
	<span class="n">bcm_enet_disable_mac</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>

	<span class="cm">/* force reclaim of all tx buffers */</span>
	<span class="n">bcm_enet_tx_reclaim</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* free the rx skb ring */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_ring_size</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">bcm_enet_desc</span> <span class="o">*</span><span class="n">desc</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_skb</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">desc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_desc_cpu</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">dma_unmap_single</span><span class="p">(</span><span class="n">kdev</span><span class="p">,</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">address</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_skb_size</span><span class="p">,</span>
				 <span class="n">DMA_FROM_DEVICE</span><span class="p">);</span>
		<span class="n">kfree_skb</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_skb</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="p">}</span>

	<span class="cm">/* free remaining allocated memory */</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_skb</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="p">);</span>
	<span class="n">dma_free_coherent</span><span class="p">(</span><span class="n">kdev</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_desc_alloc_size</span><span class="p">,</span>
			  <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_desc_cpu</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_desc_dma</span><span class="p">);</span>
	<span class="n">dma_free_coherent</span><span class="p">(</span><span class="n">kdev</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_desc_alloc_size</span><span class="p">,</span>
			  <span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_desc_cpu</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_desc_dma</span><span class="p">);</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">irq_tx</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">irq_rx</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* release phy */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">has_phy</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">phy_disconnect</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">phydev</span><span class="p">);</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">phydev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * ethtool callbacks</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">bcm_enet_stats</span> <span class="p">{</span>
	<span class="kt">char</span> <span class="n">stat_string</span><span class="p">[</span><span class="n">ETH_GSTRING_LEN</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">sizeof_stat</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">stat_offset</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">mib_reg</span><span class="p">;</span>
<span class="p">};</span>

<span class="cp">#define GEN_STAT(m) sizeof(((struct bcm_enet_priv *)0)-&gt;m),		\</span>
<span class="cp">		     offsetof(struct bcm_enet_priv, m)</span>
<span class="cp">#define DEV_STAT(m) sizeof(((struct net_device_stats *)0)-&gt;m),		\</span>
<span class="cp">		     offsetof(struct net_device_stats, m)</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">bcm_enet_stats</span> <span class="n">bcm_enet_gstrings_stats</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="s">&quot;rx_packets&quot;</span><span class="p">,</span> <span class="n">DEV_STAT</span><span class="p">(</span><span class="n">rx_packets</span><span class="p">),</span> <span class="o">-</span><span class="mi">1</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;tx_packets&quot;</span><span class="p">,</span>	<span class="n">DEV_STAT</span><span class="p">(</span><span class="n">tx_packets</span><span class="p">),</span> <span class="o">-</span><span class="mi">1</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;rx_bytes&quot;</span><span class="p">,</span> <span class="n">DEV_STAT</span><span class="p">(</span><span class="n">rx_bytes</span><span class="p">),</span> <span class="o">-</span><span class="mi">1</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;tx_bytes&quot;</span><span class="p">,</span> <span class="n">DEV_STAT</span><span class="p">(</span><span class="n">tx_bytes</span><span class="p">),</span> <span class="o">-</span><span class="mi">1</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;rx_errors&quot;</span><span class="p">,</span> <span class="n">DEV_STAT</span><span class="p">(</span><span class="n">rx_errors</span><span class="p">),</span> <span class="o">-</span><span class="mi">1</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;tx_errors&quot;</span><span class="p">,</span> <span class="n">DEV_STAT</span><span class="p">(</span><span class="n">tx_errors</span><span class="p">),</span> <span class="o">-</span><span class="mi">1</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;rx_dropped&quot;</span><span class="p">,</span>	<span class="n">DEV_STAT</span><span class="p">(</span><span class="n">rx_dropped</span><span class="p">),</span> <span class="o">-</span><span class="mi">1</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;tx_dropped&quot;</span><span class="p">,</span>	<span class="n">DEV_STAT</span><span class="p">(</span><span class="n">tx_dropped</span><span class="p">),</span> <span class="o">-</span><span class="mi">1</span> <span class="p">},</span>

	<span class="p">{</span> <span class="s">&quot;rx_good_octets&quot;</span><span class="p">,</span> <span class="n">GEN_STAT</span><span class="p">(</span><span class="n">mib</span><span class="p">.</span><span class="n">rx_gd_octets</span><span class="p">),</span> <span class="n">ETH_MIB_RX_GD_OCTETS</span><span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;rx_good_pkts&quot;</span><span class="p">,</span> <span class="n">GEN_STAT</span><span class="p">(</span><span class="n">mib</span><span class="p">.</span><span class="n">rx_gd_pkts</span><span class="p">),</span> <span class="n">ETH_MIB_RX_GD_PKTS</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;rx_broadcast&quot;</span><span class="p">,</span> <span class="n">GEN_STAT</span><span class="p">(</span><span class="n">mib</span><span class="p">.</span><span class="n">rx_brdcast</span><span class="p">),</span> <span class="n">ETH_MIB_RX_BRDCAST</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;rx_multicast&quot;</span><span class="p">,</span> <span class="n">GEN_STAT</span><span class="p">(</span><span class="n">mib</span><span class="p">.</span><span class="n">rx_mult</span><span class="p">),</span> <span class="n">ETH_MIB_RX_MULT</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;rx_64_octets&quot;</span><span class="p">,</span> <span class="n">GEN_STAT</span><span class="p">(</span><span class="n">mib</span><span class="p">.</span><span class="n">rx_64</span><span class="p">),</span> <span class="n">ETH_MIB_RX_64</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;rx_65_127_oct&quot;</span><span class="p">,</span> <span class="n">GEN_STAT</span><span class="p">(</span><span class="n">mib</span><span class="p">.</span><span class="n">rx_65_127</span><span class="p">),</span> <span class="n">ETH_MIB_RX_65_127</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;rx_128_255_oct&quot;</span><span class="p">,</span> <span class="n">GEN_STAT</span><span class="p">(</span><span class="n">mib</span><span class="p">.</span><span class="n">rx_128_255</span><span class="p">),</span> <span class="n">ETH_MIB_RX_128_255</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;rx_256_511_oct&quot;</span><span class="p">,</span> <span class="n">GEN_STAT</span><span class="p">(</span><span class="n">mib</span><span class="p">.</span><span class="n">rx_256_511</span><span class="p">),</span> <span class="n">ETH_MIB_RX_256_511</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;rx_512_1023_oct&quot;</span><span class="p">,</span> <span class="n">GEN_STAT</span><span class="p">(</span><span class="n">mib</span><span class="p">.</span><span class="n">rx_512_1023</span><span class="p">),</span> <span class="n">ETH_MIB_RX_512_1023</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;rx_1024_max_oct&quot;</span><span class="p">,</span> <span class="n">GEN_STAT</span><span class="p">(</span><span class="n">mib</span><span class="p">.</span><span class="n">rx_1024_max</span><span class="p">),</span> <span class="n">ETH_MIB_RX_1024_MAX</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;rx_jabber&quot;</span><span class="p">,</span> <span class="n">GEN_STAT</span><span class="p">(</span><span class="n">mib</span><span class="p">.</span><span class="n">rx_jab</span><span class="p">),</span> <span class="n">ETH_MIB_RX_JAB</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;rx_oversize&quot;</span><span class="p">,</span> <span class="n">GEN_STAT</span><span class="p">(</span><span class="n">mib</span><span class="p">.</span><span class="n">rx_ovr</span><span class="p">),</span> <span class="n">ETH_MIB_RX_OVR</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;rx_fragment&quot;</span><span class="p">,</span> <span class="n">GEN_STAT</span><span class="p">(</span><span class="n">mib</span><span class="p">.</span><span class="n">rx_frag</span><span class="p">),</span> <span class="n">ETH_MIB_RX_FRAG</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;rx_dropped&quot;</span><span class="p">,</span>	<span class="n">GEN_STAT</span><span class="p">(</span><span class="n">mib</span><span class="p">.</span><span class="n">rx_drop</span><span class="p">),</span> <span class="n">ETH_MIB_RX_DROP</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;rx_crc_align&quot;</span><span class="p">,</span> <span class="n">GEN_STAT</span><span class="p">(</span><span class="n">mib</span><span class="p">.</span><span class="n">rx_crc_align</span><span class="p">),</span> <span class="n">ETH_MIB_RX_CRC_ALIGN</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;rx_undersize&quot;</span><span class="p">,</span> <span class="n">GEN_STAT</span><span class="p">(</span><span class="n">mib</span><span class="p">.</span><span class="n">rx_und</span><span class="p">),</span> <span class="n">ETH_MIB_RX_UND</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;rx_crc&quot;</span><span class="p">,</span> <span class="n">GEN_STAT</span><span class="p">(</span><span class="n">mib</span><span class="p">.</span><span class="n">rx_crc</span><span class="p">),</span> <span class="n">ETH_MIB_RX_CRC</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;rx_align&quot;</span><span class="p">,</span> <span class="n">GEN_STAT</span><span class="p">(</span><span class="n">mib</span><span class="p">.</span><span class="n">rx_align</span><span class="p">),</span> <span class="n">ETH_MIB_RX_ALIGN</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;rx_symbol_error&quot;</span><span class="p">,</span> <span class="n">GEN_STAT</span><span class="p">(</span><span class="n">mib</span><span class="p">.</span><span class="n">rx_sym</span><span class="p">),</span> <span class="n">ETH_MIB_RX_SYM</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;rx_pause&quot;</span><span class="p">,</span> <span class="n">GEN_STAT</span><span class="p">(</span><span class="n">mib</span><span class="p">.</span><span class="n">rx_pause</span><span class="p">),</span> <span class="n">ETH_MIB_RX_PAUSE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;rx_control&quot;</span><span class="p">,</span> <span class="n">GEN_STAT</span><span class="p">(</span><span class="n">mib</span><span class="p">.</span><span class="n">rx_cntrl</span><span class="p">),</span> <span class="n">ETH_MIB_RX_CNTRL</span> <span class="p">},</span>

	<span class="p">{</span> <span class="s">&quot;tx_good_octets&quot;</span><span class="p">,</span> <span class="n">GEN_STAT</span><span class="p">(</span><span class="n">mib</span><span class="p">.</span><span class="n">tx_gd_octets</span><span class="p">),</span> <span class="n">ETH_MIB_TX_GD_OCTETS</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;tx_good_pkts&quot;</span><span class="p">,</span> <span class="n">GEN_STAT</span><span class="p">(</span><span class="n">mib</span><span class="p">.</span><span class="n">tx_gd_pkts</span><span class="p">),</span> <span class="n">ETH_MIB_TX_GD_PKTS</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;tx_broadcast&quot;</span><span class="p">,</span> <span class="n">GEN_STAT</span><span class="p">(</span><span class="n">mib</span><span class="p">.</span><span class="n">tx_brdcast</span><span class="p">),</span> <span class="n">ETH_MIB_TX_BRDCAST</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;tx_multicast&quot;</span><span class="p">,</span> <span class="n">GEN_STAT</span><span class="p">(</span><span class="n">mib</span><span class="p">.</span><span class="n">tx_mult</span><span class="p">),</span> <span class="n">ETH_MIB_TX_MULT</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;tx_64_oct&quot;</span><span class="p">,</span> <span class="n">GEN_STAT</span><span class="p">(</span><span class="n">mib</span><span class="p">.</span><span class="n">tx_64</span><span class="p">),</span> <span class="n">ETH_MIB_TX_64</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;tx_65_127_oct&quot;</span><span class="p">,</span> <span class="n">GEN_STAT</span><span class="p">(</span><span class="n">mib</span><span class="p">.</span><span class="n">tx_65_127</span><span class="p">),</span> <span class="n">ETH_MIB_TX_65_127</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;tx_128_255_oct&quot;</span><span class="p">,</span> <span class="n">GEN_STAT</span><span class="p">(</span><span class="n">mib</span><span class="p">.</span><span class="n">tx_128_255</span><span class="p">),</span> <span class="n">ETH_MIB_TX_128_255</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;tx_256_511_oct&quot;</span><span class="p">,</span> <span class="n">GEN_STAT</span><span class="p">(</span><span class="n">mib</span><span class="p">.</span><span class="n">tx_256_511</span><span class="p">),</span> <span class="n">ETH_MIB_TX_256_511</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;tx_512_1023_oct&quot;</span><span class="p">,</span> <span class="n">GEN_STAT</span><span class="p">(</span><span class="n">mib</span><span class="p">.</span><span class="n">tx_512_1023</span><span class="p">),</span> <span class="n">ETH_MIB_TX_512_1023</span><span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;tx_1024_max_oct&quot;</span><span class="p">,</span> <span class="n">GEN_STAT</span><span class="p">(</span><span class="n">mib</span><span class="p">.</span><span class="n">tx_1024_max</span><span class="p">),</span> <span class="n">ETH_MIB_TX_1024_MAX</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;tx_jabber&quot;</span><span class="p">,</span> <span class="n">GEN_STAT</span><span class="p">(</span><span class="n">mib</span><span class="p">.</span><span class="n">tx_jab</span><span class="p">),</span> <span class="n">ETH_MIB_TX_JAB</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;tx_oversize&quot;</span><span class="p">,</span> <span class="n">GEN_STAT</span><span class="p">(</span><span class="n">mib</span><span class="p">.</span><span class="n">tx_ovr</span><span class="p">),</span> <span class="n">ETH_MIB_TX_OVR</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;tx_fragment&quot;</span><span class="p">,</span> <span class="n">GEN_STAT</span><span class="p">(</span><span class="n">mib</span><span class="p">.</span><span class="n">tx_frag</span><span class="p">),</span> <span class="n">ETH_MIB_TX_FRAG</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;tx_underrun&quot;</span><span class="p">,</span> <span class="n">GEN_STAT</span><span class="p">(</span><span class="n">mib</span><span class="p">.</span><span class="n">tx_underrun</span><span class="p">),</span> <span class="n">ETH_MIB_TX_UNDERRUN</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;tx_collisions&quot;</span><span class="p">,</span> <span class="n">GEN_STAT</span><span class="p">(</span><span class="n">mib</span><span class="p">.</span><span class="n">tx_col</span><span class="p">),</span> <span class="n">ETH_MIB_TX_COL</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;tx_single_collision&quot;</span><span class="p">,</span> <span class="n">GEN_STAT</span><span class="p">(</span><span class="n">mib</span><span class="p">.</span><span class="n">tx_1_col</span><span class="p">),</span> <span class="n">ETH_MIB_TX_1_COL</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;tx_multiple_collision&quot;</span><span class="p">,</span> <span class="n">GEN_STAT</span><span class="p">(</span><span class="n">mib</span><span class="p">.</span><span class="n">tx_m_col</span><span class="p">),</span> <span class="n">ETH_MIB_TX_M_COL</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;tx_excess_collision&quot;</span><span class="p">,</span> <span class="n">GEN_STAT</span><span class="p">(</span><span class="n">mib</span><span class="p">.</span><span class="n">tx_ex_col</span><span class="p">),</span> <span class="n">ETH_MIB_TX_EX_COL</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;tx_late_collision&quot;</span><span class="p">,</span> <span class="n">GEN_STAT</span><span class="p">(</span><span class="n">mib</span><span class="p">.</span><span class="n">tx_late</span><span class="p">),</span> <span class="n">ETH_MIB_TX_LATE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;tx_deferred&quot;</span><span class="p">,</span> <span class="n">GEN_STAT</span><span class="p">(</span><span class="n">mib</span><span class="p">.</span><span class="n">tx_def</span><span class="p">),</span> <span class="n">ETH_MIB_TX_DEF</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;tx_carrier_sense&quot;</span><span class="p">,</span> <span class="n">GEN_STAT</span><span class="p">(</span><span class="n">mib</span><span class="p">.</span><span class="n">tx_crs</span><span class="p">),</span> <span class="n">ETH_MIB_TX_CRS</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;tx_pause&quot;</span><span class="p">,</span> <span class="n">GEN_STAT</span><span class="p">(</span><span class="n">mib</span><span class="p">.</span><span class="n">tx_pause</span><span class="p">),</span> <span class="n">ETH_MIB_TX_PAUSE</span> <span class="p">},</span>

<span class="p">};</span>

<span class="cp">#define BCM_ENET_STATS_LEN	\</span>
<span class="cp">	(sizeof(bcm_enet_gstrings_stats) / sizeof(struct bcm_enet_stats))</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">u32</span> <span class="n">unused_mib_regs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">ETH_MIB_TX_ALL_OCTETS</span><span class="p">,</span>
	<span class="n">ETH_MIB_TX_ALL_PKTS</span><span class="p">,</span>
	<span class="n">ETH_MIB_RX_ALL_OCTETS</span><span class="p">,</span>
	<span class="n">ETH_MIB_RX_ALL_PKTS</span><span class="p">,</span>
<span class="p">};</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">bcm_enet_get_drvinfo</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">ethtool_drvinfo</span> <span class="o">*</span><span class="n">drvinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">strncpy</span><span class="p">(</span><span class="n">drvinfo</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">,</span> <span class="n">bcm_enet_driver_name</span><span class="p">,</span> <span class="mi">32</span><span class="p">);</span>
	<span class="n">strncpy</span><span class="p">(</span><span class="n">drvinfo</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">,</span> <span class="n">bcm_enet_driver_version</span><span class="p">,</span> <span class="mi">32</span><span class="p">);</span>
	<span class="n">strncpy</span><span class="p">(</span><span class="n">drvinfo</span><span class="o">-&gt;</span><span class="n">fw_version</span><span class="p">,</span> <span class="s">&quot;N/A&quot;</span><span class="p">,</span> <span class="mi">32</span><span class="p">);</span>
	<span class="n">strncpy</span><span class="p">(</span><span class="n">drvinfo</span><span class="o">-&gt;</span><span class="n">bus_info</span><span class="p">,</span> <span class="s">&quot;bcm63xx&quot;</span><span class="p">,</span> <span class="mi">32</span><span class="p">);</span>
	<span class="n">drvinfo</span><span class="o">-&gt;</span><span class="n">n_stats</span> <span class="o">=</span> <span class="n">BCM_ENET_STATS_LEN</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bcm_enet_get_sset_count</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span>
					<span class="kt">int</span> <span class="n">string_set</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">string_set</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ETH_SS_STATS</span>:
		<span class="k">return</span> <span class="n">BCM_ENET_STATS_LEN</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bcm_enet_get_strings</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span>
				 <span class="n">u32</span> <span class="n">stringset</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">stringset</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ETH_SS_STATS</span>:
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">BCM_ENET_STATS_LEN</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">data</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="n">ETH_GSTRING_LEN</span><span class="p">,</span>
			       <span class="n">bcm_enet_gstrings_stats</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">stat_string</span><span class="p">,</span>
			       <span class="n">ETH_GSTRING_LEN</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">update_mib_counters</span><span class="p">(</span><span class="k">struct</span> <span class="n">bcm_enet_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">BCM_ENET_STATS_LEN</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">const</span> <span class="k">struct</span> <span class="n">bcm_enet_stats</span> <span class="o">*</span><span class="n">s</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>
		<span class="kt">char</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>

		<span class="n">s</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">bcm_enet_gstrings_stats</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">mib_reg</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">val</span> <span class="o">=</span> <span class="n">enet_readl</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">ENET_MIB_REG</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">mib_reg</span><span class="p">));</span>
		<span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">priv</span> <span class="o">+</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">stat_offset</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">sizeof_stat</span> <span class="o">==</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u64</span><span class="p">))</span>
			<span class="o">*</span><span class="p">(</span><span class="n">u64</span> <span class="o">*</span><span class="p">)</span><span class="n">p</span> <span class="o">+=</span> <span class="n">val</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="o">*</span><span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="n">p</span> <span class="o">+=</span> <span class="n">val</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* also empty unused mib counters to make sure mib counter</span>
<span class="cm">	 * overflow interrupt is cleared */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">unused_mib_regs</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">enet_readl</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">ENET_MIB_REG</span><span class="p">(</span><span class="n">unused_mib_regs</span><span class="p">[</span><span class="n">i</span><span class="p">]));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bcm_enet_update_mib_counters_defer</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">t</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bcm_enet_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">;</span>

	<span class="n">priv</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bcm_enet_priv</span><span class="p">,</span> <span class="n">mib_update_task</span><span class="p">);</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mib_update_lock</span><span class="p">);</span>
	<span class="n">update_mib_counters</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mib_update_lock</span><span class="p">);</span>

	<span class="cm">/* reenable mib interrupt */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">netif_running</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">net_dev</span><span class="p">))</span>
		<span class="n">enet_writel</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">ENET_IR_MIB</span><span class="p">,</span> <span class="n">ENET_IRMASK_REG</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bcm_enet_get_ethtool_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">ethtool_stats</span> <span class="o">*</span><span class="n">stats</span><span class="p">,</span>
				       <span class="n">u64</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bcm_enet_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mib_update_lock</span><span class="p">);</span>
	<span class="n">update_mib_counters</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">BCM_ENET_STATS_LEN</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">const</span> <span class="k">struct</span> <span class="n">bcm_enet_stats</span> <span class="o">*</span><span class="n">s</span><span class="p">;</span>
		<span class="kt">char</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>

		<span class="n">s</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">bcm_enet_gstrings_stats</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">mib_reg</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
			<span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">priv</span><span class="p">;</span>
		<span class="n">p</span> <span class="o">+=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">stat_offset</span><span class="p">;</span>
		<span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">sizeof_stat</span> <span class="o">==</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u64</span><span class="p">))</span> <span class="o">?</span>
			<span class="o">*</span><span class="p">(</span><span class="n">u64</span> <span class="o">*</span><span class="p">)</span><span class="n">p</span> <span class="o">:</span> <span class="o">*</span><span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="n">p</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mib_update_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bcm_enet_get_settings</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">ethtool_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bcm_enet_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">;</span>

	<span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">maxrxpkt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">maxtxpkt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">has_phy</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">phydev</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">phy_ethtool_gset</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">phydev</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">autoneg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ethtool_cmd_speed_set</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="p">((</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">force_speed_100</span><span class="p">)</span>
					    <span class="o">?</span> <span class="n">SPEED_100</span> <span class="o">:</span> <span class="n">SPEED_10</span><span class="p">));</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">duplex</span> <span class="o">=</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">force_duplex_full</span><span class="p">)</span> <span class="o">?</span>
			<span class="n">DUPLEX_FULL</span> <span class="o">:</span> <span class="n">DUPLEX_HALF</span><span class="p">;</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">supported</span> <span class="o">=</span> <span class="n">ADVERTISED_10baseT_Half</span>  <span class="o">|</span>
			<span class="n">ADVERTISED_10baseT_Full</span> <span class="o">|</span>
			<span class="n">ADVERTISED_100baseT_Half</span> <span class="o">|</span>
			<span class="n">ADVERTISED_100baseT_Full</span><span class="p">;</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">advertising</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">=</span> <span class="n">PORT_MII</span><span class="p">;</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">transceiver</span> <span class="o">=</span> <span class="n">XCVR_EXTERNAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bcm_enet_set_settings</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">ethtool_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bcm_enet_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">;</span>

	<span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">has_phy</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">phydev</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">phy_ethtool_sset</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">phydev</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">autoneg</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">speed</span> <span class="o">!=</span> <span class="n">SPEED_100</span> <span class="o">&amp;&amp;</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">speed</span> <span class="o">!=</span> <span class="n">SPEED_10</span><span class="p">)</span> <span class="o">||</span>
		    <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">!=</span> <span class="n">PORT_MII</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">force_speed_100</span> <span class="o">=</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">speed</span> <span class="o">==</span> <span class="n">SPEED_100</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">force_duplex_full</span> <span class="o">=</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">duplex</span> <span class="o">==</span> <span class="n">DUPLEX_FULL</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">netif_running</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
			<span class="n">bcm_enet_adjust_link</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bcm_enet_get_ringparam</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">ethtool_ringparam</span> <span class="o">*</span><span class="n">ering</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bcm_enet_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">;</span>

	<span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* rx/tx ring is actually only limited by memory */</span>
	<span class="n">ering</span><span class="o">-&gt;</span><span class="n">rx_max_pending</span> <span class="o">=</span> <span class="mi">8192</span><span class="p">;</span>
	<span class="n">ering</span><span class="o">-&gt;</span><span class="n">tx_max_pending</span> <span class="o">=</span> <span class="mi">8192</span><span class="p">;</span>
	<span class="n">ering</span><span class="o">-&gt;</span><span class="n">rx_pending</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_ring_size</span><span class="p">;</span>
	<span class="n">ering</span><span class="o">-&gt;</span><span class="n">tx_pending</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_ring_size</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bcm_enet_set_ringparam</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">ethtool_ringparam</span> <span class="o">*</span><span class="n">ering</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bcm_enet_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">was_running</span><span class="p">;</span>

	<span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">was_running</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">netif_running</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">bcm_enet_stop</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">was_running</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_ring_size</span> <span class="o">=</span> <span class="n">ering</span><span class="o">-&gt;</span><span class="n">rx_pending</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_ring_size</span> <span class="o">=</span> <span class="n">ering</span><span class="o">-&gt;</span><span class="n">tx_pending</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">was_running</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">bcm_enet_open</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="n">dev_close</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">bcm_enet_set_multicast_list</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bcm_enet_get_pauseparam</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">ethtool_pauseparam</span> <span class="o">*</span><span class="n">ecmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bcm_enet_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">;</span>

	<span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">ecmd</span><span class="o">-&gt;</span><span class="n">autoneg</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">pause_auto</span><span class="p">;</span>
	<span class="n">ecmd</span><span class="o">-&gt;</span><span class="n">rx_pause</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">pause_rx</span><span class="p">;</span>
	<span class="n">ecmd</span><span class="o">-&gt;</span><span class="n">tx_pause</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">pause_tx</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bcm_enet_set_pauseparam</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">ethtool_pauseparam</span> <span class="o">*</span><span class="n">ecmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bcm_enet_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">;</span>

	<span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">has_phy</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ecmd</span><span class="o">-&gt;</span><span class="n">autoneg</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ecmd</span><span class="o">-&gt;</span><span class="n">rx_pause</span> <span class="o">!=</span> <span class="n">ecmd</span><span class="o">-&gt;</span><span class="n">tx_pause</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* asymetric pause mode not supported,</span>
<span class="cm">			 * actually possible but integrated PHY has RO</span>
<span class="cm">			 * asym_pause bit */</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* no pause autoneg on direct mii connection */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ecmd</span><span class="o">-&gt;</span><span class="n">autoneg</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">pause_auto</span> <span class="o">=</span> <span class="n">ecmd</span><span class="o">-&gt;</span><span class="n">autoneg</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">pause_rx</span> <span class="o">=</span> <span class="n">ecmd</span><span class="o">-&gt;</span><span class="n">rx_pause</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">pause_tx</span> <span class="o">=</span> <span class="n">ecmd</span><span class="o">-&gt;</span><span class="n">tx_pause</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ethtool_ops</span> <span class="n">bcm_enet_ethtool_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">get_strings</span>		<span class="o">=</span> <span class="n">bcm_enet_get_strings</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_sset_count</span>		<span class="o">=</span> <span class="n">bcm_enet_get_sset_count</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_ethtool_stats</span>      <span class="o">=</span> <span class="n">bcm_enet_get_ethtool_stats</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_settings</span>		<span class="o">=</span> <span class="n">bcm_enet_get_settings</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_settings</span>		<span class="o">=</span> <span class="n">bcm_enet_set_settings</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_drvinfo</span>		<span class="o">=</span> <span class="n">bcm_enet_get_drvinfo</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_link</span>		<span class="o">=</span> <span class="n">ethtool_op_get_link</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_ringparam</span>		<span class="o">=</span> <span class="n">bcm_enet_get_ringparam</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_ringparam</span>		<span class="o">=</span> <span class="n">bcm_enet_set_ringparam</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_pauseparam</span>		<span class="o">=</span> <span class="n">bcm_enet_get_pauseparam</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_pauseparam</span>		<span class="o">=</span> <span class="n">bcm_enet_set_pauseparam</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bcm_enet_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ifreq</span> <span class="o">*</span><span class="n">rq</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bcm_enet_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">;</span>

	<span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">has_phy</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">phydev</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">phy_mii_ioctl</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">phydev</span><span class="p">,</span> <span class="n">rq</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">mii_if_info</span> <span class="n">mii</span><span class="p">;</span>

		<span class="n">mii</span><span class="p">.</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
		<span class="n">mii</span><span class="p">.</span><span class="n">mdio_read</span> <span class="o">=</span> <span class="n">bcm_enet_mdio_read_mii</span><span class="p">;</span>
		<span class="n">mii</span><span class="p">.</span><span class="n">mdio_write</span> <span class="o">=</span> <span class="n">bcm_enet_mdio_write_mii</span><span class="p">;</span>
		<span class="n">mii</span><span class="p">.</span><span class="n">phy_id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">mii</span><span class="p">.</span><span class="n">phy_id_mask</span> <span class="o">=</span> <span class="mh">0x3f</span><span class="p">;</span>
		<span class="n">mii</span><span class="p">.</span><span class="n">reg_num_mask</span> <span class="o">=</span> <span class="mh">0x1f</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">generic_mii_ioctl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mii</span><span class="p">,</span> <span class="n">if_mii</span><span class="p">(</span><span class="n">rq</span><span class="p">),</span> <span class="n">cmd</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * calculate actual hardware mtu</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">compute_hw_mtu</span><span class="p">(</span><span class="k">struct</span> <span class="n">bcm_enet_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mtu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">actual_mtu</span><span class="p">;</span>

	<span class="n">actual_mtu</span> <span class="o">=</span> <span class="n">mtu</span><span class="p">;</span>

	<span class="cm">/* add ethernet header + vlan tag size */</span>
	<span class="n">actual_mtu</span> <span class="o">+=</span> <span class="n">VLAN_ETH_HLEN</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">actual_mtu</span> <span class="o">&lt;</span> <span class="mi">64</span> <span class="o">||</span> <span class="n">actual_mtu</span> <span class="o">&gt;</span> <span class="n">BCMENET_MAX_MTU</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * setup maximum size before we get overflow mark in</span>
<span class="cm">	 * descriptor, note that this will not prevent reception of</span>
<span class="cm">	 * big frames, they will be split into multiple buffers</span>
<span class="cm">	 * anyway</span>
<span class="cm">	 */</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw_mtu</span> <span class="o">=</span> <span class="n">actual_mtu</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * align rx buffer size to dma burst len, account FCS since</span>
<span class="cm">	 * it&#39;s appended</span>
<span class="cm">	 */</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_skb_size</span> <span class="o">=</span> <span class="n">ALIGN</span><span class="p">(</span><span class="n">actual_mtu</span> <span class="o">+</span> <span class="n">ETH_FCS_LEN</span><span class="p">,</span>
				  <span class="n">BCMENET_DMA_MAXBURST</span> <span class="o">*</span> <span class="mi">4</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * adjust mtu, can&#39;t be called while device is running</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">bcm_enet_change_mtu</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">new_mtu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">netif_running</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">compute_hw_mtu</span><span class="p">(</span><span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">),</span> <span class="n">new_mtu</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">mtu</span> <span class="o">=</span> <span class="n">new_mtu</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * preinit hardware to allow mii operation while device is down</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">bcm_enet_hw_preinit</span><span class="p">(</span><span class="k">struct</span> <span class="n">bcm_enet_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">limit</span><span class="p">;</span>

	<span class="cm">/* make sure mac is disabled */</span>
	<span class="n">bcm_enet_disable_mac</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>

	<span class="cm">/* soft reset mac */</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">ENET_CTL_SRESET_MASK</span><span class="p">;</span>
	<span class="n">enet_writel</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">ENET_CTL_REG</span><span class="p">);</span>
	<span class="n">wmb</span><span class="p">();</span>

	<span class="n">limit</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">;</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">enet_readl</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">ENET_CTL_REG</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">ENET_CTL_SRESET_MASK</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">limit</span><span class="o">--</span><span class="p">);</span>

	<span class="cm">/* select correct mii interface */</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">enet_readl</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">ENET_CTL_REG</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">use_external_mii</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">ENET_CTL_EPHYSEL_MASK</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ENET_CTL_EPHYSEL_MASK</span><span class="p">;</span>
	<span class="n">enet_writel</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">ENET_CTL_REG</span><span class="p">);</span>

	<span class="cm">/* turn on mdc clock */</span>
	<span class="n">enet_writel</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="p">(</span><span class="mh">0x1f</span> <span class="o">&lt;&lt;</span> <span class="n">ENET_MIISC_MDCFREQDIV_SHIFT</span><span class="p">)</span> <span class="o">|</span>
		    <span class="n">ENET_MIISC_PREAMBLEEN_MASK</span><span class="p">,</span> <span class="n">ENET_MIISC_REG</span><span class="p">);</span>

	<span class="cm">/* set mib counters to self-clear when read */</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">enet_readl</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">ENET_MIBCTL_REG</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">|=</span> <span class="n">ENET_MIBCTL_RDCLEAR_MASK</span><span class="p">;</span>
	<span class="n">enet_writel</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">ENET_MIBCTL_REG</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">net_device_ops</span> <span class="n">bcm_enet_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">ndo_open</span>		<span class="o">=</span> <span class="n">bcm_enet_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_stop</span>		<span class="o">=</span> <span class="n">bcm_enet_stop</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_start_xmit</span>		<span class="o">=</span> <span class="n">bcm_enet_start_xmit</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_set_mac_address</span>	<span class="o">=</span> <span class="n">bcm_enet_set_mac_address</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_set_rx_mode</span>	<span class="o">=</span> <span class="n">bcm_enet_set_multicast_list</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_do_ioctl</span>		<span class="o">=</span> <span class="n">bcm_enet_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_change_mtu</span>		<span class="o">=</span> <span class="n">bcm_enet_change_mtu</span><span class="p">,</span>
<span class="cp">#ifdef CONFIG_NET_POLL_CONTROLLER</span>
	<span class="p">.</span><span class="n">ndo_poll_controller</span> <span class="o">=</span> <span class="n">bcm_enet_netpoll</span><span class="p">,</span>
<span class="cp">#endif</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * allocate netdevice, request register memory and register device.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">bcm_enet_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bcm_enet_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bcm63xx_enet_platform_data</span> <span class="o">*</span><span class="n">pd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">res_mem</span><span class="p">,</span> <span class="o">*</span><span class="n">res_irq</span><span class="p">,</span> <span class="o">*</span><span class="n">res_irq_rx</span><span class="p">,</span> <span class="o">*</span><span class="n">res_irq_tx</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mii_bus</span> <span class="o">*</span><span class="n">bus</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">clk_name</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">iomem_size</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* stop if shared driver failed, assume driver-&gt;probe will be</span>
<span class="cm">	 * called in the same order we register devices (correct ?) */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bcm_enet_shared_base</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">res_mem</span> <span class="o">=</span> <span class="n">platform_get_resource</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">res_irq</span> <span class="o">=</span> <span class="n">platform_get_resource</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">IORESOURCE_IRQ</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">res_irq_rx</span> <span class="o">=</span> <span class="n">platform_get_resource</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">IORESOURCE_IRQ</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">res_irq_tx</span> <span class="o">=</span> <span class="n">platform_get_resource</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">IORESOURCE_IRQ</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">res_mem</span> <span class="o">||</span> <span class="o">!</span><span class="n">res_irq</span> <span class="o">||</span> <span class="o">!</span><span class="n">res_irq_rx</span> <span class="o">||</span> <span class="o">!</span><span class="n">res_irq_tx</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dev</span> <span class="o">=</span> <span class="n">alloc_etherdev</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">priv</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">compute_hw_mtu</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">mtu</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">iomem_size</span> <span class="o">=</span> <span class="n">resource_size</span><span class="p">(</span><span class="n">res_mem</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">request_mem_region</span><span class="p">(</span><span class="n">res_mem</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="n">iomem_size</span><span class="p">,</span> <span class="s">&quot;bcm63xx_enet&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">res_mem</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="n">iomem_size</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_release_mem</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">res_irq</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">irq_rx</span> <span class="o">=</span> <span class="n">res_irq_rx</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">irq_tx</span> <span class="o">=</span> <span class="n">res_irq_tx</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">mac_id</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">;</span>

	<span class="cm">/* get rx &amp; tx dma channel id for this mac */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mac_id</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_chan</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_chan</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">clk_name</span> <span class="o">=</span> <span class="s">&quot;enet0&quot;</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_chan</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_chan</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
		<span class="n">clk_name</span> <span class="o">=</span> <span class="s">&quot;enet1&quot;</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">mac_clk</span> <span class="o">=</span> <span class="n">clk_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">clk_name</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mac_clk</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mac_clk</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_unmap</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">clk_enable</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mac_clk</span><span class="p">);</span>

	<span class="cm">/* initialize default and fetch platform data */</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_ring_size</span> <span class="o">=</span> <span class="n">BCMENET_DEF_RX_DESC</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_ring_size</span> <span class="o">=</span> <span class="n">BCMENET_DEF_TX_DESC</span><span class="p">;</span>

	<span class="n">pd</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">platform_data</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pd</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">pd</span><span class="o">-&gt;</span><span class="n">mac_addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">has_phy</span> <span class="o">=</span> <span class="n">pd</span><span class="o">-&gt;</span><span class="n">has_phy</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">phy_id</span> <span class="o">=</span> <span class="n">pd</span><span class="o">-&gt;</span><span class="n">phy_id</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">has_phy_interrupt</span> <span class="o">=</span> <span class="n">pd</span><span class="o">-&gt;</span><span class="n">has_phy_interrupt</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">phy_interrupt</span> <span class="o">=</span> <span class="n">pd</span><span class="o">-&gt;</span><span class="n">phy_interrupt</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">use_external_mii</span> <span class="o">=</span> <span class="o">!</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">use_internal_phy</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">pause_auto</span> <span class="o">=</span> <span class="n">pd</span><span class="o">-&gt;</span><span class="n">pause_auto</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">pause_rx</span> <span class="o">=</span> <span class="n">pd</span><span class="o">-&gt;</span><span class="n">pause_rx</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">pause_tx</span> <span class="o">=</span> <span class="n">pd</span><span class="o">-&gt;</span><span class="n">pause_tx</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">force_duplex_full</span> <span class="o">=</span> <span class="n">pd</span><span class="o">-&gt;</span><span class="n">force_duplex_full</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">force_speed_100</span> <span class="o">=</span> <span class="n">pd</span><span class="o">-&gt;</span><span class="n">force_speed_100</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mac_id</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">has_phy</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">use_external_mii</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* using internal PHY, enable clock */</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">phy_clk</span> <span class="o">=</span> <span class="n">clk_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;ephy&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">phy_clk</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">phy_clk</span><span class="p">);</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">phy_clk</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out_put_clk_mac</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">clk_enable</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">phy_clk</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* do minimal hardware init to be able to probe mii bus */</span>
	<span class="n">bcm_enet_hw_preinit</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>

	<span class="cm">/* MII bus registration */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">has_phy</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">mii_bus</span> <span class="o">=</span> <span class="n">mdiobus_alloc</span><span class="p">();</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mii_bus</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out_uninit_hw</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">bus</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">mii_bus</span><span class="p">;</span>
		<span class="n">bus</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;bcm63xx_enet MII bus&quot;</span><span class="p">;</span>
		<span class="n">bus</span><span class="o">-&gt;</span><span class="n">parent</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
		<span class="n">bus</span><span class="o">-&gt;</span><span class="n">priv</span> <span class="o">=</span> <span class="n">priv</span><span class="p">;</span>
		<span class="n">bus</span><span class="o">-&gt;</span><span class="n">read</span> <span class="o">=</span> <span class="n">bcm_enet_mdio_read_phylib</span><span class="p">;</span>
		<span class="n">bus</span><span class="o">-&gt;</span><span class="n">write</span> <span class="o">=</span> <span class="n">bcm_enet_mdio_write_phylib</span><span class="p">;</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="s">&quot;%s-%d&quot;</span><span class="p">,</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">mac_id</span><span class="p">);</span>

		<span class="cm">/* only probe bus where we think the PHY is, because</span>
<span class="cm">		 * the mdio read operation return 0 instead of 0xffff</span>
<span class="cm">		 * if a slave is not present on hw */</span>
		<span class="n">bus</span><span class="o">-&gt;</span><span class="n">phy_mask</span> <span class="o">=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">phy_id</span><span class="p">);</span>

		<span class="n">bus</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="o">*</span> <span class="n">PHY_MAX_ADDR</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out_free_mdio</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">has_phy_interrupt</span><span class="p">)</span>
			<span class="n">bus</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">[</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">phy_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">phy_interrupt</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">bus</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">[</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">phy_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">PHY_POLL</span><span class="p">;</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">mdiobus_register</span><span class="p">(</span><span class="n">bus</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;unable to register mdio bus</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out_free_mdio</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>

		<span class="cm">/* run platform code to initialize PHY device */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">mii_config</span> <span class="o">&amp;&amp;</span>
		    <span class="n">pd</span><span class="o">-&gt;</span><span class="n">mii_config</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">bcm_enet_mdio_read_mii</span><span class="p">,</span>
				   <span class="n">bcm_enet_mdio_write_mii</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;unable to configure mdio bus</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out_uninit_hw</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_lock</span><span class="p">);</span>

	<span class="cm">/* init rx timeout (used for oom) */</span>
	<span class="n">init_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_timeout</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_timeout</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="n">bcm_enet_refill_rx_timer</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_timeout</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">dev</span><span class="p">;</span>

	<span class="cm">/* init the mib update lock&amp;work */</span>
	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mib_update_lock</span><span class="p">);</span>
	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mib_update_task</span><span class="p">,</span> <span class="n">bcm_enet_update_mib_counters_defer</span><span class="p">);</span>

	<span class="cm">/* zero mib counters */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ENET_MIB_REG_COUNT</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">enet_writel</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ENET_MIB_REG</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>

	<span class="cm">/* register netdevice */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">netdev_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">bcm_enet_ops</span><span class="p">;</span>
	<span class="n">netif_napi_add</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">,</span> <span class="n">bcm_enet_poll</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>

	<span class="n">SET_ETHTOOL_OPS</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bcm_enet_ethtool_ops</span><span class="p">);</span>
	<span class="n">SET_NETDEV_DEV</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">register_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_unregister_mdio</span><span class="p">;</span>

	<span class="n">netif_carrier_off</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">platform_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">pdev</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">net_dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">out_unregister_mdio:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mii_bus</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mdiobus_unregister</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mii_bus</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mii_bus</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
	<span class="p">}</span>

<span class="nl">out_free_mdio:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mii_bus</span><span class="p">)</span>
		<span class="n">mdiobus_free</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mii_bus</span><span class="p">);</span>

<span class="nl">out_uninit_hw:</span>
	<span class="cm">/* turn off mdc clock */</span>
	<span class="n">enet_writel</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ENET_MIISC_REG</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">phy_clk</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">clk_disable</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">phy_clk</span><span class="p">);</span>
		<span class="n">clk_put</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">phy_clk</span><span class="p">);</span>
	<span class="p">}</span>

<span class="nl">out_put_clk_mac:</span>
	<span class="n">clk_disable</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mac_clk</span><span class="p">);</span>
	<span class="n">clk_put</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mac_clk</span><span class="p">);</span>

<span class="nl">out_unmap:</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">);</span>

<span class="nl">out_release_mem:</span>
	<span class="n">release_mem_region</span><span class="p">(</span><span class="n">res_mem</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="n">iomem_size</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="n">free_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * exit func, stops hardware and unregisters netdevice</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__devexit</span> <span class="nf">bcm_enet_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bcm_enet_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">res</span><span class="p">;</span>

	<span class="cm">/* stop netdevice */</span>
	<span class="n">dev</span> <span class="o">=</span> <span class="n">platform_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">unregister_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* turn off mdc clock */</span>
	<span class="n">enet_writel</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ENET_MIISC_REG</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">has_phy</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mdiobus_unregister</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mii_bus</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mii_bus</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
		<span class="n">mdiobus_free</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mii_bus</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">bcm63xx_enet_platform_data</span> <span class="o">*</span><span class="n">pd</span><span class="p">;</span>

		<span class="n">pd</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">platform_data</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pd</span> <span class="o">&amp;&amp;</span> <span class="n">pd</span><span class="o">-&gt;</span><span class="n">mii_config</span><span class="p">)</span>
			<span class="n">pd</span><span class="o">-&gt;</span><span class="n">mii_config</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">bcm_enet_mdio_read_mii</span><span class="p">,</span>
				       <span class="n">bcm_enet_mdio_write_mii</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* release device resources */</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">);</span>
	<span class="n">res</span> <span class="o">=</span> <span class="n">platform_get_resource</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">release_mem_region</span><span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="n">resource_size</span><span class="p">(</span><span class="n">res</span><span class="p">));</span>

	<span class="cm">/* disable hw block clocks */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">phy_clk</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">clk_disable</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">phy_clk</span><span class="p">);</span>
		<span class="n">clk_put</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">phy_clk</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">clk_disable</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mac_clk</span><span class="p">);</span>
	<span class="n">clk_put</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mac_clk</span><span class="p">);</span>

	<span class="n">platform_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">free_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">platform_driver</span> <span class="n">bcm63xx_enet_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">probe</span>	<span class="o">=</span> <span class="n">bcm_enet_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>	<span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">bcm_enet_remove</span><span class="p">),</span>
	<span class="p">.</span><span class="n">driver</span>	<span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="s">&quot;bcm63xx_enet&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">owner</span>  <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * reserve &amp; remap memory space shared between all macs</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">bcm_enet_shared_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">res</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">iomem_size</span><span class="p">;</span>

	<span class="n">res</span> <span class="o">=</span> <span class="n">platform_get_resource</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">res</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">iomem_size</span> <span class="o">=</span> <span class="n">resource_size</span><span class="p">(</span><span class="n">res</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">request_mem_region</span><span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="n">iomem_size</span><span class="p">,</span> <span class="s">&quot;bcm63xx_enet_dma&quot;</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="n">bcm_enet_shared_base</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="n">iomem_size</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bcm_enet_shared_base</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">release_mem_region</span><span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="n">iomem_size</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devexit</span> <span class="nf">bcm_enet_shared_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">res</span><span class="p">;</span>

	<span class="n">iounmap</span><span class="p">(</span><span class="n">bcm_enet_shared_base</span><span class="p">);</span>
	<span class="n">res</span> <span class="o">=</span> <span class="n">platform_get_resource</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">release_mem_region</span><span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="n">resource_size</span><span class="p">(</span><span class="n">res</span><span class="p">));</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * this &quot;shared&quot; driver is needed because both macs share a single</span>
<span class="cm"> * address space</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">platform_driver</span> <span class="n">bcm63xx_enet_shared_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">probe</span>	<span class="o">=</span> <span class="n">bcm_enet_shared_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>	<span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">bcm_enet_shared_remove</span><span class="p">),</span>
	<span class="p">.</span><span class="n">driver</span>	<span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="s">&quot;bcm63xx_enet_shared&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">owner</span>  <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * entry point</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">bcm_enet_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">platform_driver_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bcm63xx_enet_shared_driver</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">platform_driver_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bcm63xx_enet_driver</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">platform_driver_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bcm63xx_enet_shared_driver</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">bcm_enet_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">platform_driver_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bcm63xx_enet_driver</span><span class="p">);</span>
	<span class="n">platform_driver_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bcm63xx_enet_shared_driver</span><span class="p">);</span>
<span class="p">}</span>


<span class="n">module_init</span><span class="p">(</span><span class="n">bcm_enet_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">bcm_enet_exit</span><span class="p">);</span>

<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;BCM63xx internal ethernet mac driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Maxime Bizon &lt;mbizon@freebox.fr&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
