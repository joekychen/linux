<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › ethernet › broadcom › cnic.h

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>cnic.h</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/* cnic.h: Broadcom CNIC core network driver.</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (c) 2006-2011 Broadcom Corporation</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License as published by</span>
<span class="cm"> * the Free Software Foundation.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>


<span class="cp">#ifndef CNIC_H</span>
<span class="cp">#define CNIC_H</span>

<span class="cp">#define HC_INDEX_ISCSI_EQ_CONS			6</span>

<span class="cp">#define HC_INDEX_FCOE_EQ_CONS			3</span>

<span class="cp">#define HC_SP_INDEX_ETH_ISCSI_CQ_CONS		5</span>
<span class="cp">#define HC_SP_INDEX_ETH_ISCSI_RX_CQ_CONS	1</span>

<span class="cp">#define KWQ_PAGE_CNT	4</span>
<span class="cp">#define KCQ_PAGE_CNT	16</span>

<span class="cp">#define KWQ_CID 		24</span>
<span class="cp">#define KCQ_CID 		25</span>

<span class="cm">/*</span>
<span class="cm"> *	krnlq_context definition</span>
<span class="cm"> */</span>
<span class="cp">#define L5_KRNLQ_FLAGS	0x00000000</span>
<span class="cp">#define L5_KRNLQ_SIZE	0x00000000</span>
<span class="cp">#define L5_KRNLQ_TYPE	0x00000000</span>
<span class="cp">#define KRNLQ_FLAGS_PG_SZ					(0xf&lt;&lt;0)</span>
<span class="cp">#define KRNLQ_FLAGS_PG_SZ_256					(0&lt;&lt;0)</span>
<span class="cp">#define KRNLQ_FLAGS_PG_SZ_512					(1&lt;&lt;0)</span>
<span class="cp">#define KRNLQ_FLAGS_PG_SZ_1K					(2&lt;&lt;0)</span>
<span class="cp">#define KRNLQ_FLAGS_PG_SZ_2K					(3&lt;&lt;0)</span>
<span class="cp">#define KRNLQ_FLAGS_PG_SZ_4K					(4&lt;&lt;0)</span>
<span class="cp">#define KRNLQ_FLAGS_PG_SZ_8K					(5&lt;&lt;0)</span>
<span class="cp">#define KRNLQ_FLAGS_PG_SZ_16K					(6&lt;&lt;0)</span>
<span class="cp">#define KRNLQ_FLAGS_PG_SZ_32K					(7&lt;&lt;0)</span>
<span class="cp">#define KRNLQ_FLAGS_PG_SZ_64K					(8&lt;&lt;0)</span>
<span class="cp">#define KRNLQ_FLAGS_PG_SZ_128K					(9&lt;&lt;0)</span>
<span class="cp">#define KRNLQ_FLAGS_PG_SZ_256K					(10&lt;&lt;0)</span>
<span class="cp">#define KRNLQ_FLAGS_PG_SZ_512K					(11&lt;&lt;0)</span>
<span class="cp">#define KRNLQ_FLAGS_PG_SZ_1M					(12&lt;&lt;0)</span>
<span class="cp">#define KRNLQ_FLAGS_PG_SZ_2M					(13&lt;&lt;0)</span>
<span class="cp">#define KRNLQ_FLAGS_QE_SELF_SEQ					(1&lt;&lt;15)</span>
<span class="cp">#define KRNLQ_SIZE_TYPE_SIZE	((((0x28 + 0x1f) &amp; ~0x1f) / 0x20) &lt;&lt; 16)</span>
<span class="cp">#define KRNLQ_TYPE_TYPE						(0xf&lt;&lt;28)</span>
<span class="cp">#define KRNLQ_TYPE_TYPE_EMPTY					(0&lt;&lt;28)</span>
<span class="cp">#define KRNLQ_TYPE_TYPE_KRNLQ					(6&lt;&lt;28)</span>

<span class="cp">#define L5_KRNLQ_HOST_QIDX		0x00000004</span>
<span class="cp">#define L5_KRNLQ_HOST_FW_QIDX		0x00000008</span>
<span class="cp">#define L5_KRNLQ_NX_QE_SELF_SEQ 	0x0000000c</span>
<span class="cp">#define L5_KRNLQ_QE_SELF_SEQ_MAX	0x0000000c</span>
<span class="cp">#define L5_KRNLQ_NX_QE_HADDR_HI 	0x00000010</span>
<span class="cp">#define L5_KRNLQ_NX_QE_HADDR_LO 	0x00000014</span>
<span class="cp">#define L5_KRNLQ_PGTBL_PGIDX		0x00000018</span>
<span class="cp">#define L5_KRNLQ_NX_PG_QIDX 		0x00000018</span>
<span class="cp">#define L5_KRNLQ_PGTBL_NPAGES		0x0000001c</span>
<span class="cp">#define L5_KRNLQ_QIDX_INCR		0x0000001c</span>
<span class="cp">#define L5_KRNLQ_PGTBL_HADDR_HI 	0x00000020</span>
<span class="cp">#define L5_KRNLQ_PGTBL_HADDR_LO 	0x00000024</span>

<span class="cp">#define BNX2_PG_CTX_MAP			0x1a0034</span>
<span class="cp">#define BNX2_ISCSI_CTX_MAP		0x1a0074</span>

<span class="cp">#define MAX_COMPLETED_KCQE	64</span>

<span class="cp">#define MAX_CNIC_L5_CONTEXT	256</span>

<span class="cp">#define MAX_CM_SK_TBL_SZ	MAX_CNIC_L5_CONTEXT</span>

<span class="cp">#define MAX_ISCSI_TBL_SZ	256</span>

<span class="cp">#define CNIC_LOCAL_PORT_MIN	60000</span>
<span class="cp">#define CNIC_LOCAL_PORT_MAX	61024</span>
<span class="cp">#define CNIC_LOCAL_PORT_RANGE	(CNIC_LOCAL_PORT_MAX - CNIC_LOCAL_PORT_MIN)</span>

<span class="cp">#define KWQE_CNT (BCM_PAGE_SIZE / sizeof(struct kwqe))</span>
<span class="cp">#define KCQE_CNT (BCM_PAGE_SIZE / sizeof(struct kcqe))</span>
<span class="cp">#define MAX_KWQE_CNT (KWQE_CNT - 1)</span>
<span class="cp">#define MAX_KCQE_CNT (KCQE_CNT - 1)</span>

<span class="cp">#define MAX_KWQ_IDX	((KWQ_PAGE_CNT * KWQE_CNT) - 1)</span>
<span class="cp">#define MAX_KCQ_IDX	((KCQ_PAGE_CNT * KCQE_CNT) - 1)</span>

<span class="cp">#define KWQ_PG(x) (((x) &amp; ~MAX_KWQE_CNT) &gt;&gt; (BCM_PAGE_BITS - 5))</span>
<span class="cp">#define KWQ_IDX(x) ((x) &amp; MAX_KWQE_CNT)</span>

<span class="cp">#define KCQ_PG(x) (((x) &amp; ~MAX_KCQE_CNT) &gt;&gt; (BCM_PAGE_BITS - 5))</span>
<span class="cp">#define KCQ_IDX(x) ((x) &amp; MAX_KCQE_CNT)</span>

<span class="cp">#define BNX2X_NEXT_KCQE(x) (((x) &amp; (MAX_KCQE_CNT - 1)) ==		\</span>
<span class="cp">		(MAX_KCQE_CNT - 1)) ?					\</span>
<span class="cp">		(x) + 2 : (x) + 1</span>

<span class="cp">#define BNX2X_KWQ_DATA_PG(cp, x) ((x) / (cp)-&gt;kwq_16_data_pp)</span>
<span class="cp">#define BNX2X_KWQ_DATA_IDX(cp, x) ((x) % (cp)-&gt;kwq_16_data_pp)</span>
<span class="cp">#define BNX2X_KWQ_DATA(cp, x)						\</span>
<span class="cp">	&amp;(cp)-&gt;kwq_16_data[BNX2X_KWQ_DATA_PG(cp, x)][BNX2X_KWQ_DATA_IDX(cp, x)]</span>

<span class="cp">#define DEF_IPID_START		0x8000</span>

<span class="cp">#define DEF_KA_TIMEOUT		10000</span>
<span class="cp">#define DEF_KA_INTERVAL		300000</span>
<span class="cp">#define DEF_KA_MAX_PROBE_COUNT	3</span>
<span class="cp">#define DEF_TOS			0</span>
<span class="cp">#define DEF_TTL			0xfe</span>
<span class="cp">#define DEF_SND_SEQ_SCALE	0</span>
<span class="cp">#define DEF_RCV_BUF		0xffff</span>
<span class="cp">#define DEF_SND_BUF		0xffff</span>
<span class="cp">#define DEF_SEED		0</span>
<span class="cp">#define DEF_MAX_RT_TIME		500</span>
<span class="cp">#define DEF_MAX_DA_COUNT	2</span>
<span class="cp">#define DEF_SWS_TIMER		1000</span>
<span class="cp">#define DEF_MAX_CWND		0xffff</span>

<span class="k">struct</span> <span class="n">cnic_ctx</span> <span class="p">{</span>
	<span class="n">u32</span>		<span class="n">cid</span><span class="p">;</span>
	<span class="kt">void</span>		<span class="o">*</span><span class="n">ctx</span><span class="p">;</span>
	<span class="n">dma_addr_t</span>	<span class="n">mapping</span><span class="p">;</span>
<span class="p">};</span>

<span class="cp">#define BNX2_MAX_CID		0x2000</span>

<span class="k">struct</span> <span class="n">cnic_dma</span> <span class="p">{</span>
	<span class="kt">int</span>		<span class="n">num_pages</span><span class="p">;</span>
	<span class="kt">void</span>		<span class="o">**</span><span class="n">pg_arr</span><span class="p">;</span>
	<span class="n">dma_addr_t</span>	<span class="o">*</span><span class="n">pg_map_arr</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">pgtbl_size</span><span class="p">;</span>
	<span class="n">u32</span>		<span class="o">*</span><span class="n">pgtbl</span><span class="p">;</span>
	<span class="n">dma_addr_t</span>	<span class="n">pgtbl_map</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">cnic_id_tbl</span> <span class="p">{</span>
	<span class="n">spinlock_t</span>	<span class="n">lock</span><span class="p">;</span>
	<span class="n">u32</span>		<span class="n">start</span><span class="p">;</span>
	<span class="n">u32</span>		<span class="n">max</span><span class="p">;</span>
	<span class="n">u32</span>		<span class="n">next</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>	<span class="o">*</span><span class="n">table</span><span class="p">;</span>
<span class="p">};</span>

<span class="cp">#define CNIC_KWQ16_DATA_SIZE	128</span>

<span class="k">struct</span> <span class="n">kwqe_16_data</span> <span class="p">{</span>
	<span class="n">u8</span>	<span class="n">data</span><span class="p">[</span><span class="n">CNIC_KWQ16_DATA_SIZE</span><span class="p">];</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">cnic_iscsi</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">cnic_dma</span>		<span class="n">task_array_info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cnic_dma</span>		<span class="n">r2tq_info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cnic_dma</span>		<span class="n">hq_info</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">cnic_context</span> <span class="p">{</span>
	<span class="n">u32</span>			<span class="n">cid</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">kwqe_16_data</span>	<span class="o">*</span><span class="n">kwqe_data</span><span class="p">;</span>
	<span class="n">dma_addr_t</span>		<span class="n">kwqe_data_mapping</span><span class="p">;</span>
	<span class="n">wait_queue_head_t</span>	<span class="n">waitq</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">wait_cond</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>		<span class="n">timestamp</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>		<span class="n">ctx_flags</span><span class="p">;</span>
<span class="cp">#define	CTX_FL_OFFLD_START	0</span>
<span class="cp">#define	CTX_FL_DELETE_WAIT	1</span>
<span class="cp">#define	CTX_FL_CID_ERROR	2</span>
	<span class="n">u8</span>			<span class="n">ulp_proto_id</span><span class="p">;</span>
	<span class="k">union</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">cnic_iscsi</span>	<span class="o">*</span><span class="n">iscsi</span><span class="p">;</span>
	<span class="p">}</span> <span class="n">proto</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">kcq_info</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">cnic_dma</span>	<span class="n">dma</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">kcqe</span>	<span class="o">**</span><span class="n">kcq</span><span class="p">;</span>

	<span class="n">u16</span>		<span class="o">*</span><span class="n">hw_prod_idx_ptr</span><span class="p">;</span>
	<span class="n">u16</span>		<span class="n">sw_prod_idx</span><span class="p">;</span>
	<span class="n">u16</span>		<span class="o">*</span><span class="n">status_idx_ptr</span><span class="p">;</span>
	<span class="n">u32</span>		<span class="n">io_addr</span><span class="p">;</span>

	<span class="n">u16</span>		<span class="p">(</span><span class="o">*</span><span class="n">next_idx</span><span class="p">)(</span><span class="n">u16</span><span class="p">);</span>
	<span class="n">u16</span>		<span class="p">(</span><span class="o">*</span><span class="n">hw_idx</span><span class="p">)(</span><span class="n">u16</span><span class="p">);</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">iro</span> <span class="p">{</span>
	<span class="n">u32</span> <span class="n">base</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">m1</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">m2</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">m3</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">size</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">cnic_uio_dev</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">uio_info</span>		<span class="n">cnic_uinfo</span><span class="p">;</span>
	<span class="n">u32</span>			<span class="n">uio_dev</span><span class="p">;</span>

	<span class="kt">int</span>			<span class="n">l2_ring_size</span><span class="p">;</span>
	<span class="kt">void</span>			<span class="o">*</span><span class="n">l2_ring</span><span class="p">;</span>
	<span class="n">dma_addr_t</span>		<span class="n">l2_ring_map</span><span class="p">;</span>

	<span class="kt">int</span>			<span class="n">l2_buf_size</span><span class="p">;</span>
	<span class="kt">void</span>			<span class="o">*</span><span class="n">l2_buf</span><span class="p">;</span>
	<span class="n">dma_addr_t</span>		<span class="n">l2_buf_map</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">cnic_dev</span>		<span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_dev</span>		<span class="o">*</span><span class="n">pdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span>	<span class="n">list</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">cnic_local</span> <span class="p">{</span>

	<span class="n">spinlock_t</span> <span class="n">cnic_ulp_lock</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">ulp_handle</span><span class="p">[</span><span class="n">MAX_CNIC_ULP_TYPE</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ulp_flags</span><span class="p">[</span><span class="n">MAX_CNIC_ULP_TYPE</span><span class="p">];</span>
<span class="cp">#define ULP_F_INIT	0</span>
<span class="cp">#define ULP_F_START	1</span>
<span class="cp">#define ULP_F_CALL_PENDING	2</span>
	<span class="k">struct</span> <span class="n">cnic_ulp_ops</span> <span class="n">__rcu</span> <span class="o">*</span><span class="n">ulp_ops</span><span class="p">[</span><span class="n">MAX_CNIC_ULP_TYPE</span><span class="p">];</span>

	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">cnic_local_flags</span><span class="p">;</span>
<span class="cp">#define	CNIC_LCL_FL_KWQ_INIT		0x0</span>
<span class="cp">#define	CNIC_LCL_FL_L2_WAIT		0x1</span>
<span class="cp">#define	CNIC_LCL_FL_RINGS_INITED	0x2</span>
<span class="cp">#define	CNIC_LCL_FL_STOP_ISCSI		0x4</span>

	<span class="k">struct</span> <span class="n">cnic_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">cnic_eth_dev</span> <span class="o">*</span><span class="n">ethdev</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">cnic_uio_dev</span> <span class="o">*</span><span class="n">udev</span><span class="p">;</span>

	<span class="kt">int</span>		<span class="n">l2_rx_ring_size</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">l2_single_buf_size</span><span class="p">;</span>

	<span class="n">u16</span>		<span class="o">*</span><span class="n">rx_cons_ptr</span><span class="p">;</span>
	<span class="n">u16</span>		<span class="o">*</span><span class="n">tx_cons_ptr</span><span class="p">;</span>
	<span class="n">u16</span>		<span class="n">rx_cons</span><span class="p">;</span>
	<span class="n">u16</span>		<span class="n">tx_cons</span><span class="p">;</span>

	<span class="k">const</span> <span class="k">struct</span> <span class="n">iro</span>	<span class="o">*</span><span class="n">iro_arr</span><span class="p">;</span>
<span class="cp">#define IRO (((struct cnic_local *) dev-&gt;cnic_priv)-&gt;iro_arr)</span>

	<span class="k">struct</span> <span class="n">cnic_dma</span>		<span class="n">kwq_info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">kwqe</span>		<span class="o">**</span><span class="n">kwq</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">cnic_dma</span>		<span class="n">kwq_16_data_info</span><span class="p">;</span>

	<span class="n">u16</span>		<span class="n">max_kwq_idx</span><span class="p">;</span>

	<span class="n">u16</span>		<span class="n">kwq_prod_idx</span><span class="p">;</span>
	<span class="n">u32</span>		<span class="n">kwq_io_addr</span><span class="p">;</span>

	<span class="n">u16</span>		<span class="o">*</span><span class="n">kwq_con_idx_ptr</span><span class="p">;</span>
	<span class="n">u16</span>		<span class="n">kwq_con_idx</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">kcq_info</span>	<span class="n">kcq1</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">kcq_info</span>	<span class="n">kcq2</span><span class="p">;</span>

	<span class="k">union</span> <span class="p">{</span>
		<span class="kt">void</span>				<span class="o">*</span><span class="n">gen</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">status_block_msix</span>	<span class="o">*</span><span class="n">bnx2</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">host_hc_status_block_e1x</span>	<span class="o">*</span><span class="n">bnx2x_e1x</span><span class="p">;</span>
		<span class="cm">/* index values - which counter to update */</span>
		<span class="cp">#define SM_RX_ID		0</span>
		<span class="cp">#define SM_TX_ID		1</span>
	<span class="p">}</span> <span class="n">status_blk</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">host_sp_status_block</span>	<span class="o">*</span><span class="n">bnx2x_def_status_blk</span><span class="p">;</span>

	<span class="n">u32</span>				<span class="n">status_blk_num</span><span class="p">;</span>
	<span class="n">u32</span>				<span class="n">bnx2x_igu_sb_id</span><span class="p">;</span>
	<span class="n">u32</span>				<span class="n">int_num</span><span class="p">;</span>
	<span class="n">u32</span>				<span class="n">last_status_idx</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tasklet_struct</span>		<span class="n">cnic_irq_task</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">kcqe</span>		<span class="o">*</span><span class="n">completed_kcq</span><span class="p">[</span><span class="n">MAX_COMPLETED_KCQE</span><span class="p">];</span>

	<span class="k">struct</span> <span class="n">cnic_sock</span>	<span class="o">*</span><span class="n">csk_tbl</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cnic_id_tbl</span>	<span class="n">csk_port_tbl</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">cnic_dma</span>		<span class="n">gbl_buf_info</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">cnic_iscsi</span>	<span class="o">*</span><span class="n">iscsi_tbl</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cnic_context</span>	<span class="o">*</span><span class="n">ctx_tbl</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cnic_id_tbl</span>	<span class="n">cid_tbl</span><span class="p">;</span>
	<span class="n">atomic_t</span>		<span class="n">iscsi_conn</span><span class="p">;</span>
	<span class="n">u32</span>			<span class="n">iscsi_start_cid</span><span class="p">;</span>

	<span class="n">u32</span>			<span class="n">fcoe_init_cid</span><span class="p">;</span>
	<span class="n">u32</span>			<span class="n">fcoe_start_cid</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cnic_id_tbl</span>	<span class="n">fcoe_cid_tbl</span><span class="p">;</span>

	<span class="n">u32</span>			<span class="n">max_cid_space</span><span class="p">;</span>

	<span class="cm">/* per connection parameters */</span>
	<span class="kt">int</span>			<span class="n">num_iscsi_tasks</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">num_ccells</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">task_array_size</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">r2tq_size</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">hq_size</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">num_cqs</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">delayed_work</span>	<span class="n">delete_task</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">cnic_ctx</span>		<span class="o">*</span><span class="n">ctx_arr</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">ctx_blks</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">ctx_blk_size</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>		<span class="n">ctx_align</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">cids_per_blk</span><span class="p">;</span>

	<span class="n">u32</span>			<span class="n">chip_id</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">func</span><span class="p">;</span>
	<span class="n">u32</span>			<span class="n">pfid</span><span class="p">;</span>
	<span class="n">u8</span>			<span class="n">port_mode</span><span class="p">;</span>
<span class="cp">#define CHIP_4_PORT_MODE	0</span>
<span class="cp">#define CHIP_2_PORT_MODE	1</span>
<span class="cp">#define CHIP_PORT_MODE_NONE	2</span>

	<span class="n">u32</span>			<span class="n">shmem_base</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">cnic_ops</span>		<span class="o">*</span><span class="n">cnic_ops</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="p">(</span><span class="o">*</span><span class="n">start_hw</span><span class="p">)(</span><span class="k">struct</span> <span class="n">cnic_dev</span> <span class="o">*</span><span class="p">);</span>
	<span class="kt">void</span>			<span class="p">(</span><span class="o">*</span><span class="n">stop_hw</span><span class="p">)(</span><span class="k">struct</span> <span class="n">cnic_dev</span> <span class="o">*</span><span class="p">);</span>
	<span class="kt">void</span>			<span class="p">(</span><span class="o">*</span><span class="n">setup_pgtbl</span><span class="p">)(</span><span class="k">struct</span> <span class="n">cnic_dev</span> <span class="o">*</span><span class="p">,</span>
					       <span class="k">struct</span> <span class="n">cnic_dma</span> <span class="o">*</span><span class="p">);</span>
	<span class="kt">int</span>			<span class="p">(</span><span class="o">*</span><span class="n">alloc_resc</span><span class="p">)(</span><span class="k">struct</span> <span class="n">cnic_dev</span> <span class="o">*</span><span class="p">);</span>
	<span class="kt">void</span>			<span class="p">(</span><span class="o">*</span><span class="n">free_resc</span><span class="p">)(</span><span class="k">struct</span> <span class="n">cnic_dev</span> <span class="o">*</span><span class="p">);</span>
	<span class="kt">int</span>			<span class="p">(</span><span class="o">*</span><span class="n">start_cm</span><span class="p">)(</span><span class="k">struct</span> <span class="n">cnic_dev</span> <span class="o">*</span><span class="p">);</span>
	<span class="kt">void</span>			<span class="p">(</span><span class="o">*</span><span class="n">stop_cm</span><span class="p">)(</span><span class="k">struct</span> <span class="n">cnic_dev</span> <span class="o">*</span><span class="p">);</span>
	<span class="kt">void</span>			<span class="p">(</span><span class="o">*</span><span class="n">enable_int</span><span class="p">)(</span><span class="k">struct</span> <span class="n">cnic_dev</span> <span class="o">*</span><span class="p">);</span>
	<span class="kt">void</span>			<span class="p">(</span><span class="o">*</span><span class="n">disable_int_sync</span><span class="p">)(</span><span class="k">struct</span> <span class="n">cnic_dev</span> <span class="o">*</span><span class="p">);</span>
	<span class="kt">void</span>			<span class="p">(</span><span class="o">*</span><span class="n">ack_int</span><span class="p">)(</span><span class="k">struct</span> <span class="n">cnic_dev</span> <span class="o">*</span><span class="p">);</span>
	<span class="kt">void</span>			<span class="p">(</span><span class="o">*</span><span class="n">close_conn</span><span class="p">)(</span><span class="k">struct</span> <span class="n">cnic_sock</span> <span class="o">*</span><span class="p">,</span> <span class="n">u32</span> <span class="n">opcode</span><span class="p">);</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">bnx2x_bd_chain_next</span> <span class="p">{</span>
	<span class="n">u32</span>	<span class="n">addr_lo</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">addr_hi</span><span class="p">;</span>
	<span class="n">u8</span>	<span class="n">reserved</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
<span class="p">};</span>

<span class="cp">#define ISCSI_DEFAULT_MAX_OUTSTANDING_R2T 	(1)</span>

<span class="cp">#define ISCSI_RAMROD_CMD_ID_UPDATE_CONN		(ISCSI_KCQE_OPCODE_UPDATE_CONN)</span>
<span class="cp">#define ISCSI_RAMROD_CMD_ID_INIT		(ISCSI_KCQE_OPCODE_INIT)</span>

<span class="cp">#define CDU_REGION_NUMBER_XCM_AG 2</span>
<span class="cp">#define CDU_REGION_NUMBER_UCM_AG 4</span>

<span class="cp">#define CDU_VALID_DATA(_cid, _region, _type)	\</span>
<span class="cp">	(((_cid) &lt;&lt; 8) | (((_region)&amp;0xf)&lt;&lt;4) | (((_type)&amp;0xf)))</span>

<span class="cp">#define CDU_CRC8(_cid, _region, _type)	\</span>
<span class="cp">	(calc_crc8(CDU_VALID_DATA(_cid, _region, _type), 0xff))</span>

<span class="cp">#define CDU_RSRVD_VALUE_TYPE_A(_cid, _region, _type)	\</span>
<span class="cp">	(0x80 | ((CDU_CRC8(_cid, _region, _type)) &amp; 0x7f))</span>

<span class="cp">#define BNX2X_CONTEXT_MEM_SIZE		1024</span>
<span class="cp">#define BNX2X_FCOE_CID			16</span>

<span class="cp">#define BNX2X_ISCSI_START_CID		18</span>
<span class="cp">#define BNX2X_ISCSI_NUM_CONNECTIONS	128</span>
<span class="cp">#define BNX2X_ISCSI_TASK_CONTEXT_SIZE	128</span>
<span class="cp">#define BNX2X_ISCSI_MAX_PENDING_R2TS	4</span>
<span class="cp">#define BNX2X_ISCSI_R2TQE_SIZE		8</span>
<span class="cp">#define BNX2X_ISCSI_HQ_BD_SIZE		64</span>
<span class="cp">#define BNX2X_ISCSI_GLB_BUF_SIZE	64</span>
<span class="cp">#define BNX2X_ISCSI_PBL_NOT_CACHED	0xff</span>
<span class="cp">#define BNX2X_ISCSI_PDU_HEADER_NOT_CACHED	0xff</span>

<span class="cp">#define BNX2X_FCOE_NUM_CONNECTIONS	1024</span>

<span class="cp">#define BNX2X_FCOE_L5_CID_BASE		MAX_ISCSI_TBL_SZ</span>

<span class="cp">#define BNX2X_CHIP_NUM_57710		0x164e</span>
<span class="cp">#define BNX2X_CHIP_NUM_57711		0x164f</span>
<span class="cp">#define BNX2X_CHIP_NUM_57711E		0x1650</span>
<span class="cp">#define BNX2X_CHIP_NUM_57712		0x1662</span>
<span class="cp">#define BNX2X_CHIP_NUM_57712E		0x1663</span>
<span class="cp">#define BNX2X_CHIP_NUM_57713		0x1651</span>
<span class="cp">#define BNX2X_CHIP_NUM_57713E		0x1652</span>
<span class="cp">#define BNX2X_CHIP_NUM_57800		0x168a</span>
<span class="cp">#define BNX2X_CHIP_NUM_57810		0x168e</span>
<span class="cp">#define BNX2X_CHIP_NUM_57840		0x168d</span>

<span class="cp">#define BNX2X_CHIP_NUM(x)		(x &gt;&gt; 16)</span>
<span class="cp">#define BNX2X_CHIP_IS_57710(x)		\</span>
<span class="cp">	(BNX2X_CHIP_NUM(x) == BNX2X_CHIP_NUM_57710)</span>
<span class="cp">#define BNX2X_CHIP_IS_57711(x)		\</span>
<span class="cp">	(BNX2X_CHIP_NUM(x) == BNX2X_CHIP_NUM_57711)</span>
<span class="cp">#define BNX2X_CHIP_IS_57711E(x)		\</span>
<span class="cp">	(BNX2X_CHIP_NUM(x) == BNX2X_CHIP_NUM_57711E)</span>
<span class="cp">#define BNX2X_CHIP_IS_E1H(x)		\</span>
<span class="cp">	(BNX2X_CHIP_IS_57711(x) || BNX2X_CHIP_IS_57711E(x))</span>
<span class="cp">#define BNX2X_CHIP_IS_57712(x)		\</span>
<span class="cp">	(BNX2X_CHIP_NUM(x) == BNX2X_CHIP_NUM_57712)</span>
<span class="cp">#define BNX2X_CHIP_IS_57712E(x)		\</span>
<span class="cp">	(BNX2X_CHIP_NUM(x) == BNX2X_CHIP_NUM_57712E)</span>
<span class="cp">#define BNX2X_CHIP_IS_57713(x)		\</span>
<span class="cp">	(BNX2X_CHIP_NUM(x) == BNX2X_CHIP_NUM_57713)</span>
<span class="cp">#define BNX2X_CHIP_IS_57713E(x)		\</span>
<span class="cp">	(BNX2X_CHIP_NUM(x) == BNX2X_CHIP_NUM_57713E)</span>
<span class="cp">#define BNX2X_CHIP_IS_57800(x)		\</span>
<span class="cp">	(BNX2X_CHIP_NUM(x) == BNX2X_CHIP_NUM_57800)</span>
<span class="cp">#define BNX2X_CHIP_IS_57810(x)		\</span>
<span class="cp">	(BNX2X_CHIP_NUM(x) == BNX2X_CHIP_NUM_57810)</span>
<span class="cp">#define BNX2X_CHIP_IS_57840(x)		\</span>
<span class="cp">	(BNX2X_CHIP_NUM(x) == BNX2X_CHIP_NUM_57840)</span>
<span class="cp">#define BNX2X_CHIP_IS_E2(x)		\</span>
<span class="cp">	(BNX2X_CHIP_IS_57712(x) || BNX2X_CHIP_IS_57712E(x) || \</span>
<span class="cp">	 BNX2X_CHIP_IS_57713(x) || BNX2X_CHIP_IS_57713E(x))</span>
<span class="cp">#define BNX2X_CHIP_IS_E3(x)			\</span>
<span class="cp">	(BNX2X_CHIP_IS_57800(x) || BNX2X_CHIP_IS_57810(x) || \</span>
<span class="cp">	 BNX2X_CHIP_IS_57840(x))</span>
<span class="cp">#define BNX2X_CHIP_IS_E2_PLUS(x) (BNX2X_CHIP_IS_E2(x) || BNX2X_CHIP_IS_E3(x))</span>

<span class="cp">#define IS_E1H_OFFSET       		BNX2X_CHIP_IS_E1H(cp-&gt;chip_id)</span>

<span class="cp">#define BNX2X_RX_DESC_CNT		(BCM_PAGE_SIZE / sizeof(struct eth_rx_bd))</span>
<span class="cp">#define BNX2X_MAX_RX_DESC_CNT		(BNX2X_RX_DESC_CNT - 2)</span>
<span class="cp">#define BNX2X_RCQ_DESC_CNT		(BCM_PAGE_SIZE / sizeof(union eth_rx_cqe))</span>
<span class="cp">#define BNX2X_MAX_RCQ_DESC_CNT		(BNX2X_RCQ_DESC_CNT - 1)</span>

<span class="cp">#define BNX2X_NEXT_RCQE(x) (((x) &amp; BNX2X_MAX_RCQ_DESC_CNT) ==		\</span>
<span class="cp">		(BNX2X_MAX_RCQ_DESC_CNT - 1)) ?				\</span>
<span class="cp">		((x) + 2) : ((x) + 1)</span>

<span class="cp">#define BNX2X_DEF_SB_ID			HC_SP_SB_ID</span>

<span class="cp">#define BNX2X_SHMEM_MF_BLK_OFFSET	0x7e4</span>

<span class="cp">#define BNX2X_SHMEM_ADDR(base, field)	(base + \</span>
<span class="cp">					 offsetof(struct shmem_region, field))</span>

<span class="cp">#define BNX2X_SHMEM2_ADDR(base, field)	(base + \</span>
<span class="cp">					 offsetof(struct shmem2_region, field))</span>

<span class="cp">#define BNX2X_SHMEM2_HAS(base, field)				\</span>
<span class="cp">		((base) &amp;&amp;					\</span>
<span class="cp">		 (CNIC_RD(dev, BNX2X_SHMEM2_ADDR(base, size)) &gt;	\</span>
<span class="cp">		  offsetof(struct shmem2_region, field)))</span>

<span class="cp">#define BNX2X_MF_CFG_ADDR(base, field)				\</span>
<span class="cp">			((base) + offsetof(struct mf_cfg, field))</span>

<span class="cp">#ifndef ETH_MAX_RX_CLIENTS_E2</span>
<span class="cp">#define ETH_MAX_RX_CLIENTS_E2 		ETH_MAX_RX_CLIENTS_E1H</span>
<span class="cp">#endif</span>

<span class="cp">#define CNIC_PORT(cp)			((cp)-&gt;pfid &amp; 1)</span>
<span class="cp">#define CNIC_FUNC(cp)			((cp)-&gt;func)</span>
<span class="cp">#define CNIC_PATH(cp)			(!BNX2X_CHIP_IS_E2_PLUS(cp-&gt;chip_id) ? \</span>
<span class="cp">					 0 : (CNIC_FUNC(cp) &amp; 1))</span>
<span class="cp">#define CNIC_E1HVN(cp)			((cp)-&gt;pfid &gt;&gt; 1)</span>

<span class="cp">#define BNX2X_HW_CID(cp, x)		((CNIC_PORT(cp) &lt;&lt; 23) | \</span>
<span class="cp">					 (CNIC_E1HVN(cp) &lt;&lt; 17) | (x))</span>

<span class="cp">#define BNX2X_SW_CID(x)			(x &amp; 0x1ffff)</span>

<span class="cp">#define BNX2X_CL_QZONE_ID(cp, cli)					\</span>
<span class="cp">		(BNX2X_CHIP_IS_E2_PLUS(cp-&gt;chip_id) ? cli :		\</span>
<span class="cp">		 cli + (CNIC_PORT(cp) * ETH_MAX_RX_CLIENTS_E1H))</span>

<span class="cp">#ifndef MAX_STAT_COUNTER_ID</span>
<span class="cp">#define MAX_STAT_COUNTER_ID						\</span>
<span class="cp">	(BNX2X_CHIP_IS_E1H((cp)-&gt;chip_id) ? MAX_STAT_COUNTER_ID_E1H :	\</span>
<span class="cp">	 ((BNX2X_CHIP_IS_E2_PLUS((cp)-&gt;chip_id)) ? MAX_STAT_COUNTER_ID_E2 :\</span>
<span class="cp">	  MAX_STAT_COUNTER_ID_E1))</span>
<span class="cp">#endif</span>

<span class="cp">#define CNIC_RAMROD_TMO			(HZ / 4)</span>

<span class="cp">#endif</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
