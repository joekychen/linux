<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › ethernet › brocade › bna › bfa_ioc.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../../index.html"></a><h1>bfa_ioc.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Linux network driver for Brocade Converged Network Adapter.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify it</span>
<span class="cm"> * under the terms of the GNU General Public License (GPL) Version 2 as</span>
<span class="cm"> * published by the Free Software Foundation</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful, but</span>
<span class="cm"> * WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU</span>
<span class="cm"> * General Public License for more details.</span>
<span class="cm"> */</span>
<span class="cm">/*</span>
<span class="cm"> * Copyright (c) 2005-2010 Brocade Communications Systems, Inc.</span>
<span class="cm"> * All rights reserved</span>
<span class="cm"> * www.brocade.com</span>
<span class="cm"> */</span>

<span class="cp">#include &quot;bfa_ioc.h&quot;</span>
<span class="cp">#include &quot;bfi_reg.h&quot;</span>
<span class="cp">#include &quot;bfa_defs.h&quot;</span>

<span class="cm">/**</span>
<span class="cm"> * IOC local definitions</span>
<span class="cm"> */</span>

<span class="cm">/**</span>
<span class="cm"> * Asic specific macros : see bfa_hw_cb.c and bfa_hw_ct.c for details.</span>
<span class="cm"> */</span>

<span class="cp">#define bfa_ioc_firmware_lock(__ioc)			\</span>
<span class="cp">			((__ioc)-&gt;ioc_hwif-&gt;ioc_firmware_lock(__ioc))</span>
<span class="cp">#define bfa_ioc_firmware_unlock(__ioc)			\</span>
<span class="cp">			((__ioc)-&gt;ioc_hwif-&gt;ioc_firmware_unlock(__ioc))</span>
<span class="cp">#define bfa_ioc_reg_init(__ioc) ((__ioc)-&gt;ioc_hwif-&gt;ioc_reg_init(__ioc))</span>
<span class="cp">#define bfa_ioc_map_port(__ioc) ((__ioc)-&gt;ioc_hwif-&gt;ioc_map_port(__ioc))</span>
<span class="cp">#define bfa_ioc_notify_fail(__ioc)			\</span>
<span class="cp">			((__ioc)-&gt;ioc_hwif-&gt;ioc_notify_fail(__ioc))</span>
<span class="cp">#define bfa_ioc_sync_start(__ioc)               \</span>
<span class="cp">			((__ioc)-&gt;ioc_hwif-&gt;ioc_sync_start(__ioc))</span>
<span class="cp">#define bfa_ioc_sync_join(__ioc)			\</span>
<span class="cp">			((__ioc)-&gt;ioc_hwif-&gt;ioc_sync_join(__ioc))</span>
<span class="cp">#define bfa_ioc_sync_leave(__ioc)			\</span>
<span class="cp">			((__ioc)-&gt;ioc_hwif-&gt;ioc_sync_leave(__ioc))</span>
<span class="cp">#define bfa_ioc_sync_ack(__ioc)				\</span>
<span class="cp">			((__ioc)-&gt;ioc_hwif-&gt;ioc_sync_ack(__ioc))</span>
<span class="cp">#define bfa_ioc_sync_complete(__ioc)			\</span>
<span class="cp">			((__ioc)-&gt;ioc_hwif-&gt;ioc_sync_complete(__ioc))</span>

<span class="cp">#define bfa_ioc_mbox_cmd_pending(__ioc)		\</span>
<span class="cp">			(!list_empty(&amp;((__ioc)-&gt;mbox_mod.cmd_q)) || \</span>
<span class="cp">			readl((__ioc)-&gt;ioc_regs.hfn_mbox_cmd))</span>

<span class="k">static</span> <span class="n">bool</span> <span class="n">bfa_nw_auto_recover</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> * forward declarations</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">bfa_ioc_hw_sem_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_ioc</span> <span class="o">*</span><span class="n">ioc</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">bfa_ioc_hw_sem_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_ioc</span> <span class="o">*</span><span class="n">ioc</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">bfa_ioc_hw_sem_get_cancel</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_ioc</span> <span class="o">*</span><span class="n">ioc</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">bfa_ioc_hwinit</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_ioc</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="n">bool</span> <span class="n">force</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">bfa_ioc_poll_fwinit</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_ioc</span> <span class="o">*</span><span class="n">ioc</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">bfa_ioc_send_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_ioc</span> <span class="o">*</span><span class="n">ioc</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">bfa_ioc_send_disable</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_ioc</span> <span class="o">*</span><span class="n">ioc</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">bfa_ioc_send_getattr</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_ioc</span> <span class="o">*</span><span class="n">ioc</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">bfa_ioc_hb_monitor</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_ioc</span> <span class="o">*</span><span class="n">ioc</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">bfa_ioc_hb_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_ioc</span> <span class="o">*</span><span class="n">ioc</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">bfa_ioc_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_ioc</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="n">bool</span> <span class="n">force</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">bfa_ioc_mbox_poll</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_ioc</span> <span class="o">*</span><span class="n">ioc</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">bfa_ioc_mbox_flush</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_ioc</span> <span class="o">*</span><span class="n">ioc</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">bfa_ioc_recover</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_ioc</span> <span class="o">*</span><span class="n">ioc</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">bfa_ioc_event_notify</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_ioc</span> <span class="o">*</span><span class="p">,</span> <span class="k">enum</span> <span class="n">bfa_ioc_event</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">bfa_ioc_disable_comp</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_ioc</span> <span class="o">*</span><span class="n">ioc</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">bfa_ioc_lpu_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_ioc</span> <span class="o">*</span><span class="n">ioc</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">bfa_nw_ioc_debug_save_ftrc</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_ioc</span> <span class="o">*</span><span class="n">ioc</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">bfa_ioc_fail_notify</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_ioc</span> <span class="o">*</span><span class="n">ioc</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">bfa_ioc_pf_enabled</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_ioc</span> <span class="o">*</span><span class="n">ioc</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">bfa_ioc_pf_disabled</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_ioc</span> <span class="o">*</span><span class="n">ioc</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">bfa_ioc_pf_failed</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_ioc</span> <span class="o">*</span><span class="n">ioc</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">bfa_ioc_pf_hwfailed</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_ioc</span> <span class="o">*</span><span class="n">ioc</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">bfa_ioc_pf_fwmismatch</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_ioc</span> <span class="o">*</span><span class="n">ioc</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">bfa_ioc_boot</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_ioc</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="n">u32</span> <span class="n">boot_type</span><span class="p">,</span>
			 <span class="n">u32</span> <span class="n">boot_param</span><span class="p">);</span>
<span class="k">static</span> <span class="n">u32</span> <span class="n">bfa_ioc_smem_pgnum</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_ioc</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="n">u32</span> <span class="n">fmaddr</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">bfa_ioc_get_adapter_serial_num</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_ioc</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span>
						<span class="kt">char</span> <span class="o">*</span><span class="n">serial_num</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">bfa_ioc_get_adapter_fw_ver</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_ioc</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span>
						<span class="kt">char</span> <span class="o">*</span><span class="n">fw_ver</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">bfa_ioc_get_pci_chip_rev</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_ioc</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span>
						<span class="kt">char</span> <span class="o">*</span><span class="n">chip_rev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">bfa_ioc_get_adapter_optrom_ver</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_ioc</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span>
						<span class="kt">char</span> <span class="o">*</span><span class="n">optrom_ver</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">bfa_ioc_get_adapter_manufacturer</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_ioc</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span>
						<span class="kt">char</span> <span class="o">*</span><span class="n">manufacturer</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">bfa_ioc_get_adapter_model</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_ioc</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">model</span><span class="p">);</span>
<span class="k">static</span> <span class="n">u64</span> <span class="n">bfa_ioc_get_pwwn</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_ioc</span> <span class="o">*</span><span class="n">ioc</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * IOC state machine definitions/declarations</span>
<span class="cm"> */</span>
<span class="k">enum</span> <span class="n">ioc_event</span> <span class="p">{</span>
	<span class="n">IOC_E_RESET</span>		<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>	<span class="cm">/*!&lt; IOC reset request		*/</span>
	<span class="n">IOC_E_ENABLE</span>		<span class="o">=</span> <span class="mi">2</span><span class="p">,</span>	<span class="cm">/*!&lt; IOC enable request		*/</span>
	<span class="n">IOC_E_DISABLE</span>		<span class="o">=</span> <span class="mi">3</span><span class="p">,</span>	<span class="cm">/*!&lt; IOC disable request	*/</span>
	<span class="n">IOC_E_DETACH</span>		<span class="o">=</span> <span class="mi">4</span><span class="p">,</span>	<span class="cm">/*!&lt; driver detach cleanup	*/</span>
	<span class="n">IOC_E_ENABLED</span>		<span class="o">=</span> <span class="mi">5</span><span class="p">,</span>	<span class="cm">/*!&lt; f/w enabled		*/</span>
	<span class="n">IOC_E_FWRSP_GETATTR</span>	<span class="o">=</span> <span class="mi">6</span><span class="p">,</span>	<span class="cm">/*!&lt; IOC get attribute response	*/</span>
	<span class="n">IOC_E_DISABLED</span>		<span class="o">=</span> <span class="mi">7</span><span class="p">,</span>	<span class="cm">/*!&lt; f/w disabled		*/</span>
	<span class="n">IOC_E_PFFAILED</span>		<span class="o">=</span> <span class="mi">8</span><span class="p">,</span>	<span class="cm">/*!&lt; failure notice by iocpf sm	*/</span>
	<span class="n">IOC_E_HBFAIL</span>		<span class="o">=</span> <span class="mi">9</span><span class="p">,</span>	<span class="cm">/*!&lt; heartbeat failure		*/</span>
	<span class="n">IOC_E_HWERROR</span>		<span class="o">=</span> <span class="mi">10</span><span class="p">,</span>	<span class="cm">/*!&lt; hardware error interrupt	*/</span>
	<span class="n">IOC_E_TIMEOUT</span>		<span class="o">=</span> <span class="mi">11</span><span class="p">,</span>	<span class="cm">/*!&lt; timeout			*/</span>
	<span class="n">IOC_E_HWFAILED</span>		<span class="o">=</span> <span class="mi">12</span><span class="p">,</span>	<span class="cm">/*!&lt; PCI mapping failure notice	*/</span>
<span class="p">};</span>

<span class="n">bfa_fsm_state_decl</span><span class="p">(</span><span class="n">bfa_ioc</span><span class="p">,</span> <span class="n">uninit</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bfa_ioc</span><span class="p">,</span> <span class="k">enum</span> <span class="n">ioc_event</span><span class="p">);</span>
<span class="n">bfa_fsm_state_decl</span><span class="p">(</span><span class="n">bfa_ioc</span><span class="p">,</span> <span class="n">reset</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bfa_ioc</span><span class="p">,</span> <span class="k">enum</span> <span class="n">ioc_event</span><span class="p">);</span>
<span class="n">bfa_fsm_state_decl</span><span class="p">(</span><span class="n">bfa_ioc</span><span class="p">,</span> <span class="n">enabling</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bfa_ioc</span><span class="p">,</span> <span class="k">enum</span> <span class="n">ioc_event</span><span class="p">);</span>
<span class="n">bfa_fsm_state_decl</span><span class="p">(</span><span class="n">bfa_ioc</span><span class="p">,</span> <span class="n">getattr</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bfa_ioc</span><span class="p">,</span> <span class="k">enum</span> <span class="n">ioc_event</span><span class="p">);</span>
<span class="n">bfa_fsm_state_decl</span><span class="p">(</span><span class="n">bfa_ioc</span><span class="p">,</span> <span class="n">op</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bfa_ioc</span><span class="p">,</span> <span class="k">enum</span> <span class="n">ioc_event</span><span class="p">);</span>
<span class="n">bfa_fsm_state_decl</span><span class="p">(</span><span class="n">bfa_ioc</span><span class="p">,</span> <span class="n">fail_retry</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bfa_ioc</span><span class="p">,</span> <span class="k">enum</span> <span class="n">ioc_event</span><span class="p">);</span>
<span class="n">bfa_fsm_state_decl</span><span class="p">(</span><span class="n">bfa_ioc</span><span class="p">,</span> <span class="n">fail</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bfa_ioc</span><span class="p">,</span> <span class="k">enum</span> <span class="n">ioc_event</span><span class="p">);</span>
<span class="n">bfa_fsm_state_decl</span><span class="p">(</span><span class="n">bfa_ioc</span><span class="p">,</span> <span class="n">disabling</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bfa_ioc</span><span class="p">,</span> <span class="k">enum</span> <span class="n">ioc_event</span><span class="p">);</span>
<span class="n">bfa_fsm_state_decl</span><span class="p">(</span><span class="n">bfa_ioc</span><span class="p">,</span> <span class="n">disabled</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bfa_ioc</span><span class="p">,</span> <span class="k">enum</span> <span class="n">ioc_event</span><span class="p">);</span>
<span class="n">bfa_fsm_state_decl</span><span class="p">(</span><span class="n">bfa_ioc</span><span class="p">,</span> <span class="n">hwfail</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bfa_ioc</span><span class="p">,</span> <span class="k">enum</span> <span class="n">ioc_event</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">bfa_sm_table</span> <span class="n">ioc_sm_table</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span><span class="n">BFA_SM</span><span class="p">(</span><span class="n">bfa_ioc_sm_uninit</span><span class="p">),</span> <span class="n">BFA_IOC_UNINIT</span><span class="p">},</span>
	<span class="p">{</span><span class="n">BFA_SM</span><span class="p">(</span><span class="n">bfa_ioc_sm_reset</span><span class="p">),</span> <span class="n">BFA_IOC_RESET</span><span class="p">},</span>
	<span class="p">{</span><span class="n">BFA_SM</span><span class="p">(</span><span class="n">bfa_ioc_sm_enabling</span><span class="p">),</span> <span class="n">BFA_IOC_ENABLING</span><span class="p">},</span>
	<span class="p">{</span><span class="n">BFA_SM</span><span class="p">(</span><span class="n">bfa_ioc_sm_getattr</span><span class="p">),</span> <span class="n">BFA_IOC_GETATTR</span><span class="p">},</span>
	<span class="p">{</span><span class="n">BFA_SM</span><span class="p">(</span><span class="n">bfa_ioc_sm_op</span><span class="p">),</span> <span class="n">BFA_IOC_OPERATIONAL</span><span class="p">},</span>
	<span class="p">{</span><span class="n">BFA_SM</span><span class="p">(</span><span class="n">bfa_ioc_sm_fail_retry</span><span class="p">),</span> <span class="n">BFA_IOC_INITFAIL</span><span class="p">},</span>
	<span class="p">{</span><span class="n">BFA_SM</span><span class="p">(</span><span class="n">bfa_ioc_sm_fail</span><span class="p">),</span> <span class="n">BFA_IOC_FAIL</span><span class="p">},</span>
	<span class="p">{</span><span class="n">BFA_SM</span><span class="p">(</span><span class="n">bfa_ioc_sm_disabling</span><span class="p">),</span> <span class="n">BFA_IOC_DISABLING</span><span class="p">},</span>
	<span class="p">{</span><span class="n">BFA_SM</span><span class="p">(</span><span class="n">bfa_ioc_sm_disabled</span><span class="p">),</span> <span class="n">BFA_IOC_DISABLED</span><span class="p">},</span>
	<span class="p">{</span><span class="n">BFA_SM</span><span class="p">(</span><span class="n">bfa_ioc_sm_hwfail</span><span class="p">),</span> <span class="n">BFA_IOC_HWFAIL</span><span class="p">},</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Forward declareations for iocpf state machine</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">bfa_iocpf_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_ioc</span> <span class="o">*</span><span class="n">ioc</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">bfa_iocpf_disable</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_ioc</span> <span class="o">*</span><span class="n">ioc</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">bfa_iocpf_fail</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_ioc</span> <span class="o">*</span><span class="n">ioc</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">bfa_iocpf_initfail</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_ioc</span> <span class="o">*</span><span class="n">ioc</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">bfa_iocpf_getattrfail</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_ioc</span> <span class="o">*</span><span class="n">ioc</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">bfa_iocpf_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_ioc</span> <span class="o">*</span><span class="n">ioc</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * IOCPF state machine events</span>
<span class="cm"> */</span>
<span class="k">enum</span> <span class="n">iocpf_event</span> <span class="p">{</span>
	<span class="n">IOCPF_E_ENABLE</span>		<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>	<span class="cm">/*!&lt; IOCPF enable request	*/</span>
	<span class="n">IOCPF_E_DISABLE</span>		<span class="o">=</span> <span class="mi">2</span><span class="p">,</span>	<span class="cm">/*!&lt; IOCPF disable request	*/</span>
	<span class="n">IOCPF_E_STOP</span>		<span class="o">=</span> <span class="mi">3</span><span class="p">,</span>	<span class="cm">/*!&lt; stop on driver detach	*/</span>
	<span class="n">IOCPF_E_FWREADY</span>		<span class="o">=</span> <span class="mi">4</span><span class="p">,</span>	<span class="cm">/*!&lt; f/w initialization done	*/</span>
	<span class="n">IOCPF_E_FWRSP_ENABLE</span>	<span class="o">=</span> <span class="mi">5</span><span class="p">,</span>	<span class="cm">/*!&lt; enable f/w response	*/</span>
	<span class="n">IOCPF_E_FWRSP_DISABLE</span>	<span class="o">=</span> <span class="mi">6</span><span class="p">,</span>	<span class="cm">/*!&lt; disable f/w response	*/</span>
	<span class="n">IOCPF_E_FAIL</span>		<span class="o">=</span> <span class="mi">7</span><span class="p">,</span>	<span class="cm">/*!&lt; failure notice by ioc sm	*/</span>
	<span class="n">IOCPF_E_INITFAIL</span>	<span class="o">=</span> <span class="mi">8</span><span class="p">,</span>	<span class="cm">/*!&lt; init fail notice by ioc sm	*/</span>
	<span class="n">IOCPF_E_GETATTRFAIL</span>	<span class="o">=</span> <span class="mi">9</span><span class="p">,</span>	<span class="cm">/*!&lt; init fail notice by ioc sm	*/</span>
	<span class="n">IOCPF_E_SEMLOCKED</span>	<span class="o">=</span> <span class="mi">10</span><span class="p">,</span>   <span class="cm">/*!&lt; h/w semaphore is locked	*/</span>
	<span class="n">IOCPF_E_TIMEOUT</span>		<span class="o">=</span> <span class="mi">11</span><span class="p">,</span>   <span class="cm">/*!&lt; f/w response timeout	*/</span>
	<span class="n">IOCPF_E_SEM_ERROR</span>	<span class="o">=</span> <span class="mi">12</span><span class="p">,</span>   <span class="cm">/*!&lt; h/w sem mapping error	*/</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * IOCPF states</span>
<span class="cm"> */</span>
<span class="k">enum</span> <span class="n">bfa_iocpf_state</span> <span class="p">{</span>
	<span class="n">BFA_IOCPF_RESET</span>		<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>	<span class="cm">/*!&lt; IOC is in reset state */</span>
	<span class="n">BFA_IOCPF_SEMWAIT</span>	<span class="o">=</span> <span class="mi">2</span><span class="p">,</span>	<span class="cm">/*!&lt; Waiting for IOC h/w semaphore */</span>
	<span class="n">BFA_IOCPF_HWINIT</span>	<span class="o">=</span> <span class="mi">3</span><span class="p">,</span>	<span class="cm">/*!&lt; IOC h/w is being initialized */</span>
	<span class="n">BFA_IOCPF_READY</span>		<span class="o">=</span> <span class="mi">4</span><span class="p">,</span>	<span class="cm">/*!&lt; IOCPF is initialized */</span>
	<span class="n">BFA_IOCPF_INITFAIL</span>	<span class="o">=</span> <span class="mi">5</span><span class="p">,</span>	<span class="cm">/*!&lt; IOCPF failed */</span>
	<span class="n">BFA_IOCPF_FAIL</span>		<span class="o">=</span> <span class="mi">6</span><span class="p">,</span>	<span class="cm">/*!&lt; IOCPF failed */</span>
	<span class="n">BFA_IOCPF_DISABLING</span>	<span class="o">=</span> <span class="mi">7</span><span class="p">,</span>	<span class="cm">/*!&lt; IOCPF is being disabled */</span>
	<span class="n">BFA_IOCPF_DISABLED</span>	<span class="o">=</span> <span class="mi">8</span><span class="p">,</span>	<span class="cm">/*!&lt; IOCPF is disabled */</span>
	<span class="n">BFA_IOCPF_FWMISMATCH</span>	<span class="o">=</span> <span class="mi">9</span><span class="p">,</span>	<span class="cm">/*!&lt; IOC f/w different from drivers */</span>
<span class="p">};</span>

<span class="n">bfa_fsm_state_decl</span><span class="p">(</span><span class="n">bfa_iocpf</span><span class="p">,</span> <span class="n">reset</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bfa_iocpf</span><span class="p">,</span> <span class="k">enum</span> <span class="n">iocpf_event</span><span class="p">);</span>
<span class="n">bfa_fsm_state_decl</span><span class="p">(</span><span class="n">bfa_iocpf</span><span class="p">,</span> <span class="n">fwcheck</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bfa_iocpf</span><span class="p">,</span> <span class="k">enum</span> <span class="n">iocpf_event</span><span class="p">);</span>
<span class="n">bfa_fsm_state_decl</span><span class="p">(</span><span class="n">bfa_iocpf</span><span class="p">,</span> <span class="n">mismatch</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bfa_iocpf</span><span class="p">,</span> <span class="k">enum</span> <span class="n">iocpf_event</span><span class="p">);</span>
<span class="n">bfa_fsm_state_decl</span><span class="p">(</span><span class="n">bfa_iocpf</span><span class="p">,</span> <span class="n">semwait</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bfa_iocpf</span><span class="p">,</span> <span class="k">enum</span> <span class="n">iocpf_event</span><span class="p">);</span>
<span class="n">bfa_fsm_state_decl</span><span class="p">(</span><span class="n">bfa_iocpf</span><span class="p">,</span> <span class="n">hwinit</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bfa_iocpf</span><span class="p">,</span> <span class="k">enum</span> <span class="n">iocpf_event</span><span class="p">);</span>
<span class="n">bfa_fsm_state_decl</span><span class="p">(</span><span class="n">bfa_iocpf</span><span class="p">,</span> <span class="n">enabling</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bfa_iocpf</span><span class="p">,</span> <span class="k">enum</span> <span class="n">iocpf_event</span><span class="p">);</span>
<span class="n">bfa_fsm_state_decl</span><span class="p">(</span><span class="n">bfa_iocpf</span><span class="p">,</span> <span class="n">ready</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bfa_iocpf</span><span class="p">,</span> <span class="k">enum</span> <span class="n">iocpf_event</span><span class="p">);</span>
<span class="n">bfa_fsm_state_decl</span><span class="p">(</span><span class="n">bfa_iocpf</span><span class="p">,</span> <span class="n">initfail_sync</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bfa_iocpf</span><span class="p">,</span>
						<span class="k">enum</span> <span class="n">iocpf_event</span><span class="p">);</span>
<span class="n">bfa_fsm_state_decl</span><span class="p">(</span><span class="n">bfa_iocpf</span><span class="p">,</span> <span class="n">initfail</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bfa_iocpf</span><span class="p">,</span> <span class="k">enum</span> <span class="n">iocpf_event</span><span class="p">);</span>
<span class="n">bfa_fsm_state_decl</span><span class="p">(</span><span class="n">bfa_iocpf</span><span class="p">,</span> <span class="n">fail_sync</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bfa_iocpf</span><span class="p">,</span> <span class="k">enum</span> <span class="n">iocpf_event</span><span class="p">);</span>
<span class="n">bfa_fsm_state_decl</span><span class="p">(</span><span class="n">bfa_iocpf</span><span class="p">,</span> <span class="n">fail</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bfa_iocpf</span><span class="p">,</span> <span class="k">enum</span> <span class="n">iocpf_event</span><span class="p">);</span>
<span class="n">bfa_fsm_state_decl</span><span class="p">(</span><span class="n">bfa_iocpf</span><span class="p">,</span> <span class="n">disabling</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bfa_iocpf</span><span class="p">,</span> <span class="k">enum</span> <span class="n">iocpf_event</span><span class="p">);</span>
<span class="n">bfa_fsm_state_decl</span><span class="p">(</span><span class="n">bfa_iocpf</span><span class="p">,</span> <span class="n">disabling_sync</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bfa_iocpf</span><span class="p">,</span>
						<span class="k">enum</span> <span class="n">iocpf_event</span><span class="p">);</span>
<span class="n">bfa_fsm_state_decl</span><span class="p">(</span><span class="n">bfa_iocpf</span><span class="p">,</span> <span class="n">disabled</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bfa_iocpf</span><span class="p">,</span> <span class="k">enum</span> <span class="n">iocpf_event</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">bfa_sm_table</span> <span class="n">iocpf_sm_table</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span><span class="n">BFA_SM</span><span class="p">(</span><span class="n">bfa_iocpf_sm_reset</span><span class="p">),</span> <span class="n">BFA_IOCPF_RESET</span><span class="p">},</span>
	<span class="p">{</span><span class="n">BFA_SM</span><span class="p">(</span><span class="n">bfa_iocpf_sm_fwcheck</span><span class="p">),</span> <span class="n">BFA_IOCPF_FWMISMATCH</span><span class="p">},</span>
	<span class="p">{</span><span class="n">BFA_SM</span><span class="p">(</span><span class="n">bfa_iocpf_sm_mismatch</span><span class="p">),</span> <span class="n">BFA_IOCPF_FWMISMATCH</span><span class="p">},</span>
	<span class="p">{</span><span class="n">BFA_SM</span><span class="p">(</span><span class="n">bfa_iocpf_sm_semwait</span><span class="p">),</span> <span class="n">BFA_IOCPF_SEMWAIT</span><span class="p">},</span>
	<span class="p">{</span><span class="n">BFA_SM</span><span class="p">(</span><span class="n">bfa_iocpf_sm_hwinit</span><span class="p">),</span> <span class="n">BFA_IOCPF_HWINIT</span><span class="p">},</span>
	<span class="p">{</span><span class="n">BFA_SM</span><span class="p">(</span><span class="n">bfa_iocpf_sm_enabling</span><span class="p">),</span> <span class="n">BFA_IOCPF_HWINIT</span><span class="p">},</span>
	<span class="p">{</span><span class="n">BFA_SM</span><span class="p">(</span><span class="n">bfa_iocpf_sm_ready</span><span class="p">),</span> <span class="n">BFA_IOCPF_READY</span><span class="p">},</span>
	<span class="p">{</span><span class="n">BFA_SM</span><span class="p">(</span><span class="n">bfa_iocpf_sm_initfail_sync</span><span class="p">),</span> <span class="n">BFA_IOCPF_INITFAIL</span><span class="p">},</span>
	<span class="p">{</span><span class="n">BFA_SM</span><span class="p">(</span><span class="n">bfa_iocpf_sm_initfail</span><span class="p">),</span> <span class="n">BFA_IOCPF_INITFAIL</span><span class="p">},</span>
	<span class="p">{</span><span class="n">BFA_SM</span><span class="p">(</span><span class="n">bfa_iocpf_sm_fail_sync</span><span class="p">),</span> <span class="n">BFA_IOCPF_FAIL</span><span class="p">},</span>
	<span class="p">{</span><span class="n">BFA_SM</span><span class="p">(</span><span class="n">bfa_iocpf_sm_fail</span><span class="p">),</span> <span class="n">BFA_IOCPF_FAIL</span><span class="p">},</span>
	<span class="p">{</span><span class="n">BFA_SM</span><span class="p">(</span><span class="n">bfa_iocpf_sm_disabling</span><span class="p">),</span> <span class="n">BFA_IOCPF_DISABLING</span><span class="p">},</span>
	<span class="p">{</span><span class="n">BFA_SM</span><span class="p">(</span><span class="n">bfa_iocpf_sm_disabling_sync</span><span class="p">),</span> <span class="n">BFA_IOCPF_DISABLING</span><span class="p">},</span>
	<span class="p">{</span><span class="n">BFA_SM</span><span class="p">(</span><span class="n">bfa_iocpf_sm_disabled</span><span class="p">),</span> <span class="n">BFA_IOCPF_DISABLED</span><span class="p">},</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * IOC State Machine</span>
<span class="cm"> */</span>

<span class="cm">/**</span>
<span class="cm"> * Beginning state. IOC uninit state.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_ioc_sm_uninit_entry</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_ioc</span> <span class="o">*</span><span class="n">ioc</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * IOC is in uninit state.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_ioc_sm_uninit</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_ioc</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="k">enum</span> <span class="n">ioc_event</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IOC_E_RESET</span>:
		<span class="n">bfa_fsm_set_state</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">bfa_ioc_sm_reset</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">bfa_sm_fault</span><span class="p">(</span><span class="n">event</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Reset entry actions -- initialize state machine</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_ioc_sm_reset_entry</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_ioc</span> <span class="o">*</span><span class="n">ioc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfa_fsm_set_state</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">iocpf</span><span class="p">,</span> <span class="n">bfa_iocpf_sm_reset</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * IOC is in reset state.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_ioc_sm_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_ioc</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="k">enum</span> <span class="n">ioc_event</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IOC_E_ENABLE</span>:
		<span class="n">bfa_fsm_set_state</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">bfa_ioc_sm_enabling</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">IOC_E_DISABLE</span>:
		<span class="n">bfa_ioc_disable_comp</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">IOC_E_DETACH</span>:
		<span class="n">bfa_fsm_set_state</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">bfa_ioc_sm_uninit</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">bfa_sm_fault</span><span class="p">(</span><span class="n">event</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_ioc_sm_enabling_entry</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_ioc</span> <span class="o">*</span><span class="n">ioc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfa_iocpf_enable</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Host IOC function is being enabled, awaiting response from firmware.</span>
<span class="cm"> * Semaphore is acquired.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_ioc_sm_enabling</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_ioc</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="k">enum</span> <span class="n">ioc_event</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IOC_E_ENABLED</span>:
		<span class="n">bfa_fsm_set_state</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">bfa_ioc_sm_getattr</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">IOC_E_PFFAILED</span>:
		<span class="cm">/* !!! fall through !!! */</span>
	<span class="k">case</span> <span class="n">IOC_E_HWERROR</span>:
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">cbfn</span><span class="o">-&gt;</span><span class="n">enable_cbfn</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">BFA_STATUS_IOC_FAILURE</span><span class="p">);</span>
		<span class="n">bfa_fsm_set_state</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">bfa_ioc_sm_fail</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">event</span> <span class="o">!=</span> <span class="n">IOC_E_PFFAILED</span><span class="p">)</span>
			<span class="n">bfa_iocpf_initfail</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">IOC_E_HWFAILED</span>:
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">cbfn</span><span class="o">-&gt;</span><span class="n">enable_cbfn</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">BFA_STATUS_IOC_FAILURE</span><span class="p">);</span>
		<span class="n">bfa_fsm_set_state</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">bfa_ioc_sm_hwfail</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">IOC_E_DISABLE</span>:
		<span class="n">bfa_fsm_set_state</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">bfa_ioc_sm_disabling</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">IOC_E_DETACH</span>:
		<span class="n">bfa_fsm_set_state</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">bfa_ioc_sm_uninit</span><span class="p">);</span>
		<span class="n">bfa_iocpf_stop</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">IOC_E_ENABLE</span>:
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">bfa_sm_fault</span><span class="p">(</span><span class="n">event</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Semaphore should be acquired for version check.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_ioc_sm_getattr_entry</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_ioc</span> <span class="o">*</span><span class="n">ioc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioc_timer</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">+</span>
		<span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">BFA_IOC_TOV</span><span class="p">));</span>
	<span class="n">bfa_ioc_send_getattr</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * IOC configuration in progress. Timer is active.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_ioc_sm_getattr</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_ioc</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="k">enum</span> <span class="n">ioc_event</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IOC_E_FWRSP_GETATTR</span>:
		<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioc_timer</span><span class="p">);</span>
		<span class="n">bfa_fsm_set_state</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">bfa_ioc_sm_op</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">IOC_E_PFFAILED</span>:
	<span class="k">case</span> <span class="n">IOC_E_HWERROR</span>:
		<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioc_timer</span><span class="p">);</span>
		<span class="cm">/* fall through */</span>
	<span class="k">case</span> <span class="n">IOC_E_TIMEOUT</span>:
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">cbfn</span><span class="o">-&gt;</span><span class="n">enable_cbfn</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">BFA_STATUS_IOC_FAILURE</span><span class="p">);</span>
		<span class="n">bfa_fsm_set_state</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">bfa_ioc_sm_fail</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">event</span> <span class="o">!=</span> <span class="n">IOC_E_PFFAILED</span><span class="p">)</span>
			<span class="n">bfa_iocpf_getattrfail</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">IOC_E_DISABLE</span>:
		<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioc_timer</span><span class="p">);</span>
		<span class="n">bfa_fsm_set_state</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">bfa_ioc_sm_disabling</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">IOC_E_ENABLE</span>:
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">bfa_sm_fault</span><span class="p">(</span><span class="n">event</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_ioc_sm_op_entry</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_ioc</span> <span class="o">*</span><span class="n">ioc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">cbfn</span><span class="o">-&gt;</span><span class="n">enable_cbfn</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">BFA_STATUS_OK</span><span class="p">);</span>
	<span class="n">bfa_ioc_event_notify</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">BFA_IOC_E_ENABLED</span><span class="p">);</span>
	<span class="n">bfa_ioc_hb_monitor</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_ioc_sm_op</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_ioc</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="k">enum</span> <span class="n">ioc_event</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IOC_E_ENABLE</span>:
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">IOC_E_DISABLE</span>:
		<span class="n">bfa_ioc_hb_stop</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>
		<span class="n">bfa_fsm_set_state</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">bfa_ioc_sm_disabling</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">IOC_E_PFFAILED</span>:
	<span class="k">case</span> <span class="n">IOC_E_HWERROR</span>:
		<span class="n">bfa_ioc_hb_stop</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>
		<span class="cm">/* !!! fall through !!! */</span>
	<span class="k">case</span> <span class="n">IOC_E_HBFAIL</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">iocpf</span><span class="p">.</span><span class="n">auto_recover</span><span class="p">)</span>
			<span class="n">bfa_fsm_set_state</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">bfa_ioc_sm_fail_retry</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">bfa_fsm_set_state</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">bfa_ioc_sm_fail</span><span class="p">);</span>

		<span class="n">bfa_ioc_fail_notify</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">event</span> <span class="o">!=</span> <span class="n">IOC_E_PFFAILED</span><span class="p">)</span>
			<span class="n">bfa_iocpf_fail</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">bfa_sm_fault</span><span class="p">(</span><span class="n">event</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_ioc_sm_disabling_entry</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_ioc</span> <span class="o">*</span><span class="n">ioc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfa_iocpf_disable</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * IOC is being disabled</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_ioc_sm_disabling</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_ioc</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="k">enum</span> <span class="n">ioc_event</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IOC_E_DISABLED</span>:
		<span class="n">bfa_fsm_set_state</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">bfa_ioc_sm_disabled</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">IOC_E_HWERROR</span>:
		<span class="cm">/*</span>
<span class="cm">		 * No state change.  Will move to disabled state</span>
<span class="cm">		 * after iocpf sm completes failure processing and</span>
<span class="cm">		 * moves to disabled state.</span>
<span class="cm">		 */</span>
		<span class="n">bfa_iocpf_fail</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">IOC_E_HWFAILED</span>:
		<span class="n">bfa_fsm_set_state</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">bfa_ioc_sm_hwfail</span><span class="p">);</span>
		<span class="n">bfa_ioc_disable_comp</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">bfa_sm_fault</span><span class="p">(</span><span class="n">event</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * IOC disable completion entry.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_ioc_sm_disabled_entry</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_ioc</span> <span class="o">*</span><span class="n">ioc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfa_ioc_disable_comp</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_ioc_sm_disabled</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_ioc</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="k">enum</span> <span class="n">ioc_event</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IOC_E_ENABLE</span>:
		<span class="n">bfa_fsm_set_state</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">bfa_ioc_sm_enabling</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">IOC_E_DISABLE</span>:
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">cbfn</span><span class="o">-&gt;</span><span class="n">disable_cbfn</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">IOC_E_DETACH</span>:
		<span class="n">bfa_fsm_set_state</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">bfa_ioc_sm_uninit</span><span class="p">);</span>
		<span class="n">bfa_iocpf_stop</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">bfa_sm_fault</span><span class="p">(</span><span class="n">event</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_ioc_sm_fail_retry_entry</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_ioc</span> <span class="o">*</span><span class="n">ioc</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Hardware initialization retry.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_ioc_sm_fail_retry</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_ioc</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="k">enum</span> <span class="n">ioc_event</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IOC_E_ENABLED</span>:
		<span class="n">bfa_fsm_set_state</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">bfa_ioc_sm_getattr</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">IOC_E_PFFAILED</span>:
	<span class="k">case</span> <span class="n">IOC_E_HWERROR</span>:
		<span class="cm">/**</span>
<span class="cm">		 * Initialization retry failed.</span>
<span class="cm">		 */</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">cbfn</span><span class="o">-&gt;</span><span class="n">enable_cbfn</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">BFA_STATUS_IOC_FAILURE</span><span class="p">);</span>
		<span class="n">bfa_fsm_set_state</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">bfa_ioc_sm_fail</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">event</span> <span class="o">!=</span> <span class="n">IOC_E_PFFAILED</span><span class="p">)</span>
			<span class="n">bfa_iocpf_initfail</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">IOC_E_HWFAILED</span>:
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">cbfn</span><span class="o">-&gt;</span><span class="n">enable_cbfn</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">BFA_STATUS_IOC_FAILURE</span><span class="p">);</span>
		<span class="n">bfa_fsm_set_state</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">bfa_ioc_sm_hwfail</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">IOC_E_ENABLE</span>:
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">IOC_E_DISABLE</span>:
		<span class="n">bfa_fsm_set_state</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">bfa_ioc_sm_disabling</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">IOC_E_DETACH</span>:
		<span class="n">bfa_fsm_set_state</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">bfa_ioc_sm_uninit</span><span class="p">);</span>
		<span class="n">bfa_iocpf_stop</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">bfa_sm_fault</span><span class="p">(</span><span class="n">event</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_ioc_sm_fail_entry</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_ioc</span> <span class="o">*</span><span class="n">ioc</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * IOC failure.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_ioc_sm_fail</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_ioc</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="k">enum</span> <span class="n">ioc_event</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IOC_E_ENABLE</span>:
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">cbfn</span><span class="o">-&gt;</span><span class="n">enable_cbfn</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">BFA_STATUS_IOC_FAILURE</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">IOC_E_DISABLE</span>:
		<span class="n">bfa_fsm_set_state</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">bfa_ioc_sm_disabling</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">IOC_E_DETACH</span>:
		<span class="n">bfa_fsm_set_state</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">bfa_ioc_sm_uninit</span><span class="p">);</span>
		<span class="n">bfa_iocpf_stop</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">IOC_E_HWERROR</span>:
		<span class="cm">/* HB failure notification, ignore. */</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">bfa_sm_fault</span><span class="p">(</span><span class="n">event</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_ioc_sm_hwfail_entry</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_ioc</span> <span class="o">*</span><span class="n">ioc</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * IOC failure.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_ioc_sm_hwfail</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_ioc</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="k">enum</span> <span class="n">ioc_event</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>

	<span class="k">case</span> <span class="n">IOC_E_ENABLE</span>:
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">cbfn</span><span class="o">-&gt;</span><span class="n">enable_cbfn</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">BFA_STATUS_IOC_FAILURE</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">IOC_E_DISABLE</span>:
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">cbfn</span><span class="o">-&gt;</span><span class="n">disable_cbfn</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">IOC_E_DETACH</span>:
		<span class="n">bfa_fsm_set_state</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">bfa_ioc_sm_uninit</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">bfa_sm_fault</span><span class="p">(</span><span class="n">event</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * IOCPF State Machine</span>
<span class="cm"> */</span>

<span class="cm">/**</span>
<span class="cm"> * Reset entry actions -- initialize state machine</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_iocpf_sm_reset_entry</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_iocpf</span> <span class="o">*</span><span class="n">iocpf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">iocpf</span><span class="o">-&gt;</span><span class="n">fw_mismatch_notified</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">iocpf</span><span class="o">-&gt;</span><span class="n">auto_recover</span> <span class="o">=</span> <span class="n">bfa_nw_auto_recover</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Beginning state. IOC is in reset state.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_iocpf_sm_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_iocpf</span> <span class="o">*</span><span class="n">iocpf</span><span class="p">,</span> <span class="k">enum</span> <span class="n">iocpf_event</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IOCPF_E_ENABLE</span>:
		<span class="n">bfa_fsm_set_state</span><span class="p">(</span><span class="n">iocpf</span><span class="p">,</span> <span class="n">bfa_iocpf_sm_fwcheck</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">IOCPF_E_STOP</span>:
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">bfa_sm_fault</span><span class="p">(</span><span class="n">event</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Semaphore should be acquired for version check.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_iocpf_sm_fwcheck_entry</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_iocpf</span> <span class="o">*</span><span class="n">iocpf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfa_ioc_hw_sem_init</span><span class="p">(</span><span class="n">iocpf</span><span class="o">-&gt;</span><span class="n">ioc</span><span class="p">);</span>
	<span class="n">bfa_ioc_hw_sem_get</span><span class="p">(</span><span class="n">iocpf</span><span class="o">-&gt;</span><span class="n">ioc</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Awaiting h/w semaphore to continue with version check.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_iocpf_sm_fwcheck</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_iocpf</span> <span class="o">*</span><span class="n">iocpf</span><span class="p">,</span> <span class="k">enum</span> <span class="n">iocpf_event</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_ioc</span> <span class="o">*</span><span class="n">ioc</span> <span class="o">=</span> <span class="n">iocpf</span><span class="o">-&gt;</span><span class="n">ioc</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IOCPF_E_SEMLOCKED</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">bfa_ioc_firmware_lock</span><span class="p">(</span><span class="n">ioc</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">bfa_ioc_sync_start</span><span class="p">(</span><span class="n">ioc</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">bfa_ioc_sync_join</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>
				<span class="n">bfa_fsm_set_state</span><span class="p">(</span><span class="n">iocpf</span><span class="p">,</span> <span class="n">bfa_iocpf_sm_hwinit</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">bfa_ioc_firmware_unlock</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>
				<span class="n">bfa_nw_ioc_hw_sem_release</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>
				<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sem_timer</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">+</span>
					<span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">BFA_IOC_HWSEM_TOV</span><span class="p">));</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">bfa_nw_ioc_hw_sem_release</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>
			<span class="n">bfa_fsm_set_state</span><span class="p">(</span><span class="n">iocpf</span><span class="p">,</span> <span class="n">bfa_iocpf_sm_mismatch</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">IOCPF_E_SEM_ERROR</span>:
		<span class="n">bfa_fsm_set_state</span><span class="p">(</span><span class="n">iocpf</span><span class="p">,</span> <span class="n">bfa_iocpf_sm_fail</span><span class="p">);</span>
		<span class="n">bfa_ioc_pf_hwfailed</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">IOCPF_E_DISABLE</span>:
		<span class="n">bfa_ioc_hw_sem_get_cancel</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>
		<span class="n">bfa_fsm_set_state</span><span class="p">(</span><span class="n">iocpf</span><span class="p">,</span> <span class="n">bfa_iocpf_sm_reset</span><span class="p">);</span>
		<span class="n">bfa_ioc_pf_disabled</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">IOCPF_E_STOP</span>:
		<span class="n">bfa_ioc_hw_sem_get_cancel</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>
		<span class="n">bfa_fsm_set_state</span><span class="p">(</span><span class="n">iocpf</span><span class="p">,</span> <span class="n">bfa_iocpf_sm_reset</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">bfa_sm_fault</span><span class="p">(</span><span class="n">event</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Notify enable completion callback</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_iocpf_sm_mismatch_entry</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_iocpf</span> <span class="o">*</span><span class="n">iocpf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Call only the first time sm enters fwmismatch state. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">iocpf</span><span class="o">-&gt;</span><span class="n">fw_mismatch_notified</span><span class="p">)</span>
		<span class="n">bfa_ioc_pf_fwmismatch</span><span class="p">(</span><span class="n">iocpf</span><span class="o">-&gt;</span><span class="n">ioc</span><span class="p">);</span>

	<span class="n">iocpf</span><span class="o">-&gt;</span><span class="n">fw_mismatch_notified</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">iocpf</span><span class="o">-&gt;</span><span class="n">ioc</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">iocpf_timer</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">+</span>
		<span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">BFA_IOC_TOV</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Awaiting firmware version match.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_iocpf_sm_mismatch</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_iocpf</span> <span class="o">*</span><span class="n">iocpf</span><span class="p">,</span> <span class="k">enum</span> <span class="n">iocpf_event</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_ioc</span> <span class="o">*</span><span class="n">ioc</span> <span class="o">=</span> <span class="n">iocpf</span><span class="o">-&gt;</span><span class="n">ioc</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IOCPF_E_TIMEOUT</span>:
		<span class="n">bfa_fsm_set_state</span><span class="p">(</span><span class="n">iocpf</span><span class="p">,</span> <span class="n">bfa_iocpf_sm_fwcheck</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">IOCPF_E_DISABLE</span>:
		<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">iocpf_timer</span><span class="p">);</span>
		<span class="n">bfa_fsm_set_state</span><span class="p">(</span><span class="n">iocpf</span><span class="p">,</span> <span class="n">bfa_iocpf_sm_reset</span><span class="p">);</span>
		<span class="n">bfa_ioc_pf_disabled</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">IOCPF_E_STOP</span>:
		<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">iocpf_timer</span><span class="p">);</span>
		<span class="n">bfa_fsm_set_state</span><span class="p">(</span><span class="n">iocpf</span><span class="p">,</span> <span class="n">bfa_iocpf_sm_reset</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">bfa_sm_fault</span><span class="p">(</span><span class="n">event</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Request for semaphore.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_iocpf_sm_semwait_entry</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_iocpf</span> <span class="o">*</span><span class="n">iocpf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfa_ioc_hw_sem_get</span><span class="p">(</span><span class="n">iocpf</span><span class="o">-&gt;</span><span class="n">ioc</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Awaiting semaphore for h/w initialzation.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_iocpf_sm_semwait</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_iocpf</span> <span class="o">*</span><span class="n">iocpf</span><span class="p">,</span> <span class="k">enum</span> <span class="n">iocpf_event</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_ioc</span> <span class="o">*</span><span class="n">ioc</span> <span class="o">=</span> <span class="n">iocpf</span><span class="o">-&gt;</span><span class="n">ioc</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IOCPF_E_SEMLOCKED</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">bfa_ioc_sync_complete</span><span class="p">(</span><span class="n">ioc</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">bfa_ioc_sync_join</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>
			<span class="n">bfa_fsm_set_state</span><span class="p">(</span><span class="n">iocpf</span><span class="p">,</span> <span class="n">bfa_iocpf_sm_hwinit</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">bfa_nw_ioc_hw_sem_release</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>
			<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sem_timer</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">+</span>
				<span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">BFA_IOC_HWSEM_TOV</span><span class="p">));</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">IOCPF_E_SEM_ERROR</span>:
		<span class="n">bfa_fsm_set_state</span><span class="p">(</span><span class="n">iocpf</span><span class="p">,</span> <span class="n">bfa_iocpf_sm_fail</span><span class="p">);</span>
		<span class="n">bfa_ioc_pf_hwfailed</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">IOCPF_E_DISABLE</span>:
		<span class="n">bfa_ioc_hw_sem_get_cancel</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>
		<span class="n">bfa_fsm_set_state</span><span class="p">(</span><span class="n">iocpf</span><span class="p">,</span> <span class="n">bfa_iocpf_sm_disabling_sync</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">bfa_sm_fault</span><span class="p">(</span><span class="n">event</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_iocpf_sm_hwinit_entry</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_iocpf</span> <span class="o">*</span><span class="n">iocpf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">iocpf</span><span class="o">-&gt;</span><span class="n">poll_time</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">bfa_ioc_reset</span><span class="p">(</span><span class="n">iocpf</span><span class="o">-&gt;</span><span class="n">ioc</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Hardware is being initialized. Interrupts are enabled.</span>
<span class="cm"> * Holding hardware semaphore lock.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_iocpf_sm_hwinit</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_iocpf</span> <span class="o">*</span><span class="n">iocpf</span><span class="p">,</span> <span class="k">enum</span> <span class="n">iocpf_event</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_ioc</span> <span class="o">*</span><span class="n">ioc</span> <span class="o">=</span> <span class="n">iocpf</span><span class="o">-&gt;</span><span class="n">ioc</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IOCPF_E_FWREADY</span>:
		<span class="n">bfa_fsm_set_state</span><span class="p">(</span><span class="n">iocpf</span><span class="p">,</span> <span class="n">bfa_iocpf_sm_enabling</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">IOCPF_E_TIMEOUT</span>:
		<span class="n">bfa_nw_ioc_hw_sem_release</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>
			<span class="n">bfa_ioc_pf_failed</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>
		<span class="n">bfa_fsm_set_state</span><span class="p">(</span><span class="n">iocpf</span><span class="p">,</span> <span class="n">bfa_iocpf_sm_initfail_sync</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">IOCPF_E_DISABLE</span>:
		<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">iocpf_timer</span><span class="p">);</span>
		<span class="n">bfa_ioc_sync_leave</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>
		<span class="n">bfa_nw_ioc_hw_sem_release</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>
		<span class="n">bfa_fsm_set_state</span><span class="p">(</span><span class="n">iocpf</span><span class="p">,</span> <span class="n">bfa_iocpf_sm_disabled</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">bfa_sm_fault</span><span class="p">(</span><span class="n">event</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_iocpf_sm_enabling_entry</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_iocpf</span> <span class="o">*</span><span class="n">iocpf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">iocpf</span><span class="o">-&gt;</span><span class="n">ioc</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">iocpf_timer</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">+</span>
		<span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">BFA_IOC_TOV</span><span class="p">));</span>
	<span class="cm">/**</span>
<span class="cm">	 * Enable Interrupts before sending fw IOC ENABLE cmd.</span>
<span class="cm">	 */</span>
	<span class="n">iocpf</span><span class="o">-&gt;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">cbfn</span><span class="o">-&gt;</span><span class="n">reset_cbfn</span><span class="p">(</span><span class="n">iocpf</span><span class="o">-&gt;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">);</span>
	<span class="n">bfa_ioc_send_enable</span><span class="p">(</span><span class="n">iocpf</span><span class="o">-&gt;</span><span class="n">ioc</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Host IOC function is being enabled, awaiting response from firmware.</span>
<span class="cm"> * Semaphore is acquired.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_iocpf_sm_enabling</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_iocpf</span> <span class="o">*</span><span class="n">iocpf</span><span class="p">,</span> <span class="k">enum</span> <span class="n">iocpf_event</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_ioc</span> <span class="o">*</span><span class="n">ioc</span> <span class="o">=</span> <span class="n">iocpf</span><span class="o">-&gt;</span><span class="n">ioc</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IOCPF_E_FWRSP_ENABLE</span>:
		<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">iocpf_timer</span><span class="p">);</span>
		<span class="n">bfa_nw_ioc_hw_sem_release</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>
		<span class="n">bfa_fsm_set_state</span><span class="p">(</span><span class="n">iocpf</span><span class="p">,</span> <span class="n">bfa_iocpf_sm_ready</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">IOCPF_E_INITFAIL</span>:
		<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">iocpf_timer</span><span class="p">);</span>
		<span class="cm">/*</span>
<span class="cm">		 * !!! fall through !!!</span>
<span class="cm">		 */</span>
	<span class="k">case</span> <span class="n">IOCPF_E_TIMEOUT</span>:
		<span class="n">bfa_nw_ioc_hw_sem_release</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">event</span> <span class="o">==</span> <span class="n">IOCPF_E_TIMEOUT</span><span class="p">)</span>
			<span class="n">bfa_ioc_pf_failed</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>
		<span class="n">bfa_fsm_set_state</span><span class="p">(</span><span class="n">iocpf</span><span class="p">,</span> <span class="n">bfa_iocpf_sm_initfail_sync</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">IOCPF_E_DISABLE</span>:
		<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">iocpf_timer</span><span class="p">);</span>
		<span class="n">bfa_nw_ioc_hw_sem_release</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>
		<span class="n">bfa_fsm_set_state</span><span class="p">(</span><span class="n">iocpf</span><span class="p">,</span> <span class="n">bfa_iocpf_sm_disabling</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">bfa_sm_fault</span><span class="p">(</span><span class="n">event</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_iocpf_sm_ready_entry</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_iocpf</span> <span class="o">*</span><span class="n">iocpf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfa_ioc_pf_enabled</span><span class="p">(</span><span class="n">iocpf</span><span class="o">-&gt;</span><span class="n">ioc</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_iocpf_sm_ready</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_iocpf</span> <span class="o">*</span><span class="n">iocpf</span><span class="p">,</span> <span class="k">enum</span> <span class="n">iocpf_event</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IOCPF_E_DISABLE</span>:
		<span class="n">bfa_fsm_set_state</span><span class="p">(</span><span class="n">iocpf</span><span class="p">,</span> <span class="n">bfa_iocpf_sm_disabling</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">IOCPF_E_GETATTRFAIL</span>:
		<span class="n">bfa_fsm_set_state</span><span class="p">(</span><span class="n">iocpf</span><span class="p">,</span> <span class="n">bfa_iocpf_sm_initfail_sync</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">IOCPF_E_FAIL</span>:
		<span class="n">bfa_fsm_set_state</span><span class="p">(</span><span class="n">iocpf</span><span class="p">,</span> <span class="n">bfa_iocpf_sm_fail_sync</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">bfa_sm_fault</span><span class="p">(</span><span class="n">event</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_iocpf_sm_disabling_entry</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_iocpf</span> <span class="o">*</span><span class="n">iocpf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">iocpf</span><span class="o">-&gt;</span><span class="n">ioc</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">iocpf_timer</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">+</span>
		<span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">BFA_IOC_TOV</span><span class="p">));</span>
	<span class="n">bfa_ioc_send_disable</span><span class="p">(</span><span class="n">iocpf</span><span class="o">-&gt;</span><span class="n">ioc</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * IOC is being disabled</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_iocpf_sm_disabling</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_iocpf</span> <span class="o">*</span><span class="n">iocpf</span><span class="p">,</span> <span class="k">enum</span> <span class="n">iocpf_event</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_ioc</span> <span class="o">*</span><span class="n">ioc</span> <span class="o">=</span> <span class="n">iocpf</span><span class="o">-&gt;</span><span class="n">ioc</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IOCPF_E_FWRSP_DISABLE</span>:
		<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">iocpf_timer</span><span class="p">);</span>
		<span class="n">bfa_fsm_set_state</span><span class="p">(</span><span class="n">iocpf</span><span class="p">,</span> <span class="n">bfa_iocpf_sm_disabling_sync</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">IOCPF_E_FAIL</span>:
		<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">iocpf_timer</span><span class="p">);</span>
		<span class="cm">/*</span>
<span class="cm">		 * !!! fall through !!!</span>
<span class="cm">		 */</span>

	<span class="k">case</span> <span class="n">IOCPF_E_TIMEOUT</span>:
		<span class="n">writel</span><span class="p">(</span><span class="n">BFI_IOC_FAIL</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioc_regs</span><span class="p">.</span><span class="n">ioc_fwstate</span><span class="p">);</span>
		<span class="n">bfa_fsm_set_state</span><span class="p">(</span><span class="n">iocpf</span><span class="p">,</span> <span class="n">bfa_iocpf_sm_disabling_sync</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">IOCPF_E_FWRSP_ENABLE</span>:
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">bfa_sm_fault</span><span class="p">(</span><span class="n">event</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_iocpf_sm_disabling_sync_entry</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_iocpf</span> <span class="o">*</span><span class="n">iocpf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfa_ioc_hw_sem_get</span><span class="p">(</span><span class="n">iocpf</span><span class="o">-&gt;</span><span class="n">ioc</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * IOC hb ack request is being removed.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_iocpf_sm_disabling_sync</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_iocpf</span> <span class="o">*</span><span class="n">iocpf</span><span class="p">,</span> <span class="k">enum</span> <span class="n">iocpf_event</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_ioc</span> <span class="o">*</span><span class="n">ioc</span> <span class="o">=</span> <span class="n">iocpf</span><span class="o">-&gt;</span><span class="n">ioc</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IOCPF_E_SEMLOCKED</span>:
		<span class="n">bfa_ioc_sync_leave</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>
		<span class="n">bfa_nw_ioc_hw_sem_release</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>
		<span class="n">bfa_fsm_set_state</span><span class="p">(</span><span class="n">iocpf</span><span class="p">,</span> <span class="n">bfa_iocpf_sm_disabled</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">IOCPF_E_SEM_ERROR</span>:
		<span class="n">bfa_fsm_set_state</span><span class="p">(</span><span class="n">iocpf</span><span class="p">,</span> <span class="n">bfa_iocpf_sm_fail</span><span class="p">);</span>
		<span class="n">bfa_ioc_pf_hwfailed</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">IOCPF_E_FAIL</span>:
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">bfa_sm_fault</span><span class="p">(</span><span class="n">event</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * IOC disable completion entry.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_iocpf_sm_disabled_entry</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_iocpf</span> <span class="o">*</span><span class="n">iocpf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfa_ioc_mbox_flush</span><span class="p">(</span><span class="n">iocpf</span><span class="o">-&gt;</span><span class="n">ioc</span><span class="p">);</span>
	<span class="n">bfa_ioc_pf_disabled</span><span class="p">(</span><span class="n">iocpf</span><span class="o">-&gt;</span><span class="n">ioc</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_iocpf_sm_disabled</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_iocpf</span> <span class="o">*</span><span class="n">iocpf</span><span class="p">,</span> <span class="k">enum</span> <span class="n">iocpf_event</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_ioc</span> <span class="o">*</span><span class="n">ioc</span> <span class="o">=</span> <span class="n">iocpf</span><span class="o">-&gt;</span><span class="n">ioc</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IOCPF_E_ENABLE</span>:
		<span class="n">bfa_fsm_set_state</span><span class="p">(</span><span class="n">iocpf</span><span class="p">,</span> <span class="n">bfa_iocpf_sm_semwait</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">IOCPF_E_STOP</span>:
		<span class="n">bfa_ioc_firmware_unlock</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>
		<span class="n">bfa_fsm_set_state</span><span class="p">(</span><span class="n">iocpf</span><span class="p">,</span> <span class="n">bfa_iocpf_sm_reset</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">bfa_sm_fault</span><span class="p">(</span><span class="n">event</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_iocpf_sm_initfail_sync_entry</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_iocpf</span> <span class="o">*</span><span class="n">iocpf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfa_nw_ioc_debug_save_ftrc</span><span class="p">(</span><span class="n">iocpf</span><span class="o">-&gt;</span><span class="n">ioc</span><span class="p">);</span>
	<span class="n">bfa_ioc_hw_sem_get</span><span class="p">(</span><span class="n">iocpf</span><span class="o">-&gt;</span><span class="n">ioc</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Hardware initialization failed.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_iocpf_sm_initfail_sync</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_iocpf</span> <span class="o">*</span><span class="n">iocpf</span><span class="p">,</span> <span class="k">enum</span> <span class="n">iocpf_event</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_ioc</span> <span class="o">*</span><span class="n">ioc</span> <span class="o">=</span> <span class="n">iocpf</span><span class="o">-&gt;</span><span class="n">ioc</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IOCPF_E_SEMLOCKED</span>:
		<span class="n">bfa_ioc_notify_fail</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>
		<span class="n">bfa_ioc_sync_leave</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">BFI_IOC_FAIL</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioc_regs</span><span class="p">.</span><span class="n">ioc_fwstate</span><span class="p">);</span>
		<span class="n">bfa_nw_ioc_hw_sem_release</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>
		<span class="n">bfa_fsm_set_state</span><span class="p">(</span><span class="n">iocpf</span><span class="p">,</span> <span class="n">bfa_iocpf_sm_initfail</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">IOCPF_E_SEM_ERROR</span>:
		<span class="n">bfa_fsm_set_state</span><span class="p">(</span><span class="n">iocpf</span><span class="p">,</span> <span class="n">bfa_iocpf_sm_fail</span><span class="p">);</span>
		<span class="n">bfa_ioc_pf_hwfailed</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">IOCPF_E_DISABLE</span>:
		<span class="n">bfa_ioc_hw_sem_get_cancel</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>
		<span class="n">bfa_fsm_set_state</span><span class="p">(</span><span class="n">iocpf</span><span class="p">,</span> <span class="n">bfa_iocpf_sm_disabling_sync</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">IOCPF_E_STOP</span>:
		<span class="n">bfa_ioc_hw_sem_get_cancel</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>
		<span class="n">bfa_ioc_firmware_unlock</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>
		<span class="n">bfa_fsm_set_state</span><span class="p">(</span><span class="n">iocpf</span><span class="p">,</span> <span class="n">bfa_iocpf_sm_reset</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">IOCPF_E_FAIL</span>:
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">bfa_sm_fault</span><span class="p">(</span><span class="n">event</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_iocpf_sm_initfail_entry</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_iocpf</span> <span class="o">*</span><span class="n">iocpf</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Hardware initialization failed.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_iocpf_sm_initfail</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_iocpf</span> <span class="o">*</span><span class="n">iocpf</span><span class="p">,</span> <span class="k">enum</span> <span class="n">iocpf_event</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_ioc</span> <span class="o">*</span><span class="n">ioc</span> <span class="o">=</span> <span class="n">iocpf</span><span class="o">-&gt;</span><span class="n">ioc</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IOCPF_E_DISABLE</span>:
		<span class="n">bfa_fsm_set_state</span><span class="p">(</span><span class="n">iocpf</span><span class="p">,</span> <span class="n">bfa_iocpf_sm_disabled</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">IOCPF_E_STOP</span>:
		<span class="n">bfa_ioc_firmware_unlock</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>
		<span class="n">bfa_fsm_set_state</span><span class="p">(</span><span class="n">iocpf</span><span class="p">,</span> <span class="n">bfa_iocpf_sm_reset</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">bfa_sm_fault</span><span class="p">(</span><span class="n">event</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_iocpf_sm_fail_sync_entry</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_iocpf</span> <span class="o">*</span><span class="n">iocpf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/**</span>
<span class="cm">	 * Mark IOC as failed in hardware and stop firmware.</span>
<span class="cm">	 */</span>
	<span class="n">bfa_ioc_lpu_stop</span><span class="p">(</span><span class="n">iocpf</span><span class="o">-&gt;</span><span class="n">ioc</span><span class="p">);</span>

	<span class="cm">/**</span>
<span class="cm">	 * Flush any queued up mailbox requests.</span>
<span class="cm">	 */</span>
	<span class="n">bfa_ioc_mbox_flush</span><span class="p">(</span><span class="n">iocpf</span><span class="o">-&gt;</span><span class="n">ioc</span><span class="p">);</span>
	<span class="n">bfa_ioc_hw_sem_get</span><span class="p">(</span><span class="n">iocpf</span><span class="o">-&gt;</span><span class="n">ioc</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * IOC is in failed state.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_iocpf_sm_fail_sync</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_iocpf</span> <span class="o">*</span><span class="n">iocpf</span><span class="p">,</span> <span class="k">enum</span> <span class="n">iocpf_event</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_ioc</span> <span class="o">*</span><span class="n">ioc</span> <span class="o">=</span> <span class="n">iocpf</span><span class="o">-&gt;</span><span class="n">ioc</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IOCPF_E_SEMLOCKED</span>:
		<span class="n">bfa_ioc_sync_ack</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>
		<span class="n">bfa_ioc_notify_fail</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">iocpf</span><span class="o">-&gt;</span><span class="n">auto_recover</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">bfa_ioc_sync_leave</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>
			<span class="n">writel</span><span class="p">(</span><span class="n">BFI_IOC_FAIL</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioc_regs</span><span class="p">.</span><span class="n">ioc_fwstate</span><span class="p">);</span>
			<span class="n">bfa_nw_ioc_hw_sem_release</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>
			<span class="n">bfa_fsm_set_state</span><span class="p">(</span><span class="n">iocpf</span><span class="p">,</span> <span class="n">bfa_iocpf_sm_fail</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">bfa_ioc_sync_complete</span><span class="p">(</span><span class="n">ioc</span><span class="p">))</span>
				<span class="n">bfa_fsm_set_state</span><span class="p">(</span><span class="n">iocpf</span><span class="p">,</span> <span class="n">bfa_iocpf_sm_hwinit</span><span class="p">);</span>
			<span class="k">else</span> <span class="p">{</span>
				<span class="n">bfa_nw_ioc_hw_sem_release</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>
				<span class="n">bfa_fsm_set_state</span><span class="p">(</span><span class="n">iocpf</span><span class="p">,</span> <span class="n">bfa_iocpf_sm_semwait</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">IOCPF_E_SEM_ERROR</span>:
		<span class="n">bfa_fsm_set_state</span><span class="p">(</span><span class="n">iocpf</span><span class="p">,</span> <span class="n">bfa_iocpf_sm_fail</span><span class="p">);</span>
		<span class="n">bfa_ioc_pf_hwfailed</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">IOCPF_E_DISABLE</span>:
		<span class="n">bfa_ioc_hw_sem_get_cancel</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>
		<span class="n">bfa_fsm_set_state</span><span class="p">(</span><span class="n">iocpf</span><span class="p">,</span> <span class="n">bfa_iocpf_sm_disabling_sync</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">IOCPF_E_FAIL</span>:
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">bfa_sm_fault</span><span class="p">(</span><span class="n">event</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_iocpf_sm_fail_entry</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_iocpf</span> <span class="o">*</span><span class="n">iocpf</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * @brief</span>
<span class="cm"> * IOC is in failed state.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_iocpf_sm_fail</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_iocpf</span> <span class="o">*</span><span class="n">iocpf</span><span class="p">,</span> <span class="k">enum</span> <span class="n">iocpf_event</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IOCPF_E_DISABLE</span>:
		<span class="n">bfa_fsm_set_state</span><span class="p">(</span><span class="n">iocpf</span><span class="p">,</span> <span class="n">bfa_iocpf_sm_disabled</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">bfa_sm_fault</span><span class="p">(</span><span class="n">event</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * BFA IOC private functions</span>
<span class="cm"> */</span>

<span class="cm">/**</span>
<span class="cm"> * Notify common modules registered for notification.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_ioc_event_notify</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_ioc</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="k">enum</span> <span class="n">bfa_ioc_event</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_ioc_notify</span> <span class="o">*</span><span class="n">notify</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span>			<span class="o">*</span><span class="n">qe</span><span class="p">;</span>

	<span class="n">list_for_each</span><span class="p">(</span><span class="n">qe</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">notify_q</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">notify</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">bfa_ioc_notify</span> <span class="o">*</span><span class="p">)</span><span class="n">qe</span><span class="p">;</span>
		<span class="n">notify</span><span class="o">-&gt;</span><span class="n">cbfn</span><span class="p">(</span><span class="n">notify</span><span class="o">-&gt;</span><span class="n">cbarg</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_ioc_disable_comp</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_ioc</span> <span class="o">*</span><span class="n">ioc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">cbfn</span><span class="o">-&gt;</span><span class="n">disable_cbfn</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">);</span>
	<span class="n">bfa_ioc_event_notify</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">BFA_IOC_E_DISABLED</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">bool</span>
<span class="nf">bfa_nw_ioc_sem_get</span><span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">sem_reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">r32</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#define BFA_SEM_SPINCNT	3000</span>

	<span class="n">r32</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">sem_reg</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">((</span><span class="n">r32</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">&lt;</span> <span class="n">BFA_SEM_SPINCNT</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">cnt</span><span class="o">++</span><span class="p">;</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
		<span class="n">r32</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">sem_reg</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">r32</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>

	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">bfa_nw_ioc_sem_release</span><span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">sem_reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">readl</span><span class="p">(</span><span class="n">sem_reg</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">sem_reg</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Clear fwver hdr */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_ioc_fwver_clear</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_ioc</span> <span class="o">*</span><span class="n">ioc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">pgnum</span><span class="p">,</span> <span class="n">pgoff</span><span class="p">,</span> <span class="n">loff</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">pgnum</span> <span class="o">=</span> <span class="n">PSS_SMEM_PGNUM</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioc_regs</span><span class="p">.</span><span class="n">smem_pg0</span><span class="p">,</span> <span class="n">loff</span><span class="p">);</span>
	<span class="n">pgoff</span> <span class="o">=</span> <span class="n">PSS_SMEM_PGOFF</span><span class="p">(</span><span class="n">loff</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">pgnum</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioc_regs</span><span class="p">.</span><span class="n">host_page_num_fn</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfi_ioc_image_hdr</span><span class="p">)</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">));</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioc_regs</span><span class="p">.</span><span class="n">smem_page_start</span> <span class="o">+</span> <span class="n">loff</span><span class="p">);</span>
		<span class="n">loff</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_ioc_hw_sem_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_ioc</span> <span class="o">*</span><span class="n">ioc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfi_ioc_image_hdr</span> <span class="n">fwhdr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">fwstate</span><span class="p">,</span> <span class="n">r32</span><span class="p">;</span>

	<span class="cm">/* Spin on init semaphore to serialize. */</span>
	<span class="n">r32</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioc_regs</span><span class="p">.</span><span class="n">ioc_init_sem_reg</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">r32</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>
		<span class="n">r32</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioc_regs</span><span class="p">.</span><span class="n">ioc_init_sem_reg</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">fwstate</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioc_regs</span><span class="p">.</span><span class="n">ioc_fwstate</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fwstate</span> <span class="o">==</span> <span class="n">BFI_IOC_UNINIT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">writel</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioc_regs</span><span class="p">.</span><span class="n">ioc_init_sem_reg</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">bfa_nw_ioc_fwver_get</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fwhdr</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">swab32</span><span class="p">(</span><span class="n">fwhdr</span><span class="p">.</span><span class="n">exec</span><span class="p">)</span> <span class="o">==</span> <span class="n">BFI_FWBOOT_TYPE_NORMAL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">writel</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioc_regs</span><span class="p">.</span><span class="n">ioc_init_sem_reg</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">bfa_ioc_fwver_clear</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">BFI_IOC_UNINIT</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioc_regs</span><span class="p">.</span><span class="n">ioc_fwstate</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">BFI_IOC_UNINIT</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioc_regs</span><span class="p">.</span><span class="n">alt_ioc_fwstate</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Try to lock and then unlock the semaphore.</span>
<span class="cm">	 */</span>
	<span class="n">readl</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioc_regs</span><span class="p">.</span><span class="n">ioc_sem_reg</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioc_regs</span><span class="p">.</span><span class="n">ioc_sem_reg</span><span class="p">);</span>

	<span class="cm">/* Unlock init semaphore */</span>
	<span class="n">writel</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioc_regs</span><span class="p">.</span><span class="n">ioc_init_sem_reg</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_ioc_hw_sem_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_ioc</span> <span class="o">*</span><span class="n">ioc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span>	<span class="n">r32</span><span class="p">;</span>

	<span class="cm">/**</span>
<span class="cm">	 * First read to the semaphore register will return 0, subsequent reads</span>
<span class="cm">	 * will return 1. Semaphore is released by writing 1 to the register</span>
<span class="cm">	 */</span>
	<span class="n">r32</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioc_regs</span><span class="p">.</span><span class="n">ioc_sem_reg</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r32</span> <span class="o">==</span> <span class="o">~</span><span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bfa_fsm_send_event</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">iocpf</span><span class="p">,</span> <span class="n">IOCPF_E_SEM_ERROR</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">r32</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">bfa_fsm_send_event</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">iocpf</span><span class="p">,</span> <span class="n">IOCPF_E_SEMLOCKED</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sem_timer</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">+</span>
		<span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">BFA_IOC_HWSEM_TOV</span><span class="p">));</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">bfa_nw_ioc_hw_sem_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_ioc</span> <span class="o">*</span><span class="n">ioc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">writel</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioc_regs</span><span class="p">.</span><span class="n">ioc_sem_reg</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_ioc_hw_sem_get_cancel</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_ioc</span> <span class="o">*</span><span class="n">ioc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sem_timer</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * @brief</span>
<span class="cm"> * Initialize LPU local memory (aka secondary memory / SRAM)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_ioc_lmem_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_ioc</span> <span class="o">*</span><span class="n">ioc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span>	<span class="n">pss_ctl</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">i</span><span class="p">;</span>
<span class="cp">#define PSS_LMEM_INIT_TIME  10000</span>

	<span class="n">pss_ctl</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioc_regs</span><span class="p">.</span><span class="n">pss_ctl_reg</span><span class="p">);</span>
	<span class="n">pss_ctl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">__PSS_LMEM_RESET</span><span class="p">;</span>
	<span class="n">pss_ctl</span> <span class="o">|=</span> <span class="n">__PSS_LMEM_INIT_EN</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * i2c workaround 12.5khz clock</span>
<span class="cm">	 */</span>
	<span class="n">pss_ctl</span> <span class="o">|=</span> <span class="n">__PSS_I2C_CLK_DIV</span><span class="p">(</span><span class="mi">3UL</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">pss_ctl</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioc_regs</span><span class="p">.</span><span class="n">pss_ctl_reg</span><span class="p">);</span>

	<span class="cm">/**</span>
<span class="cm">	 * wait for memory initialization to be complete</span>
<span class="cm">	 */</span>
	<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">pss_ctl</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioc_regs</span><span class="p">.</span><span class="n">pss_ctl_reg</span><span class="p">);</span>
		<span class="n">i</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">pss_ctl</span> <span class="o">&amp;</span> <span class="n">__PSS_LMEM_INIT_DONE</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">PSS_LMEM_INIT_TIME</span><span class="p">));</span>

	<span class="cm">/**</span>
<span class="cm">	 * If memory initialization is not successful, IOC timeout will catch</span>
<span class="cm">	 * such failures.</span>
<span class="cm">	 */</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">pss_ctl</span> <span class="o">&amp;</span> <span class="n">__PSS_LMEM_INIT_DONE</span><span class="p">));</span>

	<span class="n">pss_ctl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">__PSS_LMEM_INIT_DONE</span> <span class="o">|</span> <span class="n">__PSS_LMEM_INIT_EN</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">pss_ctl</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioc_regs</span><span class="p">.</span><span class="n">pss_ctl_reg</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_ioc_lpu_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_ioc</span> <span class="o">*</span><span class="n">ioc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span>	<span class="n">pss_ctl</span><span class="p">;</span>

	<span class="cm">/**</span>
<span class="cm">	 * Take processor out of reset.</span>
<span class="cm">	 */</span>
	<span class="n">pss_ctl</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioc_regs</span><span class="p">.</span><span class="n">pss_ctl_reg</span><span class="p">);</span>
	<span class="n">pss_ctl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">__PSS_LPU0_RESET</span><span class="p">;</span>

	<span class="n">writel</span><span class="p">(</span><span class="n">pss_ctl</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioc_regs</span><span class="p">.</span><span class="n">pss_ctl_reg</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_ioc_lpu_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_ioc</span> <span class="o">*</span><span class="n">ioc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span>	<span class="n">pss_ctl</span><span class="p">;</span>

	<span class="cm">/**</span>
<span class="cm">	 * Put processors in reset.</span>
<span class="cm">	 */</span>
	<span class="n">pss_ctl</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioc_regs</span><span class="p">.</span><span class="n">pss_ctl_reg</span><span class="p">);</span>
	<span class="n">pss_ctl</span> <span class="o">|=</span> <span class="p">(</span><span class="n">__PSS_LPU0_RESET</span> <span class="o">|</span> <span class="n">__PSS_LPU1_RESET</span><span class="p">);</span>

	<span class="n">writel</span><span class="p">(</span><span class="n">pss_ctl</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioc_regs</span><span class="p">.</span><span class="n">pss_ctl_reg</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Get driver and firmware versions.</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">bfa_nw_ioc_fwver_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_ioc</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bfi_ioc_image_hdr</span> <span class="o">*</span><span class="n">fwhdr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span>	<span class="n">pgnum</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">loff</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">i</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="o">*</span><span class="n">fwsig</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span> <span class="n">fwhdr</span><span class="p">;</span>

	<span class="n">pgnum</span> <span class="o">=</span> <span class="n">bfa_ioc_smem_pgnum</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">loff</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">pgnum</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioc_regs</span><span class="p">.</span><span class="n">host_page_num_fn</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfi_ioc_image_hdr</span><span class="p">)</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">));</span>
	     <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fwsig</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span>
			<span class="n">swab32</span><span class="p">(</span><span class="n">readl</span><span class="p">((</span><span class="n">loff</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioc_regs</span><span class="p">.</span><span class="n">smem_page_start</span><span class="p">)));</span>
		<span class="n">loff</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Returns TRUE if same.</span>
<span class="cm"> */</span>
<span class="n">bool</span>
<span class="nf">bfa_nw_ioc_fwver_cmp</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_ioc</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bfi_ioc_image_hdr</span> <span class="o">*</span><span class="n">fwhdr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfi_ioc_image_hdr</span> <span class="o">*</span><span class="n">drv_fwhdr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">drv_fwhdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">bfi_ioc_image_hdr</span> <span class="o">*</span><span class="p">)</span>
		<span class="n">bfa_cb_image_get_chunk</span><span class="p">(</span><span class="n">bfa_ioc_asic_gen</span><span class="p">(</span><span class="n">ioc</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">BFI_IOC_MD5SUM_SZ</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fwhdr</span><span class="o">-&gt;</span><span class="n">md5sum</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="n">drv_fwhdr</span><span class="o">-&gt;</span><span class="n">md5sum</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
			<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Return true if current running version is valid. Firmware signature and</span>
<span class="cm"> * execution context (driver/bios) must match.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">bool</span>
<span class="nf">bfa_ioc_fwver_valid</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_ioc</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="n">u32</span> <span class="n">boot_env</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfi_ioc_image_hdr</span> <span class="n">fwhdr</span><span class="p">,</span> <span class="o">*</span><span class="n">drv_fwhdr</span><span class="p">;</span>

	<span class="n">bfa_nw_ioc_fwver_get</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fwhdr</span><span class="p">);</span>
	<span class="n">drv_fwhdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">bfi_ioc_image_hdr</span> <span class="o">*</span><span class="p">)</span>
		<span class="n">bfa_cb_image_get_chunk</span><span class="p">(</span><span class="n">bfa_ioc_asic_gen</span><span class="p">(</span><span class="n">ioc</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fwhdr</span><span class="p">.</span><span class="n">signature</span> <span class="o">!=</span> <span class="n">drv_fwhdr</span><span class="o">-&gt;</span><span class="n">signature</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">swab32</span><span class="p">(</span><span class="n">fwhdr</span><span class="p">.</span><span class="n">bootenv</span><span class="p">)</span> <span class="o">!=</span> <span class="n">boot_env</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">bfa_nw_ioc_fwver_cmp</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fwhdr</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Conditionally flush any pending message from firmware at start.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_ioc_msgflush</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_ioc</span> <span class="o">*</span><span class="n">ioc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span>	<span class="n">r32</span><span class="p">;</span>

	<span class="n">r32</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioc_regs</span><span class="p">.</span><span class="n">lpu_mbox_cmd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r32</span><span class="p">)</span>
		<span class="n">writel</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioc_regs</span><span class="p">.</span><span class="n">lpu_mbox_cmd</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * @img ioc_init_logic.jpg</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_ioc_hwinit</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_ioc</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="n">bool</span> <span class="n">force</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">enum</span> <span class="n">bfi_ioc_state</span> <span class="n">ioc_fwstate</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">fwvalid</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">boot_env</span><span class="p">;</span>

	<span class="n">ioc_fwstate</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioc_regs</span><span class="p">.</span><span class="n">ioc_fwstate</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">force</span><span class="p">)</span>
		<span class="n">ioc_fwstate</span> <span class="o">=</span> <span class="n">BFI_IOC_UNINIT</span><span class="p">;</span>

	<span class="n">boot_env</span> <span class="o">=</span> <span class="n">BFI_FWBOOT_ENV_OS</span><span class="p">;</span>

	<span class="cm">/**</span>
<span class="cm">	 * check if firmware is valid</span>
<span class="cm">	 */</span>
	<span class="n">fwvalid</span> <span class="o">=</span> <span class="p">(</span><span class="n">ioc_fwstate</span> <span class="o">==</span> <span class="n">BFI_IOC_UNINIT</span><span class="p">)</span> <span class="o">?</span>
		<span class="nb">false</span> <span class="o">:</span> <span class="n">bfa_ioc_fwver_valid</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">boot_env</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fwvalid</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bfa_ioc_boot</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">BFI_FWBOOT_TYPE_NORMAL</span><span class="p">,</span> <span class="n">boot_env</span><span class="p">);</span>
		<span class="n">bfa_ioc_poll_fwinit</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/**</span>
<span class="cm">	 * If hardware initialization is in progress (initialized by other IOC),</span>
<span class="cm">	 * just wait for an initialization completion interrupt.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ioc_fwstate</span> <span class="o">==</span> <span class="n">BFI_IOC_INITING</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bfa_ioc_poll_fwinit</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/**</span>
<span class="cm">	 * If IOC function is disabled and firmware version is same,</span>
<span class="cm">	 * just re-enable IOC.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ioc_fwstate</span> <span class="o">==</span> <span class="n">BFI_IOC_DISABLED</span> <span class="o">||</span> <span class="n">ioc_fwstate</span> <span class="o">==</span> <span class="n">BFI_IOC_OP</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/**</span>
<span class="cm">		 * When using MSI-X any pending firmware ready event should</span>
<span class="cm">		 * be flushed. Otherwise MSI-X interrupts are not delivered.</span>
<span class="cm">		 */</span>
		<span class="n">bfa_ioc_msgflush</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>
		<span class="n">bfa_fsm_send_event</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">iocpf</span><span class="p">,</span> <span class="n">IOCPF_E_FWREADY</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/**</span>
<span class="cm">	 * Initialize the h/w for any other states.</span>
<span class="cm">	 */</span>
	<span class="n">bfa_ioc_boot</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">BFI_FWBOOT_TYPE_NORMAL</span><span class="p">,</span> <span class="n">boot_env</span><span class="p">);</span>
	<span class="n">bfa_ioc_poll_fwinit</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">bfa_nw_ioc_timeout</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">ioc_arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_ioc</span> <span class="o">*</span><span class="n">ioc</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">bfa_ioc</span> <span class="o">*</span><span class="p">)</span> <span class="n">ioc_arg</span><span class="p">;</span>

	<span class="n">bfa_fsm_send_event</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">IOC_E_TIMEOUT</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_ioc_mbox_send</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_ioc</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">ioc_msg</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">msgp</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span> <span class="n">ioc_msg</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">len</span> <span class="o">&lt;=</span> <span class="n">BFI_IOC_MSGLEN_MAX</span><span class="p">));</span>

	<span class="cm">/*</span>
<span class="cm">	 * first write msg to mailbox registers</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">len</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">msgp</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span>
			      <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioc_regs</span><span class="p">.</span><span class="n">hfn_mbox</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">));</span>

	<span class="k">for</span> <span class="p">(;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">BFI_IOC_MSGLEN_MAX</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioc_regs</span><span class="p">.</span><span class="n">hfn_mbox</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">));</span>

	<span class="cm">/*</span>
<span class="cm">	 * write 1 to mailbox CMD to trigger LPU event</span>
<span class="cm">	 */</span>
	<span class="n">writel</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioc_regs</span><span class="p">.</span><span class="n">hfn_mbox_cmd</span><span class="p">);</span>
	<span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">readl</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioc_regs</span><span class="p">.</span><span class="n">hfn_mbox_cmd</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_ioc_send_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_ioc</span> <span class="o">*</span><span class="n">ioc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfi_ioc_ctrl_req</span> <span class="n">enable_req</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">timeval</span> <span class="n">tv</span><span class="p">;</span>

	<span class="n">bfi_h2i_set</span><span class="p">(</span><span class="n">enable_req</span><span class="p">.</span><span class="n">mh</span><span class="p">,</span> <span class="n">BFI_MC_IOC</span><span class="p">,</span> <span class="n">BFI_IOC_H2I_ENABLE_REQ</span><span class="p">,</span>
		    <span class="n">bfa_ioc_portid</span><span class="p">(</span><span class="n">ioc</span><span class="p">));</span>
	<span class="n">enable_req</span><span class="p">.</span><span class="n">clscode</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">clscode</span><span class="p">);</span>
	<span class="n">do_gettimeofday</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tv</span><span class="p">);</span>
	<span class="n">enable_req</span><span class="p">.</span><span class="n">tv_sec</span> <span class="o">=</span> <span class="n">ntohl</span><span class="p">(</span><span class="n">tv</span><span class="p">.</span><span class="n">tv_sec</span><span class="p">);</span>
	<span class="n">bfa_ioc_mbox_send</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">enable_req</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfi_ioc_ctrl_req</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_ioc_send_disable</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_ioc</span> <span class="o">*</span><span class="n">ioc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfi_ioc_ctrl_req</span> <span class="n">disable_req</span><span class="p">;</span>

	<span class="n">bfi_h2i_set</span><span class="p">(</span><span class="n">disable_req</span><span class="p">.</span><span class="n">mh</span><span class="p">,</span> <span class="n">BFI_MC_IOC</span><span class="p">,</span> <span class="n">BFI_IOC_H2I_DISABLE_REQ</span><span class="p">,</span>
		    <span class="n">bfa_ioc_portid</span><span class="p">(</span><span class="n">ioc</span><span class="p">));</span>
	<span class="n">bfa_ioc_mbox_send</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">disable_req</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfi_ioc_ctrl_req</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_ioc_send_getattr</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_ioc</span> <span class="o">*</span><span class="n">ioc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfi_ioc_getattr_req</span> <span class="n">attr_req</span><span class="p">;</span>

	<span class="n">bfi_h2i_set</span><span class="p">(</span><span class="n">attr_req</span><span class="p">.</span><span class="n">mh</span><span class="p">,</span> <span class="n">BFI_MC_IOC</span><span class="p">,</span> <span class="n">BFI_IOC_H2I_GETATTR_REQ</span><span class="p">,</span>
		    <span class="n">bfa_ioc_portid</span><span class="p">(</span><span class="n">ioc</span><span class="p">));</span>
	<span class="n">bfa_dma_be_addr_set</span><span class="p">(</span><span class="n">attr_req</span><span class="p">.</span><span class="n">attr_addr</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">attr_dma</span><span class="p">.</span><span class="n">pa</span><span class="p">);</span>
	<span class="n">bfa_ioc_mbox_send</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">attr_req</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">attr_req</span><span class="p">));</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">bfa_nw_ioc_hb_check</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">cbarg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_ioc</span> <span class="o">*</span><span class="n">ioc</span> <span class="o">=</span> <span class="n">cbarg</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">hb_count</span><span class="p">;</span>

	<span class="n">hb_count</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioc_regs</span><span class="p">.</span><span class="n">heartbeat</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">hb_count</span> <span class="o">==</span> <span class="n">hb_count</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bfa_ioc_recover</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">hb_count</span> <span class="o">=</span> <span class="n">hb_count</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">bfa_ioc_mbox_poll</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>
	<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">hb_timer</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">+</span>
		<span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">BFA_IOC_HB_TOV</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_ioc_hb_monitor</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_ioc</span> <span class="o">*</span><span class="n">ioc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">hb_count</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioc_regs</span><span class="p">.</span><span class="n">heartbeat</span><span class="p">);</span>
	<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">hb_timer</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">+</span>
		<span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">BFA_IOC_HB_TOV</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_ioc_hb_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_ioc</span> <span class="o">*</span><span class="n">ioc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">hb_timer</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * @brief</span>
<span class="cm"> *	Initiate a full firmware download.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_ioc_download_fw</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_ioc</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="n">u32</span> <span class="n">boot_type</span><span class="p">,</span>
		    <span class="n">u32</span> <span class="n">boot_env</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">fwimg</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">pgnum</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">loff</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">chunkno</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">asicmode</span><span class="p">;</span>

	<span class="n">fwimg</span> <span class="o">=</span> <span class="n">bfa_cb_image_get_chunk</span><span class="p">(</span><span class="n">bfa_ioc_asic_gen</span><span class="p">(</span><span class="n">ioc</span><span class="p">),</span> <span class="n">chunkno</span><span class="p">);</span>

	<span class="n">pgnum</span> <span class="o">=</span> <span class="n">bfa_ioc_smem_pgnum</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">loff</span><span class="p">);</span>

	<span class="n">writel</span><span class="p">(</span><span class="n">pgnum</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioc_regs</span><span class="p">.</span><span class="n">host_page_num_fn</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">bfa_cb_image_get_size</span><span class="p">(</span><span class="n">bfa_ioc_asic_gen</span><span class="p">(</span><span class="n">ioc</span><span class="p">));</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">BFA_IOC_FLASH_CHUNK_NO</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">!=</span> <span class="n">chunkno</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">chunkno</span> <span class="o">=</span> <span class="n">BFA_IOC_FLASH_CHUNK_NO</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
			<span class="n">fwimg</span> <span class="o">=</span> <span class="n">bfa_cb_image_get_chunk</span><span class="p">(</span><span class="n">bfa_ioc_asic_gen</span><span class="p">(</span><span class="n">ioc</span><span class="p">),</span>
					<span class="n">BFA_IOC_FLASH_CHUNK_ADDR</span><span class="p">(</span><span class="n">chunkno</span><span class="p">));</span>
		<span class="p">}</span>

		<span class="cm">/**</span>
<span class="cm">		 * write smem</span>
<span class="cm">		 */</span>
		<span class="n">writel</span><span class="p">((</span><span class="n">swab32</span><span class="p">(</span><span class="n">fwimg</span><span class="p">[</span><span class="n">BFA_IOC_FLASH_OFFSET_IN_CHUNK</span><span class="p">(</span><span class="n">i</span><span class="p">)])),</span>
			      <span class="p">((</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioc_regs</span><span class="p">.</span><span class="n">smem_page_start</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">loff</span><span class="p">)));</span>

		<span class="n">loff</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">);</span>

		<span class="cm">/**</span>
<span class="cm">		 * handle page offset wrap around</span>
<span class="cm">		 */</span>
		<span class="n">loff</span> <span class="o">=</span> <span class="n">PSS_SMEM_PGOFF</span><span class="p">(</span><span class="n">loff</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">loff</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pgnum</span><span class="o">++</span><span class="p">;</span>
			<span class="n">writel</span><span class="p">(</span><span class="n">pgnum</span><span class="p">,</span>
				      <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioc_regs</span><span class="p">.</span><span class="n">host_page_num_fn</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">writel</span><span class="p">(</span><span class="n">bfa_ioc_smem_pgnum</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
		      <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioc_regs</span><span class="p">.</span><span class="n">host_page_num_fn</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Set boot type, env and device mode at the end.</span>
<span class="cm">	*/</span>
	<span class="n">asicmode</span> <span class="o">=</span> <span class="n">BFI_FWBOOT_DEVMODE</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">asic_gen</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">asic_mode</span><span class="p">,</span>
					<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">port0_mode</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">port1_mode</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">asicmode</span><span class="p">,</span> <span class="p">((</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioc_regs</span><span class="p">.</span><span class="n">smem_page_start</span><span class="p">)</span>
			<span class="o">+</span> <span class="n">BFI_FWBOOT_DEVMODE_OFF</span><span class="p">));</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">boot_type</span><span class="p">,</span> <span class="p">((</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioc_regs</span><span class="p">.</span><span class="n">smem_page_start</span><span class="p">)</span>
			<span class="o">+</span> <span class="p">(</span><span class="n">BFI_FWBOOT_TYPE_OFF</span><span class="p">)));</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">boot_env</span><span class="p">,</span> <span class="p">((</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioc_regs</span><span class="p">.</span><span class="n">smem_page_start</span><span class="p">)</span>
			<span class="o">+</span> <span class="p">(</span><span class="n">BFI_FWBOOT_ENV_OFF</span><span class="p">)));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_ioc_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_ioc</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="n">bool</span> <span class="n">force</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfa_ioc_hwinit</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">force</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * BFA ioc enable reply by firmware</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_ioc_enable_reply</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_ioc</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="k">enum</span> <span class="n">bfa_mode</span> <span class="n">port_mode</span><span class="p">,</span>
			<span class="n">u8</span> <span class="n">cap_bm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_iocpf</span> <span class="o">*</span><span class="n">iocpf</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">iocpf</span><span class="p">;</span>

	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">port_mode</span> <span class="o">=</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">port_mode_cfg</span> <span class="o">=</span> <span class="n">port_mode</span><span class="p">;</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ad_cap_bm</span> <span class="o">=</span> <span class="n">cap_bm</span><span class="p">;</span>
	<span class="n">bfa_fsm_send_event</span><span class="p">(</span><span class="n">iocpf</span><span class="p">,</span> <span class="n">IOCPF_E_FWRSP_ENABLE</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * @brief</span>
<span class="cm"> * Update BFA configuration from firmware configuration.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_ioc_getattr_reply</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_ioc</span> <span class="o">*</span><span class="n">ioc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfi_ioc_attr</span> <span class="o">*</span><span class="n">attr</span> <span class="o">=</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">;</span>

	<span class="n">attr</span><span class="o">-&gt;</span><span class="n">adapter_prop</span>  <span class="o">=</span> <span class="n">ntohl</span><span class="p">(</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">adapter_prop</span><span class="p">);</span>
	<span class="n">attr</span><span class="o">-&gt;</span><span class="n">card_type</span>     <span class="o">=</span> <span class="n">ntohl</span><span class="p">(</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">card_type</span><span class="p">);</span>
	<span class="n">attr</span><span class="o">-&gt;</span><span class="n">maxfrsize</span>	    <span class="o">=</span> <span class="n">ntohs</span><span class="p">(</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">maxfrsize</span><span class="p">);</span>

	<span class="n">bfa_fsm_send_event</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">IOC_E_FWRSP_GETATTR</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Attach time initialization of mbox logic.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_ioc_mbox_attach</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_ioc</span> <span class="o">*</span><span class="n">ioc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_ioc_mbox_mod</span> <span class="o">*</span><span class="n">mod</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">mbox_mod</span><span class="p">;</span>
	<span class="kt">int</span>	<span class="n">mc</span><span class="p">;</span>

	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mod</span><span class="o">-&gt;</span><span class="n">cmd_q</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">mc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">mc</span> <span class="o">&lt;</span> <span class="n">BFI_MC_MAX</span><span class="p">;</span> <span class="n">mc</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mod</span><span class="o">-&gt;</span><span class="n">mbhdlr</span><span class="p">[</span><span class="n">mc</span><span class="p">].</span><span class="n">cbfn</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">mod</span><span class="o">-&gt;</span><span class="n">mbhdlr</span><span class="p">[</span><span class="n">mc</span><span class="p">].</span><span class="n">cbarg</span> <span class="o">=</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Mbox poll timer -- restarts any pending mailbox requests.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_ioc_mbox_poll</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_ioc</span> <span class="o">*</span><span class="n">ioc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_ioc_mbox_mod</span> <span class="o">*</span><span class="n">mod</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">mbox_mod</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bfa_mbox_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
	<span class="n">bfa_mbox_cmd_cbfn_t</span> <span class="n">cbfn</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">cbarg</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">stat</span><span class="p">;</span>

	<span class="cm">/**</span>
<span class="cm">	 * If no command pending, do nothing</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mod</span><span class="o">-&gt;</span><span class="n">cmd_q</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/**</span>
<span class="cm">	 * If previous command is not yet fetched by firmware, do nothing</span>
<span class="cm">	 */</span>
	<span class="n">stat</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioc_regs</span><span class="p">.</span><span class="n">hfn_mbox_cmd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">stat</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/**</span>
<span class="cm">	 * Enqueue command to firmware.</span>
<span class="cm">	 */</span>
	<span class="n">bfa_q_deq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mod</span><span class="o">-&gt;</span><span class="n">cmd_q</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>
	<span class="n">bfa_ioc_mbox_send</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">));</span>

	<span class="cm">/**</span>
<span class="cm">	 * Give a callback to the client, indicating that the command is sent</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cbfn</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cbfn</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cbfn</span><span class="p">;</span>
		<span class="n">cbarg</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cbarg</span><span class="p">;</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cbfn</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">cbfn</span><span class="p">(</span><span class="n">cbarg</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Cleanup any pending requests.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_ioc_mbox_flush</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_ioc</span> <span class="o">*</span><span class="n">ioc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_ioc_mbox_mod</span> <span class="o">*</span><span class="n">mod</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">mbox_mod</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bfa_mbox_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mod</span><span class="o">-&gt;</span><span class="n">cmd_q</span><span class="p">))</span>
		<span class="n">bfa_q_deq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mod</span><span class="o">-&gt;</span><span class="n">cmd_q</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Read data from SMEM to host through PCI memmap</span>
<span class="cm"> *</span>
<span class="cm"> * @param[in]  ioc     memory for IOC</span>
<span class="cm"> * @param[in]  tbuf    app memory to store data from smem</span>
<span class="cm"> * @param[in]  soff    smem offset</span>
<span class="cm"> * @param[in]  sz      size of smem in bytes</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">bfa_nw_ioc_smem_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_ioc</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">tbuf</span><span class="p">,</span> <span class="n">u32</span> <span class="n">soff</span><span class="p">,</span> <span class="n">u32</span> <span class="n">sz</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">pgnum</span><span class="p">,</span> <span class="n">loff</span><span class="p">,</span> <span class="n">r32</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">len</span><span class="p">;</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="n">tbuf</span><span class="p">;</span>

	<span class="n">pgnum</span> <span class="o">=</span> <span class="n">PSS_SMEM_PGNUM</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioc_regs</span><span class="p">.</span><span class="n">smem_pg0</span><span class="p">,</span> <span class="n">soff</span><span class="p">);</span>
	<span class="n">loff</span> <span class="o">=</span> <span class="n">PSS_SMEM_PGOFF</span><span class="p">(</span><span class="n">soff</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 *  Hold semaphore to serialize pll init and fwtrc.</span>
<span class="cm">	*/</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bfa_nw_ioc_sem_get</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioc_regs</span><span class="p">.</span><span class="n">ioc_init_sem_reg</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">writel</span><span class="p">(</span><span class="n">pgnum</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioc_regs</span><span class="p">.</span><span class="n">host_page_num_fn</span><span class="p">);</span>

	<span class="n">len</span> <span class="o">=</span> <span class="n">sz</span><span class="o">/</span><span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">r32</span> <span class="o">=</span> <span class="n">swab32</span><span class="p">(</span><span class="n">readl</span><span class="p">((</span><span class="n">loff</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioc_regs</span><span class="p">.</span><span class="n">smem_page_start</span><span class="p">)));</span>
		<span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">r32</span><span class="p">);</span>
		<span class="n">loff</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">);</span>

		<span class="cm">/**</span>
<span class="cm">		 * handle page offset wrap around</span>
<span class="cm">		 */</span>
		<span class="n">loff</span> <span class="o">=</span> <span class="n">PSS_SMEM_PGOFF</span><span class="p">(</span><span class="n">loff</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">loff</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pgnum</span><span class="o">++</span><span class="p">;</span>
			<span class="n">writel</span><span class="p">(</span><span class="n">pgnum</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioc_regs</span><span class="p">.</span><span class="n">host_page_num_fn</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">writel</span><span class="p">(</span><span class="n">PSS_SMEM_PGNUM</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioc_regs</span><span class="p">.</span><span class="n">smem_pg0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	       <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioc_regs</span><span class="p">.</span><span class="n">host_page_num_fn</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * release semaphore</span>
<span class="cm">	 */</span>
	<span class="n">readl</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioc_regs</span><span class="p">.</span><span class="n">ioc_init_sem_reg</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioc_regs</span><span class="p">.</span><span class="n">ioc_init_sem_reg</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Retrieve saved firmware trace from a prior IOC failure.</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">bfa_nw_ioc_debug_fwtrc</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_ioc</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">trcdata</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">trclen</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">loff</span> <span class="o">=</span> <span class="n">BFI_IOC_TRC_OFF</span> <span class="o">+</span> <span class="n">BNA_DBG_FWTRC_LEN</span> <span class="o">*</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">port_id</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">tlen</span><span class="p">,</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">tlen</span> <span class="o">=</span> <span class="o">*</span><span class="n">trclen</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tlen</span> <span class="o">&gt;</span> <span class="n">BNA_DBG_FWTRC_LEN</span><span class="p">)</span>
		<span class="n">tlen</span> <span class="o">=</span> <span class="n">BNA_DBG_FWTRC_LEN</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">bfa_nw_ioc_smem_read</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">trcdata</span><span class="p">,</span> <span class="n">loff</span><span class="p">,</span> <span class="n">tlen</span><span class="p">);</span>
	<span class="o">*</span><span class="n">trclen</span> <span class="o">=</span> <span class="n">tlen</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Save firmware trace if configured.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_nw_ioc_debug_save_ftrc</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_ioc</span> <span class="o">*</span><span class="n">ioc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">tlen</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">dbg_fwsave_once</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">dbg_fwsave_once</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">dbg_fwsave_len</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">tlen</span> <span class="o">=</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">dbg_fwsave_len</span><span class="p">;</span>
			<span class="n">bfa_nw_ioc_debug_fwtrc</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">dbg_fwsave</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tlen</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Retrieve saved firmware trace from a prior IOC failure.</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">bfa_nw_ioc_debug_fwsave</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_ioc</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">trcdata</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">trclen</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">tlen</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">dbg_fwsave_len</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">BFA_STATUS_ENOFSAVE</span><span class="p">;</span>

	<span class="n">tlen</span> <span class="o">=</span> <span class="o">*</span><span class="n">trclen</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tlen</span> <span class="o">&gt;</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">dbg_fwsave_len</span><span class="p">)</span>
		<span class="n">tlen</span> <span class="o">=</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">dbg_fwsave_len</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">trcdata</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">dbg_fwsave</span><span class="p">,</span> <span class="n">tlen</span><span class="p">);</span>
	<span class="o">*</span><span class="n">trclen</span> <span class="o">=</span> <span class="n">tlen</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">BFA_STATUS_OK</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_ioc_fail_notify</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_ioc</span> <span class="o">*</span><span class="n">ioc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/**</span>
<span class="cm">	 * Notify driver and common modules registered for notification.</span>
<span class="cm">	 */</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">cbfn</span><span class="o">-&gt;</span><span class="n">hbfail_cbfn</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">);</span>
	<span class="n">bfa_ioc_event_notify</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">BFA_IOC_E_FAILED</span><span class="p">);</span>
	<span class="n">bfa_nw_ioc_debug_save_ftrc</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * IOCPF to IOC interface</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_ioc_pf_enabled</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_ioc</span> <span class="o">*</span><span class="n">ioc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfa_fsm_send_event</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">IOC_E_ENABLED</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_ioc_pf_disabled</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_ioc</span> <span class="o">*</span><span class="n">ioc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfa_fsm_send_event</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">IOC_E_DISABLED</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_ioc_pf_failed</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_ioc</span> <span class="o">*</span><span class="n">ioc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfa_fsm_send_event</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">IOC_E_PFFAILED</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_ioc_pf_hwfailed</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_ioc</span> <span class="o">*</span><span class="n">ioc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfa_fsm_send_event</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">IOC_E_HWFAILED</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_ioc_pf_fwmismatch</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_ioc</span> <span class="o">*</span><span class="n">ioc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/**</span>
<span class="cm">	 * Provide enable completion callback and AEN notification.</span>
<span class="cm">	 */</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">cbfn</span><span class="o">-&gt;</span><span class="n">enable_cbfn</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">bfa</span><span class="p">,</span> <span class="n">BFA_STATUS_IOC_FAILURE</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * IOC public</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">enum</span> <span class="n">bfa_status</span>
<span class="nf">bfa_ioc_pll_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_ioc</span> <span class="o">*</span><span class="n">ioc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 *  Hold semaphore so that nobody can access the chip during init.</span>
<span class="cm">	 */</span>
	<span class="n">bfa_nw_ioc_sem_get</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioc_regs</span><span class="p">.</span><span class="n">ioc_init_sem_reg</span><span class="p">);</span>

	<span class="n">bfa_ioc_pll_init_asic</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>

	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pllinit</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="cm">/* Initialize LMEM */</span>
	<span class="n">bfa_ioc_lmem_init</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 *  release semaphore.</span>
<span class="cm">	 */</span>
	<span class="n">bfa_nw_ioc_sem_release</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioc_regs</span><span class="p">.</span><span class="n">ioc_init_sem_reg</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">BFA_STATUS_OK</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Interface used by diag module to do firmware boot with memory test</span>
<span class="cm"> * as the entry vector.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_ioc_boot</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_ioc</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="k">enum</span> <span class="n">bfi_fwboot_type</span> <span class="n">boot_type</span><span class="p">,</span>
		<span class="n">u32</span> <span class="n">boot_env</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfa_ioc_stats</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">ioc_boots</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bfa_ioc_pll_init</span><span class="p">(</span><span class="n">ioc</span><span class="p">)</span> <span class="o">!=</span> <span class="n">BFA_STATUS_OK</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/**</span>
<span class="cm">	 * Initialize IOC state of all functions on a chip reset.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">boot_type</span> <span class="o">==</span> <span class="n">BFI_FWBOOT_TYPE_MEMTEST</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">BFI_IOC_MEMTEST</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioc_regs</span><span class="p">.</span><span class="n">ioc_fwstate</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">BFI_IOC_MEMTEST</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioc_regs</span><span class="p">.</span><span class="n">alt_ioc_fwstate</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">BFI_IOC_INITING</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioc_regs</span><span class="p">.</span><span class="n">ioc_fwstate</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">BFI_IOC_INITING</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioc_regs</span><span class="p">.</span><span class="n">alt_ioc_fwstate</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">bfa_ioc_msgflush</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>
	<span class="n">bfa_ioc_download_fw</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">boot_type</span><span class="p">,</span> <span class="n">boot_env</span><span class="p">);</span>
	<span class="n">bfa_ioc_lpu_start</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Enable/disable IOC failure auto recovery.</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">bfa_nw_ioc_auto_recover</span><span class="p">(</span><span class="n">bool</span> <span class="n">auto_recover</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfa_nw_auto_recover</span> <span class="o">=</span> <span class="n">auto_recover</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span>
<span class="nf">bfa_ioc_msgget</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_ioc</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">mbmsg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span>	<span class="o">*</span><span class="n">msgp</span> <span class="o">=</span> <span class="n">mbmsg</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">r32</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">i</span><span class="p">;</span>

	<span class="n">r32</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioc_regs</span><span class="p">.</span><span class="n">lpu_mbox_cmd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">r32</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="cm">/**</span>
<span class="cm">	 * read the MBOX msg</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">union</span> <span class="n">bfi_ioc_i2h_msg_u</span><span class="p">)</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">));</span>
	     <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">r32</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioc_regs</span><span class="p">.</span><span class="n">lpu_mbox</span> <span class="o">+</span>
				   <span class="n">i</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">));</span>
		<span class="n">msgp</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">r32</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/**</span>
<span class="cm">	 * turn off mailbox interrupt by clearing mailbox status</span>
<span class="cm">	 */</span>
	<span class="n">writel</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioc_regs</span><span class="p">.</span><span class="n">lpu_mbox_cmd</span><span class="p">);</span>
	<span class="n">readl</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioc_regs</span><span class="p">.</span><span class="n">lpu_mbox_cmd</span><span class="p">);</span>

	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_ioc_isr</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_ioc</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bfi_mbmsg</span> <span class="o">*</span><span class="n">m</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">union</span> <span class="n">bfi_ioc_i2h_msg_u</span>	<span class="o">*</span><span class="n">msg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bfa_iocpf</span> <span class="o">*</span><span class="n">iocpf</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">iocpf</span><span class="p">;</span>

	<span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="k">union</span> <span class="n">bfi_ioc_i2h_msg_u</span> <span class="o">*</span><span class="p">)</span> <span class="n">m</span><span class="p">;</span>

	<span class="n">bfa_ioc_stats</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">ioc_isrs</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">mh</span><span class="p">.</span><span class="n">msg_id</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">BFI_IOC_I2H_HBEAT</span>:
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFI_IOC_I2H_ENABLE_REPLY</span>:
		<span class="n">bfa_ioc_enable_reply</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span>
			<span class="p">(</span><span class="k">enum</span> <span class="n">bfa_mode</span><span class="p">)</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">fw_event</span><span class="p">.</span><span class="n">port_mode</span><span class="p">,</span>
			<span class="n">msg</span><span class="o">-&gt;</span><span class="n">fw_event</span><span class="p">.</span><span class="n">cap_bm</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFI_IOC_I2H_DISABLE_REPLY</span>:
		<span class="n">bfa_fsm_send_event</span><span class="p">(</span><span class="n">iocpf</span><span class="p">,</span> <span class="n">IOCPF_E_FWRSP_DISABLE</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFI_IOC_I2H_GETATTR_REPLY</span>:
		<span class="n">bfa_ioc_getattr_reply</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * IOC attach time initialization and setup.</span>
<span class="cm"> *</span>
<span class="cm"> * @param[in]	ioc	memory for IOC</span>
<span class="cm"> * @param[in]	bfa	driver instance structure</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">bfa_nw_ioc_attach</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_ioc</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">bfa</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bfa_ioc_cbfn</span> <span class="o">*</span><span class="n">cbfn</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">bfa</span>	<span class="o">=</span> <span class="n">bfa</span><span class="p">;</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">cbfn</span>	<span class="o">=</span> <span class="n">cbfn</span><span class="p">;</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">fcmode</span>	<span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pllinit</span>	<span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">dbg_fwsave_once</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">iocpf</span><span class="p">.</span><span class="n">ioc</span>  <span class="o">=</span> <span class="n">ioc</span><span class="p">;</span>

	<span class="n">bfa_ioc_mbox_attach</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">notify_q</span><span class="p">);</span>

	<span class="n">bfa_fsm_set_state</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">bfa_ioc_sm_uninit</span><span class="p">);</span>
	<span class="n">bfa_fsm_send_event</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">IOC_E_RESET</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Driver detach time IOC cleanup.</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">bfa_nw_ioc_detach</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_ioc</span> <span class="o">*</span><span class="n">ioc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfa_fsm_send_event</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">IOC_E_DETACH</span><span class="p">);</span>

	<span class="cm">/* Done with detach, empty the notify_q. */</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">notify_q</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Setup IOC PCI properties.</span>
<span class="cm"> *</span>
<span class="cm"> * @param[in]	pcidev	PCI device information for this IOC</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">bfa_nw_ioc_pci_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_ioc</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bfa_pcidev</span> <span class="o">*</span><span class="n">pcidev</span><span class="p">,</span>
		 <span class="k">enum</span> <span class="n">bfi_pcifn_class</span> <span class="n">clscode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">clscode</span>	<span class="o">=</span> <span class="n">clscode</span><span class="p">;</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pcidev</span>	<span class="o">=</span> <span class="o">*</span><span class="n">pcidev</span><span class="p">;</span>

	<span class="cm">/**</span>
<span class="cm">	 * Initialize IOC and device personality</span>
<span class="cm">	 */</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">port0_mode</span> <span class="o">=</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">port1_mode</span> <span class="o">=</span> <span class="n">BFI_PORT_MODE_FC</span><span class="p">;</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">asic_mode</span>  <span class="o">=</span> <span class="n">BFI_ASIC_MODE_FC</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">device_id</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PCI_DEVICE_ID_BROCADE_CT</span>:
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">asic_gen</span> <span class="o">=</span> <span class="n">BFI_ASIC_GEN_CT</span><span class="p">;</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">port0_mode</span> <span class="o">=</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">port1_mode</span> <span class="o">=</span> <span class="n">BFI_PORT_MODE_ETH</span><span class="p">;</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">asic_mode</span>  <span class="o">=</span> <span class="n">BFI_ASIC_MODE_ETH</span><span class="p">;</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">port_mode</span> <span class="o">=</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">port_mode_cfg</span> <span class="o">=</span> <span class="n">BFA_MODE_CNA</span><span class="p">;</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ad_cap_bm</span> <span class="o">=</span> <span class="n">BFA_CM_CNA</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFA_PCI_DEVICE_ID_CT2</span>:
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">asic_gen</span> <span class="o">=</span> <span class="n">BFI_ASIC_GEN_CT2</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">clscode</span> <span class="o">==</span> <span class="n">BFI_PCIFN_CLASS_FC</span> <span class="o">&amp;&amp;</span>
			<span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">ssid</span> <span class="o">==</span> <span class="n">BFA_PCI_CT2_SSID_FC</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">asic_mode</span>  <span class="o">=</span> <span class="n">BFI_ASIC_MODE_FC16</span><span class="p">;</span>
			<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">fcmode</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">port_mode</span> <span class="o">=</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">port_mode_cfg</span> <span class="o">=</span> <span class="n">BFA_MODE_HBA</span><span class="p">;</span>
			<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ad_cap_bm</span> <span class="o">=</span> <span class="n">BFA_CM_HBA</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">port0_mode</span> <span class="o">=</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">port1_mode</span> <span class="o">=</span> <span class="n">BFI_PORT_MODE_ETH</span><span class="p">;</span>
			<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">asic_mode</span>  <span class="o">=</span> <span class="n">BFI_ASIC_MODE_ETH</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">ssid</span> <span class="o">==</span> <span class="n">BFA_PCI_CT2_SSID_FCoE</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">port_mode</span> <span class="o">=</span>
				<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">port_mode_cfg</span> <span class="o">=</span> <span class="n">BFA_MODE_CNA</span><span class="p">;</span>
				<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ad_cap_bm</span> <span class="o">=</span> <span class="n">BFA_CM_CNA</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">port_mode</span> <span class="o">=</span>
				<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">port_mode_cfg</span> <span class="o">=</span> <span class="n">BFA_MODE_NIC</span><span class="p">;</span>
				<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ad_cap_bm</span> <span class="o">=</span> <span class="n">BFA_CM_NIC</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/**</span>
<span class="cm">	 * Set asic specific interfaces.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">asic_gen</span> <span class="o">==</span> <span class="n">BFI_ASIC_GEN_CT</span><span class="p">)</span>
		<span class="n">bfa_nw_ioc_set_ct_hwif</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">WARN_ON</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">asic_gen</span> <span class="o">!=</span> <span class="n">BFI_ASIC_GEN_CT2</span><span class="p">);</span>
		<span class="n">bfa_nw_ioc_set_ct2_hwif</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>
		<span class="n">bfa_nw_ioc_ct2_poweron</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">bfa_ioc_map_port</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>
	<span class="n">bfa_ioc_reg_init</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Initialize IOC dma memory</span>
<span class="cm"> *</span>
<span class="cm"> * @param[in]	dm_kva	kernel virtual address of IOC dma memory</span>
<span class="cm"> * @param[in]	dm_pa	physical address of IOC dma memory</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">bfa_nw_ioc_mem_claim</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_ioc</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span>  <span class="n">u8</span> <span class="o">*</span><span class="n">dm_kva</span><span class="p">,</span> <span class="n">u64</span> <span class="n">dm_pa</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/**</span>
<span class="cm">	 * dma memory for firmware attribute</span>
<span class="cm">	 */</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">attr_dma</span><span class="p">.</span><span class="n">kva</span> <span class="o">=</span> <span class="n">dm_kva</span><span class="p">;</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">attr_dma</span><span class="p">.</span><span class="n">pa</span> <span class="o">=</span> <span class="n">dm_pa</span><span class="p">;</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">attr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">bfi_ioc_attr</span> <span class="o">*</span><span class="p">)</span> <span class="n">dm_kva</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Return size of dma memory required.</span>
<span class="cm"> */</span>
<span class="n">u32</span>
<span class="nf">bfa_nw_ioc_meminfo</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">roundup</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfi_ioc_attr</span><span class="p">),</span> <span class="n">BFA_DMA_ALIGN_SZ</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">bfa_nw_ioc_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_ioc</span> <span class="o">*</span><span class="n">ioc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfa_ioc_stats</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">ioc_enables</span><span class="p">);</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">dbg_fwsave_once</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="n">bfa_fsm_send_event</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">IOC_E_ENABLE</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">bfa_nw_ioc_disable</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_ioc</span> <span class="o">*</span><span class="n">ioc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfa_ioc_stats</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">ioc_disables</span><span class="p">);</span>
	<span class="n">bfa_fsm_send_event</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">IOC_E_DISABLE</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Initialize memory for saving firmware trace.</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">bfa_nw_ioc_debug_memclaim</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_ioc</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dbg_fwsave</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">dbg_fwsave</span> <span class="o">=</span> <span class="n">dbg_fwsave</span><span class="p">;</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">dbg_fwsave_len</span> <span class="o">=</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">iocpf</span><span class="p">.</span><span class="n">auto_recover</span> <span class="o">?</span> <span class="n">BNA_DBG_FWTRC_LEN</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span>
<span class="nf">bfa_ioc_smem_pgnum</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_ioc</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="n">u32</span> <span class="n">fmaddr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">PSS_SMEM_PGNUM</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioc_regs</span><span class="p">.</span><span class="n">smem_pg0</span><span class="p">,</span> <span class="n">fmaddr</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Register mailbox message handler function, to be called by common modules</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">bfa_nw_ioc_mbox_regisr</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_ioc</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="k">enum</span> <span class="n">bfi_mclass</span> <span class="n">mc</span><span class="p">,</span>
		    <span class="n">bfa_ioc_mbox_mcfunc_t</span> <span class="n">cbfn</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">cbarg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_ioc_mbox_mod</span> <span class="o">*</span><span class="n">mod</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">mbox_mod</span><span class="p">;</span>

	<span class="n">mod</span><span class="o">-&gt;</span><span class="n">mbhdlr</span><span class="p">[</span><span class="n">mc</span><span class="p">].</span><span class="n">cbfn</span>	<span class="o">=</span> <span class="n">cbfn</span><span class="p">;</span>
	<span class="n">mod</span><span class="o">-&gt;</span><span class="n">mbhdlr</span><span class="p">[</span><span class="n">mc</span><span class="p">].</span><span class="n">cbarg</span> <span class="o">=</span> <span class="n">cbarg</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Queue a mailbox command request to firmware. Waits if mailbox is busy.</span>
<span class="cm"> * Responsibility of caller to serialize</span>
<span class="cm"> *</span>
<span class="cm"> * @param[in]	ioc	IOC instance</span>
<span class="cm"> * @param[i]	cmd	Mailbox command</span>
<span class="cm"> */</span>
<span class="n">bool</span>
<span class="nf">bfa_nw_ioc_mbox_queue</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_ioc</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bfa_mbox_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">,</span>
			<span class="n">bfa_mbox_cmd_cbfn_t</span> <span class="n">cbfn</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">cbarg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_ioc_mbox_mod</span> <span class="o">*</span><span class="n">mod</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">mbox_mod</span><span class="p">;</span>
	<span class="n">u32</span>			<span class="n">stat</span><span class="p">;</span>

	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cbfn</span> <span class="o">=</span> <span class="n">cbfn</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cbarg</span> <span class="o">=</span> <span class="n">cbarg</span><span class="p">;</span>

	<span class="cm">/**</span>
<span class="cm">	 * If a previous command is pending, queue new command</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mod</span><span class="o">-&gt;</span><span class="n">cmd_q</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">qe</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mod</span><span class="o">-&gt;</span><span class="n">cmd_q</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/**</span>
<span class="cm">	 * If mailbox is busy, queue command for poll timer</span>
<span class="cm">	 */</span>
	<span class="n">stat</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioc_regs</span><span class="p">.</span><span class="n">hfn_mbox_cmd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">stat</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">qe</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mod</span><span class="o">-&gt;</span><span class="n">cmd_q</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/**</span>
<span class="cm">	 * mailbox is free -- queue command to firmware</span>
<span class="cm">	 */</span>
	<span class="n">bfa_ioc_mbox_send</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">));</span>

	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Handle mailbox interrupts</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">bfa_nw_ioc_mbox_isr</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_ioc</span> <span class="o">*</span><span class="n">ioc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_ioc_mbox_mod</span> <span class="o">*</span><span class="n">mod</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">mbox_mod</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bfi_mbmsg</span> <span class="n">m</span><span class="p">;</span>
	<span class="kt">int</span>				<span class="n">mc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bfa_ioc_msgget</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">m</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/**</span>
<span class="cm">		 * Treat IOC message class as special.</span>
<span class="cm">		 */</span>
		<span class="n">mc</span> <span class="o">=</span> <span class="n">m</span><span class="p">.</span><span class="n">mh</span><span class="p">.</span><span class="n">msg_class</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mc</span> <span class="o">==</span> <span class="n">BFI_MC_IOC</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">bfa_ioc_isr</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">m</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">mc</span> <span class="o">&gt;=</span> <span class="n">BFI_MC_MAX</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">mod</span><span class="o">-&gt;</span><span class="n">mbhdlr</span><span class="p">[</span><span class="n">mc</span><span class="p">].</span><span class="n">cbfn</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">))</span>
			<span class="k">return</span><span class="p">;</span>

		<span class="n">mod</span><span class="o">-&gt;</span><span class="n">mbhdlr</span><span class="p">[</span><span class="n">mc</span><span class="p">].</span><span class="n">cbfn</span><span class="p">(</span><span class="n">mod</span><span class="o">-&gt;</span><span class="n">mbhdlr</span><span class="p">[</span><span class="n">mc</span><span class="p">].</span><span class="n">cbarg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">m</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">bfa_ioc_lpu_read_stat</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>

	<span class="cm">/**</span>
<span class="cm">	 * Try to send pending mailbox commands</span>
<span class="cm">	 */</span>
	<span class="n">bfa_ioc_mbox_poll</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">bfa_nw_ioc_error_isr</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_ioc</span> <span class="o">*</span><span class="n">ioc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfa_ioc_stats</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">ioc_hbfails</span><span class="p">);</span>
	<span class="n">bfa_ioc_stats_hb_count</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">hb_count</span><span class="p">);</span>
	<span class="n">bfa_fsm_send_event</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">IOC_E_HWERROR</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * return true if IOC is disabled</span>
<span class="cm"> */</span>
<span class="n">bool</span>
<span class="nf">bfa_nw_ioc_is_disabled</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_ioc</span> <span class="o">*</span><span class="n">ioc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">bfa_fsm_cmp_state</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">bfa_ioc_sm_disabling</span><span class="p">)</span> <span class="o">||</span>
		<span class="n">bfa_fsm_cmp_state</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">bfa_ioc_sm_disabled</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * return true if IOC is operational</span>
<span class="cm"> */</span>
<span class="n">bool</span>
<span class="nf">bfa_nw_ioc_is_operational</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_ioc</span> <span class="o">*</span><span class="n">ioc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">bfa_fsm_cmp_state</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">bfa_ioc_sm_op</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Add to IOC heartbeat failure notification queue. To be used by common</span>
<span class="cm"> * modules such as cee, port, diag.</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">bfa_nw_ioc_notify_register</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_ioc</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">bfa_ioc_notify</span> <span class="o">*</span><span class="n">notify</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">notify</span><span class="o">-&gt;</span><span class="n">qe</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">notify_q</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#define BFA_MFG_NAME &quot;Brocade&quot;</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_ioc_get_adapter_attr</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_ioc</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">bfa_adapter_attr</span> <span class="o">*</span><span class="n">ad_attr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfi_ioc_attr</span> <span class="o">*</span><span class="n">ioc_attr</span><span class="p">;</span>

	<span class="n">ioc_attr</span> <span class="o">=</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">;</span>

	<span class="n">bfa_ioc_get_adapter_serial_num</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">ad_attr</span><span class="o">-&gt;</span><span class="n">serial_num</span><span class="p">);</span>
	<span class="n">bfa_ioc_get_adapter_fw_ver</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">ad_attr</span><span class="o">-&gt;</span><span class="n">fw_ver</span><span class="p">);</span>
	<span class="n">bfa_ioc_get_adapter_optrom_ver</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">ad_attr</span><span class="o">-&gt;</span><span class="n">optrom_ver</span><span class="p">);</span>
	<span class="n">bfa_ioc_get_adapter_manufacturer</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">ad_attr</span><span class="o">-&gt;</span><span class="n">manufacturer</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ad_attr</span><span class="o">-&gt;</span><span class="n">vpd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioc_attr</span><span class="o">-&gt;</span><span class="n">vpd</span><span class="p">,</span>
		      <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_mfg_vpd</span><span class="p">));</span>

	<span class="n">ad_attr</span><span class="o">-&gt;</span><span class="n">nports</span> <span class="o">=</span> <span class="n">bfa_ioc_get_nports</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>
	<span class="n">ad_attr</span><span class="o">-&gt;</span><span class="n">max_speed</span> <span class="o">=</span> <span class="n">bfa_ioc_speed_sup</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>

	<span class="n">bfa_ioc_get_adapter_model</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">ad_attr</span><span class="o">-&gt;</span><span class="n">model</span><span class="p">);</span>
	<span class="cm">/* For now, model descr uses same model string */</span>
	<span class="n">bfa_ioc_get_adapter_model</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">ad_attr</span><span class="o">-&gt;</span><span class="n">model_descr</span><span class="p">);</span>

	<span class="n">ad_attr</span><span class="o">-&gt;</span><span class="n">card_type</span> <span class="o">=</span> <span class="n">ioc_attr</span><span class="o">-&gt;</span><span class="n">card_type</span><span class="p">;</span>
	<span class="n">ad_attr</span><span class="o">-&gt;</span><span class="n">is_mezz</span> <span class="o">=</span> <span class="n">bfa_mfg_is_mezz</span><span class="p">(</span><span class="n">ioc_attr</span><span class="o">-&gt;</span><span class="n">card_type</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">BFI_ADAPTER_IS_SPECIAL</span><span class="p">(</span><span class="n">ioc_attr</span><span class="o">-&gt;</span><span class="n">adapter_prop</span><span class="p">))</span>
		<span class="n">ad_attr</span><span class="o">-&gt;</span><span class="n">prototype</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">ad_attr</span><span class="o">-&gt;</span><span class="n">prototype</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ad_attr</span><span class="o">-&gt;</span><span class="n">pwwn</span> <span class="o">=</span> <span class="n">bfa_ioc_get_pwwn</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>
	<span class="n">ad_attr</span><span class="o">-&gt;</span><span class="n">mac</span>  <span class="o">=</span> <span class="n">bfa_nw_ioc_get_mac</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>

	<span class="n">ad_attr</span><span class="o">-&gt;</span><span class="n">pcie_gen</span> <span class="o">=</span> <span class="n">ioc_attr</span><span class="o">-&gt;</span><span class="n">pcie_gen</span><span class="p">;</span>
	<span class="n">ad_attr</span><span class="o">-&gt;</span><span class="n">pcie_lanes</span> <span class="o">=</span> <span class="n">ioc_attr</span><span class="o">-&gt;</span><span class="n">pcie_lanes</span><span class="p">;</span>
	<span class="n">ad_attr</span><span class="o">-&gt;</span><span class="n">pcie_lanes_orig</span> <span class="o">=</span> <span class="n">ioc_attr</span><span class="o">-&gt;</span><span class="n">pcie_lanes_orig</span><span class="p">;</span>
	<span class="n">ad_attr</span><span class="o">-&gt;</span><span class="n">asic_rev</span> <span class="o">=</span> <span class="n">ioc_attr</span><span class="o">-&gt;</span><span class="n">asic_rev</span><span class="p">;</span>

	<span class="n">bfa_ioc_get_pci_chip_rev</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">ad_attr</span><span class="o">-&gt;</span><span class="n">hw_ver</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">enum</span> <span class="n">bfa_ioc_type</span>
<span class="nf">bfa_ioc_get_type</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_ioc</span> <span class="o">*</span><span class="n">ioc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">clscode</span> <span class="o">==</span> <span class="n">BFI_PCIFN_CLASS_ETH</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">BFA_IOC_TYPE_LL</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">clscode</span> <span class="o">==</span> <span class="n">BFI_PCIFN_CLASS_FC</span><span class="p">));</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">port_mode</span> <span class="o">==</span> <span class="n">BFI_PORT_MODE_FC</span><span class="p">)</span>
		<span class="o">?</span> <span class="n">BFA_IOC_TYPE_FC</span> <span class="o">:</span> <span class="n">BFA_IOC_TYPE_FCoE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_ioc_get_adapter_serial_num</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_ioc</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">serial_num</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">serial_num</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">BFA_ADAPTER_SERIAL_NUM_LEN</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">serial_num</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">brcd_serialnum</span><span class="p">,</span>
			<span class="n">BFA_ADAPTER_SERIAL_NUM_LEN</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_ioc_get_adapter_fw_ver</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_ioc</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fw_ver</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">fw_ver</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">BFA_VERSION_LEN</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">fw_ver</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">fw_version</span><span class="p">,</span> <span class="n">BFA_VERSION_LEN</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_ioc_get_pci_chip_rev</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_ioc</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">chip_rev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">chip_rev</span><span class="p">));</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">chip_rev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">BFA_IOC_CHIP_REV_LEN</span><span class="p">);</span>

	<span class="n">chip_rev</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;R&#39;</span><span class="p">;</span>
	<span class="n">chip_rev</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;e&#39;</span><span class="p">;</span>
	<span class="n">chip_rev</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;v&#39;</span><span class="p">;</span>
	<span class="n">chip_rev</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;-&#39;</span><span class="p">;</span>
	<span class="n">chip_rev</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">asic_rev</span><span class="p">;</span>
	<span class="n">chip_rev</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_ioc_get_adapter_optrom_ver</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_ioc</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">optrom_ver</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">optrom_ver</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">BFA_VERSION_LEN</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">optrom_ver</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">optrom_version</span><span class="p">,</span>
		      <span class="n">BFA_VERSION_LEN</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_ioc_get_adapter_manufacturer</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_ioc</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">manufacturer</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">manufacturer</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">BFA_ADAPTER_MFG_NAME_LEN</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">manufacturer</span><span class="p">,</span> <span class="n">BFA_MFG_NAME</span><span class="p">,</span> <span class="n">BFA_ADAPTER_MFG_NAME_LEN</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_ioc_get_adapter_model</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_ioc</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">model</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfi_ioc_attr</span> <span class="o">*</span><span class="n">ioc_attr</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">model</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">BFA_ADAPTER_MODEL_NAME_LEN</span><span class="p">);</span>

	<span class="n">ioc_attr</span> <span class="o">=</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">;</span>

	<span class="n">snprintf</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">BFA_ADAPTER_MODEL_NAME_LEN</span><span class="p">,</span> <span class="s">&quot;%s-%u&quot;</span><span class="p">,</span>
		<span class="n">BFA_MFG_NAME</span><span class="p">,</span> <span class="n">ioc_attr</span><span class="o">-&gt;</span><span class="n">card_type</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">enum</span> <span class="n">bfa_ioc_state</span>
<span class="nf">bfa_ioc_get_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_ioc</span> <span class="o">*</span><span class="n">ioc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">enum</span> <span class="n">bfa_iocpf_state</span> <span class="n">iocpf_st</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">bfa_ioc_state</span> <span class="n">ioc_st</span> <span class="o">=</span> <span class="n">bfa_sm_to_state</span><span class="p">(</span><span class="n">ioc_sm_table</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">fsm</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ioc_st</span> <span class="o">==</span> <span class="n">BFA_IOC_ENABLING</span> <span class="o">||</span>
		<span class="n">ioc_st</span> <span class="o">==</span> <span class="n">BFA_IOC_FAIL</span> <span class="o">||</span> <span class="n">ioc_st</span> <span class="o">==</span> <span class="n">BFA_IOC_INITFAIL</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">iocpf_st</span> <span class="o">=</span> <span class="n">bfa_sm_to_state</span><span class="p">(</span><span class="n">iocpf_sm_table</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">iocpf</span><span class="p">.</span><span class="n">fsm</span><span class="p">);</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">iocpf_st</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">BFA_IOCPF_SEMWAIT</span>:
			<span class="n">ioc_st</span> <span class="o">=</span> <span class="n">BFA_IOC_SEMWAIT</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">BFA_IOCPF_HWINIT</span>:
			<span class="n">ioc_st</span> <span class="o">=</span> <span class="n">BFA_IOC_HWINIT</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">BFA_IOCPF_FWMISMATCH</span>:
			<span class="n">ioc_st</span> <span class="o">=</span> <span class="n">BFA_IOC_FWMISMATCH</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">BFA_IOCPF_FAIL</span>:
			<span class="n">ioc_st</span> <span class="o">=</span> <span class="n">BFA_IOC_FAIL</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">BFA_IOCPF_INITFAIL</span>:
			<span class="n">ioc_st</span> <span class="o">=</span> <span class="n">BFA_IOC_INITFAIL</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="nl">default:</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ioc_st</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">bfa_nw_ioc_get_attr</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_ioc</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bfa_ioc_attr</span> <span class="o">*</span><span class="n">ioc_attr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">memset</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">ioc_attr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_ioc_attr</span><span class="p">));</span>

	<span class="n">ioc_attr</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">bfa_ioc_get_state</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>
	<span class="n">ioc_attr</span><span class="o">-&gt;</span><span class="n">port_id</span> <span class="o">=</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">port_id</span><span class="p">;</span>
	<span class="n">ioc_attr</span><span class="o">-&gt;</span><span class="n">port_mode</span> <span class="o">=</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">port_mode</span><span class="p">;</span>

	<span class="n">ioc_attr</span><span class="o">-&gt;</span><span class="n">port_mode_cfg</span> <span class="o">=</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">port_mode_cfg</span><span class="p">;</span>
	<span class="n">ioc_attr</span><span class="o">-&gt;</span><span class="n">cap_bm</span> <span class="o">=</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ad_cap_bm</span><span class="p">;</span>

	<span class="n">ioc_attr</span><span class="o">-&gt;</span><span class="n">ioc_type</span> <span class="o">=</span> <span class="n">bfa_ioc_get_type</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>

	<span class="n">bfa_ioc_get_adapter_attr</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioc_attr</span><span class="o">-&gt;</span><span class="n">adapter_attr</span><span class="p">);</span>

	<span class="n">ioc_attr</span><span class="o">-&gt;</span><span class="n">pci_attr</span><span class="p">.</span><span class="n">device_id</span> <span class="o">=</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">.</span><span class="n">device_id</span><span class="p">;</span>
	<span class="n">ioc_attr</span><span class="o">-&gt;</span><span class="n">pci_attr</span><span class="p">.</span><span class="n">pcifn</span> <span class="o">=</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">.</span><span class="n">pci_func</span><span class="p">;</span>
	<span class="n">bfa_ioc_get_pci_chip_rev</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">ioc_attr</span><span class="o">-&gt;</span><span class="n">pci_attr</span><span class="p">.</span><span class="n">chip_rev</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * WWN public</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">u64</span>
<span class="nf">bfa_ioc_get_pwwn</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_ioc</span> <span class="o">*</span><span class="n">ioc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">pwwn</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">mac_t</span>
<span class="nf">bfa_nw_ioc_get_mac</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_ioc</span> <span class="o">*</span><span class="n">ioc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Firmware failure detected. Start recovery actions.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_ioc_recover</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_ioc</span> <span class="o">*</span><span class="n">ioc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pr_crit</span><span class="p">(</span><span class="s">&quot;Heart Beat of IOC has failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">bfa_ioc_stats</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">ioc_hbfails</span><span class="p">);</span>
	<span class="n">bfa_ioc_stats_hb_count</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">hb_count</span><span class="p">);</span>
	<span class="n">bfa_fsm_send_event</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">IOC_E_HBFAIL</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * @dg hal_iocpf_pvt BFA IOC PF private functions</span>
<span class="cm"> * @{</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_iocpf_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_ioc</span> <span class="o">*</span><span class="n">ioc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfa_fsm_send_event</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">iocpf</span><span class="p">,</span> <span class="n">IOCPF_E_ENABLE</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_iocpf_disable</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_ioc</span> <span class="o">*</span><span class="n">ioc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfa_fsm_send_event</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">iocpf</span><span class="p">,</span> <span class="n">IOCPF_E_DISABLE</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_iocpf_fail</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_ioc</span> <span class="o">*</span><span class="n">ioc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfa_fsm_send_event</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">iocpf</span><span class="p">,</span> <span class="n">IOCPF_E_FAIL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_iocpf_initfail</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_ioc</span> <span class="o">*</span><span class="n">ioc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfa_fsm_send_event</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">iocpf</span><span class="p">,</span> <span class="n">IOCPF_E_INITFAIL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_iocpf_getattrfail</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_ioc</span> <span class="o">*</span><span class="n">ioc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfa_fsm_send_event</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">iocpf</span><span class="p">,</span> <span class="n">IOCPF_E_GETATTRFAIL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_iocpf_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_ioc</span> <span class="o">*</span><span class="n">ioc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfa_fsm_send_event</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">iocpf</span><span class="p">,</span> <span class="n">IOCPF_E_STOP</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">bfa_nw_iocpf_timeout</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">ioc_arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_ioc</span>  <span class="o">*</span><span class="n">ioc</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">bfa_ioc</span> <span class="o">*</span><span class="p">)</span> <span class="n">ioc_arg</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">bfa_iocpf_state</span> <span class="n">iocpf_st</span><span class="p">;</span>

	<span class="n">iocpf_st</span> <span class="o">=</span> <span class="n">bfa_sm_to_state</span><span class="p">(</span><span class="n">iocpf_sm_table</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">iocpf</span><span class="p">.</span><span class="n">fsm</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">iocpf_st</span> <span class="o">==</span> <span class="n">BFA_IOCPF_HWINIT</span><span class="p">)</span>
		<span class="n">bfa_ioc_poll_fwinit</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">bfa_fsm_send_event</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">iocpf</span><span class="p">,</span> <span class="n">IOCPF_E_TIMEOUT</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">bfa_nw_iocpf_sem_timeout</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">ioc_arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_ioc</span>  <span class="o">*</span><span class="n">ioc</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">bfa_ioc</span> <span class="o">*</span><span class="p">)</span> <span class="n">ioc_arg</span><span class="p">;</span>

	<span class="n">bfa_ioc_hw_sem_get</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_ioc_poll_fwinit</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_ioc</span> <span class="o">*</span><span class="n">ioc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">fwstate</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioc_regs</span><span class="p">.</span><span class="n">ioc_fwstate</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fwstate</span> <span class="o">==</span> <span class="n">BFI_IOC_DISABLED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bfa_fsm_send_event</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">iocpf</span><span class="p">,</span> <span class="n">IOCPF_E_FWREADY</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">iocpf</span><span class="p">.</span><span class="n">poll_time</span> <span class="o">&gt;=</span> <span class="n">BFA_IOC_TOV</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bfa_nw_iocpf_timeout</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">iocpf</span><span class="p">.</span><span class="n">poll_time</span> <span class="o">+=</span> <span class="n">BFA_IOC_POLL_TOV</span><span class="p">;</span>
		<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">iocpf_timer</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">+</span>
			<span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">BFA_IOC_POLL_TOV</span><span class="p">));</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *	Flash module specific</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * FLASH DMA buffer should be big enough to hold both MFG block and</span>
<span class="cm"> * asic block(64k) at the same time and also should be 2k aligned to</span>
<span class="cm"> * avoid write segement to cross sector boundary.</span>
<span class="cm"> */</span>
<span class="cp">#define BFA_FLASH_SEG_SZ	2048</span>
<span class="cp">#define BFA_FLASH_DMA_BUF_SZ	\</span>
<span class="cp">	roundup(0x010000 + sizeof(struct bfa_mfg_block), BFA_FLASH_SEG_SZ)</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_flash_cb</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_flash</span> <span class="o">*</span><span class="n">flash</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">flash</span><span class="o">-&gt;</span><span class="n">op_busy</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">flash</span><span class="o">-&gt;</span><span class="n">cbfn</span><span class="p">)</span>
		<span class="n">flash</span><span class="o">-&gt;</span><span class="n">cbfn</span><span class="p">(</span><span class="n">flash</span><span class="o">-&gt;</span><span class="n">cbarg</span><span class="p">,</span> <span class="n">flash</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_flash_notify</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">cbarg</span><span class="p">,</span> <span class="k">enum</span> <span class="n">bfa_ioc_event</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_flash</span> <span class="o">*</span><span class="n">flash</span> <span class="o">=</span> <span class="n">cbarg</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">BFA_IOC_E_DISABLED</span>:
	<span class="k">case</span> <span class="n">BFA_IOC_E_FAILED</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">flash</span><span class="o">-&gt;</span><span class="n">op_busy</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">flash</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">BFA_STATUS_IOC_FAILURE</span><span class="p">;</span>
			<span class="n">flash</span><span class="o">-&gt;</span><span class="n">cbfn</span><span class="p">(</span><span class="n">flash</span><span class="o">-&gt;</span><span class="n">cbarg</span><span class="p">,</span> <span class="n">flash</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
			<span class="n">flash</span><span class="o">-&gt;</span><span class="n">op_busy</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Send flash write request.</span>
<span class="cm"> *</span>
<span class="cm"> * @param[in] cbarg - callback argument</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_flash_write_send</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_flash</span> <span class="o">*</span><span class="n">flash</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfi_flash_write_req</span> <span class="o">*</span><span class="n">msg</span> <span class="o">=</span>
			<span class="p">(</span><span class="k">struct</span> <span class="n">bfi_flash_write_req</span> <span class="o">*</span><span class="p">)</span> <span class="n">flash</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">.</span><span class="n">msg</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">len</span><span class="p">;</span>

	<span class="n">msg</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">flash</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">);</span>
	<span class="n">msg</span><span class="o">-&gt;</span><span class="n">instance</span> <span class="o">=</span> <span class="n">flash</span><span class="o">-&gt;</span><span class="n">instance</span><span class="p">;</span>
	<span class="n">msg</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">flash</span><span class="o">-&gt;</span><span class="n">addr_off</span> <span class="o">+</span> <span class="n">flash</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">);</span>
	<span class="n">len</span> <span class="o">=</span> <span class="p">(</span><span class="n">flash</span><span class="o">-&gt;</span><span class="n">residue</span> <span class="o">&lt;</span> <span class="n">BFA_FLASH_DMA_BUF_SZ</span><span class="p">)</span> <span class="o">?</span>
	       <span class="n">flash</span><span class="o">-&gt;</span><span class="n">residue</span> <span class="o">:</span> <span class="n">BFA_FLASH_DMA_BUF_SZ</span><span class="p">;</span>
	<span class="n">msg</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">len</span><span class="p">);</span>

	<span class="cm">/* indicate if it&#39;s the last msg of the whole write operation */</span>
	<span class="n">msg</span><span class="o">-&gt;</span><span class="n">last</span> <span class="o">=</span> <span class="p">(</span><span class="n">len</span> <span class="o">==</span> <span class="n">flash</span><span class="o">-&gt;</span><span class="n">residue</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">bfi_h2i_set</span><span class="p">(</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">mh</span><span class="p">,</span> <span class="n">BFI_MC_FLASH</span><span class="p">,</span> <span class="n">BFI_FLASH_H2I_WRITE_REQ</span><span class="p">,</span>
		    <span class="n">bfa_ioc_portid</span><span class="p">(</span><span class="n">flash</span><span class="o">-&gt;</span><span class="n">ioc</span><span class="p">));</span>
	<span class="n">bfa_alen_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">alen</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">flash</span><span class="o">-&gt;</span><span class="n">dbuf_pa</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">flash</span><span class="o">-&gt;</span><span class="n">dbuf_kva</span><span class="p">,</span> <span class="n">flash</span><span class="o">-&gt;</span><span class="n">ubuf</span> <span class="o">+</span> <span class="n">flash</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="n">bfa_nw_ioc_mbox_queue</span><span class="p">(</span><span class="n">flash</span><span class="o">-&gt;</span><span class="n">ioc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">flash</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="n">flash</span><span class="o">-&gt;</span><span class="n">residue</span> <span class="o">-=</span> <span class="n">len</span><span class="p">;</span>
	<span class="n">flash</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Send flash read request.</span>
<span class="cm"> *</span>
<span class="cm"> * @param[in] cbarg - callback argument</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_flash_read_send</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">cbarg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_flash</span> <span class="o">*</span><span class="n">flash</span> <span class="o">=</span> <span class="n">cbarg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bfi_flash_read_req</span> <span class="o">*</span><span class="n">msg</span> <span class="o">=</span>
			<span class="p">(</span><span class="k">struct</span> <span class="n">bfi_flash_read_req</span> <span class="o">*</span><span class="p">)</span> <span class="n">flash</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">.</span><span class="n">msg</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">len</span><span class="p">;</span>

	<span class="n">msg</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">flash</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">);</span>
	<span class="n">msg</span><span class="o">-&gt;</span><span class="n">instance</span> <span class="o">=</span> <span class="n">flash</span><span class="o">-&gt;</span><span class="n">instance</span><span class="p">;</span>
	<span class="n">msg</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">flash</span><span class="o">-&gt;</span><span class="n">addr_off</span> <span class="o">+</span> <span class="n">flash</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">);</span>
	<span class="n">len</span> <span class="o">=</span> <span class="p">(</span><span class="n">flash</span><span class="o">-&gt;</span><span class="n">residue</span> <span class="o">&lt;</span> <span class="n">BFA_FLASH_DMA_BUF_SZ</span><span class="p">)</span> <span class="o">?</span>
	       <span class="n">flash</span><span class="o">-&gt;</span><span class="n">residue</span> <span class="o">:</span> <span class="n">BFA_FLASH_DMA_BUF_SZ</span><span class="p">;</span>
	<span class="n">msg</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">len</span><span class="p">);</span>
	<span class="n">bfi_h2i_set</span><span class="p">(</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">mh</span><span class="p">,</span> <span class="n">BFI_MC_FLASH</span><span class="p">,</span> <span class="n">BFI_FLASH_H2I_READ_REQ</span><span class="p">,</span>
		    <span class="n">bfa_ioc_portid</span><span class="p">(</span><span class="n">flash</span><span class="o">-&gt;</span><span class="n">ioc</span><span class="p">));</span>
	<span class="n">bfa_alen_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">alen</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">flash</span><span class="o">-&gt;</span><span class="n">dbuf_pa</span><span class="p">);</span>
	<span class="n">bfa_nw_ioc_mbox_queue</span><span class="p">(</span><span class="n">flash</span><span class="o">-&gt;</span><span class="n">ioc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">flash</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Process flash response messages upon receiving interrupts.</span>
<span class="cm"> *</span>
<span class="cm"> * @param[in] flasharg - flash structure</span>
<span class="cm"> * @param[in] msg - message structure</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_flash_intr</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">flasharg</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bfi_mbmsg</span> <span class="o">*</span><span class="n">msg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_flash</span> <span class="o">*</span><span class="n">flash</span> <span class="o">=</span> <span class="n">flasharg</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">status</span><span class="p">;</span>

	<span class="k">union</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">bfi_flash_query_rsp</span> <span class="o">*</span><span class="n">query</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">bfi_flash_write_rsp</span> <span class="o">*</span><span class="n">write</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">bfi_flash_read_rsp</span> <span class="o">*</span><span class="n">read</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">bfi_mbmsg</span>   <span class="o">*</span><span class="n">msg</span><span class="p">;</span>
	<span class="p">}</span> <span class="n">m</span><span class="p">;</span>

	<span class="n">m</span><span class="p">.</span><span class="n">msg</span> <span class="o">=</span> <span class="n">msg</span><span class="p">;</span>

	<span class="cm">/* receiving response after ioc failure */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">flash</span><span class="o">-&gt;</span><span class="n">op_busy</span> <span class="o">&amp;&amp;</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">mh</span><span class="p">.</span><span class="n">msg_id</span> <span class="o">!=</span> <span class="n">BFI_FLASH_I2H_EVENT</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">mh</span><span class="p">.</span><span class="n">msg_id</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">BFI_FLASH_I2H_QUERY_RSP</span>:
		<span class="n">status</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">m</span><span class="p">.</span><span class="n">query</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="n">BFA_STATUS_OK</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u32</span>	<span class="n">i</span><span class="p">;</span>
			<span class="k">struct</span> <span class="n">bfa_flash_attr</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="o">*</span><span class="n">f</span><span class="p">;</span>

			<span class="n">attr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">bfa_flash_attr</span> <span class="o">*</span><span class="p">)</span> <span class="n">flash</span><span class="o">-&gt;</span><span class="n">ubuf</span><span class="p">;</span>
			<span class="n">f</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">bfa_flash_attr</span> <span class="o">*</span><span class="p">)</span> <span class="n">flash</span><span class="o">-&gt;</span><span class="n">dbuf_kva</span><span class="p">;</span>
			<span class="n">attr</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
			<span class="n">attr</span><span class="o">-&gt;</span><span class="n">npart</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">npart</span><span class="p">);</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">attr</span><span class="o">-&gt;</span><span class="n">npart</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">attr</span><span class="o">-&gt;</span><span class="n">part</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">part_type</span> <span class="o">=</span>
					<span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">part</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">part_type</span><span class="p">);</span>
				<span class="n">attr</span><span class="o">-&gt;</span><span class="n">part</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">part_instance</span> <span class="o">=</span>
					<span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">part</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">part_instance</span><span class="p">);</span>
				<span class="n">attr</span><span class="o">-&gt;</span><span class="n">part</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">part_off</span> <span class="o">=</span>
					<span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">part</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">part_off</span><span class="p">);</span>
				<span class="n">attr</span><span class="o">-&gt;</span><span class="n">part</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">part_size</span> <span class="o">=</span>
					<span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">part</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">part_size</span><span class="p">);</span>
				<span class="n">attr</span><span class="o">-&gt;</span><span class="n">part</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">part_len</span> <span class="o">=</span>
					<span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">part</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">part_len</span><span class="p">);</span>
				<span class="n">attr</span><span class="o">-&gt;</span><span class="n">part</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">part_status</span> <span class="o">=</span>
					<span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">part</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">part_status</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">flash</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">status</span><span class="p">;</span>
		<span class="n">bfa_flash_cb</span><span class="p">(</span><span class="n">flash</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">BFI_FLASH_I2H_WRITE_RSP</span>:
		<span class="n">status</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">m</span><span class="p">.</span><span class="n">write</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="n">BFA_STATUS_OK</span> <span class="o">||</span> <span class="n">flash</span><span class="o">-&gt;</span><span class="n">residue</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">flash</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">status</span><span class="p">;</span>
			<span class="n">bfa_flash_cb</span><span class="p">(</span><span class="n">flash</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">bfa_flash_write_send</span><span class="p">(</span><span class="n">flash</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">BFI_FLASH_I2H_READ_RSP</span>:
		<span class="n">status</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">m</span><span class="p">.</span><span class="n">read</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="n">BFA_STATUS_OK</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">flash</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">status</span><span class="p">;</span>
			<span class="n">bfa_flash_cb</span><span class="p">(</span><span class="n">flash</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">u32</span> <span class="n">len</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">m</span><span class="p">.</span><span class="n">read</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">);</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">flash</span><span class="o">-&gt;</span><span class="n">ubuf</span> <span class="o">+</span> <span class="n">flash</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">,</span>
			       <span class="n">flash</span><span class="o">-&gt;</span><span class="n">dbuf_kva</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
			<span class="n">flash</span><span class="o">-&gt;</span><span class="n">residue</span> <span class="o">-=</span> <span class="n">len</span><span class="p">;</span>
			<span class="n">flash</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">flash</span><span class="o">-&gt;</span><span class="n">residue</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">flash</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">status</span><span class="p">;</span>
				<span class="n">bfa_flash_cb</span><span class="p">(</span><span class="n">flash</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="n">bfa_flash_read_send</span><span class="p">(</span><span class="n">flash</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">BFI_FLASH_I2H_BOOT_VER_RSP</span>:
	<span class="k">case</span> <span class="n">BFI_FLASH_I2H_EVENT</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">WARN_ON</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Flash memory info API.</span>
<span class="cm"> */</span>
<span class="n">u32</span>
<span class="nf">bfa_nw_flash_meminfo</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">roundup</span><span class="p">(</span><span class="n">BFA_FLASH_DMA_BUF_SZ</span><span class="p">,</span> <span class="n">BFA_DMA_ALIGN_SZ</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Flash attach API.</span>
<span class="cm"> *</span>
<span class="cm"> * @param[in] flash - flash structure</span>
<span class="cm"> * @param[in] ioc  - ioc structure</span>
<span class="cm"> * @param[in] dev  - device structure</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">bfa_nw_flash_attach</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_flash</span> <span class="o">*</span><span class="n">flash</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bfa_ioc</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">flash</span><span class="o">-&gt;</span><span class="n">ioc</span> <span class="o">=</span> <span class="n">ioc</span><span class="p">;</span>
	<span class="n">flash</span><span class="o">-&gt;</span><span class="n">cbfn</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">flash</span><span class="o">-&gt;</span><span class="n">cbarg</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">flash</span><span class="o">-&gt;</span><span class="n">op_busy</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">bfa_nw_ioc_mbox_regisr</span><span class="p">(</span><span class="n">flash</span><span class="o">-&gt;</span><span class="n">ioc</span><span class="p">,</span> <span class="n">BFI_MC_FLASH</span><span class="p">,</span> <span class="n">bfa_flash_intr</span><span class="p">,</span> <span class="n">flash</span><span class="p">);</span>
	<span class="n">bfa_q_qe_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">flash</span><span class="o">-&gt;</span><span class="n">ioc_notify</span><span class="p">);</span>
	<span class="n">bfa_ioc_notify_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">flash</span><span class="o">-&gt;</span><span class="n">ioc_notify</span><span class="p">,</span> <span class="n">bfa_flash_notify</span><span class="p">,</span> <span class="n">flash</span><span class="p">);</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">flash</span><span class="o">-&gt;</span><span class="n">ioc_notify</span><span class="p">.</span><span class="n">qe</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">flash</span><span class="o">-&gt;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">notify_q</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Claim memory for flash</span>
<span class="cm"> *</span>
<span class="cm"> * @param[in] flash - flash structure</span>
<span class="cm"> * @param[in] dm_kva - pointer to virtual memory address</span>
<span class="cm"> * @param[in] dm_pa - physical memory address</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">bfa_nw_flash_memclaim</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_flash</span> <span class="o">*</span><span class="n">flash</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">dm_kva</span><span class="p">,</span> <span class="n">u64</span> <span class="n">dm_pa</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">flash</span><span class="o">-&gt;</span><span class="n">dbuf_kva</span> <span class="o">=</span> <span class="n">dm_kva</span><span class="p">;</span>
	<span class="n">flash</span><span class="o">-&gt;</span><span class="n">dbuf_pa</span> <span class="o">=</span> <span class="n">dm_pa</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">flash</span><span class="o">-&gt;</span><span class="n">dbuf_kva</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">BFA_FLASH_DMA_BUF_SZ</span><span class="p">);</span>
	<span class="n">dm_kva</span> <span class="o">+=</span> <span class="n">roundup</span><span class="p">(</span><span class="n">BFA_FLASH_DMA_BUF_SZ</span><span class="p">,</span> <span class="n">BFA_DMA_ALIGN_SZ</span><span class="p">);</span>
	<span class="n">dm_pa</span> <span class="o">+=</span> <span class="n">roundup</span><span class="p">(</span><span class="n">BFA_FLASH_DMA_BUF_SZ</span><span class="p">,</span> <span class="n">BFA_DMA_ALIGN_SZ</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Get flash attribute.</span>
<span class="cm"> *</span>
<span class="cm"> * @param[in] flash - flash structure</span>
<span class="cm"> * @param[in] attr - flash attribute structure</span>
<span class="cm"> * @param[in] cbfn - callback function</span>
<span class="cm"> * @param[in] cbarg - callback argument</span>
<span class="cm"> *</span>
<span class="cm"> * Return status.</span>
<span class="cm"> */</span>
<span class="k">enum</span> <span class="n">bfa_status</span>
<span class="nf">bfa_nw_flash_get_attr</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_flash</span> <span class="o">*</span><span class="n">flash</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bfa_flash_attr</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
		      <span class="n">bfa_cb_flash</span> <span class="n">cbfn</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">cbarg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfi_flash_query_req</span> <span class="o">*</span><span class="n">msg</span> <span class="o">=</span>
			<span class="p">(</span><span class="k">struct</span> <span class="n">bfi_flash_query_req</span> <span class="o">*</span><span class="p">)</span> <span class="n">flash</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">.</span><span class="n">msg</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bfa_nw_ioc_is_operational</span><span class="p">(</span><span class="n">flash</span><span class="o">-&gt;</span><span class="n">ioc</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">BFA_STATUS_IOC_NON_OP</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">flash</span><span class="o">-&gt;</span><span class="n">op_busy</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">BFA_STATUS_DEVBUSY</span><span class="p">;</span>

	<span class="n">flash</span><span class="o">-&gt;</span><span class="n">op_busy</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">flash</span><span class="o">-&gt;</span><span class="n">cbfn</span> <span class="o">=</span> <span class="n">cbfn</span><span class="p">;</span>
	<span class="n">flash</span><span class="o">-&gt;</span><span class="n">cbarg</span> <span class="o">=</span> <span class="n">cbarg</span><span class="p">;</span>
	<span class="n">flash</span><span class="o">-&gt;</span><span class="n">ubuf</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">attr</span><span class="p">;</span>

	<span class="n">bfi_h2i_set</span><span class="p">(</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">mh</span><span class="p">,</span> <span class="n">BFI_MC_FLASH</span><span class="p">,</span> <span class="n">BFI_FLASH_H2I_QUERY_REQ</span><span class="p">,</span>
		    <span class="n">bfa_ioc_portid</span><span class="p">(</span><span class="n">flash</span><span class="o">-&gt;</span><span class="n">ioc</span><span class="p">));</span>
	<span class="n">bfa_alen_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">alen</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_flash_attr</span><span class="p">),</span> <span class="n">flash</span><span class="o">-&gt;</span><span class="n">dbuf_pa</span><span class="p">);</span>
	<span class="n">bfa_nw_ioc_mbox_queue</span><span class="p">(</span><span class="n">flash</span><span class="o">-&gt;</span><span class="n">ioc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">flash</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">BFA_STATUS_OK</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Update flash partition.</span>
<span class="cm"> *</span>
<span class="cm"> * @param[in] flash - flash structure</span>
<span class="cm"> * @param[in] type - flash partition type</span>
<span class="cm"> * @param[in] instance - flash partition instance</span>
<span class="cm"> * @param[in] buf - update data buffer</span>
<span class="cm"> * @param[in] len - data buffer length</span>
<span class="cm"> * @param[in] offset - offset relative to the partition starting address</span>
<span class="cm"> * @param[in] cbfn - callback function</span>
<span class="cm"> * @param[in] cbarg - callback argument</span>
<span class="cm"> *</span>
<span class="cm"> * Return status.</span>
<span class="cm"> */</span>
<span class="k">enum</span> <span class="n">bfa_status</span>
<span class="nf">bfa_nw_flash_update_part</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_flash</span> <span class="o">*</span><span class="n">flash</span><span class="p">,</span> <span class="n">u32</span> <span class="n">type</span><span class="p">,</span> <span class="n">u8</span> <span class="n">instance</span><span class="p">,</span>
			 <span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="n">u32</span> <span class="n">len</span><span class="p">,</span> <span class="n">u32</span> <span class="n">offset</span><span class="p">,</span>
			 <span class="n">bfa_cb_flash</span> <span class="n">cbfn</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">cbarg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bfa_nw_ioc_is_operational</span><span class="p">(</span><span class="n">flash</span><span class="o">-&gt;</span><span class="n">ioc</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">BFA_STATUS_IOC_NON_OP</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * &#39;len&#39; must be in word (4-byte) boundary</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">len</span> <span class="o">||</span> <span class="p">(</span><span class="n">len</span> <span class="o">&amp;</span> <span class="mh">0x03</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">BFA_STATUS_FLASH_BAD_LEN</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">BFA_FLASH_PART_MFG</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">BFA_STATUS_EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">flash</span><span class="o">-&gt;</span><span class="n">op_busy</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">BFA_STATUS_DEVBUSY</span><span class="p">;</span>

	<span class="n">flash</span><span class="o">-&gt;</span><span class="n">op_busy</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">flash</span><span class="o">-&gt;</span><span class="n">cbfn</span> <span class="o">=</span> <span class="n">cbfn</span><span class="p">;</span>
	<span class="n">flash</span><span class="o">-&gt;</span><span class="n">cbarg</span> <span class="o">=</span> <span class="n">cbarg</span><span class="p">;</span>
	<span class="n">flash</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">type</span><span class="p">;</span>
	<span class="n">flash</span><span class="o">-&gt;</span><span class="n">instance</span> <span class="o">=</span> <span class="n">instance</span><span class="p">;</span>
	<span class="n">flash</span><span class="o">-&gt;</span><span class="n">residue</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
	<span class="n">flash</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">flash</span><span class="o">-&gt;</span><span class="n">addr_off</span> <span class="o">=</span> <span class="n">offset</span><span class="p">;</span>
	<span class="n">flash</span><span class="o">-&gt;</span><span class="n">ubuf</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>

	<span class="n">bfa_flash_write_send</span><span class="p">(</span><span class="n">flash</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">BFA_STATUS_OK</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Read flash partition.</span>
<span class="cm"> *</span>
<span class="cm"> * @param[in] flash - flash structure</span>
<span class="cm"> * @param[in] type - flash partition type</span>
<span class="cm"> * @param[in] instance - flash partition instance</span>
<span class="cm"> * @param[in] buf - read data buffer</span>
<span class="cm"> * @param[in] len - data buffer length</span>
<span class="cm"> * @param[in] offset - offset relative to the partition starting address</span>
<span class="cm"> * @param[in] cbfn - callback function</span>
<span class="cm"> * @param[in] cbarg - callback argument</span>
<span class="cm"> *</span>
<span class="cm"> * Return status.</span>
<span class="cm"> */</span>
<span class="k">enum</span> <span class="n">bfa_status</span>
<span class="nf">bfa_nw_flash_read_part</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_flash</span> <span class="o">*</span><span class="n">flash</span><span class="p">,</span> <span class="n">u32</span> <span class="n">type</span><span class="p">,</span> <span class="n">u8</span> <span class="n">instance</span><span class="p">,</span>
		       <span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="n">u32</span> <span class="n">len</span><span class="p">,</span> <span class="n">u32</span> <span class="n">offset</span><span class="p">,</span>
		       <span class="n">bfa_cb_flash</span> <span class="n">cbfn</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">cbarg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bfa_nw_ioc_is_operational</span><span class="p">(</span><span class="n">flash</span><span class="o">-&gt;</span><span class="n">ioc</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">BFA_STATUS_IOC_NON_OP</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * &#39;len&#39; must be in word (4-byte) boundary</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">len</span> <span class="o">||</span> <span class="p">(</span><span class="n">len</span> <span class="o">&amp;</span> <span class="mh">0x03</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">BFA_STATUS_FLASH_BAD_LEN</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">flash</span><span class="o">-&gt;</span><span class="n">op_busy</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">BFA_STATUS_DEVBUSY</span><span class="p">;</span>

	<span class="n">flash</span><span class="o">-&gt;</span><span class="n">op_busy</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">flash</span><span class="o">-&gt;</span><span class="n">cbfn</span> <span class="o">=</span> <span class="n">cbfn</span><span class="p">;</span>
	<span class="n">flash</span><span class="o">-&gt;</span><span class="n">cbarg</span> <span class="o">=</span> <span class="n">cbarg</span><span class="p">;</span>
	<span class="n">flash</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">type</span><span class="p">;</span>
	<span class="n">flash</span><span class="o">-&gt;</span><span class="n">instance</span> <span class="o">=</span> <span class="n">instance</span><span class="p">;</span>
	<span class="n">flash</span><span class="o">-&gt;</span><span class="n">residue</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
	<span class="n">flash</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">flash</span><span class="o">-&gt;</span><span class="n">addr_off</span> <span class="o">=</span> <span class="n">offset</span><span class="p">;</span>
	<span class="n">flash</span><span class="o">-&gt;</span><span class="n">ubuf</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>

	<span class="n">bfa_flash_read_send</span><span class="p">(</span><span class="n">flash</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">BFA_STATUS_OK</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:5}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../../javascript/docco.min.js"></script>
</html>
