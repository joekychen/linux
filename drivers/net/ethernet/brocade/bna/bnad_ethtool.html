<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › ethernet › brocade › bna › bnad_ethtool.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../../index.html"></a><h1>bnad_ethtool.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Linux network driver for Brocade Converged Network Adapter.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify it</span>
<span class="cm"> * under the terms of the GNU General Public License (GPL) Version 2 as</span>
<span class="cm"> * published by the Free Software Foundation</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful, but</span>
<span class="cm"> * WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU</span>
<span class="cm"> * General Public License for more details.</span>
<span class="cm"> */</span>
<span class="cm">/*</span>
<span class="cm"> * Copyright (c) 2005-2010 Brocade Communications Systems, Inc.</span>
<span class="cm"> * All rights reserved</span>
<span class="cm"> * www.brocade.com</span>
<span class="cm"> */</span>

<span class="cp">#include &quot;cna.h&quot;</span>

<span class="cp">#include &lt;linux/netdevice.h&gt;</span>
<span class="cp">#include &lt;linux/skbuff.h&gt;</span>
<span class="cp">#include &lt;linux/ethtool.h&gt;</span>
<span class="cp">#include &lt;linux/rtnetlink.h&gt;</span>

<span class="cp">#include &quot;bna.h&quot;</span>

<span class="cp">#include &quot;bnad.h&quot;</span>

<span class="cp">#define BNAD_NUM_TXF_COUNTERS 12</span>
<span class="cp">#define BNAD_NUM_RXF_COUNTERS 10</span>
<span class="cp">#define BNAD_NUM_CQ_COUNTERS (3 + 5)</span>
<span class="cp">#define BNAD_NUM_RXQ_COUNTERS 6</span>
<span class="cp">#define BNAD_NUM_TXQ_COUNTERS 5</span>

<span class="cp">#define BNAD_ETHTOOL_STATS_NUM						\</span>
<span class="cp">	(sizeof(struct rtnl_link_stats64) / sizeof(u64) +	\</span>
<span class="cp">	sizeof(struct bnad_drv_stats) / sizeof(u64) +		\</span>
<span class="cp">	offsetof(struct bfi_enet_stats, rxf_stats[0]) / sizeof(u64))</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">bnad_net_stats_strings</span><span class="p">[</span><span class="n">BNAD_ETHTOOL_STATS_NUM</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="s">&quot;rx_packets&quot;</span><span class="p">,</span>
	<span class="s">&quot;tx_packets&quot;</span><span class="p">,</span>
	<span class="s">&quot;rx_bytes&quot;</span><span class="p">,</span>
	<span class="s">&quot;tx_bytes&quot;</span><span class="p">,</span>
	<span class="s">&quot;rx_errors&quot;</span><span class="p">,</span>
	<span class="s">&quot;tx_errors&quot;</span><span class="p">,</span>
	<span class="s">&quot;rx_dropped&quot;</span><span class="p">,</span>
	<span class="s">&quot;tx_dropped&quot;</span><span class="p">,</span>
	<span class="s">&quot;multicast&quot;</span><span class="p">,</span>
	<span class="s">&quot;collisions&quot;</span><span class="p">,</span>

	<span class="s">&quot;rx_length_errors&quot;</span><span class="p">,</span>
	<span class="s">&quot;rx_over_errors&quot;</span><span class="p">,</span>
	<span class="s">&quot;rx_crc_errors&quot;</span><span class="p">,</span>
	<span class="s">&quot;rx_frame_errors&quot;</span><span class="p">,</span>
	<span class="s">&quot;rx_fifo_errors&quot;</span><span class="p">,</span>
	<span class="s">&quot;rx_missed_errors&quot;</span><span class="p">,</span>

	<span class="s">&quot;tx_aborted_errors&quot;</span><span class="p">,</span>
	<span class="s">&quot;tx_carrier_errors&quot;</span><span class="p">,</span>
	<span class="s">&quot;tx_fifo_errors&quot;</span><span class="p">,</span>
	<span class="s">&quot;tx_heartbeat_errors&quot;</span><span class="p">,</span>
	<span class="s">&quot;tx_window_errors&quot;</span><span class="p">,</span>

	<span class="s">&quot;rx_compressed&quot;</span><span class="p">,</span>
	<span class="s">&quot;tx_compressed&quot;</span><span class="p">,</span>

	<span class="s">&quot;netif_queue_stop&quot;</span><span class="p">,</span>
	<span class="s">&quot;netif_queue_wakeup&quot;</span><span class="p">,</span>
	<span class="s">&quot;netif_queue_stopped&quot;</span><span class="p">,</span>
	<span class="s">&quot;tso4&quot;</span><span class="p">,</span>
	<span class="s">&quot;tso6&quot;</span><span class="p">,</span>
	<span class="s">&quot;tso_err&quot;</span><span class="p">,</span>
	<span class="s">&quot;tcpcsum_offload&quot;</span><span class="p">,</span>
	<span class="s">&quot;udpcsum_offload&quot;</span><span class="p">,</span>
	<span class="s">&quot;csum_help&quot;</span><span class="p">,</span>
	<span class="s">&quot;tx_skb_too_short&quot;</span><span class="p">,</span>
	<span class="s">&quot;tx_skb_stopping&quot;</span><span class="p">,</span>
	<span class="s">&quot;tx_skb_max_vectors&quot;</span><span class="p">,</span>
	<span class="s">&quot;tx_skb_mss_too_long&quot;</span><span class="p">,</span>
	<span class="s">&quot;tx_skb_tso_too_short&quot;</span><span class="p">,</span>
	<span class="s">&quot;tx_skb_tso_prepare&quot;</span><span class="p">,</span>
	<span class="s">&quot;tx_skb_non_tso_too_long&quot;</span><span class="p">,</span>
	<span class="s">&quot;tx_skb_tcp_hdr&quot;</span><span class="p">,</span>
	<span class="s">&quot;tx_skb_udp_hdr&quot;</span><span class="p">,</span>
	<span class="s">&quot;tx_skb_csum_err&quot;</span><span class="p">,</span>
	<span class="s">&quot;tx_skb_headlen_too_long&quot;</span><span class="p">,</span>
	<span class="s">&quot;tx_skb_headlen_zero&quot;</span><span class="p">,</span>
	<span class="s">&quot;tx_skb_frag_zero&quot;</span><span class="p">,</span>
	<span class="s">&quot;tx_skb_len_mismatch&quot;</span><span class="p">,</span>
	<span class="s">&quot;hw_stats_updates&quot;</span><span class="p">,</span>
	<span class="s">&quot;netif_rx_dropped&quot;</span><span class="p">,</span>

	<span class="s">&quot;link_toggle&quot;</span><span class="p">,</span>
	<span class="s">&quot;cee_toggle&quot;</span><span class="p">,</span>

	<span class="s">&quot;rxp_info_alloc_failed&quot;</span><span class="p">,</span>
	<span class="s">&quot;mbox_intr_disabled&quot;</span><span class="p">,</span>
	<span class="s">&quot;mbox_intr_enabled&quot;</span><span class="p">,</span>
	<span class="s">&quot;tx_unmap_q_alloc_failed&quot;</span><span class="p">,</span>
	<span class="s">&quot;rx_unmap_q_alloc_failed&quot;</span><span class="p">,</span>
	<span class="s">&quot;rxbuf_alloc_failed&quot;</span><span class="p">,</span>

	<span class="s">&quot;mac_frame_64&quot;</span><span class="p">,</span>
	<span class="s">&quot;mac_frame_65_127&quot;</span><span class="p">,</span>
	<span class="s">&quot;mac_frame_128_255&quot;</span><span class="p">,</span>
	<span class="s">&quot;mac_frame_256_511&quot;</span><span class="p">,</span>
	<span class="s">&quot;mac_frame_512_1023&quot;</span><span class="p">,</span>
	<span class="s">&quot;mac_frame_1024_1518&quot;</span><span class="p">,</span>
	<span class="s">&quot;mac_frame_1518_1522&quot;</span><span class="p">,</span>
	<span class="s">&quot;mac_rx_bytes&quot;</span><span class="p">,</span>
	<span class="s">&quot;mac_rx_packets&quot;</span><span class="p">,</span>
	<span class="s">&quot;mac_rx_fcs_error&quot;</span><span class="p">,</span>
	<span class="s">&quot;mac_rx_multicast&quot;</span><span class="p">,</span>
	<span class="s">&quot;mac_rx_broadcast&quot;</span><span class="p">,</span>
	<span class="s">&quot;mac_rx_control_frames&quot;</span><span class="p">,</span>
	<span class="s">&quot;mac_rx_pause&quot;</span><span class="p">,</span>
	<span class="s">&quot;mac_rx_unknown_opcode&quot;</span><span class="p">,</span>
	<span class="s">&quot;mac_rx_alignment_error&quot;</span><span class="p">,</span>
	<span class="s">&quot;mac_rx_frame_length_error&quot;</span><span class="p">,</span>
	<span class="s">&quot;mac_rx_code_error&quot;</span><span class="p">,</span>
	<span class="s">&quot;mac_rx_carrier_sense_error&quot;</span><span class="p">,</span>
	<span class="s">&quot;mac_rx_undersize&quot;</span><span class="p">,</span>
	<span class="s">&quot;mac_rx_oversize&quot;</span><span class="p">,</span>
	<span class="s">&quot;mac_rx_fragments&quot;</span><span class="p">,</span>
	<span class="s">&quot;mac_rx_jabber&quot;</span><span class="p">,</span>
	<span class="s">&quot;mac_rx_drop&quot;</span><span class="p">,</span>

	<span class="s">&quot;mac_tx_bytes&quot;</span><span class="p">,</span>
	<span class="s">&quot;mac_tx_packets&quot;</span><span class="p">,</span>
	<span class="s">&quot;mac_tx_multicast&quot;</span><span class="p">,</span>
	<span class="s">&quot;mac_tx_broadcast&quot;</span><span class="p">,</span>
	<span class="s">&quot;mac_tx_pause&quot;</span><span class="p">,</span>
	<span class="s">&quot;mac_tx_deferral&quot;</span><span class="p">,</span>
	<span class="s">&quot;mac_tx_excessive_deferral&quot;</span><span class="p">,</span>
	<span class="s">&quot;mac_tx_single_collision&quot;</span><span class="p">,</span>
	<span class="s">&quot;mac_tx_muliple_collision&quot;</span><span class="p">,</span>
	<span class="s">&quot;mac_tx_late_collision&quot;</span><span class="p">,</span>
	<span class="s">&quot;mac_tx_excessive_collision&quot;</span><span class="p">,</span>
	<span class="s">&quot;mac_tx_total_collision&quot;</span><span class="p">,</span>
	<span class="s">&quot;mac_tx_pause_honored&quot;</span><span class="p">,</span>
	<span class="s">&quot;mac_tx_drop&quot;</span><span class="p">,</span>
	<span class="s">&quot;mac_tx_jabber&quot;</span><span class="p">,</span>
	<span class="s">&quot;mac_tx_fcs_error&quot;</span><span class="p">,</span>
	<span class="s">&quot;mac_tx_control_frame&quot;</span><span class="p">,</span>
	<span class="s">&quot;mac_tx_oversize&quot;</span><span class="p">,</span>
	<span class="s">&quot;mac_tx_undersize&quot;</span><span class="p">,</span>
	<span class="s">&quot;mac_tx_fragments&quot;</span><span class="p">,</span>

	<span class="s">&quot;bpc_tx_pause_0&quot;</span><span class="p">,</span>
	<span class="s">&quot;bpc_tx_pause_1&quot;</span><span class="p">,</span>
	<span class="s">&quot;bpc_tx_pause_2&quot;</span><span class="p">,</span>
	<span class="s">&quot;bpc_tx_pause_3&quot;</span><span class="p">,</span>
	<span class="s">&quot;bpc_tx_pause_4&quot;</span><span class="p">,</span>
	<span class="s">&quot;bpc_tx_pause_5&quot;</span><span class="p">,</span>
	<span class="s">&quot;bpc_tx_pause_6&quot;</span><span class="p">,</span>
	<span class="s">&quot;bpc_tx_pause_7&quot;</span><span class="p">,</span>
	<span class="s">&quot;bpc_tx_zero_pause_0&quot;</span><span class="p">,</span>
	<span class="s">&quot;bpc_tx_zero_pause_1&quot;</span><span class="p">,</span>
	<span class="s">&quot;bpc_tx_zero_pause_2&quot;</span><span class="p">,</span>
	<span class="s">&quot;bpc_tx_zero_pause_3&quot;</span><span class="p">,</span>
	<span class="s">&quot;bpc_tx_zero_pause_4&quot;</span><span class="p">,</span>
	<span class="s">&quot;bpc_tx_zero_pause_5&quot;</span><span class="p">,</span>
	<span class="s">&quot;bpc_tx_zero_pause_6&quot;</span><span class="p">,</span>
	<span class="s">&quot;bpc_tx_zero_pause_7&quot;</span><span class="p">,</span>
	<span class="s">&quot;bpc_tx_first_pause_0&quot;</span><span class="p">,</span>
	<span class="s">&quot;bpc_tx_first_pause_1&quot;</span><span class="p">,</span>
	<span class="s">&quot;bpc_tx_first_pause_2&quot;</span><span class="p">,</span>
	<span class="s">&quot;bpc_tx_first_pause_3&quot;</span><span class="p">,</span>
	<span class="s">&quot;bpc_tx_first_pause_4&quot;</span><span class="p">,</span>
	<span class="s">&quot;bpc_tx_first_pause_5&quot;</span><span class="p">,</span>
	<span class="s">&quot;bpc_tx_first_pause_6&quot;</span><span class="p">,</span>
	<span class="s">&quot;bpc_tx_first_pause_7&quot;</span><span class="p">,</span>

	<span class="s">&quot;bpc_rx_pause_0&quot;</span><span class="p">,</span>
	<span class="s">&quot;bpc_rx_pause_1&quot;</span><span class="p">,</span>
	<span class="s">&quot;bpc_rx_pause_2&quot;</span><span class="p">,</span>
	<span class="s">&quot;bpc_rx_pause_3&quot;</span><span class="p">,</span>
	<span class="s">&quot;bpc_rx_pause_4&quot;</span><span class="p">,</span>
	<span class="s">&quot;bpc_rx_pause_5&quot;</span><span class="p">,</span>
	<span class="s">&quot;bpc_rx_pause_6&quot;</span><span class="p">,</span>
	<span class="s">&quot;bpc_rx_pause_7&quot;</span><span class="p">,</span>
	<span class="s">&quot;bpc_rx_zero_pause_0&quot;</span><span class="p">,</span>
	<span class="s">&quot;bpc_rx_zero_pause_1&quot;</span><span class="p">,</span>
	<span class="s">&quot;bpc_rx_zero_pause_2&quot;</span><span class="p">,</span>
	<span class="s">&quot;bpc_rx_zero_pause_3&quot;</span><span class="p">,</span>
	<span class="s">&quot;bpc_rx_zero_pause_4&quot;</span><span class="p">,</span>
	<span class="s">&quot;bpc_rx_zero_pause_5&quot;</span><span class="p">,</span>
	<span class="s">&quot;bpc_rx_zero_pause_6&quot;</span><span class="p">,</span>
	<span class="s">&quot;bpc_rx_zero_pause_7&quot;</span><span class="p">,</span>
	<span class="s">&quot;bpc_rx_first_pause_0&quot;</span><span class="p">,</span>
	<span class="s">&quot;bpc_rx_first_pause_1&quot;</span><span class="p">,</span>
	<span class="s">&quot;bpc_rx_first_pause_2&quot;</span><span class="p">,</span>
	<span class="s">&quot;bpc_rx_first_pause_3&quot;</span><span class="p">,</span>
	<span class="s">&quot;bpc_rx_first_pause_4&quot;</span><span class="p">,</span>
	<span class="s">&quot;bpc_rx_first_pause_5&quot;</span><span class="p">,</span>
	<span class="s">&quot;bpc_rx_first_pause_6&quot;</span><span class="p">,</span>
	<span class="s">&quot;bpc_rx_first_pause_7&quot;</span><span class="p">,</span>

	<span class="s">&quot;rad_rx_frames&quot;</span><span class="p">,</span>
	<span class="s">&quot;rad_rx_octets&quot;</span><span class="p">,</span>
	<span class="s">&quot;rad_rx_vlan_frames&quot;</span><span class="p">,</span>
	<span class="s">&quot;rad_rx_ucast&quot;</span><span class="p">,</span>
	<span class="s">&quot;rad_rx_ucast_octets&quot;</span><span class="p">,</span>
	<span class="s">&quot;rad_rx_ucast_vlan&quot;</span><span class="p">,</span>
	<span class="s">&quot;rad_rx_mcast&quot;</span><span class="p">,</span>
	<span class="s">&quot;rad_rx_mcast_octets&quot;</span><span class="p">,</span>
	<span class="s">&quot;rad_rx_mcast_vlan&quot;</span><span class="p">,</span>
	<span class="s">&quot;rad_rx_bcast&quot;</span><span class="p">,</span>
	<span class="s">&quot;rad_rx_bcast_octets&quot;</span><span class="p">,</span>
	<span class="s">&quot;rad_rx_bcast_vlan&quot;</span><span class="p">,</span>
	<span class="s">&quot;rad_rx_drops&quot;</span><span class="p">,</span>

	<span class="s">&quot;rlb_rad_rx_frames&quot;</span><span class="p">,</span>
	<span class="s">&quot;rlb_rad_rx_octets&quot;</span><span class="p">,</span>
	<span class="s">&quot;rlb_rad_rx_vlan_frames&quot;</span><span class="p">,</span>
	<span class="s">&quot;rlb_rad_rx_ucast&quot;</span><span class="p">,</span>
	<span class="s">&quot;rlb_rad_rx_ucast_octets&quot;</span><span class="p">,</span>
	<span class="s">&quot;rlb_rad_rx_ucast_vlan&quot;</span><span class="p">,</span>
	<span class="s">&quot;rlb_rad_rx_mcast&quot;</span><span class="p">,</span>
	<span class="s">&quot;rlb_rad_rx_mcast_octets&quot;</span><span class="p">,</span>
	<span class="s">&quot;rlb_rad_rx_mcast_vlan&quot;</span><span class="p">,</span>
	<span class="s">&quot;rlb_rad_rx_bcast&quot;</span><span class="p">,</span>
	<span class="s">&quot;rlb_rad_rx_bcast_octets&quot;</span><span class="p">,</span>
	<span class="s">&quot;rlb_rad_rx_bcast_vlan&quot;</span><span class="p">,</span>
	<span class="s">&quot;rlb_rad_rx_drops&quot;</span><span class="p">,</span>

	<span class="s">&quot;fc_rx_ucast_octets&quot;</span><span class="p">,</span>
	<span class="s">&quot;fc_rx_ucast&quot;</span><span class="p">,</span>
	<span class="s">&quot;fc_rx_ucast_vlan&quot;</span><span class="p">,</span>
	<span class="s">&quot;fc_rx_mcast_octets&quot;</span><span class="p">,</span>
	<span class="s">&quot;fc_rx_mcast&quot;</span><span class="p">,</span>
	<span class="s">&quot;fc_rx_mcast_vlan&quot;</span><span class="p">,</span>
	<span class="s">&quot;fc_rx_bcast_octets&quot;</span><span class="p">,</span>
	<span class="s">&quot;fc_rx_bcast&quot;</span><span class="p">,</span>
	<span class="s">&quot;fc_rx_bcast_vlan&quot;</span><span class="p">,</span>

	<span class="s">&quot;fc_tx_ucast_octets&quot;</span><span class="p">,</span>
	<span class="s">&quot;fc_tx_ucast&quot;</span><span class="p">,</span>
	<span class="s">&quot;fc_tx_ucast_vlan&quot;</span><span class="p">,</span>
	<span class="s">&quot;fc_tx_mcast_octets&quot;</span><span class="p">,</span>
	<span class="s">&quot;fc_tx_mcast&quot;</span><span class="p">,</span>
	<span class="s">&quot;fc_tx_mcast_vlan&quot;</span><span class="p">,</span>
	<span class="s">&quot;fc_tx_bcast_octets&quot;</span><span class="p">,</span>
	<span class="s">&quot;fc_tx_bcast&quot;</span><span class="p">,</span>
	<span class="s">&quot;fc_tx_bcast_vlan&quot;</span><span class="p">,</span>
	<span class="s">&quot;fc_tx_parity_errors&quot;</span><span class="p">,</span>
	<span class="s">&quot;fc_tx_timeout&quot;</span><span class="p">,</span>
	<span class="s">&quot;fc_tx_fid_parity_errors&quot;</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">bnad_get_settings</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ethtool_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">supported</span> <span class="o">=</span> <span class="n">SUPPORTED_10000baseT_Full</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">advertising</span> <span class="o">=</span> <span class="n">ADVERTISED_10000baseT_Full</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">autoneg</span> <span class="o">=</span> <span class="n">AUTONEG_DISABLE</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">supported</span> <span class="o">|=</span> <span class="n">SUPPORTED_FIBRE</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">advertising</span> <span class="o">|=</span> <span class="n">ADVERTISED_FIBRE</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">=</span> <span class="n">PORT_FIBRE</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">phy_address</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">netif_carrier_ok</span><span class="p">(</span><span class="n">netdev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ethtool_cmd_speed_set</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">SPEED_10000</span><span class="p">);</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">duplex</span> <span class="o">=</span> <span class="n">DUPLEX_FULL</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ethtool_cmd_speed_set</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">duplex</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">transceiver</span> <span class="o">=</span> <span class="n">XCVR_EXTERNAL</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">maxtxpkt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">maxrxpkt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">bnad_set_settings</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ethtool_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* 10G full duplex setting supported only */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">autoneg</span> <span class="o">==</span> <span class="n">AUTONEG_ENABLE</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">ethtool_cmd_speed</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="o">==</span> <span class="n">SPEED_10000</span><span class="p">)</span>
		    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">duplex</span> <span class="o">==</span> <span class="n">DUPLEX_FULL</span><span class="p">))</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bnad_get_drvinfo</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ethtool_drvinfo</span> <span class="o">*</span><span class="n">drvinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnad</span> <span class="o">*</span><span class="n">bnad</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">bfa_ioc_attr</span> <span class="o">*</span><span class="n">ioc_attr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">strlcpy</span><span class="p">(</span><span class="n">drvinfo</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">,</span> <span class="n">BNAD_NAME</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">drvinfo</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">));</span>
	<span class="n">strlcpy</span><span class="p">(</span><span class="n">drvinfo</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">,</span> <span class="n">BNAD_VERSION</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">drvinfo</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">));</span>

	<span class="n">ioc_attr</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ioc_attr</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ioc_attr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bnad</span><span class="o">-&gt;</span><span class="n">bna_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">bfa_nw_ioc_get_attr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bnad</span><span class="o">-&gt;</span><span class="n">bna</span><span class="p">.</span><span class="n">ioceth</span><span class="p">.</span><span class="n">ioc</span><span class="p">,</span> <span class="n">ioc_attr</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bnad</span><span class="o">-&gt;</span><span class="n">bna_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

		<span class="n">strlcpy</span><span class="p">(</span><span class="n">drvinfo</span><span class="o">-&gt;</span><span class="n">fw_version</span><span class="p">,</span> <span class="n">ioc_attr</span><span class="o">-&gt;</span><span class="n">adapter_attr</span><span class="p">.</span><span class="n">fw_ver</span><span class="p">,</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="n">drvinfo</span><span class="o">-&gt;</span><span class="n">fw_version</span><span class="p">));</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">ioc_attr</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">strlcpy</span><span class="p">(</span><span class="n">drvinfo</span><span class="o">-&gt;</span><span class="n">bus_info</span><span class="p">,</span> <span class="n">pci_name</span><span class="p">(</span><span class="n">bnad</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">),</span>
		<span class="k">sizeof</span><span class="p">(</span><span class="n">drvinfo</span><span class="o">-&gt;</span><span class="n">bus_info</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bnad_get_wol</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ethtool_wolinfo</span> <span class="o">*</span><span class="n">wolinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">wolinfo</span><span class="o">-&gt;</span><span class="n">supported</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">wolinfo</span><span class="o">-&gt;</span><span class="n">wolopts</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">bnad_get_coalesce</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ethtool_coalesce</span> <span class="o">*</span><span class="n">coalesce</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnad</span> <span class="o">*</span><span class="n">bnad</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="cm">/* Lock rqd. to access bnad-&gt;bna_lock */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bnad</span><span class="o">-&gt;</span><span class="n">bna_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">coalesce</span><span class="o">-&gt;</span><span class="n">use_adaptive_rx_coalesce</span> <span class="o">=</span>
		<span class="p">(</span><span class="n">bnad</span><span class="o">-&gt;</span><span class="n">cfg_flags</span> <span class="o">&amp;</span> <span class="n">BNAD_CF_DIM_ENABLED</span><span class="p">)</span> <span class="o">?</span> <span class="nb">true</span> <span class="o">:</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bnad</span><span class="o">-&gt;</span><span class="n">bna_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">coalesce</span><span class="o">-&gt;</span><span class="n">rx_coalesce_usecs</span> <span class="o">=</span> <span class="n">bnad</span><span class="o">-&gt;</span><span class="n">rx_coalescing_timeo</span> <span class="o">*</span>
					<span class="n">BFI_COALESCING_TIMER_UNIT</span><span class="p">;</span>
	<span class="n">coalesce</span><span class="o">-&gt;</span><span class="n">tx_coalesce_usecs</span> <span class="o">=</span> <span class="n">bnad</span><span class="o">-&gt;</span><span class="n">tx_coalescing_timeo</span> <span class="o">*</span>
					<span class="n">BFI_COALESCING_TIMER_UNIT</span><span class="p">;</span>
	<span class="n">coalesce</span><span class="o">-&gt;</span><span class="n">tx_max_coalesced_frames</span> <span class="o">=</span> <span class="n">BFI_TX_INTERPKT_COUNT</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">bnad_set_coalesce</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ethtool_coalesce</span> <span class="o">*</span><span class="n">coalesce</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnad</span> <span class="o">*</span><span class="n">bnad</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">to_del</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">coalesce</span><span class="o">-&gt;</span><span class="n">rx_coalesce_usecs</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span>
	    <span class="n">coalesce</span><span class="o">-&gt;</span><span class="n">rx_coalesce_usecs</span> <span class="o">&gt;</span>
	    <span class="n">BFI_MAX_COALESCING_TIMEO</span> <span class="o">*</span> <span class="n">BFI_COALESCING_TIMER_UNIT</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">coalesce</span><span class="o">-&gt;</span><span class="n">tx_coalesce_usecs</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span>
	    <span class="n">coalesce</span><span class="o">-&gt;</span><span class="n">tx_coalesce_usecs</span> <span class="o">&gt;</span>
	    <span class="n">BFI_MAX_COALESCING_TIMEO</span> <span class="o">*</span> <span class="n">BFI_COALESCING_TIMER_UNIT</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bnad</span><span class="o">-&gt;</span><span class="n">conf_mutex</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * Do not need to store rx_coalesce_usecs here</span>
<span class="cm">	 * Every time DIM is disabled, we can get it from the</span>
<span class="cm">	 * stack.</span>
<span class="cm">	 */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bnad</span><span class="o">-&gt;</span><span class="n">bna_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">coalesce</span><span class="o">-&gt;</span><span class="n">use_adaptive_rx_coalesce</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">bnad</span><span class="o">-&gt;</span><span class="n">cfg_flags</span> <span class="o">&amp;</span> <span class="n">BNAD_CF_DIM_ENABLED</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">bnad</span><span class="o">-&gt;</span><span class="n">cfg_flags</span> <span class="o">|=</span> <span class="n">BNAD_CF_DIM_ENABLED</span><span class="p">;</span>
			<span class="n">bnad_dim_timer_start</span><span class="p">(</span><span class="n">bnad</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bnad</span><span class="o">-&gt;</span><span class="n">cfg_flags</span> <span class="o">&amp;</span> <span class="n">BNAD_CF_DIM_ENABLED</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">bnad</span><span class="o">-&gt;</span><span class="n">cfg_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">BNAD_CF_DIM_ENABLED</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">bnad</span><span class="o">-&gt;</span><span class="n">cfg_flags</span> <span class="o">&amp;</span> <span class="n">BNAD_CF_DIM_ENABLED</span> <span class="o">&amp;&amp;</span>
			    <span class="n">test_bit</span><span class="p">(</span><span class="n">BNAD_RF_DIM_TIMER_RUNNING</span><span class="p">,</span>
			    <span class="o">&amp;</span><span class="n">bnad</span><span class="o">-&gt;</span><span class="n">run_flags</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">clear_bit</span><span class="p">(</span><span class="n">BNAD_RF_DIM_TIMER_RUNNING</span><span class="p">,</span>
							<span class="o">&amp;</span><span class="n">bnad</span><span class="o">-&gt;</span><span class="n">run_flags</span><span class="p">);</span>
				<span class="n">to_del</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bnad</span><span class="o">-&gt;</span><span class="n">bna_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">to_del</span><span class="p">)</span>
				<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bnad</span><span class="o">-&gt;</span><span class="n">dim_timer</span><span class="p">);</span>
			<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bnad</span><span class="o">-&gt;</span><span class="n">bna_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="n">bnad_rx_coalescing_timeo_set</span><span class="p">(</span><span class="n">bnad</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bnad</span><span class="o">-&gt;</span><span class="n">tx_coalescing_timeo</span> <span class="o">!=</span> <span class="n">coalesce</span><span class="o">-&gt;</span><span class="n">tx_coalesce_usecs</span> <span class="o">/</span>
					<span class="n">BFI_COALESCING_TIMER_UNIT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bnad</span><span class="o">-&gt;</span><span class="n">tx_coalescing_timeo</span> <span class="o">=</span> <span class="n">coalesce</span><span class="o">-&gt;</span><span class="n">tx_coalesce_usecs</span> <span class="o">/</span>
						<span class="n">BFI_COALESCING_TIMER_UNIT</span><span class="p">;</span>
		<span class="n">bnad_tx_coalescing_timeo_set</span><span class="p">(</span><span class="n">bnad</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bnad</span><span class="o">-&gt;</span><span class="n">rx_coalescing_timeo</span> <span class="o">!=</span> <span class="n">coalesce</span><span class="o">-&gt;</span><span class="n">rx_coalesce_usecs</span> <span class="o">/</span>
					<span class="n">BFI_COALESCING_TIMER_UNIT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bnad</span><span class="o">-&gt;</span><span class="n">rx_coalescing_timeo</span> <span class="o">=</span> <span class="n">coalesce</span><span class="o">-&gt;</span><span class="n">rx_coalesce_usecs</span> <span class="o">/</span>
						<span class="n">BFI_COALESCING_TIMER_UNIT</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">bnad</span><span class="o">-&gt;</span><span class="n">cfg_flags</span> <span class="o">&amp;</span> <span class="n">BNAD_CF_DIM_ENABLED</span><span class="p">))</span>
			<span class="n">bnad_rx_coalescing_timeo_set</span><span class="p">(</span><span class="n">bnad</span><span class="p">);</span>

	<span class="p">}</span>

	<span class="cm">/* Add Tx Inter-pkt DMA count?  */</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bnad</span><span class="o">-&gt;</span><span class="n">bna_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bnad</span><span class="o">-&gt;</span><span class="n">conf_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bnad_get_ringparam</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span>
		   <span class="k">struct</span> <span class="n">ethtool_ringparam</span> <span class="o">*</span><span class="n">ringparam</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnad</span> <span class="o">*</span><span class="n">bnad</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>

	<span class="n">ringparam</span><span class="o">-&gt;</span><span class="n">rx_max_pending</span> <span class="o">=</span> <span class="n">BNAD_MAX_RXQ_DEPTH</span><span class="p">;</span>
	<span class="n">ringparam</span><span class="o">-&gt;</span><span class="n">tx_max_pending</span> <span class="o">=</span> <span class="n">BNAD_MAX_TXQ_DEPTH</span><span class="p">;</span>

	<span class="n">ringparam</span><span class="o">-&gt;</span><span class="n">rx_pending</span> <span class="o">=</span> <span class="n">bnad</span><span class="o">-&gt;</span><span class="n">rxq_depth</span><span class="p">;</span>
	<span class="n">ringparam</span><span class="o">-&gt;</span><span class="n">tx_pending</span> <span class="o">=</span> <span class="n">bnad</span><span class="o">-&gt;</span><span class="n">txq_depth</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">bnad_set_ringparam</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span>
		   <span class="k">struct</span> <span class="n">ethtool_ringparam</span> <span class="o">*</span><span class="n">ringparam</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">current_err</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bnad</span> <span class="o">*</span><span class="n">bnad</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bnad</span><span class="o">-&gt;</span><span class="n">conf_mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ringparam</span><span class="o">-&gt;</span><span class="n">rx_pending</span> <span class="o">==</span> <span class="n">bnad</span><span class="o">-&gt;</span><span class="n">rxq_depth</span> <span class="o">&amp;&amp;</span>
	    <span class="n">ringparam</span><span class="o">-&gt;</span><span class="n">tx_pending</span> <span class="o">==</span> <span class="n">bnad</span><span class="o">-&gt;</span><span class="n">txq_depth</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bnad</span><span class="o">-&gt;</span><span class="n">conf_mutex</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ringparam</span><span class="o">-&gt;</span><span class="n">rx_pending</span> <span class="o">&lt;</span> <span class="n">BNAD_MIN_Q_DEPTH</span> <span class="o">||</span>
	    <span class="n">ringparam</span><span class="o">-&gt;</span><span class="n">rx_pending</span> <span class="o">&gt;</span> <span class="n">BNAD_MAX_RXQ_DEPTH</span> <span class="o">||</span>
	    <span class="o">!</span><span class="n">BNA_POWER_OF_2</span><span class="p">(</span><span class="n">ringparam</span><span class="o">-&gt;</span><span class="n">rx_pending</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bnad</span><span class="o">-&gt;</span><span class="n">conf_mutex</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ringparam</span><span class="o">-&gt;</span><span class="n">tx_pending</span> <span class="o">&lt;</span> <span class="n">BNAD_MIN_Q_DEPTH</span> <span class="o">||</span>
	    <span class="n">ringparam</span><span class="o">-&gt;</span><span class="n">tx_pending</span> <span class="o">&gt;</span> <span class="n">BNAD_MAX_TXQ_DEPTH</span> <span class="o">||</span>
	    <span class="o">!</span><span class="n">BNA_POWER_OF_2</span><span class="p">(</span><span class="n">ringparam</span><span class="o">-&gt;</span><span class="n">tx_pending</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bnad</span><span class="o">-&gt;</span><span class="n">conf_mutex</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ringparam</span><span class="o">-&gt;</span><span class="n">rx_pending</span> <span class="o">!=</span> <span class="n">bnad</span><span class="o">-&gt;</span><span class="n">rxq_depth</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bnad</span><span class="o">-&gt;</span><span class="n">rxq_depth</span> <span class="o">=</span> <span class="n">ringparam</span><span class="o">-&gt;</span><span class="n">rx_pending</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">netif_running</span><span class="p">(</span><span class="n">netdev</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bnad</span><span class="o">-&gt;</span><span class="n">conf_mutex</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">bnad</span><span class="o">-&gt;</span><span class="n">num_rx</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bnad</span><span class="o">-&gt;</span><span class="n">rx_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rx</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="n">bnad_destroy_rx</span><span class="p">(</span><span class="n">bnad</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="n">current_err</span> <span class="o">=</span> <span class="n">bnad_setup_rx</span><span class="p">(</span><span class="n">bnad</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">current_err</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">err</span><span class="p">)</span>
				<span class="n">err</span> <span class="o">=</span> <span class="n">current_err</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span> <span class="o">&amp;&amp;</span> <span class="n">bnad</span><span class="o">-&gt;</span><span class="n">rx_info</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">rx</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* restore rx configuration */</span>
			<span class="n">bnad_restore_vlans</span><span class="p">(</span><span class="n">bnad</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">bnad_enable_default_bcast</span><span class="p">(</span><span class="n">bnad</span><span class="p">);</span>
			<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bnad</span><span class="o">-&gt;</span><span class="n">bna_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="n">bnad_mac_addr_set_locked</span><span class="p">(</span><span class="n">bnad</span><span class="p">,</span> <span class="n">netdev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">);</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bnad</span><span class="o">-&gt;</span><span class="n">bna_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="n">bnad</span><span class="o">-&gt;</span><span class="n">cfg_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">BNAD_CF_ALLMULTI</span> <span class="o">|</span>
					     <span class="n">BNAD_CF_PROMISC</span><span class="p">);</span>
			<span class="n">bnad_set_rx_mode</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ringparam</span><span class="o">-&gt;</span><span class="n">tx_pending</span> <span class="o">!=</span> <span class="n">bnad</span><span class="o">-&gt;</span><span class="n">txq_depth</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bnad</span><span class="o">-&gt;</span><span class="n">txq_depth</span> <span class="o">=</span> <span class="n">ringparam</span><span class="o">-&gt;</span><span class="n">tx_pending</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">netif_running</span><span class="p">(</span><span class="n">netdev</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bnad</span><span class="o">-&gt;</span><span class="n">conf_mutex</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">bnad</span><span class="o">-&gt;</span><span class="n">num_tx</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bnad</span><span class="o">-&gt;</span><span class="n">tx_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">tx</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="n">bnad_destroy_tx</span><span class="p">(</span><span class="n">bnad</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="n">current_err</span> <span class="o">=</span> <span class="n">bnad_setup_tx</span><span class="p">(</span><span class="n">bnad</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">current_err</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">err</span><span class="p">)</span>
				<span class="n">err</span> <span class="o">=</span> <span class="n">current_err</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bnad</span><span class="o">-&gt;</span><span class="n">conf_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bnad_get_pauseparam</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span>
		    <span class="k">struct</span> <span class="n">ethtool_pauseparam</span> <span class="o">*</span><span class="n">pauseparam</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnad</span> <span class="o">*</span><span class="n">bnad</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>

	<span class="n">pauseparam</span><span class="o">-&gt;</span><span class="n">autoneg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pauseparam</span><span class="o">-&gt;</span><span class="n">rx_pause</span> <span class="o">=</span> <span class="n">bnad</span><span class="o">-&gt;</span><span class="n">bna</span><span class="p">.</span><span class="n">enet</span><span class="p">.</span><span class="n">pause_config</span><span class="p">.</span><span class="n">rx_pause</span><span class="p">;</span>
	<span class="n">pauseparam</span><span class="o">-&gt;</span><span class="n">tx_pause</span> <span class="o">=</span> <span class="n">bnad</span><span class="o">-&gt;</span><span class="n">bna</span><span class="p">.</span><span class="n">enet</span><span class="p">.</span><span class="n">pause_config</span><span class="p">.</span><span class="n">tx_pause</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">bnad_set_pauseparam</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span>
		    <span class="k">struct</span> <span class="n">ethtool_pauseparam</span> <span class="o">*</span><span class="n">pauseparam</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnad</span> <span class="o">*</span><span class="n">bnad</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">bna_pause_config</span> <span class="n">pause_config</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pauseparam</span><span class="o">-&gt;</span><span class="n">autoneg</span> <span class="o">==</span> <span class="n">AUTONEG_ENABLE</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bnad</span><span class="o">-&gt;</span><span class="n">conf_mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pauseparam</span><span class="o">-&gt;</span><span class="n">rx_pause</span> <span class="o">!=</span> <span class="n">bnad</span><span class="o">-&gt;</span><span class="n">bna</span><span class="p">.</span><span class="n">enet</span><span class="p">.</span><span class="n">pause_config</span><span class="p">.</span><span class="n">rx_pause</span> <span class="o">||</span>
	    <span class="n">pauseparam</span><span class="o">-&gt;</span><span class="n">tx_pause</span> <span class="o">!=</span> <span class="n">bnad</span><span class="o">-&gt;</span><span class="n">bna</span><span class="p">.</span><span class="n">enet</span><span class="p">.</span><span class="n">pause_config</span><span class="p">.</span><span class="n">tx_pause</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pause_config</span><span class="p">.</span><span class="n">rx_pause</span> <span class="o">=</span> <span class="n">pauseparam</span><span class="o">-&gt;</span><span class="n">rx_pause</span><span class="p">;</span>
		<span class="n">pause_config</span><span class="p">.</span><span class="n">tx_pause</span> <span class="o">=</span> <span class="n">pauseparam</span><span class="o">-&gt;</span><span class="n">tx_pause</span><span class="p">;</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bnad</span><span class="o">-&gt;</span><span class="n">bna_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">bna_enet_pause_config</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bnad</span><span class="o">-&gt;</span><span class="n">bna</span><span class="p">.</span><span class="n">enet</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pause_config</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bnad</span><span class="o">-&gt;</span><span class="n">bna_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bnad</span><span class="o">-&gt;</span><span class="n">conf_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bnad_get_strings</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">stringset</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">string</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnad</span> <span class="o">*</span><span class="n">bnad</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">q_num</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">bmap</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bnad</span><span class="o">-&gt;</span><span class="n">conf_mutex</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">stringset</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ETH_SS_STATS</span>:
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">BNAD_ETHTOOL_STATS_NUM</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">strlen</span><span class="p">(</span><span class="n">bnad_net_stats_strings</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">&lt;</span>
				   <span class="n">ETH_GSTRING_LEN</span><span class="p">));</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="n">bnad_net_stats_strings</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
			       <span class="n">ETH_GSTRING_LEN</span><span class="p">);</span>
			<span class="n">string</span> <span class="o">+=</span> <span class="n">ETH_GSTRING_LEN</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">bmap</span> <span class="o">=</span> <span class="n">bna_tx_rid_mask</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bnad</span><span class="o">-&gt;</span><span class="n">bna</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">bmap</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">bmap</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">sprintf</span><span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="s">&quot;txf%d_ucast_octets&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
				<span class="n">string</span> <span class="o">+=</span> <span class="n">ETH_GSTRING_LEN</span><span class="p">;</span>
				<span class="n">sprintf</span><span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="s">&quot;txf%d_ucast&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
				<span class="n">string</span> <span class="o">+=</span> <span class="n">ETH_GSTRING_LEN</span><span class="p">;</span>
				<span class="n">sprintf</span><span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="s">&quot;txf%d_ucast_vlan&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
				<span class="n">string</span> <span class="o">+=</span> <span class="n">ETH_GSTRING_LEN</span><span class="p">;</span>
				<span class="n">sprintf</span><span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="s">&quot;txf%d_mcast_octets&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
				<span class="n">string</span> <span class="o">+=</span> <span class="n">ETH_GSTRING_LEN</span><span class="p">;</span>
				<span class="n">sprintf</span><span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="s">&quot;txf%d_mcast&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
				<span class="n">string</span> <span class="o">+=</span> <span class="n">ETH_GSTRING_LEN</span><span class="p">;</span>
				<span class="n">sprintf</span><span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="s">&quot;txf%d_mcast_vlan&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
				<span class="n">string</span> <span class="o">+=</span> <span class="n">ETH_GSTRING_LEN</span><span class="p">;</span>
				<span class="n">sprintf</span><span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="s">&quot;txf%d_bcast_octets&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
				<span class="n">string</span> <span class="o">+=</span> <span class="n">ETH_GSTRING_LEN</span><span class="p">;</span>
				<span class="n">sprintf</span><span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="s">&quot;txf%d_bcast&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
				<span class="n">string</span> <span class="o">+=</span> <span class="n">ETH_GSTRING_LEN</span><span class="p">;</span>
				<span class="n">sprintf</span><span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="s">&quot;txf%d_bcast_vlan&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
				<span class="n">string</span> <span class="o">+=</span> <span class="n">ETH_GSTRING_LEN</span><span class="p">;</span>
				<span class="n">sprintf</span><span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="s">&quot;txf%d_errors&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
				<span class="n">string</span> <span class="o">+=</span> <span class="n">ETH_GSTRING_LEN</span><span class="p">;</span>
				<span class="n">sprintf</span><span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="s">&quot;txf%d_filter_vlan&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
				<span class="n">string</span> <span class="o">+=</span> <span class="n">ETH_GSTRING_LEN</span><span class="p">;</span>
				<span class="n">sprintf</span><span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="s">&quot;txf%d_filter_mac_sa&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
				<span class="n">string</span> <span class="o">+=</span> <span class="n">ETH_GSTRING_LEN</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">bmap</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">bmap</span> <span class="o">=</span> <span class="n">bna_rx_rid_mask</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bnad</span><span class="o">-&gt;</span><span class="n">bna</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">bmap</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">bmap</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">sprintf</span><span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="s">&quot;rxf%d_ucast_octets&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
				<span class="n">string</span> <span class="o">+=</span> <span class="n">ETH_GSTRING_LEN</span><span class="p">;</span>
				<span class="n">sprintf</span><span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="s">&quot;rxf%d_ucast&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
				<span class="n">string</span> <span class="o">+=</span> <span class="n">ETH_GSTRING_LEN</span><span class="p">;</span>
				<span class="n">sprintf</span><span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="s">&quot;rxf%d_ucast_vlan&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
				<span class="n">string</span> <span class="o">+=</span> <span class="n">ETH_GSTRING_LEN</span><span class="p">;</span>
				<span class="n">sprintf</span><span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="s">&quot;rxf%d_mcast_octets&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
				<span class="n">string</span> <span class="o">+=</span> <span class="n">ETH_GSTRING_LEN</span><span class="p">;</span>
				<span class="n">sprintf</span><span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="s">&quot;rxf%d_mcast&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
				<span class="n">string</span> <span class="o">+=</span> <span class="n">ETH_GSTRING_LEN</span><span class="p">;</span>
				<span class="n">sprintf</span><span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="s">&quot;rxf%d_mcast_vlan&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
				<span class="n">string</span> <span class="o">+=</span> <span class="n">ETH_GSTRING_LEN</span><span class="p">;</span>
				<span class="n">sprintf</span><span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="s">&quot;rxf%d_bcast_octets&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
				<span class="n">string</span> <span class="o">+=</span> <span class="n">ETH_GSTRING_LEN</span><span class="p">;</span>
				<span class="n">sprintf</span><span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="s">&quot;rxf%d_bcast&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
				<span class="n">string</span> <span class="o">+=</span> <span class="n">ETH_GSTRING_LEN</span><span class="p">;</span>
				<span class="n">sprintf</span><span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="s">&quot;rxf%d_bcast_vlan&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
				<span class="n">string</span> <span class="o">+=</span> <span class="n">ETH_GSTRING_LEN</span><span class="p">;</span>
				<span class="n">sprintf</span><span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="s">&quot;rxf%d_frame_drops&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
				<span class="n">string</span> <span class="o">+=</span> <span class="n">ETH_GSTRING_LEN</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">bmap</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">q_num</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">bnad</span><span class="o">-&gt;</span><span class="n">num_rx</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bnad</span><span class="o">-&gt;</span><span class="n">rx_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rx</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">bnad</span><span class="o">-&gt;</span><span class="n">num_rxp_per_rx</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">sprintf</span><span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="s">&quot;cq%d_producer_index&quot;</span><span class="p">,</span> <span class="n">q_num</span><span class="p">);</span>
				<span class="n">string</span> <span class="o">+=</span> <span class="n">ETH_GSTRING_LEN</span><span class="p">;</span>
				<span class="n">sprintf</span><span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="s">&quot;cq%d_consumer_index&quot;</span><span class="p">,</span> <span class="n">q_num</span><span class="p">);</span>
				<span class="n">string</span> <span class="o">+=</span> <span class="n">ETH_GSTRING_LEN</span><span class="p">;</span>
				<span class="n">sprintf</span><span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="s">&quot;cq%d_hw_producer_index&quot;</span><span class="p">,</span>
					<span class="n">q_num</span><span class="p">);</span>
				<span class="n">string</span> <span class="o">+=</span> <span class="n">ETH_GSTRING_LEN</span><span class="p">;</span>
				<span class="n">sprintf</span><span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="s">&quot;cq%d_intr&quot;</span><span class="p">,</span> <span class="n">q_num</span><span class="p">);</span>
				<span class="n">string</span> <span class="o">+=</span> <span class="n">ETH_GSTRING_LEN</span><span class="p">;</span>
				<span class="n">sprintf</span><span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="s">&quot;cq%d_poll&quot;</span><span class="p">,</span> <span class="n">q_num</span><span class="p">);</span>
				<span class="n">string</span> <span class="o">+=</span> <span class="n">ETH_GSTRING_LEN</span><span class="p">;</span>
				<span class="n">sprintf</span><span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="s">&quot;cq%d_schedule&quot;</span><span class="p">,</span> <span class="n">q_num</span><span class="p">);</span>
				<span class="n">string</span> <span class="o">+=</span> <span class="n">ETH_GSTRING_LEN</span><span class="p">;</span>
				<span class="n">sprintf</span><span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="s">&quot;cq%d_keep_poll&quot;</span><span class="p">,</span> <span class="n">q_num</span><span class="p">);</span>
				<span class="n">string</span> <span class="o">+=</span> <span class="n">ETH_GSTRING_LEN</span><span class="p">;</span>
				<span class="n">sprintf</span><span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="s">&quot;cq%d_complete&quot;</span><span class="p">,</span> <span class="n">q_num</span><span class="p">);</span>
				<span class="n">string</span> <span class="o">+=</span> <span class="n">ETH_GSTRING_LEN</span><span class="p">;</span>
				<span class="n">q_num</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="n">q_num</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">bnad</span><span class="o">-&gt;</span><span class="n">num_rx</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bnad</span><span class="o">-&gt;</span><span class="n">rx_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rx</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">bnad</span><span class="o">-&gt;</span><span class="n">num_rxp_per_rx</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">sprintf</span><span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="s">&quot;rxq%d_packets&quot;</span><span class="p">,</span> <span class="n">q_num</span><span class="p">);</span>
				<span class="n">string</span> <span class="o">+=</span> <span class="n">ETH_GSTRING_LEN</span><span class="p">;</span>
				<span class="n">sprintf</span><span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="s">&quot;rxq%d_bytes&quot;</span><span class="p">,</span> <span class="n">q_num</span><span class="p">);</span>
				<span class="n">string</span> <span class="o">+=</span> <span class="n">ETH_GSTRING_LEN</span><span class="p">;</span>
				<span class="n">sprintf</span><span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="s">&quot;rxq%d_packets_with_error&quot;</span><span class="p">,</span>
								<span class="n">q_num</span><span class="p">);</span>
				<span class="n">string</span> <span class="o">+=</span> <span class="n">ETH_GSTRING_LEN</span><span class="p">;</span>
				<span class="n">sprintf</span><span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="s">&quot;rxq%d_allocbuf_failed&quot;</span><span class="p">,</span> <span class="n">q_num</span><span class="p">);</span>
				<span class="n">string</span> <span class="o">+=</span> <span class="n">ETH_GSTRING_LEN</span><span class="p">;</span>
				<span class="n">sprintf</span><span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="s">&quot;rxq%d_producer_index&quot;</span><span class="p">,</span> <span class="n">q_num</span><span class="p">);</span>
				<span class="n">string</span> <span class="o">+=</span> <span class="n">ETH_GSTRING_LEN</span><span class="p">;</span>
				<span class="n">sprintf</span><span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="s">&quot;rxq%d_consumer_index&quot;</span><span class="p">,</span> <span class="n">q_num</span><span class="p">);</span>
				<span class="n">string</span> <span class="o">+=</span> <span class="n">ETH_GSTRING_LEN</span><span class="p">;</span>
				<span class="n">q_num</span><span class="o">++</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">bnad</span><span class="o">-&gt;</span><span class="n">rx_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rx_ctrl</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">ccb</span> <span class="o">&amp;&amp;</span>
					<span class="n">bnad</span><span class="o">-&gt;</span><span class="n">rx_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rx_ctrl</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">ccb</span><span class="o">-&gt;</span>
					<span class="n">rcb</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;&amp;</span>
					<span class="n">bnad</span><span class="o">-&gt;</span><span class="n">rx_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rx_ctrl</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">ccb</span><span class="o">-&gt;</span>
					<span class="n">rcb</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">rxq</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">sprintf</span><span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="s">&quot;rxq%d_packets&quot;</span><span class="p">,</span> <span class="n">q_num</span><span class="p">);</span>
					<span class="n">string</span> <span class="o">+=</span> <span class="n">ETH_GSTRING_LEN</span><span class="p">;</span>
					<span class="n">sprintf</span><span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="s">&quot;rxq%d_bytes&quot;</span><span class="p">,</span> <span class="n">q_num</span><span class="p">);</span>
					<span class="n">string</span> <span class="o">+=</span> <span class="n">ETH_GSTRING_LEN</span><span class="p">;</span>
					<span class="n">sprintf</span><span class="p">(</span><span class="n">string</span><span class="p">,</span>
					<span class="s">&quot;rxq%d_packets_with_error&quot;</span><span class="p">,</span> <span class="n">q_num</span><span class="p">);</span>
					<span class="n">string</span> <span class="o">+=</span> <span class="n">ETH_GSTRING_LEN</span><span class="p">;</span>
					<span class="n">sprintf</span><span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="s">&quot;rxq%d_allocbuf_failed&quot;</span><span class="p">,</span>
								<span class="n">q_num</span><span class="p">);</span>
					<span class="n">string</span> <span class="o">+=</span> <span class="n">ETH_GSTRING_LEN</span><span class="p">;</span>
					<span class="n">sprintf</span><span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="s">&quot;rxq%d_producer_index&quot;</span><span class="p">,</span>
								<span class="n">q_num</span><span class="p">);</span>
					<span class="n">string</span> <span class="o">+=</span> <span class="n">ETH_GSTRING_LEN</span><span class="p">;</span>
					<span class="n">sprintf</span><span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="s">&quot;rxq%d_consumer_index&quot;</span><span class="p">,</span>
								<span class="n">q_num</span><span class="p">);</span>
					<span class="n">string</span> <span class="o">+=</span> <span class="n">ETH_GSTRING_LEN</span><span class="p">;</span>
					<span class="n">q_num</span><span class="o">++</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="n">q_num</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">bnad</span><span class="o">-&gt;</span><span class="n">num_tx</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bnad</span><span class="o">-&gt;</span><span class="n">tx_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">tx</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">bnad</span><span class="o">-&gt;</span><span class="n">num_txq_per_tx</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">sprintf</span><span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="s">&quot;txq%d_packets&quot;</span><span class="p">,</span> <span class="n">q_num</span><span class="p">);</span>
				<span class="n">string</span> <span class="o">+=</span> <span class="n">ETH_GSTRING_LEN</span><span class="p">;</span>
				<span class="n">sprintf</span><span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="s">&quot;txq%d_bytes&quot;</span><span class="p">,</span> <span class="n">q_num</span><span class="p">);</span>
				<span class="n">string</span> <span class="o">+=</span> <span class="n">ETH_GSTRING_LEN</span><span class="p">;</span>
				<span class="n">sprintf</span><span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="s">&quot;txq%d_producer_index&quot;</span><span class="p">,</span> <span class="n">q_num</span><span class="p">);</span>
				<span class="n">string</span> <span class="o">+=</span> <span class="n">ETH_GSTRING_LEN</span><span class="p">;</span>
				<span class="n">sprintf</span><span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="s">&quot;txq%d_consumer_index&quot;</span><span class="p">,</span> <span class="n">q_num</span><span class="p">);</span>
				<span class="n">string</span> <span class="o">+=</span> <span class="n">ETH_GSTRING_LEN</span><span class="p">;</span>
				<span class="n">sprintf</span><span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="s">&quot;txq%d_hw_consumer_index&quot;</span><span class="p">,</span>
									<span class="n">q_num</span><span class="p">);</span>
				<span class="n">string</span> <span class="o">+=</span> <span class="n">ETH_GSTRING_LEN</span><span class="p">;</span>
				<span class="n">q_num</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bnad</span><span class="o">-&gt;</span><span class="n">conf_mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">bnad_get_stats_count_locked</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnad</span> <span class="o">*</span><span class="n">bnad</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">rxf_active_num</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">txf_active_num</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">bmap</span><span class="p">;</span>

	<span class="n">bmap</span> <span class="o">=</span> <span class="n">bna_tx_rid_mask</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bnad</span><span class="o">-&gt;</span><span class="n">bna</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">bmap</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bmap</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">txf_active_num</span><span class="o">++</span><span class="p">;</span>
		<span class="n">bmap</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">bmap</span> <span class="o">=</span> <span class="n">bna_rx_rid_mask</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bnad</span><span class="o">-&gt;</span><span class="n">bna</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">bmap</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bmap</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">rxf_active_num</span><span class="o">++</span><span class="p">;</span>
		<span class="n">bmap</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">count</span> <span class="o">=</span> <span class="n">BNAD_ETHTOOL_STATS_NUM</span> <span class="o">+</span>
		<span class="n">txf_active_num</span> <span class="o">*</span> <span class="n">BNAD_NUM_TXF_COUNTERS</span> <span class="o">+</span>
		<span class="n">rxf_active_num</span> <span class="o">*</span> <span class="n">BNAD_NUM_RXF_COUNTERS</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">bnad</span><span class="o">-&gt;</span><span class="n">num_rx</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bnad</span><span class="o">-&gt;</span><span class="n">rx_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rx</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">count</span> <span class="o">+=</span> <span class="n">bnad</span><span class="o">-&gt;</span><span class="n">num_rxp_per_rx</span> <span class="o">*</span> <span class="n">BNAD_NUM_CQ_COUNTERS</span><span class="p">;</span>
		<span class="n">count</span> <span class="o">+=</span> <span class="n">bnad</span><span class="o">-&gt;</span><span class="n">num_rxp_per_rx</span> <span class="o">*</span> <span class="n">BNAD_NUM_RXQ_COUNTERS</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">bnad</span><span class="o">-&gt;</span><span class="n">num_rxp_per_rx</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">bnad</span><span class="o">-&gt;</span><span class="n">rx_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rx_ctrl</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">ccb</span> <span class="o">&amp;&amp;</span>
				<span class="n">bnad</span><span class="o">-&gt;</span><span class="n">rx_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rx_ctrl</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">ccb</span><span class="o">-&gt;</span><span class="n">rcb</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;&amp;</span>
				<span class="n">bnad</span><span class="o">-&gt;</span><span class="n">rx_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rx_ctrl</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">ccb</span><span class="o">-&gt;</span><span class="n">rcb</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">rxq</span><span class="p">)</span>
				<span class="n">count</span> <span class="o">+=</span>  <span class="n">BNAD_NUM_RXQ_COUNTERS</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">bnad</span><span class="o">-&gt;</span><span class="n">num_tx</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bnad</span><span class="o">-&gt;</span><span class="n">tx_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">tx</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">count</span> <span class="o">+=</span> <span class="n">bnad</span><span class="o">-&gt;</span><span class="n">num_txq_per_tx</span> <span class="o">*</span> <span class="n">BNAD_NUM_TXQ_COUNTERS</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">bnad_per_q_stats_fill</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnad</span> <span class="o">*</span><span class="n">bnad</span><span class="p">,</span> <span class="n">u64</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bna_rcb</span> <span class="o">*</span><span class="n">rcb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bna_tcb</span> <span class="o">*</span><span class="n">tcb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">bnad</span><span class="o">-&gt;</span><span class="n">num_rx</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bnad</span><span class="o">-&gt;</span><span class="n">rx_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rx</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">bnad</span><span class="o">-&gt;</span><span class="n">num_rxp_per_rx</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">bnad</span><span class="o">-&gt;</span><span class="n">rx_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rx_ctrl</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">ccb</span> <span class="o">&amp;&amp;</span>
				<span class="n">bnad</span><span class="o">-&gt;</span><span class="n">rx_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rx_ctrl</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">ccb</span><span class="o">-&gt;</span><span class="n">rcb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;&amp;</span>
				<span class="n">bnad</span><span class="o">-&gt;</span><span class="n">rx_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rx_ctrl</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">ccb</span><span class="o">-&gt;</span><span class="n">rcb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">rxq</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">buf</span><span class="p">[</span><span class="n">bi</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">bnad</span><span class="o">-&gt;</span><span class="n">rx_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rx_ctrl</span><span class="p">[</span><span class="n">j</span><span class="p">].</span>
						<span class="n">ccb</span><span class="o">-&gt;</span><span class="n">producer_index</span><span class="p">;</span>
				<span class="n">buf</span><span class="p">[</span><span class="n">bi</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* ccb-&gt;consumer_index */</span>
				<span class="n">buf</span><span class="p">[</span><span class="n">bi</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">bnad</span><span class="o">-&gt;</span><span class="n">rx_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rx_ctrl</span><span class="p">[</span><span class="n">j</span><span class="p">].</span>
						<span class="n">ccb</span><span class="o">-&gt;</span><span class="n">hw_producer_index</span><span class="p">);</span>

				<span class="n">buf</span><span class="p">[</span><span class="n">bi</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">bnad</span><span class="o">-&gt;</span><span class="n">rx_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span>
						<span class="n">rx_ctrl</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">rx_intr_ctr</span><span class="p">;</span>
				<span class="n">buf</span><span class="p">[</span><span class="n">bi</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">bnad</span><span class="o">-&gt;</span><span class="n">rx_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span>
						<span class="n">rx_ctrl</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">rx_poll_ctr</span><span class="p">;</span>
				<span class="n">buf</span><span class="p">[</span><span class="n">bi</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">bnad</span><span class="o">-&gt;</span><span class="n">rx_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span>
						<span class="n">rx_ctrl</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">rx_schedule</span><span class="p">;</span>
				<span class="n">buf</span><span class="p">[</span><span class="n">bi</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">bnad</span><span class="o">-&gt;</span><span class="n">rx_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span>
						<span class="n">rx_ctrl</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">rx_keep_poll</span><span class="p">;</span>
				<span class="n">buf</span><span class="p">[</span><span class="n">bi</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">bnad</span><span class="o">-&gt;</span><span class="n">rx_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span>
						<span class="n">rx_ctrl</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">rx_complete</span><span class="p">;</span>
			<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">bnad</span><span class="o">-&gt;</span><span class="n">num_rx</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bnad</span><span class="o">-&gt;</span><span class="n">rx_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rx</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">bnad</span><span class="o">-&gt;</span><span class="n">num_rxp_per_rx</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">bnad</span><span class="o">-&gt;</span><span class="n">rx_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rx_ctrl</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">ccb</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">bnad</span><span class="o">-&gt;</span><span class="n">rx_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rx_ctrl</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">ccb</span><span class="o">-&gt;</span><span class="n">rcb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;&amp;</span>
					<span class="n">bnad</span><span class="o">-&gt;</span><span class="n">rx_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rx_ctrl</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">ccb</span><span class="o">-&gt;</span>
					<span class="n">rcb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">rxq</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">rcb</span> <span class="o">=</span> <span class="n">bnad</span><span class="o">-&gt;</span><span class="n">rx_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rx_ctrl</span><span class="p">[</span><span class="n">j</span><span class="p">].</span>
							<span class="n">ccb</span><span class="o">-&gt;</span><span class="n">rcb</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
					<span class="n">buf</span><span class="p">[</span><span class="n">bi</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">rcb</span><span class="o">-&gt;</span><span class="n">rxq</span><span class="o">-&gt;</span><span class="n">rx_packets</span><span class="p">;</span>
					<span class="n">buf</span><span class="p">[</span><span class="n">bi</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">rcb</span><span class="o">-&gt;</span><span class="n">rxq</span><span class="o">-&gt;</span><span class="n">rx_bytes</span><span class="p">;</span>
					<span class="n">buf</span><span class="p">[</span><span class="n">bi</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">rcb</span><span class="o">-&gt;</span><span class="n">rxq</span><span class="o">-&gt;</span>
							<span class="n">rx_packets_with_error</span><span class="p">;</span>
					<span class="n">buf</span><span class="p">[</span><span class="n">bi</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">rcb</span><span class="o">-&gt;</span><span class="n">rxq</span><span class="o">-&gt;</span>
							<span class="n">rxbuf_alloc_failed</span><span class="p">;</span>
					<span class="n">buf</span><span class="p">[</span><span class="n">bi</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">rcb</span><span class="o">-&gt;</span><span class="n">producer_index</span><span class="p">;</span>
					<span class="n">buf</span><span class="p">[</span><span class="n">bi</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">rcb</span><span class="o">-&gt;</span><span class="n">consumer_index</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">bnad</span><span class="o">-&gt;</span><span class="n">rx_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rx_ctrl</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">ccb</span><span class="o">-&gt;</span><span class="n">rcb</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;&amp;</span>
					<span class="n">bnad</span><span class="o">-&gt;</span><span class="n">rx_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rx_ctrl</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">ccb</span><span class="o">-&gt;</span>
					<span class="n">rcb</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">rxq</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">rcb</span> <span class="o">=</span> <span class="n">bnad</span><span class="o">-&gt;</span><span class="n">rx_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rx_ctrl</span><span class="p">[</span><span class="n">j</span><span class="p">].</span>
								<span class="n">ccb</span><span class="o">-&gt;</span><span class="n">rcb</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
					<span class="n">buf</span><span class="p">[</span><span class="n">bi</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">rcb</span><span class="o">-&gt;</span><span class="n">rxq</span><span class="o">-&gt;</span><span class="n">rx_packets</span><span class="p">;</span>
					<span class="n">buf</span><span class="p">[</span><span class="n">bi</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">rcb</span><span class="o">-&gt;</span><span class="n">rxq</span><span class="o">-&gt;</span><span class="n">rx_bytes</span><span class="p">;</span>
					<span class="n">buf</span><span class="p">[</span><span class="n">bi</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">rcb</span><span class="o">-&gt;</span><span class="n">rxq</span><span class="o">-&gt;</span>
							<span class="n">rx_packets_with_error</span><span class="p">;</span>
					<span class="n">buf</span><span class="p">[</span><span class="n">bi</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">rcb</span><span class="o">-&gt;</span><span class="n">rxq</span><span class="o">-&gt;</span>
							<span class="n">rxbuf_alloc_failed</span><span class="p">;</span>
					<span class="n">buf</span><span class="p">[</span><span class="n">bi</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">rcb</span><span class="o">-&gt;</span><span class="n">producer_index</span><span class="p">;</span>
					<span class="n">buf</span><span class="p">[</span><span class="n">bi</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">rcb</span><span class="o">-&gt;</span><span class="n">consumer_index</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">bnad</span><span class="o">-&gt;</span><span class="n">num_tx</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bnad</span><span class="o">-&gt;</span><span class="n">tx_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">tx</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">bnad</span><span class="o">-&gt;</span><span class="n">num_txq_per_tx</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">bnad</span><span class="o">-&gt;</span><span class="n">tx_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">tcb</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">&amp;&amp;</span>
				<span class="n">bnad</span><span class="o">-&gt;</span><span class="n">tx_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">tcb</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">txq</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">tcb</span> <span class="o">=</span> <span class="n">bnad</span><span class="o">-&gt;</span><span class="n">tx_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">tcb</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>
				<span class="n">buf</span><span class="p">[</span><span class="n">bi</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">tcb</span><span class="o">-&gt;</span><span class="n">txq</span><span class="o">-&gt;</span><span class="n">tx_packets</span><span class="p">;</span>
				<span class="n">buf</span><span class="p">[</span><span class="n">bi</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">tcb</span><span class="o">-&gt;</span><span class="n">txq</span><span class="o">-&gt;</span><span class="n">tx_bytes</span><span class="p">;</span>
				<span class="n">buf</span><span class="p">[</span><span class="n">bi</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">tcb</span><span class="o">-&gt;</span><span class="n">producer_index</span><span class="p">;</span>
				<span class="n">buf</span><span class="p">[</span><span class="n">bi</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">tcb</span><span class="o">-&gt;</span><span class="n">consumer_index</span><span class="p">;</span>
				<span class="n">buf</span><span class="p">[</span><span class="n">bi</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">tcb</span><span class="o">-&gt;</span><span class="n">hw_consumer_index</span><span class="p">);</span>
			<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">bi</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bnad_get_ethtool_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ethtool_stats</span> <span class="o">*</span><span class="n">stats</span><span class="p">,</span>
		       <span class="n">u64</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnad</span> <span class="o">*</span><span class="n">bnad</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">bi</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rtnl_link_stats64</span> <span class="o">*</span><span class="n">net_stats64</span><span class="p">;</span>
	<span class="n">u64</span> <span class="o">*</span><span class="n">stats64</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">bmap</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bnad</span><span class="o">-&gt;</span><span class="n">conf_mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bnad_get_stats_count_locked</span><span class="p">(</span><span class="n">netdev</span><span class="p">)</span> <span class="o">!=</span> <span class="n">stats</span><span class="o">-&gt;</span><span class="n">n_stats</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bnad</span><span class="o">-&gt;</span><span class="n">conf_mutex</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Used bna_lock to sync reads from bna_stats, which is written</span>
<span class="cm">	 * under the same lock</span>
<span class="cm">	 */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bnad</span><span class="o">-&gt;</span><span class="n">bna_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">bi</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">stats</span><span class="o">-&gt;</span><span class="n">n_stats</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u64</span><span class="p">));</span>

	<span class="n">net_stats64</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">rtnl_link_stats64</span> <span class="o">*</span><span class="p">)</span><span class="n">buf</span><span class="p">;</span>
	<span class="n">bnad_netdev_qstats_fill</span><span class="p">(</span><span class="n">bnad</span><span class="p">,</span> <span class="n">net_stats64</span><span class="p">);</span>
	<span class="n">bnad_netdev_hwstats_fill</span><span class="p">(</span><span class="n">bnad</span><span class="p">,</span> <span class="n">net_stats64</span><span class="p">);</span>

	<span class="n">bi</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">net_stats64</span><span class="p">)</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u64</span><span class="p">);</span>

	<span class="cm">/* Get netif_queue_stopped from stack */</span>
	<span class="n">bnad</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">drv_stats</span><span class="p">.</span><span class="n">netif_queue_stopped</span> <span class="o">=</span> <span class="n">netif_queue_stopped</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>

	<span class="cm">/* Fill driver stats into ethtool buffers */</span>
	<span class="n">stats64</span> <span class="o">=</span> <span class="p">(</span><span class="n">u64</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">bnad</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">drv_stats</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnad_drv_stats</span><span class="p">)</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u64</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">buf</span><span class="p">[</span><span class="n">bi</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">stats64</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

	<span class="cm">/* Fill hardware stats excluding the rxf/txf into ethtool bufs */</span>
	<span class="n">stats64</span> <span class="o">=</span> <span class="p">(</span><span class="n">u64</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">bnad</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">bna_stats</span><span class="o">-&gt;</span><span class="n">hw_stats</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	     <span class="n">i</span> <span class="o">&lt;</span> <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfi_enet_stats</span><span class="p">,</span> <span class="n">rxf_stats</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span>
		<span class="k">sizeof</span><span class="p">(</span><span class="n">u64</span><span class="p">);</span>
	     <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">buf</span><span class="p">[</span><span class="n">bi</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">stats64</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

	<span class="cm">/* Fill txf stats into ethtool buffers */</span>
	<span class="n">bmap</span> <span class="o">=</span> <span class="n">bna_tx_rid_mask</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bnad</span><span class="o">-&gt;</span><span class="n">bna</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">bmap</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bmap</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">stats64</span> <span class="o">=</span> <span class="p">(</span><span class="n">u64</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">bnad</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">bna_stats</span><span class="o">-&gt;</span>
						<span class="n">hw_stats</span><span class="p">.</span><span class="n">txf_stats</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfi_enet_stats_txf</span><span class="p">)</span> <span class="o">/</span>
					<span class="k">sizeof</span><span class="p">(</span><span class="n">u64</span><span class="p">);</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
				<span class="n">buf</span><span class="p">[</span><span class="n">bi</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">stats64</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>
		<span class="p">}</span>
		<span class="n">bmap</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*  Fill rxf stats into ethtool buffers */</span>
	<span class="n">bmap</span> <span class="o">=</span> <span class="n">bna_rx_rid_mask</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bnad</span><span class="o">-&gt;</span><span class="n">bna</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">bmap</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bmap</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">stats64</span> <span class="o">=</span> <span class="p">(</span><span class="n">u64</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">bnad</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">bna_stats</span><span class="o">-&gt;</span>
						<span class="n">hw_stats</span><span class="p">.</span><span class="n">rxf_stats</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfi_enet_stats_rxf</span><span class="p">)</span> <span class="o">/</span>
					<span class="k">sizeof</span><span class="p">(</span><span class="n">u64</span><span class="p">);</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
				<span class="n">buf</span><span class="p">[</span><span class="n">bi</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">stats64</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>
		<span class="p">}</span>
		<span class="n">bmap</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Fill per Q stats into ethtool buffers */</span>
	<span class="n">bi</span> <span class="o">=</span> <span class="n">bnad_per_q_stats_fill</span><span class="p">(</span><span class="n">bnad</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">bi</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bnad</span><span class="o">-&gt;</span><span class="n">bna_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bnad</span><span class="o">-&gt;</span><span class="n">conf_mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">bnad_get_sset_count</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">sset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">sset</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ETH_SS_STATS</span>:
		<span class="k">return</span> <span class="n">bnad_get_stats_count_locked</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span>
<span class="nf">bnad_get_flash_partition_by_offset</span><span class="p">(</span><span class="k">struct</span> <span class="n">bnad</span> <span class="o">*</span><span class="n">bnad</span><span class="p">,</span> <span class="n">u32</span> <span class="n">offset</span><span class="p">,</span>
				<span class="n">u32</span> <span class="o">*</span><span class="n">base_offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfa_flash_attr</span> <span class="o">*</span><span class="n">flash_attr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bnad_iocmd_comp</span> <span class="n">fcomp</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">i</span><span class="p">,</span> <span class="n">flash_part</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">flash_attr</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_flash_attr</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">flash_attr</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">fcomp</span><span class="p">.</span><span class="n">bnad</span> <span class="o">=</span> <span class="n">bnad</span><span class="p">;</span>
	<span class="n">fcomp</span><span class="p">.</span><span class="n">comp_status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">init_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fcomp</span><span class="p">.</span><span class="n">comp</span><span class="p">);</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bnad</span><span class="o">-&gt;</span><span class="n">bna_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">bfa_nw_flash_get_attr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bnad</span><span class="o">-&gt;</span><span class="n">bna</span><span class="p">.</span><span class="n">flash</span><span class="p">,</span> <span class="n">flash_attr</span><span class="p">,</span>
				<span class="n">bnad_cb_completion</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fcomp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="n">BFA_STATUS_OK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bnad</span><span class="o">-&gt;</span><span class="n">bna_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">flash_attr</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bnad</span><span class="o">-&gt;</span><span class="n">bna_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">wait_for_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fcomp</span><span class="p">.</span><span class="n">comp</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">fcomp</span><span class="p">.</span><span class="n">comp_status</span><span class="p">;</span>

	<span class="cm">/* Check for the flash type &amp; base offset value */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="n">BFA_STATUS_OK</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">flash_attr</span><span class="o">-&gt;</span><span class="n">npart</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">offset</span> <span class="o">&gt;=</span> <span class="n">flash_attr</span><span class="o">-&gt;</span><span class="n">part</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">part_off</span> <span class="o">&amp;&amp;</span>
			    <span class="n">offset</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">flash_attr</span><span class="o">-&gt;</span><span class="n">part</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">part_off</span> <span class="o">+</span>
				      <span class="n">flash_attr</span><span class="o">-&gt;</span><span class="n">part</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">part_size</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">flash_part</span> <span class="o">=</span> <span class="n">flash_attr</span><span class="o">-&gt;</span><span class="n">part</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">part_type</span><span class="p">;</span>
				<span class="o">*</span><span class="n">base_offset</span> <span class="o">=</span> <span class="n">flash_attr</span><span class="o">-&gt;</span><span class="n">part</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">part_off</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">flash_attr</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">flash_part</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">bnad_get_eeprom_len</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">BFA_TOTAL_FLASH_SIZE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">bnad_get_eeprom</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ethtool_eeprom</span> <span class="o">*</span><span class="n">eeprom</span><span class="p">,</span>
		<span class="n">u8</span> <span class="o">*</span><span class="n">bytes</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnad</span> <span class="o">*</span><span class="n">bnad</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">bnad_iocmd_comp</span> <span class="n">fcomp</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">flash_part</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">base_offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Check if the flash read request is valid */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">eeprom</span><span class="o">-&gt;</span><span class="n">magic</span> <span class="o">!=</span> <span class="p">(</span><span class="n">bnad</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">vendor</span> <span class="o">|</span>
			     <span class="p">(</span><span class="n">bnad</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="cm">/* Query the flash partition based on the offset */</span>
	<span class="n">flash_part</span> <span class="o">=</span> <span class="n">bnad_get_flash_partition_by_offset</span><span class="p">(</span><span class="n">bnad</span><span class="p">,</span>
				<span class="n">eeprom</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">base_offset</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">flash_part</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="n">fcomp</span><span class="p">.</span><span class="n">bnad</span> <span class="o">=</span> <span class="n">bnad</span><span class="p">;</span>
	<span class="n">fcomp</span><span class="p">.</span><span class="n">comp_status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">init_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fcomp</span><span class="p">.</span><span class="n">comp</span><span class="p">);</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bnad</span><span class="o">-&gt;</span><span class="n">bna_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">bfa_nw_flash_read_part</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bnad</span><span class="o">-&gt;</span><span class="n">bna</span><span class="p">.</span><span class="n">flash</span><span class="p">,</span> <span class="n">flash_part</span><span class="p">,</span>
				<span class="n">bnad</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">bytes</span><span class="p">,</span> <span class="n">eeprom</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span>
				<span class="n">eeprom</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">-</span> <span class="n">base_offset</span><span class="p">,</span>
				<span class="n">bnad_cb_completion</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fcomp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="n">BFA_STATUS_OK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bnad</span><span class="o">-&gt;</span><span class="n">bna_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bnad</span><span class="o">-&gt;</span><span class="n">bna_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">wait_for_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fcomp</span><span class="p">.</span><span class="n">comp</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">fcomp</span><span class="p">.</span><span class="n">comp_status</span><span class="p">;</span>
<span class="nl">done:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">bnad_set_eeprom</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ethtool_eeprom</span> <span class="o">*</span><span class="n">eeprom</span><span class="p">,</span>
		<span class="n">u8</span> <span class="o">*</span><span class="n">bytes</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnad</span> <span class="o">*</span><span class="n">bnad</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">bnad_iocmd_comp</span> <span class="n">fcomp</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">flash_part</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">base_offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Check if the flash update request is valid */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">eeprom</span><span class="o">-&gt;</span><span class="n">magic</span> <span class="o">!=</span> <span class="p">(</span><span class="n">bnad</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">vendor</span> <span class="o">|</span>
			     <span class="p">(</span><span class="n">bnad</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/* Query the flash partition based on the offset */</span>
	<span class="n">flash_part</span> <span class="o">=</span> <span class="n">bnad_get_flash_partition_by_offset</span><span class="p">(</span><span class="n">bnad</span><span class="p">,</span>
				<span class="n">eeprom</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">base_offset</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">flash_part</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="n">fcomp</span><span class="p">.</span><span class="n">bnad</span> <span class="o">=</span> <span class="n">bnad</span><span class="p">;</span>
	<span class="n">fcomp</span><span class="p">.</span><span class="n">comp_status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">init_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fcomp</span><span class="p">.</span><span class="n">comp</span><span class="p">);</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bnad</span><span class="o">-&gt;</span><span class="n">bna_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">bfa_nw_flash_update_part</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bnad</span><span class="o">-&gt;</span><span class="n">bna</span><span class="p">.</span><span class="n">flash</span><span class="p">,</span> <span class="n">flash_part</span><span class="p">,</span>
				<span class="n">bnad</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">bytes</span><span class="p">,</span> <span class="n">eeprom</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span>
				<span class="n">eeprom</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">-</span> <span class="n">base_offset</span><span class="p">,</span>
				<span class="n">bnad_cb_completion</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fcomp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="n">BFA_STATUS_OK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bnad</span><span class="o">-&gt;</span><span class="n">bna_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bnad</span><span class="o">-&gt;</span><span class="n">bna_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">wait_for_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fcomp</span><span class="p">.</span><span class="n">comp</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">fcomp</span><span class="p">.</span><span class="n">comp_status</span><span class="p">;</span>
<span class="nl">done:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">bnad_flash_device</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ethtool_flash</span> <span class="o">*</span><span class="n">eflash</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bnad</span> <span class="o">*</span><span class="n">bnad</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">bnad_iocmd_comp</span> <span class="n">fcomp</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">firmware</span> <span class="o">*</span><span class="n">fw</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">request_firmware</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fw</span><span class="p">,</span> <span class="n">eflash</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bnad</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;BNA: Can&#39;t locate firmware %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">eflash</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">fcomp</span><span class="p">.</span><span class="n">bnad</span> <span class="o">=</span> <span class="n">bnad</span><span class="p">;</span>
	<span class="n">fcomp</span><span class="p">.</span><span class="n">comp_status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">init_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fcomp</span><span class="p">.</span><span class="n">comp</span><span class="p">);</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bnad</span><span class="o">-&gt;</span><span class="n">bna_lock</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">bfa_nw_flash_update_part</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bnad</span><span class="o">-&gt;</span><span class="n">bna</span><span class="p">.</span><span class="n">flash</span><span class="p">,</span> <span class="n">BFA_FLASH_PART_FWIMG</span><span class="p">,</span>
				<span class="n">bnad</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">fw</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">fw</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				<span class="n">bnad_cb_completion</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fcomp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="n">BFA_STATUS_OK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_warn</span><span class="p">(</span><span class="s">&quot;BNA: Flash update failed with err: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bnad</span><span class="o">-&gt;</span><span class="n">bna_lock</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bnad</span><span class="o">-&gt;</span><span class="n">bna_lock</span><span class="p">);</span>
	<span class="n">wait_for_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fcomp</span><span class="p">.</span><span class="n">comp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fcomp</span><span class="p">.</span><span class="n">comp_status</span> <span class="o">!=</span> <span class="n">BFA_STATUS_OK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="n">pr_warn</span><span class="p">(</span><span class="s">&quot;BNA: Firmware image update to flash failed with: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">fcomp</span><span class="p">.</span><span class="n">comp_status</span><span class="p">);</span>
	<span class="p">}</span>
<span class="nl">out:</span>
	<span class="n">release_firmware</span><span class="p">(</span><span class="n">fw</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ethtool_ops</span> <span class="n">bnad_ethtool_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">get_settings</span> <span class="o">=</span> <span class="n">bnad_get_settings</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_settings</span> <span class="o">=</span> <span class="n">bnad_set_settings</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_drvinfo</span> <span class="o">=</span> <span class="n">bnad_get_drvinfo</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_wol</span> <span class="o">=</span> <span class="n">bnad_get_wol</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_link</span> <span class="o">=</span> <span class="n">ethtool_op_get_link</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_coalesce</span> <span class="o">=</span> <span class="n">bnad_get_coalesce</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_coalesce</span> <span class="o">=</span> <span class="n">bnad_set_coalesce</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_ringparam</span> <span class="o">=</span> <span class="n">bnad_get_ringparam</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_ringparam</span> <span class="o">=</span> <span class="n">bnad_set_ringparam</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_pauseparam</span> <span class="o">=</span> <span class="n">bnad_get_pauseparam</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_pauseparam</span> <span class="o">=</span> <span class="n">bnad_set_pauseparam</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_strings</span> <span class="o">=</span> <span class="n">bnad_get_strings</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_ethtool_stats</span> <span class="o">=</span> <span class="n">bnad_get_ethtool_stats</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_sset_count</span> <span class="o">=</span> <span class="n">bnad_get_sset_count</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_eeprom_len</span> <span class="o">=</span> <span class="n">bnad_get_eeprom_len</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_eeprom</span> <span class="o">=</span> <span class="n">bnad_get_eeprom</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_eeprom</span> <span class="o">=</span> <span class="n">bnad_set_eeprom</span><span class="p">,</span>
	<span class="p">.</span><span class="n">flash_device</span> <span class="o">=</span> <span class="n">bnad_flash_device</span><span class="p">,</span>
<span class="p">};</span>

<span class="kt">void</span>
<span class="nf">bnad_set_ethtool_ops</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">SET_ETHTOOL_OPS</span><span class="p">(</span><span class="n">netdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bnad_ethtool_ops</span><span class="p">);</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:5}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../../javascript/docco.min.js"></script>
</html>
