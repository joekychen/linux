<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › ethernet › brocade › bna › bfa_ioc_ct.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../../index.html"></a><h1>bfa_ioc_ct.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Linux network driver for Brocade Converged Network Adapter.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify it</span>
<span class="cm"> * under the terms of the GNU General Public License (GPL) Version 2 as</span>
<span class="cm"> * published by the Free Software Foundation</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful, but</span>
<span class="cm"> * WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU</span>
<span class="cm"> * General Public License for more details.</span>
<span class="cm"> */</span>
<span class="cm">/*</span>
<span class="cm"> * Copyright (c) 2005-2010 Brocade Communications Systems, Inc.</span>
<span class="cm"> * All rights reserved</span>
<span class="cm"> * www.brocade.com</span>
<span class="cm"> */</span>

<span class="cp">#include &quot;bfa_ioc.h&quot;</span>
<span class="cp">#include &quot;cna.h&quot;</span>
<span class="cp">#include &quot;bfi.h&quot;</span>
<span class="cp">#include &quot;bfi_reg.h&quot;</span>
<span class="cp">#include &quot;bfa_defs.h&quot;</span>

<span class="cp">#define bfa_ioc_ct_sync_pos(__ioc)	\</span>
<span class="cp">		((u32) (1 &lt;&lt; bfa_ioc_pcifn(__ioc)))</span>
<span class="cp">#define BFA_IOC_SYNC_REQD_SH		16</span>
<span class="cp">#define bfa_ioc_ct_get_sync_ackd(__val) (__val &amp; 0x0000ffff)</span>
<span class="cp">#define bfa_ioc_ct_clear_sync_ackd(__val) (__val &amp; 0xffff0000)</span>
<span class="cp">#define bfa_ioc_ct_get_sync_reqd(__val) (__val &gt;&gt; BFA_IOC_SYNC_REQD_SH)</span>
<span class="cp">#define bfa_ioc_ct_sync_reqd_pos(__ioc) \</span>
<span class="cp">		(bfa_ioc_ct_sync_pos(__ioc) &lt;&lt; BFA_IOC_SYNC_REQD_SH)</span>

<span class="cm">/*</span>
<span class="cm"> * forward declarations</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">bool</span> <span class="n">bfa_ioc_ct_firmware_lock</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_ioc</span> <span class="o">*</span><span class="n">ioc</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">bfa_ioc_ct_firmware_unlock</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_ioc</span> <span class="o">*</span><span class="n">ioc</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">bfa_ioc_ct_reg_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_ioc</span> <span class="o">*</span><span class="n">ioc</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">bfa_ioc_ct2_reg_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_ioc</span> <span class="o">*</span><span class="n">ioc</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">bfa_ioc_ct_map_port</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_ioc</span> <span class="o">*</span><span class="n">ioc</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">bfa_ioc_ct2_map_port</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_ioc</span> <span class="o">*</span><span class="n">ioc</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">bfa_ioc_ct_isr_mode_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_ioc</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="n">bool</span> <span class="n">msix</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">bfa_ioc_ct_notify_fail</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_ioc</span> <span class="o">*</span><span class="n">ioc</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">bfa_ioc_ct_ownership_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_ioc</span> <span class="o">*</span><span class="n">ioc</span><span class="p">);</span>
<span class="k">static</span> <span class="n">bool</span> <span class="n">bfa_ioc_ct_sync_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_ioc</span> <span class="o">*</span><span class="n">ioc</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">bfa_ioc_ct_sync_join</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_ioc</span> <span class="o">*</span><span class="n">ioc</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">bfa_ioc_ct_sync_leave</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_ioc</span> <span class="o">*</span><span class="n">ioc</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">bfa_ioc_ct_sync_ack</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_ioc</span> <span class="o">*</span><span class="n">ioc</span><span class="p">);</span>
<span class="k">static</span> <span class="n">bool</span> <span class="n">bfa_ioc_ct_sync_complete</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_ioc</span> <span class="o">*</span><span class="n">ioc</span><span class="p">);</span>
<span class="k">static</span> <span class="k">enum</span> <span class="n">bfa_status</span> <span class="n">bfa_ioc_ct_pll_init</span><span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">rb</span><span class="p">,</span>
				<span class="k">enum</span> <span class="n">bfi_asic_mode</span> <span class="n">asic_mode</span><span class="p">);</span>
<span class="k">static</span> <span class="k">enum</span> <span class="n">bfa_status</span> <span class="n">bfa_ioc_ct2_pll_init</span><span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">rb</span><span class="p">,</span>
				<span class="k">enum</span> <span class="n">bfi_asic_mode</span> <span class="n">asic_mode</span><span class="p">);</span>
<span class="k">static</span> <span class="n">bool</span> <span class="n">bfa_ioc_ct2_lpu_read_stat</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_ioc</span> <span class="o">*</span><span class="n">ioc</span><span class="p">);</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">bfa_ioc_hwif</span> <span class="n">nw_hwif_ct</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">ioc_pll_init</span>	     <span class="o">=</span> <span class="n">bfa_ioc_ct_pll_init</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ioc_firmware_lock</span>   <span class="o">=</span> <span class="n">bfa_ioc_ct_firmware_lock</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ioc_firmware_unlock</span> <span class="o">=</span> <span class="n">bfa_ioc_ct_firmware_unlock</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ioc_reg_init</span>	     <span class="o">=</span> <span class="n">bfa_ioc_ct_reg_init</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ioc_map_port</span>	     <span class="o">=</span> <span class="n">bfa_ioc_ct_map_port</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ioc_isr_mode_set</span>    <span class="o">=</span> <span class="n">bfa_ioc_ct_isr_mode_set</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ioc_notify_fail</span>     <span class="o">=</span> <span class="n">bfa_ioc_ct_notify_fail</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ioc_ownership_reset</span> <span class="o">=</span> <span class="n">bfa_ioc_ct_ownership_reset</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ioc_sync_start</span>      <span class="o">=</span> <span class="n">bfa_ioc_ct_sync_start</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ioc_sync_join</span>       <span class="o">=</span> <span class="n">bfa_ioc_ct_sync_join</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ioc_sync_leave</span>	     <span class="o">=</span> <span class="n">bfa_ioc_ct_sync_leave</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ioc_sync_ack</span>	     <span class="o">=</span> <span class="n">bfa_ioc_ct_sync_ack</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ioc_sync_complete</span>   <span class="o">=</span> <span class="n">bfa_ioc_ct_sync_complete</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">bfa_ioc_hwif</span> <span class="n">nw_hwif_ct2</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">ioc_pll_init</span>	     <span class="o">=</span> <span class="n">bfa_ioc_ct2_pll_init</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ioc_firmware_lock</span>   <span class="o">=</span> <span class="n">bfa_ioc_ct_firmware_lock</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ioc_firmware_unlock</span> <span class="o">=</span> <span class="n">bfa_ioc_ct_firmware_unlock</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ioc_reg_init</span>	     <span class="o">=</span> <span class="n">bfa_ioc_ct2_reg_init</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ioc_map_port</span>	     <span class="o">=</span> <span class="n">bfa_ioc_ct2_map_port</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ioc_lpu_read_stat</span>   <span class="o">=</span> <span class="n">bfa_ioc_ct2_lpu_read_stat</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ioc_isr_mode_set</span>    <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ioc_notify_fail</span>     <span class="o">=</span> <span class="n">bfa_ioc_ct_notify_fail</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ioc_ownership_reset</span> <span class="o">=</span> <span class="n">bfa_ioc_ct_ownership_reset</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ioc_sync_start</span>      <span class="o">=</span> <span class="n">bfa_ioc_ct_sync_start</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ioc_sync_join</span>       <span class="o">=</span> <span class="n">bfa_ioc_ct_sync_join</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ioc_sync_leave</span>	     <span class="o">=</span> <span class="n">bfa_ioc_ct_sync_leave</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ioc_sync_ack</span>	     <span class="o">=</span> <span class="n">bfa_ioc_ct_sync_ack</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ioc_sync_complete</span>   <span class="o">=</span> <span class="n">bfa_ioc_ct_sync_complete</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * Called from bfa_ioc_attach() to map asic specific calls.</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">bfa_nw_ioc_set_ct_hwif</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_ioc</span> <span class="o">*</span><span class="n">ioc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioc_hwif</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">nw_hwif_ct</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">bfa_nw_ioc_set_ct2_hwif</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_ioc</span> <span class="o">*</span><span class="n">ioc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioc_hwif</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">nw_hwif_ct2</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Return true if firmware of current driver matches the running firmware.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">bool</span>
<span class="nf">bfa_ioc_ct_firmware_lock</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_ioc</span> <span class="o">*</span><span class="n">ioc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">enum</span> <span class="n">bfi_ioc_state</span> <span class="n">ioc_fwstate</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">usecnt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bfi_ioc_image_hdr</span> <span class="n">fwhdr</span><span class="p">;</span>

	<span class="cm">/**</span>
<span class="cm">	 * If bios boot (flash based) -- do not increment usage count</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bfa_cb_image_get_size</span><span class="p">(</span><span class="n">bfa_ioc_asic_gen</span><span class="p">(</span><span class="n">ioc</span><span class="p">))</span> <span class="o">&lt;</span>
						<span class="n">BFA_IOC_FWIMG_MINSZ</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>

	<span class="n">bfa_nw_ioc_sem_get</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioc_regs</span><span class="p">.</span><span class="n">ioc_usage_sem_reg</span><span class="p">);</span>
	<span class="n">usecnt</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioc_regs</span><span class="p">.</span><span class="n">ioc_usage_reg</span><span class="p">);</span>

	<span class="cm">/**</span>
<span class="cm">	 * If usage count is 0, always return TRUE.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">usecnt</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">writel</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioc_regs</span><span class="p">.</span><span class="n">ioc_usage_reg</span><span class="p">);</span>
		<span class="n">bfa_nw_ioc_sem_release</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioc_regs</span><span class="p">.</span><span class="n">ioc_usage_sem_reg</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioc_regs</span><span class="p">.</span><span class="n">ioc_fail_sync</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ioc_fwstate</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioc_regs</span><span class="p">.</span><span class="n">ioc_fwstate</span><span class="p">);</span>

	<span class="cm">/**</span>
<span class="cm">	 * Use count cannot be non-zero and chip in uninitialized state.</span>
<span class="cm">	 */</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ioc_fwstate</span> <span class="o">!=</span> <span class="n">BFI_IOC_UNINIT</span><span class="p">));</span>

	<span class="cm">/**</span>
<span class="cm">	 * Check if another driver with a different firmware is active</span>
<span class="cm">	 */</span>
	<span class="n">bfa_nw_ioc_fwver_get</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fwhdr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bfa_nw_ioc_fwver_cmp</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fwhdr</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">bfa_nw_ioc_sem_release</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioc_regs</span><span class="p">.</span><span class="n">ioc_usage_sem_reg</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/**</span>
<span class="cm">	 * Same firmware version. Increment the reference count.</span>
<span class="cm">	 */</span>
	<span class="n">usecnt</span><span class="o">++</span><span class="p">;</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">usecnt</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioc_regs</span><span class="p">.</span><span class="n">ioc_usage_reg</span><span class="p">);</span>
	<span class="n">bfa_nw_ioc_sem_release</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioc_regs</span><span class="p">.</span><span class="n">ioc_usage_sem_reg</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_ioc_ct_firmware_unlock</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_ioc</span> <span class="o">*</span><span class="n">ioc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">usecnt</span><span class="p">;</span>

	<span class="cm">/**</span>
<span class="cm">	 * If bios boot (flash based) -- do not decrement usage count</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bfa_cb_image_get_size</span><span class="p">(</span><span class="n">bfa_ioc_asic_gen</span><span class="p">(</span><span class="n">ioc</span><span class="p">))</span> <span class="o">&lt;</span>
						<span class="n">BFA_IOC_FWIMG_MINSZ</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/**</span>
<span class="cm">	 * decrement usage count</span>
<span class="cm">	 */</span>
	<span class="n">bfa_nw_ioc_sem_get</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioc_regs</span><span class="p">.</span><span class="n">ioc_usage_sem_reg</span><span class="p">);</span>
	<span class="n">usecnt</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioc_regs</span><span class="p">.</span><span class="n">ioc_usage_reg</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">usecnt</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">));</span>

	<span class="n">usecnt</span><span class="o">--</span><span class="p">;</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">usecnt</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioc_regs</span><span class="p">.</span><span class="n">ioc_usage_reg</span><span class="p">);</span>

	<span class="n">bfa_nw_ioc_sem_release</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioc_regs</span><span class="p">.</span><span class="n">ioc_usage_sem_reg</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Notify other functions on HB failure.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_ioc_ct_notify_fail</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_ioc</span> <span class="o">*</span><span class="n">ioc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">__FW_INIT_HALT_P</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioc_regs</span><span class="p">.</span><span class="n">ll_halt</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">__FW_INIT_HALT_P</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioc_regs</span><span class="p">.</span><span class="n">alt_ll_halt</span><span class="p">);</span>
	<span class="cm">/* Wait for halt to take effect */</span>
	<span class="n">readl</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioc_regs</span><span class="p">.</span><span class="n">ll_halt</span><span class="p">);</span>
	<span class="n">readl</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioc_regs</span><span class="p">.</span><span class="n">alt_ll_halt</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Host to LPU mailbox message addresses</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="p">{</span>
	<span class="n">u32</span>	<span class="n">hfn_mbox</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">lpu_mbox</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">hfn_pgn</span><span class="p">;</span>
<span class="p">}</span> <span class="n">ct_fnreg</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">HOSTFN0_LPU_MBOX0_0</span><span class="p">,</span> <span class="n">LPU_HOSTFN0_MBOX0_0</span><span class="p">,</span> <span class="n">HOST_PAGE_NUM_FN0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">HOSTFN1_LPU_MBOX0_8</span><span class="p">,</span> <span class="n">LPU_HOSTFN1_MBOX0_8</span><span class="p">,</span> <span class="n">HOST_PAGE_NUM_FN1</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">HOSTFN2_LPU_MBOX0_0</span><span class="p">,</span> <span class="n">LPU_HOSTFN2_MBOX0_0</span><span class="p">,</span> <span class="n">HOST_PAGE_NUM_FN2</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">HOSTFN3_LPU_MBOX0_8</span><span class="p">,</span> <span class="n">LPU_HOSTFN3_MBOX0_8</span><span class="p">,</span> <span class="n">HOST_PAGE_NUM_FN3</span> <span class="p">}</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * Host &lt;-&gt; LPU mailbox command/status registers - port 0</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="p">{</span>
	<span class="n">u32</span>	<span class="n">hfn</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">lpu</span><span class="p">;</span>
<span class="p">}</span> <span class="n">ct_p0reg</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">HOSTFN0_LPU0_CMD_STAT</span><span class="p">,</span> <span class="n">LPU0_HOSTFN0_CMD_STAT</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">HOSTFN1_LPU0_CMD_STAT</span><span class="p">,</span> <span class="n">LPU0_HOSTFN1_CMD_STAT</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">HOSTFN2_LPU0_CMD_STAT</span><span class="p">,</span> <span class="n">LPU0_HOSTFN2_CMD_STAT</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">HOSTFN3_LPU0_CMD_STAT</span><span class="p">,</span> <span class="n">LPU0_HOSTFN3_CMD_STAT</span> <span class="p">}</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * Host &lt;-&gt; LPU mailbox command/status registers - port 1</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="p">{</span>
	<span class="n">u32</span>	<span class="n">hfn</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">lpu</span><span class="p">;</span>
<span class="p">}</span> <span class="n">ct_p1reg</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">HOSTFN0_LPU1_CMD_STAT</span><span class="p">,</span> <span class="n">LPU1_HOSTFN0_CMD_STAT</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">HOSTFN1_LPU1_CMD_STAT</span><span class="p">,</span> <span class="n">LPU1_HOSTFN1_CMD_STAT</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">HOSTFN2_LPU1_CMD_STAT</span><span class="p">,</span> <span class="n">LPU1_HOSTFN2_CMD_STAT</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">HOSTFN3_LPU1_CMD_STAT</span><span class="p">,</span> <span class="n">LPU1_HOSTFN3_CMD_STAT</span> <span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="p">{</span>
	<span class="n">u32</span>	<span class="n">hfn_mbox</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">lpu_mbox</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">hfn_pgn</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">hfn</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">lpu</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">lpu_read</span><span class="p">;</span>
<span class="p">}</span> <span class="n">ct2_reg</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">CT2_HOSTFN_LPU0_MBOX0</span><span class="p">,</span> <span class="n">CT2_LPU0_HOSTFN_MBOX0</span><span class="p">,</span> <span class="n">CT2_HOSTFN_PAGE_NUM</span><span class="p">,</span>
	  <span class="n">CT2_HOSTFN_LPU0_CMD_STAT</span><span class="p">,</span> <span class="n">CT2_LPU0_HOSTFN_CMD_STAT</span><span class="p">,</span>
	  <span class="n">CT2_HOSTFN_LPU0_READ_STAT</span><span class="p">},</span>
	<span class="p">{</span> <span class="n">CT2_HOSTFN_LPU1_MBOX0</span><span class="p">,</span> <span class="n">CT2_LPU1_HOSTFN_MBOX0</span><span class="p">,</span> <span class="n">CT2_HOSTFN_PAGE_NUM</span><span class="p">,</span>
	  <span class="n">CT2_HOSTFN_LPU1_CMD_STAT</span><span class="p">,</span> <span class="n">CT2_LPU1_HOSTFN_CMD_STAT</span><span class="p">,</span>
	  <span class="n">CT2_HOSTFN_LPU1_READ_STAT</span><span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_ioc_ct_reg_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_ioc</span> <span class="o">*</span><span class="n">ioc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">rb</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">pcifn</span> <span class="o">=</span> <span class="n">bfa_ioc_pcifn</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>

	<span class="n">rb</span> <span class="o">=</span> <span class="n">bfa_ioc_bar0</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>

	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioc_regs</span><span class="p">.</span><span class="n">hfn_mbox</span> <span class="o">=</span> <span class="n">rb</span> <span class="o">+</span> <span class="n">ct_fnreg</span><span class="p">[</span><span class="n">pcifn</span><span class="p">].</span><span class="n">hfn_mbox</span><span class="p">;</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioc_regs</span><span class="p">.</span><span class="n">lpu_mbox</span> <span class="o">=</span> <span class="n">rb</span> <span class="o">+</span> <span class="n">ct_fnreg</span><span class="p">[</span><span class="n">pcifn</span><span class="p">].</span><span class="n">lpu_mbox</span><span class="p">;</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioc_regs</span><span class="p">.</span><span class="n">host_page_num_fn</span> <span class="o">=</span> <span class="n">rb</span> <span class="o">+</span> <span class="n">ct_fnreg</span><span class="p">[</span><span class="n">pcifn</span><span class="p">].</span><span class="n">hfn_pgn</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">port_id</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioc_regs</span><span class="p">.</span><span class="n">heartbeat</span> <span class="o">=</span> <span class="n">rb</span> <span class="o">+</span> <span class="n">BFA_IOC0_HBEAT_REG</span><span class="p">;</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioc_regs</span><span class="p">.</span><span class="n">ioc_fwstate</span> <span class="o">=</span> <span class="n">rb</span> <span class="o">+</span> <span class="n">BFA_IOC0_STATE_REG</span><span class="p">;</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioc_regs</span><span class="p">.</span><span class="n">alt_ioc_fwstate</span> <span class="o">=</span> <span class="n">rb</span> <span class="o">+</span> <span class="n">BFA_IOC1_STATE_REG</span><span class="p">;</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioc_regs</span><span class="p">.</span><span class="n">hfn_mbox_cmd</span> <span class="o">=</span> <span class="n">rb</span> <span class="o">+</span> <span class="n">ct_p0reg</span><span class="p">[</span><span class="n">pcifn</span><span class="p">].</span><span class="n">hfn</span><span class="p">;</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioc_regs</span><span class="p">.</span><span class="n">lpu_mbox_cmd</span> <span class="o">=</span> <span class="n">rb</span> <span class="o">+</span> <span class="n">ct_p0reg</span><span class="p">[</span><span class="n">pcifn</span><span class="p">].</span><span class="n">lpu</span><span class="p">;</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioc_regs</span><span class="p">.</span><span class="n">ll_halt</span> <span class="o">=</span> <span class="n">rb</span> <span class="o">+</span> <span class="n">FW_INIT_HALT_P0</span><span class="p">;</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioc_regs</span><span class="p">.</span><span class="n">alt_ll_halt</span> <span class="o">=</span> <span class="n">rb</span> <span class="o">+</span> <span class="n">FW_INIT_HALT_P1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioc_regs</span><span class="p">.</span><span class="n">heartbeat</span> <span class="o">=</span> <span class="n">rb</span> <span class="o">+</span> <span class="n">BFA_IOC1_HBEAT_REG</span><span class="p">;</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioc_regs</span><span class="p">.</span><span class="n">ioc_fwstate</span> <span class="o">=</span> <span class="n">rb</span> <span class="o">+</span> <span class="n">BFA_IOC1_STATE_REG</span><span class="p">;</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioc_regs</span><span class="p">.</span><span class="n">alt_ioc_fwstate</span> <span class="o">=</span> <span class="n">rb</span> <span class="o">+</span> <span class="n">BFA_IOC0_STATE_REG</span><span class="p">;</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioc_regs</span><span class="p">.</span><span class="n">hfn_mbox_cmd</span> <span class="o">=</span> <span class="n">rb</span> <span class="o">+</span> <span class="n">ct_p1reg</span><span class="p">[</span><span class="n">pcifn</span><span class="p">].</span><span class="n">hfn</span><span class="p">;</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioc_regs</span><span class="p">.</span><span class="n">lpu_mbox_cmd</span> <span class="o">=</span> <span class="n">rb</span> <span class="o">+</span> <span class="n">ct_p1reg</span><span class="p">[</span><span class="n">pcifn</span><span class="p">].</span><span class="n">lpu</span><span class="p">;</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioc_regs</span><span class="p">.</span><span class="n">ll_halt</span> <span class="o">=</span> <span class="n">rb</span> <span class="o">+</span> <span class="n">FW_INIT_HALT_P1</span><span class="p">;</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioc_regs</span><span class="p">.</span><span class="n">alt_ll_halt</span> <span class="o">=</span> <span class="n">rb</span> <span class="o">+</span> <span class="n">FW_INIT_HALT_P0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * PSS control registers</span>
<span class="cm">	 */</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioc_regs</span><span class="p">.</span><span class="n">pss_ctl_reg</span> <span class="o">=</span> <span class="n">rb</span> <span class="o">+</span> <span class="n">PSS_CTL_REG</span><span class="p">;</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioc_regs</span><span class="p">.</span><span class="n">pss_err_status_reg</span> <span class="o">=</span> <span class="n">rb</span> <span class="o">+</span> <span class="n">PSS_ERR_STATUS_REG</span><span class="p">;</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioc_regs</span><span class="p">.</span><span class="n">app_pll_fast_ctl_reg</span> <span class="o">=</span> <span class="n">rb</span> <span class="o">+</span> <span class="n">APP_PLL_LCLK_CTL_REG</span><span class="p">;</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioc_regs</span><span class="p">.</span><span class="n">app_pll_slow_ctl_reg</span> <span class="o">=</span> <span class="n">rb</span> <span class="o">+</span> <span class="n">APP_PLL_SCLK_CTL_REG</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * IOC semaphore registers and serialization</span>
<span class="cm">	 */</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioc_regs</span><span class="p">.</span><span class="n">ioc_sem_reg</span> <span class="o">=</span> <span class="n">rb</span> <span class="o">+</span> <span class="n">HOST_SEM0_REG</span><span class="p">;</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioc_regs</span><span class="p">.</span><span class="n">ioc_usage_sem_reg</span> <span class="o">=</span> <span class="n">rb</span> <span class="o">+</span> <span class="n">HOST_SEM1_REG</span><span class="p">;</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioc_regs</span><span class="p">.</span><span class="n">ioc_init_sem_reg</span> <span class="o">=</span> <span class="n">rb</span> <span class="o">+</span> <span class="n">HOST_SEM2_REG</span><span class="p">;</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioc_regs</span><span class="p">.</span><span class="n">ioc_usage_reg</span> <span class="o">=</span> <span class="n">rb</span> <span class="o">+</span> <span class="n">BFA_FW_USE_COUNT</span><span class="p">;</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioc_regs</span><span class="p">.</span><span class="n">ioc_fail_sync</span> <span class="o">=</span> <span class="n">rb</span> <span class="o">+</span> <span class="n">BFA_IOC_FAIL_SYNC</span><span class="p">;</span>

	<span class="cm">/**</span>
<span class="cm">	 * sram memory access</span>
<span class="cm">	 */</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioc_regs</span><span class="p">.</span><span class="n">smem_page_start</span> <span class="o">=</span> <span class="n">rb</span> <span class="o">+</span> <span class="n">PSS_SMEM_PAGE_START</span><span class="p">;</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioc_regs</span><span class="p">.</span><span class="n">smem_pg0</span> <span class="o">=</span> <span class="n">BFI_IOC_SMEM_PG0_CT</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * err set reg : for notification of hb failure in fcmode</span>
<span class="cm">	 */</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioc_regs</span><span class="p">.</span><span class="n">err_set</span> <span class="o">=</span> <span class="p">(</span><span class="n">rb</span> <span class="o">+</span> <span class="n">ERR_SET_REG</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_ioc_ct2_reg_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_ioc</span> <span class="o">*</span><span class="n">ioc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">rb</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">port</span> <span class="o">=</span> <span class="n">bfa_ioc_portid</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>

	<span class="n">rb</span> <span class="o">=</span> <span class="n">bfa_ioc_bar0</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>

	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioc_regs</span><span class="p">.</span><span class="n">hfn_mbox</span> <span class="o">=</span> <span class="n">rb</span> <span class="o">+</span> <span class="n">ct2_reg</span><span class="p">[</span><span class="n">port</span><span class="p">].</span><span class="n">hfn_mbox</span><span class="p">;</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioc_regs</span><span class="p">.</span><span class="n">lpu_mbox</span> <span class="o">=</span> <span class="n">rb</span> <span class="o">+</span> <span class="n">ct2_reg</span><span class="p">[</span><span class="n">port</span><span class="p">].</span><span class="n">lpu_mbox</span><span class="p">;</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioc_regs</span><span class="p">.</span><span class="n">host_page_num_fn</span> <span class="o">=</span> <span class="n">rb</span> <span class="o">+</span> <span class="n">ct2_reg</span><span class="p">[</span><span class="n">port</span><span class="p">].</span><span class="n">hfn_pgn</span><span class="p">;</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioc_regs</span><span class="p">.</span><span class="n">hfn_mbox_cmd</span> <span class="o">=</span> <span class="n">rb</span> <span class="o">+</span> <span class="n">ct2_reg</span><span class="p">[</span><span class="n">port</span><span class="p">].</span><span class="n">hfn</span><span class="p">;</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioc_regs</span><span class="p">.</span><span class="n">lpu_mbox_cmd</span> <span class="o">=</span> <span class="n">rb</span> <span class="o">+</span> <span class="n">ct2_reg</span><span class="p">[</span><span class="n">port</span><span class="p">].</span><span class="n">lpu</span><span class="p">;</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioc_regs</span><span class="p">.</span><span class="n">lpu_read_stat</span> <span class="o">=</span> <span class="n">rb</span> <span class="o">+</span> <span class="n">ct2_reg</span><span class="p">[</span><span class="n">port</span><span class="p">].</span><span class="n">lpu_read</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">port</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioc_regs</span><span class="p">.</span><span class="n">heartbeat</span> <span class="o">=</span> <span class="n">rb</span> <span class="o">+</span> <span class="n">CT2_BFA_IOC0_HBEAT_REG</span><span class="p">;</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioc_regs</span><span class="p">.</span><span class="n">ioc_fwstate</span> <span class="o">=</span> <span class="n">rb</span> <span class="o">+</span> <span class="n">CT2_BFA_IOC0_STATE_REG</span><span class="p">;</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioc_regs</span><span class="p">.</span><span class="n">alt_ioc_fwstate</span> <span class="o">=</span> <span class="n">rb</span> <span class="o">+</span> <span class="n">CT2_BFA_IOC1_STATE_REG</span><span class="p">;</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioc_regs</span><span class="p">.</span><span class="n">ll_halt</span> <span class="o">=</span> <span class="n">rb</span> <span class="o">+</span> <span class="n">FW_INIT_HALT_P0</span><span class="p">;</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioc_regs</span><span class="p">.</span><span class="n">alt_ll_halt</span> <span class="o">=</span> <span class="n">rb</span> <span class="o">+</span> <span class="n">FW_INIT_HALT_P1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioc_regs</span><span class="p">.</span><span class="n">heartbeat</span> <span class="o">=</span> <span class="n">rb</span> <span class="o">+</span> <span class="n">CT2_BFA_IOC1_HBEAT_REG</span><span class="p">;</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioc_regs</span><span class="p">.</span><span class="n">ioc_fwstate</span> <span class="o">=</span> <span class="n">rb</span> <span class="o">+</span> <span class="n">CT2_BFA_IOC1_STATE_REG</span><span class="p">;</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioc_regs</span><span class="p">.</span><span class="n">alt_ioc_fwstate</span> <span class="o">=</span> <span class="n">rb</span> <span class="o">+</span> <span class="n">CT2_BFA_IOC0_STATE_REG</span><span class="p">;</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioc_regs</span><span class="p">.</span><span class="n">ll_halt</span> <span class="o">=</span> <span class="n">rb</span> <span class="o">+</span> <span class="n">FW_INIT_HALT_P1</span><span class="p">;</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioc_regs</span><span class="p">.</span><span class="n">alt_ll_halt</span> <span class="o">=</span> <span class="n">rb</span> <span class="o">+</span> <span class="n">FW_INIT_HALT_P0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * PSS control registers</span>
<span class="cm">	 */</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioc_regs</span><span class="p">.</span><span class="n">pss_ctl_reg</span> <span class="o">=</span> <span class="n">rb</span> <span class="o">+</span> <span class="n">PSS_CTL_REG</span><span class="p">;</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioc_regs</span><span class="p">.</span><span class="n">pss_err_status_reg</span> <span class="o">=</span> <span class="n">rb</span> <span class="o">+</span> <span class="n">PSS_ERR_STATUS_REG</span><span class="p">;</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioc_regs</span><span class="p">.</span><span class="n">app_pll_fast_ctl_reg</span> <span class="o">=</span> <span class="n">rb</span> <span class="o">+</span> <span class="n">CT2_APP_PLL_LCLK_CTL_REG</span><span class="p">;</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioc_regs</span><span class="p">.</span><span class="n">app_pll_slow_ctl_reg</span> <span class="o">=</span> <span class="n">rb</span> <span class="o">+</span> <span class="n">CT2_APP_PLL_SCLK_CTL_REG</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * IOC semaphore registers and serialization</span>
<span class="cm">	 */</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioc_regs</span><span class="p">.</span><span class="n">ioc_sem_reg</span> <span class="o">=</span> <span class="n">rb</span> <span class="o">+</span> <span class="n">CT2_HOST_SEM0_REG</span><span class="p">;</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioc_regs</span><span class="p">.</span><span class="n">ioc_usage_sem_reg</span> <span class="o">=</span> <span class="n">rb</span> <span class="o">+</span> <span class="n">CT2_HOST_SEM1_REG</span><span class="p">;</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioc_regs</span><span class="p">.</span><span class="n">ioc_init_sem_reg</span> <span class="o">=</span> <span class="n">rb</span> <span class="o">+</span> <span class="n">CT2_HOST_SEM2_REG</span><span class="p">;</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioc_regs</span><span class="p">.</span><span class="n">ioc_usage_reg</span> <span class="o">=</span> <span class="n">rb</span> <span class="o">+</span> <span class="n">CT2_BFA_FW_USE_COUNT</span><span class="p">;</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioc_regs</span><span class="p">.</span><span class="n">ioc_fail_sync</span> <span class="o">=</span> <span class="n">rb</span> <span class="o">+</span> <span class="n">CT2_BFA_IOC_FAIL_SYNC</span><span class="p">;</span>

	<span class="cm">/**</span>
<span class="cm">	 * sram memory access</span>
<span class="cm">	 */</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioc_regs</span><span class="p">.</span><span class="n">smem_page_start</span> <span class="o">=</span> <span class="n">rb</span> <span class="o">+</span> <span class="n">PSS_SMEM_PAGE_START</span><span class="p">;</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioc_regs</span><span class="p">.</span><span class="n">smem_pg0</span> <span class="o">=</span> <span class="n">BFI_IOC_SMEM_PG0_CT</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * err set reg : for notification of hb failure in fcmode</span>
<span class="cm">	 */</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioc_regs</span><span class="p">.</span><span class="n">err_set</span> <span class="o">=</span> <span class="n">rb</span> <span class="o">+</span> <span class="n">ERR_SET_REG</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Initialize IOC to port mapping.</span>
<span class="cm"> */</span>

<span class="cp">#define FNC_PERS_FN_SHIFT(__fn)	((__fn) * 8)</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_ioc_ct_map_port</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_ioc</span> <span class="o">*</span><span class="n">ioc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">rb</span> <span class="o">=</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">.</span><span class="n">pci_bar_kva</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">r32</span><span class="p">;</span>

	<span class="cm">/**</span>
<span class="cm">	 * For catapult, base port id on personality register and IOC type</span>
<span class="cm">	 */</span>
	<span class="n">r32</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">rb</span> <span class="o">+</span> <span class="n">FNC_PERS_REG</span><span class="p">);</span>
	<span class="n">r32</span> <span class="o">&gt;&gt;=</span> <span class="n">FNC_PERS_FN_SHIFT</span><span class="p">(</span><span class="n">bfa_ioc_pcifn</span><span class="p">(</span><span class="n">ioc</span><span class="p">));</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">port_id</span> <span class="o">=</span> <span class="p">(</span><span class="n">r32</span> <span class="o">&amp;</span> <span class="n">__F0_PORT_MAP_MK</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">__F0_PORT_MAP_SH</span><span class="p">;</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_ioc_ct2_map_port</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_ioc</span> <span class="o">*</span><span class="n">ioc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">rb</span> <span class="o">=</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">.</span><span class="n">pci_bar_kva</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">r32</span><span class="p">;</span>

	<span class="n">r32</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">rb</span> <span class="o">+</span> <span class="n">CT2_HOSTFN_PERSONALITY0</span><span class="p">);</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">port_id</span> <span class="o">=</span> <span class="p">((</span><span class="n">r32</span> <span class="o">&amp;</span> <span class="n">__FC_LL_PORT_MAP__MK</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">__FC_LL_PORT_MAP__SH</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Set interrupt mode for a function: INTX or MSIX</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_ioc_ct_isr_mode_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_ioc</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="n">bool</span> <span class="n">msix</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">rb</span> <span class="o">=</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">.</span><span class="n">pci_bar_kva</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">r32</span><span class="p">,</span> <span class="n">mode</span><span class="p">;</span>

	<span class="n">r32</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">rb</span> <span class="o">+</span> <span class="n">FNC_PERS_REG</span><span class="p">);</span>

	<span class="n">mode</span> <span class="o">=</span> <span class="p">(</span><span class="n">r32</span> <span class="o">&gt;&gt;</span> <span class="n">FNC_PERS_FN_SHIFT</span><span class="p">(</span><span class="n">bfa_ioc_pcifn</span><span class="p">(</span><span class="n">ioc</span><span class="p">)))</span> <span class="o">&amp;</span>
		<span class="n">__F0_INTX_STATUS</span><span class="p">;</span>

	<span class="cm">/**</span>
<span class="cm">	 * If already in desired mode, do not change anything</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="n">msix</span> <span class="o">&amp;&amp;</span> <span class="n">mode</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">msix</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">mode</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">msix</span><span class="p">)</span>
		<span class="n">mode</span> <span class="o">=</span> <span class="n">__F0_INTX_STATUS_MSIX</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">mode</span> <span class="o">=</span> <span class="n">__F0_INTX_STATUS_INTA</span><span class="p">;</span>

	<span class="n">r32</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">__F0_INTX_STATUS</span> <span class="o">&lt;&lt;</span> <span class="n">FNC_PERS_FN_SHIFT</span><span class="p">(</span><span class="n">bfa_ioc_pcifn</span><span class="p">(</span><span class="n">ioc</span><span class="p">)));</span>
	<span class="n">r32</span> <span class="o">|=</span> <span class="p">(</span><span class="n">mode</span> <span class="o">&lt;&lt;</span> <span class="n">FNC_PERS_FN_SHIFT</span><span class="p">(</span><span class="n">bfa_ioc_pcifn</span><span class="p">(</span><span class="n">ioc</span><span class="p">)));</span>

	<span class="n">writel</span><span class="p">(</span><span class="n">r32</span><span class="p">,</span> <span class="n">rb</span> <span class="o">+</span> <span class="n">FNC_PERS_REG</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span>
<span class="nf">bfa_ioc_ct2_lpu_read_stat</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_ioc</span> <span class="o">*</span><span class="n">ioc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">r32</span><span class="p">;</span>

	<span class="n">r32</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioc_regs</span><span class="p">.</span><span class="n">lpu_read_stat</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r32</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">writel</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioc_regs</span><span class="p">.</span><span class="n">lpu_read_stat</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * MSI-X resource allocation for 1860 with no asic block</span>
<span class="cm"> */</span>
<span class="cp">#define HOSTFN_MSIX_DEFAULT		64</span>
<span class="cp">#define HOSTFN_MSIX_VT_INDEX_MBOX_ERR	0x30138</span>
<span class="cp">#define HOSTFN_MSIX_VT_OFST_NUMVT	0x3013c</span>
<span class="cp">#define __MSIX_VT_NUMVT__MK		0x003ff800</span>
<span class="cp">#define __MSIX_VT_NUMVT__SH		11</span>
<span class="cp">#define __MSIX_VT_NUMVT_(_v)		((_v) &lt;&lt; __MSIX_VT_NUMVT__SH)</span>
<span class="cp">#define __MSIX_VT_OFST_			0x000007ff</span>
<span class="kt">void</span>
<span class="nf">bfa_nw_ioc_ct2_poweron</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_ioc</span> <span class="o">*</span><span class="n">ioc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">rb</span> <span class="o">=</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">.</span><span class="n">pci_bar_kva</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">r32</span><span class="p">;</span>

	<span class="n">r32</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">rb</span> <span class="o">+</span> <span class="n">HOSTFN_MSIX_VT_OFST_NUMVT</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r32</span> <span class="o">&amp;</span> <span class="n">__MSIX_VT_NUMVT__MK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">r32</span> <span class="o">&amp;</span> <span class="n">__MSIX_VT_OFST_</span><span class="p">,</span>
			<span class="n">rb</span> <span class="o">+</span> <span class="n">HOSTFN_MSIX_VT_INDEX_MBOX_ERR</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">writel</span><span class="p">(</span><span class="n">__MSIX_VT_NUMVT_</span><span class="p">(</span><span class="n">HOSTFN_MSIX_DEFAULT</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span>
			<span class="n">HOSTFN_MSIX_DEFAULT</span> <span class="o">*</span> <span class="n">bfa_ioc_pcifn</span><span class="p">(</span><span class="n">ioc</span><span class="p">),</span>
			<span class="n">rb</span> <span class="o">+</span> <span class="n">HOSTFN_MSIX_VT_OFST_NUMVT</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">HOSTFN_MSIX_DEFAULT</span> <span class="o">*</span> <span class="n">bfa_ioc_pcifn</span><span class="p">(</span><span class="n">ioc</span><span class="p">),</span>
			<span class="n">rb</span> <span class="o">+</span> <span class="n">HOSTFN_MSIX_VT_INDEX_MBOX_ERR</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Cleanup hw semaphore and usecnt registers</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_ioc_ct_ownership_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_ioc</span> <span class="o">*</span><span class="n">ioc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfa_nw_ioc_sem_get</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioc_regs</span><span class="p">.</span><span class="n">ioc_usage_sem_reg</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioc_regs</span><span class="p">.</span><span class="n">ioc_usage_reg</span><span class="p">);</span>
	<span class="n">bfa_nw_ioc_sem_release</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioc_regs</span><span class="p">.</span><span class="n">ioc_usage_sem_reg</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Read the hw sem reg to make sure that it is locked</span>
<span class="cm">	 * before we clear it. If it is not locked, writing 1</span>
<span class="cm">	 * will lock it instead of clearing it.</span>
<span class="cm">	 */</span>
	<span class="n">readl</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioc_regs</span><span class="p">.</span><span class="n">ioc_sem_reg</span><span class="p">);</span>
	<span class="n">bfa_nw_ioc_hw_sem_release</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Synchronized IOC failure processing routines</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">bool</span>
<span class="nf">bfa_ioc_ct_sync_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_ioc</span> <span class="o">*</span><span class="n">ioc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">r32</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioc_regs</span><span class="p">.</span><span class="n">ioc_fail_sync</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">sync_reqd</span> <span class="o">=</span> <span class="n">bfa_ioc_ct_get_sync_reqd</span><span class="p">(</span><span class="n">r32</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Driver load time.  If the sync required bit for this PCI fn</span>
<span class="cm">	 * is set, it is due to an unclean exit by the driver for this</span>
<span class="cm">	 * PCI fn in the previous incarnation. Whoever comes here first</span>
<span class="cm">	 * should clean it up, no matter which PCI fn.</span>
<span class="cm">	 */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sync_reqd</span> <span class="o">&amp;</span> <span class="n">bfa_ioc_ct_sync_pos</span><span class="p">(</span><span class="n">ioc</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioc_regs</span><span class="p">.</span><span class="n">ioc_fail_sync</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioc_regs</span><span class="p">.</span><span class="n">ioc_usage_reg</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">BFI_IOC_UNINIT</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioc_regs</span><span class="p">.</span><span class="n">ioc_fwstate</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">BFI_IOC_UNINIT</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioc_regs</span><span class="p">.</span><span class="n">alt_ioc_fwstate</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">bfa_ioc_ct_sync_complete</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>
<span class="p">}</span>
<span class="cm">/**</span>
<span class="cm"> * Synchronized IOC failure processing routines</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_ioc_ct_sync_join</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_ioc</span> <span class="o">*</span><span class="n">ioc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">r32</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioc_regs</span><span class="p">.</span><span class="n">ioc_fail_sync</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">sync_pos</span> <span class="o">=</span> <span class="n">bfa_ioc_ct_sync_reqd_pos</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>

	<span class="n">writel</span><span class="p">((</span><span class="n">r32</span> <span class="o">|</span> <span class="n">sync_pos</span><span class="p">),</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioc_regs</span><span class="p">.</span><span class="n">ioc_fail_sync</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_ioc_ct_sync_leave</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_ioc</span> <span class="o">*</span><span class="n">ioc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">r32</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioc_regs</span><span class="p">.</span><span class="n">ioc_fail_sync</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">sync_msk</span> <span class="o">=</span> <span class="n">bfa_ioc_ct_sync_reqd_pos</span><span class="p">(</span><span class="n">ioc</span><span class="p">)</span> <span class="o">|</span>
					<span class="n">bfa_ioc_ct_sync_pos</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>

	<span class="n">writel</span><span class="p">((</span><span class="n">r32</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">sync_msk</span><span class="p">),</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioc_regs</span><span class="p">.</span><span class="n">ioc_fail_sync</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_ioc_ct_sync_ack</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_ioc</span> <span class="o">*</span><span class="n">ioc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">r32</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioc_regs</span><span class="p">.</span><span class="n">ioc_fail_sync</span><span class="p">);</span>

	<span class="n">writel</span><span class="p">((</span><span class="n">r32</span> <span class="o">|</span> <span class="n">bfa_ioc_ct_sync_pos</span><span class="p">(</span><span class="n">ioc</span><span class="p">)),</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioc_regs</span><span class="p">.</span><span class="n">ioc_fail_sync</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span>
<span class="nf">bfa_ioc_ct_sync_complete</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfa_ioc</span> <span class="o">*</span><span class="n">ioc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">r32</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioc_regs</span><span class="p">.</span><span class="n">ioc_fail_sync</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">sync_reqd</span> <span class="o">=</span> <span class="n">bfa_ioc_ct_get_sync_reqd</span><span class="p">(</span><span class="n">r32</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">sync_ackd</span> <span class="o">=</span> <span class="n">bfa_ioc_ct_get_sync_ackd</span><span class="p">(</span><span class="n">r32</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">tmp_ackd</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sync_ackd</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>

	<span class="cm">/**</span>
<span class="cm">	 * The check below is to see whether any other PCI fn</span>
<span class="cm">	 * has reinitialized the ASIC (reset sync_ackd bits)</span>
<span class="cm">	 * and failed again while this IOC was waiting for hw</span>
<span class="cm">	 * semaphore (in bfa_iocpf_sm_semwait()).</span>
<span class="cm">	 */</span>
	<span class="n">tmp_ackd</span> <span class="o">=</span> <span class="n">sync_ackd</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">sync_reqd</span> <span class="o">&amp;</span>  <span class="n">bfa_ioc_ct_sync_pos</span><span class="p">(</span><span class="n">ioc</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
			<span class="o">!</span><span class="p">(</span><span class="n">sync_ackd</span> <span class="o">&amp;</span> <span class="n">bfa_ioc_ct_sync_pos</span><span class="p">(</span><span class="n">ioc</span><span class="p">)))</span>
		<span class="n">sync_ackd</span> <span class="o">|=</span> <span class="n">bfa_ioc_ct_sync_pos</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sync_reqd</span> <span class="o">==</span> <span class="n">sync_ackd</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">bfa_ioc_ct_clear_sync_ackd</span><span class="p">(</span><span class="n">r32</span><span class="p">),</span>
				<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioc_regs</span><span class="p">.</span><span class="n">ioc_fail_sync</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">BFI_IOC_FAIL</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioc_regs</span><span class="p">.</span><span class="n">ioc_fwstate</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">BFI_IOC_FAIL</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioc_regs</span><span class="p">.</span><span class="n">alt_ioc_fwstate</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/**</span>
<span class="cm">	 * If another PCI fn reinitialized and failed again while</span>
<span class="cm">	 * this IOC was waiting for hw sem, the sync_ackd bit for</span>
<span class="cm">	 * this IOC need to be set again to allow reinitialization.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tmp_ackd</span> <span class="o">!=</span> <span class="n">sync_ackd</span><span class="p">)</span>
		<span class="n">writel</span><span class="p">((</span><span class="n">r32</span> <span class="o">|</span> <span class="n">sync_ackd</span><span class="p">),</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioc_regs</span><span class="p">.</span><span class="n">ioc_fail_sync</span><span class="p">);</span>

	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">enum</span> <span class="n">bfa_status</span>
<span class="nf">bfa_ioc_ct_pll_init</span><span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">rb</span><span class="p">,</span> <span class="k">enum</span> <span class="n">bfi_asic_mode</span> <span class="n">asic_mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span>	<span class="n">pll_sclk</span><span class="p">,</span> <span class="n">pll_fclk</span><span class="p">,</span> <span class="n">r32</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">fcmode</span> <span class="o">=</span> <span class="p">(</span><span class="n">asic_mode</span> <span class="o">==</span> <span class="n">BFI_ASIC_MODE_FC</span><span class="p">);</span>

	<span class="n">pll_sclk</span> <span class="o">=</span> <span class="n">__APP_PLL_SCLK_LRESETN</span> <span class="o">|</span> <span class="n">__APP_PLL_SCLK_ENARST</span> <span class="o">|</span>
		<span class="n">__APP_PLL_SCLK_RSEL200500</span> <span class="o">|</span> <span class="n">__APP_PLL_SCLK_P0_1</span><span class="p">(</span><span class="mi">3U</span><span class="p">)</span> <span class="o">|</span>
		<span class="n">__APP_PLL_SCLK_JITLMT0_1</span><span class="p">(</span><span class="mi">3U</span><span class="p">)</span> <span class="o">|</span>
		<span class="n">__APP_PLL_SCLK_CNTLMT0_1</span><span class="p">(</span><span class="mi">1U</span><span class="p">);</span>
	<span class="n">pll_fclk</span> <span class="o">=</span> <span class="n">__APP_PLL_LCLK_LRESETN</span> <span class="o">|</span> <span class="n">__APP_PLL_LCLK_ENARST</span> <span class="o">|</span>
		<span class="n">__APP_PLL_LCLK_RSEL200500</span> <span class="o">|</span> <span class="n">__APP_PLL_LCLK_P0_1</span><span class="p">(</span><span class="mi">3U</span><span class="p">)</span> <span class="o">|</span>
		<span class="n">__APP_PLL_LCLK_JITLMT0_1</span><span class="p">(</span><span class="mi">3U</span><span class="p">)</span> <span class="o">|</span>
		<span class="n">__APP_PLL_LCLK_CNTLMT0_1</span><span class="p">(</span><span class="mi">1U</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fcmode</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="n">rb</span> <span class="o">+</span> <span class="n">OP_MODE</span><span class="p">));</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">__APP_EMS_CMLCKSEL</span> <span class="o">|</span>
				<span class="n">__APP_EMS_REFCKBUFEN2</span> <span class="o">|</span>
				<span class="n">__APP_EMS_CHANNEL_SEL</span><span class="p">,</span>
				<span class="p">(</span><span class="n">rb</span> <span class="o">+</span> <span class="n">ETH_MAC_SER_REG</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">__GLOBAL_FCOE_MODE</span><span class="p">,</span> <span class="p">(</span><span class="n">rb</span> <span class="o">+</span> <span class="n">OP_MODE</span><span class="p">));</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">__APP_EMS_REFCKBUFEN1</span><span class="p">,</span>
				<span class="p">(</span><span class="n">rb</span> <span class="o">+</span> <span class="n">ETH_MAC_SER_REG</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">BFI_IOC_UNINIT</span><span class="p">,</span> <span class="p">(</span><span class="n">rb</span> <span class="o">+</span> <span class="n">BFA_IOC0_STATE_REG</span><span class="p">));</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">BFI_IOC_UNINIT</span><span class="p">,</span> <span class="p">(</span><span class="n">rb</span> <span class="o">+</span> <span class="n">BFA_IOC1_STATE_REG</span><span class="p">));</span>
	<span class="n">writel</span><span class="p">(</span><span class="mh">0xffffffffU</span><span class="p">,</span> <span class="p">(</span><span class="n">rb</span> <span class="o">+</span> <span class="n">HOSTFN0_INT_MSK</span><span class="p">));</span>
	<span class="n">writel</span><span class="p">(</span><span class="mh">0xffffffffU</span><span class="p">,</span> <span class="p">(</span><span class="n">rb</span> <span class="o">+</span> <span class="n">HOSTFN1_INT_MSK</span><span class="p">));</span>
	<span class="n">writel</span><span class="p">(</span><span class="mh">0xffffffffU</span><span class="p">,</span> <span class="p">(</span><span class="n">rb</span> <span class="o">+</span> <span class="n">HOSTFN0_INT_STATUS</span><span class="p">));</span>
	<span class="n">writel</span><span class="p">(</span><span class="mh">0xffffffffU</span><span class="p">,</span> <span class="p">(</span><span class="n">rb</span> <span class="o">+</span> <span class="n">HOSTFN1_INT_STATUS</span><span class="p">));</span>
	<span class="n">writel</span><span class="p">(</span><span class="mh">0xffffffffU</span><span class="p">,</span> <span class="p">(</span><span class="n">rb</span> <span class="o">+</span> <span class="n">HOSTFN0_INT_MSK</span><span class="p">));</span>
	<span class="n">writel</span><span class="p">(</span><span class="mh">0xffffffffU</span><span class="p">,</span> <span class="p">(</span><span class="n">rb</span> <span class="o">+</span> <span class="n">HOSTFN1_INT_MSK</span><span class="p">));</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">pll_sclk</span> <span class="o">|</span>
		<span class="n">__APP_PLL_SCLK_LOGIC_SOFT_RESET</span><span class="p">,</span>
		<span class="n">rb</span> <span class="o">+</span> <span class="n">APP_PLL_SCLK_CTL_REG</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">pll_fclk</span> <span class="o">|</span>
		<span class="n">__APP_PLL_LCLK_LOGIC_SOFT_RESET</span><span class="p">,</span>
		<span class="n">rb</span> <span class="o">+</span> <span class="n">APP_PLL_LCLK_CTL_REG</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">pll_sclk</span> <span class="o">|</span>
		<span class="n">__APP_PLL_SCLK_LOGIC_SOFT_RESET</span> <span class="o">|</span> <span class="n">__APP_PLL_SCLK_ENABLE</span><span class="p">,</span>
		<span class="n">rb</span> <span class="o">+</span> <span class="n">APP_PLL_SCLK_CTL_REG</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">pll_fclk</span> <span class="o">|</span>
		<span class="n">__APP_PLL_LCLK_LOGIC_SOFT_RESET</span> <span class="o">|</span> <span class="n">__APP_PLL_LCLK_ENABLE</span><span class="p">,</span>
		<span class="n">rb</span> <span class="o">+</span> <span class="n">APP_PLL_LCLK_CTL_REG</span><span class="p">);</span>
	<span class="n">readl</span><span class="p">(</span><span class="n">rb</span> <span class="o">+</span> <span class="n">HOSTFN0_INT_MSK</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">2000</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="mh">0xffffffffU</span><span class="p">,</span> <span class="p">(</span><span class="n">rb</span> <span class="o">+</span> <span class="n">HOSTFN0_INT_STATUS</span><span class="p">));</span>
	<span class="n">writel</span><span class="p">(</span><span class="mh">0xffffffffU</span><span class="p">,</span> <span class="p">(</span><span class="n">rb</span> <span class="o">+</span> <span class="n">HOSTFN1_INT_STATUS</span><span class="p">));</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">pll_sclk</span> <span class="o">|</span>
		<span class="n">__APP_PLL_SCLK_ENABLE</span><span class="p">,</span>
		<span class="n">rb</span> <span class="o">+</span> <span class="n">APP_PLL_SCLK_CTL_REG</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">pll_fclk</span> <span class="o">|</span>
		<span class="n">__APP_PLL_LCLK_ENABLE</span><span class="p">,</span>
		<span class="n">rb</span> <span class="o">+</span> <span class="n">APP_PLL_LCLK_CTL_REG</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fcmode</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">__PMM_1T_RESET_P</span><span class="p">,</span> <span class="p">(</span><span class="n">rb</span> <span class="o">+</span> <span class="n">PMM_1T_RESET_REG_P0</span><span class="p">));</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">__PMM_1T_RESET_P</span><span class="p">,</span> <span class="p">(</span><span class="n">rb</span> <span class="o">+</span> <span class="n">PMM_1T_RESET_REG_P1</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="n">r32</span> <span class="o">=</span> <span class="n">readl</span><span class="p">((</span><span class="n">rb</span> <span class="o">+</span> <span class="n">PSS_CTL_REG</span><span class="p">));</span>
	<span class="n">r32</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">__PSS_LMEM_RESET</span><span class="p">;</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">r32</span><span class="p">,</span> <span class="p">(</span><span class="n">rb</span> <span class="o">+</span> <span class="n">PSS_CTL_REG</span><span class="p">));</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fcmode</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="n">rb</span> <span class="o">+</span> <span class="n">PMM_1T_RESET_REG_P0</span><span class="p">));</span>
		<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="n">rb</span> <span class="o">+</span> <span class="n">PMM_1T_RESET_REG_P1</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="n">writel</span><span class="p">(</span><span class="n">__EDRAM_BISTR_START</span><span class="p">,</span> <span class="p">(</span><span class="n">rb</span> <span class="o">+</span> <span class="n">MBIST_CTL_REG</span><span class="p">));</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
	<span class="n">r32</span> <span class="o">=</span> <span class="n">readl</span><span class="p">((</span><span class="n">rb</span> <span class="o">+</span> <span class="n">MBIST_STAT_REG</span><span class="p">));</span>
	<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="n">rb</span> <span class="o">+</span> <span class="n">MBIST_CTL_REG</span><span class="p">));</span>
	<span class="k">return</span> <span class="n">BFA_STATUS_OK</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_ioc_ct2_sclk_init</span><span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">rb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">r32</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * put s_clk PLL and PLL FSM in reset</span>
<span class="cm">	 */</span>
	<span class="n">r32</span> <span class="o">=</span> <span class="n">readl</span><span class="p">((</span><span class="n">rb</span> <span class="o">+</span> <span class="n">CT2_APP_PLL_SCLK_CTL_REG</span><span class="p">));</span>
	<span class="n">r32</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">__APP_PLL_SCLK_ENABLE</span> <span class="o">|</span> <span class="n">__APP_PLL_SCLK_LRESETN</span><span class="p">);</span>
	<span class="n">r32</span> <span class="o">|=</span> <span class="p">(</span><span class="n">__APP_PLL_SCLK_ENARST</span> <span class="o">|</span> <span class="n">__APP_PLL_SCLK_BYPASS</span> <span class="o">|</span>
		<span class="n">__APP_PLL_SCLK_LOGIC_SOFT_RESET</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">r32</span><span class="p">,</span> <span class="p">(</span><span class="n">rb</span> <span class="o">+</span> <span class="n">CT2_APP_PLL_SCLK_CTL_REG</span><span class="p">));</span>

	<span class="cm">/*</span>
<span class="cm">	 * Ignore mode and program for the max clock (which is FC16)</span>
<span class="cm">	 * Firmware/NFC will do the PLL init appropiately</span>
<span class="cm">	 */</span>
	<span class="n">r32</span> <span class="o">=</span> <span class="n">readl</span><span class="p">((</span><span class="n">rb</span> <span class="o">+</span> <span class="n">CT2_APP_PLL_SCLK_CTL_REG</span><span class="p">));</span>
	<span class="n">r32</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">__APP_PLL_SCLK_REFCLK_SEL</span> <span class="o">|</span> <span class="n">__APP_PLL_SCLK_CLK_DIV2</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">r32</span><span class="p">,</span> <span class="p">(</span><span class="n">rb</span> <span class="o">+</span> <span class="n">CT2_APP_PLL_SCLK_CTL_REG</span><span class="p">));</span>

	<span class="cm">/*</span>
<span class="cm">	 * while doing PLL init dont clock gate ethernet subsystem</span>
<span class="cm">	 */</span>
	<span class="n">r32</span> <span class="o">=</span> <span class="n">readl</span><span class="p">((</span><span class="n">rb</span> <span class="o">+</span> <span class="n">CT2_CHIP_MISC_PRG</span><span class="p">));</span>
	<span class="n">writel</span><span class="p">((</span><span class="n">r32</span> <span class="o">|</span> <span class="n">__ETH_CLK_ENABLE_PORT0</span><span class="p">),</span>
				<span class="p">(</span><span class="n">rb</span> <span class="o">+</span> <span class="n">CT2_CHIP_MISC_PRG</span><span class="p">));</span>

	<span class="n">r32</span> <span class="o">=</span> <span class="n">readl</span><span class="p">((</span><span class="n">rb</span> <span class="o">+</span> <span class="n">CT2_PCIE_MISC_REG</span><span class="p">));</span>
	<span class="n">writel</span><span class="p">((</span><span class="n">r32</span> <span class="o">|</span> <span class="n">__ETH_CLK_ENABLE_PORT1</span><span class="p">),</span>
				<span class="p">(</span><span class="n">rb</span> <span class="o">+</span> <span class="n">CT2_PCIE_MISC_REG</span><span class="p">));</span>

	<span class="cm">/*</span>
<span class="cm">	 * set sclk value</span>
<span class="cm">	 */</span>
	<span class="n">r32</span> <span class="o">=</span> <span class="n">readl</span><span class="p">((</span><span class="n">rb</span> <span class="o">+</span> <span class="n">CT2_APP_PLL_SCLK_CTL_REG</span><span class="p">));</span>
	<span class="n">r32</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="n">__P_SCLK_PLL_LOCK</span> <span class="o">|</span> <span class="n">__APP_PLL_SCLK_REFCLK_SEL</span> <span class="o">|</span>
		<span class="n">__APP_PLL_SCLK_CLK_DIV2</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">r32</span> <span class="o">|</span> <span class="mh">0x1061731b</span><span class="p">,</span> <span class="p">(</span><span class="n">rb</span> <span class="o">+</span> <span class="n">CT2_APP_PLL_SCLK_CTL_REG</span><span class="p">));</span>

	<span class="cm">/*</span>
<span class="cm">	 * poll for s_clk lock or delay 1ms</span>
<span class="cm">	 */</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Dont do clock gating for ethernet subsystem, firmware/NFC will</span>
<span class="cm">	 * do this appropriately</span>
<span class="cm">	 */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_ioc_ct2_lclk_init</span><span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">rb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">r32</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * put l_clk PLL and PLL FSM in reset</span>
<span class="cm">	 */</span>
	<span class="n">r32</span> <span class="o">=</span> <span class="n">readl</span><span class="p">((</span><span class="n">rb</span> <span class="o">+</span> <span class="n">CT2_APP_PLL_LCLK_CTL_REG</span><span class="p">));</span>
	<span class="n">r32</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">__APP_PLL_LCLK_ENABLE</span> <span class="o">|</span> <span class="n">__APP_PLL_LCLK_LRESETN</span><span class="p">);</span>
	<span class="n">r32</span> <span class="o">|=</span> <span class="p">(</span><span class="n">__APP_PLL_LCLK_ENARST</span> <span class="o">|</span> <span class="n">__APP_PLL_LCLK_BYPASS</span> <span class="o">|</span>
		<span class="n">__APP_PLL_LCLK_LOGIC_SOFT_RESET</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">r32</span><span class="p">,</span> <span class="p">(</span><span class="n">rb</span> <span class="o">+</span> <span class="n">CT2_APP_PLL_LCLK_CTL_REG</span><span class="p">));</span>

	<span class="cm">/*</span>
<span class="cm">	 * set LPU speed (set for FC16 which will work for other modes)</span>
<span class="cm">	 */</span>
	<span class="n">r32</span> <span class="o">=</span> <span class="n">readl</span><span class="p">((</span><span class="n">rb</span> <span class="o">+</span> <span class="n">CT2_CHIP_MISC_PRG</span><span class="p">));</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">r32</span><span class="p">,</span> <span class="p">(</span><span class="n">rb</span> <span class="o">+</span> <span class="n">CT2_CHIP_MISC_PRG</span><span class="p">));</span>

	<span class="cm">/*</span>
<span class="cm">	 * set LPU half speed (set for FC16 which will work for other modes)</span>
<span class="cm">	 */</span>
	<span class="n">r32</span> <span class="o">=</span> <span class="n">readl</span><span class="p">((</span><span class="n">rb</span> <span class="o">+</span> <span class="n">CT2_APP_PLL_LCLK_CTL_REG</span><span class="p">));</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">r32</span><span class="p">,</span> <span class="p">(</span><span class="n">rb</span> <span class="o">+</span> <span class="n">CT2_APP_PLL_LCLK_CTL_REG</span><span class="p">));</span>

	<span class="cm">/*</span>
<span class="cm">	 * set lclk for mode (set for FC16)</span>
<span class="cm">	 */</span>
	<span class="n">r32</span> <span class="o">=</span> <span class="n">readl</span><span class="p">((</span><span class="n">rb</span> <span class="o">+</span> <span class="n">CT2_APP_PLL_LCLK_CTL_REG</span><span class="p">));</span>
	<span class="n">r32</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="n">__P_LCLK_PLL_LOCK</span> <span class="o">|</span> <span class="n">__APP_LPUCLK_HALFSPEED</span><span class="p">);</span>
	<span class="n">r32</span> <span class="o">|=</span> <span class="mh">0x20c1731b</span><span class="p">;</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">r32</span><span class="p">,</span> <span class="p">(</span><span class="n">rb</span> <span class="o">+</span> <span class="n">CT2_APP_PLL_LCLK_CTL_REG</span><span class="p">));</span>

	<span class="cm">/*</span>
<span class="cm">	 * poll for s_clk lock or delay 1ms</span>
<span class="cm">	 */</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_ioc_ct2_mem_init</span><span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">rb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">r32</span><span class="p">;</span>

	<span class="n">r32</span> <span class="o">=</span> <span class="n">readl</span><span class="p">((</span><span class="n">rb</span> <span class="o">+</span> <span class="n">PSS_CTL_REG</span><span class="p">));</span>
	<span class="n">r32</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">__PSS_LMEM_RESET</span><span class="p">;</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">r32</span><span class="p">,</span> <span class="p">(</span><span class="n">rb</span> <span class="o">+</span> <span class="n">PSS_CTL_REG</span><span class="p">));</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>

	<span class="n">writel</span><span class="p">(</span><span class="n">__EDRAM_BISTR_START</span><span class="p">,</span> <span class="p">(</span><span class="n">rb</span> <span class="o">+</span> <span class="n">CT2_MBIST_CTL_REG</span><span class="p">));</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="n">rb</span> <span class="o">+</span> <span class="n">CT2_MBIST_CTL_REG</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_ioc_ct2_mac_reset</span><span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">rb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">volatile</span> <span class="n">u32</span> <span class="n">r32</span><span class="p">;</span>

	<span class="n">bfa_ioc_ct2_sclk_init</span><span class="p">(</span><span class="n">rb</span><span class="p">);</span>
	<span class="n">bfa_ioc_ct2_lclk_init</span><span class="p">(</span><span class="n">rb</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * release soft reset on s_clk &amp; l_clk</span>
<span class="cm">	 */</span>
	<span class="n">r32</span> <span class="o">=</span> <span class="n">readl</span><span class="p">((</span><span class="n">rb</span> <span class="o">+</span> <span class="n">CT2_APP_PLL_SCLK_CTL_REG</span><span class="p">));</span>
	<span class="n">writel</span><span class="p">((</span><span class="n">r32</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">__APP_PLL_SCLK_LOGIC_SOFT_RESET</span><span class="p">),</span>
			<span class="p">(</span><span class="n">rb</span> <span class="o">+</span> <span class="n">CT2_APP_PLL_SCLK_CTL_REG</span><span class="p">));</span>

	<span class="cm">/*</span>
<span class="cm">	 * release soft reset on s_clk &amp; l_clk</span>
<span class="cm">	 */</span>
	<span class="n">r32</span> <span class="o">=</span> <span class="n">readl</span><span class="p">((</span><span class="n">rb</span> <span class="o">+</span> <span class="n">CT2_APP_PLL_LCLK_CTL_REG</span><span class="p">));</span>
	<span class="n">writel</span><span class="p">((</span><span class="n">r32</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">__APP_PLL_LCLK_LOGIC_SOFT_RESET</span><span class="p">),</span>
			<span class="p">(</span><span class="n">rb</span> <span class="o">+</span> <span class="n">CT2_APP_PLL_LCLK_CTL_REG</span><span class="p">));</span>

	<span class="cm">/* put port0, port1 MAC &amp; AHB in reset */</span>
	<span class="n">writel</span><span class="p">((</span><span class="n">__CSI_MAC_RESET</span> <span class="o">|</span> <span class="n">__CSI_MAC_AHB_RESET</span><span class="p">),</span>
			<span class="p">(</span><span class="n">rb</span> <span class="o">+</span> <span class="n">CT2_CSI_MAC_CONTROL_REG</span><span class="p">(</span><span class="mi">0</span><span class="p">)));</span>
	<span class="n">writel</span><span class="p">((</span><span class="n">__CSI_MAC_RESET</span> <span class="o">|</span> <span class="n">__CSI_MAC_AHB_RESET</span><span class="p">),</span>
			<span class="p">(</span><span class="n">rb</span> <span class="o">+</span> <span class="n">CT2_CSI_MAC_CONTROL_REG</span><span class="p">(</span><span class="mi">1</span><span class="p">)));</span>
<span class="p">}</span>

<span class="cp">#define CT2_NFC_MAX_DELAY       1000</span>
<span class="cp">#define CT2_NFC_VER_VALID       0x143</span>
<span class="cp">#define BFA_IOC_PLL_POLL        1000000</span>

<span class="k">static</span> <span class="n">bool</span>
<span class="nf">bfa_ioc_ct2_nfc_halted</span><span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">rb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">volatile</span> <span class="n">u32</span> <span class="n">r32</span><span class="p">;</span>

	<span class="n">r32</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">rb</span> <span class="o">+</span> <span class="n">CT2_NFC_CSR_SET_REG</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r32</span> <span class="o">&amp;</span> <span class="n">__NFC_CONTROLLER_HALTED</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>

	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bfa_ioc_ct2_nfc_resume</span><span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">rb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">volatile</span> <span class="n">u32</span> <span class="n">r32</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">writel</span><span class="p">(</span><span class="n">__HALT_NFC_CONTROLLER</span><span class="p">,</span> <span class="n">rb</span> <span class="o">+</span> <span class="n">CT2_NFC_CSR_CLR_REG</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">CT2_NFC_MAX_DELAY</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">r32</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">rb</span> <span class="o">+</span> <span class="n">CT2_NFC_CSR_SET_REG</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">r32</span> <span class="o">&amp;</span> <span class="n">__NFC_CONTROLLER_HALTED</span><span class="p">))</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">enum</span> <span class="n">bfa_status</span>
<span class="nf">bfa_ioc_ct2_pll_init</span><span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">rb</span><span class="p">,</span> <span class="k">enum</span> <span class="n">bfi_asic_mode</span> <span class="n">asic_mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">volatile</span> <span class="n">u32</span> <span class="n">wgn</span><span class="p">,</span> <span class="n">r32</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">nfc_ver</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">wgn</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">rb</span> <span class="o">+</span> <span class="n">CT2_WGN_STATUS</span><span class="p">);</span>

	<span class="n">nfc_ver</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">rb</span> <span class="o">+</span> <span class="n">CT2_RSC_GPR15_REG</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">wgn</span> <span class="o">==</span> <span class="p">(</span><span class="n">__A2T_AHB_LOAD</span> <span class="o">|</span> <span class="n">__WGN_READY</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
		<span class="p">(</span><span class="n">nfc_ver</span> <span class="o">&gt;=</span> <span class="n">CT2_NFC_VER_VALID</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bfa_ioc_ct2_nfc_halted</span><span class="p">(</span><span class="n">rb</span><span class="p">))</span>
			<span class="n">bfa_ioc_ct2_nfc_resume</span><span class="p">(</span><span class="n">rb</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">__RESET_AND_START_SCLK_LCLK_PLLS</span><span class="p">,</span>
				<span class="n">rb</span> <span class="o">+</span> <span class="n">CT2_CSI_FW_CTL_SET_REG</span><span class="p">);</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">BFA_IOC_PLL_POLL</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">r32</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">rb</span> <span class="o">+</span> <span class="n">CT2_APP_PLL_LCLK_CTL_REG</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">r32</span> <span class="o">&amp;</span> <span class="n">__RESET_AND_START_SCLK_LCLK_PLLS</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">r32</span> <span class="o">&amp;</span> <span class="n">__RESET_AND_START_SCLK_LCLK_PLLS</span><span class="p">));</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">BFA_IOC_PLL_POLL</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">r32</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">rb</span> <span class="o">+</span> <span class="n">CT2_APP_PLL_LCLK_CTL_REG</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">r32</span> <span class="o">&amp;</span> <span class="n">__RESET_AND_START_SCLK_LCLK_PLLS</span><span class="p">))</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="n">r32</span> <span class="o">&amp;</span> <span class="n">__RESET_AND_START_SCLK_LCLK_PLLS</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>

		<span class="n">r32</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">rb</span> <span class="o">+</span> <span class="n">CT2_CSI_FW_CTL_REG</span><span class="p">);</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="n">r32</span> <span class="o">&amp;</span> <span class="n">__RESET_AND_START_SCLK_LCLK_PLLS</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">__HALT_NFC_CONTROLLER</span><span class="p">,</span> <span class="p">(</span><span class="n">rb</span> <span class="o">+</span> <span class="n">CT2_NFC_CSR_SET_REG</span><span class="p">));</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">CT2_NFC_MAX_DELAY</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">r32</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">rb</span> <span class="o">+</span> <span class="n">CT2_NFC_CSR_SET_REG</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">r32</span> <span class="o">&amp;</span> <span class="n">__NFC_CONTROLLER_HALTED</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">bfa_ioc_ct2_mac_reset</span><span class="p">(</span><span class="n">rb</span><span class="p">);</span>
		<span class="n">bfa_ioc_ct2_sclk_init</span><span class="p">(</span><span class="n">rb</span><span class="p">);</span>
		<span class="n">bfa_ioc_ct2_lclk_init</span><span class="p">(</span><span class="n">rb</span><span class="p">);</span>

		<span class="cm">/* release soft reset on s_clk &amp; l_clk */</span>
		<span class="n">r32</span> <span class="o">=</span> <span class="n">readl</span><span class="p">((</span><span class="n">rb</span> <span class="o">+</span> <span class="n">CT2_APP_PLL_SCLK_CTL_REG</span><span class="p">));</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">r32</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">__APP_PLL_SCLK_LOGIC_SOFT_RESET</span><span class="p">,</span>
				<span class="n">rb</span> <span class="o">+</span> <span class="n">CT2_APP_PLL_SCLK_CTL_REG</span><span class="p">);</span>
		<span class="n">r32</span> <span class="o">=</span> <span class="n">readl</span><span class="p">((</span><span class="n">rb</span> <span class="o">+</span> <span class="n">CT2_APP_PLL_LCLK_CTL_REG</span><span class="p">));</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">r32</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">__APP_PLL_LCLK_LOGIC_SOFT_RESET</span><span class="p">,</span>
				<span class="n">rb</span> <span class="o">+</span> <span class="n">CT2_APP_PLL_LCLK_CTL_REG</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Announce flash device presence, if flash was corrupted. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wgn</span> <span class="o">==</span> <span class="p">(</span><span class="n">__WGN_READY</span> <span class="o">|</span> <span class="n">__GLBL_PF_VF_CFG_RDY</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">r32</span> <span class="o">=</span> <span class="n">readl</span><span class="p">((</span><span class="n">rb</span> <span class="o">+</span> <span class="n">PSS_GPIO_OUT_REG</span><span class="p">));</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">r32</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">1</span><span class="p">,</span> <span class="n">rb</span> <span class="o">+</span> <span class="n">PSS_GPIO_OUT_REG</span><span class="p">);</span>
		<span class="n">r32</span> <span class="o">=</span> <span class="n">readl</span><span class="p">((</span><span class="n">rb</span> <span class="o">+</span> <span class="n">PSS_GPIO_OE_REG</span><span class="p">));</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">r32</span> <span class="o">|</span> <span class="mi">1</span><span class="p">,</span> <span class="n">rb</span> <span class="o">+</span> <span class="n">PSS_GPIO_OE_REG</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Mask the interrupts and clear any</span>
<span class="cm">	 * pending interrupts left by BIOS/EFI</span>
<span class="cm">	 */</span>
	<span class="n">writel</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="n">rb</span> <span class="o">+</span> <span class="n">CT2_LPU0_HOSTFN_MBOX0_MSK</span><span class="p">));</span>
	<span class="n">writel</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="n">rb</span> <span class="o">+</span> <span class="n">CT2_LPU1_HOSTFN_MBOX0_MSK</span><span class="p">));</span>

	<span class="cm">/* For first time initialization, no need to clear interrupts */</span>
	<span class="n">r32</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">rb</span> <span class="o">+</span> <span class="n">HOST_SEM5_REG</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r32</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">r32</span> <span class="o">=</span> <span class="n">readl</span><span class="p">((</span><span class="n">rb</span> <span class="o">+</span> <span class="n">CT2_LPU0_HOSTFN_CMD_STAT</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r32</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">writel</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="n">rb</span> <span class="o">+</span> <span class="n">CT2_LPU0_HOSTFN_CMD_STAT</span><span class="p">));</span>
			<span class="n">readl</span><span class="p">((</span><span class="n">rb</span> <span class="o">+</span> <span class="n">CT2_LPU0_HOSTFN_CMD_STAT</span><span class="p">));</span>
		<span class="p">}</span>
		<span class="n">r32</span> <span class="o">=</span> <span class="n">readl</span><span class="p">((</span><span class="n">rb</span> <span class="o">+</span> <span class="n">CT2_LPU1_HOSTFN_CMD_STAT</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r32</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">writel</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="n">rb</span> <span class="o">+</span> <span class="n">CT2_LPU1_HOSTFN_CMD_STAT</span><span class="p">));</span>
			<span class="n">readl</span><span class="p">((</span><span class="n">rb</span> <span class="o">+</span> <span class="n">CT2_LPU1_HOSTFN_CMD_STAT</span><span class="p">));</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">bfa_ioc_ct2_mem_init</span><span class="p">(</span><span class="n">rb</span><span class="p">);</span>

	<span class="n">writel</span><span class="p">(</span><span class="n">BFI_IOC_UNINIT</span><span class="p">,</span> <span class="p">(</span><span class="n">rb</span> <span class="o">+</span> <span class="n">CT2_BFA_IOC0_STATE_REG</span><span class="p">));</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">BFI_IOC_UNINIT</span><span class="p">,</span> <span class="p">(</span><span class="n">rb</span> <span class="o">+</span> <span class="n">CT2_BFA_IOC1_STATE_REG</span><span class="p">));</span>
	<span class="k">return</span> <span class="n">BFA_STATUS_OK</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:5}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../../javascript/docco.min.js"></script>
</html>
