<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › ethernet › brocade › bna › bna_enet.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../../index.html"></a><h1>bna_enet.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Linux network driver for Brocade Converged Network Adapter.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify it</span>
<span class="cm"> * under the terms of the GNU General Public License (GPL) Version 2 as</span>
<span class="cm"> * published by the Free Software Foundation</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful, but</span>
<span class="cm"> * WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU</span>
<span class="cm"> * General Public License for more details.</span>
<span class="cm"> */</span>
<span class="cm">/*</span>
<span class="cm"> * Copyright (c) 2005-2011 Brocade Communications Systems, Inc.</span>
<span class="cm"> * All rights reserved</span>
<span class="cm"> * www.brocade.com</span>
<span class="cm"> */</span>
<span class="cp">#include &quot;bna.h&quot;</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span>
<span class="nf">ethport_can_be_up</span><span class="p">(</span><span class="k">struct</span> <span class="n">bna_ethport</span> <span class="o">*</span><span class="n">ethport</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ready</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ethport</span><span class="o">-&gt;</span><span class="n">bna</span><span class="o">-&gt;</span><span class="n">enet</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">BNA_ENET_T_REGULAR</span><span class="p">)</span>
		<span class="n">ready</span> <span class="o">=</span> <span class="p">((</span><span class="n">ethport</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">BNA_ETHPORT_F_ADMIN_UP</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			 <span class="p">(</span><span class="n">ethport</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">BNA_ETHPORT_F_RX_STARTED</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			 <span class="p">(</span><span class="n">ethport</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">BNA_ETHPORT_F_PORT_ENABLED</span><span class="p">));</span>
	<span class="k">else</span>
		<span class="n">ready</span> <span class="o">=</span> <span class="p">((</span><span class="n">ethport</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">BNA_ETHPORT_F_ADMIN_UP</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			 <span class="p">(</span><span class="n">ethport</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">BNA_ETHPORT_F_RX_STARTED</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			 <span class="o">!</span><span class="p">(</span><span class="n">ethport</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">BNA_ETHPORT_F_PORT_ENABLED</span><span class="p">));</span>
	<span class="k">return</span> <span class="n">ready</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define ethport_is_up ethport_can_be_up</span>

<span class="k">enum</span> <span class="n">bna_ethport_event</span> <span class="p">{</span>
	<span class="n">ETHPORT_E_START</span>			<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="n">ETHPORT_E_STOP</span>			<span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
	<span class="n">ETHPORT_E_FAIL</span>			<span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
	<span class="n">ETHPORT_E_UP</span>			<span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
	<span class="n">ETHPORT_E_DOWN</span>			<span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
	<span class="n">ETHPORT_E_FWRESP_UP_OK</span>		<span class="o">=</span> <span class="mi">6</span><span class="p">,</span>
	<span class="n">ETHPORT_E_FWRESP_DOWN</span>		<span class="o">=</span> <span class="mi">7</span><span class="p">,</span>
	<span class="n">ETHPORT_E_FWRESP_UP_FAIL</span>	<span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="n">bna_enet_event</span> <span class="p">{</span>
	<span class="n">ENET_E_START</span>			<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="n">ENET_E_STOP</span>			<span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
	<span class="n">ENET_E_FAIL</span>			<span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
	<span class="n">ENET_E_PAUSE_CFG</span>		<span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
	<span class="n">ENET_E_MTU_CFG</span>			<span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
	<span class="n">ENET_E_FWRESP_PAUSE</span>		<span class="o">=</span> <span class="mi">6</span><span class="p">,</span>
	<span class="n">ENET_E_CHLD_STOPPED</span>		<span class="o">=</span> <span class="mi">7</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="n">bna_ioceth_event</span> <span class="p">{</span>
	<span class="n">IOCETH_E_ENABLE</span>			<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="n">IOCETH_E_DISABLE</span>		<span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
	<span class="n">IOCETH_E_IOC_RESET</span>		<span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
	<span class="n">IOCETH_E_IOC_FAILED</span>		<span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
	<span class="n">IOCETH_E_IOC_READY</span>		<span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
	<span class="n">IOCETH_E_ENET_ATTR_RESP</span>		<span class="o">=</span> <span class="mi">6</span><span class="p">,</span>
	<span class="n">IOCETH_E_ENET_STOPPED</span>		<span class="o">=</span> <span class="mi">7</span><span class="p">,</span>
	<span class="n">IOCETH_E_IOC_DISABLED</span>		<span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
<span class="p">};</span>

<span class="cp">#define bna_stats_copy(_name, _type)					\</span>
<span class="cp">do {									\</span>
<span class="cp">	count = sizeof(struct bfi_enet_stats_ ## _type) / sizeof(u64);	\</span>
<span class="cp">	stats_src = (u64 *)&amp;bna-&gt;stats.hw_stats_kva-&gt;_name ## _stats;	\</span>
<span class="cp">	stats_dst = (u64 *)&amp;bna-&gt;stats.hw_stats._name ## _stats;	\</span>
<span class="cp">	for (i = 0; i &lt; count; i++)					\</span>
<span class="cp">		stats_dst[i] = be64_to_cpu(stats_src[i]);		\</span>
<span class="cp">} while (0)								\</span>

<span class="cm">/*</span>
<span class="cm"> * FW response handlers</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bna_bfi_ethport_enable_aen</span><span class="p">(</span><span class="k">struct</span> <span class="n">bna_ethport</span> <span class="o">*</span><span class="n">ethport</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">bfi_msgq_mhdr</span> <span class="o">*</span><span class="n">msghdr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ethport</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">BNA_ETHPORT_F_PORT_ENABLED</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ethport_can_be_up</span><span class="p">(</span><span class="n">ethport</span><span class="p">))</span>
		<span class="n">bfa_fsm_send_event</span><span class="p">(</span><span class="n">ethport</span><span class="p">,</span> <span class="n">ETHPORT_E_UP</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bna_bfi_ethport_disable_aen</span><span class="p">(</span><span class="k">struct</span> <span class="n">bna_ethport</span> <span class="o">*</span><span class="n">ethport</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">bfi_msgq_mhdr</span> <span class="o">*</span><span class="n">msghdr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ethport_up</span> <span class="o">=</span> <span class="n">ethport_is_up</span><span class="p">(</span><span class="n">ethport</span><span class="p">);</span>

	<span class="n">ethport</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">BNA_ETHPORT_F_PORT_ENABLED</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ethport_up</span><span class="p">)</span>
		<span class="n">bfa_fsm_send_event</span><span class="p">(</span><span class="n">ethport</span><span class="p">,</span> <span class="n">ETHPORT_E_DOWN</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bna_bfi_ethport_admin_rsp</span><span class="p">(</span><span class="k">struct</span> <span class="n">bna_ethport</span> <span class="o">*</span><span class="n">ethport</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">bfi_msgq_mhdr</span> <span class="o">*</span><span class="n">msghdr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfi_enet_enable_req</span> <span class="o">*</span><span class="n">admin_req</span> <span class="o">=</span>
		<span class="o">&amp;</span><span class="n">ethport</span><span class="o">-&gt;</span><span class="n">bfi_enet_cmd</span><span class="p">.</span><span class="n">admin_req</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bfi_enet_rsp</span> <span class="o">*</span><span class="n">rsp</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">bfi_enet_rsp</span> <span class="o">*</span><span class="p">)</span><span class="n">msghdr</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">admin_req</span><span class="o">-&gt;</span><span class="n">enable</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">BNA_STATUS_T_ENABLED</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">rsp</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">==</span> <span class="n">BFI_ENET_CMD_OK</span><span class="p">)</span>
			<span class="n">bfa_fsm_send_event</span><span class="p">(</span><span class="n">ethport</span><span class="p">,</span> <span class="n">ETHPORT_E_FWRESP_UP_OK</span><span class="p">);</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">ethport</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">BNA_ETHPORT_F_PORT_ENABLED</span><span class="p">;</span>
			<span class="n">bfa_fsm_send_event</span><span class="p">(</span><span class="n">ethport</span><span class="p">,</span> <span class="n">ETHPORT_E_FWRESP_UP_FAIL</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BNA_STATUS_T_DISABLED</span>:
		<span class="n">bfa_fsm_send_event</span><span class="p">(</span><span class="n">ethport</span><span class="p">,</span> <span class="n">ETHPORT_E_FWRESP_DOWN</span><span class="p">);</span>
		<span class="n">ethport</span><span class="o">-&gt;</span><span class="n">link_status</span> <span class="o">=</span> <span class="n">BNA_LINK_DOWN</span><span class="p">;</span>
		<span class="n">ethport</span><span class="o">-&gt;</span><span class="n">link_cbfn</span><span class="p">(</span><span class="n">ethport</span><span class="o">-&gt;</span><span class="n">bna</span><span class="o">-&gt;</span><span class="n">bnad</span><span class="p">,</span> <span class="n">BNA_LINK_DOWN</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bna_bfi_ethport_lpbk_rsp</span><span class="p">(</span><span class="k">struct</span> <span class="n">bna_ethport</span> <span class="o">*</span><span class="n">ethport</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">bfi_msgq_mhdr</span> <span class="o">*</span><span class="n">msghdr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfi_enet_diag_lb_req</span> <span class="o">*</span><span class="n">diag_lb_req</span> <span class="o">=</span>
		<span class="o">&amp;</span><span class="n">ethport</span><span class="o">-&gt;</span><span class="n">bfi_enet_cmd</span><span class="p">.</span><span class="n">lpbk_req</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bfi_enet_rsp</span> <span class="o">*</span><span class="n">rsp</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">bfi_enet_rsp</span> <span class="o">*</span><span class="p">)</span><span class="n">msghdr</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">diag_lb_req</span><span class="o">-&gt;</span><span class="n">enable</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">BNA_STATUS_T_ENABLED</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">rsp</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">==</span> <span class="n">BFI_ENET_CMD_OK</span><span class="p">)</span>
			<span class="n">bfa_fsm_send_event</span><span class="p">(</span><span class="n">ethport</span><span class="p">,</span> <span class="n">ETHPORT_E_FWRESP_UP_OK</span><span class="p">);</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">ethport</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">BNA_ETHPORT_F_ADMIN_UP</span><span class="p">;</span>
			<span class="n">bfa_fsm_send_event</span><span class="p">(</span><span class="n">ethport</span><span class="p">,</span> <span class="n">ETHPORT_E_FWRESP_UP_FAIL</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BNA_STATUS_T_DISABLED</span>:
		<span class="n">bfa_fsm_send_event</span><span class="p">(</span><span class="n">ethport</span><span class="p">,</span> <span class="n">ETHPORT_E_FWRESP_DOWN</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bna_bfi_pause_set_rsp</span><span class="p">(</span><span class="k">struct</span> <span class="n">bna_enet</span> <span class="o">*</span><span class="n">enet</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bfi_msgq_mhdr</span> <span class="o">*</span><span class="n">msghdr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfa_fsm_send_event</span><span class="p">(</span><span class="n">enet</span><span class="p">,</span> <span class="n">ENET_E_FWRESP_PAUSE</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bna_bfi_attr_get_rsp</span><span class="p">(</span><span class="k">struct</span> <span class="n">bna_ioceth</span> <span class="o">*</span><span class="n">ioceth</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">bfi_msgq_mhdr</span> <span class="o">*</span><span class="n">msghdr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfi_enet_attr_rsp</span> <span class="o">*</span><span class="n">rsp</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">bfi_enet_attr_rsp</span> <span class="o">*</span><span class="p">)</span><span class="n">msghdr</span><span class="p">;</span>

	<span class="cm">/**</span>
<span class="cm">	 * Store only if not set earlier, since BNAD can override the HW</span>
<span class="cm">	 * attributes</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ioceth</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">fw_query_complete</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ioceth</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">num_txq</span> <span class="o">=</span> <span class="n">ntohl</span><span class="p">(</span><span class="n">rsp</span><span class="o">-&gt;</span><span class="n">max_cfg</span><span class="p">);</span>
		<span class="n">ioceth</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">num_rxp</span> <span class="o">=</span> <span class="n">ntohl</span><span class="p">(</span><span class="n">rsp</span><span class="o">-&gt;</span><span class="n">max_cfg</span><span class="p">);</span>
		<span class="n">ioceth</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">num_ucmac</span> <span class="o">=</span> <span class="n">ntohl</span><span class="p">(</span><span class="n">rsp</span><span class="o">-&gt;</span><span class="n">max_ucmac</span><span class="p">);</span>
		<span class="n">ioceth</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">num_mcmac</span> <span class="o">=</span> <span class="n">BFI_ENET_MAX_MCAM</span><span class="p">;</span>
		<span class="n">ioceth</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">max_rit_size</span> <span class="o">=</span> <span class="n">ntohl</span><span class="p">(</span><span class="n">rsp</span><span class="o">-&gt;</span><span class="n">rit_size</span><span class="p">);</span>
		<span class="n">ioceth</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">fw_query_complete</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">bfa_fsm_send_event</span><span class="p">(</span><span class="n">ioceth</span><span class="p">,</span> <span class="n">IOCETH_E_ENET_ATTR_RESP</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bna_bfi_stats_get_rsp</span><span class="p">(</span><span class="k">struct</span> <span class="n">bna</span> <span class="o">*</span><span class="n">bna</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bfi_msgq_mhdr</span> <span class="o">*</span><span class="n">msghdr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfi_enet_stats_req</span> <span class="o">*</span><span class="n">stats_req</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">bna</span><span class="o">-&gt;</span><span class="n">stats_mod</span><span class="p">.</span><span class="n">stats_get</span><span class="p">;</span>
	<span class="n">u64</span> <span class="o">*</span><span class="n">stats_src</span><span class="p">;</span>
	<span class="n">u64</span> <span class="o">*</span><span class="n">stats_dst</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tx_enet_mask</span> <span class="o">=</span> <span class="n">ntohl</span><span class="p">(</span><span class="n">stats_req</span><span class="o">-&gt;</span><span class="n">tx_enet_mask</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">rx_enet_mask</span> <span class="o">=</span> <span class="n">ntohl</span><span class="p">(</span><span class="n">stats_req</span><span class="o">-&gt;</span><span class="n">rx_enet_mask</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">count</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">bna_stats_copy</span><span class="p">(</span><span class="n">mac</span><span class="p">,</span> <span class="n">mac</span><span class="p">);</span>
	<span class="n">bna_stats_copy</span><span class="p">(</span><span class="n">bpc</span><span class="p">,</span> <span class="n">bpc</span><span class="p">);</span>
	<span class="n">bna_stats_copy</span><span class="p">(</span><span class="n">rad</span><span class="p">,</span> <span class="n">rad</span><span class="p">);</span>
	<span class="n">bna_stats_copy</span><span class="p">(</span><span class="n">rlb</span><span class="p">,</span> <span class="n">rad</span><span class="p">);</span>
	<span class="n">bna_stats_copy</span><span class="p">(</span><span class="n">fc_rx</span><span class="p">,</span> <span class="n">fc_rx</span><span class="p">);</span>
	<span class="n">bna_stats_copy</span><span class="p">(</span><span class="n">fc_tx</span><span class="p">,</span> <span class="n">fc_tx</span><span class="p">);</span>

	<span class="n">stats_src</span> <span class="o">=</span> <span class="p">(</span><span class="n">u64</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">bna</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">hw_stats_kva</span><span class="o">-&gt;</span><span class="n">rxf_stats</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>

	<span class="cm">/* Copy Rxf stats to SW area, scatter them while copying */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">BFI_ENET_CFG_MAX</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">stats_dst</span> <span class="o">=</span> <span class="p">(</span><span class="n">u64</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">bna</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">hw_stats</span><span class="p">.</span><span class="n">rxf_stats</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">stats_dst</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfi_enet_stats_rxf</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rx_enet_mask</span> <span class="o">&amp;</span> <span class="p">((</span><span class="n">u32</span><span class="p">)(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">)))</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">k</span><span class="p">;</span>
			<span class="n">count</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfi_enet_stats_rxf</span><span class="p">)</span> <span class="o">/</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="n">u64</span><span class="p">);</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">count</span><span class="p">;</span> <span class="n">k</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">stats_dst</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">be64_to_cpu</span><span class="p">(</span><span class="o">*</span><span class="n">stats_src</span><span class="p">);</span>
				<span class="n">stats_src</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Copy Txf stats to SW area, scatter them while copying */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">BFI_ENET_CFG_MAX</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">stats_dst</span> <span class="o">=</span> <span class="p">(</span><span class="n">u64</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">bna</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">hw_stats</span><span class="p">.</span><span class="n">txf_stats</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">stats_dst</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfi_enet_stats_txf</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tx_enet_mask</span> <span class="o">&amp;</span> <span class="p">((</span><span class="n">u32</span><span class="p">)(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">)))</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">k</span><span class="p">;</span>
			<span class="n">count</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfi_enet_stats_txf</span><span class="p">)</span> <span class="o">/</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="n">u64</span><span class="p">);</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">count</span><span class="p">;</span> <span class="n">k</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">stats_dst</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">be64_to_cpu</span><span class="p">(</span><span class="o">*</span><span class="n">stats_src</span><span class="p">);</span>
				<span class="n">stats_src</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">bna</span><span class="o">-&gt;</span><span class="n">stats_mod</span><span class="p">.</span><span class="n">stats_get_busy</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">bnad_cb_stats_get</span><span class="p">(</span><span class="n">bna</span><span class="o">-&gt;</span><span class="n">bnad</span><span class="p">,</span> <span class="n">BNA_CB_SUCCESS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bna</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bna_bfi_ethport_linkup_aen</span><span class="p">(</span><span class="k">struct</span> <span class="n">bna_ethport</span> <span class="o">*</span><span class="n">ethport</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">bfi_msgq_mhdr</span> <span class="o">*</span><span class="n">msghdr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ethport</span><span class="o">-&gt;</span><span class="n">link_status</span> <span class="o">=</span> <span class="n">BNA_LINK_UP</span><span class="p">;</span>

	<span class="cm">/* Dispatch events */</span>
	<span class="n">ethport</span><span class="o">-&gt;</span><span class="n">link_cbfn</span><span class="p">(</span><span class="n">ethport</span><span class="o">-&gt;</span><span class="n">bna</span><span class="o">-&gt;</span><span class="n">bnad</span><span class="p">,</span> <span class="n">ethport</span><span class="o">-&gt;</span><span class="n">link_status</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bna_bfi_ethport_linkdown_aen</span><span class="p">(</span><span class="k">struct</span> <span class="n">bna_ethport</span> <span class="o">*</span><span class="n">ethport</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">bfi_msgq_mhdr</span> <span class="o">*</span><span class="n">msghdr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ethport</span><span class="o">-&gt;</span><span class="n">link_status</span> <span class="o">=</span> <span class="n">BNA_LINK_DOWN</span><span class="p">;</span>

	<span class="cm">/* Dispatch events */</span>
	<span class="n">ethport</span><span class="o">-&gt;</span><span class="n">link_cbfn</span><span class="p">(</span><span class="n">ethport</span><span class="o">-&gt;</span><span class="n">bna</span><span class="o">-&gt;</span><span class="n">bnad</span><span class="p">,</span> <span class="n">BNA_LINK_DOWN</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bna_err_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">bna</span> <span class="o">*</span><span class="n">bna</span><span class="p">,</span> <span class="n">u32</span> <span class="n">intr_status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">BNA_IS_HALT_INTR</span><span class="p">(</span><span class="n">bna</span><span class="p">,</span> <span class="n">intr_status</span><span class="p">))</span>
		<span class="n">bna_halt_clear</span><span class="p">(</span><span class="n">bna</span><span class="p">);</span>

	<span class="n">bfa_nw_ioc_error_isr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bna</span><span class="o">-&gt;</span><span class="n">ioceth</span><span class="p">.</span><span class="n">ioc</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">bna_mbox_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">bna</span> <span class="o">*</span><span class="n">bna</span><span class="p">,</span> <span class="n">u32</span> <span class="n">intr_status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">BNA_IS_ERR_INTR</span><span class="p">(</span><span class="n">bna</span><span class="p">,</span> <span class="n">intr_status</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">bna_err_handler</span><span class="p">(</span><span class="n">bna</span><span class="p">,</span> <span class="n">intr_status</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">BNA_IS_MBOX_INTR</span><span class="p">(</span><span class="n">bna</span><span class="p">,</span> <span class="n">intr_status</span><span class="p">))</span>
		<span class="n">bfa_nw_ioc_mbox_isr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bna</span><span class="o">-&gt;</span><span class="n">ioceth</span><span class="p">.</span><span class="n">ioc</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bna_msgq_rsp_handler</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bfi_msgq_mhdr</span> <span class="o">*</span><span class="n">msghdr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bna</span> <span class="o">*</span><span class="n">bna</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">bna</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bna_tx</span> <span class="o">*</span><span class="n">tx</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bna_rx</span> <span class="o">*</span><span class="n">rx</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">msghdr</span><span class="o">-&gt;</span><span class="n">msg_id</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">BFI_ENET_I2H_RX_CFG_SET_RSP</span>:
		<span class="n">bna_rx_from_rid</span><span class="p">(</span><span class="n">bna</span><span class="p">,</span> <span class="n">msghdr</span><span class="o">-&gt;</span><span class="n">enet_id</span><span class="p">,</span> <span class="n">rx</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rx</span><span class="p">)</span>
			<span class="n">bna_bfi_rx_enet_start_rsp</span><span class="p">(</span><span class="n">rx</span><span class="p">,</span> <span class="n">msghdr</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFI_ENET_I2H_RX_CFG_CLR_RSP</span>:
		<span class="n">bna_rx_from_rid</span><span class="p">(</span><span class="n">bna</span><span class="p">,</span> <span class="n">msghdr</span><span class="o">-&gt;</span><span class="n">enet_id</span><span class="p">,</span> <span class="n">rx</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rx</span><span class="p">)</span>
			<span class="n">bna_bfi_rx_enet_stop_rsp</span><span class="p">(</span><span class="n">rx</span><span class="p">,</span> <span class="n">msghdr</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFI_ENET_I2H_RIT_CFG_RSP</span>:
	<span class="k">case</span> <span class="n">BFI_ENET_I2H_RSS_CFG_RSP</span>:
	<span class="k">case</span> <span class="n">BFI_ENET_I2H_RSS_ENABLE_RSP</span>:
	<span class="k">case</span> <span class="n">BFI_ENET_I2H_RX_PROMISCUOUS_RSP</span>:
	<span class="k">case</span> <span class="n">BFI_ENET_I2H_RX_DEFAULT_RSP</span>:
	<span class="k">case</span> <span class="n">BFI_ENET_I2H_MAC_UCAST_SET_RSP</span>:
	<span class="k">case</span> <span class="n">BFI_ENET_I2H_MAC_UCAST_CLR_RSP</span>:
	<span class="k">case</span> <span class="n">BFI_ENET_I2H_MAC_UCAST_ADD_RSP</span>:
	<span class="k">case</span> <span class="n">BFI_ENET_I2H_MAC_UCAST_DEL_RSP</span>:
	<span class="k">case</span> <span class="n">BFI_ENET_I2H_MAC_MCAST_DEL_RSP</span>:
	<span class="k">case</span> <span class="n">BFI_ENET_I2H_MAC_MCAST_FILTER_RSP</span>:
	<span class="k">case</span> <span class="n">BFI_ENET_I2H_RX_VLAN_SET_RSP</span>:
	<span class="k">case</span> <span class="n">BFI_ENET_I2H_RX_VLAN_STRIP_ENABLE_RSP</span>:
		<span class="n">bna_rx_from_rid</span><span class="p">(</span><span class="n">bna</span><span class="p">,</span> <span class="n">msghdr</span><span class="o">-&gt;</span><span class="n">enet_id</span><span class="p">,</span> <span class="n">rx</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rx</span><span class="p">)</span>
			<span class="n">bna_bfi_rxf_cfg_rsp</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">rxf</span><span class="p">,</span> <span class="n">msghdr</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFI_ENET_I2H_MAC_MCAST_ADD_RSP</span>:
		<span class="n">bna_rx_from_rid</span><span class="p">(</span><span class="n">bna</span><span class="p">,</span> <span class="n">msghdr</span><span class="o">-&gt;</span><span class="n">enet_id</span><span class="p">,</span> <span class="n">rx</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rx</span><span class="p">)</span>
			<span class="n">bna_bfi_rxf_mcast_add_rsp</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">rxf</span><span class="p">,</span> <span class="n">msghdr</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFI_ENET_I2H_TX_CFG_SET_RSP</span>:
		<span class="n">bna_tx_from_rid</span><span class="p">(</span><span class="n">bna</span><span class="p">,</span> <span class="n">msghdr</span><span class="o">-&gt;</span><span class="n">enet_id</span><span class="p">,</span> <span class="n">tx</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tx</span><span class="p">)</span>
			<span class="n">bna_bfi_tx_enet_start_rsp</span><span class="p">(</span><span class="n">tx</span><span class="p">,</span> <span class="n">msghdr</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFI_ENET_I2H_TX_CFG_CLR_RSP</span>:
		<span class="n">bna_tx_from_rid</span><span class="p">(</span><span class="n">bna</span><span class="p">,</span> <span class="n">msghdr</span><span class="o">-&gt;</span><span class="n">enet_id</span><span class="p">,</span> <span class="n">tx</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tx</span><span class="p">)</span>
			<span class="n">bna_bfi_tx_enet_stop_rsp</span><span class="p">(</span><span class="n">tx</span><span class="p">,</span> <span class="n">msghdr</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFI_ENET_I2H_PORT_ADMIN_RSP</span>:
		<span class="n">bna_bfi_ethport_admin_rsp</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bna</span><span class="o">-&gt;</span><span class="n">ethport</span><span class="p">,</span> <span class="n">msghdr</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFI_ENET_I2H_DIAG_LOOPBACK_RSP</span>:
		<span class="n">bna_bfi_ethport_lpbk_rsp</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bna</span><span class="o">-&gt;</span><span class="n">ethport</span><span class="p">,</span> <span class="n">msghdr</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFI_ENET_I2H_SET_PAUSE_RSP</span>:
		<span class="n">bna_bfi_pause_set_rsp</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bna</span><span class="o">-&gt;</span><span class="n">enet</span><span class="p">,</span> <span class="n">msghdr</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFI_ENET_I2H_GET_ATTR_RSP</span>:
		<span class="n">bna_bfi_attr_get_rsp</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bna</span><span class="o">-&gt;</span><span class="n">ioceth</span><span class="p">,</span> <span class="n">msghdr</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFI_ENET_I2H_STATS_GET_RSP</span>:
		<span class="n">bna_bfi_stats_get_rsp</span><span class="p">(</span><span class="n">bna</span><span class="p">,</span> <span class="n">msghdr</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFI_ENET_I2H_STATS_CLR_RSP</span>:
		<span class="cm">/* No-op */</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFI_ENET_I2H_LINK_UP_AEN</span>:
		<span class="n">bna_bfi_ethport_linkup_aen</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bna</span><span class="o">-&gt;</span><span class="n">ethport</span><span class="p">,</span> <span class="n">msghdr</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFI_ENET_I2H_LINK_DOWN_AEN</span>:
		<span class="n">bna_bfi_ethport_linkdown_aen</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bna</span><span class="o">-&gt;</span><span class="n">ethport</span><span class="p">,</span> <span class="n">msghdr</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFI_ENET_I2H_PORT_ENABLE_AEN</span>:
		<span class="n">bna_bfi_ethport_enable_aen</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bna</span><span class="o">-&gt;</span><span class="n">ethport</span><span class="p">,</span> <span class="n">msghdr</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFI_ENET_I2H_PORT_DISABLE_AEN</span>:
		<span class="n">bna_bfi_ethport_disable_aen</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bna</span><span class="o">-&gt;</span><span class="n">ethport</span><span class="p">,</span> <span class="n">msghdr</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BFI_ENET_I2H_BW_UPDATE_AEN</span>:
		<span class="n">bna_bfi_bw_update_aen</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bna</span><span class="o">-&gt;</span><span class="n">tx_mod</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ETHPORT</span>
<span class="cm"> */</span>
<span class="cp">#define call_ethport_stop_cbfn(_ethport)				\</span>
<span class="cp">do {									\</span>
<span class="cp">	if ((_ethport)-&gt;stop_cbfn) {					\</span>
<span class="cp">		void (*cbfn)(struct bna_enet *);			\</span>
<span class="cp">		cbfn = (_ethport)-&gt;stop_cbfn;				\</span>
<span class="cp">		(_ethport)-&gt;stop_cbfn = NULL;				\</span>
<span class="cp">		cbfn(&amp;(_ethport)-&gt;bna-&gt;enet);				\</span>
<span class="cp">	}								\</span>
<span class="cp">} while (0)</span>

<span class="cp">#define call_ethport_adminup_cbfn(ethport, status)			\</span>
<span class="cp">do {									\</span>
<span class="cp">	if ((ethport)-&gt;adminup_cbfn) {					\</span>
<span class="cp">		void (*cbfn)(struct bnad *, enum bna_cb_status);	\</span>
<span class="cp">		cbfn = (ethport)-&gt;adminup_cbfn;				\</span>
<span class="cp">		(ethport)-&gt;adminup_cbfn = NULL;				\</span>
<span class="cp">		cbfn((ethport)-&gt;bna-&gt;bnad, status);			\</span>
<span class="cp">	}								\</span>
<span class="cp">} while (0)</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bna_bfi_ethport_admin_up</span><span class="p">(</span><span class="k">struct</span> <span class="n">bna_ethport</span> <span class="o">*</span><span class="n">ethport</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfi_enet_enable_req</span> <span class="o">*</span><span class="n">admin_up_req</span> <span class="o">=</span>
		<span class="o">&amp;</span><span class="n">ethport</span><span class="o">-&gt;</span><span class="n">bfi_enet_cmd</span><span class="p">.</span><span class="n">admin_req</span><span class="p">;</span>

	<span class="n">bfi_msgq_mhdr_set</span><span class="p">(</span><span class="n">admin_up_req</span><span class="o">-&gt;</span><span class="n">mh</span><span class="p">,</span> <span class="n">BFI_MC_ENET</span><span class="p">,</span>
		<span class="n">BFI_ENET_H2I_PORT_ADMIN_UP_REQ</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">admin_up_req</span><span class="o">-&gt;</span><span class="n">mh</span><span class="p">.</span><span class="n">num_entries</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span>
		<span class="n">bfi_msgq_num_cmd_entries</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfi_enet_enable_req</span><span class="p">)));</span>
	<span class="n">admin_up_req</span><span class="o">-&gt;</span><span class="n">enable</span> <span class="o">=</span> <span class="n">BNA_STATUS_T_ENABLED</span><span class="p">;</span>

	<span class="n">bfa_msgq_cmd_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ethport</span><span class="o">-&gt;</span><span class="n">msgq_cmd</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
		<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfi_enet_enable_req</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">admin_up_req</span><span class="o">-&gt;</span><span class="n">mh</span><span class="p">);</span>
	<span class="n">bfa_msgq_cmd_post</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ethport</span><span class="o">-&gt;</span><span class="n">bna</span><span class="o">-&gt;</span><span class="n">msgq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ethport</span><span class="o">-&gt;</span><span class="n">msgq_cmd</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bna_bfi_ethport_admin_down</span><span class="p">(</span><span class="k">struct</span> <span class="n">bna_ethport</span> <span class="o">*</span><span class="n">ethport</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfi_enet_enable_req</span> <span class="o">*</span><span class="n">admin_down_req</span> <span class="o">=</span>
		<span class="o">&amp;</span><span class="n">ethport</span><span class="o">-&gt;</span><span class="n">bfi_enet_cmd</span><span class="p">.</span><span class="n">admin_req</span><span class="p">;</span>

	<span class="n">bfi_msgq_mhdr_set</span><span class="p">(</span><span class="n">admin_down_req</span><span class="o">-&gt;</span><span class="n">mh</span><span class="p">,</span> <span class="n">BFI_MC_ENET</span><span class="p">,</span>
		<span class="n">BFI_ENET_H2I_PORT_ADMIN_UP_REQ</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">admin_down_req</span><span class="o">-&gt;</span><span class="n">mh</span><span class="p">.</span><span class="n">num_entries</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span>
		<span class="n">bfi_msgq_num_cmd_entries</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfi_enet_enable_req</span><span class="p">)));</span>
	<span class="n">admin_down_req</span><span class="o">-&gt;</span><span class="n">enable</span> <span class="o">=</span> <span class="n">BNA_STATUS_T_DISABLED</span><span class="p">;</span>

	<span class="n">bfa_msgq_cmd_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ethport</span><span class="o">-&gt;</span><span class="n">msgq_cmd</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
		<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfi_enet_enable_req</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">admin_down_req</span><span class="o">-&gt;</span><span class="n">mh</span><span class="p">);</span>
	<span class="n">bfa_msgq_cmd_post</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ethport</span><span class="o">-&gt;</span><span class="n">bna</span><span class="o">-&gt;</span><span class="n">msgq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ethport</span><span class="o">-&gt;</span><span class="n">msgq_cmd</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bna_bfi_ethport_lpbk_up</span><span class="p">(</span><span class="k">struct</span> <span class="n">bna_ethport</span> <span class="o">*</span><span class="n">ethport</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfi_enet_diag_lb_req</span> <span class="o">*</span><span class="n">lpbk_up_req</span> <span class="o">=</span>
		<span class="o">&amp;</span><span class="n">ethport</span><span class="o">-&gt;</span><span class="n">bfi_enet_cmd</span><span class="p">.</span><span class="n">lpbk_req</span><span class="p">;</span>

	<span class="n">bfi_msgq_mhdr_set</span><span class="p">(</span><span class="n">lpbk_up_req</span><span class="o">-&gt;</span><span class="n">mh</span><span class="p">,</span> <span class="n">BFI_MC_ENET</span><span class="p">,</span>
		<span class="n">BFI_ENET_H2I_DIAG_LOOPBACK_REQ</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">lpbk_up_req</span><span class="o">-&gt;</span><span class="n">mh</span><span class="p">.</span><span class="n">num_entries</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span>
		<span class="n">bfi_msgq_num_cmd_entries</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfi_enet_diag_lb_req</span><span class="p">)));</span>
	<span class="n">lpbk_up_req</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">=</span> <span class="p">(</span><span class="n">ethport</span><span class="o">-&gt;</span><span class="n">bna</span><span class="o">-&gt;</span><span class="n">enet</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span>
				<span class="n">BNA_ENET_T_LOOPBACK_INTERNAL</span><span class="p">)</span> <span class="o">?</span>
				<span class="n">BFI_ENET_DIAG_LB_OPMODE_EXT</span> <span class="o">:</span>
				<span class="n">BFI_ENET_DIAG_LB_OPMODE_CBL</span><span class="p">;</span>
	<span class="n">lpbk_up_req</span><span class="o">-&gt;</span><span class="n">enable</span> <span class="o">=</span> <span class="n">BNA_STATUS_T_ENABLED</span><span class="p">;</span>

	<span class="n">bfa_msgq_cmd_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ethport</span><span class="o">-&gt;</span><span class="n">msgq_cmd</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
		<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfi_enet_diag_lb_req</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">lpbk_up_req</span><span class="o">-&gt;</span><span class="n">mh</span><span class="p">);</span>
	<span class="n">bfa_msgq_cmd_post</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ethport</span><span class="o">-&gt;</span><span class="n">bna</span><span class="o">-&gt;</span><span class="n">msgq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ethport</span><span class="o">-&gt;</span><span class="n">msgq_cmd</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bna_bfi_ethport_lpbk_down</span><span class="p">(</span><span class="k">struct</span> <span class="n">bna_ethport</span> <span class="o">*</span><span class="n">ethport</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfi_enet_diag_lb_req</span> <span class="o">*</span><span class="n">lpbk_down_req</span> <span class="o">=</span>
		<span class="o">&amp;</span><span class="n">ethport</span><span class="o">-&gt;</span><span class="n">bfi_enet_cmd</span><span class="p">.</span><span class="n">lpbk_req</span><span class="p">;</span>

	<span class="n">bfi_msgq_mhdr_set</span><span class="p">(</span><span class="n">lpbk_down_req</span><span class="o">-&gt;</span><span class="n">mh</span><span class="p">,</span> <span class="n">BFI_MC_ENET</span><span class="p">,</span>
		<span class="n">BFI_ENET_H2I_DIAG_LOOPBACK_REQ</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">lpbk_down_req</span><span class="o">-&gt;</span><span class="n">mh</span><span class="p">.</span><span class="n">num_entries</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span>
		<span class="n">bfi_msgq_num_cmd_entries</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfi_enet_diag_lb_req</span><span class="p">)));</span>
	<span class="n">lpbk_down_req</span><span class="o">-&gt;</span><span class="n">enable</span> <span class="o">=</span> <span class="n">BNA_STATUS_T_DISABLED</span><span class="p">;</span>

	<span class="n">bfa_msgq_cmd_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ethport</span><span class="o">-&gt;</span><span class="n">msgq_cmd</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
		<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfi_enet_diag_lb_req</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">lpbk_down_req</span><span class="o">-&gt;</span><span class="n">mh</span><span class="p">);</span>
	<span class="n">bfa_msgq_cmd_post</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ethport</span><span class="o">-&gt;</span><span class="n">bna</span><span class="o">-&gt;</span><span class="n">msgq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ethport</span><span class="o">-&gt;</span><span class="n">msgq_cmd</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bna_bfi_ethport_up</span><span class="p">(</span><span class="k">struct</span> <span class="n">bna_ethport</span> <span class="o">*</span><span class="n">ethport</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ethport</span><span class="o">-&gt;</span><span class="n">bna</span><span class="o">-&gt;</span><span class="n">enet</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">BNA_ENET_T_REGULAR</span><span class="p">)</span>
		<span class="n">bna_bfi_ethport_admin_up</span><span class="p">(</span><span class="n">ethport</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">bna_bfi_ethport_lpbk_up</span><span class="p">(</span><span class="n">ethport</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bna_bfi_ethport_down</span><span class="p">(</span><span class="k">struct</span> <span class="n">bna_ethport</span> <span class="o">*</span><span class="n">ethport</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ethport</span><span class="o">-&gt;</span><span class="n">bna</span><span class="o">-&gt;</span><span class="n">enet</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">BNA_ENET_T_REGULAR</span><span class="p">)</span>
		<span class="n">bna_bfi_ethport_admin_down</span><span class="p">(</span><span class="n">ethport</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">bna_bfi_ethport_lpbk_down</span><span class="p">(</span><span class="n">ethport</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">bfa_fsm_state_decl</span><span class="p">(</span><span class="n">bna_ethport</span><span class="p">,</span> <span class="n">stopped</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bna_ethport</span><span class="p">,</span>
			<span class="k">enum</span> <span class="n">bna_ethport_event</span><span class="p">);</span>
<span class="n">bfa_fsm_state_decl</span><span class="p">(</span><span class="n">bna_ethport</span><span class="p">,</span> <span class="n">down</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bna_ethport</span><span class="p">,</span>
			<span class="k">enum</span> <span class="n">bna_ethport_event</span><span class="p">);</span>
<span class="n">bfa_fsm_state_decl</span><span class="p">(</span><span class="n">bna_ethport</span><span class="p">,</span> <span class="n">up_resp_wait</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bna_ethport</span><span class="p">,</span>
			<span class="k">enum</span> <span class="n">bna_ethport_event</span><span class="p">);</span>
<span class="n">bfa_fsm_state_decl</span><span class="p">(</span><span class="n">bna_ethport</span><span class="p">,</span> <span class="n">down_resp_wait</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bna_ethport</span><span class="p">,</span>
			<span class="k">enum</span> <span class="n">bna_ethport_event</span><span class="p">);</span>
<span class="n">bfa_fsm_state_decl</span><span class="p">(</span><span class="n">bna_ethport</span><span class="p">,</span> <span class="n">up</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bna_ethport</span><span class="p">,</span>
			<span class="k">enum</span> <span class="n">bna_ethport_event</span><span class="p">);</span>
<span class="n">bfa_fsm_state_decl</span><span class="p">(</span><span class="n">bna_ethport</span><span class="p">,</span> <span class="n">last_resp_wait</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bna_ethport</span><span class="p">,</span>
			<span class="k">enum</span> <span class="n">bna_ethport_event</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bna_ethport_sm_stopped_entry</span><span class="p">(</span><span class="k">struct</span> <span class="n">bna_ethport</span> <span class="o">*</span><span class="n">ethport</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">call_ethport_stop_cbfn</span><span class="p">(</span><span class="n">ethport</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bna_ethport_sm_stopped</span><span class="p">(</span><span class="k">struct</span> <span class="n">bna_ethport</span> <span class="o">*</span><span class="n">ethport</span><span class="p">,</span>
			<span class="k">enum</span> <span class="n">bna_ethport_event</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ETHPORT_E_START</span>:
		<span class="n">bfa_fsm_set_state</span><span class="p">(</span><span class="n">ethport</span><span class="p">,</span> <span class="n">bna_ethport_sm_down</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">ETHPORT_E_STOP</span>:
		<span class="n">call_ethport_stop_cbfn</span><span class="p">(</span><span class="n">ethport</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">ETHPORT_E_FAIL</span>:
		<span class="cm">/* No-op */</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">ETHPORT_E_DOWN</span>:
		<span class="cm">/* This event is received due to Rx objects failing */</span>
		<span class="cm">/* No-op */</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">bfa_sm_fault</span><span class="p">(</span><span class="n">event</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bna_ethport_sm_down_entry</span><span class="p">(</span><span class="k">struct</span> <span class="n">bna_ethport</span> <span class="o">*</span><span class="n">ethport</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bna_ethport_sm_down</span><span class="p">(</span><span class="k">struct</span> <span class="n">bna_ethport</span> <span class="o">*</span><span class="n">ethport</span><span class="p">,</span>
			<span class="k">enum</span> <span class="n">bna_ethport_event</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ETHPORT_E_STOP</span>:
		<span class="n">bfa_fsm_set_state</span><span class="p">(</span><span class="n">ethport</span><span class="p">,</span> <span class="n">bna_ethport_sm_stopped</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">ETHPORT_E_FAIL</span>:
		<span class="n">bfa_fsm_set_state</span><span class="p">(</span><span class="n">ethport</span><span class="p">,</span> <span class="n">bna_ethport_sm_stopped</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">ETHPORT_E_UP</span>:
		<span class="n">bfa_fsm_set_state</span><span class="p">(</span><span class="n">ethport</span><span class="p">,</span> <span class="n">bna_ethport_sm_up_resp_wait</span><span class="p">);</span>
		<span class="n">bna_bfi_ethport_up</span><span class="p">(</span><span class="n">ethport</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">bfa_sm_fault</span><span class="p">(</span><span class="n">event</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bna_ethport_sm_up_resp_wait_entry</span><span class="p">(</span><span class="k">struct</span> <span class="n">bna_ethport</span> <span class="o">*</span><span class="n">ethport</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bna_ethport_sm_up_resp_wait</span><span class="p">(</span><span class="k">struct</span> <span class="n">bna_ethport</span> <span class="o">*</span><span class="n">ethport</span><span class="p">,</span>
			<span class="k">enum</span> <span class="n">bna_ethport_event</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ETHPORT_E_STOP</span>:
		<span class="n">bfa_fsm_set_state</span><span class="p">(</span><span class="n">ethport</span><span class="p">,</span> <span class="n">bna_ethport_sm_last_resp_wait</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">ETHPORT_E_FAIL</span>:
		<span class="n">call_ethport_adminup_cbfn</span><span class="p">(</span><span class="n">ethport</span><span class="p">,</span> <span class="n">BNA_CB_FAIL</span><span class="p">);</span>
		<span class="n">bfa_fsm_set_state</span><span class="p">(</span><span class="n">ethport</span><span class="p">,</span> <span class="n">bna_ethport_sm_stopped</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">ETHPORT_E_DOWN</span>:
		<span class="n">call_ethport_adminup_cbfn</span><span class="p">(</span><span class="n">ethport</span><span class="p">,</span> <span class="n">BNA_CB_INTERRUPT</span><span class="p">);</span>
		<span class="n">bfa_fsm_set_state</span><span class="p">(</span><span class="n">ethport</span><span class="p">,</span> <span class="n">bna_ethport_sm_down_resp_wait</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">ETHPORT_E_FWRESP_UP_OK</span>:
		<span class="n">call_ethport_adminup_cbfn</span><span class="p">(</span><span class="n">ethport</span><span class="p">,</span> <span class="n">BNA_CB_SUCCESS</span><span class="p">);</span>
		<span class="n">bfa_fsm_set_state</span><span class="p">(</span><span class="n">ethport</span><span class="p">,</span> <span class="n">bna_ethport_sm_up</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">ETHPORT_E_FWRESP_UP_FAIL</span>:
		<span class="n">call_ethport_adminup_cbfn</span><span class="p">(</span><span class="n">ethport</span><span class="p">,</span> <span class="n">BNA_CB_FAIL</span><span class="p">);</span>
		<span class="n">bfa_fsm_set_state</span><span class="p">(</span><span class="n">ethport</span><span class="p">,</span> <span class="n">bna_ethport_sm_down</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">ETHPORT_E_FWRESP_DOWN</span>:
		<span class="cm">/* down_resp_wait -&gt; up_resp_wait transition on ETHPORT_E_UP */</span>
		<span class="n">bna_bfi_ethport_up</span><span class="p">(</span><span class="n">ethport</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">bfa_sm_fault</span><span class="p">(</span><span class="n">event</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bna_ethport_sm_down_resp_wait_entry</span><span class="p">(</span><span class="k">struct</span> <span class="n">bna_ethport</span> <span class="o">*</span><span class="n">ethport</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/**</span>
<span class="cm">	 * NOTE: Do not call bna_bfi_ethport_down() here. That will over step</span>
<span class="cm">	 * mbox due to up_resp_wait -&gt; down_resp_wait transition on event</span>
<span class="cm">	 * ETHPORT_E_DOWN</span>
<span class="cm">	 */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bna_ethport_sm_down_resp_wait</span><span class="p">(</span><span class="k">struct</span> <span class="n">bna_ethport</span> <span class="o">*</span><span class="n">ethport</span><span class="p">,</span>
			<span class="k">enum</span> <span class="n">bna_ethport_event</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ETHPORT_E_STOP</span>:
		<span class="n">bfa_fsm_set_state</span><span class="p">(</span><span class="n">ethport</span><span class="p">,</span> <span class="n">bna_ethport_sm_last_resp_wait</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">ETHPORT_E_FAIL</span>:
		<span class="n">bfa_fsm_set_state</span><span class="p">(</span><span class="n">ethport</span><span class="p">,</span> <span class="n">bna_ethport_sm_stopped</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">ETHPORT_E_UP</span>:
		<span class="n">bfa_fsm_set_state</span><span class="p">(</span><span class="n">ethport</span><span class="p">,</span> <span class="n">bna_ethport_sm_up_resp_wait</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">ETHPORT_E_FWRESP_UP_OK</span>:
		<span class="cm">/* up_resp_wait-&gt;down_resp_wait transition on ETHPORT_E_DOWN */</span>
		<span class="n">bna_bfi_ethport_down</span><span class="p">(</span><span class="n">ethport</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">ETHPORT_E_FWRESP_UP_FAIL</span>:
	<span class="k">case</span> <span class="n">ETHPORT_E_FWRESP_DOWN</span>:
		<span class="n">bfa_fsm_set_state</span><span class="p">(</span><span class="n">ethport</span><span class="p">,</span> <span class="n">bna_ethport_sm_down</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">bfa_sm_fault</span><span class="p">(</span><span class="n">event</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bna_ethport_sm_up_entry</span><span class="p">(</span><span class="k">struct</span> <span class="n">bna_ethport</span> <span class="o">*</span><span class="n">ethport</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bna_ethport_sm_up</span><span class="p">(</span><span class="k">struct</span> <span class="n">bna_ethport</span> <span class="o">*</span><span class="n">ethport</span><span class="p">,</span>
			<span class="k">enum</span> <span class="n">bna_ethport_event</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ETHPORT_E_STOP</span>:
		<span class="n">bfa_fsm_set_state</span><span class="p">(</span><span class="n">ethport</span><span class="p">,</span> <span class="n">bna_ethport_sm_last_resp_wait</span><span class="p">);</span>
		<span class="n">bna_bfi_ethport_down</span><span class="p">(</span><span class="n">ethport</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">ETHPORT_E_FAIL</span>:
		<span class="n">bfa_fsm_set_state</span><span class="p">(</span><span class="n">ethport</span><span class="p">,</span> <span class="n">bna_ethport_sm_stopped</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">ETHPORT_E_DOWN</span>:
		<span class="n">bfa_fsm_set_state</span><span class="p">(</span><span class="n">ethport</span><span class="p">,</span> <span class="n">bna_ethport_sm_down_resp_wait</span><span class="p">);</span>
		<span class="n">bna_bfi_ethport_down</span><span class="p">(</span><span class="n">ethport</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">bfa_sm_fault</span><span class="p">(</span><span class="n">event</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bna_ethport_sm_last_resp_wait_entry</span><span class="p">(</span><span class="k">struct</span> <span class="n">bna_ethport</span> <span class="o">*</span><span class="n">ethport</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bna_ethport_sm_last_resp_wait</span><span class="p">(</span><span class="k">struct</span> <span class="n">bna_ethport</span> <span class="o">*</span><span class="n">ethport</span><span class="p">,</span>
			<span class="k">enum</span> <span class="n">bna_ethport_event</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ETHPORT_E_FAIL</span>:
		<span class="n">bfa_fsm_set_state</span><span class="p">(</span><span class="n">ethport</span><span class="p">,</span> <span class="n">bna_ethport_sm_stopped</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">ETHPORT_E_DOWN</span>:
		<span class="cm">/**</span>
<span class="cm">		 * This event is received due to Rx objects stopping in</span>
<span class="cm">		 * parallel to ethport</span>
<span class="cm">		 */</span>
		<span class="cm">/* No-op */</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">ETHPORT_E_FWRESP_UP_OK</span>:
		<span class="cm">/* up_resp_wait-&gt;last_resp_wait transition on ETHPORT_T_STOP */</span>
		<span class="n">bna_bfi_ethport_down</span><span class="p">(</span><span class="n">ethport</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">ETHPORT_E_FWRESP_UP_FAIL</span>:
	<span class="k">case</span> <span class="n">ETHPORT_E_FWRESP_DOWN</span>:
		<span class="n">bfa_fsm_set_state</span><span class="p">(</span><span class="n">ethport</span><span class="p">,</span> <span class="n">bna_ethport_sm_stopped</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">bfa_sm_fault</span><span class="p">(</span><span class="n">event</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bna_ethport_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">bna_ethport</span> <span class="o">*</span><span class="n">ethport</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bna</span> <span class="o">*</span><span class="n">bna</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ethport</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="p">(</span><span class="n">BNA_ETHPORT_F_ADMIN_UP</span> <span class="o">|</span> <span class="n">BNA_ETHPORT_F_PORT_ENABLED</span><span class="p">);</span>
	<span class="n">ethport</span><span class="o">-&gt;</span><span class="n">bna</span> <span class="o">=</span> <span class="n">bna</span><span class="p">;</span>

	<span class="n">ethport</span><span class="o">-&gt;</span><span class="n">link_status</span> <span class="o">=</span> <span class="n">BNA_LINK_DOWN</span><span class="p">;</span>
	<span class="n">ethport</span><span class="o">-&gt;</span><span class="n">link_cbfn</span> <span class="o">=</span> <span class="n">bnad_cb_ethport_link_status</span><span class="p">;</span>

	<span class="n">ethport</span><span class="o">-&gt;</span><span class="n">rx_started_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ethport</span><span class="o">-&gt;</span><span class="n">stop_cbfn</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">ethport</span><span class="o">-&gt;</span><span class="n">adminup_cbfn</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">bfa_fsm_set_state</span><span class="p">(</span><span class="n">ethport</span><span class="p">,</span> <span class="n">bna_ethport_sm_stopped</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bna_ethport_uninit</span><span class="p">(</span><span class="k">struct</span> <span class="n">bna_ethport</span> <span class="o">*</span><span class="n">ethport</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ethport</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">BNA_ETHPORT_F_ADMIN_UP</span><span class="p">;</span>
	<span class="n">ethport</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">BNA_ETHPORT_F_PORT_ENABLED</span><span class="p">;</span>

	<span class="n">ethport</span><span class="o">-&gt;</span><span class="n">bna</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bna_ethport_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">bna_ethport</span> <span class="o">*</span><span class="n">ethport</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfa_fsm_send_event</span><span class="p">(</span><span class="n">ethport</span><span class="p">,</span> <span class="n">ETHPORT_E_START</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bna_enet_cb_ethport_stopped</span><span class="p">(</span><span class="k">struct</span> <span class="n">bna_enet</span> <span class="o">*</span><span class="n">enet</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfa_wc_down</span><span class="p">(</span><span class="o">&amp;</span><span class="n">enet</span><span class="o">-&gt;</span><span class="n">chld_stop_wc</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bna_ethport_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">bna_ethport</span> <span class="o">*</span><span class="n">ethport</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ethport</span><span class="o">-&gt;</span><span class="n">stop_cbfn</span> <span class="o">=</span> <span class="n">bna_enet_cb_ethport_stopped</span><span class="p">;</span>
	<span class="n">bfa_fsm_send_event</span><span class="p">(</span><span class="n">ethport</span><span class="p">,</span> <span class="n">ETHPORT_E_STOP</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bna_ethport_fail</span><span class="p">(</span><span class="k">struct</span> <span class="n">bna_ethport</span> <span class="o">*</span><span class="n">ethport</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Reset the physical port status to enabled */</span>
	<span class="n">ethport</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">BNA_ETHPORT_F_PORT_ENABLED</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ethport</span><span class="o">-&gt;</span><span class="n">link_status</span> <span class="o">!=</span> <span class="n">BNA_LINK_DOWN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ethport</span><span class="o">-&gt;</span><span class="n">link_status</span> <span class="o">=</span> <span class="n">BNA_LINK_DOWN</span><span class="p">;</span>
		<span class="n">ethport</span><span class="o">-&gt;</span><span class="n">link_cbfn</span><span class="p">(</span><span class="n">ethport</span><span class="o">-&gt;</span><span class="n">bna</span><span class="o">-&gt;</span><span class="n">bnad</span><span class="p">,</span> <span class="n">BNA_LINK_DOWN</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">bfa_fsm_send_event</span><span class="p">(</span><span class="n">ethport</span><span class="p">,</span> <span class="n">ETHPORT_E_FAIL</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Should be called only when ethport is disabled */</span>
<span class="kt">void</span>
<span class="nf">bna_ethport_cb_rx_started</span><span class="p">(</span><span class="k">struct</span> <span class="n">bna_ethport</span> <span class="o">*</span><span class="n">ethport</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ethport</span><span class="o">-&gt;</span><span class="n">rx_started_count</span><span class="o">++</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ethport</span><span class="o">-&gt;</span><span class="n">rx_started_count</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ethport</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">BNA_ETHPORT_F_RX_STARTED</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ethport_can_be_up</span><span class="p">(</span><span class="n">ethport</span><span class="p">))</span>
			<span class="n">bfa_fsm_send_event</span><span class="p">(</span><span class="n">ethport</span><span class="p">,</span> <span class="n">ETHPORT_E_UP</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">bna_ethport_cb_rx_stopped</span><span class="p">(</span><span class="k">struct</span> <span class="n">bna_ethport</span> <span class="o">*</span><span class="n">ethport</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ethport_up</span> <span class="o">=</span> <span class="n">ethport_is_up</span><span class="p">(</span><span class="n">ethport</span><span class="p">);</span>

	<span class="n">ethport</span><span class="o">-&gt;</span><span class="n">rx_started_count</span><span class="o">--</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ethport</span><span class="o">-&gt;</span><span class="n">rx_started_count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ethport</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">BNA_ETHPORT_F_RX_STARTED</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ethport_up</span><span class="p">)</span>
			<span class="n">bfa_fsm_send_event</span><span class="p">(</span><span class="n">ethport</span><span class="p">,</span> <span class="n">ETHPORT_E_DOWN</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ENET</span>
<span class="cm"> */</span>
<span class="cp">#define bna_enet_chld_start(enet)					\</span>
<span class="cp">do {									\</span>
<span class="cp">	enum bna_tx_type tx_type =					\</span>
<span class="cp">		((enet)-&gt;type == BNA_ENET_T_REGULAR) ?			\</span>
<span class="cp">		BNA_TX_T_REGULAR : BNA_TX_T_LOOPBACK;			\</span>
<span class="cp">	enum bna_rx_type rx_type =					\</span>
<span class="cp">		((enet)-&gt;type == BNA_ENET_T_REGULAR) ?			\</span>
<span class="cp">		BNA_RX_T_REGULAR : BNA_RX_T_LOOPBACK;			\</span>
<span class="cp">	bna_ethport_start(&amp;(enet)-&gt;bna-&gt;ethport);			\</span>
<span class="cp">	bna_tx_mod_start(&amp;(enet)-&gt;bna-&gt;tx_mod, tx_type);		\</span>
<span class="cp">	bna_rx_mod_start(&amp;(enet)-&gt;bna-&gt;rx_mod, rx_type);		\</span>
<span class="cp">} while (0)</span>

<span class="cp">#define bna_enet_chld_stop(enet)					\</span>
<span class="cp">do {									\</span>
<span class="cp">	enum bna_tx_type tx_type =					\</span>
<span class="cp">		((enet)-&gt;type == BNA_ENET_T_REGULAR) ?			\</span>
<span class="cp">		BNA_TX_T_REGULAR : BNA_TX_T_LOOPBACK;			\</span>
<span class="cp">	enum bna_rx_type rx_type =					\</span>
<span class="cp">		((enet)-&gt;type == BNA_ENET_T_REGULAR) ?			\</span>
<span class="cp">		BNA_RX_T_REGULAR : BNA_RX_T_LOOPBACK;			\</span>
<span class="cp">	bfa_wc_init(&amp;(enet)-&gt;chld_stop_wc, bna_enet_cb_chld_stopped, (enet));\</span>
<span class="cp">	bfa_wc_up(&amp;(enet)-&gt;chld_stop_wc);				\</span>
<span class="cp">	bna_ethport_stop(&amp;(enet)-&gt;bna-&gt;ethport);			\</span>
<span class="cp">	bfa_wc_up(&amp;(enet)-&gt;chld_stop_wc);				\</span>
<span class="cp">	bna_tx_mod_stop(&amp;(enet)-&gt;bna-&gt;tx_mod, tx_type);			\</span>
<span class="cp">	bfa_wc_up(&amp;(enet)-&gt;chld_stop_wc);				\</span>
<span class="cp">	bna_rx_mod_stop(&amp;(enet)-&gt;bna-&gt;rx_mod, rx_type);			\</span>
<span class="cp">	bfa_wc_wait(&amp;(enet)-&gt;chld_stop_wc);				\</span>
<span class="cp">} while (0)</span>

<span class="cp">#define bna_enet_chld_fail(enet)					\</span>
<span class="cp">do {									\</span>
<span class="cp">	bna_ethport_fail(&amp;(enet)-&gt;bna-&gt;ethport);			\</span>
<span class="cp">	bna_tx_mod_fail(&amp;(enet)-&gt;bna-&gt;tx_mod);				\</span>
<span class="cp">	bna_rx_mod_fail(&amp;(enet)-&gt;bna-&gt;rx_mod);				\</span>
<span class="cp">} while (0)</span>

<span class="cp">#define bna_enet_rx_start(enet)						\</span>
<span class="cp">do {									\</span>
<span class="cp">	enum bna_rx_type rx_type =					\</span>
<span class="cp">		((enet)-&gt;type == BNA_ENET_T_REGULAR) ?			\</span>
<span class="cp">		BNA_RX_T_REGULAR : BNA_RX_T_LOOPBACK;			\</span>
<span class="cp">	bna_rx_mod_start(&amp;(enet)-&gt;bna-&gt;rx_mod, rx_type);		\</span>
<span class="cp">} while (0)</span>

<span class="cp">#define bna_enet_rx_stop(enet)						\</span>
<span class="cp">do {									\</span>
<span class="cp">	enum bna_rx_type rx_type =					\</span>
<span class="cp">		((enet)-&gt;type == BNA_ENET_T_REGULAR) ?			\</span>
<span class="cp">		BNA_RX_T_REGULAR : BNA_RX_T_LOOPBACK;			\</span>
<span class="cp">	bfa_wc_init(&amp;(enet)-&gt;chld_stop_wc, bna_enet_cb_chld_stopped, (enet));\</span>
<span class="cp">	bfa_wc_up(&amp;(enet)-&gt;chld_stop_wc);				\</span>
<span class="cp">	bna_rx_mod_stop(&amp;(enet)-&gt;bna-&gt;rx_mod, rx_type);			\</span>
<span class="cp">	bfa_wc_wait(&amp;(enet)-&gt;chld_stop_wc);				\</span>
<span class="cp">} while (0)</span>

<span class="cp">#define call_enet_stop_cbfn(enet)					\</span>
<span class="cp">do {									\</span>
<span class="cp">	if ((enet)-&gt;stop_cbfn) {					\</span>
<span class="cp">		void (*cbfn)(void *);					\</span>
<span class="cp">		void *cbarg;						\</span>
<span class="cp">		cbfn = (enet)-&gt;stop_cbfn;				\</span>
<span class="cp">		cbarg = (enet)-&gt;stop_cbarg;				\</span>
<span class="cp">		(enet)-&gt;stop_cbfn = NULL;				\</span>
<span class="cp">		(enet)-&gt;stop_cbarg = NULL;				\</span>
<span class="cp">		cbfn(cbarg);						\</span>
<span class="cp">	}								\</span>
<span class="cp">} while (0)</span>

<span class="cp">#define call_enet_pause_cbfn(enet)					\</span>
<span class="cp">do {									\</span>
<span class="cp">	if ((enet)-&gt;pause_cbfn) {					\</span>
<span class="cp">		void (*cbfn)(struct bnad *);				\</span>
<span class="cp">		cbfn = (enet)-&gt;pause_cbfn;				\</span>
<span class="cp">		(enet)-&gt;pause_cbfn = NULL;				\</span>
<span class="cp">		cbfn((enet)-&gt;bna-&gt;bnad);				\</span>
<span class="cp">	}								\</span>
<span class="cp">} while (0)</span>

<span class="cp">#define call_enet_mtu_cbfn(enet)					\</span>
<span class="cp">do {									\</span>
<span class="cp">	if ((enet)-&gt;mtu_cbfn) {						\</span>
<span class="cp">		void (*cbfn)(struct bnad *);				\</span>
<span class="cp">		cbfn = (enet)-&gt;mtu_cbfn;				\</span>
<span class="cp">		(enet)-&gt;mtu_cbfn = NULL;				\</span>
<span class="cp">		cbfn((enet)-&gt;bna-&gt;bnad);				\</span>
<span class="cp">	}								\</span>
<span class="cp">} while (0)</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">bna_enet_cb_chld_stopped</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">bna_bfi_pause_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">bna_enet</span> <span class="o">*</span><span class="n">enet</span><span class="p">);</span>

<span class="n">bfa_fsm_state_decl</span><span class="p">(</span><span class="n">bna_enet</span><span class="p">,</span> <span class="n">stopped</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bna_enet</span><span class="p">,</span>
			<span class="k">enum</span> <span class="n">bna_enet_event</span><span class="p">);</span>
<span class="n">bfa_fsm_state_decl</span><span class="p">(</span><span class="n">bna_enet</span><span class="p">,</span> <span class="n">pause_init_wait</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bna_enet</span><span class="p">,</span>
			<span class="k">enum</span> <span class="n">bna_enet_event</span><span class="p">);</span>
<span class="n">bfa_fsm_state_decl</span><span class="p">(</span><span class="n">bna_enet</span><span class="p">,</span> <span class="n">last_resp_wait</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bna_enet</span><span class="p">,</span>
			<span class="k">enum</span> <span class="n">bna_enet_event</span><span class="p">);</span>
<span class="n">bfa_fsm_state_decl</span><span class="p">(</span><span class="n">bna_enet</span><span class="p">,</span> <span class="n">started</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bna_enet</span><span class="p">,</span>
			<span class="k">enum</span> <span class="n">bna_enet_event</span><span class="p">);</span>
<span class="n">bfa_fsm_state_decl</span><span class="p">(</span><span class="n">bna_enet</span><span class="p">,</span> <span class="n">cfg_wait</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bna_enet</span><span class="p">,</span>
			<span class="k">enum</span> <span class="n">bna_enet_event</span><span class="p">);</span>
<span class="n">bfa_fsm_state_decl</span><span class="p">(</span><span class="n">bna_enet</span><span class="p">,</span> <span class="n">cfg_stop_wait</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bna_enet</span><span class="p">,</span>
			<span class="k">enum</span> <span class="n">bna_enet_event</span><span class="p">);</span>
<span class="n">bfa_fsm_state_decl</span><span class="p">(</span><span class="n">bna_enet</span><span class="p">,</span> <span class="n">chld_stop_wait</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bna_enet</span><span class="p">,</span>
			<span class="k">enum</span> <span class="n">bna_enet_event</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bna_enet_sm_stopped_entry</span><span class="p">(</span><span class="k">struct</span> <span class="n">bna_enet</span> <span class="o">*</span><span class="n">enet</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">call_enet_pause_cbfn</span><span class="p">(</span><span class="n">enet</span><span class="p">);</span>
	<span class="n">call_enet_mtu_cbfn</span><span class="p">(</span><span class="n">enet</span><span class="p">);</span>
	<span class="n">call_enet_stop_cbfn</span><span class="p">(</span><span class="n">enet</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bna_enet_sm_stopped</span><span class="p">(</span><span class="k">struct</span> <span class="n">bna_enet</span> <span class="o">*</span><span class="n">enet</span><span class="p">,</span> <span class="k">enum</span> <span class="n">bna_enet_event</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ENET_E_START</span>:
		<span class="n">bfa_fsm_set_state</span><span class="p">(</span><span class="n">enet</span><span class="p">,</span> <span class="n">bna_enet_sm_pause_init_wait</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">ENET_E_STOP</span>:
		<span class="n">call_enet_stop_cbfn</span><span class="p">(</span><span class="n">enet</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">ENET_E_FAIL</span>:
		<span class="cm">/* No-op */</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">ENET_E_PAUSE_CFG</span>:
		<span class="n">call_enet_pause_cbfn</span><span class="p">(</span><span class="n">enet</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">ENET_E_MTU_CFG</span>:
		<span class="n">call_enet_mtu_cbfn</span><span class="p">(</span><span class="n">enet</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">ENET_E_CHLD_STOPPED</span>:
		<span class="cm">/**</span>
<span class="cm">		 * This event is received due to Ethport, Tx and Rx objects</span>
<span class="cm">		 * failing</span>
<span class="cm">		 */</span>
		<span class="cm">/* No-op */</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">bfa_sm_fault</span><span class="p">(</span><span class="n">event</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bna_enet_sm_pause_init_wait_entry</span><span class="p">(</span><span class="k">struct</span> <span class="n">bna_enet</span> <span class="o">*</span><span class="n">enet</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bna_bfi_pause_set</span><span class="p">(</span><span class="n">enet</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bna_enet_sm_pause_init_wait</span><span class="p">(</span><span class="k">struct</span> <span class="n">bna_enet</span> <span class="o">*</span><span class="n">enet</span><span class="p">,</span>
				<span class="k">enum</span> <span class="n">bna_enet_event</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ENET_E_STOP</span>:
		<span class="n">enet</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">BNA_ENET_F_PAUSE_CHANGED</span><span class="p">;</span>
		<span class="n">bfa_fsm_set_state</span><span class="p">(</span><span class="n">enet</span><span class="p">,</span> <span class="n">bna_enet_sm_last_resp_wait</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">ENET_E_FAIL</span>:
		<span class="n">enet</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">BNA_ENET_F_PAUSE_CHANGED</span><span class="p">;</span>
		<span class="n">bfa_fsm_set_state</span><span class="p">(</span><span class="n">enet</span><span class="p">,</span> <span class="n">bna_enet_sm_stopped</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">ENET_E_PAUSE_CFG</span>:
		<span class="n">enet</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">BNA_ENET_F_PAUSE_CHANGED</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">ENET_E_MTU_CFG</span>:
		<span class="cm">/* No-op */</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">ENET_E_FWRESP_PAUSE</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">enet</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">BNA_ENET_F_PAUSE_CHANGED</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">enet</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">BNA_ENET_F_PAUSE_CHANGED</span><span class="p">;</span>
			<span class="n">bna_bfi_pause_set</span><span class="p">(</span><span class="n">enet</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">bfa_fsm_set_state</span><span class="p">(</span><span class="n">enet</span><span class="p">,</span> <span class="n">bna_enet_sm_started</span><span class="p">);</span>
			<span class="n">bna_enet_chld_start</span><span class="p">(</span><span class="n">enet</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">bfa_sm_fault</span><span class="p">(</span><span class="n">event</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bna_enet_sm_last_resp_wait_entry</span><span class="p">(</span><span class="k">struct</span> <span class="n">bna_enet</span> <span class="o">*</span><span class="n">enet</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">enet</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">BNA_ENET_F_PAUSE_CHANGED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bna_enet_sm_last_resp_wait</span><span class="p">(</span><span class="k">struct</span> <span class="n">bna_enet</span> <span class="o">*</span><span class="n">enet</span><span class="p">,</span>
				<span class="k">enum</span> <span class="n">bna_enet_event</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ENET_E_FAIL</span>:
	<span class="k">case</span> <span class="n">ENET_E_FWRESP_PAUSE</span>:
		<span class="n">bfa_fsm_set_state</span><span class="p">(</span><span class="n">enet</span><span class="p">,</span> <span class="n">bna_enet_sm_stopped</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">bfa_sm_fault</span><span class="p">(</span><span class="n">event</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bna_enet_sm_started_entry</span><span class="p">(</span><span class="k">struct</span> <span class="n">bna_enet</span> <span class="o">*</span><span class="n">enet</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/**</span>
<span class="cm">	 * NOTE: Do not call bna_enet_chld_start() here, since it will be</span>
<span class="cm">	 * inadvertently called during cfg_wait-&gt;started transition as well</span>
<span class="cm">	 */</span>
	<span class="n">call_enet_pause_cbfn</span><span class="p">(</span><span class="n">enet</span><span class="p">);</span>
	<span class="n">call_enet_mtu_cbfn</span><span class="p">(</span><span class="n">enet</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bna_enet_sm_started</span><span class="p">(</span><span class="k">struct</span> <span class="n">bna_enet</span> <span class="o">*</span><span class="n">enet</span><span class="p">,</span>
			<span class="k">enum</span> <span class="n">bna_enet_event</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ENET_E_STOP</span>:
		<span class="n">bfa_fsm_set_state</span><span class="p">(</span><span class="n">enet</span><span class="p">,</span> <span class="n">bna_enet_sm_chld_stop_wait</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">ENET_E_FAIL</span>:
		<span class="n">bfa_fsm_set_state</span><span class="p">(</span><span class="n">enet</span><span class="p">,</span> <span class="n">bna_enet_sm_stopped</span><span class="p">);</span>
		<span class="n">bna_enet_chld_fail</span><span class="p">(</span><span class="n">enet</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">ENET_E_PAUSE_CFG</span>:
		<span class="n">bfa_fsm_set_state</span><span class="p">(</span><span class="n">enet</span><span class="p">,</span> <span class="n">bna_enet_sm_cfg_wait</span><span class="p">);</span>
		<span class="n">bna_bfi_pause_set</span><span class="p">(</span><span class="n">enet</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">ENET_E_MTU_CFG</span>:
		<span class="n">bfa_fsm_set_state</span><span class="p">(</span><span class="n">enet</span><span class="p">,</span> <span class="n">bna_enet_sm_cfg_wait</span><span class="p">);</span>
		<span class="n">bna_enet_rx_stop</span><span class="p">(</span><span class="n">enet</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">bfa_sm_fault</span><span class="p">(</span><span class="n">event</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bna_enet_sm_cfg_wait_entry</span><span class="p">(</span><span class="k">struct</span> <span class="n">bna_enet</span> <span class="o">*</span><span class="n">enet</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bna_enet_sm_cfg_wait</span><span class="p">(</span><span class="k">struct</span> <span class="n">bna_enet</span> <span class="o">*</span><span class="n">enet</span><span class="p">,</span>
			<span class="k">enum</span> <span class="n">bna_enet_event</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ENET_E_STOP</span>:
		<span class="n">enet</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">BNA_ENET_F_PAUSE_CHANGED</span><span class="p">;</span>
		<span class="n">enet</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">BNA_ENET_F_MTU_CHANGED</span><span class="p">;</span>
		<span class="n">bfa_fsm_set_state</span><span class="p">(</span><span class="n">enet</span><span class="p">,</span> <span class="n">bna_enet_sm_cfg_stop_wait</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">ENET_E_FAIL</span>:
		<span class="n">enet</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">BNA_ENET_F_PAUSE_CHANGED</span><span class="p">;</span>
		<span class="n">enet</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">BNA_ENET_F_MTU_CHANGED</span><span class="p">;</span>
		<span class="n">bfa_fsm_set_state</span><span class="p">(</span><span class="n">enet</span><span class="p">,</span> <span class="n">bna_enet_sm_stopped</span><span class="p">);</span>
		<span class="n">bna_enet_chld_fail</span><span class="p">(</span><span class="n">enet</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">ENET_E_PAUSE_CFG</span>:
		<span class="n">enet</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">BNA_ENET_F_PAUSE_CHANGED</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">ENET_E_MTU_CFG</span>:
		<span class="n">enet</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">BNA_ENET_F_MTU_CHANGED</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">ENET_E_CHLD_STOPPED</span>:
		<span class="n">bna_enet_rx_start</span><span class="p">(</span><span class="n">enet</span><span class="p">);</span>
		<span class="cm">/* Fall through */</span>
	<span class="k">case</span> <span class="n">ENET_E_FWRESP_PAUSE</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">enet</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">BNA_ENET_F_PAUSE_CHANGED</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">enet</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">BNA_ENET_F_PAUSE_CHANGED</span><span class="p">;</span>
			<span class="n">bna_bfi_pause_set</span><span class="p">(</span><span class="n">enet</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">enet</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">BNA_ENET_F_MTU_CHANGED</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">enet</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">BNA_ENET_F_MTU_CHANGED</span><span class="p">;</span>
			<span class="n">bna_enet_rx_stop</span><span class="p">(</span><span class="n">enet</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">bfa_fsm_set_state</span><span class="p">(</span><span class="n">enet</span><span class="p">,</span> <span class="n">bna_enet_sm_started</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">bfa_sm_fault</span><span class="p">(</span><span class="n">event</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bna_enet_sm_cfg_stop_wait_entry</span><span class="p">(</span><span class="k">struct</span> <span class="n">bna_enet</span> <span class="o">*</span><span class="n">enet</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">enet</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">BNA_ENET_F_PAUSE_CHANGED</span><span class="p">;</span>
	<span class="n">enet</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">BNA_ENET_F_MTU_CHANGED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bna_enet_sm_cfg_stop_wait</span><span class="p">(</span><span class="k">struct</span> <span class="n">bna_enet</span> <span class="o">*</span><span class="n">enet</span><span class="p">,</span>
				<span class="k">enum</span> <span class="n">bna_enet_event</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ENET_E_FAIL</span>:
		<span class="n">bfa_fsm_set_state</span><span class="p">(</span><span class="n">enet</span><span class="p">,</span> <span class="n">bna_enet_sm_stopped</span><span class="p">);</span>
		<span class="n">bna_enet_chld_fail</span><span class="p">(</span><span class="n">enet</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">ENET_E_FWRESP_PAUSE</span>:
	<span class="k">case</span> <span class="n">ENET_E_CHLD_STOPPED</span>:
		<span class="n">bfa_fsm_set_state</span><span class="p">(</span><span class="n">enet</span><span class="p">,</span> <span class="n">bna_enet_sm_chld_stop_wait</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">bfa_sm_fault</span><span class="p">(</span><span class="n">event</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bna_enet_sm_chld_stop_wait_entry</span><span class="p">(</span><span class="k">struct</span> <span class="n">bna_enet</span> <span class="o">*</span><span class="n">enet</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bna_enet_chld_stop</span><span class="p">(</span><span class="n">enet</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bna_enet_sm_chld_stop_wait</span><span class="p">(</span><span class="k">struct</span> <span class="n">bna_enet</span> <span class="o">*</span><span class="n">enet</span><span class="p">,</span>
				<span class="k">enum</span> <span class="n">bna_enet_event</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ENET_E_FAIL</span>:
		<span class="n">bfa_fsm_set_state</span><span class="p">(</span><span class="n">enet</span><span class="p">,</span> <span class="n">bna_enet_sm_stopped</span><span class="p">);</span>
		<span class="n">bna_enet_chld_fail</span><span class="p">(</span><span class="n">enet</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">ENET_E_CHLD_STOPPED</span>:
		<span class="n">bfa_fsm_set_state</span><span class="p">(</span><span class="n">enet</span><span class="p">,</span> <span class="n">bna_enet_sm_stopped</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">bfa_sm_fault</span><span class="p">(</span><span class="n">event</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bna_bfi_pause_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">bna_enet</span> <span class="o">*</span><span class="n">enet</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfi_enet_set_pause_req</span> <span class="o">*</span><span class="n">pause_req</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">enet</span><span class="o">-&gt;</span><span class="n">pause_req</span><span class="p">;</span>

	<span class="n">bfi_msgq_mhdr_set</span><span class="p">(</span><span class="n">pause_req</span><span class="o">-&gt;</span><span class="n">mh</span><span class="p">,</span> <span class="n">BFI_MC_ENET</span><span class="p">,</span>
		<span class="n">BFI_ENET_H2I_SET_PAUSE_REQ</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">pause_req</span><span class="o">-&gt;</span><span class="n">mh</span><span class="p">.</span><span class="n">num_entries</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span>
	<span class="n">bfi_msgq_num_cmd_entries</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfi_enet_set_pause_req</span><span class="p">)));</span>
	<span class="n">pause_req</span><span class="o">-&gt;</span><span class="n">tx_pause</span> <span class="o">=</span> <span class="n">enet</span><span class="o">-&gt;</span><span class="n">pause_config</span><span class="p">.</span><span class="n">tx_pause</span><span class="p">;</span>
	<span class="n">pause_req</span><span class="o">-&gt;</span><span class="n">rx_pause</span> <span class="o">=</span> <span class="n">enet</span><span class="o">-&gt;</span><span class="n">pause_config</span><span class="p">.</span><span class="n">rx_pause</span><span class="p">;</span>

	<span class="n">bfa_msgq_cmd_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">enet</span><span class="o">-&gt;</span><span class="n">msgq_cmd</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
		<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfi_enet_set_pause_req</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">pause_req</span><span class="o">-&gt;</span><span class="n">mh</span><span class="p">);</span>
	<span class="n">bfa_msgq_cmd_post</span><span class="p">(</span><span class="o">&amp;</span><span class="n">enet</span><span class="o">-&gt;</span><span class="n">bna</span><span class="o">-&gt;</span><span class="n">msgq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">enet</span><span class="o">-&gt;</span><span class="n">msgq_cmd</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bna_enet_cb_chld_stopped</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bna_enet</span> <span class="o">*</span><span class="n">enet</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">bna_enet</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">;</span>

	<span class="n">bfa_fsm_send_event</span><span class="p">(</span><span class="n">enet</span><span class="p">,</span> <span class="n">ENET_E_CHLD_STOPPED</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bna_enet_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">bna_enet</span> <span class="o">*</span><span class="n">enet</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bna</span> <span class="o">*</span><span class="n">bna</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">enet</span><span class="o">-&gt;</span><span class="n">bna</span> <span class="o">=</span> <span class="n">bna</span><span class="p">;</span>
	<span class="n">enet</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">enet</span><span class="o">-&gt;</span><span class="n">mtu</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">enet</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">BNA_ENET_T_REGULAR</span><span class="p">;</span>

	<span class="n">enet</span><span class="o">-&gt;</span><span class="n">stop_cbfn</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">enet</span><span class="o">-&gt;</span><span class="n">stop_cbarg</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">enet</span><span class="o">-&gt;</span><span class="n">pause_cbfn</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">enet</span><span class="o">-&gt;</span><span class="n">mtu_cbfn</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">bfa_fsm_set_state</span><span class="p">(</span><span class="n">enet</span><span class="p">,</span> <span class="n">bna_enet_sm_stopped</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bna_enet_uninit</span><span class="p">(</span><span class="k">struct</span> <span class="n">bna_enet</span> <span class="o">*</span><span class="n">enet</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">enet</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">enet</span><span class="o">-&gt;</span><span class="n">bna</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bna_enet_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">bna_enet</span> <span class="o">*</span><span class="n">enet</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">enet</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">BNA_ENET_F_IOCETH_READY</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">enet</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">BNA_ENET_F_ENABLED</span><span class="p">)</span>
		<span class="n">bfa_fsm_send_event</span><span class="p">(</span><span class="n">enet</span><span class="p">,</span> <span class="n">ENET_E_START</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bna_ioceth_cb_enet_stopped</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bna_ioceth</span> <span class="o">*</span><span class="n">ioceth</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">bna_ioceth</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">;</span>

	<span class="n">bfa_fsm_send_event</span><span class="p">(</span><span class="n">ioceth</span><span class="p">,</span> <span class="n">IOCETH_E_ENET_STOPPED</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bna_enet_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">bna_enet</span> <span class="o">*</span><span class="n">enet</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">enet</span><span class="o">-&gt;</span><span class="n">stop_cbfn</span> <span class="o">=</span> <span class="n">bna_ioceth_cb_enet_stopped</span><span class="p">;</span>
	<span class="n">enet</span><span class="o">-&gt;</span><span class="n">stop_cbarg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">enet</span><span class="o">-&gt;</span><span class="n">bna</span><span class="o">-&gt;</span><span class="n">ioceth</span><span class="p">;</span>

	<span class="n">enet</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">BNA_ENET_F_IOCETH_READY</span><span class="p">;</span>
	<span class="n">bfa_fsm_send_event</span><span class="p">(</span><span class="n">enet</span><span class="p">,</span> <span class="n">ENET_E_STOP</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bna_enet_fail</span><span class="p">(</span><span class="k">struct</span> <span class="n">bna_enet</span> <span class="o">*</span><span class="n">enet</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">enet</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">BNA_ENET_F_IOCETH_READY</span><span class="p">;</span>
	<span class="n">bfa_fsm_send_event</span><span class="p">(</span><span class="n">enet</span><span class="p">,</span> <span class="n">ENET_E_FAIL</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">bna_enet_cb_tx_stopped</span><span class="p">(</span><span class="k">struct</span> <span class="n">bna_enet</span> <span class="o">*</span><span class="n">enet</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfa_wc_down</span><span class="p">(</span><span class="o">&amp;</span><span class="n">enet</span><span class="o">-&gt;</span><span class="n">chld_stop_wc</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">bna_enet_cb_rx_stopped</span><span class="p">(</span><span class="k">struct</span> <span class="n">bna_enet</span> <span class="o">*</span><span class="n">enet</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfa_wc_down</span><span class="p">(</span><span class="o">&amp;</span><span class="n">enet</span><span class="o">-&gt;</span><span class="n">chld_stop_wc</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">bna_enet_mtu_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">bna_enet</span> <span class="o">*</span><span class="n">enet</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">enet</span><span class="o">-&gt;</span><span class="n">mtu</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">bna_enet_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">bna_enet</span> <span class="o">*</span><span class="n">enet</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">enet</span><span class="o">-&gt;</span><span class="n">fsm</span> <span class="o">!=</span> <span class="p">(</span><span class="n">bfa_sm_t</span><span class="p">)</span><span class="n">bna_enet_sm_stopped</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">enet</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">BNA_ENET_F_ENABLED</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">enet</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">BNA_ENET_F_IOCETH_READY</span><span class="p">)</span>
		<span class="n">bfa_fsm_send_event</span><span class="p">(</span><span class="n">enet</span><span class="p">,</span> <span class="n">ENET_E_START</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">bna_enet_disable</span><span class="p">(</span><span class="k">struct</span> <span class="n">bna_enet</span> <span class="o">*</span><span class="n">enet</span><span class="p">,</span> <span class="k">enum</span> <span class="n">bna_cleanup_type</span> <span class="n">type</span><span class="p">,</span>
		 <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">cbfn</span><span class="p">)(</span><span class="kt">void</span> <span class="o">*</span><span class="p">))</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">BNA_SOFT_CLEANUP</span><span class="p">)</span> <span class="p">{</span>
		<span class="p">(</span><span class="o">*</span><span class="n">cbfn</span><span class="p">)(</span><span class="n">enet</span><span class="o">-&gt;</span><span class="n">bna</span><span class="o">-&gt;</span><span class="n">bnad</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">enet</span><span class="o">-&gt;</span><span class="n">stop_cbfn</span> <span class="o">=</span> <span class="n">cbfn</span><span class="p">;</span>
	<span class="n">enet</span><span class="o">-&gt;</span><span class="n">stop_cbarg</span> <span class="o">=</span> <span class="n">enet</span><span class="o">-&gt;</span><span class="n">bna</span><span class="o">-&gt;</span><span class="n">bnad</span><span class="p">;</span>

	<span class="n">enet</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">BNA_ENET_F_ENABLED</span><span class="p">;</span>

	<span class="n">bfa_fsm_send_event</span><span class="p">(</span><span class="n">enet</span><span class="p">,</span> <span class="n">ENET_E_STOP</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">bna_enet_pause_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">bna_enet</span> <span class="o">*</span><span class="n">enet</span><span class="p">,</span>
		      <span class="k">struct</span> <span class="n">bna_pause_config</span> <span class="o">*</span><span class="n">pause_config</span><span class="p">,</span>
		      <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">cbfn</span><span class="p">)(</span><span class="k">struct</span> <span class="n">bnad</span> <span class="o">*</span><span class="p">))</span>
<span class="p">{</span>
	<span class="n">enet</span><span class="o">-&gt;</span><span class="n">pause_config</span> <span class="o">=</span> <span class="o">*</span><span class="n">pause_config</span><span class="p">;</span>

	<span class="n">enet</span><span class="o">-&gt;</span><span class="n">pause_cbfn</span> <span class="o">=</span> <span class="n">cbfn</span><span class="p">;</span>

	<span class="n">bfa_fsm_send_event</span><span class="p">(</span><span class="n">enet</span><span class="p">,</span> <span class="n">ENET_E_PAUSE_CFG</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">bna_enet_mtu_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">bna_enet</span> <span class="o">*</span><span class="n">enet</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mtu</span><span class="p">,</span>
		 <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">cbfn</span><span class="p">)(</span><span class="k">struct</span> <span class="n">bnad</span> <span class="o">*</span><span class="p">))</span>
<span class="p">{</span>
	<span class="n">enet</span><span class="o">-&gt;</span><span class="n">mtu</span> <span class="o">=</span> <span class="n">mtu</span><span class="p">;</span>

	<span class="n">enet</span><span class="o">-&gt;</span><span class="n">mtu_cbfn</span> <span class="o">=</span> <span class="n">cbfn</span><span class="p">;</span>

	<span class="n">bfa_fsm_send_event</span><span class="p">(</span><span class="n">enet</span><span class="p">,</span> <span class="n">ENET_E_MTU_CFG</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">bna_enet_perm_mac_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">bna_enet</span> <span class="o">*</span><span class="n">enet</span><span class="p">,</span> <span class="n">mac_t</span> <span class="o">*</span><span class="n">mac</span><span class="p">)</span>
<span class="p">{</span>
	<span class="o">*</span><span class="n">mac</span> <span class="o">=</span> <span class="n">bfa_nw_ioc_get_mac</span><span class="p">(</span><span class="o">&amp;</span><span class="n">enet</span><span class="o">-&gt;</span><span class="n">bna</span><span class="o">-&gt;</span><span class="n">ioceth</span><span class="p">.</span><span class="n">ioc</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * IOCETH</span>
<span class="cm"> */</span>
<span class="cp">#define enable_mbox_intr(_ioceth)					\</span>
<span class="cp">do {									\</span>
<span class="cp">	u32 intr_status;						\</span>
<span class="cp">	bna_intr_status_get((_ioceth)-&gt;bna, intr_status);		\</span>
<span class="cp">	bnad_cb_mbox_intr_enable((_ioceth)-&gt;bna-&gt;bnad);			\</span>
<span class="cp">	bna_mbox_intr_enable((_ioceth)-&gt;bna);				\</span>
<span class="cp">} while (0)</span>

<span class="cp">#define disable_mbox_intr(_ioceth)					\</span>
<span class="cp">do {									\</span>
<span class="cp">	bna_mbox_intr_disable((_ioceth)-&gt;bna);				\</span>
<span class="cp">	bnad_cb_mbox_intr_disable((_ioceth)-&gt;bna-&gt;bnad);		\</span>
<span class="cp">} while (0)</span>

<span class="cp">#define call_ioceth_stop_cbfn(_ioceth)					\</span>
<span class="cp">do {									\</span>
<span class="cp">	if ((_ioceth)-&gt;stop_cbfn) {					\</span>
<span class="cp">		void (*cbfn)(struct bnad *);				\</span>
<span class="cp">		struct bnad *cbarg;					\</span>
<span class="cp">		cbfn = (_ioceth)-&gt;stop_cbfn;				\</span>
<span class="cp">		cbarg = (_ioceth)-&gt;stop_cbarg;				\</span>
<span class="cp">		(_ioceth)-&gt;stop_cbfn = NULL;				\</span>
<span class="cp">		(_ioceth)-&gt;stop_cbarg = NULL;				\</span>
<span class="cp">		cbfn(cbarg);						\</span>
<span class="cp">	}								\</span>
<span class="cp">} while (0)</span>

<span class="cp">#define bna_stats_mod_uninit(_stats_mod)				\</span>
<span class="cp">do {									\</span>
<span class="cp">} while (0)</span>

<span class="cp">#define bna_stats_mod_start(_stats_mod)					\</span>
<span class="cp">do {									\</span>
<span class="cp">	(_stats_mod)-&gt;ioc_ready = true;					\</span>
<span class="cp">} while (0)</span>

<span class="cp">#define bna_stats_mod_stop(_stats_mod)					\</span>
<span class="cp">do {									\</span>
<span class="cp">	(_stats_mod)-&gt;ioc_ready = false;				\</span>
<span class="cp">} while (0)</span>

<span class="cp">#define bna_stats_mod_fail(_stats_mod)					\</span>
<span class="cp">do {									\</span>
<span class="cp">	(_stats_mod)-&gt;ioc_ready = false;				\</span>
<span class="cp">	(_stats_mod)-&gt;stats_get_busy = false;				\</span>
<span class="cp">	(_stats_mod)-&gt;stats_clr_busy = false;				\</span>
<span class="cp">} while (0)</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">bna_bfi_attr_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">bna_ioceth</span> <span class="o">*</span><span class="n">ioceth</span><span class="p">);</span>

<span class="n">bfa_fsm_state_decl</span><span class="p">(</span><span class="n">bna_ioceth</span><span class="p">,</span> <span class="n">stopped</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bna_ioceth</span><span class="p">,</span>
			<span class="k">enum</span> <span class="n">bna_ioceth_event</span><span class="p">);</span>
<span class="n">bfa_fsm_state_decl</span><span class="p">(</span><span class="n">bna_ioceth</span><span class="p">,</span> <span class="n">ioc_ready_wait</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bna_ioceth</span><span class="p">,</span>
			<span class="k">enum</span> <span class="n">bna_ioceth_event</span><span class="p">);</span>
<span class="n">bfa_fsm_state_decl</span><span class="p">(</span><span class="n">bna_ioceth</span><span class="p">,</span> <span class="n">enet_attr_wait</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bna_ioceth</span><span class="p">,</span>
			<span class="k">enum</span> <span class="n">bna_ioceth_event</span><span class="p">);</span>
<span class="n">bfa_fsm_state_decl</span><span class="p">(</span><span class="n">bna_ioceth</span><span class="p">,</span> <span class="n">ready</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bna_ioceth</span><span class="p">,</span>
			<span class="k">enum</span> <span class="n">bna_ioceth_event</span><span class="p">);</span>
<span class="n">bfa_fsm_state_decl</span><span class="p">(</span><span class="n">bna_ioceth</span><span class="p">,</span> <span class="n">last_resp_wait</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bna_ioceth</span><span class="p">,</span>
			<span class="k">enum</span> <span class="n">bna_ioceth_event</span><span class="p">);</span>
<span class="n">bfa_fsm_state_decl</span><span class="p">(</span><span class="n">bna_ioceth</span><span class="p">,</span> <span class="n">enet_stop_wait</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bna_ioceth</span><span class="p">,</span>
			<span class="k">enum</span> <span class="n">bna_ioceth_event</span><span class="p">);</span>
<span class="n">bfa_fsm_state_decl</span><span class="p">(</span><span class="n">bna_ioceth</span><span class="p">,</span> <span class="n">ioc_disable_wait</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bna_ioceth</span><span class="p">,</span>
			<span class="k">enum</span> <span class="n">bna_ioceth_event</span><span class="p">);</span>
<span class="n">bfa_fsm_state_decl</span><span class="p">(</span><span class="n">bna_ioceth</span><span class="p">,</span> <span class="n">failed</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bna_ioceth</span><span class="p">,</span>
			<span class="k">enum</span> <span class="n">bna_ioceth_event</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bna_ioceth_sm_stopped_entry</span><span class="p">(</span><span class="k">struct</span> <span class="n">bna_ioceth</span> <span class="o">*</span><span class="n">ioceth</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">call_ioceth_stop_cbfn</span><span class="p">(</span><span class="n">ioceth</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bna_ioceth_sm_stopped</span><span class="p">(</span><span class="k">struct</span> <span class="n">bna_ioceth</span> <span class="o">*</span><span class="n">ioceth</span><span class="p">,</span>
			<span class="k">enum</span> <span class="n">bna_ioceth_event</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IOCETH_E_ENABLE</span>:
		<span class="n">bfa_fsm_set_state</span><span class="p">(</span><span class="n">ioceth</span><span class="p">,</span> <span class="n">bna_ioceth_sm_ioc_ready_wait</span><span class="p">);</span>
		<span class="n">bfa_nw_ioc_enable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioceth</span><span class="o">-&gt;</span><span class="n">ioc</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">IOCETH_E_DISABLE</span>:
		<span class="n">bfa_fsm_set_state</span><span class="p">(</span><span class="n">ioceth</span><span class="p">,</span> <span class="n">bna_ioceth_sm_stopped</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">IOCETH_E_IOC_RESET</span>:
		<span class="n">enable_mbox_intr</span><span class="p">(</span><span class="n">ioceth</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">IOCETH_E_IOC_FAILED</span>:
		<span class="n">disable_mbox_intr</span><span class="p">(</span><span class="n">ioceth</span><span class="p">);</span>
		<span class="n">bfa_fsm_set_state</span><span class="p">(</span><span class="n">ioceth</span><span class="p">,</span> <span class="n">bna_ioceth_sm_failed</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">bfa_sm_fault</span><span class="p">(</span><span class="n">event</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bna_ioceth_sm_ioc_ready_wait_entry</span><span class="p">(</span><span class="k">struct</span> <span class="n">bna_ioceth</span> <span class="o">*</span><span class="n">ioceth</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/**</span>
<span class="cm">	 * Do not call bfa_nw_ioc_enable() here. It must be called in the</span>
<span class="cm">	 * previous state due to failed -&gt; ioc_ready_wait transition.</span>
<span class="cm">	 */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bna_ioceth_sm_ioc_ready_wait</span><span class="p">(</span><span class="k">struct</span> <span class="n">bna_ioceth</span> <span class="o">*</span><span class="n">ioceth</span><span class="p">,</span>
				<span class="k">enum</span> <span class="n">bna_ioceth_event</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IOCETH_E_DISABLE</span>:
		<span class="n">bfa_fsm_set_state</span><span class="p">(</span><span class="n">ioceth</span><span class="p">,</span> <span class="n">bna_ioceth_sm_ioc_disable_wait</span><span class="p">);</span>
		<span class="n">bfa_nw_ioc_disable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioceth</span><span class="o">-&gt;</span><span class="n">ioc</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">IOCETH_E_IOC_RESET</span>:
		<span class="n">enable_mbox_intr</span><span class="p">(</span><span class="n">ioceth</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">IOCETH_E_IOC_FAILED</span>:
		<span class="n">disable_mbox_intr</span><span class="p">(</span><span class="n">ioceth</span><span class="p">);</span>
		<span class="n">bfa_fsm_set_state</span><span class="p">(</span><span class="n">ioceth</span><span class="p">,</span> <span class="n">bna_ioceth_sm_failed</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">IOCETH_E_IOC_READY</span>:
		<span class="n">bfa_fsm_set_state</span><span class="p">(</span><span class="n">ioceth</span><span class="p">,</span> <span class="n">bna_ioceth_sm_enet_attr_wait</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">bfa_sm_fault</span><span class="p">(</span><span class="n">event</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bna_ioceth_sm_enet_attr_wait_entry</span><span class="p">(</span><span class="k">struct</span> <span class="n">bna_ioceth</span> <span class="o">*</span><span class="n">ioceth</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bna_bfi_attr_get</span><span class="p">(</span><span class="n">ioceth</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bna_ioceth_sm_enet_attr_wait</span><span class="p">(</span><span class="k">struct</span> <span class="n">bna_ioceth</span> <span class="o">*</span><span class="n">ioceth</span><span class="p">,</span>
				<span class="k">enum</span> <span class="n">bna_ioceth_event</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IOCETH_E_DISABLE</span>:
		<span class="n">bfa_fsm_set_state</span><span class="p">(</span><span class="n">ioceth</span><span class="p">,</span> <span class="n">bna_ioceth_sm_last_resp_wait</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">IOCETH_E_IOC_FAILED</span>:
		<span class="n">disable_mbox_intr</span><span class="p">(</span><span class="n">ioceth</span><span class="p">);</span>
		<span class="n">bfa_fsm_set_state</span><span class="p">(</span><span class="n">ioceth</span><span class="p">,</span> <span class="n">bna_ioceth_sm_failed</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">IOCETH_E_ENET_ATTR_RESP</span>:
		<span class="n">bfa_fsm_set_state</span><span class="p">(</span><span class="n">ioceth</span><span class="p">,</span> <span class="n">bna_ioceth_sm_ready</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">bfa_sm_fault</span><span class="p">(</span><span class="n">event</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bna_ioceth_sm_ready_entry</span><span class="p">(</span><span class="k">struct</span> <span class="n">bna_ioceth</span> <span class="o">*</span><span class="n">ioceth</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bna_enet_start</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioceth</span><span class="o">-&gt;</span><span class="n">bna</span><span class="o">-&gt;</span><span class="n">enet</span><span class="p">);</span>
	<span class="n">bna_stats_mod_start</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioceth</span><span class="o">-&gt;</span><span class="n">bna</span><span class="o">-&gt;</span><span class="n">stats_mod</span><span class="p">);</span>
	<span class="n">bnad_cb_ioceth_ready</span><span class="p">(</span><span class="n">ioceth</span><span class="o">-&gt;</span><span class="n">bna</span><span class="o">-&gt;</span><span class="n">bnad</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bna_ioceth_sm_ready</span><span class="p">(</span><span class="k">struct</span> <span class="n">bna_ioceth</span> <span class="o">*</span><span class="n">ioceth</span><span class="p">,</span> <span class="k">enum</span> <span class="n">bna_ioceth_event</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IOCETH_E_DISABLE</span>:
		<span class="n">bfa_fsm_set_state</span><span class="p">(</span><span class="n">ioceth</span><span class="p">,</span> <span class="n">bna_ioceth_sm_enet_stop_wait</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">IOCETH_E_IOC_FAILED</span>:
		<span class="n">disable_mbox_intr</span><span class="p">(</span><span class="n">ioceth</span><span class="p">);</span>
		<span class="n">bna_enet_fail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioceth</span><span class="o">-&gt;</span><span class="n">bna</span><span class="o">-&gt;</span><span class="n">enet</span><span class="p">);</span>
		<span class="n">bna_stats_mod_fail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioceth</span><span class="o">-&gt;</span><span class="n">bna</span><span class="o">-&gt;</span><span class="n">stats_mod</span><span class="p">);</span>
		<span class="n">bfa_fsm_set_state</span><span class="p">(</span><span class="n">ioceth</span><span class="p">,</span> <span class="n">bna_ioceth_sm_failed</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">bfa_sm_fault</span><span class="p">(</span><span class="n">event</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bna_ioceth_sm_last_resp_wait_entry</span><span class="p">(</span><span class="k">struct</span> <span class="n">bna_ioceth</span> <span class="o">*</span><span class="n">ioceth</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bna_ioceth_sm_last_resp_wait</span><span class="p">(</span><span class="k">struct</span> <span class="n">bna_ioceth</span> <span class="o">*</span><span class="n">ioceth</span><span class="p">,</span>
				<span class="k">enum</span> <span class="n">bna_ioceth_event</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IOCETH_E_IOC_FAILED</span>:
		<span class="n">bfa_fsm_set_state</span><span class="p">(</span><span class="n">ioceth</span><span class="p">,</span> <span class="n">bna_ioceth_sm_ioc_disable_wait</span><span class="p">);</span>
		<span class="n">disable_mbox_intr</span><span class="p">(</span><span class="n">ioceth</span><span class="p">);</span>
		<span class="n">bfa_nw_ioc_disable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioceth</span><span class="o">-&gt;</span><span class="n">ioc</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">IOCETH_E_ENET_ATTR_RESP</span>:
		<span class="n">bfa_fsm_set_state</span><span class="p">(</span><span class="n">ioceth</span><span class="p">,</span> <span class="n">bna_ioceth_sm_ioc_disable_wait</span><span class="p">);</span>
		<span class="n">bfa_nw_ioc_disable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioceth</span><span class="o">-&gt;</span><span class="n">ioc</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">bfa_sm_fault</span><span class="p">(</span><span class="n">event</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bna_ioceth_sm_enet_stop_wait_entry</span><span class="p">(</span><span class="k">struct</span> <span class="n">bna_ioceth</span> <span class="o">*</span><span class="n">ioceth</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bna_stats_mod_stop</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioceth</span><span class="o">-&gt;</span><span class="n">bna</span><span class="o">-&gt;</span><span class="n">stats_mod</span><span class="p">);</span>
	<span class="n">bna_enet_stop</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioceth</span><span class="o">-&gt;</span><span class="n">bna</span><span class="o">-&gt;</span><span class="n">enet</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bna_ioceth_sm_enet_stop_wait</span><span class="p">(</span><span class="k">struct</span> <span class="n">bna_ioceth</span> <span class="o">*</span><span class="n">ioceth</span><span class="p">,</span>
				<span class="k">enum</span> <span class="n">bna_ioceth_event</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IOCETH_E_IOC_FAILED</span>:
		<span class="n">bfa_fsm_set_state</span><span class="p">(</span><span class="n">ioceth</span><span class="p">,</span> <span class="n">bna_ioceth_sm_ioc_disable_wait</span><span class="p">);</span>
		<span class="n">disable_mbox_intr</span><span class="p">(</span><span class="n">ioceth</span><span class="p">);</span>
		<span class="n">bna_enet_fail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioceth</span><span class="o">-&gt;</span><span class="n">bna</span><span class="o">-&gt;</span><span class="n">enet</span><span class="p">);</span>
		<span class="n">bna_stats_mod_fail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioceth</span><span class="o">-&gt;</span><span class="n">bna</span><span class="o">-&gt;</span><span class="n">stats_mod</span><span class="p">);</span>
		<span class="n">bfa_nw_ioc_disable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioceth</span><span class="o">-&gt;</span><span class="n">ioc</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">IOCETH_E_ENET_STOPPED</span>:
		<span class="n">bfa_fsm_set_state</span><span class="p">(</span><span class="n">ioceth</span><span class="p">,</span> <span class="n">bna_ioceth_sm_ioc_disable_wait</span><span class="p">);</span>
		<span class="n">bfa_nw_ioc_disable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioceth</span><span class="o">-&gt;</span><span class="n">ioc</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">bfa_sm_fault</span><span class="p">(</span><span class="n">event</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bna_ioceth_sm_ioc_disable_wait_entry</span><span class="p">(</span><span class="k">struct</span> <span class="n">bna_ioceth</span> <span class="o">*</span><span class="n">ioceth</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bna_ioceth_sm_ioc_disable_wait</span><span class="p">(</span><span class="k">struct</span> <span class="n">bna_ioceth</span> <span class="o">*</span><span class="n">ioceth</span><span class="p">,</span>
				<span class="k">enum</span> <span class="n">bna_ioceth_event</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IOCETH_E_IOC_DISABLED</span>:
		<span class="n">disable_mbox_intr</span><span class="p">(</span><span class="n">ioceth</span><span class="p">);</span>
		<span class="n">bfa_fsm_set_state</span><span class="p">(</span><span class="n">ioceth</span><span class="p">,</span> <span class="n">bna_ioceth_sm_stopped</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">IOCETH_E_ENET_STOPPED</span>:
		<span class="cm">/* This event is received due to enet failing */</span>
		<span class="cm">/* No-op */</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">bfa_sm_fault</span><span class="p">(</span><span class="n">event</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bna_ioceth_sm_failed_entry</span><span class="p">(</span><span class="k">struct</span> <span class="n">bna_ioceth</span> <span class="o">*</span><span class="n">ioceth</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bnad_cb_ioceth_failed</span><span class="p">(</span><span class="n">ioceth</span><span class="o">-&gt;</span><span class="n">bna</span><span class="o">-&gt;</span><span class="n">bnad</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bna_ioceth_sm_failed</span><span class="p">(</span><span class="k">struct</span> <span class="n">bna_ioceth</span> <span class="o">*</span><span class="n">ioceth</span><span class="p">,</span>
			<span class="k">enum</span> <span class="n">bna_ioceth_event</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IOCETH_E_DISABLE</span>:
		<span class="n">bfa_fsm_set_state</span><span class="p">(</span><span class="n">ioceth</span><span class="p">,</span> <span class="n">bna_ioceth_sm_ioc_disable_wait</span><span class="p">);</span>
		<span class="n">bfa_nw_ioc_disable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioceth</span><span class="o">-&gt;</span><span class="n">ioc</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">IOCETH_E_IOC_RESET</span>:
		<span class="n">enable_mbox_intr</span><span class="p">(</span><span class="n">ioceth</span><span class="p">);</span>
		<span class="n">bfa_fsm_set_state</span><span class="p">(</span><span class="n">ioceth</span><span class="p">,</span> <span class="n">bna_ioceth_sm_ioc_ready_wait</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">IOCETH_E_IOC_FAILED</span>:
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">bfa_sm_fault</span><span class="p">(</span><span class="n">event</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bna_bfi_attr_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">bna_ioceth</span> <span class="o">*</span><span class="n">ioceth</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfi_enet_attr_req</span> <span class="o">*</span><span class="n">attr_req</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ioceth</span><span class="o">-&gt;</span><span class="n">attr_req</span><span class="p">;</span>

	<span class="n">bfi_msgq_mhdr_set</span><span class="p">(</span><span class="n">attr_req</span><span class="o">-&gt;</span><span class="n">mh</span><span class="p">,</span> <span class="n">BFI_MC_ENET</span><span class="p">,</span>
		<span class="n">BFI_ENET_H2I_GET_ATTR_REQ</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">attr_req</span><span class="o">-&gt;</span><span class="n">mh</span><span class="p">.</span><span class="n">num_entries</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span>
	<span class="n">bfi_msgq_num_cmd_entries</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfi_enet_attr_req</span><span class="p">)));</span>
	<span class="n">bfa_msgq_cmd_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioceth</span><span class="o">-&gt;</span><span class="n">msgq_cmd</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
		<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfi_enet_attr_req</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">attr_req</span><span class="o">-&gt;</span><span class="n">mh</span><span class="p">);</span>
	<span class="n">bfa_msgq_cmd_post</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioceth</span><span class="o">-&gt;</span><span class="n">bna</span><span class="o">-&gt;</span><span class="n">msgq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioceth</span><span class="o">-&gt;</span><span class="n">msgq_cmd</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* IOC callback functions */</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bna_cb_ioceth_enable</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">,</span> <span class="k">enum</span> <span class="n">bfa_status</span> <span class="n">error</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bna_ioceth</span> <span class="o">*</span><span class="n">ioceth</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">bna_ioceth</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="n">bfa_fsm_send_event</span><span class="p">(</span><span class="n">ioceth</span><span class="p">,</span> <span class="n">IOCETH_E_IOC_FAILED</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">bfa_fsm_send_event</span><span class="p">(</span><span class="n">ioceth</span><span class="p">,</span> <span class="n">IOCETH_E_IOC_READY</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bna_cb_ioceth_disable</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bna_ioceth</span> <span class="o">*</span><span class="n">ioceth</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">bna_ioceth</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">;</span>

	<span class="n">bfa_fsm_send_event</span><span class="p">(</span><span class="n">ioceth</span><span class="p">,</span> <span class="n">IOCETH_E_IOC_DISABLED</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bna_cb_ioceth_hbfail</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bna_ioceth</span> <span class="o">*</span><span class="n">ioceth</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">bna_ioceth</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">;</span>

	<span class="n">bfa_fsm_send_event</span><span class="p">(</span><span class="n">ioceth</span><span class="p">,</span> <span class="n">IOCETH_E_IOC_FAILED</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bna_cb_ioceth_reset</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bna_ioceth</span> <span class="o">*</span><span class="n">ioceth</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">bna_ioceth</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">;</span>

	<span class="n">bfa_fsm_send_event</span><span class="p">(</span><span class="n">ioceth</span><span class="p">,</span> <span class="n">IOCETH_E_IOC_RESET</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">bfa_ioc_cbfn</span> <span class="n">bna_ioceth_cbfn</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">bna_cb_ioceth_enable</span><span class="p">,</span>
	<span class="n">bna_cb_ioceth_disable</span><span class="p">,</span>
	<span class="n">bna_cb_ioceth_hbfail</span><span class="p">,</span>
	<span class="n">bna_cb_ioceth_reset</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bna_attr_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">bna_ioceth</span> <span class="o">*</span><span class="n">ioceth</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ioceth</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">num_txq</span> <span class="o">=</span> <span class="n">BFI_ENET_DEF_TXQ</span><span class="p">;</span>
	<span class="n">ioceth</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">num_rxp</span> <span class="o">=</span> <span class="n">BFI_ENET_DEF_RXP</span><span class="p">;</span>
	<span class="n">ioceth</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">num_ucmac</span> <span class="o">=</span> <span class="n">BFI_ENET_DEF_UCAM</span><span class="p">;</span>
	<span class="n">ioceth</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">num_mcmac</span> <span class="o">=</span> <span class="n">BFI_ENET_MAX_MCAM</span><span class="p">;</span>
	<span class="n">ioceth</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">max_rit_size</span> <span class="o">=</span> <span class="n">BFI_ENET_DEF_RITSZ</span><span class="p">;</span>
	<span class="n">ioceth</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">fw_query_complete</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bna_ioceth_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">bna_ioceth</span> <span class="o">*</span><span class="n">ioceth</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bna</span> <span class="o">*</span><span class="n">bna</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">bna_res_info</span> <span class="o">*</span><span class="n">res_info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">dma</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">kva</span><span class="p">;</span>

	<span class="n">ioceth</span><span class="o">-&gt;</span><span class="n">bna</span> <span class="o">=</span> <span class="n">bna</span><span class="p">;</span>

	<span class="cm">/**</span>
<span class="cm">	 * Attach IOC and claim:</span>
<span class="cm">	 *	1. DMA memory for IOC attributes</span>
<span class="cm">	 *	2. Kernel memory for FW trace</span>
<span class="cm">	 */</span>
	<span class="n">bfa_nw_ioc_attach</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioceth</span><span class="o">-&gt;</span><span class="n">ioc</span><span class="p">,</span> <span class="n">ioceth</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bna_ioceth_cbfn</span><span class="p">);</span>
	<span class="n">bfa_nw_ioc_pci_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioceth</span><span class="o">-&gt;</span><span class="n">ioc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bna</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">BFI_PCIFN_CLASS_ETH</span><span class="p">);</span>

	<span class="n">BNA_GET_DMA_ADDR</span><span class="p">(</span>
		<span class="o">&amp;</span><span class="n">res_info</span><span class="p">[</span><span class="n">BNA_RES_MEM_T_ATTR</span><span class="p">].</span><span class="n">res_u</span><span class="p">.</span><span class="n">mem_info</span><span class="p">.</span><span class="n">mdl</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">dma</span><span class="p">,</span> <span class="n">dma</span><span class="p">);</span>
	<span class="n">kva</span> <span class="o">=</span> <span class="n">res_info</span><span class="p">[</span><span class="n">BNA_RES_MEM_T_ATTR</span><span class="p">].</span><span class="n">res_u</span><span class="p">.</span><span class="n">mem_info</span><span class="p">.</span><span class="n">mdl</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">kva</span><span class="p">;</span>
	<span class="n">bfa_nw_ioc_mem_claim</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioceth</span><span class="o">-&gt;</span><span class="n">ioc</span><span class="p">,</span> <span class="n">kva</span><span class="p">,</span> <span class="n">dma</span><span class="p">);</span>

	<span class="n">kva</span> <span class="o">=</span> <span class="n">res_info</span><span class="p">[</span><span class="n">BNA_RES_MEM_T_FWTRC</span><span class="p">].</span><span class="n">res_u</span><span class="p">.</span><span class="n">mem_info</span><span class="p">.</span><span class="n">mdl</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">kva</span><span class="p">;</span>
	<span class="n">bfa_nw_ioc_debug_memclaim</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioceth</span><span class="o">-&gt;</span><span class="n">ioc</span><span class="p">,</span> <span class="n">kva</span><span class="p">);</span>

	<span class="cm">/**</span>
<span class="cm">	 * Attach common modules (Diag, SFP, CEE, Port) and claim respective</span>
<span class="cm">	 * DMA memory.</span>
<span class="cm">	 */</span>
	<span class="n">BNA_GET_DMA_ADDR</span><span class="p">(</span>
		<span class="o">&amp;</span><span class="n">res_info</span><span class="p">[</span><span class="n">BNA_RES_MEM_T_COM</span><span class="p">].</span><span class="n">res_u</span><span class="p">.</span><span class="n">mem_info</span><span class="p">.</span><span class="n">mdl</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">dma</span><span class="p">,</span> <span class="n">dma</span><span class="p">);</span>
	<span class="n">kva</span> <span class="o">=</span> <span class="n">res_info</span><span class="p">[</span><span class="n">BNA_RES_MEM_T_COM</span><span class="p">].</span><span class="n">res_u</span><span class="p">.</span><span class="n">mem_info</span><span class="p">.</span><span class="n">mdl</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">kva</span><span class="p">;</span>
	<span class="n">bfa_nw_cee_attach</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bna</span><span class="o">-&gt;</span><span class="n">cee</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioceth</span><span class="o">-&gt;</span><span class="n">ioc</span><span class="p">,</span> <span class="n">bna</span><span class="p">);</span>
	<span class="n">bfa_nw_cee_mem_claim</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bna</span><span class="o">-&gt;</span><span class="n">cee</span><span class="p">,</span> <span class="n">kva</span><span class="p">,</span> <span class="n">dma</span><span class="p">);</span>
	<span class="n">kva</span> <span class="o">+=</span> <span class="n">bfa_nw_cee_meminfo</span><span class="p">();</span>
	<span class="n">dma</span> <span class="o">+=</span> <span class="n">bfa_nw_cee_meminfo</span><span class="p">();</span>

	<span class="n">bfa_nw_flash_attach</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bna</span><span class="o">-&gt;</span><span class="n">flash</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioceth</span><span class="o">-&gt;</span><span class="n">ioc</span><span class="p">,</span> <span class="n">bna</span><span class="p">);</span>
	<span class="n">bfa_nw_flash_memclaim</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bna</span><span class="o">-&gt;</span><span class="n">flash</span><span class="p">,</span> <span class="n">kva</span><span class="p">,</span> <span class="n">dma</span><span class="p">);</span>
	<span class="n">kva</span> <span class="o">+=</span> <span class="n">bfa_nw_flash_meminfo</span><span class="p">();</span>
	<span class="n">dma</span> <span class="o">+=</span> <span class="n">bfa_nw_flash_meminfo</span><span class="p">();</span>

	<span class="n">bfa_msgq_attach</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bna</span><span class="o">-&gt;</span><span class="n">msgq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioceth</span><span class="o">-&gt;</span><span class="n">ioc</span><span class="p">);</span>
	<span class="n">bfa_msgq_memclaim</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bna</span><span class="o">-&gt;</span><span class="n">msgq</span><span class="p">,</span> <span class="n">kva</span><span class="p">,</span> <span class="n">dma</span><span class="p">);</span>
	<span class="n">bfa_msgq_regisr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bna</span><span class="o">-&gt;</span><span class="n">msgq</span><span class="p">,</span> <span class="n">BFI_MC_ENET</span><span class="p">,</span> <span class="n">bna_msgq_rsp_handler</span><span class="p">,</span> <span class="n">bna</span><span class="p">);</span>
	<span class="n">kva</span> <span class="o">+=</span> <span class="n">bfa_msgq_meminfo</span><span class="p">();</span>
	<span class="n">dma</span> <span class="o">+=</span> <span class="n">bfa_msgq_meminfo</span><span class="p">();</span>

	<span class="n">ioceth</span><span class="o">-&gt;</span><span class="n">stop_cbfn</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">ioceth</span><span class="o">-&gt;</span><span class="n">stop_cbarg</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">bna_attr_init</span><span class="p">(</span><span class="n">ioceth</span><span class="p">);</span>

	<span class="n">bfa_fsm_set_state</span><span class="p">(</span><span class="n">ioceth</span><span class="p">,</span> <span class="n">bna_ioceth_sm_stopped</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bna_ioceth_uninit</span><span class="p">(</span><span class="k">struct</span> <span class="n">bna_ioceth</span> <span class="o">*</span><span class="n">ioceth</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bfa_nw_ioc_detach</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioceth</span><span class="o">-&gt;</span><span class="n">ioc</span><span class="p">);</span>

	<span class="n">ioceth</span><span class="o">-&gt;</span><span class="n">bna</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">bna_ioceth_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">bna_ioceth</span> <span class="o">*</span><span class="n">ioceth</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ioceth</span><span class="o">-&gt;</span><span class="n">fsm</span> <span class="o">==</span> <span class="p">(</span><span class="n">bfa_fsm_t</span><span class="p">)</span><span class="n">bna_ioceth_sm_ready</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bnad_cb_ioceth_ready</span><span class="p">(</span><span class="n">ioceth</span><span class="o">-&gt;</span><span class="n">bna</span><span class="o">-&gt;</span><span class="n">bnad</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ioceth</span><span class="o">-&gt;</span><span class="n">fsm</span> <span class="o">==</span> <span class="p">(</span><span class="n">bfa_fsm_t</span><span class="p">)</span><span class="n">bna_ioceth_sm_stopped</span><span class="p">)</span>
		<span class="n">bfa_fsm_send_event</span><span class="p">(</span><span class="n">ioceth</span><span class="p">,</span> <span class="n">IOCETH_E_ENABLE</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">bna_ioceth_disable</span><span class="p">(</span><span class="k">struct</span> <span class="n">bna_ioceth</span> <span class="o">*</span><span class="n">ioceth</span><span class="p">,</span> <span class="k">enum</span> <span class="n">bna_cleanup_type</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">BNA_SOFT_CLEANUP</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bnad_cb_ioceth_disabled</span><span class="p">(</span><span class="n">ioceth</span><span class="o">-&gt;</span><span class="n">bna</span><span class="o">-&gt;</span><span class="n">bnad</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ioceth</span><span class="o">-&gt;</span><span class="n">stop_cbfn</span> <span class="o">=</span> <span class="n">bnad_cb_ioceth_disabled</span><span class="p">;</span>
	<span class="n">ioceth</span><span class="o">-&gt;</span><span class="n">stop_cbarg</span> <span class="o">=</span> <span class="n">ioceth</span><span class="o">-&gt;</span><span class="n">bna</span><span class="o">-&gt;</span><span class="n">bnad</span><span class="p">;</span>

	<span class="n">bfa_fsm_send_event</span><span class="p">(</span><span class="n">ioceth</span><span class="p">,</span> <span class="n">IOCETH_E_DISABLE</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bna_ucam_mod_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">bna_ucam_mod</span> <span class="o">*</span><span class="n">ucam_mod</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bna</span> <span class="o">*</span><span class="n">bna</span><span class="p">,</span>
		  <span class="k">struct</span> <span class="n">bna_res_info</span> <span class="o">*</span><span class="n">res_info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">ucam_mod</span><span class="o">-&gt;</span><span class="n">ucmac</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">bna_mac</span> <span class="o">*</span><span class="p">)</span>
	<span class="n">res_info</span><span class="p">[</span><span class="n">BNA_MOD_RES_MEM_T_UCMAC_ARRAY</span><span class="p">].</span><span class="n">res_u</span><span class="p">.</span><span class="n">mem_info</span><span class="p">.</span><span class="n">mdl</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">kva</span><span class="p">;</span>

	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ucam_mod</span><span class="o">-&gt;</span><span class="n">free_q</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">bna</span><span class="o">-&gt;</span><span class="n">ioceth</span><span class="p">.</span><span class="n">attr</span><span class="p">.</span><span class="n">num_ucmac</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bfa_q_qe_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ucam_mod</span><span class="o">-&gt;</span><span class="n">ucmac</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">qe</span><span class="p">);</span>
		<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ucam_mod</span><span class="o">-&gt;</span><span class="n">ucmac</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">qe</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ucam_mod</span><span class="o">-&gt;</span><span class="n">free_q</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">ucam_mod</span><span class="o">-&gt;</span><span class="n">bna</span> <span class="o">=</span> <span class="n">bna</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bna_ucam_mod_uninit</span><span class="p">(</span><span class="k">struct</span> <span class="n">bna_ucam_mod</span> <span class="o">*</span><span class="n">ucam_mod</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">qe</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">list_for_each</span><span class="p">(</span><span class="n">qe</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ucam_mod</span><span class="o">-&gt;</span><span class="n">free_q</span><span class="p">)</span>
		<span class="n">i</span><span class="o">++</span><span class="p">;</span>

	<span class="n">ucam_mod</span><span class="o">-&gt;</span><span class="n">bna</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bna_mcam_mod_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">bna_mcam_mod</span> <span class="o">*</span><span class="n">mcam_mod</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bna</span> <span class="o">*</span><span class="n">bna</span><span class="p">,</span>
		  <span class="k">struct</span> <span class="n">bna_res_info</span> <span class="o">*</span><span class="n">res_info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">mcam_mod</span><span class="o">-&gt;</span><span class="n">mcmac</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">bna_mac</span> <span class="o">*</span><span class="p">)</span>
	<span class="n">res_info</span><span class="p">[</span><span class="n">BNA_MOD_RES_MEM_T_MCMAC_ARRAY</span><span class="p">].</span><span class="n">res_u</span><span class="p">.</span><span class="n">mem_info</span><span class="p">.</span><span class="n">mdl</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">kva</span><span class="p">;</span>

	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mcam_mod</span><span class="o">-&gt;</span><span class="n">free_q</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">bna</span><span class="o">-&gt;</span><span class="n">ioceth</span><span class="p">.</span><span class="n">attr</span><span class="p">.</span><span class="n">num_mcmac</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bfa_q_qe_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mcam_mod</span><span class="o">-&gt;</span><span class="n">mcmac</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">qe</span><span class="p">);</span>
		<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mcam_mod</span><span class="o">-&gt;</span><span class="n">mcmac</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">qe</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mcam_mod</span><span class="o">-&gt;</span><span class="n">free_q</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">mcam_mod</span><span class="o">-&gt;</span><span class="n">mchandle</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">bna_mcam_handle</span> <span class="o">*</span><span class="p">)</span>
	<span class="n">res_info</span><span class="p">[</span><span class="n">BNA_MOD_RES_MEM_T_MCHANDLE_ARRAY</span><span class="p">].</span><span class="n">res_u</span><span class="p">.</span><span class="n">mem_info</span><span class="p">.</span><span class="n">mdl</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">kva</span><span class="p">;</span>

	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mcam_mod</span><span class="o">-&gt;</span><span class="n">free_handle_q</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">bna</span><span class="o">-&gt;</span><span class="n">ioceth</span><span class="p">.</span><span class="n">attr</span><span class="p">.</span><span class="n">num_mcmac</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bfa_q_qe_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mcam_mod</span><span class="o">-&gt;</span><span class="n">mchandle</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">qe</span><span class="p">);</span>
		<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mcam_mod</span><span class="o">-&gt;</span><span class="n">mchandle</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">qe</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">mcam_mod</span><span class="o">-&gt;</span><span class="n">free_handle_q</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">mcam_mod</span><span class="o">-&gt;</span><span class="n">bna</span> <span class="o">=</span> <span class="n">bna</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bna_mcam_mod_uninit</span><span class="p">(</span><span class="k">struct</span> <span class="n">bna_mcam_mod</span> <span class="o">*</span><span class="n">mcam_mod</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">qe</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">list_for_each</span><span class="p">(</span><span class="n">qe</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mcam_mod</span><span class="o">-&gt;</span><span class="n">free_q</span><span class="p">)</span> <span class="n">i</span><span class="o">++</span><span class="p">;</span>

	<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">list_for_each</span><span class="p">(</span><span class="n">qe</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mcam_mod</span><span class="o">-&gt;</span><span class="n">free_handle_q</span><span class="p">)</span> <span class="n">i</span><span class="o">++</span><span class="p">;</span>

	<span class="n">mcam_mod</span><span class="o">-&gt;</span><span class="n">bna</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bna_bfi_stats_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">bna</span> <span class="o">*</span><span class="n">bna</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfi_enet_stats_req</span> <span class="o">*</span><span class="n">stats_req</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">bna</span><span class="o">-&gt;</span><span class="n">stats_mod</span><span class="p">.</span><span class="n">stats_get</span><span class="p">;</span>

	<span class="n">bna</span><span class="o">-&gt;</span><span class="n">stats_mod</span><span class="p">.</span><span class="n">stats_get_busy</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="n">bfi_msgq_mhdr_set</span><span class="p">(</span><span class="n">stats_req</span><span class="o">-&gt;</span><span class="n">mh</span><span class="p">,</span> <span class="n">BFI_MC_ENET</span><span class="p">,</span>
		<span class="n">BFI_ENET_H2I_STATS_GET_REQ</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">stats_req</span><span class="o">-&gt;</span><span class="n">mh</span><span class="p">.</span><span class="n">num_entries</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span>
		<span class="n">bfi_msgq_num_cmd_entries</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfi_enet_stats_req</span><span class="p">)));</span>
	<span class="n">stats_req</span><span class="o">-&gt;</span><span class="n">stats_mask</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">BFI_ENET_STATS_ALL</span><span class="p">);</span>
	<span class="n">stats_req</span><span class="o">-&gt;</span><span class="n">tx_enet_mask</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">bna</span><span class="o">-&gt;</span><span class="n">tx_mod</span><span class="p">.</span><span class="n">rid_mask</span><span class="p">);</span>
	<span class="n">stats_req</span><span class="o">-&gt;</span><span class="n">rx_enet_mask</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">bna</span><span class="o">-&gt;</span><span class="n">rx_mod</span><span class="p">.</span><span class="n">rid_mask</span><span class="p">);</span>
	<span class="n">stats_req</span><span class="o">-&gt;</span><span class="n">host_buffer</span><span class="p">.</span><span class="n">a32</span><span class="p">.</span><span class="n">addr_hi</span> <span class="o">=</span> <span class="n">bna</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">hw_stats_dma</span><span class="p">.</span><span class="n">msb</span><span class="p">;</span>
	<span class="n">stats_req</span><span class="o">-&gt;</span><span class="n">host_buffer</span><span class="p">.</span><span class="n">a32</span><span class="p">.</span><span class="n">addr_lo</span> <span class="o">=</span> <span class="n">bna</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">hw_stats_dma</span><span class="p">.</span><span class="n">lsb</span><span class="p">;</span>

	<span class="n">bfa_msgq_cmd_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bna</span><span class="o">-&gt;</span><span class="n">stats_mod</span><span class="p">.</span><span class="n">stats_get_cmd</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
		<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfi_enet_stats_req</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">stats_req</span><span class="o">-&gt;</span><span class="n">mh</span><span class="p">);</span>
	<span class="n">bfa_msgq_cmd_post</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bna</span><span class="o">-&gt;</span><span class="n">msgq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bna</span><span class="o">-&gt;</span><span class="n">stats_mod</span><span class="p">.</span><span class="n">stats_get_cmd</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">bna_res_req</span><span class="p">(</span><span class="k">struct</span> <span class="n">bna_res_info</span> <span class="o">*</span><span class="n">res_info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* DMA memory for COMMON_MODULE */</span>
	<span class="n">res_info</span><span class="p">[</span><span class="n">BNA_RES_MEM_T_COM</span><span class="p">].</span><span class="n">res_type</span> <span class="o">=</span> <span class="n">BNA_RES_T_MEM</span><span class="p">;</span>
	<span class="n">res_info</span><span class="p">[</span><span class="n">BNA_RES_MEM_T_COM</span><span class="p">].</span><span class="n">res_u</span><span class="p">.</span><span class="n">mem_info</span><span class="p">.</span><span class="n">mem_type</span> <span class="o">=</span> <span class="n">BNA_MEM_T_DMA</span><span class="p">;</span>
	<span class="n">res_info</span><span class="p">[</span><span class="n">BNA_RES_MEM_T_COM</span><span class="p">].</span><span class="n">res_u</span><span class="p">.</span><span class="n">mem_info</span><span class="p">.</span><span class="n">num</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">res_info</span><span class="p">[</span><span class="n">BNA_RES_MEM_T_COM</span><span class="p">].</span><span class="n">res_u</span><span class="p">.</span><span class="n">mem_info</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">ALIGN</span><span class="p">(</span>
				<span class="p">(</span><span class="n">bfa_nw_cee_meminfo</span><span class="p">()</span> <span class="o">+</span>
				 <span class="n">bfa_nw_flash_meminfo</span><span class="p">()</span> <span class="o">+</span>
				 <span class="n">bfa_msgq_meminfo</span><span class="p">()),</span> <span class="n">PAGE_SIZE</span><span class="p">);</span>

	<span class="cm">/* DMA memory for retrieving IOC attributes */</span>
	<span class="n">res_info</span><span class="p">[</span><span class="n">BNA_RES_MEM_T_ATTR</span><span class="p">].</span><span class="n">res_type</span> <span class="o">=</span> <span class="n">BNA_RES_T_MEM</span><span class="p">;</span>
	<span class="n">res_info</span><span class="p">[</span><span class="n">BNA_RES_MEM_T_ATTR</span><span class="p">].</span><span class="n">res_u</span><span class="p">.</span><span class="n">mem_info</span><span class="p">.</span><span class="n">mem_type</span> <span class="o">=</span> <span class="n">BNA_MEM_T_DMA</span><span class="p">;</span>
	<span class="n">res_info</span><span class="p">[</span><span class="n">BNA_RES_MEM_T_ATTR</span><span class="p">].</span><span class="n">res_u</span><span class="p">.</span><span class="n">mem_info</span><span class="p">.</span><span class="n">num</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">res_info</span><span class="p">[</span><span class="n">BNA_RES_MEM_T_ATTR</span><span class="p">].</span><span class="n">res_u</span><span class="p">.</span><span class="n">mem_info</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span>
				<span class="n">ALIGN</span><span class="p">(</span><span class="n">bfa_nw_ioc_meminfo</span><span class="p">(),</span> <span class="n">PAGE_SIZE</span><span class="p">);</span>

	<span class="cm">/* Virtual memory for retreiving fw_trc */</span>
	<span class="n">res_info</span><span class="p">[</span><span class="n">BNA_RES_MEM_T_FWTRC</span><span class="p">].</span><span class="n">res_type</span> <span class="o">=</span> <span class="n">BNA_RES_T_MEM</span><span class="p">;</span>
	<span class="n">res_info</span><span class="p">[</span><span class="n">BNA_RES_MEM_T_FWTRC</span><span class="p">].</span><span class="n">res_u</span><span class="p">.</span><span class="n">mem_info</span><span class="p">.</span><span class="n">mem_type</span> <span class="o">=</span> <span class="n">BNA_MEM_T_KVA</span><span class="p">;</span>
	<span class="n">res_info</span><span class="p">[</span><span class="n">BNA_RES_MEM_T_FWTRC</span><span class="p">].</span><span class="n">res_u</span><span class="p">.</span><span class="n">mem_info</span><span class="p">.</span><span class="n">num</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">res_info</span><span class="p">[</span><span class="n">BNA_RES_MEM_T_FWTRC</span><span class="p">].</span><span class="n">res_u</span><span class="p">.</span><span class="n">mem_info</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">BNA_DBG_FWTRC_LEN</span><span class="p">;</span>

	<span class="cm">/* DMA memory for retreiving stats */</span>
	<span class="n">res_info</span><span class="p">[</span><span class="n">BNA_RES_MEM_T_STATS</span><span class="p">].</span><span class="n">res_type</span> <span class="o">=</span> <span class="n">BNA_RES_T_MEM</span><span class="p">;</span>
	<span class="n">res_info</span><span class="p">[</span><span class="n">BNA_RES_MEM_T_STATS</span><span class="p">].</span><span class="n">res_u</span><span class="p">.</span><span class="n">mem_info</span><span class="p">.</span><span class="n">mem_type</span> <span class="o">=</span> <span class="n">BNA_MEM_T_DMA</span><span class="p">;</span>
	<span class="n">res_info</span><span class="p">[</span><span class="n">BNA_RES_MEM_T_STATS</span><span class="p">].</span><span class="n">res_u</span><span class="p">.</span><span class="n">mem_info</span><span class="p">.</span><span class="n">num</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">res_info</span><span class="p">[</span><span class="n">BNA_RES_MEM_T_STATS</span><span class="p">].</span><span class="n">res_u</span><span class="p">.</span><span class="n">mem_info</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span>
				<span class="n">ALIGN</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfi_enet_stats</span><span class="p">),</span>
					<span class="n">PAGE_SIZE</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">bna_mod_res_req</span><span class="p">(</span><span class="k">struct</span> <span class="n">bna</span> <span class="o">*</span><span class="n">bna</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bna_res_info</span> <span class="o">*</span><span class="n">res_info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bna_attr</span> <span class="o">*</span><span class="n">attr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">bna</span><span class="o">-&gt;</span><span class="n">ioceth</span><span class="p">.</span><span class="n">attr</span><span class="p">;</span>

	<span class="cm">/* Virtual memory for Tx objects - stored by Tx module */</span>
	<span class="n">res_info</span><span class="p">[</span><span class="n">BNA_MOD_RES_MEM_T_TX_ARRAY</span><span class="p">].</span><span class="n">res_type</span> <span class="o">=</span> <span class="n">BNA_RES_T_MEM</span><span class="p">;</span>
	<span class="n">res_info</span><span class="p">[</span><span class="n">BNA_MOD_RES_MEM_T_TX_ARRAY</span><span class="p">].</span><span class="n">res_u</span><span class="p">.</span><span class="n">mem_info</span><span class="p">.</span><span class="n">mem_type</span> <span class="o">=</span>
		<span class="n">BNA_MEM_T_KVA</span><span class="p">;</span>
	<span class="n">res_info</span><span class="p">[</span><span class="n">BNA_MOD_RES_MEM_T_TX_ARRAY</span><span class="p">].</span><span class="n">res_u</span><span class="p">.</span><span class="n">mem_info</span><span class="p">.</span><span class="n">num</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">res_info</span><span class="p">[</span><span class="n">BNA_MOD_RES_MEM_T_TX_ARRAY</span><span class="p">].</span><span class="n">res_u</span><span class="p">.</span><span class="n">mem_info</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span>
		<span class="n">attr</span><span class="o">-&gt;</span><span class="n">num_txq</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">bna_tx</span><span class="p">);</span>

	<span class="cm">/* Virtual memory for TxQ - stored by Tx module */</span>
	<span class="n">res_info</span><span class="p">[</span><span class="n">BNA_MOD_RES_MEM_T_TXQ_ARRAY</span><span class="p">].</span><span class="n">res_type</span> <span class="o">=</span> <span class="n">BNA_RES_T_MEM</span><span class="p">;</span>
	<span class="n">res_info</span><span class="p">[</span><span class="n">BNA_MOD_RES_MEM_T_TXQ_ARRAY</span><span class="p">].</span><span class="n">res_u</span><span class="p">.</span><span class="n">mem_info</span><span class="p">.</span><span class="n">mem_type</span> <span class="o">=</span>
		<span class="n">BNA_MEM_T_KVA</span><span class="p">;</span>
	<span class="n">res_info</span><span class="p">[</span><span class="n">BNA_MOD_RES_MEM_T_TXQ_ARRAY</span><span class="p">].</span><span class="n">res_u</span><span class="p">.</span><span class="n">mem_info</span><span class="p">.</span><span class="n">num</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">res_info</span><span class="p">[</span><span class="n">BNA_MOD_RES_MEM_T_TXQ_ARRAY</span><span class="p">].</span><span class="n">res_u</span><span class="p">.</span><span class="n">mem_info</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span>
		<span class="n">attr</span><span class="o">-&gt;</span><span class="n">num_txq</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">bna_txq</span><span class="p">);</span>

	<span class="cm">/* Virtual memory for Rx objects - stored by Rx module */</span>
	<span class="n">res_info</span><span class="p">[</span><span class="n">BNA_MOD_RES_MEM_T_RX_ARRAY</span><span class="p">].</span><span class="n">res_type</span> <span class="o">=</span> <span class="n">BNA_RES_T_MEM</span><span class="p">;</span>
	<span class="n">res_info</span><span class="p">[</span><span class="n">BNA_MOD_RES_MEM_T_RX_ARRAY</span><span class="p">].</span><span class="n">res_u</span><span class="p">.</span><span class="n">mem_info</span><span class="p">.</span><span class="n">mem_type</span> <span class="o">=</span>
		<span class="n">BNA_MEM_T_KVA</span><span class="p">;</span>
	<span class="n">res_info</span><span class="p">[</span><span class="n">BNA_MOD_RES_MEM_T_RX_ARRAY</span><span class="p">].</span><span class="n">res_u</span><span class="p">.</span><span class="n">mem_info</span><span class="p">.</span><span class="n">num</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">res_info</span><span class="p">[</span><span class="n">BNA_MOD_RES_MEM_T_RX_ARRAY</span><span class="p">].</span><span class="n">res_u</span><span class="p">.</span><span class="n">mem_info</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span>
		<span class="n">attr</span><span class="o">-&gt;</span><span class="n">num_rxp</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">bna_rx</span><span class="p">);</span>

	<span class="cm">/* Virtual memory for RxPath - stored by Rx module */</span>
	<span class="n">res_info</span><span class="p">[</span><span class="n">BNA_MOD_RES_MEM_T_RXP_ARRAY</span><span class="p">].</span><span class="n">res_type</span> <span class="o">=</span> <span class="n">BNA_RES_T_MEM</span><span class="p">;</span>
	<span class="n">res_info</span><span class="p">[</span><span class="n">BNA_MOD_RES_MEM_T_RXP_ARRAY</span><span class="p">].</span><span class="n">res_u</span><span class="p">.</span><span class="n">mem_info</span><span class="p">.</span><span class="n">mem_type</span> <span class="o">=</span>
		<span class="n">BNA_MEM_T_KVA</span><span class="p">;</span>
	<span class="n">res_info</span><span class="p">[</span><span class="n">BNA_MOD_RES_MEM_T_RXP_ARRAY</span><span class="p">].</span><span class="n">res_u</span><span class="p">.</span><span class="n">mem_info</span><span class="p">.</span><span class="n">num</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">res_info</span><span class="p">[</span><span class="n">BNA_MOD_RES_MEM_T_RXP_ARRAY</span><span class="p">].</span><span class="n">res_u</span><span class="p">.</span><span class="n">mem_info</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span>
		<span class="n">attr</span><span class="o">-&gt;</span><span class="n">num_rxp</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">bna_rxp</span><span class="p">);</span>

	<span class="cm">/* Virtual memory for RxQ - stored by Rx module */</span>
	<span class="n">res_info</span><span class="p">[</span><span class="n">BNA_MOD_RES_MEM_T_RXQ_ARRAY</span><span class="p">].</span><span class="n">res_type</span> <span class="o">=</span> <span class="n">BNA_RES_T_MEM</span><span class="p">;</span>
	<span class="n">res_info</span><span class="p">[</span><span class="n">BNA_MOD_RES_MEM_T_RXQ_ARRAY</span><span class="p">].</span><span class="n">res_u</span><span class="p">.</span><span class="n">mem_info</span><span class="p">.</span><span class="n">mem_type</span> <span class="o">=</span>
		<span class="n">BNA_MEM_T_KVA</span><span class="p">;</span>
	<span class="n">res_info</span><span class="p">[</span><span class="n">BNA_MOD_RES_MEM_T_RXQ_ARRAY</span><span class="p">].</span><span class="n">res_u</span><span class="p">.</span><span class="n">mem_info</span><span class="p">.</span><span class="n">num</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">res_info</span><span class="p">[</span><span class="n">BNA_MOD_RES_MEM_T_RXQ_ARRAY</span><span class="p">].</span><span class="n">res_u</span><span class="p">.</span><span class="n">mem_info</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span>
		<span class="p">(</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">num_rxp</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">bna_rxq</span><span class="p">);</span>

	<span class="cm">/* Virtual memory for Unicast MAC address - stored by ucam module */</span>
	<span class="n">res_info</span><span class="p">[</span><span class="n">BNA_MOD_RES_MEM_T_UCMAC_ARRAY</span><span class="p">].</span><span class="n">res_type</span> <span class="o">=</span> <span class="n">BNA_RES_T_MEM</span><span class="p">;</span>
	<span class="n">res_info</span><span class="p">[</span><span class="n">BNA_MOD_RES_MEM_T_UCMAC_ARRAY</span><span class="p">].</span><span class="n">res_u</span><span class="p">.</span><span class="n">mem_info</span><span class="p">.</span><span class="n">mem_type</span> <span class="o">=</span>
		<span class="n">BNA_MEM_T_KVA</span><span class="p">;</span>
	<span class="n">res_info</span><span class="p">[</span><span class="n">BNA_MOD_RES_MEM_T_UCMAC_ARRAY</span><span class="p">].</span><span class="n">res_u</span><span class="p">.</span><span class="n">mem_info</span><span class="p">.</span><span class="n">num</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">res_info</span><span class="p">[</span><span class="n">BNA_MOD_RES_MEM_T_UCMAC_ARRAY</span><span class="p">].</span><span class="n">res_u</span><span class="p">.</span><span class="n">mem_info</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span>
		<span class="n">attr</span><span class="o">-&gt;</span><span class="n">num_ucmac</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">bna_mac</span><span class="p">);</span>

	<span class="cm">/* Virtual memory for Multicast MAC address - stored by mcam module */</span>
	<span class="n">res_info</span><span class="p">[</span><span class="n">BNA_MOD_RES_MEM_T_MCMAC_ARRAY</span><span class="p">].</span><span class="n">res_type</span> <span class="o">=</span> <span class="n">BNA_RES_T_MEM</span><span class="p">;</span>
	<span class="n">res_info</span><span class="p">[</span><span class="n">BNA_MOD_RES_MEM_T_MCMAC_ARRAY</span><span class="p">].</span><span class="n">res_u</span><span class="p">.</span><span class="n">mem_info</span><span class="p">.</span><span class="n">mem_type</span> <span class="o">=</span>
		<span class="n">BNA_MEM_T_KVA</span><span class="p">;</span>
	<span class="n">res_info</span><span class="p">[</span><span class="n">BNA_MOD_RES_MEM_T_MCMAC_ARRAY</span><span class="p">].</span><span class="n">res_u</span><span class="p">.</span><span class="n">mem_info</span><span class="p">.</span><span class="n">num</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">res_info</span><span class="p">[</span><span class="n">BNA_MOD_RES_MEM_T_MCMAC_ARRAY</span><span class="p">].</span><span class="n">res_u</span><span class="p">.</span><span class="n">mem_info</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span>
		<span class="n">attr</span><span class="o">-&gt;</span><span class="n">num_mcmac</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">bna_mac</span><span class="p">);</span>

	<span class="cm">/* Virtual memory for Multicast handle - stored by mcam module */</span>
	<span class="n">res_info</span><span class="p">[</span><span class="n">BNA_MOD_RES_MEM_T_MCHANDLE_ARRAY</span><span class="p">].</span><span class="n">res_type</span> <span class="o">=</span> <span class="n">BNA_RES_T_MEM</span><span class="p">;</span>
	<span class="n">res_info</span><span class="p">[</span><span class="n">BNA_MOD_RES_MEM_T_MCHANDLE_ARRAY</span><span class="p">].</span><span class="n">res_u</span><span class="p">.</span><span class="n">mem_info</span><span class="p">.</span><span class="n">mem_type</span> <span class="o">=</span>
		<span class="n">BNA_MEM_T_KVA</span><span class="p">;</span>
	<span class="n">res_info</span><span class="p">[</span><span class="n">BNA_MOD_RES_MEM_T_MCHANDLE_ARRAY</span><span class="p">].</span><span class="n">res_u</span><span class="p">.</span><span class="n">mem_info</span><span class="p">.</span><span class="n">num</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">res_info</span><span class="p">[</span><span class="n">BNA_MOD_RES_MEM_T_MCHANDLE_ARRAY</span><span class="p">].</span><span class="n">res_u</span><span class="p">.</span><span class="n">mem_info</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span>
		<span class="n">attr</span><span class="o">-&gt;</span><span class="n">num_mcmac</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">bna_mcam_handle</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">bna_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">bna</span> <span class="o">*</span><span class="n">bna</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bnad</span> <span class="o">*</span><span class="n">bnad</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">bfa_pcidev</span> <span class="o">*</span><span class="n">pcidev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bna_res_info</span> <span class="o">*</span><span class="n">res_info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bna</span><span class="o">-&gt;</span><span class="n">bnad</span> <span class="o">=</span> <span class="n">bnad</span><span class="p">;</span>
	<span class="n">bna</span><span class="o">-&gt;</span><span class="n">pcidev</span> <span class="o">=</span> <span class="o">*</span><span class="n">pcidev</span><span class="p">;</span>

	<span class="n">bna</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">hw_stats_kva</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">bfi_enet_stats</span> <span class="o">*</span><span class="p">)</span>
		<span class="n">res_info</span><span class="p">[</span><span class="n">BNA_RES_MEM_T_STATS</span><span class="p">].</span><span class="n">res_u</span><span class="p">.</span><span class="n">mem_info</span><span class="p">.</span><span class="n">mdl</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">kva</span><span class="p">;</span>
	<span class="n">bna</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">hw_stats_dma</span><span class="p">.</span><span class="n">msb</span> <span class="o">=</span>
		<span class="n">res_info</span><span class="p">[</span><span class="n">BNA_RES_MEM_T_STATS</span><span class="p">].</span><span class="n">res_u</span><span class="p">.</span><span class="n">mem_info</span><span class="p">.</span><span class="n">mdl</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">dma</span><span class="p">.</span><span class="n">msb</span><span class="p">;</span>
	<span class="n">bna</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">hw_stats_dma</span><span class="p">.</span><span class="n">lsb</span> <span class="o">=</span>
		<span class="n">res_info</span><span class="p">[</span><span class="n">BNA_RES_MEM_T_STATS</span><span class="p">].</span><span class="n">res_u</span><span class="p">.</span><span class="n">mem_info</span><span class="p">.</span><span class="n">mdl</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">dma</span><span class="p">.</span><span class="n">lsb</span><span class="p">;</span>

	<span class="n">bna_reg_addr_init</span><span class="p">(</span><span class="n">bna</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bna</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">);</span>

	<span class="cm">/* Also initializes diag, cee, sfp, phy_port, msgq */</span>
	<span class="n">bna_ioceth_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bna</span><span class="o">-&gt;</span><span class="n">ioceth</span><span class="p">,</span> <span class="n">bna</span><span class="p">,</span> <span class="n">res_info</span><span class="p">);</span>

	<span class="n">bna_enet_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bna</span><span class="o">-&gt;</span><span class="n">enet</span><span class="p">,</span> <span class="n">bna</span><span class="p">);</span>
	<span class="n">bna_ethport_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bna</span><span class="o">-&gt;</span><span class="n">ethport</span><span class="p">,</span> <span class="n">bna</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">bna_mod_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">bna</span> <span class="o">*</span><span class="n">bna</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bna_res_info</span> <span class="o">*</span><span class="n">res_info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bna_tx_mod_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bna</span><span class="o">-&gt;</span><span class="n">tx_mod</span><span class="p">,</span> <span class="n">bna</span><span class="p">,</span> <span class="n">res_info</span><span class="p">);</span>

	<span class="n">bna_rx_mod_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bna</span><span class="o">-&gt;</span><span class="n">rx_mod</span><span class="p">,</span> <span class="n">bna</span><span class="p">,</span> <span class="n">res_info</span><span class="p">);</span>

	<span class="n">bna_ucam_mod_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bna</span><span class="o">-&gt;</span><span class="n">ucam_mod</span><span class="p">,</span> <span class="n">bna</span><span class="p">,</span> <span class="n">res_info</span><span class="p">);</span>

	<span class="n">bna_mcam_mod_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bna</span><span class="o">-&gt;</span><span class="n">mcam_mod</span><span class="p">,</span> <span class="n">bna</span><span class="p">,</span> <span class="n">res_info</span><span class="p">);</span>

	<span class="n">bna</span><span class="o">-&gt;</span><span class="n">default_mode_rid</span> <span class="o">=</span> <span class="n">BFI_INVALID_RID</span><span class="p">;</span>
	<span class="n">bna</span><span class="o">-&gt;</span><span class="n">promisc_rid</span> <span class="o">=</span> <span class="n">BFI_INVALID_RID</span><span class="p">;</span>

	<span class="n">bna</span><span class="o">-&gt;</span><span class="n">mod_flags</span> <span class="o">|=</span> <span class="n">BNA_MOD_F_INIT_DONE</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">bna_uninit</span><span class="p">(</span><span class="k">struct</span> <span class="n">bna</span> <span class="o">*</span><span class="n">bna</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bna</span><span class="o">-&gt;</span><span class="n">mod_flags</span> <span class="o">&amp;</span> <span class="n">BNA_MOD_F_INIT_DONE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bna_mcam_mod_uninit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bna</span><span class="o">-&gt;</span><span class="n">mcam_mod</span><span class="p">);</span>
		<span class="n">bna_ucam_mod_uninit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bna</span><span class="o">-&gt;</span><span class="n">ucam_mod</span><span class="p">);</span>
		<span class="n">bna_rx_mod_uninit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bna</span><span class="o">-&gt;</span><span class="n">rx_mod</span><span class="p">);</span>
		<span class="n">bna_tx_mod_uninit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bna</span><span class="o">-&gt;</span><span class="n">tx_mod</span><span class="p">);</span>
		<span class="n">bna</span><span class="o">-&gt;</span><span class="n">mod_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">BNA_MOD_F_INIT_DONE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">bna_stats_mod_uninit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bna</span><span class="o">-&gt;</span><span class="n">stats_mod</span><span class="p">);</span>
	<span class="n">bna_ethport_uninit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bna</span><span class="o">-&gt;</span><span class="n">ethport</span><span class="p">);</span>
	<span class="n">bna_enet_uninit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bna</span><span class="o">-&gt;</span><span class="n">enet</span><span class="p">);</span>

	<span class="n">bna_ioceth_uninit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bna</span><span class="o">-&gt;</span><span class="n">ioceth</span><span class="p">);</span>

	<span class="n">bna</span><span class="o">-&gt;</span><span class="n">bnad</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">bna_num_txq_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">bna</span> <span class="o">*</span><span class="n">bna</span><span class="p">,</span> <span class="kt">int</span> <span class="n">num_txq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bna</span><span class="o">-&gt;</span><span class="n">ioceth</span><span class="p">.</span><span class="n">attr</span><span class="p">.</span><span class="n">fw_query_complete</span> <span class="o">&amp;&amp;</span>
		<span class="p">(</span><span class="n">num_txq</span> <span class="o">&lt;=</span> <span class="n">bna</span><span class="o">-&gt;</span><span class="n">ioceth</span><span class="p">.</span><span class="n">attr</span><span class="p">.</span><span class="n">num_txq</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">bna</span><span class="o">-&gt;</span><span class="n">ioceth</span><span class="p">.</span><span class="n">attr</span><span class="p">.</span><span class="n">num_txq</span> <span class="o">=</span> <span class="n">num_txq</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">BNA_CB_SUCCESS</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">BNA_CB_FAIL</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">bna_num_rxp_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">bna</span> <span class="o">*</span><span class="n">bna</span><span class="p">,</span> <span class="kt">int</span> <span class="n">num_rxp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bna</span><span class="o">-&gt;</span><span class="n">ioceth</span><span class="p">.</span><span class="n">attr</span><span class="p">.</span><span class="n">fw_query_complete</span> <span class="o">&amp;&amp;</span>
		<span class="p">(</span><span class="n">num_rxp</span> <span class="o">&lt;=</span> <span class="n">bna</span><span class="o">-&gt;</span><span class="n">ioceth</span><span class="p">.</span><span class="n">attr</span><span class="p">.</span><span class="n">num_rxp</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">bna</span><span class="o">-&gt;</span><span class="n">ioceth</span><span class="p">.</span><span class="n">attr</span><span class="p">.</span><span class="n">num_rxp</span> <span class="o">=</span> <span class="n">num_rxp</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">BNA_CB_SUCCESS</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">BNA_CB_FAIL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">bna_mac</span> <span class="o">*</span>
<span class="nf">bna_ucam_mod_mac_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">bna_ucam_mod</span> <span class="o">*</span><span class="n">ucam_mod</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">qe</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ucam_mod</span><span class="o">-&gt;</span><span class="n">free_q</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">bfa_q_deq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ucam_mod</span><span class="o">-&gt;</span><span class="n">free_q</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qe</span><span class="p">);</span>

	<span class="k">return</span> <span class="p">(</span><span class="k">struct</span> <span class="n">bna_mac</span> <span class="o">*</span><span class="p">)</span><span class="n">qe</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">bna_ucam_mod_mac_put</span><span class="p">(</span><span class="k">struct</span> <span class="n">bna_ucam_mod</span> <span class="o">*</span><span class="n">ucam_mod</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bna_mac</span> <span class="o">*</span><span class="n">mac</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">qe</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ucam_mod</span><span class="o">-&gt;</span><span class="n">free_q</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">bna_mac</span> <span class="o">*</span>
<span class="nf">bna_mcam_mod_mac_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">bna_mcam_mod</span> <span class="o">*</span><span class="n">mcam_mod</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">qe</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mcam_mod</span><span class="o">-&gt;</span><span class="n">free_q</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">bfa_q_deq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mcam_mod</span><span class="o">-&gt;</span><span class="n">free_q</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qe</span><span class="p">);</span>

	<span class="k">return</span> <span class="p">(</span><span class="k">struct</span> <span class="n">bna_mac</span> <span class="o">*</span><span class="p">)</span><span class="n">qe</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">bna_mcam_mod_mac_put</span><span class="p">(</span><span class="k">struct</span> <span class="n">bna_mcam_mod</span> <span class="o">*</span><span class="n">mcam_mod</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bna_mac</span> <span class="o">*</span><span class="n">mac</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">qe</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mcam_mod</span><span class="o">-&gt;</span><span class="n">free_q</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">bna_mcam_handle</span> <span class="o">*</span>
<span class="nf">bna_mcam_mod_handle_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">bna_mcam_mod</span> <span class="o">*</span><span class="n">mcam_mod</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">qe</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mcam_mod</span><span class="o">-&gt;</span><span class="n">free_handle_q</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">bfa_q_deq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mcam_mod</span><span class="o">-&gt;</span><span class="n">free_handle_q</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qe</span><span class="p">);</span>

	<span class="k">return</span> <span class="p">(</span><span class="k">struct</span> <span class="n">bna_mcam_handle</span> <span class="o">*</span><span class="p">)</span><span class="n">qe</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">bna_mcam_mod_handle_put</span><span class="p">(</span><span class="k">struct</span> <span class="n">bna_mcam_mod</span> <span class="o">*</span><span class="n">mcam_mod</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">bna_mcam_handle</span> <span class="o">*</span><span class="n">handle</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">handle</span><span class="o">-&gt;</span><span class="n">qe</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mcam_mod</span><span class="o">-&gt;</span><span class="n">free_handle_q</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">bna_hw_stats_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">bna</span> <span class="o">*</span><span class="n">bna</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bna</span><span class="o">-&gt;</span><span class="n">stats_mod</span><span class="p">.</span><span class="n">ioc_ready</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bnad_cb_stats_get</span><span class="p">(</span><span class="n">bna</span><span class="o">-&gt;</span><span class="n">bnad</span><span class="p">,</span> <span class="n">BNA_CB_FAIL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bna</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bna</span><span class="o">-&gt;</span><span class="n">stats_mod</span><span class="p">.</span><span class="n">stats_get_busy</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bnad_cb_stats_get</span><span class="p">(</span><span class="n">bna</span><span class="o">-&gt;</span><span class="n">bnad</span><span class="p">,</span> <span class="n">BNA_CB_BUSY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bna</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">bna_bfi_stats_get</span><span class="p">(</span><span class="n">bna</span><span class="p">);</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:5}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../../javascript/docco.min.js"></script>
</html>
