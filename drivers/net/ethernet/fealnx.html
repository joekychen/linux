<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › ethernet › fealnx.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>fealnx.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm">	Written 1998-2000 by Donald Becker.</span>

<span class="cm">	This software may be used and distributed according to the terms of</span>
<span class="cm">	the GNU General Public License (GPL), incorporated herein by reference.</span>
<span class="cm">	Drivers based on or derived from this code fall under the GPL and must</span>
<span class="cm">	retain the authorship, copyright and license notice.  This file is not</span>
<span class="cm">	a complete program and may only be used when the entire operating</span>
<span class="cm">	system is licensed under the GPL.</span>

<span class="cm">	The author may be reached as becker@scyld.com, or C/O</span>
<span class="cm">	Scyld Computing Corporation</span>
<span class="cm">	410 Severn Ave., Suite 210</span>
<span class="cm">	Annapolis MD 21403</span>

<span class="cm">	Support information and updates available at</span>
<span class="cm">	http://www.scyld.com/network/pci-skeleton.html</span>

<span class="cm">	Linux kernel updates:</span>

<span class="cm">	Version 2.51, Nov 17, 2001 (jgarzik):</span>
<span class="cm">	- Add ethtool support</span>
<span class="cm">	- Replace some MII-related magic numbers with constants</span>

<span class="cm">*/</span>

<span class="cp">#define DRV_NAME	&quot;fealnx&quot;</span>
<span class="cp">#define DRV_VERSION	&quot;2.52&quot;</span>
<span class="cp">#define DRV_RELDATE	&quot;Sep-11-2006&quot;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">debug</span><span class="p">;</span>		<span class="cm">/* 1-&gt; print debug message */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">max_interrupt_work</span> <span class="o">=</span> <span class="mi">20</span><span class="p">;</span>

<span class="cm">/* Maximum number of multicast addresses to filter (vs. Rx-all-multicast). */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">multicast_filter_limit</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>

<span class="cm">/* Set the copy breakpoint for the copy-only-tiny-frames scheme. */</span>
<span class="cm">/* Setting to &gt; 1518 effectively disables this feature.          */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">rx_copybreak</span><span class="p">;</span>

<span class="cm">/* Used to pass the media type, etc.                            */</span>
<span class="cm">/* Both &#39;options[]&#39; and &#39;full_duplex[]&#39; should exist for driver */</span>
<span class="cm">/* interoperability.                                            */</span>
<span class="cm">/* The media type is usually passed in &#39;options[]&#39;.             */</span>
<span class="cp">#define MAX_UNITS 8		</span><span class="cm">/* More are supported, limit only on options */</span><span class="cp"></span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">options</span><span class="p">[</span><span class="n">MAX_UNITS</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span> <span class="p">};</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">full_duplex</span><span class="p">[</span><span class="n">MAX_UNITS</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span> <span class="p">};</span>

<span class="cm">/* Operational parameters that are set at compile time.                 */</span>
<span class="cm">/* Keep the ring sizes a power of two for compile efficiency.           */</span>
<span class="cm">/* The compiler will convert &lt;unsigned&gt;&#39;%&#39;&lt;2^N&gt; into a bit mask.        */</span>
<span class="cm">/* Making the Tx ring too large decreases the effectiveness of channel  */</span>
<span class="cm">/* bonding and packet priority.                                         */</span>
<span class="cm">/* There are no ill effects from too-large receive rings.               */</span></pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><p>88-12-9 modify,</p>

<h1>define TX<em>RING</em>SIZE    16</h1>

<h1>define RX<em>RING</em>SIZE    32</h1></td><td class="code"><div class="highlight"><pre><span class="cp">#define TX_RING_SIZE    6</span>
<span class="cp">#define RX_RING_SIZE    12</span>
<span class="cp">#define TX_TOTAL_SIZE	TX_RING_SIZE*sizeof(struct fealnx_desc)</span>
<span class="cp">#define RX_TOTAL_SIZE	RX_RING_SIZE*sizeof(struct fealnx_desc)</span>

<span class="cm">/* Operational parameters that usually are not changed. */</span>
<span class="cm">/* Time in jiffies before concluding the transmitter is hung. */</span>
<span class="cp">#define TX_TIMEOUT      (2*HZ)</span>

<span class="cp">#define PKT_BUF_SZ      1536	</span><span class="cm">/* Size of each temporary Rx buffer. */</span><span class="cp"></span>


<span class="cm">/* Include files, designed to support most kernel versions 2.0.0 and later. */</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/timer.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/ioport.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/netdevice.h&gt;</span>
<span class="cp">#include &lt;linux/etherdevice.h&gt;</span>
<span class="cp">#include &lt;linux/skbuff.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/mii.h&gt;</span>
<span class="cp">#include &lt;linux/ethtool.h&gt;</span>
<span class="cp">#include &lt;linux/crc32.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/bitops.h&gt;</span>

<span class="cp">#include &lt;asm/processor.h&gt;	</span><span class="cm">/* Processor type for cache alignment. */</span><span class="cp"></span>
<span class="cp">#include &lt;asm/io.h&gt;</span>
<span class="cp">#include &lt;asm/uaccess.h&gt;</span>
<span class="cp">#include &lt;asm/byteorder.h&gt;</span>

<span class="cm">/* These identify the driver base version and may not be removed. */</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">version</span><span class="p">[]</span> <span class="n">__devinitconst</span> <span class="o">=</span>
	<span class="n">KERN_INFO</span> <span class="n">DRV_NAME</span> <span class="s">&quot;.c:v&quot;</span> <span class="n">DRV_VERSION</span> <span class="s">&quot; &quot;</span> <span class="n">DRV_RELDATE</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>


<span class="cm">/* This driver was written to use PCI memory space, however some x86 systems</span>
<span class="cm">   work only with I/O space accesses. */</span>
<span class="cp">#ifndef __alpha__</span>
<span class="cp">#define USE_IO_OPS</span>
<span class="cp">#endif</span>

<span class="cm">/* Kernel compatibility defines, some common to David Hinds&#39; PCMCIA package. */</span>
<span class="cm">/* This is only in the support-all-kernels source code. */</span>

<span class="cp">#define RUN_AT(x) (jiffies + (x))</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Myson or whoever&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Myson MTD-8xx 100/10M Ethernet PCI Adapter Driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">max_interrupt_work</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">rx_copybreak</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">multicast_filter_limit</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">options</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">full_duplex</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">max_interrupt_work</span><span class="p">,</span> <span class="s">&quot;fealnx maximum events handled per interrupt&quot;</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="s">&quot;fealnx enable debugging (0-1)&quot;</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">rx_copybreak</span><span class="p">,</span> <span class="s">&quot;fealnx copy breakpoint for copy-only-tiny-frames&quot;</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">multicast_filter_limit</span><span class="p">,</span> <span class="s">&quot;fealnx maximum number of filtered multicast addresses&quot;</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">options</span><span class="p">,</span> <span class="s">&quot;fealnx: Bits 0-3: media type, bit 17: full duplex&quot;</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">full_duplex</span><span class="p">,</span> <span class="s">&quot;fealnx full duplex setting(s) (1)&quot;</span><span class="p">);</span>

<span class="k">enum</span> <span class="p">{</span>
	<span class="n">MIN_REGION_SIZE</span>		<span class="o">=</span> <span class="mi">136</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* A chip capabilities table, matching the entries in pci_tbl[] above. */</span>
<span class="k">enum</span> <span class="n">chip_capability_flags</span> <span class="p">{</span>
	<span class="n">HAS_MII_XCVR</span><span class="p">,</span>
	<span class="n">HAS_CHIP_XCVR</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* 89/6/13 add, */</span>
<span class="cm">/* for different PHY */</span>
<span class="k">enum</span> <span class="n">phy_type_flags</span> <span class="p">{</span>
	<span class="n">MysonPHY</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="n">AhdocPHY</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
	<span class="n">SeeqPHY</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
	<span class="n">MarvellPHY</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
	<span class="n">Myson981</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
	<span class="n">LevelOnePHY</span> <span class="o">=</span> <span class="mi">6</span><span class="p">,</span>
	<span class="n">OtherPHY</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">chip_info</span> <span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">chip_name</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">flags</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">chip_info</span> <span class="n">skel_netdrv_tbl</span><span class="p">[]</span> <span class="n">__devinitdata</span> <span class="o">=</span> <span class="p">{</span>
 	<span class="p">{</span> <span class="s">&quot;100/10M Ethernet PCI Adapter&quot;</span><span class="p">,</span>	<span class="n">HAS_MII_XCVR</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;100/10M Ethernet PCI Adapter&quot;</span><span class="p">,</span>	<span class="n">HAS_CHIP_XCVR</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;1000/100/10M Ethernet PCI Adapter&quot;</span><span class="p">,</span>	<span class="n">HAS_MII_XCVR</span> <span class="p">},</span>
<span class="p">};</span>

<span class="cm">/* Offsets to the Command and Status Registers. */</span>
<span class="k">enum</span> <span class="n">fealnx_offsets</span> <span class="p">{</span>
	<span class="n">PAR0</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span>		<span class="cm">/* physical address 0-3 */</span>
	<span class="n">PAR1</span> <span class="o">=</span> <span class="mh">0x04</span><span class="p">,</span>		<span class="cm">/* physical address 4-5 */</span>
	<span class="n">MAR0</span> <span class="o">=</span> <span class="mh">0x08</span><span class="p">,</span>		<span class="cm">/* multicast address 0-3 */</span>
	<span class="n">MAR1</span> <span class="o">=</span> <span class="mh">0x0C</span><span class="p">,</span>		<span class="cm">/* multicast address 4-7 */</span>
	<span class="n">FAR0</span> <span class="o">=</span> <span class="mh">0x10</span><span class="p">,</span>		<span class="cm">/* flow-control address 0-3 */</span>
	<span class="n">FAR1</span> <span class="o">=</span> <span class="mh">0x14</span><span class="p">,</span>		<span class="cm">/* flow-control address 4-5 */</span>
	<span class="n">TCRRCR</span> <span class="o">=</span> <span class="mh">0x18</span><span class="p">,</span>		<span class="cm">/* receive &amp; transmit configuration */</span>
	<span class="n">BCR</span> <span class="o">=</span> <span class="mh">0x1C</span><span class="p">,</span>		<span class="cm">/* bus command */</span>
	<span class="n">TXPDR</span> <span class="o">=</span> <span class="mh">0x20</span><span class="p">,</span>		<span class="cm">/* transmit polling demand */</span>
	<span class="n">RXPDR</span> <span class="o">=</span> <span class="mh">0x24</span><span class="p">,</span>		<span class="cm">/* receive polling demand */</span>
	<span class="n">RXCWP</span> <span class="o">=</span> <span class="mh">0x28</span><span class="p">,</span>		<span class="cm">/* receive current word pointer */</span>
	<span class="n">TXLBA</span> <span class="o">=</span> <span class="mh">0x2C</span><span class="p">,</span>		<span class="cm">/* transmit list base address */</span>
	<span class="n">RXLBA</span> <span class="o">=</span> <span class="mh">0x30</span><span class="p">,</span>		<span class="cm">/* receive list base address */</span>
	<span class="n">ISR</span> <span class="o">=</span> <span class="mh">0x34</span><span class="p">,</span>		<span class="cm">/* interrupt status */</span>
	<span class="n">IMR</span> <span class="o">=</span> <span class="mh">0x38</span><span class="p">,</span>		<span class="cm">/* interrupt mask */</span>
	<span class="n">FTH</span> <span class="o">=</span> <span class="mh">0x3C</span><span class="p">,</span>		<span class="cm">/* flow control high/low threshold */</span>
	<span class="n">MANAGEMENT</span> <span class="o">=</span> <span class="mh">0x40</span><span class="p">,</span>	<span class="cm">/* bootrom/eeprom and mii management */</span>
	<span class="n">TALLY</span> <span class="o">=</span> <span class="mh">0x44</span><span class="p">,</span>		<span class="cm">/* tally counters for crc and mpa */</span>
	<span class="n">TSR</span> <span class="o">=</span> <span class="mh">0x48</span><span class="p">,</span>		<span class="cm">/* tally counter for transmit status */</span>
	<span class="n">BMCRSR</span> <span class="o">=</span> <span class="mh">0x4c</span><span class="p">,</span>		<span class="cm">/* basic mode control and status */</span>
	<span class="n">PHYIDENTIFIER</span> <span class="o">=</span> <span class="mh">0x50</span><span class="p">,</span>	<span class="cm">/* phy identifier */</span>
	<span class="n">ANARANLPAR</span> <span class="o">=</span> <span class="mh">0x54</span><span class="p">,</span>	<span class="cm">/* auto-negotiation advertisement and link</span>
<span class="cm">				   partner ability */</span>
	<span class="n">ANEROCR</span> <span class="o">=</span> <span class="mh">0x58</span><span class="p">,</span>		<span class="cm">/* auto-negotiation expansion and pci conf. */</span>
	<span class="n">BPREMRPSR</span> <span class="o">=</span> <span class="mh">0x5c</span><span class="p">,</span>	<span class="cm">/* bypass &amp; receive error mask and phy status */</span>
<span class="p">};</span>

<span class="cm">/* Bits in the interrupt status/enable registers. */</span>
<span class="cm">/* The bits in the Intr Status/Enable registers, mostly interrupt sources. */</span>
<span class="k">enum</span> <span class="n">intr_status_bits</span> <span class="p">{</span>
	<span class="n">RFCON</span> <span class="o">=</span> <span class="mh">0x00020000</span><span class="p">,</span>	<span class="cm">/* receive flow control xon packet */</span>
	<span class="n">RFCOFF</span> <span class="o">=</span> <span class="mh">0x00010000</span><span class="p">,</span>	<span class="cm">/* receive flow control xoff packet */</span>
	<span class="n">LSCStatus</span> <span class="o">=</span> <span class="mh">0x00008000</span><span class="p">,</span>	<span class="cm">/* link status change */</span>
	<span class="n">ANCStatus</span> <span class="o">=</span> <span class="mh">0x00004000</span><span class="p">,</span>	<span class="cm">/* autonegotiation completed */</span>
	<span class="n">FBE</span> <span class="o">=</span> <span class="mh">0x00002000</span><span class="p">,</span>	<span class="cm">/* fatal bus error */</span>
	<span class="n">FBEMask</span> <span class="o">=</span> <span class="mh">0x00001800</span><span class="p">,</span>	<span class="cm">/* mask bit12-11 */</span>
	<span class="n">ParityErr</span> <span class="o">=</span> <span class="mh">0x00000000</span><span class="p">,</span>	<span class="cm">/* parity error */</span>
	<span class="n">TargetErr</span> <span class="o">=</span> <span class="mh">0x00001000</span><span class="p">,</span>	<span class="cm">/* target abort */</span>
	<span class="n">MasterErr</span> <span class="o">=</span> <span class="mh">0x00000800</span><span class="p">,</span>	<span class="cm">/* master error */</span>
	<span class="n">TUNF</span> <span class="o">=</span> <span class="mh">0x00000400</span><span class="p">,</span>	<span class="cm">/* transmit underflow */</span>
	<span class="n">ROVF</span> <span class="o">=</span> <span class="mh">0x00000200</span><span class="p">,</span>	<span class="cm">/* receive overflow */</span>
	<span class="n">ETI</span> <span class="o">=</span> <span class="mh">0x00000100</span><span class="p">,</span>	<span class="cm">/* transmit early int */</span>
	<span class="n">ERI</span> <span class="o">=</span> <span class="mh">0x00000080</span><span class="p">,</span>	<span class="cm">/* receive early int */</span>
	<span class="n">CNTOVF</span> <span class="o">=</span> <span class="mh">0x00000040</span><span class="p">,</span>	<span class="cm">/* counter overflow */</span>
	<span class="n">RBU</span> <span class="o">=</span> <span class="mh">0x00000020</span><span class="p">,</span>	<span class="cm">/* receive buffer unavailable */</span>
	<span class="n">TBU</span> <span class="o">=</span> <span class="mh">0x00000010</span><span class="p">,</span>	<span class="cm">/* transmit buffer unavilable */</span>
	<span class="n">TI</span> <span class="o">=</span> <span class="mh">0x00000008</span><span class="p">,</span>	<span class="cm">/* transmit interrupt */</span>
	<span class="n">RI</span> <span class="o">=</span> <span class="mh">0x00000004</span><span class="p">,</span>	<span class="cm">/* receive interrupt */</span>
	<span class="n">RxErr</span> <span class="o">=</span> <span class="mh">0x00000002</span><span class="p">,</span>	<span class="cm">/* receive error */</span>
<span class="p">};</span>

<span class="cm">/* Bits in the NetworkConfig register, W for writing, R for reading */</span>
<span class="cm">/* FIXME: some names are invented by me. Marked with (name?) */</span>
<span class="cm">/* If you have docs and know bit names, please fix &#39;em */</span>
<span class="k">enum</span> <span class="n">rx_mode_bits</span> <span class="p">{</span>
	<span class="n">CR_W_ENH</span>	<span class="o">=</span> <span class="mh">0x02000000</span><span class="p">,</span>	<span class="cm">/* enhanced mode (name?) */</span>
	<span class="n">CR_W_FD</span>		<span class="o">=</span> <span class="mh">0x00100000</span><span class="p">,</span>	<span class="cm">/* full duplex */</span>
	<span class="n">CR_W_PS10</span>	<span class="o">=</span> <span class="mh">0x00080000</span><span class="p">,</span>	<span class="cm">/* 10 mbit */</span>
	<span class="n">CR_W_TXEN</span>	<span class="o">=</span> <span class="mh">0x00040000</span><span class="p">,</span>	<span class="cm">/* tx enable (name?) */</span>
	<span class="n">CR_W_PS1000</span>	<span class="o">=</span> <span class="mh">0x00010000</span><span class="p">,</span>	<span class="cm">/* 1000 mbit */</span>
     <span class="cm">/* CR_W_RXBURSTMASK= 0x00000e00, Im unsure about this */</span>
	<span class="n">CR_W_RXMODEMASK</span>	<span class="o">=</span> <span class="mh">0x000000e0</span><span class="p">,</span>
	<span class="n">CR_W_PROM</span>	<span class="o">=</span> <span class="mh">0x00000080</span><span class="p">,</span>	<span class="cm">/* promiscuous mode */</span>
	<span class="n">CR_W_AB</span>		<span class="o">=</span> <span class="mh">0x00000040</span><span class="p">,</span>	<span class="cm">/* accept broadcast */</span>
	<span class="n">CR_W_AM</span>		<span class="o">=</span> <span class="mh">0x00000020</span><span class="p">,</span>	<span class="cm">/* accept mutlicast */</span>
	<span class="n">CR_W_ARP</span>	<span class="o">=</span> <span class="mh">0x00000008</span><span class="p">,</span>	<span class="cm">/* receive runt pkt */</span>
	<span class="n">CR_W_ALP</span>	<span class="o">=</span> <span class="mh">0x00000004</span><span class="p">,</span>	<span class="cm">/* receive long pkt */</span>
	<span class="n">CR_W_SEP</span>	<span class="o">=</span> <span class="mh">0x00000002</span><span class="p">,</span>	<span class="cm">/* receive error pkt */</span>
	<span class="n">CR_W_RXEN</span>	<span class="o">=</span> <span class="mh">0x00000001</span><span class="p">,</span>	<span class="cm">/* rx enable (unicast?) (name?) */</span>

	<span class="n">CR_R_TXSTOP</span>	<span class="o">=</span> <span class="mh">0x04000000</span><span class="p">,</span>	<span class="cm">/* tx stopped (name?) */</span>
	<span class="n">CR_R_FD</span>		<span class="o">=</span> <span class="mh">0x00100000</span><span class="p">,</span>	<span class="cm">/* full duplex detected */</span>
	<span class="n">CR_R_PS10</span>	<span class="o">=</span> <span class="mh">0x00080000</span><span class="p">,</span>	<span class="cm">/* 10 mbit detected */</span>
	<span class="n">CR_R_RXSTOP</span>	<span class="o">=</span> <span class="mh">0x00008000</span><span class="p">,</span>	<span class="cm">/* rx stopped (name?) */</span>
<span class="p">};</span>

<span class="cm">/* The Tulip Rx and Tx buffer descriptors. */</span>
<span class="k">struct</span> <span class="n">fealnx_desc</span> <span class="p">{</span>
	<span class="n">s32</span> <span class="n">status</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">control</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">buffer</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">next_desc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fealnx_desc</span> <span class="o">*</span><span class="n">next_desc_logical</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skbuff</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">reserved1</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">reserved2</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/* Bits in network_desc.status */</span>
<span class="k">enum</span> <span class="n">rx_desc_status_bits</span> <span class="p">{</span>
	<span class="n">RXOWN</span> <span class="o">=</span> <span class="mh">0x80000000</span><span class="p">,</span>	<span class="cm">/* own bit */</span>
	<span class="n">FLNGMASK</span> <span class="o">=</span> <span class="mh">0x0fff0000</span><span class="p">,</span>	<span class="cm">/* frame length */</span>
	<span class="n">FLNGShift</span> <span class="o">=</span> <span class="mi">16</span><span class="p">,</span>
	<span class="n">MARSTATUS</span> <span class="o">=</span> <span class="mh">0x00004000</span><span class="p">,</span>	<span class="cm">/* multicast address received */</span>
	<span class="n">BARSTATUS</span> <span class="o">=</span> <span class="mh">0x00002000</span><span class="p">,</span>	<span class="cm">/* broadcast address received */</span>
	<span class="n">PHYSTATUS</span> <span class="o">=</span> <span class="mh">0x00001000</span><span class="p">,</span>	<span class="cm">/* physical address received */</span>
	<span class="n">RXFSD</span> <span class="o">=</span> <span class="mh">0x00000800</span><span class="p">,</span>	<span class="cm">/* first descriptor */</span>
	<span class="n">RXLSD</span> <span class="o">=</span> <span class="mh">0x00000400</span><span class="p">,</span>	<span class="cm">/* last descriptor */</span>
	<span class="n">ErrorSummary</span> <span class="o">=</span> <span class="mh">0x80</span><span class="p">,</span>	<span class="cm">/* error summary */</span>
	<span class="n">RUNT</span> <span class="o">=</span> <span class="mh">0x40</span><span class="p">,</span>		<span class="cm">/* runt packet received */</span>
	<span class="n">LONG</span> <span class="o">=</span> <span class="mh">0x20</span><span class="p">,</span>		<span class="cm">/* long packet received */</span>
	<span class="n">FAE</span> <span class="o">=</span> <span class="mh">0x10</span><span class="p">,</span>		<span class="cm">/* frame align error */</span>
	<span class="n">CRC</span> <span class="o">=</span> <span class="mh">0x08</span><span class="p">,</span>		<span class="cm">/* crc error */</span>
	<span class="n">RXER</span> <span class="o">=</span> <span class="mh">0x04</span><span class="p">,</span>		<span class="cm">/* receive error */</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="n">rx_desc_control_bits</span> <span class="p">{</span>
	<span class="n">RXIC</span> <span class="o">=</span> <span class="mh">0x00800000</span><span class="p">,</span>	<span class="cm">/* interrupt control */</span>
	<span class="n">RBSShift</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="n">tx_desc_status_bits</span> <span class="p">{</span>
	<span class="n">TXOWN</span> <span class="o">=</span> <span class="mh">0x80000000</span><span class="p">,</span>	<span class="cm">/* own bit */</span>
	<span class="n">JABTO</span> <span class="o">=</span> <span class="mh">0x00004000</span><span class="p">,</span>	<span class="cm">/* jabber timeout */</span>
	<span class="n">CSL</span> <span class="o">=</span> <span class="mh">0x00002000</span><span class="p">,</span>	<span class="cm">/* carrier sense lost */</span>
	<span class="n">LC</span> <span class="o">=</span> <span class="mh">0x00001000</span><span class="p">,</span>	<span class="cm">/* late collision */</span>
	<span class="n">EC</span> <span class="o">=</span> <span class="mh">0x00000800</span><span class="p">,</span>	<span class="cm">/* excessive collision */</span>
	<span class="n">UDF</span> <span class="o">=</span> <span class="mh">0x00000400</span><span class="p">,</span>	<span class="cm">/* fifo underflow */</span>
	<span class="n">DFR</span> <span class="o">=</span> <span class="mh">0x00000200</span><span class="p">,</span>	<span class="cm">/* deferred */</span>
	<span class="n">HF</span> <span class="o">=</span> <span class="mh">0x00000100</span><span class="p">,</span>	<span class="cm">/* heartbeat fail */</span>
	<span class="n">NCRMask</span> <span class="o">=</span> <span class="mh">0x000000ff</span><span class="p">,</span>	<span class="cm">/* collision retry count */</span>
	<span class="n">NCRShift</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="n">tx_desc_control_bits</span> <span class="p">{</span>
	<span class="n">TXIC</span> <span class="o">=</span> <span class="mh">0x80000000</span><span class="p">,</span>	<span class="cm">/* interrupt control */</span>
	<span class="n">ETIControl</span> <span class="o">=</span> <span class="mh">0x40000000</span><span class="p">,</span>	<span class="cm">/* early transmit interrupt */</span>
	<span class="n">TXLD</span> <span class="o">=</span> <span class="mh">0x20000000</span><span class="p">,</span>	<span class="cm">/* last descriptor */</span>
	<span class="n">TXFD</span> <span class="o">=</span> <span class="mh">0x10000000</span><span class="p">,</span>	<span class="cm">/* first descriptor */</span>
	<span class="n">CRCEnable</span> <span class="o">=</span> <span class="mh">0x08000000</span><span class="p">,</span>	<span class="cm">/* crc control */</span>
	<span class="n">PADEnable</span> <span class="o">=</span> <span class="mh">0x04000000</span><span class="p">,</span>	<span class="cm">/* padding control */</span>
	<span class="n">RetryTxLC</span> <span class="o">=</span> <span class="mh">0x02000000</span><span class="p">,</span>	<span class="cm">/* retry late collision */</span>
	<span class="n">PKTSMask</span> <span class="o">=</span> <span class="mh">0x3ff800</span><span class="p">,</span>	<span class="cm">/* packet size bit21-11 */</span>
	<span class="n">PKTSShift</span> <span class="o">=</span> <span class="mi">11</span><span class="p">,</span>
	<span class="n">TBSMask</span> <span class="o">=</span> <span class="mh">0x000007ff</span><span class="p">,</span>	<span class="cm">/* transmit buffer bit 10-0 */</span>
	<span class="n">TBSShift</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* BootROM/EEPROM/MII Management Register */</span>
<span class="cp">#define MASK_MIIR_MII_READ       0x00000000</span>
<span class="cp">#define MASK_MIIR_MII_WRITE      0x00000008</span>
<span class="cp">#define MASK_MIIR_MII_MDO        0x00000004</span>
<span class="cp">#define MASK_MIIR_MII_MDI        0x00000002</span>
<span class="cp">#define MASK_MIIR_MII_MDC        0x00000001</span>

<span class="cm">/* ST+OP+PHYAD+REGAD+TA */</span>
<span class="cp">#define OP_READ             0x6000	</span><span class="cm">/* ST:01+OP:10+PHYAD+REGAD+TA:Z0 */</span><span class="cp"></span>
<span class="cp">#define OP_WRITE            0x5002	</span><span class="cm">/* ST:01+OP:01+PHYAD+REGAD+TA:10 */</span><span class="cp"></span>

<span class="cm">/* ------------------------------------------------------------------------- */</span>
<span class="cm">/*      Constants for Myson PHY                                              */</span>
<span class="cm">/* ------------------------------------------------------------------------- */</span>
<span class="cp">#define MysonPHYID      0xd0000302</span>
<span class="cm">/* 89-7-27 add, (begin) */</span>
<span class="cp">#define MysonPHYID0     0x0302</span>
<span class="cp">#define StatusRegister  18</span>
<span class="cp">#define SPEED100        0x0400	</span><span class="c1">// bit10</span>
<span class="cp">#define FULLMODE        0x0800	</span><span class="c1">// bit11</span>
<span class="cm">/* 89-7-27 add, (end) */</span>

<span class="cm">/* ------------------------------------------------------------------------- */</span>
<span class="cm">/*      Constants for Seeq 80225 PHY                                         */</span>
<span class="cm">/* ------------------------------------------------------------------------- */</span>
<span class="cp">#define SeeqPHYID0      0x0016</span>

<span class="cp">#define MIIRegister18   18</span>
<span class="cp">#define SPD_DET_100     0x80</span>
<span class="cp">#define DPLX_DET_FULL   0x40</span>

<span class="cm">/* ------------------------------------------------------------------------- */</span>
<span class="cm">/*      Constants for Ahdoc 101 PHY                                          */</span>
<span class="cm">/* ------------------------------------------------------------------------- */</span>
<span class="cp">#define AhdocPHYID0     0x0022</span>

<span class="cp">#define DiagnosticReg   18</span>
<span class="cp">#define DPLX_FULL       0x0800</span>
<span class="cp">#define Speed_100       0x0400</span>

<span class="cm">/* 89/6/13 add, */</span>
<span class="cm">/* -------------------------------------------------------------------------- */</span>
<span class="cm">/*      Constants                                                             */</span>
<span class="cm">/* -------------------------------------------------------------------------- */</span>
<span class="cp">#define MarvellPHYID0           0x0141</span>
<span class="cp">#define LevelOnePHYID0		0x0013</span>

<span class="cp">#define MII1000BaseTControlReg  9</span>
<span class="cp">#define MII1000BaseTStatusReg   10</span>
<span class="cp">#define SpecificReg		17</span>

<span class="cm">/* for 1000BaseT Control Register */</span>
<span class="cp">#define PHYAbletoPerform1000FullDuplex  0x0200</span>
<span class="cp">#define PHYAbletoPerform1000HalfDuplex  0x0100</span>
<span class="cp">#define PHY1000AbilityMask              0x300</span></pre></div></td></tr>


<tr id="section-3"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-3">&#182;</a></div><p>for phy specific status register, marvell phy.</p></td><td class="code"><div class="highlight"><pre><span class="cp">#define SpeedMask       0x0c000</span>
<span class="cp">#define Speed_1000M     0x08000</span>
<span class="cp">#define Speed_100M      0x4000</span>
<span class="cp">#define Speed_10M       0</span>
<span class="cp">#define Full_Duplex     0x2000</span></pre></div></td></tr>


<tr id="section-4"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-4">&#182;</a></div><p>89/12/29 add, for phy specific status register, levelone phy, (begin)</p></td><td class="code"><div class="highlight"><pre><span class="cp">#define LXT1000_100M    0x08000</span>
<span class="cp">#define LXT1000_1000M   0x0c000</span>
<span class="cp">#define LXT1000_Full    0x200</span></pre></div></td></tr>


<tr id="section-5"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-5">&#182;</a></div><p>89/12/29 add, for phy specific status register, levelone phy, (end)</p></td><td class="code"><div class="highlight"><pre><span class="cm">/* for 3-in-1 case, BMCRSR register */</span>
<span class="cp">#define LinkIsUp2	0x00040000</span>

<span class="cm">/* for PHY */</span>
<span class="cp">#define LinkIsUp        0x0004</span>


<span class="k">struct</span> <span class="n">netdev_private</span> <span class="p">{</span>
	<span class="cm">/* Descriptor rings first for alignment. */</span>
	<span class="k">struct</span> <span class="n">fealnx_desc</span> <span class="o">*</span><span class="n">rx_ring</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fealnx_desc</span> <span class="o">*</span><span class="n">tx_ring</span><span class="p">;</span>

	<span class="n">dma_addr_t</span> <span class="n">rx_ring_dma</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">tx_ring_dma</span><span class="p">;</span>

	<span class="n">spinlock_t</span> <span class="n">lock</span><span class="p">;</span>

	<span class="cm">/* Media monitoring timer. */</span>
	<span class="k">struct</span> <span class="n">timer_list</span> <span class="n">timer</span><span class="p">;</span>

	<span class="cm">/* Reset timer */</span>
	<span class="k">struct</span> <span class="n">timer_list</span> <span class="n">reset_timer</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">reset_timer_armed</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">crvalue_sv</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">imrvalue_sv</span><span class="p">;</span>

	<span class="cm">/* Frequently used values: keep some adjacent for cache effect. */</span>
	<span class="kt">int</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pci_dev</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">crvalue</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">bcrvalue</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">imrvalue</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fealnx_desc</span> <span class="o">*</span><span class="n">cur_rx</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fealnx_desc</span> <span class="o">*</span><span class="n">lack_rxbuf</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">really_rx_count</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fealnx_desc</span> <span class="o">*</span><span class="n">cur_tx</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fealnx_desc</span> <span class="o">*</span><span class="n">cur_tx_copy</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">really_tx_count</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">free_tx_count</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">rx_buf_sz</span><span class="p">;</span>	<span class="cm">/* Based on MTU+slack. */</span>

	<span class="cm">/* These values are keep track of the transceiver/media in use. */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">linkok</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">line_speed</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">duplexmode</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">default_port</span><span class="o">:</span><span class="mi">4</span><span class="p">;</span>	<span class="cm">/* Last dev-&gt;if_port value. */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">PHYType</span><span class="p">;</span>

	<span class="cm">/* MII transceiver section. */</span>
	<span class="kt">int</span> <span class="n">mii_cnt</span><span class="p">;</span>		<span class="cm">/* MII device addresses. */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">phys</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>	<span class="cm">/* MII device addresses. */</span>
	<span class="k">struct</span> <span class="n">mii_if_info</span> <span class="n">mii</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">mem</span><span class="p">;</span>
<span class="p">};</span>


<span class="k">static</span> <span class="kt">int</span> <span class="n">mdio_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">phy_id</span><span class="p">,</span> <span class="kt">int</span> <span class="n">location</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">mdio_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">phy_id</span><span class="p">,</span> <span class="kt">int</span> <span class="n">location</span><span class="p">,</span> <span class="kt">int</span> <span class="n">value</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">netdev_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">getlinktype</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">getlinkstatus</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">netdev_timer</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">reset_timer</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">fealnx_tx_timeout</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">init_ring</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="n">netdev_tx_t</span> <span class="n">start_tx</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="n">intr_handler</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_instance</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">netdev_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">set_rx_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__set_rx_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">net_device_stats</span> <span class="o">*</span><span class="n">get_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">mii_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ifreq</span> <span class="o">*</span><span class="n">rq</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">);</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ethtool_ops</span> <span class="n">netdev_ethtool_ops</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">netdev_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">reset_rx_descriptors</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">reset_tx_descriptors</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">stop_nic_rx</span><span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span><span class="p">,</span> <span class="kt">long</span> <span class="n">crvalue</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">delay</span> <span class="o">=</span> <span class="mh">0x1000</span><span class="p">;</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="n">crvalue</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">CR_W_RXEN</span><span class="p">),</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">TCRRCR</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">delay</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="n">ioread32</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">TCRRCR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">CR_R_RXSTOP</span><span class="p">)</span> <span class="o">==</span> <span class="n">CR_R_RXSTOP</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">stop_nic_rxtx</span><span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span><span class="p">,</span> <span class="kt">long</span> <span class="n">crvalue</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">delay</span> <span class="o">=</span> <span class="mh">0x1000</span><span class="p">;</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="n">crvalue</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">CR_W_RXEN</span><span class="o">+</span><span class="n">CR_W_TXEN</span><span class="p">),</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">TCRRCR</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">delay</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="n">ioread32</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">TCRRCR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">CR_R_RXSTOP</span><span class="o">+</span><span class="n">CR_R_TXSTOP</span><span class="p">))</span>
					    <span class="o">==</span> <span class="p">(</span><span class="n">CR_R_RXSTOP</span><span class="o">+</span><span class="n">CR_R_TXSTOP</span><span class="p">)</span> <span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">net_device_ops</span> <span class="n">netdev_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">ndo_open</span>		<span class="o">=</span> <span class="n">netdev_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_stop</span>		<span class="o">=</span> <span class="n">netdev_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_start_xmit</span>		<span class="o">=</span> <span class="n">start_tx</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_get_stats</span> 		<span class="o">=</span> <span class="n">get_stats</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_set_rx_mode</span>	<span class="o">=</span> <span class="n">set_rx_mode</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_do_ioctl</span>		<span class="o">=</span> <span class="n">mii_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_tx_timeout</span>		<span class="o">=</span> <span class="n">fealnx_tx_timeout</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_change_mtu</span>		<span class="o">=</span> <span class="n">eth_change_mtu</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_set_mac_address</span> 	<span class="o">=</span> <span class="n">eth_mac_addr</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_validate_addr</span>	<span class="o">=</span> <span class="n">eth_validate_addr</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">fealnx_init_one</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span>
				     <span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="o">*</span><span class="n">ent</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">netdev_private</span> <span class="o">*</span><span class="n">np</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">option</span><span class="p">,</span> <span class="n">err</span><span class="p">,</span> <span class="n">irq</span><span class="p">;</span>
	<span class="k">static</span> <span class="kt">int</span> <span class="n">card_idx</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">boardname</span><span class="p">[</span><span class="mi">12</span><span class="p">];</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">len</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">chip_id</span> <span class="o">=</span> <span class="n">ent</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">ring_space</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">ring_dma</span><span class="p">;</span>
<span class="cp">#ifdef USE_IO_OPS</span>
	<span class="kt">int</span> <span class="n">bar</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#else</span>
	<span class="kt">int</span> <span class="n">bar</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="cp">#endif</span>

<span class="cm">/* when built into the kernel, we only print version if device is found */</span>
<span class="cp">#ifndef MODULE</span>
	<span class="k">static</span> <span class="kt">int</span> <span class="n">printed_version</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">printed_version</span><span class="o">++</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">version</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="n">card_idx</span><span class="o">++</span><span class="p">;</span>
	<span class="n">sprintf</span><span class="p">(</span><span class="n">boardname</span><span class="p">,</span> <span class="s">&quot;fealnx%d&quot;</span><span class="p">,</span> <span class="n">card_idx</span><span class="p">);</span>

	<span class="n">option</span> <span class="o">=</span> <span class="n">card_idx</span> <span class="o">&lt;</span> <span class="n">MAX_UNITS</span> <span class="o">?</span> <span class="n">options</span><span class="p">[</span><span class="n">card_idx</span><span class="p">]</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">i</span> <span class="o">=</span> <span class="n">pci_enable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">return</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">pci_set_master</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="n">len</span> <span class="o">=</span> <span class="n">pci_resource_len</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">bar</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="n">MIN_REGION_SIZE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			   <span class="s">&quot;region size %ld too small, aborting</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">i</span> <span class="o">=</span> <span class="n">pci_request_regions</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">boardname</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">irq</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>

	<span class="n">ioaddr</span> <span class="o">=</span> <span class="n">pci_iomap</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">bar</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ioaddr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_out_res</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev</span> <span class="o">=</span> <span class="n">alloc_etherdev</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">netdev_private</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_out_unmap</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">SET_NETDEV_DEV</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* read ethernet id */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ioread8</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">PAR0</span> <span class="o">+</span> <span class="n">i</span><span class="p">);</span>

	<span class="cm">/* Reset the chip to erase previous misconfiguration. */</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="mh">0x00000001</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">BCR</span><span class="p">);</span>

	<span class="cm">/* Make certain the descriptor lists are aligned. */</span>
	<span class="n">np</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">np</span><span class="o">-&gt;</span><span class="n">mem</span> <span class="o">=</span> <span class="n">ioaddr</span><span class="p">;</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">np</span><span class="o">-&gt;</span><span class="n">pci_dev</span> <span class="o">=</span> <span class="n">pdev</span><span class="p">;</span>
	<span class="n">np</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">skel_netdrv_tbl</span><span class="p">[</span><span class="n">chip_id</span><span class="p">].</span><span class="n">flags</span><span class="p">;</span>
	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="n">np</span><span class="o">-&gt;</span><span class="n">mii</span><span class="p">.</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	<span class="n">np</span><span class="o">-&gt;</span><span class="n">mii</span><span class="p">.</span><span class="n">mdio_read</span> <span class="o">=</span> <span class="n">mdio_read</span><span class="p">;</span>
	<span class="n">np</span><span class="o">-&gt;</span><span class="n">mii</span><span class="p">.</span><span class="n">mdio_write</span> <span class="o">=</span> <span class="n">mdio_write</span><span class="p">;</span>
	<span class="n">np</span><span class="o">-&gt;</span><span class="n">mii</span><span class="p">.</span><span class="n">phy_id_mask</span> <span class="o">=</span> <span class="mh">0x1f</span><span class="p">;</span>
	<span class="n">np</span><span class="o">-&gt;</span><span class="n">mii</span><span class="p">.</span><span class="n">reg_num_mask</span> <span class="o">=</span> <span class="mh">0x1f</span><span class="p">;</span>

	<span class="n">ring_space</span> <span class="o">=</span> <span class="n">pci_alloc_consistent</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">RX_TOTAL_SIZE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ring_dma</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ring_space</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_out_free_dev</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_ring</span> <span class="o">=</span> <span class="n">ring_space</span><span class="p">;</span>
	<span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_ring_dma</span> <span class="o">=</span> <span class="n">ring_dma</span><span class="p">;</span>

	<span class="n">ring_space</span> <span class="o">=</span> <span class="n">pci_alloc_consistent</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">TX_TOTAL_SIZE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ring_dma</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ring_space</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_out_free_rx</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_ring</span> <span class="o">=</span> <span class="n">ring_space</span><span class="p">;</span>
	<span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_ring_dma</span> <span class="o">=</span> <span class="n">ring_dma</span><span class="p">;</span>

	<span class="cm">/* find the connected MII xcvrs */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">==</span> <span class="n">HAS_MII_XCVR</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">phy</span><span class="p">,</span> <span class="n">phy_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">phy</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">phy</span> <span class="o">&lt;</span> <span class="mi">32</span> <span class="o">&amp;&amp;</span> <span class="n">phy_idx</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">);</span>
			       <span class="n">phy</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">mii_status</span> <span class="o">=</span> <span class="n">mdio_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">mii_status</span> <span class="o">!=</span> <span class="mh">0xffff</span> <span class="o">&amp;&amp;</span> <span class="n">mii_status</span> <span class="o">!=</span> <span class="mh">0x0000</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">np</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">[</span><span class="n">phy_idx</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">phy</span><span class="p">;</span>
				<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				       <span class="s">&quot;MII PHY found at address %d, status &quot;</span>
				       <span class="s">&quot;0x%4.4x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">mii_status</span><span class="p">);</span>
				<span class="cm">/* get phy type */</span>
				<span class="p">{</span>
					<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">data</span><span class="p">;</span>

					<span class="n">data</span> <span class="o">=</span> <span class="n">mdio_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">2</span><span class="p">);</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">data</span> <span class="o">==</span> <span class="n">SeeqPHYID0</span><span class="p">)</span>
						<span class="n">np</span><span class="o">-&gt;</span><span class="n">PHYType</span> <span class="o">=</span> <span class="n">SeeqPHY</span><span class="p">;</span>
					<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">data</span> <span class="o">==</span> <span class="n">AhdocPHYID0</span><span class="p">)</span>
						<span class="n">np</span><span class="o">-&gt;</span><span class="n">PHYType</span> <span class="o">=</span> <span class="n">AhdocPHY</span><span class="p">;</span>
					<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">data</span> <span class="o">==</span> <span class="n">MarvellPHYID0</span><span class="p">)</span>
						<span class="n">np</span><span class="o">-&gt;</span><span class="n">PHYType</span> <span class="o">=</span> <span class="n">MarvellPHY</span><span class="p">;</span>
					<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">data</span> <span class="o">==</span> <span class="n">MysonPHYID0</span><span class="p">)</span>
						<span class="n">np</span><span class="o">-&gt;</span><span class="n">PHYType</span> <span class="o">=</span> <span class="n">Myson981</span><span class="p">;</span>
					<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">data</span> <span class="o">==</span> <span class="n">LevelOnePHYID0</span><span class="p">)</span>
						<span class="n">np</span><span class="o">-&gt;</span><span class="n">PHYType</span> <span class="o">=</span> <span class="n">LevelOnePHY</span><span class="p">;</span>
					<span class="k">else</span>
						<span class="n">np</span><span class="o">-&gt;</span><span class="n">PHYType</span> <span class="o">=</span> <span class="n">OtherPHY</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="n">np</span><span class="o">-&gt;</span><span class="n">mii_cnt</span> <span class="o">=</span> <span class="n">phy_idx</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">phy_idx</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;MII PHY not found -- this device may &quot;</span>
			       <span class="s">&quot;not operate correctly.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>
<span class="cm">/* 89/6/23 add, (begin) */</span>
		<span class="cm">/* get phy type */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ioread32</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">PHYIDENTIFIER</span><span class="p">)</span> <span class="o">==</span> <span class="n">MysonPHYID</span><span class="p">)</span>
			<span class="n">np</span><span class="o">-&gt;</span><span class="n">PHYType</span> <span class="o">=</span> <span class="n">MysonPHY</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">np</span><span class="o">-&gt;</span><span class="n">PHYType</span> <span class="o">=</span> <span class="n">OtherPHY</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">np</span><span class="o">-&gt;</span><span class="n">mii</span><span class="p">.</span><span class="n">phy_id</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mem_start</span><span class="p">)</span>
		<span class="n">option</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">mem_start</span><span class="p">;</span>

	<span class="cm">/* The lower four bits are the media type. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">option</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">option</span> <span class="o">&amp;</span> <span class="mh">0x200</span><span class="p">)</span>
			<span class="n">np</span><span class="o">-&gt;</span><span class="n">mii</span><span class="p">.</span><span class="n">full_duplex</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">default_port</span> <span class="o">=</span> <span class="n">option</span> <span class="o">&amp;</span> <span class="mi">15</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">card_idx</span> <span class="o">&lt;</span> <span class="n">MAX_UNITS</span> <span class="o">&amp;&amp;</span> <span class="n">full_duplex</span><span class="p">[</span><span class="n">card_idx</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">mii</span><span class="p">.</span><span class="n">full_duplex</span> <span class="o">=</span> <span class="n">full_duplex</span><span class="p">[</span><span class="n">card_idx</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">mii</span><span class="p">.</span><span class="n">full_duplex</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Media type forced to Full Duplex.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cm">/* 89/6/13 add, (begin) */</span></pre></div></td></tr>


<tr id="section-6"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-6">&#182;</a></div><pre><code> if (np-&gt;PHYType==MarvellPHY)
</code></pre></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span> <span class="p">((</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">PHYType</span> <span class="o">==</span> <span class="n">MarvellPHY</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">PHYType</span> <span class="o">==</span> <span class="n">LevelOnePHY</span><span class="p">))</span> <span class="p">{</span>
			<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">data</span><span class="p">;</span>

			<span class="n">data</span> <span class="o">=</span> <span class="n">mdio_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">9</span><span class="p">);</span>
			<span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span> <span class="o">&amp;</span> <span class="mh">0xfcff</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x0200</span><span class="p">;</span>
			<span class="n">mdio_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">9</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
		<span class="p">}</span>
<span class="cm">/* 89/6/13 add, (end) */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">==</span> <span class="n">HAS_MII_XCVR</span><span class="p">)</span>
			<span class="n">mdio_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">MII_ADVERTISE</span><span class="p">,</span> <span class="n">ADVERTISE_FULL</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">iowrite32</span><span class="p">(</span><span class="n">ADVERTISE_FULL</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">ANARANLPAR</span><span class="p">);</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">mii</span><span class="p">.</span><span class="n">force_media</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">netdev_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">netdev_ops</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ethtool_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">netdev_ethtool_ops</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">watchdog_timeo</span> <span class="o">=</span> <span class="n">TX_TIMEOUT</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">register_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_out_free_tx</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: %s at %p, %pM, IRQ %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">skel_netdrv_tbl</span><span class="p">[</span><span class="n">chip_id</span><span class="p">].</span><span class="n">chip_name</span><span class="p">,</span> <span class="n">ioaddr</span><span class="p">,</span>
	       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">irq</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_out_free_tx:</span>
	<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">TX_TOTAL_SIZE</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_ring_dma</span><span class="p">);</span>
<span class="nl">err_out_free_rx:</span>
	<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">RX_TOTAL_SIZE</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_ring_dma</span><span class="p">);</span>
<span class="nl">err_out_free_dev:</span>
	<span class="n">free_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="nl">err_out_unmap:</span>
	<span class="n">pci_iounmap</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">ioaddr</span><span class="p">);</span>
<span class="nl">err_out_res:</span>
	<span class="n">pci_release_regions</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="n">__devexit</span> <span class="nf">fealnx_remove_one</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">netdev_private</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

		<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">TX_TOTAL_SIZE</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">,</span>
			<span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_ring_dma</span><span class="p">);</span>
		<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">RX_TOTAL_SIZE</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">,</span>
			<span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_ring_dma</span><span class="p">);</span>
		<span class="n">unregister_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">pci_iounmap</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">);</span>
		<span class="n">free_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">pci_release_regions</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
		<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;fealnx: remove for unknown device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="n">ulong</span> <span class="nf">m80x_send_cmd_to_phy</span><span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">miiport</span><span class="p">,</span> <span class="kt">int</span> <span class="n">opcode</span><span class="p">,</span> <span class="kt">int</span> <span class="n">phyad</span><span class="p">,</span> <span class="kt">int</span> <span class="n">regad</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ulong</span> <span class="n">miir</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mask</span><span class="p">,</span> <span class="n">data</span><span class="p">;</span>

	<span class="cm">/* enable MII output */</span>
	<span class="n">miir</span> <span class="o">=</span> <span class="p">(</span><span class="n">ulong</span><span class="p">)</span> <span class="n">ioread32</span><span class="p">(</span><span class="n">miiport</span><span class="p">);</span>
	<span class="n">miir</span> <span class="o">&amp;=</span> <span class="mh">0xfffffff0</span><span class="p">;</span>

	<span class="n">miir</span> <span class="o">|=</span> <span class="n">MASK_MIIR_MII_WRITE</span> <span class="o">+</span> <span class="n">MASK_MIIR_MII_MDO</span><span class="p">;</span>

	<span class="cm">/* send 32 1&#39;s preamble */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">32</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* low MDC; MDO is already high (miir) */</span>
		<span class="n">miir</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MASK_MIIR_MII_MDC</span><span class="p">;</span>
		<span class="n">iowrite32</span><span class="p">(</span><span class="n">miir</span><span class="p">,</span> <span class="n">miiport</span><span class="p">);</span>

		<span class="cm">/* high MDC */</span>
		<span class="n">miir</span> <span class="o">|=</span> <span class="n">MASK_MIIR_MII_MDC</span><span class="p">;</span>
		<span class="n">iowrite32</span><span class="p">(</span><span class="n">miir</span><span class="p">,</span> <span class="n">miiport</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* calculate ST+OP+PHYAD+REGAD+TA */</span>
	<span class="n">data</span> <span class="o">=</span> <span class="n">opcode</span> <span class="o">|</span> <span class="p">(</span><span class="n">phyad</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">regad</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">);</span>

	<span class="cm">/* sent out */</span>
	<span class="n">mask</span> <span class="o">=</span> <span class="mh">0x8000</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">mask</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* low MDC, prepare MDO */</span>
		<span class="n">miir</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">MASK_MIIR_MII_MDC</span> <span class="o">+</span> <span class="n">MASK_MIIR_MII_MDO</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="n">data</span><span class="p">)</span>
			<span class="n">miir</span> <span class="o">|=</span> <span class="n">MASK_MIIR_MII_MDO</span><span class="p">;</span>

		<span class="n">iowrite32</span><span class="p">(</span><span class="n">miir</span><span class="p">,</span> <span class="n">miiport</span><span class="p">);</span>
		<span class="cm">/* high MDC */</span>
		<span class="n">miir</span> <span class="o">|=</span> <span class="n">MASK_MIIR_MII_MDC</span><span class="p">;</span>
		<span class="n">iowrite32</span><span class="p">(</span><span class="n">miir</span><span class="p">,</span> <span class="n">miiport</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">30</span><span class="p">);</span>

		<span class="cm">/* next */</span>
		<span class="n">mask</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mask</span> <span class="o">==</span> <span class="mh">0x2</span> <span class="o">&amp;&amp;</span> <span class="n">opcode</span> <span class="o">==</span> <span class="n">OP_READ</span><span class="p">)</span>
			<span class="n">miir</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MASK_MIIR_MII_WRITE</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">miir</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">mdio_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">phyad</span><span class="p">,</span> <span class="kt">int</span> <span class="n">regad</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">netdev_private</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">miiport</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">mem</span> <span class="o">+</span> <span class="n">MANAGEMENT</span><span class="p">;</span>
	<span class="n">ulong</span> <span class="n">miir</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mask</span><span class="p">,</span> <span class="n">data</span><span class="p">;</span>

	<span class="n">miir</span> <span class="o">=</span> <span class="n">m80x_send_cmd_to_phy</span><span class="p">(</span><span class="n">miiport</span><span class="p">,</span> <span class="n">OP_READ</span><span class="p">,</span> <span class="n">phyad</span><span class="p">,</span> <span class="n">regad</span><span class="p">);</span>

	<span class="cm">/* read data */</span>
	<span class="n">mask</span> <span class="o">=</span> <span class="mh">0x8000</span><span class="p">;</span>
	<span class="n">data</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">mask</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* low MDC */</span>
		<span class="n">miir</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MASK_MIIR_MII_MDC</span><span class="p">;</span>
		<span class="n">iowrite32</span><span class="p">(</span><span class="n">miir</span><span class="p">,</span> <span class="n">miiport</span><span class="p">);</span>

		<span class="cm">/* read MDI */</span>
		<span class="n">miir</span> <span class="o">=</span> <span class="n">ioread32</span><span class="p">(</span><span class="n">miiport</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">miir</span> <span class="o">&amp;</span> <span class="n">MASK_MIIR_MII_MDI</span><span class="p">)</span>
			<span class="n">data</span> <span class="o">|=</span> <span class="n">mask</span><span class="p">;</span>

		<span class="cm">/* high MDC, and wait */</span>
		<span class="n">miir</span> <span class="o">|=</span> <span class="n">MASK_MIIR_MII_MDC</span><span class="p">;</span>
		<span class="n">iowrite32</span><span class="p">(</span><span class="n">miir</span><span class="p">,</span> <span class="n">miiport</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">30</span><span class="p">);</span>

		<span class="cm">/* next */</span>
		<span class="n">mask</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* low MDC */</span>
	<span class="n">miir</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MASK_MIIR_MII_MDC</span><span class="p">;</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="n">miir</span><span class="p">,</span> <span class="n">miiport</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">data</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">mdio_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">phyad</span><span class="p">,</span> <span class="kt">int</span> <span class="n">regad</span><span class="p">,</span> <span class="kt">int</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">netdev_private</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">miiport</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">mem</span> <span class="o">+</span> <span class="n">MANAGEMENT</span><span class="p">;</span>
	<span class="n">ulong</span> <span class="n">miir</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mask</span><span class="p">;</span>

	<span class="n">miir</span> <span class="o">=</span> <span class="n">m80x_send_cmd_to_phy</span><span class="p">(</span><span class="n">miiport</span><span class="p">,</span> <span class="n">OP_WRITE</span><span class="p">,</span> <span class="n">phyad</span><span class="p">,</span> <span class="n">regad</span><span class="p">);</span>

	<span class="cm">/* write data */</span>
	<span class="n">mask</span> <span class="o">=</span> <span class="mh">0x8000</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">mask</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* low MDC, prepare MDO */</span>
		<span class="n">miir</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">MASK_MIIR_MII_MDC</span> <span class="o">+</span> <span class="n">MASK_MIIR_MII_MDO</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="n">data</span><span class="p">)</span>
			<span class="n">miir</span> <span class="o">|=</span> <span class="n">MASK_MIIR_MII_MDO</span><span class="p">;</span>
		<span class="n">iowrite32</span><span class="p">(</span><span class="n">miir</span><span class="p">,</span> <span class="n">miiport</span><span class="p">);</span>

		<span class="cm">/* high MDC */</span>
		<span class="n">miir</span> <span class="o">|=</span> <span class="n">MASK_MIIR_MII_MDC</span><span class="p">;</span>
		<span class="n">iowrite32</span><span class="p">(</span><span class="n">miir</span><span class="p">,</span> <span class="n">miiport</span><span class="p">);</span>

		<span class="cm">/* next */</span>
		<span class="n">mask</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* low MDC */</span>
	<span class="n">miir</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MASK_MIIR_MII_MDC</span><span class="p">;</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="n">miir</span><span class="p">,</span> <span class="n">miiport</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">netdev_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">netdev_private</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">int</span> <span class="n">irq</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">iowrite32</span><span class="p">(</span><span class="mh">0x00000001</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">BCR</span><span class="p">);</span>	<span class="cm">/* Reset */</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="n">intr_handler</span><span class="p">,</span> <span class="n">IRQF_SHARED</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">iowrite16</span><span class="p">(((</span><span class="kt">unsigned</span> <span class="kt">short</span><span class="o">*</span><span class="p">)</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">)[</span><span class="n">i</span><span class="p">],</span>
				<span class="n">ioaddr</span> <span class="o">+</span> <span class="n">PAR0</span> <span class="o">+</span> <span class="n">i</span><span class="o">*</span><span class="mi">2</span><span class="p">);</span>

	<span class="n">init_ring</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">iowrite32</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_ring_dma</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">RXLBA</span><span class="p">);</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_ring_dma</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">TXLBA</span><span class="p">);</span>

	<span class="cm">/* Initialize other registers. */</span>
	<span class="cm">/* Configure the PCI bus bursts and FIFO thresholds.</span>
<span class="cm">	   486: Set 8 longword burst.</span>
<span class="cm">	   586: no burst limit.</span>
<span class="cm">	   Burst length 5:3</span>
<span class="cm">	   0 0 0   1</span>
<span class="cm">	   0 0 1   4</span>
<span class="cm">	   0 1 0   8</span>
<span class="cm">	   0 1 1   16</span>
<span class="cm">	   1 0 0   32</span>
<span class="cm">	   1 0 1   64</span>
<span class="cm">	   1 1 0   128</span>
<span class="cm">	   1 1 1   256</span>
<span class="cm">	   Wait the specified 50 PCI cycles after a reset by initializing</span>
<span class="cm">	   Tx and Rx queues and the address filter list.</span>
<span class="cm">	   FIXME (Ueimor): optimistic for alpha + posted writes ? */</span>

	<span class="n">np</span><span class="o">-&gt;</span><span class="n">bcrvalue</span> <span class="o">=</span> <span class="mh">0x10</span><span class="p">;</span>	<span class="cm">/* little-endian, 8 burst length */</span>
<span class="cp">#ifdef __BIG_ENDIAN</span>
	<span class="n">np</span><span class="o">-&gt;</span><span class="n">bcrvalue</span> <span class="o">|=</span> <span class="mh">0x04</span><span class="p">;</span>	<span class="cm">/* big-endian */</span>
<span class="cp">#endif</span>

<span class="cp">#if defined(__i386__) &amp;&amp; !defined(MODULE)</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">boot_cpu_data</span><span class="p">.</span><span class="n">x86</span> <span class="o">&lt;=</span> <span class="mi">4</span><span class="p">)</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">crvalue</span> <span class="o">=</span> <span class="mh">0xa00</span><span class="p">;</span>
	<span class="k">else</span>
<span class="cp">#endif</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">crvalue</span> <span class="o">=</span> <span class="mh">0xe00</span><span class="p">;</span>	<span class="cm">/* rx 128 burst length */</span></pre></div></td></tr>


<tr id="section-7"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-7">&#182;</a></div><p>89/12/29 add,
90/1/16 modify,
  np->imrvalue=FBE|TUNF|CNTOVF|RBU|TI|RI;</p></td><td class="code"><div class="highlight"><pre>	<span class="n">np</span><span class="o">-&gt;</span><span class="n">imrvalue</span> <span class="o">=</span> <span class="n">TUNF</span> <span class="o">|</span> <span class="n">CNTOVF</span> <span class="o">|</span> <span class="n">RBU</span> <span class="o">|</span> <span class="n">TI</span> <span class="o">|</span> <span class="n">RI</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="mh">0x891</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">bcrvalue</span> <span class="o">|=</span> <span class="mh">0x200</span><span class="p">;</span>	<span class="cm">/* set PROG bit */</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">crvalue</span> <span class="o">|=</span> <span class="n">CR_W_ENH</span><span class="p">;</span>	<span class="cm">/* set enhanced bit */</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">imrvalue</span> <span class="o">|=</span> <span class="n">ETI</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">bcrvalue</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">BCR</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">if_port</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">if_port</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">default_port</span><span class="p">;</span>

	<span class="n">iowrite32</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">RXPDR</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-8"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-8">&#182;</a></div><p>89/9/1 modify,
  np->crvalue = 0x00e40001;    /* tx store and forward, tx/rx enable */</p></td><td class="code"><div class="highlight"><pre>	<span class="n">np</span><span class="o">-&gt;</span><span class="n">crvalue</span> <span class="o">|=</span> <span class="mh">0x00e40001</span><span class="p">;</span>	<span class="cm">/* tx store and forward, tx/rx enable */</span>
	<span class="n">np</span><span class="o">-&gt;</span><span class="n">mii</span><span class="p">.</span><span class="n">full_duplex</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">mii</span><span class="p">.</span><span class="n">force_media</span><span class="p">;</span>
	<span class="n">getlinkstatus</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">linkok</span><span class="p">)</span>
		<span class="n">getlinktype</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">__set_rx_mode</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">netif_start_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* Clear and Enable interrupts by setting the interrupt mask. */</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="n">FBE</span> <span class="o">|</span> <span class="n">TUNF</span> <span class="o">|</span> <span class="n">CNTOVF</span> <span class="o">|</span> <span class="n">RBU</span> <span class="o">|</span> <span class="n">TI</span> <span class="o">|</span> <span class="n">RI</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">ISR</span><span class="p">);</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">imrvalue</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">IMR</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">debug</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: Done netdev_open().</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="cm">/* Set the timer to check for link beat. */</span>
	<span class="n">init_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
	<span class="n">np</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span> <span class="n">RUN_AT</span><span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">);</span>
	<span class="n">np</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">dev</span><span class="p">;</span>
	<span class="n">np</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="n">netdev_timer</span><span class="p">;</span>

	<span class="cm">/* timer handler */</span>
	<span class="n">add_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>

	<span class="n">init_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">reset_timer</span><span class="p">);</span>
	<span class="n">np</span><span class="o">-&gt;</span><span class="n">reset_timer</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">dev</span><span class="p">;</span>
	<span class="n">np</span><span class="o">-&gt;</span><span class="n">reset_timer</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="n">reset_timer</span><span class="p">;</span>
	<span class="n">np</span><span class="o">-&gt;</span><span class="n">reset_timer_armed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">getlinkstatus</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="cm">/* function: Routine will read MII Status Register to get link status.       */</span>
<span class="cm">/* input   : dev... pointer to the adapter block.                            */</span>
<span class="cm">/* output  : none.                                                           */</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">netdev_private</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">DelayTime</span> <span class="o">=</span> <span class="mh">0x1000</span><span class="p">;</span>

	<span class="n">np</span><span class="o">-&gt;</span><span class="n">linkok</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">PHYType</span> <span class="o">==</span> <span class="n">MysonPHY</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">DelayTime</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ioread32</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">mem</span> <span class="o">+</span> <span class="n">BMCRSR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">LinkIsUp2</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">np</span><span class="o">-&gt;</span><span class="n">linkok</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="k">return</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">DelayTime</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">mdio_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">MII_BMSR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">BMSR_LSTATUS</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">np</span><span class="o">-&gt;</span><span class="n">linkok</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="k">return</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">getlinktype</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">netdev_private</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">PHYType</span> <span class="o">==</span> <span class="n">MysonPHY</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* 3-in-1 case */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ioread32</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">mem</span> <span class="o">+</span> <span class="n">TCRRCR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">CR_R_FD</span><span class="p">)</span>
			<span class="n">np</span><span class="o">-&gt;</span><span class="n">duplexmode</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>	<span class="cm">/* full duplex */</span>
		<span class="k">else</span>
			<span class="n">np</span><span class="o">-&gt;</span><span class="n">duplexmode</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* half duplex */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ioread32</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">mem</span> <span class="o">+</span> <span class="n">TCRRCR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">CR_R_PS10</span><span class="p">)</span>
			<span class="n">np</span><span class="o">-&gt;</span><span class="n">line_speed</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* 10M */</span>
		<span class="k">else</span>
			<span class="n">np</span><span class="o">-&gt;</span><span class="n">line_speed</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>	<span class="cm">/* 100M */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">PHYType</span> <span class="o">==</span> <span class="n">SeeqPHY</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* this PHY is SEEQ 80225 */</span>
			<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">data</span><span class="p">;</span>

			<span class="n">data</span> <span class="o">=</span> <span class="n">mdio_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">MIIRegister18</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">data</span> <span class="o">&amp;</span> <span class="n">SPD_DET_100</span><span class="p">)</span>
				<span class="n">np</span><span class="o">-&gt;</span><span class="n">line_speed</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>	<span class="cm">/* 100M */</span>
			<span class="k">else</span>
				<span class="n">np</span><span class="o">-&gt;</span><span class="n">line_speed</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* 10M */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">data</span> <span class="o">&amp;</span> <span class="n">DPLX_DET_FULL</span><span class="p">)</span>
				<span class="n">np</span><span class="o">-&gt;</span><span class="n">duplexmode</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>	<span class="cm">/* full duplex mode */</span>
			<span class="k">else</span>
				<span class="n">np</span><span class="o">-&gt;</span><span class="n">duplexmode</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* half duplex mode */</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">PHYType</span> <span class="o">==</span> <span class="n">AhdocPHY</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">data</span><span class="p">;</span>

			<span class="n">data</span> <span class="o">=</span> <span class="n">mdio_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">DiagnosticReg</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">data</span> <span class="o">&amp;</span> <span class="n">Speed_100</span><span class="p">)</span>
				<span class="n">np</span><span class="o">-&gt;</span><span class="n">line_speed</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>	<span class="cm">/* 100M */</span>
			<span class="k">else</span>
				<span class="n">np</span><span class="o">-&gt;</span><span class="n">line_speed</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* 10M */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">data</span> <span class="o">&amp;</span> <span class="n">DPLX_FULL</span><span class="p">)</span>
				<span class="n">np</span><span class="o">-&gt;</span><span class="n">duplexmode</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>	<span class="cm">/* full duplex mode */</span>
			<span class="k">else</span>
				<span class="n">np</span><span class="o">-&gt;</span><span class="n">duplexmode</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* half duplex mode */</span>
		<span class="p">}</span>
<span class="cm">/* 89/6/13 add, (begin) */</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">PHYType</span> <span class="o">==</span> <span class="n">MarvellPHY</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">data</span><span class="p">;</span>

			<span class="n">data</span> <span class="o">=</span> <span class="n">mdio_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">SpecificReg</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">data</span> <span class="o">&amp;</span> <span class="n">Full_Duplex</span><span class="p">)</span>
				<span class="n">np</span><span class="o">-&gt;</span><span class="n">duplexmode</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>	<span class="cm">/* full duplex mode */</span>
			<span class="k">else</span>
				<span class="n">np</span><span class="o">-&gt;</span><span class="n">duplexmode</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* half duplex mode */</span>
			<span class="n">data</span> <span class="o">&amp;=</span> <span class="n">SpeedMask</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">data</span> <span class="o">==</span> <span class="n">Speed_1000M</span><span class="p">)</span>
				<span class="n">np</span><span class="o">-&gt;</span><span class="n">line_speed</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>	<span class="cm">/* 1000M */</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">data</span> <span class="o">==</span> <span class="n">Speed_100M</span><span class="p">)</span>
				<span class="n">np</span><span class="o">-&gt;</span><span class="n">line_speed</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>	<span class="cm">/* 100M */</span>
			<span class="k">else</span>
				<span class="n">np</span><span class="o">-&gt;</span><span class="n">line_speed</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* 10M */</span>
		<span class="p">}</span>
<span class="cm">/* 89/6/13 add, (end) */</span>
<span class="cm">/* 89/7/27 add, (begin) */</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">PHYType</span> <span class="o">==</span> <span class="n">Myson981</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">data</span><span class="p">;</span>

			<span class="n">data</span> <span class="o">=</span> <span class="n">mdio_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">StatusRegister</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">data</span> <span class="o">&amp;</span> <span class="n">SPEED100</span><span class="p">)</span>
				<span class="n">np</span><span class="o">-&gt;</span><span class="n">line_speed</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">np</span><span class="o">-&gt;</span><span class="n">line_speed</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">data</span> <span class="o">&amp;</span> <span class="n">FULLMODE</span><span class="p">)</span>
				<span class="n">np</span><span class="o">-&gt;</span><span class="n">duplexmode</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">np</span><span class="o">-&gt;</span><span class="n">duplexmode</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
<span class="cm">/* 89/7/27 add, (end) */</span>
<span class="cm">/* 89/12/29 add */</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">PHYType</span> <span class="o">==</span> <span class="n">LevelOnePHY</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">data</span><span class="p">;</span>

			<span class="n">data</span> <span class="o">=</span> <span class="n">mdio_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">SpecificReg</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">data</span> <span class="o">&amp;</span> <span class="n">LXT1000_Full</span><span class="p">)</span>
				<span class="n">np</span><span class="o">-&gt;</span><span class="n">duplexmode</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>	<span class="cm">/* full duplex mode */</span>
			<span class="k">else</span>
				<span class="n">np</span><span class="o">-&gt;</span><span class="n">duplexmode</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* half duplex mode */</span>
			<span class="n">data</span> <span class="o">&amp;=</span> <span class="n">SpeedMask</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">data</span> <span class="o">==</span> <span class="n">LXT1000_1000M</span><span class="p">)</span>
				<span class="n">np</span><span class="o">-&gt;</span><span class="n">line_speed</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>	<span class="cm">/* 1000M */</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">data</span> <span class="o">==</span> <span class="n">LXT1000_100M</span><span class="p">)</span>
				<span class="n">np</span><span class="o">-&gt;</span><span class="n">line_speed</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>	<span class="cm">/* 100M */</span>
			<span class="k">else</span>
				<span class="n">np</span><span class="o">-&gt;</span><span class="n">line_speed</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* 10M */</span>
		<span class="p">}</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">crvalue</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="o">~</span><span class="n">CR_W_PS10</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="n">CR_W_FD</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="n">CR_W_PS1000</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">line_speed</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">np</span><span class="o">-&gt;</span><span class="n">crvalue</span> <span class="o">|=</span> <span class="n">CR_W_PS10</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">line_speed</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span>
			<span class="n">np</span><span class="o">-&gt;</span><span class="n">crvalue</span> <span class="o">|=</span> <span class="n">CR_W_PS1000</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">duplexmode</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
			<span class="n">np</span><span class="o">-&gt;</span><span class="n">crvalue</span> <span class="o">|=</span> <span class="n">CR_W_FD</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="cm">/* Take lock before calling this */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">allocate_rx_buffers</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">netdev_private</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/*  allocate skb for rx buffers */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">really_rx_count</span> <span class="o">!=</span> <span class="n">RX_RING_SIZE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>

		<span class="n">skb</span> <span class="o">=</span> <span class="n">netdev_alloc_skb</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_buf_sz</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">skb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>	<span class="cm">/* Better luck next round. */</span>

		<span class="k">while</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">lack_rxbuf</span><span class="o">-&gt;</span><span class="n">skbuff</span><span class="p">)</span>
			<span class="n">np</span><span class="o">-&gt;</span><span class="n">lack_rxbuf</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">lack_rxbuf</span><span class="o">-&gt;</span><span class="n">next_desc_logical</span><span class="p">;</span>

		<span class="n">np</span><span class="o">-&gt;</span><span class="n">lack_rxbuf</span><span class="o">-&gt;</span><span class="n">skbuff</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">lack_rxbuf</span><span class="o">-&gt;</span><span class="n">buffer</span> <span class="o">=</span> <span class="n">pci_map_single</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span>
			<span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_buf_sz</span><span class="p">,</span> <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">lack_rxbuf</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">RXOWN</span><span class="p">;</span>
		<span class="o">++</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">really_rx_count</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">netdev_timer</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="p">)</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">netdev_private</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">old_crvalue</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">crvalue</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">old_linkok</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">linkok</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">debug</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: Media selection timer tick, status %8.8x &quot;</span>
		       <span class="s">&quot;config %8.8x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ioread32</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">ISR</span><span class="p">),</span>
		       <span class="n">ioread32</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">TCRRCR</span><span class="p">));</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">==</span> <span class="n">HAS_MII_XCVR</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">getlinkstatus</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">old_linkok</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">linkok</span> <span class="o">==</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>	<span class="cm">/* we need to detect the media type again */</span>
			<span class="n">getlinktype</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">crvalue</span> <span class="o">!=</span> <span class="n">old_crvalue</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">stop_nic_rxtx</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">crvalue</span><span class="p">);</span>
				<span class="n">iowrite32</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">crvalue</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">TCRRCR</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">allocate_rx_buffers</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">np</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span> <span class="n">RUN_AT</span><span class="p">(</span><span class="mi">10</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">);</span>
	<span class="n">add_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/* Take lock before calling */</span>
<span class="cm">/* Reset chip and disable rx, tx and interrupts */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">reset_and_disable_rxtx</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">netdev_private</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">delay</span><span class="o">=</span><span class="mi">51</span><span class="p">;</span>

	<span class="cm">/* Reset the chip&#39;s Tx and Rx processes. */</span>
	<span class="n">stop_nic_rxtx</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* Disable interrupts by clearing the interrupt mask. */</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">IMR</span><span class="p">);</span>

	<span class="cm">/* Reset the chip to erase previous misconfiguration. */</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="mh">0x00000001</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">BCR</span><span class="p">);</span>

	<span class="cm">/* Ueimor: wait for 50 PCI cycles (and flush posted writes btw).</span>
<span class="cm">	   We surely wait too long (address+data phase). Who cares? */</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">delay</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ioread32</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">BCR</span><span class="p">);</span>
		<span class="n">rmb</span><span class="p">();</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="cm">/* Take lock before calling */</span>
<span class="cm">/* Restore chip after reset */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">enable_rxtx</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">netdev_private</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">;</span>

	<span class="n">reset_rx_descriptors</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">iowrite32</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_ring_dma</span> <span class="o">+</span> <span class="p">((</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">cur_tx</span> <span class="o">-</span> <span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">),</span>
		<span class="n">ioaddr</span> <span class="o">+</span> <span class="n">TXLBA</span><span class="p">);</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_ring_dma</span> <span class="o">+</span> <span class="p">((</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">cur_rx</span> <span class="o">-</span> <span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">),</span>
		<span class="n">ioaddr</span> <span class="o">+</span> <span class="n">RXLBA</span><span class="p">);</span>

	<span class="n">iowrite32</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">bcrvalue</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">BCR</span><span class="p">);</span>

	<span class="n">iowrite32</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">RXPDR</span><span class="p">);</span>
	<span class="n">__set_rx_mode</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span> <span class="cm">/* changes np-&gt;crvalue, writes it into TCRRCR */</span>

	<span class="cm">/* Clear and Enable interrupts by setting the interrupt mask. */</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="n">FBE</span> <span class="o">|</span> <span class="n">TUNF</span> <span class="o">|</span> <span class="n">CNTOVF</span> <span class="o">|</span> <span class="n">RBU</span> <span class="o">|</span> <span class="n">TI</span> <span class="o">|</span> <span class="n">RI</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">ISR</span><span class="p">);</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">imrvalue</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">IMR</span><span class="p">);</span>

	<span class="n">iowrite32</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">TXPDR</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">reset_timer</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="p">)</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">netdev_private</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: resetting tx and rx machinery</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">np</span><span class="o">-&gt;</span><span class="n">crvalue</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">crvalue_sv</span><span class="p">;</span>
	<span class="n">np</span><span class="o">-&gt;</span><span class="n">imrvalue</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">imrvalue_sv</span><span class="p">;</span>

	<span class="n">reset_and_disable_rxtx</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="cm">/* works for me without this:</span>
<span class="cm">	reset_tx_descriptors(dev); */</span>
	<span class="n">enable_rxtx</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">netif_start_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span> <span class="cm">/* FIXME: or netif_wake_queue(dev); ? */</span>

	<span class="n">np</span><span class="o">-&gt;</span><span class="n">reset_timer_armed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">fealnx_tx_timeout</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">netdev_private</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span>
	       <span class="s">&quot;%s: Transmit timed out, status %8.8x, resetting...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ioread32</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">ISR</span><span class="p">));</span>

	<span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;  Rx ring %p: &quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">RX_RING_SIZE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CONT</span> <span class="s">&quot; %8.8x&quot;</span><span class="p">,</span>
			       <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">status</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CONT</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;  Tx ring %p: &quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">TX_RING_SIZE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CONT</span> <span class="s">&quot; %4.4x&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">status</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CONT</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">reset_and_disable_rxtx</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">reset_tx_descriptors</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">enable_rxtx</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">trans_start</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span> <span class="cm">/* prevent tx timeout */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_errors</span><span class="o">++</span><span class="p">;</span>
	<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span> <span class="cm">/* or .._start_.. ?? */</span>
<span class="p">}</span>


<span class="cm">/* Initialize the Rx and Tx rings, along with various &#39;dev&#39; bits. */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">init_ring</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">netdev_private</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* initialize rx variables */</span>
	<span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_buf_sz</span> <span class="o">=</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mtu</span> <span class="o">&lt;=</span> <span class="mi">1500</span> <span class="o">?</span> <span class="n">PKT_BUF_SZ</span> <span class="o">:</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">mtu</span> <span class="o">+</span> <span class="mi">32</span><span class="p">);</span>
	<span class="n">np</span><span class="o">-&gt;</span><span class="n">cur_rx</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">np</span><span class="o">-&gt;</span><span class="n">lack_rxbuf</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">;</span>
	<span class="n">np</span><span class="o">-&gt;</span><span class="n">really_rx_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* initial rx descriptors. */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">RX_RING_SIZE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">control</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_buf_sz</span> <span class="o">&lt;&lt;</span> <span class="n">RBSShift</span><span class="p">;</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">next_desc</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_ring_dma</span> <span class="o">+</span>
			<span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fealnx_desc</span><span class="p">);</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">next_desc_logical</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">skbuff</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* for the last rx descriptor */</span>
	<span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">].</span><span class="n">next_desc</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_ring_dma</span><span class="p">;</span>
	<span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">].</span><span class="n">next_desc_logical</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">;</span>

	<span class="cm">/* allocate skb for rx buffers */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">RX_RING_SIZE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="n">netdev_alloc_skb</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_buf_sz</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">skb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">np</span><span class="o">-&gt;</span><span class="n">lack_rxbuf</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="o">++</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">really_rx_count</span><span class="p">;</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">skbuff</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">buffer</span> <span class="o">=</span> <span class="n">pci_map_single</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span>
			<span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_buf_sz</span><span class="p">,</span> <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">status</span> <span class="o">=</span> <span class="n">RXOWN</span><span class="p">;</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">control</span> <span class="o">|=</span> <span class="n">RXIC</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* initialize tx variables */</span>
	<span class="n">np</span><span class="o">-&gt;</span><span class="n">cur_tx</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">np</span><span class="o">-&gt;</span><span class="n">cur_tx_copy</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">np</span><span class="o">-&gt;</span><span class="n">really_tx_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">np</span><span class="o">-&gt;</span><span class="n">free_tx_count</span> <span class="o">=</span> <span class="n">TX_RING_SIZE</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">TX_RING_SIZE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="cm">/* do we need np-&gt;tx_ring[i].control = XXX; ?? */</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">next_desc</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_ring_dma</span> <span class="o">+</span>
			<span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fealnx_desc</span><span class="p">);</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">next_desc_logical</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">skbuff</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* for the last tx descriptor */</span>
	<span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">].</span><span class="n">next_desc</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_ring_dma</span><span class="p">;</span>
	<span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">].</span><span class="n">next_desc_logical</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<span class="p">}</span>


<span class="k">static</span> <span class="n">netdev_tx_t</span> <span class="nf">start_tx</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">netdev_private</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">np</span><span class="o">-&gt;</span><span class="n">cur_tx_copy</span><span class="o">-&gt;</span><span class="n">skbuff</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>

<span class="cp">#define one_buffer</span>
<span class="cp">#define BPT 1022</span>
<span class="cp">#if defined(one_buffer)</span>
	<span class="n">np</span><span class="o">-&gt;</span><span class="n">cur_tx_copy</span><span class="o">-&gt;</span><span class="n">buffer</span> <span class="o">=</span> <span class="n">pci_map_single</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span>
		<span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">PCI_DMA_TODEVICE</span><span class="p">);</span>
	<span class="n">np</span><span class="o">-&gt;</span><span class="n">cur_tx_copy</span><span class="o">-&gt;</span><span class="n">control</span> <span class="o">=</span> <span class="n">TXIC</span> <span class="o">|</span> <span class="n">TXLD</span> <span class="o">|</span> <span class="n">TXFD</span> <span class="o">|</span> <span class="n">CRCEnable</span> <span class="o">|</span> <span class="n">PADEnable</span><span class="p">;</span>
	<span class="n">np</span><span class="o">-&gt;</span><span class="n">cur_tx_copy</span><span class="o">-&gt;</span><span class="n">control</span> <span class="o">|=</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&lt;&lt;</span> <span class="n">PKTSShift</span><span class="p">);</span>	<span class="cm">/* pkt size */</span>
	<span class="n">np</span><span class="o">-&gt;</span><span class="n">cur_tx_copy</span><span class="o">-&gt;</span><span class="n">control</span> <span class="o">|=</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&lt;&lt;</span> <span class="n">TBSShift</span><span class="p">);</span>	<span class="cm">/* buffer size */</span></pre></div></td></tr>


<tr id="section-9"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-9">&#182;</a></div><p>89/12/29 add,</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="mh">0x891</span><span class="p">)</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">cur_tx_copy</span><span class="o">-&gt;</span><span class="n">control</span> <span class="o">|=</span> <span class="n">ETIControl</span> <span class="o">|</span> <span class="n">RetryTxLC</span><span class="p">;</span>
	<span class="n">np</span><span class="o">-&gt;</span><span class="n">cur_tx_copy</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">TXOWN</span><span class="p">;</span>
	<span class="n">np</span><span class="o">-&gt;</span><span class="n">cur_tx_copy</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">cur_tx_copy</span><span class="o">-&gt;</span><span class="n">next_desc_logical</span><span class="p">;</span>
	<span class="o">--</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">free_tx_count</span><span class="p">;</span>
<span class="cp">#elif defined(two_buffer)</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">BPT</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">fealnx_desc</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>

		<span class="cm">/* for the first descriptor */</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">cur_tx_copy</span><span class="o">-&gt;</span><span class="n">buffer</span> <span class="o">=</span> <span class="n">pci_map_single</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span>
			<span class="n">BPT</span><span class="p">,</span> <span class="n">PCI_DMA_TODEVICE</span><span class="p">);</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">cur_tx_copy</span><span class="o">-&gt;</span><span class="n">control</span> <span class="o">=</span> <span class="n">TXIC</span> <span class="o">|</span> <span class="n">TXFD</span> <span class="o">|</span> <span class="n">CRCEnable</span> <span class="o">|</span> <span class="n">PADEnable</span><span class="p">;</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">cur_tx_copy</span><span class="o">-&gt;</span><span class="n">control</span> <span class="o">|=</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&lt;&lt;</span> <span class="n">PKTSShift</span><span class="p">);</span>	<span class="cm">/* pkt size */</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">cur_tx_copy</span><span class="o">-&gt;</span><span class="n">control</span> <span class="o">|=</span> <span class="p">(</span><span class="n">BPT</span> <span class="o">&lt;&lt;</span> <span class="n">TBSShift</span><span class="p">);</span>	<span class="cm">/* buffer size */</span>

		<span class="cm">/* for the last descriptor */</span>
		<span class="n">next</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">cur_tx_copy</span><span class="o">-&gt;</span><span class="n">next_desc_logical</span><span class="p">;</span>
		<span class="n">next</span><span class="o">-&gt;</span><span class="n">skbuff</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>
		<span class="n">next</span><span class="o">-&gt;</span><span class="n">control</span> <span class="o">=</span> <span class="n">TXIC</span> <span class="o">|</span> <span class="n">TXLD</span> <span class="o">|</span> <span class="n">CRCEnable</span> <span class="o">|</span> <span class="n">PADEnable</span><span class="p">;</span>
		<span class="n">next</span><span class="o">-&gt;</span><span class="n">control</span> <span class="o">|=</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&lt;&lt;</span> <span class="n">PKTSShift</span><span class="p">);</span>	<span class="cm">/* pkt size */</span>
		<span class="n">next</span><span class="o">-&gt;</span><span class="n">control</span> <span class="o">|=</span> <span class="p">((</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">-</span> <span class="n">BPT</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">TBSShift</span><span class="p">);</span>	<span class="cm">/* buf size */</span></pre></div></td></tr>


<tr id="section-10"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-10">&#182;</a></div><p>89/12/29 add,</p></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="mh">0x891</span><span class="p">)</span>
			<span class="n">np</span><span class="o">-&gt;</span><span class="n">cur_tx_copy</span><span class="o">-&gt;</span><span class="n">control</span> <span class="o">|=</span> <span class="n">ETIControl</span> <span class="o">|</span> <span class="n">RetryTxLC</span><span class="p">;</span>
		<span class="n">next</span><span class="o">-&gt;</span><span class="n">buffer</span> <span class="o">=</span> <span class="n">pci_map_single</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="n">BPT</span><span class="p">,</span>
                                <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">-</span> <span class="n">BPT</span><span class="p">,</span> <span class="n">PCI_DMA_TODEVICE</span><span class="p">);</span>

		<span class="n">next</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">TXOWN</span><span class="p">;</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">cur_tx_copy</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">TXOWN</span><span class="p">;</span>

		<span class="n">np</span><span class="o">-&gt;</span><span class="n">cur_tx_copy</span> <span class="o">=</span> <span class="n">next</span><span class="o">-&gt;</span><span class="n">next_desc_logical</span><span class="p">;</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">free_tx_count</span> <span class="o">-=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">cur_tx_copy</span><span class="o">-&gt;</span><span class="n">buffer</span> <span class="o">=</span> <span class="n">pci_map_single</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span>
			<span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">PCI_DMA_TODEVICE</span><span class="p">);</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">cur_tx_copy</span><span class="o">-&gt;</span><span class="n">control</span> <span class="o">=</span> <span class="n">TXIC</span> <span class="o">|</span> <span class="n">TXLD</span> <span class="o">|</span> <span class="n">TXFD</span> <span class="o">|</span> <span class="n">CRCEnable</span> <span class="o">|</span> <span class="n">PADEnable</span><span class="p">;</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">cur_tx_copy</span><span class="o">-&gt;</span><span class="n">control</span> <span class="o">|=</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&lt;&lt;</span> <span class="n">PKTSShift</span><span class="p">);</span>	<span class="cm">/* pkt size */</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">cur_tx_copy</span><span class="o">-&gt;</span><span class="n">control</span> <span class="o">|=</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&lt;&lt;</span> <span class="n">TBSShift</span><span class="p">);</span>	<span class="cm">/* buffer size */</span></pre></div></td></tr>


<tr id="section-11"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-11">&#182;</a></div><p>89/12/29 add,</p></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="mh">0x891</span><span class="p">)</span>
			<span class="n">np</span><span class="o">-&gt;</span><span class="n">cur_tx_copy</span><span class="o">-&gt;</span><span class="n">control</span> <span class="o">|=</span> <span class="n">ETIControl</span> <span class="o">|</span> <span class="n">RetryTxLC</span><span class="p">;</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">cur_tx_copy</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">TXOWN</span><span class="p">;</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">cur_tx_copy</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">cur_tx_copy</span><span class="o">-&gt;</span><span class="n">next_desc_logical</span><span class="p">;</span>
		<span class="o">--</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">free_tx_count</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">free_tx_count</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span>
		<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="o">++</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">really_tx_count</span><span class="p">;</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">mem</span> <span class="o">+</span> <span class="n">TXPDR</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">NETDEV_TX_OK</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* Take lock before calling */</span>
<span class="cm">/* Chip probably hosed tx ring. Clean up. */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">reset_tx_descriptors</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">netdev_private</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">fealnx_desc</span> <span class="o">*</span><span class="n">cur</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* initialize tx variables */</span>
	<span class="n">np</span><span class="o">-&gt;</span><span class="n">cur_tx</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">np</span><span class="o">-&gt;</span><span class="n">cur_tx_copy</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">np</span><span class="o">-&gt;</span><span class="n">really_tx_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">np</span><span class="o">-&gt;</span><span class="n">free_tx_count</span> <span class="o">=</span> <span class="n">TX_RING_SIZE</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">TX_RING_SIZE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cur</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">skbuff</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pci_unmap_single</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span> <span class="n">cur</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">,</span>
				<span class="n">cur</span><span class="o">-&gt;</span><span class="n">skbuff</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">PCI_DMA_TODEVICE</span><span class="p">);</span>
			<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">skbuff</span><span class="p">);</span>
			<span class="n">cur</span><span class="o">-&gt;</span><span class="n">skbuff</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">cur</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">cur</span><span class="o">-&gt;</span><span class="n">control</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* needed? */</span>
		<span class="cm">/* probably not needed. We do it for purely paranoid reasons */</span>
		<span class="n">cur</span><span class="o">-&gt;</span><span class="n">next_desc</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_ring_dma</span> <span class="o">+</span>
			<span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fealnx_desc</span><span class="p">);</span>
		<span class="n">cur</span><span class="o">-&gt;</span><span class="n">next_desc_logical</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
	<span class="p">}</span>
	<span class="cm">/* for the last tx descriptor */</span>
	<span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">[</span><span class="n">TX_RING_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">].</span><span class="n">next_desc</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_ring_dma</span><span class="p">;</span>
	<span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">[</span><span class="n">TX_RING_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">].</span><span class="n">next_desc_logical</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<span class="p">}</span>


<span class="cm">/* Take lock and stop rx before calling this */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">reset_rx_descriptors</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">netdev_private</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">fealnx_desc</span> <span class="o">*</span><span class="n">cur</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">cur_rx</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">allocate_rx_buffers</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">RX_RING_SIZE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">skbuff</span><span class="p">)</span>
			<span class="n">cur</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">RXOWN</span><span class="p">;</span>
		<span class="n">cur</span> <span class="o">=</span> <span class="n">cur</span><span class="o">-&gt;</span><span class="n">next_desc_logical</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">iowrite32</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_ring_dma</span> <span class="o">+</span> <span class="p">((</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">cur_rx</span> <span class="o">-</span> <span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">),</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">mem</span> <span class="o">+</span> <span class="n">RXLBA</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/* The interrupt handler does all of the Rx thread work and cleans up</span>
<span class="cm">   after the Tx thread. */</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">intr_handler</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_instance</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="p">)</span> <span class="n">dev_instance</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">netdev_private</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">boguscnt</span> <span class="o">=</span> <span class="n">max_interrupt_work</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">num_tx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">handled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">iowrite32</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">IMR</span><span class="p">);</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">intr_status</span> <span class="o">=</span> <span class="n">ioread32</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">ISR</span><span class="p">);</span>

		<span class="cm">/* Acknowledge all of the current interrupt sources ASAP. */</span>
		<span class="n">iowrite32</span><span class="p">(</span><span class="n">intr_status</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">ISR</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">debug</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: Interrupt, status %4.4x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
			       <span class="n">intr_status</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">intr_status</span> <span class="o">&amp;</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">imrvalue</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">handled</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-12"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-12">&#182;</a></div><p>90/1/16 delete,</p>

<pre><code> if (intr_status &amp; FBE)
 {   /* fatal error */
     stop_nic_tx(ioaddr, 0);
     stop_nic_rx(ioaddr, 0);
     break;
 };
</code></pre></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span><span class="n">intr_status</span> <span class="o">&amp;</span> <span class="n">TUNF</span><span class="p">)</span>
			<span class="n">iowrite32</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">TXPDR</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">intr_status</span> <span class="o">&amp;</span> <span class="n">CNTOVF</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* missed pkts */</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_missed_errors</span> <span class="o">+=</span>
				<span class="n">ioread32</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">TALLY</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7fff</span><span class="p">;</span>

			<span class="cm">/* crc error */</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_crc_errors</span> <span class="o">+=</span>
			    <span class="p">(</span><span class="n">ioread32</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">TALLY</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7fff0000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">intr_status</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">RI</span> <span class="o">|</span> <span class="n">RBU</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">intr_status</span> <span class="o">&amp;</span> <span class="n">RI</span><span class="p">)</span>
				<span class="n">netdev_rx</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="k">else</span> <span class="p">{</span>
				<span class="n">stop_nic_rx</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">crvalue</span><span class="p">);</span>
				<span class="n">reset_rx_descriptors</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
				<span class="n">iowrite32</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">crvalue</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">TCRRCR</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">while</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">really_tx_count</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">long</span> <span class="n">tx_status</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">cur_tx</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">;</span>
			<span class="kt">long</span> <span class="n">tx_control</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">cur_tx</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">tx_control</span> <span class="o">&amp;</span> <span class="n">TXLD</span><span class="p">))</span> <span class="p">{</span>	<span class="cm">/* this pkt is combined by two tx descriptors */</span>
				<span class="k">struct</span> <span class="n">fealnx_desc</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>

				<span class="n">next</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">cur_tx</span><span class="o">-&gt;</span><span class="n">next_desc_logical</span><span class="p">;</span>
				<span class="n">tx_status</span> <span class="o">=</span> <span class="n">next</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">;</span>
				<span class="n">tx_control</span> <span class="o">=</span> <span class="n">next</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">tx_status</span> <span class="o">&amp;</span> <span class="n">TXOWN</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">crvalue</span> <span class="o">&amp;</span> <span class="n">CR_W_ENH</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">tx_status</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">CSL</span> <span class="o">|</span> <span class="n">LC</span> <span class="o">|</span> <span class="n">EC</span> <span class="o">|</span> <span class="n">UDF</span> <span class="o">|</span> <span class="n">HF</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_errors</span><span class="o">++</span><span class="p">;</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">tx_status</span> <span class="o">&amp;</span> <span class="n">EC</span><span class="p">)</span>
						<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_aborted_errors</span><span class="o">++</span><span class="p">;</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">tx_status</span> <span class="o">&amp;</span> <span class="n">CSL</span><span class="p">)</span>
						<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_carrier_errors</span><span class="o">++</span><span class="p">;</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">tx_status</span> <span class="o">&amp;</span> <span class="n">LC</span><span class="p">)</span>
						<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_window_errors</span><span class="o">++</span><span class="p">;</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">tx_status</span> <span class="o">&amp;</span> <span class="n">UDF</span><span class="p">)</span>
						<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_fifo_errors</span><span class="o">++</span><span class="p">;</span>
					<span class="k">if</span> <span class="p">((</span><span class="n">tx_status</span> <span class="o">&amp;</span> <span class="n">HF</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">mii</span><span class="p">.</span><span class="n">full_duplex</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
						<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_heartbeat_errors</span><span class="o">++</span><span class="p">;</span>

				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_bytes</span> <span class="o">+=</span>
					    <span class="p">((</span><span class="n">tx_control</span> <span class="o">&amp;</span> <span class="n">PKTSMask</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">PKTSShift</span><span class="p">);</span>

					<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">collisions</span> <span class="o">+=</span>
					    <span class="p">((</span><span class="n">tx_status</span> <span class="o">&amp;</span> <span class="n">NCRMask</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">NCRShift</span><span class="p">);</span>
					<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_packets</span><span class="o">++</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_bytes</span> <span class="o">+=</span>
				    <span class="p">((</span><span class="n">tx_control</span> <span class="o">&amp;</span> <span class="n">PKTSMask</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">PKTSShift</span><span class="p">);</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_packets</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="cm">/* Free the original skb. */</span>
			<span class="n">pci_unmap_single</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">cur_tx</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">,</span>
				<span class="n">np</span><span class="o">-&gt;</span><span class="n">cur_tx</span><span class="o">-&gt;</span><span class="n">skbuff</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">PCI_DMA_TODEVICE</span><span class="p">);</span>
			<span class="n">dev_kfree_skb_irq</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">cur_tx</span><span class="o">-&gt;</span><span class="n">skbuff</span><span class="p">);</span>
			<span class="n">np</span><span class="o">-&gt;</span><span class="n">cur_tx</span><span class="o">-&gt;</span><span class="n">skbuff</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="o">--</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">really_tx_count</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">cur_tx</span><span class="o">-&gt;</span><span class="n">control</span> <span class="o">&amp;</span> <span class="n">TXLD</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">np</span><span class="o">-&gt;</span><span class="n">cur_tx</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">cur_tx</span><span class="o">-&gt;</span><span class="n">next_desc_logical</span><span class="p">;</span>
				<span class="o">++</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">free_tx_count</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">np</span><span class="o">-&gt;</span><span class="n">cur_tx</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">cur_tx</span><span class="o">-&gt;</span><span class="n">next_desc_logical</span><span class="p">;</span>
				<span class="n">np</span><span class="o">-&gt;</span><span class="n">cur_tx</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">cur_tx</span><span class="o">-&gt;</span><span class="n">next_desc_logical</span><span class="p">;</span>
				<span class="n">np</span><span class="o">-&gt;</span><span class="n">free_tx_count</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">num_tx</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>		<span class="cm">/* end of for loop */</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">num_tx</span> <span class="o">&amp;&amp;</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">free_tx_count</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">)</span>
			<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

		<span class="cm">/* read transmit status for enhanced mode only */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">crvalue</span> <span class="o">&amp;</span> <span class="n">CR_W_ENH</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">long</span> <span class="n">data</span><span class="p">;</span>

			<span class="n">data</span> <span class="o">=</span> <span class="n">ioread32</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">TSR</span><span class="p">);</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_errors</span> <span class="o">+=</span> <span class="p">(</span><span class="n">data</span> <span class="o">&amp;</span> <span class="mh">0xff000000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">;</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_aborted_errors</span> <span class="o">+=</span>
				<span class="p">(</span><span class="n">data</span> <span class="o">&amp;</span> <span class="mh">0xff000000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">;</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_window_errors</span> <span class="o">+=</span>
				<span class="p">(</span><span class="n">data</span> <span class="o">&amp;</span> <span class="mh">0x00ff0000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">;</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">collisions</span> <span class="o">+=</span> <span class="p">(</span><span class="n">data</span> <span class="o">&amp;</span> <span class="mh">0x0000ffff</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">--</span><span class="n">boguscnt</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: Too much work at interrupt, &quot;</span>
			       <span class="s">&quot;status=0x%4.4x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">intr_status</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">reset_timer_armed</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">np</span><span class="o">-&gt;</span><span class="n">reset_timer_armed</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">np</span><span class="o">-&gt;</span><span class="n">reset_timer</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span> <span class="n">RUN_AT</span><span class="p">(</span><span class="n">HZ</span><span class="o">/</span><span class="mi">2</span><span class="p">);</span>
				<span class="n">add_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">reset_timer</span><span class="p">);</span>
				<span class="n">stop_nic_rxtx</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
				<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
				<span class="cm">/* or netif_tx_disable(dev); ?? */</span>
				<span class="cm">/* Prevent other paths from enabling tx,rx,intrs */</span>
				<span class="n">np</span><span class="o">-&gt;</span><span class="n">crvalue_sv</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">crvalue</span><span class="p">;</span>
				<span class="n">np</span><span class="o">-&gt;</span><span class="n">imrvalue_sv</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">imrvalue</span><span class="p">;</span>
				<span class="n">np</span><span class="o">-&gt;</span><span class="n">crvalue</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">CR_W_TXEN</span> <span class="o">|</span> <span class="n">CR_W_RXEN</span><span class="p">);</span> <span class="cm">/* or simply = 0? */</span>
				<span class="n">np</span><span class="o">-&gt;</span><span class="n">imrvalue</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* read the tally counters */</span>
	<span class="cm">/* missed pkts */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_missed_errors</span> <span class="o">+=</span> <span class="n">ioread32</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">TALLY</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7fff</span><span class="p">;</span>

	<span class="cm">/* crc error */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_crc_errors</span> <span class="o">+=</span>
		<span class="p">(</span><span class="n">ioread32</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">TALLY</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7fff0000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">debug</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: exiting interrupt, status=%#4.4x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ioread32</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">ISR</span><span class="p">));</span>

	<span class="n">iowrite32</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">imrvalue</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">IMR</span><span class="p">);</span>

	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">IRQ_RETVAL</span><span class="p">(</span><span class="n">handled</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/* This routine is logically part of the interrupt handler, but separated</span>
<span class="cm">   for clarity and better register allocation. */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">netdev_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">netdev_private</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">;</span>

	<span class="cm">/* If EOP is set on the next entry, it&#39;s a new packet. Send it up. */</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">cur_rx</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">RXOWN</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">cur_rx</span><span class="o">-&gt;</span><span class="n">skbuff</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">s32</span> <span class="n">rx_status</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">cur_rx</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">really_rx_count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">debug</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;  netdev_rx() status was %8.8x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rx_status</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="p">((</span><span class="n">rx_status</span> <span class="o">&amp;</span> <span class="n">RXFSD</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">rx_status</span> <span class="o">&amp;</span> <span class="n">RXLSD</span><span class="p">)))</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">rx_status</span> <span class="o">&amp;</span> <span class="n">ErrorSummary</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rx_status</span> <span class="o">&amp;</span> <span class="n">ErrorSummary</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* there was a fatal error */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">debug</span><span class="p">)</span>
					<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span>
					       <span class="s">&quot;%s: Receive error, Rx status %8.8x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">rx_status</span><span class="p">);</span>

				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_errors</span><span class="o">++</span><span class="p">;</span>	<span class="cm">/* end of a packet. */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">rx_status</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">LONG</span> <span class="o">|</span> <span class="n">RUNT</span><span class="p">))</span>
					<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_length_errors</span><span class="o">++</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">rx_status</span> <span class="o">&amp;</span> <span class="n">RXER</span><span class="p">)</span>
					<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_frame_errors</span><span class="o">++</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">rx_status</span> <span class="o">&amp;</span> <span class="n">CRC</span><span class="p">)</span>
					<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_crc_errors</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="kt">int</span> <span class="n">need_to_reset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="kt">int</span> <span class="n">desno</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">rx_status</span> <span class="o">&amp;</span> <span class="n">RXFSD</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* this pkt is too long, over one rx buffer */</span>
					<span class="k">struct</span> <span class="n">fealnx_desc</span> <span class="o">*</span><span class="n">cur</span><span class="p">;</span>

					<span class="cm">/* check this packet is received completely? */</span>
					<span class="n">cur</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">cur_rx</span><span class="p">;</span>
					<span class="k">while</span> <span class="p">(</span><span class="n">desno</span> <span class="o">&lt;=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">really_rx_count</span><span class="p">)</span> <span class="p">{</span>
						<span class="o">++</span><span class="n">desno</span><span class="p">;</span>
						<span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="p">(</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">RXOWN</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
						    <span class="p">(</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">RXLSD</span><span class="p">))</span>
							<span class="k">break</span><span class="p">;</span>
						<span class="cm">/* goto next rx descriptor */</span>
						<span class="n">cur</span> <span class="o">=</span> <span class="n">cur</span><span class="o">-&gt;</span><span class="n">next_desc_logical</span><span class="p">;</span>
					<span class="p">}</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">desno</span> <span class="o">&gt;</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">really_rx_count</span><span class="p">)</span>
						<span class="n">need_to_reset</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span>	<span class="cm">/* RXLSD did not find, something error */</span>
					<span class="n">need_to_reset</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">need_to_reset</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
					<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

					<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_length_errors</span><span class="o">++</span><span class="p">;</span>

					<span class="cm">/* free all rx descriptors related this long pkt */</span>
					<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">desno</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
						<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">cur_rx</span><span class="o">-&gt;</span><span class="n">skbuff</span><span class="p">)</span> <span class="p">{</span>
							<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span>
								<span class="s">&quot;%s: I&#39;m scared</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
							<span class="k">break</span><span class="p">;</span>
						<span class="p">}</span>
						<span class="n">np</span><span class="o">-&gt;</span><span class="n">cur_rx</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">RXOWN</span><span class="p">;</span>
						<span class="n">np</span><span class="o">-&gt;</span><span class="n">cur_rx</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">cur_rx</span><span class="o">-&gt;</span><span class="n">next_desc_logical</span><span class="p">;</span>
					<span class="p">}</span>
					<span class="k">continue</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>        <span class="cm">/* rx error, need to reset this chip */</span>
					<span class="n">stop_nic_rx</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">crvalue</span><span class="p">);</span>
					<span class="n">reset_rx_descriptors</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
					<span class="n">iowrite32</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">crvalue</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">TCRRCR</span><span class="p">);</span>
				<span class="p">}</span>
				<span class="k">break</span><span class="p">;</span>	<span class="cm">/* exit the while loop */</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>	<span class="cm">/* this received pkt is ok */</span>

			<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
			<span class="cm">/* Omit the four octet CRC from the length. */</span>
			<span class="kt">short</span> <span class="n">pkt_len</span> <span class="o">=</span> <span class="p">((</span><span class="n">rx_status</span> <span class="o">&amp;</span> <span class="n">FLNGMASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">FLNGShift</span><span class="p">)</span> <span class="o">-</span> <span class="mi">4</span><span class="p">;</span>

<span class="cp">#ifndef final_version</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">debug</span><span class="p">)</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;  netdev_rx() normal Rx pkt length %d&quot;</span>
				       <span class="s">&quot; status %x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pkt_len</span><span class="p">,</span> <span class="n">rx_status</span><span class="p">);</span>
<span class="cp">#endif</span>

			<span class="cm">/* Check if the packet is long enough to accept without copying</span>
<span class="cm">			   to a minimally-sized skbuff. */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pkt_len</span> <span class="o">&lt;</span> <span class="n">rx_copybreak</span> <span class="o">&amp;&amp;</span>
			    <span class="p">(</span><span class="n">skb</span> <span class="o">=</span> <span class="n">netdev_alloc_skb</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">pkt_len</span> <span class="o">+</span> <span class="mi">2</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">skb_reserve</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>	<span class="cm">/* 16 byte align the IP header */</span>
				<span class="n">pci_dma_sync_single_for_cpu</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span>
							    <span class="n">np</span><span class="o">-&gt;</span><span class="n">cur_rx</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">,</span>
							    <span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_buf_sz</span><span class="p">,</span>
							    <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>
				<span class="cm">/* Call copy + cksum if available. */</span>

<span class="cp">#if ! defined(__alpha__)</span>
				<span class="n">skb_copy_to_linear_data</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span>
					<span class="n">np</span><span class="o">-&gt;</span><span class="n">cur_rx</span><span class="o">-&gt;</span><span class="n">skbuff</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">pkt_len</span><span class="p">);</span>
				<span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">pkt_len</span><span class="p">);</span>
<span class="cp">#else</span>
				<span class="n">memcpy</span><span class="p">(</span><span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">pkt_len</span><span class="p">),</span>
					<span class="n">np</span><span class="o">-&gt;</span><span class="n">cur_rx</span><span class="o">-&gt;</span><span class="n">skbuff</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">pkt_len</span><span class="p">);</span>
<span class="cp">#endif</span>
				<span class="n">pci_dma_sync_single_for_device</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span>
							       <span class="n">np</span><span class="o">-&gt;</span><span class="n">cur_rx</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">,</span>
							       <span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_buf_sz</span><span class="p">,</span>
							       <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">pci_unmap_single</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span>
						 <span class="n">np</span><span class="o">-&gt;</span><span class="n">cur_rx</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">,</span>
						 <span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_buf_sz</span><span class="p">,</span>
						 <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>
				<span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">cur_rx</span><span class="o">-&gt;</span><span class="n">skbuff</span><span class="p">,</span> <span class="n">pkt_len</span><span class="p">);</span>
				<span class="n">np</span><span class="o">-&gt;</span><span class="n">cur_rx</span><span class="o">-&gt;</span><span class="n">skbuff</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
				<span class="o">--</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">really_rx_count</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">skb</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">eth_type_trans</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
			<span class="n">netif_rx</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_packets</span><span class="o">++</span><span class="p">;</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_bytes</span> <span class="o">+=</span> <span class="n">pkt_len</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">np</span><span class="o">-&gt;</span><span class="n">cur_rx</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">cur_rx</span><span class="o">-&gt;</span><span class="n">next_desc_logical</span><span class="p">;</span>
	<span class="p">}</span>			<span class="cm">/* end of while loop */</span>

	<span class="cm">/*  allocate skb for rx buffers */</span>
	<span class="n">allocate_rx_buffers</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="k">struct</span> <span class="n">net_device_stats</span> <span class="o">*</span><span class="nf">get_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">netdev_private</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">;</span>

	<span class="cm">/* The chip only need report frame silently dropped. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">netif_running</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_missed_errors</span> <span class="o">+=</span>
			<span class="n">ioread32</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">TALLY</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7fff</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_crc_errors</span> <span class="o">+=</span>
			<span class="p">(</span><span class="n">ioread32</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">TALLY</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7fff0000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* for dev-&gt;set_multicast_list */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">set_rx_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">spinlock_t</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">((</span><span class="k">struct</span> <span class="n">netdev_private</span> <span class="o">*</span><span class="p">)</span><span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="n">lp</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">__set_rx_mode</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="n">lp</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/* Take lock before calling */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">__set_rx_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">netdev_private</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">mc_filter</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>	<span class="cm">/* Multicast hash filter */</span>
	<span class="n">u32</span> <span class="n">rx_mode</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_PROMISC</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* Set promiscuous. */</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">mc_filter</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mc_filter</span><span class="p">));</span>
		<span class="n">rx_mode</span> <span class="o">=</span> <span class="n">CR_W_PROM</span> <span class="o">|</span> <span class="n">CR_W_AB</span> <span class="o">|</span> <span class="n">CR_W_AM</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">netdev_mc_count</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">multicast_filter_limit</span><span class="p">)</span> <span class="o">||</span>
		   <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_ALLMULTI</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Too many to match, or accept all multicasts. */</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">mc_filter</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mc_filter</span><span class="p">));</span>
		<span class="n">rx_mode</span> <span class="o">=</span> <span class="n">CR_W_AB</span> <span class="o">|</span> <span class="n">CR_W_AM</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">netdev_hw_addr</span> <span class="o">*</span><span class="n">ha</span><span class="p">;</span>

		<span class="n">memset</span><span class="p">(</span><span class="n">mc_filter</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mc_filter</span><span class="p">));</span>
		<span class="n">netdev_for_each_mc_addr</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bit</span><span class="p">;</span>
			<span class="n">bit</span> <span class="o">=</span> <span class="p">(</span><span class="n">ether_crc</span><span class="p">(</span><span class="n">ETH_ALEN</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">26</span><span class="p">)</span> <span class="o">^</span> <span class="mh">0x3F</span><span class="p">;</span>
			<span class="n">mc_filter</span><span class="p">[</span><span class="n">bit</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span><span class="p">]</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">bit</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">rx_mode</span> <span class="o">=</span> <span class="n">CR_W_AB</span> <span class="o">|</span> <span class="n">CR_W_AM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">stop_nic_rxtx</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">crvalue</span><span class="p">);</span>

	<span class="n">iowrite32</span><span class="p">(</span><span class="n">mc_filter</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">MAR0</span><span class="p">);</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="n">mc_filter</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">MAR1</span><span class="p">);</span>
	<span class="n">np</span><span class="o">-&gt;</span><span class="n">crvalue</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">CR_W_RXMODEMASK</span><span class="p">;</span>
	<span class="n">np</span><span class="o">-&gt;</span><span class="n">crvalue</span> <span class="o">|=</span> <span class="n">rx_mode</span><span class="p">;</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">crvalue</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">TCRRCR</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">netdev_get_drvinfo</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ethtool_drvinfo</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">netdev_private</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">strlcpy</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">,</span> <span class="n">DRV_NAME</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">));</span>
	<span class="n">strlcpy</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">,</span> <span class="n">DRV_VERSION</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">));</span>
	<span class="n">strlcpy</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">bus_info</span><span class="p">,</span> <span class="n">pci_name</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">),</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">bus_info</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">netdev_get_settings</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ethtool_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">netdev_private</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">mii_ethtool_gset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">mii</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">netdev_set_settings</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ethtool_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">netdev_private</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">mii_ethtool_sset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">mii</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">netdev_nway_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">netdev_private</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">mii_nway_restart</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">mii</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">netdev_get_link</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">netdev_private</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">mii_link_ok</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">mii</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">netdev_get_msglevel</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">debug</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">netdev_set_msglevel</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">debug</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ethtool_ops</span> <span class="n">netdev_ethtool_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">get_drvinfo</span>		<span class="o">=</span> <span class="n">netdev_get_drvinfo</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_settings</span>		<span class="o">=</span> <span class="n">netdev_get_settings</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_settings</span>		<span class="o">=</span> <span class="n">netdev_set_settings</span><span class="p">,</span>
	<span class="p">.</span><span class="n">nway_reset</span>		<span class="o">=</span> <span class="n">netdev_nway_reset</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_link</span>		<span class="o">=</span> <span class="n">netdev_get_link</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_msglevel</span>		<span class="o">=</span> <span class="n">netdev_get_msglevel</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_msglevel</span>		<span class="o">=</span> <span class="n">netdev_set_msglevel</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mii_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ifreq</span> <span class="o">*</span><span class="n">rq</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">netdev_private</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">netif_running</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">generic_mii_ioctl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">mii</span><span class="p">,</span> <span class="n">if_mii</span><span class="p">(</span><span class="n">rq</span><span class="p">),</span> <span class="n">cmd</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">netdev_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">netdev_private</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* Disable interrupts by clearing the interrupt mask. */</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="mh">0x0000</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">IMR</span><span class="p">);</span>

	<span class="cm">/* Stop the chip&#39;s Tx and Rx processes. */</span>
	<span class="n">stop_nic_rxtx</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
	<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">reset_timer</span><span class="p">);</span>

	<span class="n">free_irq</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* Free all the skbuffs in the Rx queue. */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">RX_RING_SIZE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">skbuff</span><span class="p">;</span>

		<span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pci_unmap_single</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">buffer</span><span class="p">,</span>
				<span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_buf_sz</span><span class="p">,</span> <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>
			<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
			<span class="n">np</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">skbuff</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">TX_RING_SIZE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">skbuff</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pci_unmap_single</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">buffer</span><span class="p">,</span>
				<span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">PCI_DMA_TODEVICE</span><span class="p">);</span>
			<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
			<span class="n">np</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">skbuff</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DEFINE_PCI_DEVICE_TABLE</span><span class="p">(</span><span class="n">fealnx_pci_tbl</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span><span class="mh">0x1516</span><span class="p">,</span> <span class="mh">0x0800</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x1516</span><span class="p">,</span> <span class="mh">0x0803</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x1516</span><span class="p">,</span> <span class="mh">0x0891</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">},</span>
	<span class="p">{}</span> <span class="cm">/* terminate list */</span>
<span class="p">};</span>
<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">fealnx_pci_tbl</span><span class="p">);</span>


<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_driver</span> <span class="n">fealnx_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;fealnx&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span>	<span class="o">=</span> <span class="n">fealnx_pci_tbl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span>		<span class="o">=</span> <span class="n">fealnx_init_one</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>		<span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">fealnx_remove_one</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">fealnx_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="cm">/* when a module, this is printed whether or not devices are found in probe */</span>
<span class="cp">#ifdef MODULE</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">version</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="k">return</span> <span class="n">pci_register_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fealnx_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">fealnx_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pci_unregister_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fealnx_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">fealnx_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">fealnx_exit</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
