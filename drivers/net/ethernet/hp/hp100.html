<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › ethernet › hp › hp100.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>hp100.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm">** hp100.c</span>
<span class="cm">** HP CASCADE Architecture Driver for 100VG-AnyLan Network Adapters</span>
<span class="cm">**</span>
<span class="cm">** $Id: hp100.c,v 1.58 2001/09/24 18:03:01 perex Exp perex $</span>
<span class="cm">**</span>
<span class="cm">** Based on the HP100 driver written by Jaroslav Kysela &lt;perex@jcu.cz&gt;</span>
<span class="cm">** Extended for new busmaster capable chipsets by</span>
<span class="cm">** Siegfried &quot;Frieder&quot; Loeffler (dg1sek) &lt;floeff@mathematik.uni-stuttgart.de&gt;</span>
<span class="cm">**</span>
<span class="cm">** Maintained by: Jaroslav Kysela &lt;perex@perex.cz&gt;</span>
<span class="cm">**</span>
<span class="cm">** This driver has only been tested with</span>
<span class="cm">** -- HP J2585B 10/100 Mbit/s PCI Busmaster</span>
<span class="cm">** -- HP J2585A 10/100 Mbit/s PCI</span>
<span class="cm">** -- HP J2970A 10 Mbit/s PCI Combo 10base-T/BNC</span>
<span class="cm">** -- HP J2973A 10 Mbit/s PCI 10base-T</span>
<span class="cm">** -- HP J2573  10/100 ISA</span>
<span class="cm">** -- Compex ReadyLink ENET100-VG4  10/100 Mbit/s PCI / EISA</span>
<span class="cm">** -- Compex FreedomLine 100/VG  10/100 Mbit/s ISA / EISA / PCI</span>
<span class="cm">**</span>
<span class="cm">** but it should also work with the other CASCADE based adapters.</span>
<span class="cm">**</span>
<span class="cm">** TODO:</span>
<span class="cm">**       -  J2573 seems to hang sometimes when in shared memory mode.</span>
<span class="cm">**       -  Mode for Priority TX</span>
<span class="cm">**       -  Check PCI registers, performance might be improved?</span>
<span class="cm">**       -  To reduce interrupt load in busmaster, one could switch off</span>
<span class="cm">**          the interrupts that are used to refill the queues whenever the</span>
<span class="cm">**          queues are filled up to more than a certain threshold.</span>
<span class="cm">**       -  some updates for EISA version of card</span>
<span class="cm">**</span>
<span class="cm">**</span>
<span class="cm">**   This code is free software; you can redistribute it and/or modify</span>
<span class="cm">**   it under the terms of the GNU General Public License as published by</span>
<span class="cm">**   the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm">**   (at your option) any later version.</span>
<span class="cm">**</span>
<span class="cm">**   This code is distributed in the hope that it will be useful,</span>
<span class="cm">**   but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm">**   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm">**   GNU General Public License for more details.</span>
<span class="cm">**</span>
<span class="cm">**   You should have received a copy of the GNU General Public License</span>
<span class="cm">**   along with this program; if not, write to the Free Software</span>
<span class="cm">**   Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.</span>
<span class="cm">**</span>
<span class="cm">** 1.57c -&gt; 1.58</span>
<span class="cm">**   - used indent to change coding-style</span>
<span class="cm">**   - added KTI DP-200 EISA ID</span>
<span class="cm">**   - ioremap is also used for low (&lt;1MB) memory (multi-architecture support)</span>
<span class="cm">**</span>
<span class="cm">** 1.57b -&gt; 1.57c - Arnaldo Carvalho de Melo &lt;acme@conectiva.com.br&gt;</span>
<span class="cm">**   - release resources on failure in init_module</span>
<span class="cm">**</span>
<span class="cm">** 1.57 -&gt; 1.57b - Jean II</span>
<span class="cm">**   - fix spinlocks, SMP is now working !</span>
<span class="cm">**</span>
<span class="cm">** 1.56 -&gt; 1.57</span>
<span class="cm">**   - updates for new PCI interface for 2.1 kernels</span>
<span class="cm">**</span>
<span class="cm">** 1.55 -&gt; 1.56</span>
<span class="cm">**   - removed printk in misc. interrupt and update statistics to allow</span>
<span class="cm">**     monitoring of card status</span>
<span class="cm">**   - timing changes in xmit routines, relogin to 100VG hub added when</span>
<span class="cm">**     driver does reset</span>
<span class="cm">**   - included fix for Compex FreedomLine PCI adapter</span>
<span class="cm">**</span>
<span class="cm">** 1.54 -&gt; 1.55</span>
<span class="cm">**   - fixed bad initialization in init_module</span>
<span class="cm">**   - added Compex FreedomLine adapter</span>
<span class="cm">**   - some fixes in card initialization</span>
<span class="cm">**</span>
<span class="cm">** 1.53 -&gt; 1.54</span>
<span class="cm">**   - added hardware multicast filter support (doesn&#39;t work)</span>
<span class="cm">**   - little changes in hp100_sense_lan routine</span>
<span class="cm">**     - added support for Coax and AUI (J2970)</span>
<span class="cm">**   - fix for multiple cards and hp100_mode parameter (insmod)</span>
<span class="cm">**   - fix for shared IRQ</span>
<span class="cm">**</span>
<span class="cm">** 1.52 -&gt; 1.53</span>
<span class="cm">**   - fixed bug in multicast support</span>
<span class="cm">**</span>
<span class="cm">*/</span>

<span class="cp">#define HP100_DEFAULT_PRIORITY_TX 0</span>

<span class="cp">#undef HP100_DEBUG</span>
<span class="cp">#undef HP100_DEBUG_B		</span><span class="cm">/* Trace  */</span><span class="cp"></span>
<span class="cp">#undef HP100_DEBUG_BM		</span><span class="cm">/* Debug busmaster code (PDL stuff) */</span><span class="cp"></span>

<span class="cp">#undef HP100_DEBUG_TRAINING	</span><span class="cm">/* Debug login-to-hub procedure */</span><span class="cp"></span>
<span class="cp">#undef HP100_DEBUG_TX</span>
<span class="cp">#undef HP100_DEBUG_IRQ</span>
<span class="cp">#undef HP100_DEBUG_RX</span>

<span class="cp">#undef HP100_MULTICAST_FILTER	</span><span class="cm">/* Need to be debugged... */</span><span class="cp"></span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/ioport.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/eisa.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/dma-mapping.h&gt;</span>
<span class="cp">#include &lt;linux/spinlock.h&gt;</span>
<span class="cp">#include &lt;linux/netdevice.h&gt;</span>
<span class="cp">#include &lt;linux/etherdevice.h&gt;</span>
<span class="cp">#include &lt;linux/skbuff.h&gt;</span>
<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/bitops.h&gt;</span>
<span class="cp">#include &lt;linux/jiffies.h&gt;</span>

<span class="cp">#include &lt;asm/io.h&gt;</span>

<span class="cp">#include &quot;hp100.h&quot;</span>

<span class="cm">/*</span>
<span class="cm"> *  defines</span>
<span class="cm"> */</span>

<span class="cp">#define HP100_BUS_ISA     0</span>
<span class="cp">#define HP100_BUS_EISA    1</span>
<span class="cp">#define HP100_BUS_PCI     2</span>

<span class="cp">#define HP100_REGION_SIZE	0x20	</span><span class="cm">/* for ioports */</span><span class="cp"></span>
<span class="cp">#define HP100_SIG_LEN		8	</span><span class="cm">/* same as EISA_SIG_LEN */</span><span class="cp"></span>

<span class="cp">#define HP100_MAX_PACKET_SIZE	(1536+4)</span>
<span class="cp">#define HP100_MIN_PACKET_SIZE	60</span>

<span class="cp">#ifndef HP100_DEFAULT_RX_RATIO</span>
<span class="cm">/* default - 75% onboard memory on the card are used for RX packets */</span>
<span class="cp">#define HP100_DEFAULT_RX_RATIO	75</span>
<span class="cp">#endif</span>

<span class="cp">#ifndef HP100_DEFAULT_PRIORITY_TX</span>
<span class="cm">/* default - don&#39;t enable transmit outgoing packets as priority */</span>
<span class="cp">#define HP100_DEFAULT_PRIORITY_TX 0</span>
<span class="cp">#endif</span>

<span class="cm">/*</span>
<span class="cm"> *  structures</span>
<span class="cm"> */</span>

<span class="k">struct</span> <span class="n">hp100_private</span> <span class="p">{</span>
	<span class="n">spinlock_t</span> <span class="n">lock</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">id</span><span class="p">[</span><span class="n">HP100_SIG_LEN</span><span class="p">];</span>
	<span class="n">u_short</span> <span class="n">chip</span><span class="p">;</span>
	<span class="n">u_short</span> <span class="n">soft_model</span><span class="p">;</span>
	<span class="n">u_int</span> <span class="n">memory_size</span><span class="p">;</span>
	<span class="n">u_int</span> <span class="n">virt_memory_size</span><span class="p">;</span>
	<span class="n">u_short</span> <span class="n">rx_ratio</span><span class="p">;</span>	<span class="cm">/* 1 - 99 */</span>
	<span class="n">u_short</span> <span class="n">priority_tx</span><span class="p">;</span>	<span class="cm">/* != 0 - priority tx */</span>
	<span class="n">u_short</span> <span class="n">mode</span><span class="p">;</span>		<span class="cm">/* PIO, Shared Mem or Busmaster */</span>
	<span class="n">u_char</span> <span class="n">bus</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pci_dev</span><span class="p">;</span>
	<span class="kt">short</span> <span class="n">mem_mapped</span><span class="p">;</span>	<span class="cm">/* memory mapped access */</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">mem_ptr_virt</span><span class="p">;</span>	<span class="cm">/* virtual memory mapped area, maybe NULL */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">mem_ptr_phys</span><span class="p">;</span>	<span class="cm">/* physical memory mapped area */</span>
	<span class="kt">short</span> <span class="n">lan_type</span><span class="p">;</span>		<span class="cm">/* 10Mb/s, 100Mb/s or -1 (error) */</span>
	<span class="kt">int</span> <span class="n">hub_status</span><span class="p">;</span>		<span class="cm">/* was login to hub successful? */</span>
	<span class="n">u_char</span> <span class="n">mac1_mode</span><span class="p">;</span>
	<span class="n">u_char</span> <span class="n">mac2_mode</span><span class="p">;</span>
	<span class="n">u_char</span> <span class="n">hash_bytes</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>

	<span class="cm">/* Rings for busmaster mode: */</span>
	<span class="n">hp100_ring_t</span> <span class="o">*</span><span class="n">rxrhead</span><span class="p">;</span>	<span class="cm">/* Head (oldest) index into rxring */</span>
	<span class="n">hp100_ring_t</span> <span class="o">*</span><span class="n">rxrtail</span><span class="p">;</span>	<span class="cm">/* Tail (newest) index into rxring */</span>
	<span class="n">hp100_ring_t</span> <span class="o">*</span><span class="n">txrhead</span><span class="p">;</span>	<span class="cm">/* Head (oldest) index into txring */</span>
	<span class="n">hp100_ring_t</span> <span class="o">*</span><span class="n">txrtail</span><span class="p">;</span>	<span class="cm">/* Tail (newest) index into txring */</span>

	<span class="n">hp100_ring_t</span> <span class="n">rxring</span><span class="p">[</span><span class="n">MAX_RX_PDL</span><span class="p">];</span>
	<span class="n">hp100_ring_t</span> <span class="n">txring</span><span class="p">[</span><span class="n">MAX_TX_PDL</span><span class="p">];</span>

	<span class="n">u_int</span> <span class="o">*</span><span class="n">page_vaddr_algn</span><span class="p">;</span>	<span class="cm">/* Aligned virtual address of allocated page */</span>
	<span class="n">u_long</span> <span class="n">whatever_offset</span><span class="p">;</span>	<span class="cm">/* Offset to bus/phys/dma address */</span>
	<span class="kt">int</span> <span class="n">rxrcommit</span><span class="p">;</span>		<span class="cm">/* # Rx PDLs committed to adapter */</span>
	<span class="kt">int</span> <span class="n">txrcommit</span><span class="p">;</span>		<span class="cm">/* # Tx PDLs committed to adapter */</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> *  variables</span>
<span class="cm"> */</span>
<span class="cp">#ifdef CONFIG_ISA</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">hp100_isa_tbl</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="s">&quot;HWPF150&quot;</span><span class="p">,</span> <span class="cm">/* HP J2573 rev A */</span>
	<span class="s">&quot;HWP1950&quot;</span><span class="p">,</span> <span class="cm">/* HP J2573 */</span>
<span class="p">};</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_EISA</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">eisa_device_id</span> <span class="n">hp100_eisa_tbl</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="s">&quot;HWPF180&quot;</span> <span class="p">},</span> <span class="cm">/* HP J2577 rev A */</span>
	<span class="p">{</span> <span class="s">&quot;HWP1920&quot;</span> <span class="p">},</span> <span class="cm">/* HP 27248B */</span>
	<span class="p">{</span> <span class="s">&quot;HWP1940&quot;</span> <span class="p">},</span> <span class="cm">/* HP J2577 */</span>
	<span class="p">{</span> <span class="s">&quot;HWP1990&quot;</span> <span class="p">},</span> <span class="cm">/* HP J2577 */</span>
	<span class="p">{</span> <span class="s">&quot;CPX0301&quot;</span> <span class="p">},</span> <span class="cm">/* ReadyLink ENET100-VG4 */</span>
	<span class="p">{</span> <span class="s">&quot;CPX0401&quot;</span> <span class="p">},</span> <span class="cm">/* FreedomLine 100/VG */</span>
	<span class="p">{</span> <span class="s">&quot;&quot;</span> <span class="p">}</span>	       <span class="cm">/* Mandatory final entry ! */</span>
<span class="p">};</span>
<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">eisa</span><span class="p">,</span> <span class="n">hp100_eisa_tbl</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_PCI</span>
<span class="k">static</span> <span class="n">DEFINE_PCI_DEVICE_TABLE</span><span class="p">(</span><span class="n">hp100_pci_tbl</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span><span class="n">PCI_VENDOR_ID_HP</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_HP_J2585A</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,},</span>
	<span class="p">{</span><span class="n">PCI_VENDOR_ID_HP</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_HP_J2585B</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,},</span>
	<span class="p">{</span><span class="n">PCI_VENDOR_ID_HP</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_HP_J2970A</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,},</span>
	<span class="p">{</span><span class="n">PCI_VENDOR_ID_HP</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_HP_J2973A</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,},</span>
	<span class="p">{</span><span class="n">PCI_VENDOR_ID_COMPEX</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_COMPEX_ENET100VG4</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,},</span>
	<span class="p">{</span><span class="n">PCI_VENDOR_ID_COMPEX2</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_COMPEX2_100VG</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,},</span>
<span class="cm">/*	{PCI_VENDOR_ID_KTI, PCI_DEVICE_ID_KTI_DP200, PCI_ANY_ID, PCI_ANY_ID }, */</span>
	<span class="p">{}</span>			<span class="cm">/* Terminating entry */</span>
<span class="p">};</span>
<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">hp100_pci_tbl</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">hp100_rx_ratio</span> <span class="o">=</span> <span class="n">HP100_DEFAULT_RX_RATIO</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">hp100_priority_tx</span> <span class="o">=</span> <span class="n">HP100_DEFAULT_PRIORITY_TX</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">hp100_mode</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

<span class="n">module_param</span><span class="p">(</span><span class="n">hp100_rx_ratio</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">hp100_priority_tx</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">hp100_mode</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> *  prototypes</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">hp100_probe1</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ioaddr</span><span class="p">,</span> <span class="n">u_char</span> <span class="n">bus</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pci_dev</span><span class="p">);</span>


<span class="k">static</span> <span class="kt">int</span> <span class="n">hp100_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">hp100_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="n">netdev_tx_t</span> <span class="n">hp100_start_xmit</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="n">netdev_tx_t</span> <span class="n">hp100_start_xmit_bm</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">hp100_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">net_device_stats</span> <span class="o">*</span><span class="n">hp100_get_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">hp100_misc_interrupt</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">hp100_update_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">hp100_clear_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">hp100_private</span> <span class="o">*</span><span class="n">lp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ioaddr</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">hp100_set_multicast_list</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="n">hp100_interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">hp100_start_interface</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">hp100_stop_interface</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">hp100_load_eeprom</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u_short</span> <span class="n">ioaddr</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">hp100_sense_lan</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">hp100_login_to_vg_hub</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				 <span class="n">u_short</span> <span class="n">force_relogin</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">hp100_down_vg_link</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">hp100_cascade_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u_short</span> <span class="n">enable</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">hp100_BM_shutdown</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">hp100_mmuinit</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">hp100_init_pdls</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">hp100_init_rxpdl</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			    <span class="k">register</span> <span class="n">hp100_ring_t</span> <span class="o">*</span> <span class="n">ringptr</span><span class="p">,</span>
			    <span class="k">register</span> <span class="n">u_int</span> <span class="o">*</span> <span class="n">pdlptr</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">hp100_init_txpdl</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			    <span class="k">register</span> <span class="n">hp100_ring_t</span> <span class="o">*</span> <span class="n">ringptr</span><span class="p">,</span>
			    <span class="k">register</span> <span class="n">u_int</span> <span class="o">*</span> <span class="n">pdlptr</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">hp100_rxfill</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">hp100_hwinit</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">hp100_clean_txring</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="cp">#ifdef HP100_DEBUG</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">hp100_RegisterDump</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="cm">/* Conversion to new PCI API :</span>
<span class="cm"> * Convert an address in a kernel buffer to a bus/phys/dma address.</span>
<span class="cm"> * This work *only* for memory fragments part of lp-&gt;page_vaddr,</span>
<span class="cm"> * because it was properly DMA allocated via pci_alloc_consistent(),</span>
<span class="cm"> * so we just need to &quot;retrieve&quot; the original mapping to bus/phys/dma</span>
<span class="cm"> * address - Jean II */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="n">dma_addr_t</span> <span class="nf">virt_to_whatever</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span> <span class="n">ptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hp100_private</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="p">((</span><span class="n">u_long</span><span class="p">)</span> <span class="n">ptr</span><span class="p">)</span> <span class="o">+</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">whatever_offset</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u_int</span> <span class="nf">pdl_map_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">hp100_private</span> <span class="o">*</span><span class="n">lp</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">pci_map_single</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span>
			      <span class="n">MAX_ETHER_SIZE</span><span class="p">,</span> <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* TODO: This function should not really be needed in a good design... */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">wait</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  probe functions</span>
<span class="cm"> *  These functions should - if possible - avoid doing write operations</span>
<span class="cm"> *  since this could cause problems when the card is not installed.</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * Read board id and convert to string.</span>
<span class="cm"> * Effectively same code as decode_eisa_sig</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">__devinit</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">hp100_read_id</span><span class="p">(</span><span class="kt">int</span> <span class="n">ioaddr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">static</span> <span class="kt">char</span> <span class="n">str</span><span class="p">[</span><span class="n">HP100_SIG_LEN</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">sig</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">sum</span><span class="p">;</span>
        <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">rev</span><span class="p">;</span>

	<span class="n">hp100_page</span><span class="p">(</span><span class="n">ID_MAC_ADDR</span><span class="p">);</span>
	<span class="n">sum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sig</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">hp100_inb</span><span class="p">(</span><span class="n">BOARD_ID</span> <span class="o">+</span> <span class="n">i</span><span class="p">);</span>
		<span class="n">sum</span> <span class="o">+=</span> <span class="n">sig</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
	<span class="p">}</span>

	<span class="n">sum</span> <span class="o">+=</span> <span class="n">hp100_inb</span><span class="p">(</span><span class="n">BOARD_ID</span> <span class="o">+</span> <span class="n">i</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sum</span> <span class="o">!=</span> <span class="mh">0xff</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>	<span class="cm">/* bad checksum */</span>

        <span class="n">str</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">sig</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="sc">&#39;A&#39;</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
        <span class="n">str</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(((</span><span class="n">sig</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">sig</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span><span class="p">))</span> <span class="o">+</span> <span class="p">(</span><span class="sc">&#39;A&#39;</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
        <span class="n">str</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">sig</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="sc">&#39;A&#39;</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
        <span class="n">rev</span> <span class="o">=</span> <span class="p">(</span><span class="n">sig</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">sig</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
        <span class="n">sprintf</span><span class="p">(</span><span class="n">str</span> <span class="o">+</span> <span class="mi">3</span><span class="p">,</span> <span class="s">&quot;%04X&quot;</span><span class="p">,</span> <span class="n">rev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">str</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_ISA</span>
<span class="k">static</span> <span class="n">__init</span> <span class="kt">int</span> <span class="nf">hp100_isa_probe1</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ioaddr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">sig</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">request_region</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">HP100_REGION_SIZE</span><span class="p">,</span> <span class="s">&quot;hp100&quot;</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hp100_inw</span><span class="p">(</span><span class="n">HW_ID</span><span class="p">)</span> <span class="o">!=</span> <span class="n">HP100_HW_ID_CASCADE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">release_region</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">HP100_REGION_SIZE</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">sig</span> <span class="o">=</span> <span class="n">hp100_read_id</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">);</span>
	<span class="n">release_region</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">HP100_REGION_SIZE</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sig</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">hp100_isa_tbl</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">hp100_isa_tbl</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">sig</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>

	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">hp100_isa_tbl</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">hp100_probe1</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ioaddr</span><span class="p">,</span> <span class="n">HP100_BUS_ISA</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
 <span class="nl">err:</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

<span class="p">}</span>
<span class="cm">/*</span>
<span class="cm"> * Probe for ISA board.</span>
<span class="cm"> * EISA and PCI are handled by device infrastructure.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span>  <span class="n">__init</span> <span class="nf">hp100_isa_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="cm">/* Probe for a specific ISA address */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">addr</span> <span class="o">&gt;</span> <span class="mh">0xff</span> <span class="o">&amp;&amp;</span> <span class="n">addr</span> <span class="o">&lt;</span> <span class="mh">0x400</span><span class="p">)</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">hp100_isa_probe1</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>

	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">addr</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>

	<span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Probe all ISA possible port regions */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">addr</span> <span class="o">=</span> <span class="mh">0x100</span><span class="p">;</span> <span class="n">addr</span> <span class="o">&lt;</span> <span class="mh">0x400</span><span class="p">;</span> <span class="n">addr</span> <span class="o">+=</span> <span class="mh">0x20</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">hp100_isa_probe1</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_ISA */</span><span class="cp"></span>

<span class="cp">#if !defined(MODULE) &amp;&amp; defined(CONFIG_ISA)</span>
<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span> <span class="n">__init</span> <span class="nf">hp100_probe</span><span class="p">(</span><span class="kt">int</span> <span class="n">unit</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">alloc_etherdev</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">hp100_private</span><span class="p">));</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ENODEV</span><span class="p">);</span>

<span class="cp">#ifdef HP100_DEBUG_B</span>
	<span class="n">hp100_outw</span><span class="p">(</span><span class="mh">0x4200</span><span class="p">,</span> <span class="n">TRACE</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;hp100: %s: probe</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unit</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;eth%d&quot;</span><span class="p">,</span> <span class="n">unit</span><span class="p">);</span>
		<span class="n">netdev_boot_setup_check</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">hp100_isa_probe</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">dev</span><span class="p">;</span>
 <span class="nl">out:</span>
	<span class="n">free_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="n">err</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* !MODULE &amp;&amp; CONFIG_ISA */</span><span class="cp"></span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">net_device_ops</span> <span class="n">hp100_bm_netdev_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">ndo_open</span>		<span class="o">=</span> <span class="n">hp100_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_stop</span>		<span class="o">=</span> <span class="n">hp100_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_start_xmit</span>		<span class="o">=</span> <span class="n">hp100_start_xmit_bm</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_get_stats</span> 		<span class="o">=</span> <span class="n">hp100_get_stats</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_set_rx_mode</span>	<span class="o">=</span> <span class="n">hp100_set_multicast_list</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_change_mtu</span>		<span class="o">=</span> <span class="n">eth_change_mtu</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_set_mac_address</span> 	<span class="o">=</span> <span class="n">eth_mac_addr</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_validate_addr</span>	<span class="o">=</span> <span class="n">eth_validate_addr</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">net_device_ops</span> <span class="n">hp100_netdev_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">ndo_open</span>		<span class="o">=</span> <span class="n">hp100_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_stop</span>		<span class="o">=</span> <span class="n">hp100_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_start_xmit</span>		<span class="o">=</span> <span class="n">hp100_start_xmit</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_get_stats</span> 		<span class="o">=</span> <span class="n">hp100_get_stats</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_set_rx_mode</span>	<span class="o">=</span> <span class="n">hp100_set_multicast_list</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_change_mtu</span>		<span class="o">=</span> <span class="n">eth_change_mtu</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_set_mac_address</span> 	<span class="o">=</span> <span class="n">eth_mac_addr</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_validate_addr</span>	<span class="o">=</span> <span class="n">eth_validate_addr</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">hp100_probe1</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ioaddr</span><span class="p">,</span>
				  <span class="n">u_char</span> <span class="n">bus</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pci_dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">eid</span><span class="p">;</span>
	<span class="n">u_int</span> <span class="n">chip</span><span class="p">;</span>
	<span class="n">u_char</span> <span class="n">uc</span><span class="p">;</span>
	<span class="n">u_int</span> <span class="n">memory_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">virt_memory_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u_short</span> <span class="n">local_mode</span><span class="p">,</span> <span class="n">lsw</span><span class="p">;</span>
	<span class="kt">short</span> <span class="n">mem_mapped</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">mem_ptr_phys</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">mem_ptr_virt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hp100_private</span> <span class="o">*</span><span class="n">lp</span><span class="p">;</span>

<span class="cp">#ifdef HP100_DEBUG_B</span>
	<span class="n">hp100_outw</span><span class="p">(</span><span class="mh">0x4201</span><span class="p">,</span> <span class="n">TRACE</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;hp100: %s: probe1</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="cm">/* memory region for programmed i/o */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">request_region</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">HP100_REGION_SIZE</span><span class="p">,</span> <span class="s">&quot;hp100&quot;</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hp100_inw</span><span class="p">(</span><span class="n">HW_ID</span><span class="p">)</span> <span class="o">!=</span> <span class="n">HP100_HW_ID_CASCADE</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out2</span><span class="p">;</span>

	<span class="n">chip</span> <span class="o">=</span> <span class="n">hp100_inw</span><span class="p">(</span><span class="n">PAGING</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">HP100_CHIPID_MASK</span><span class="p">;</span>
<span class="cp">#ifdef HP100_DEBUG</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span> <span class="o">==</span> <span class="n">HP100_CHIPID_SHASTA</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;hp100: %s: Shasta Chip detected. (This is a pre 802.12 chip)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">chip</span> <span class="o">==</span> <span class="n">HP100_CHIPID_RAINIER</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;hp100: %s: Rainier Chip detected. (This is a pre 802.12 chip)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">chip</span> <span class="o">==</span> <span class="n">HP100_CHIPID_LASSEN</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;hp100: %s: Lassen Chip detected.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;hp100: %s: Warning: Unknown CASCADE chip (id=0x%.4x).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">chip</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">=</span> <span class="n">ioaddr</span><span class="p">;</span>

	<span class="n">eid</span> <span class="o">=</span> <span class="n">hp100_read_id</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">eid</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* bad checksum? */</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;hp100_probe: bad ID checksum at base port 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioaddr</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">hp100_page</span><span class="p">(</span><span class="n">ID_MAC_ADDR</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">uc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">7</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">uc</span> <span class="o">+=</span> <span class="n">hp100_inb</span><span class="p">(</span><span class="n">LAN_ADDR</span> <span class="o">+</span> <span class="n">i</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">uc</span> <span class="o">!=</span> <span class="mh">0xff</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;hp100_probe: bad lan address checksum at port 0x%x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioaddr</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Make sure, that all registers are correctly updated... */</span>

	<span class="n">hp100_load_eeprom</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ioaddr</span><span class="p">);</span>
	<span class="n">wait</span><span class="p">();</span>

	<span class="cm">/*</span>
<span class="cm">	 * Determine driver operation mode</span>
<span class="cm">	 *</span>
<span class="cm">	 * Use the variable &quot;hp100_mode&quot; upon insmod or as kernel parameter to</span>
<span class="cm">	 * force driver modes:</span>
<span class="cm">	 * hp100_mode=1 -&gt; default, use busmaster mode if configured.</span>
<span class="cm">	 * hp100_mode=2 -&gt; enable shared memory mode</span>
<span class="cm">	 * hp100_mode=3 -&gt; force use of i/o mapped mode.</span>
<span class="cm">	 * hp100_mode=4 -&gt; same as 1, but re-set the enable bit on the card.</span>
<span class="cm">	 */</span>

	<span class="cm">/*</span>
<span class="cm">	 * LSW values:</span>
<span class="cm">	 *   0x2278 -&gt; J2585B, PnP shared memory mode</span>
<span class="cm">	 *   0x2270 -&gt; J2585B, shared memory mode, 0xdc000</span>
<span class="cm">	 *   0xa23c -&gt; J2585B, I/O mapped mode</span>
<span class="cm">	 *   0x2240 -&gt; EISA COMPEX, BusMaster (Shasta Chip)</span>
<span class="cm">	 *   0x2220 -&gt; EISA HP, I/O (Shasta Chip)</span>
<span class="cm">	 *   0x2260 -&gt; EISA HP, BusMaster (Shasta Chip)</span>
<span class="cm">	 */</span>

<span class="cp">#if 0</span><span class="c"></span>
<span class="c">	local_mode = 0x2270;</span>
<span class="c">	hp100_outw(0xfefe, OPTION_LSW);</span>
<span class="c">	hp100_outw(local_mode | HP100_SET_LB | HP100_SET_HB, OPTION_LSW);</span>
<span class="cp">#endif</span>

	<span class="cm">/* hp100_mode value maybe used in future by another card */</span>
	<span class="n">local_mode</span> <span class="o">=</span> <span class="n">hp100_mode</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">local_mode</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="o">||</span> <span class="n">local_mode</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">)</span>
		<span class="n">local_mode</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* default */</span>
<span class="cp">#ifdef HP100_DEBUG</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;hp100: %s: original LSW = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
	       <span class="n">hp100_inw</span><span class="p">(</span><span class="n">OPTION_LSW</span><span class="p">));</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">local_mode</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hp100_outw</span><span class="p">(</span><span class="n">HP100_MEM_EN</span> <span class="o">|</span> <span class="n">HP100_RESET_LB</span><span class="p">,</span> <span class="n">OPTION_LSW</span><span class="p">);</span>
		<span class="n">hp100_outw</span><span class="p">(</span><span class="n">HP100_IO_EN</span> <span class="o">|</span> <span class="n">HP100_SET_LB</span><span class="p">,</span> <span class="n">OPTION_LSW</span><span class="p">);</span>
		<span class="n">hp100_outw</span><span class="p">(</span><span class="n">HP100_BM_WRITE</span> <span class="o">|</span> <span class="n">HP100_BM_READ</span> <span class="o">|</span> <span class="n">HP100_RESET_HB</span><span class="p">,</span> <span class="n">OPTION_LSW</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;hp100: IO mapped mode forced.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">local_mode</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hp100_outw</span><span class="p">(</span><span class="n">HP100_MEM_EN</span> <span class="o">|</span> <span class="n">HP100_SET_LB</span><span class="p">,</span> <span class="n">OPTION_LSW</span><span class="p">);</span>
		<span class="n">hp100_outw</span><span class="p">(</span><span class="n">HP100_IO_EN</span> <span class="o">|</span> <span class="n">HP100_SET_LB</span><span class="p">,</span> <span class="n">OPTION_LSW</span><span class="p">);</span>
		<span class="n">hp100_outw</span><span class="p">(</span><span class="n">HP100_BM_WRITE</span> <span class="o">|</span> <span class="n">HP100_BM_READ</span> <span class="o">|</span> <span class="n">HP100_RESET_HB</span><span class="p">,</span> <span class="n">OPTION_LSW</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;hp100: Shared memory mode requested.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">local_mode</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">chip</span> <span class="o">==</span> <span class="n">HP100_CHIPID_LASSEN</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">hp100_outw</span><span class="p">(</span><span class="n">HP100_BM_WRITE</span> <span class="o">|</span> <span class="n">HP100_BM_READ</span> <span class="o">|</span> <span class="n">HP100_SET_HB</span><span class="p">,</span> <span class="n">OPTION_LSW</span><span class="p">);</span>
			<span class="n">hp100_outw</span><span class="p">(</span><span class="n">HP100_IO_EN</span> <span class="o">|</span> <span class="n">HP100_MEM_EN</span> <span class="o">|</span> <span class="n">HP100_RESET_LB</span><span class="p">,</span> <span class="n">OPTION_LSW</span><span class="p">);</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;hp100: Busmaster mode requested.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">local_mode</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">local_mode</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* default behaviour */</span>
		<span class="n">lsw</span> <span class="o">=</span> <span class="n">hp100_inw</span><span class="p">(</span><span class="n">OPTION_LSW</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">lsw</span> <span class="o">&amp;</span> <span class="n">HP100_IO_EN</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">~</span><span class="n">lsw</span> <span class="o">&amp;</span> <span class="n">HP100_MEM_EN</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="o">~</span><span class="n">lsw</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">HP100_BM_WRITE</span> <span class="o">|</span> <span class="n">HP100_BM_READ</span><span class="p">)))</span> <span class="p">{</span>
<span class="cp">#ifdef HP100_DEBUG</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;hp100: %s: IO_EN bit is set on card.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
<span class="cp">#endif</span>
			<span class="n">local_mode</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">chip</span> <span class="o">==</span> <span class="n">HP100_CHIPID_LASSEN</span> <span class="o">&amp;&amp;</span>
			   <span class="p">(</span><span class="n">lsw</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">HP100_BM_WRITE</span> <span class="o">|</span> <span class="n">HP100_BM_READ</span><span class="p">))</span> <span class="o">==</span> <span class="p">(</span><span class="n">HP100_BM_WRITE</span> <span class="o">|</span> <span class="n">HP100_BM_READ</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* Conversion to new PCI API :</span>
<span class="cm">			 * I don&#39;t have the doc, but I assume that the card</span>
<span class="cm">			 * can map the full 32bit address space.</span>
<span class="cm">			 * Also, we can have EISA Busmaster cards (not tested),</span>
<span class="cm">			 * so beware !!! - Jean II */</span>
			<span class="k">if</span><span class="p">((</span><span class="n">bus</span> <span class="o">==</span> <span class="n">HP100_BUS_PCI</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			   <span class="p">(</span><span class="n">pci_set_dma_mask</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">,</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">32</span><span class="p">))))</span> <span class="p">{</span>
				<span class="cm">/* Gracefully fallback to shared memory */</span>
				<span class="k">goto</span> <span class="n">busmasterfail</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;hp100: Busmaster mode enabled.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">hp100_outw</span><span class="p">(</span><span class="n">HP100_MEM_EN</span> <span class="o">|</span> <span class="n">HP100_IO_EN</span> <span class="o">|</span> <span class="n">HP100_RESET_LB</span><span class="p">,</span> <span class="n">OPTION_LSW</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="nl">busmasterfail:</span>
<span class="cp">#ifdef HP100_DEBUG</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;hp100: %s: Card not configured for BM or BM not supported with this card.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;hp100: %s: Trying shared memory mode.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
<span class="cp">#endif</span>
			<span class="cm">/* In this case, try shared memory mode */</span>
			<span class="n">local_mode</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
			<span class="n">hp100_outw</span><span class="p">(</span><span class="n">HP100_MEM_EN</span> <span class="o">|</span> <span class="n">HP100_SET_LB</span><span class="p">,</span> <span class="n">OPTION_LSW</span><span class="p">);</span>
			<span class="cm">/* hp100_outw(HP100_IO_EN|HP100_RESET_LB, OPTION_LSW); */</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="cp">#ifdef HP100_DEBUG</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;hp100: %s: new LSW = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">hp100_inw</span><span class="p">(</span><span class="n">OPTION_LSW</span><span class="p">));</span>
<span class="cp">#endif</span>

	<span class="cm">/* Check for shared memory on the card, eventually remap it */</span>
	<span class="n">hp100_page</span><span class="p">(</span><span class="n">HW_MAP</span><span class="p">);</span>
	<span class="n">mem_mapped</span> <span class="o">=</span> <span class="p">((</span><span class="n">hp100_inw</span><span class="p">(</span><span class="n">OPTION_LSW</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">HP100_MEM_EN</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">mem_ptr_phys</span> <span class="o">=</span> <span class="mi">0UL</span><span class="p">;</span>
	<span class="n">mem_ptr_virt</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">memory_size</span> <span class="o">=</span> <span class="p">(</span><span class="mi">8192</span> <span class="o">&lt;&lt;</span> <span class="p">((</span><span class="n">hp100_inb</span><span class="p">(</span><span class="n">SRAM</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x07</span><span class="p">));</span>
	<span class="n">virt_memory_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* For memory mapped or busmaster mode, we want the memory address */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mem_mapped</span> <span class="o">||</span> <span class="p">(</span><span class="n">local_mode</span> <span class="o">==</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">mem_ptr_phys</span> <span class="o">=</span> <span class="p">(</span><span class="n">hp100_inw</span><span class="p">(</span><span class="n">MEM_MAP_LSW</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">hp100_inw</span><span class="p">(</span><span class="n">MEM_MAP_MSW</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">));</span>
		<span class="n">mem_ptr_phys</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x1fff</span><span class="p">;</span>	<span class="cm">/* 8k alignment */</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">bus</span> <span class="o">==</span> <span class="n">HP100_BUS_ISA</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">mem_ptr_phys</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0xfffff</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;hp100: Can only use programmed i/o mode.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">mem_ptr_phys</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">mem_mapped</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">local_mode</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>	<span class="cm">/* Use programmed i/o */</span>
		<span class="p">}</span>

		<span class="cm">/* We do not need access to shared memory in busmaster mode */</span>
		<span class="cm">/* However in slave mode we need to remap high (&gt;1GB) card memory  */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">local_mode</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* = not busmaster */</span>
			<span class="cm">/* We try with smaller memory sizes, if ioremap fails */</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">virt_memory_size</span> <span class="o">=</span> <span class="n">memory_size</span><span class="p">;</span> <span class="n">virt_memory_size</span> <span class="o">&gt;</span> <span class="mi">16383</span><span class="p">;</span> <span class="n">virt_memory_size</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">mem_ptr_virt</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">((</span><span class="n">u_long</span><span class="p">)</span> <span class="n">mem_ptr_phys</span><span class="p">,</span> <span class="n">virt_memory_size</span><span class="p">))</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifdef HP100_DEBUG</span>
					<span class="n">printk</span><span class="p">(</span><span class="s">&quot;hp100: %s: ioremap for 0x%x bytes high PCI memory at 0x%lx failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">virt_memory_size</span><span class="p">,</span> <span class="n">mem_ptr_phys</span><span class="p">);</span>
<span class="cp">#endif</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<span class="cp">#ifdef HP100_DEBUG</span>
					<span class="n">printk</span><span class="p">(</span><span class="s">&quot;hp100: %s: remapped 0x%x bytes high PCI memory at 0x%lx to %p.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">virt_memory_size</span><span class="p">,</span> <span class="n">mem_ptr_phys</span><span class="p">,</span> <span class="n">mem_ptr_virt</span><span class="p">);</span>
<span class="cp">#endif</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">mem_ptr_virt</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* all ioremap tries failed */</span>
				<span class="n">printk</span><span class="p">(</span><span class="s">&quot;hp100: Failed to ioremap the PCI card memory. Will have to use i/o mapped mode.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">local_mode</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
				<span class="n">virt_memory_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">local_mode</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* io mapped forced */</span>
		<span class="n">mem_mapped</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">mem_ptr_phys</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">mem_ptr_virt</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;hp100: Using (slow) programmed i/o mode.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Initialise the &quot;private&quot; data structure for this card. */</span>
	<span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">strlcpy</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">eid</span><span class="p">,</span> <span class="n">HP100_SIG_LEN</span><span class="p">);</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">chip</span> <span class="o">=</span> <span class="n">chip</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">=</span> <span class="n">local_mode</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">bus</span> <span class="o">=</span> <span class="n">bus</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">pci_dev</span> <span class="o">=</span> <span class="n">pci_dev</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">priority_tx</span> <span class="o">=</span> <span class="n">hp100_priority_tx</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_ratio</span> <span class="o">=</span> <span class="n">hp100_rx_ratio</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">mem_ptr_phys</span> <span class="o">=</span> <span class="n">mem_ptr_phys</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">mem_ptr_virt</span> <span class="o">=</span> <span class="n">mem_ptr_virt</span><span class="p">;</span>
	<span class="n">hp100_page</span><span class="p">(</span><span class="n">ID_MAC_ADDR</span><span class="p">);</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">soft_model</span> <span class="o">=</span> <span class="n">hp100_inb</span><span class="p">(</span><span class="n">SOFT_MODEL</span><span class="p">);</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">mac1_mode</span> <span class="o">=</span> <span class="n">HP100_MAC1MODE3</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">mac2_mode</span> <span class="o">=</span> <span class="n">HP100_MAC2MODE3</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">hash_bytes</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">=</span> <span class="n">ioaddr</span><span class="p">;</span>

	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">memory_size</span> <span class="o">=</span> <span class="n">memory_size</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">virt_memory_size</span> <span class="o">=</span> <span class="n">virt_memory_size</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_ratio</span> <span class="o">=</span> <span class="n">hp100_rx_ratio</span><span class="p">;</span>	<span class="cm">/* can be conf&#39;d with insmod */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>	<span class="cm">/* busmaster */</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">netdev_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hp100_bm_netdev_ops</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">netdev_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hp100_netdev_ops</span><span class="p">;</span>

	<span class="cm">/* Ask the card for which IRQ line it is configured */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bus</span> <span class="o">==</span> <span class="n">HP100_BUS_PCI</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">pci_dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">hp100_page</span><span class="p">(</span><span class="n">HW_MAP</span><span class="p">);</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">hp100_inb</span><span class="p">(</span><span class="n">IRQ_CHANNEL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">HP100_IRQMASK</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="mi">9</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>	<span class="cm">/* busmaster */</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dma</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>

	<span class="cm">/* Ask the card for its MAC address and store it for later use. */</span>
	<span class="n">hp100_page</span><span class="p">(</span><span class="n">ID_MAC_ADDR</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">uc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">hp100_inb</span><span class="p">(</span><span class="n">LAN_ADDR</span> <span class="o">+</span> <span class="n">i</span><span class="p">);</span>

	<span class="cm">/* Reset statistics (counters) */</span>
	<span class="n">hp100_clear_stats</span><span class="p">(</span><span class="n">lp</span><span class="p">,</span> <span class="n">ioaddr</span><span class="p">);</span>

	<span class="cm">/* If busmaster mode is wanted, a dma-capable memory area is needed for</span>
<span class="cm">	 * the rx and tx PDLs</span>
<span class="cm">	 * PCI cards can access the whole PC memory. Therefore GFP_DMA is not</span>
<span class="cm">	 * needed for the allocation of the memory area.</span>
<span class="cm">	 */</span>

	<span class="cm">/* TODO: We do not need this with old cards, where PDLs are stored</span>
<span class="cm">	 * in the cards shared memory area. But currently, busmaster has been</span>
<span class="cm">	 * implemented/tested only with the lassen chip anyway... */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* busmaster */</span>
		<span class="n">dma_addr_t</span> <span class="n">page_baddr</span><span class="p">;</span>
		<span class="cm">/* Get physically continuous memory for TX &amp; RX PDLs    */</span>
		<span class="cm">/* Conversion to new PCI API :</span>
<span class="cm">		 * Pages are always aligned and zeroed, no need to it ourself.</span>
<span class="cm">		 * Doc says should be OK for EISA bus as well - Jean II */</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">page_vaddr_algn</span> <span class="o">=</span> <span class="n">pci_alloc_consistent</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span> <span class="n">MAX_RINGSIZE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">page_baddr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">page_vaddr_algn</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out_mem_ptr</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">whatever_offset</span> <span class="o">=</span> <span class="p">((</span><span class="n">u_long</span><span class="p">)</span> <span class="n">page_baddr</span><span class="p">)</span> <span class="o">-</span> <span class="p">((</span><span class="n">u_long</span><span class="p">)</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">page_vaddr_algn</span><span class="p">);</span>

<span class="cp">#ifdef HP100_DEBUG_BM</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;hp100: %s: Reserved DMA memory from 0x%x to 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="p">(</span><span class="n">u_int</span><span class="p">)</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">page_vaddr_algn</span><span class="p">,</span> <span class="p">(</span><span class="n">u_int</span><span class="p">)</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">page_vaddr_algn</span> <span class="o">+</span> <span class="n">MAX_RINGSIZE</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">rxrcommit</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">txrcommit</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">rxrhead</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">rxrtail</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">rxring</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">txrhead</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">txrtail</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">txring</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="p">}</span>

	<span class="cm">/* Initialise the card. */</span>
	<span class="cm">/* (I&#39;m not really sure if it&#39;s a good idea to do this during probing, but</span>
<span class="cm">	 * like this it&#39;s assured that the lan connection type can be sensed</span>
<span class="cm">	 * correctly)</span>
<span class="cm">	 */</span>
	<span class="n">hp100_hwinit</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* Try to find out which kind of LAN the card is connected to. */</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">lan_type</span> <span class="o">=</span> <span class="n">hp100_sense_lan</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* Print out a message what about what we think we have probed. */</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;hp100: at 0x%x, IRQ %d, &quot;</span><span class="p">,</span> <span class="n">ioaddr</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">bus</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">HP100_BUS_EISA</span>:
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;EISA&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HP100_BUS_PCI</span>:
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;PCI&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;ISA&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot; bus, %dk SRAM (rx/tx %d%%).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">memory_size</span> <span class="o">&gt;&gt;</span> <span class="mi">10</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_ratio</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* memory mapped */</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;hp100: Memory area at 0x%lx-0x%lx&quot;</span><span class="p">,</span> <span class="n">mem_ptr_phys</span><span class="p">,</span>
				<span class="p">(</span><span class="n">mem_ptr_phys</span> <span class="o">+</span> <span class="p">(</span><span class="n">mem_ptr_phys</span> <span class="o">&gt;</span> <span class="mh">0x100000</span> <span class="o">?</span> <span class="p">(</span><span class="n">u_long</span><span class="p">)</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">memory_size</span> <span class="o">:</span> <span class="mi">16</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">))</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mem_ptr_virt</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot; (virtual base %p)&quot;</span><span class="p">,</span> <span class="n">mem_ptr_virt</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="cm">/* Set for info when doing ifconfig */</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">mem_start</span> <span class="o">=</span> <span class="n">mem_ptr_phys</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">mem_end</span> <span class="o">=</span> <span class="n">mem_ptr_phys</span> <span class="o">+</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">memory_size</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;hp100: &quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">lan_type</span> <span class="o">!=</span> <span class="n">HP100_LAN_ERR</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Adapter is attached to &quot;</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">lan_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">HP100_LAN_100</span>:
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;100Mb/s Voice Grade AnyLAN network.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HP100_LAN_10</span>:
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;10Mb/s network (10baseT).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HP100_LAN_COAX</span>:
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;10Mb/s network (coax).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Warning! Link down.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">register_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out3</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">out3:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">local_mode</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span> <span class="n">MAX_RINGSIZE</span> <span class="o">+</span> <span class="mh">0x0f</span><span class="p">,</span>
				    <span class="n">lp</span><span class="o">-&gt;</span><span class="n">page_vaddr_algn</span><span class="p">,</span>
				    <span class="n">virt_to_whatever</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">page_vaddr_algn</span><span class="p">));</span>
<span class="nl">out_mem_ptr:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mem_ptr_virt</span><span class="p">)</span>
		<span class="n">iounmap</span><span class="p">(</span><span class="n">mem_ptr_virt</span><span class="p">);</span>
<span class="nl">out2:</span>
	<span class="n">release_region</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">HP100_REGION_SIZE</span><span class="p">);</span>
<span class="nl">out1:</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* This procedure puts the card into a stable init state */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">hp100_hwinit</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ioaddr</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hp100_private</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

<span class="cp">#ifdef HP100_DEBUG_B</span>
	<span class="n">hp100_outw</span><span class="p">(</span><span class="mh">0x4202</span><span class="p">,</span> <span class="n">TRACE</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;hp100: %s: hwinit</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="cm">/* Initialise the card. -------------------------------------------- */</span>

	<span class="cm">/* Clear all pending Ints and disable Ints */</span>
	<span class="n">hp100_page</span><span class="p">(</span><span class="n">PERFORMANCE</span><span class="p">);</span>
	<span class="n">hp100_outw</span><span class="p">(</span><span class="mh">0xfefe</span><span class="p">,</span> <span class="n">IRQ_MASK</span><span class="p">);</span>	<span class="cm">/* mask off all ints */</span>
	<span class="n">hp100_outw</span><span class="p">(</span><span class="mh">0xffff</span><span class="p">,</span> <span class="n">IRQ_STATUS</span><span class="p">);</span>	<span class="cm">/* clear all pending ints */</span>

	<span class="n">hp100_outw</span><span class="p">(</span><span class="n">HP100_INT_EN</span> <span class="o">|</span> <span class="n">HP100_RESET_LB</span><span class="p">,</span> <span class="n">OPTION_LSW</span><span class="p">);</span>
	<span class="n">hp100_outw</span><span class="p">(</span><span class="n">HP100_TRI_INT</span> <span class="o">|</span> <span class="n">HP100_SET_HB</span><span class="p">,</span> <span class="n">OPTION_LSW</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hp100_BM_shutdown</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>	<span class="cm">/* disables BM, puts cascade in reset */</span>
		<span class="n">wait</span><span class="p">();</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">hp100_outw</span><span class="p">(</span><span class="n">HP100_INT_EN</span> <span class="o">|</span> <span class="n">HP100_RESET_LB</span><span class="p">,</span> <span class="n">OPTION_LSW</span><span class="p">);</span>
		<span class="n">hp100_cascade_reset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">hp100_page</span><span class="p">(</span><span class="n">MAC_CTRL</span><span class="p">);</span>
		<span class="n">hp100_andb</span><span class="p">(</span><span class="o">~</span><span class="p">(</span><span class="n">HP100_RX_EN</span> <span class="o">|</span> <span class="n">HP100_TX_EN</span><span class="p">),</span> <span class="n">MAC_CFG_1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Initiate EEPROM reload */</span>
	<span class="n">hp100_load_eeprom</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">wait</span><span class="p">();</span>

	<span class="cm">/* Go into reset again. */</span>
	<span class="n">hp100_cascade_reset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* Set Option Registers to a safe state  */</span>
	<span class="n">hp100_outw</span><span class="p">(</span><span class="n">HP100_DEBUG_EN</span> <span class="o">|</span>
		   <span class="n">HP100_RX_HDR</span> <span class="o">|</span>
		   <span class="n">HP100_EE_EN</span> <span class="o">|</span>
		   <span class="n">HP100_BM_WRITE</span> <span class="o">|</span>
		   <span class="n">HP100_BM_READ</span> <span class="o">|</span> <span class="n">HP100_RESET_HB</span> <span class="o">|</span>
		   <span class="n">HP100_FAKE_INT</span> <span class="o">|</span>
		   <span class="n">HP100_INT_EN</span> <span class="o">|</span>
		   <span class="n">HP100_MEM_EN</span> <span class="o">|</span>
		   <span class="n">HP100_IO_EN</span> <span class="o">|</span> <span class="n">HP100_RESET_LB</span><span class="p">,</span> <span class="n">OPTION_LSW</span><span class="p">);</span>

	<span class="n">hp100_outw</span><span class="p">(</span><span class="n">HP100_TRI_INT</span> <span class="o">|</span>
		   <span class="n">HP100_MMAP_DIS</span> <span class="o">|</span> <span class="n">HP100_SET_HB</span><span class="p">,</span> <span class="n">OPTION_LSW</span><span class="p">);</span>

	<span class="n">hp100_outb</span><span class="p">(</span><span class="n">HP100_PRIORITY_TX</span> <span class="o">|</span>
		   <span class="n">HP100_ADV_NXT_PKT</span> <span class="o">|</span>
		   <span class="n">HP100_TX_CMD</span> <span class="o">|</span> <span class="n">HP100_RESET_LB</span><span class="p">,</span> <span class="n">OPTION_MSW</span><span class="p">);</span>

	<span class="cm">/* TODO: Configure MMU for Ram Test. */</span>
	<span class="cm">/* TODO: Ram Test. */</span>

	<span class="cm">/* Re-check if adapter is still at same i/o location      */</span>
	<span class="cm">/* (If the base i/o in eeprom has been changed but the    */</span>
	<span class="cm">/* registers had not been changed, a reload of the eeprom */</span>
	<span class="cm">/* would move the adapter to the address stored in eeprom */</span>

	<span class="cm">/* TODO: Code to implement. */</span>

	<span class="cm">/* Until here it was code from HWdiscover procedure. */</span>
	<span class="cm">/* Next comes code from mmuinit procedure of SCO BM driver which is</span>
<span class="cm">	 * called from HWconfigure in the SCO driver.  */</span>

	<span class="cm">/* Initialise MMU, eventually switch on Busmaster Mode, initialise</span>
<span class="cm">	 * multicast filter...</span>
<span class="cm">	 */</span>
	<span class="n">hp100_mmuinit</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* We don&#39;t turn the interrupts on here - this is done by start_interface. */</span>
	<span class="n">wait</span><span class="p">();</span>			<span class="cm">/* TODO: Do we really need this? */</span>

	<span class="cm">/* Enable Hardware (e.g. unreset) */</span>
	<span class="n">hp100_cascade_reset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* ------- initialisation complete ----------- */</span>

	<span class="cm">/* Finally try to log in the Hub if there may be a VG connection. */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">lan_type</span> <span class="o">==</span> <span class="n">HP100_LAN_100</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">lan_type</span> <span class="o">==</span> <span class="n">HP100_LAN_ERR</span><span class="p">))</span>
		<span class="n">hp100_login_to_vg_hub</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>	<span class="cm">/* relogin */</span>

<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * mmuinit - Reinitialise Cascade MMU and MAC settings.</span>
<span class="cm"> * Note: Must already be in reset and leaves card in reset.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">hp100_mmuinit</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ioaddr</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hp100_private</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

<span class="cp">#ifdef HP100_DEBUG_B</span>
	<span class="n">hp100_outw</span><span class="p">(</span><span class="mh">0x4203</span><span class="p">,</span> <span class="n">TRACE</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;hp100: %s: mmuinit</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef HP100_DEBUG</span>
	<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">!=</span> <span class="p">(</span><span class="n">hp100_inw</span><span class="p">(</span><span class="n">OPTION_LSW</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">HP100_HW_RST</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;hp100: %s: Not in reset when entering mmuinit. Fix me.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="cm">/* Make sure IRQs are masked off and ack&#39;ed. */</span>
	<span class="n">hp100_page</span><span class="p">(</span><span class="n">PERFORMANCE</span><span class="p">);</span>
	<span class="n">hp100_outw</span><span class="p">(</span><span class="mh">0xfefe</span><span class="p">,</span> <span class="n">IRQ_MASK</span><span class="p">);</span>	<span class="cm">/* mask off all ints */</span>
	<span class="n">hp100_outw</span><span class="p">(</span><span class="mh">0xffff</span><span class="p">,</span> <span class="n">IRQ_STATUS</span><span class="p">);</span>	<span class="cm">/* ack IRQ */</span>

	<span class="cm">/*</span>
<span class="cm">	 * Enable Hardware</span>
<span class="cm">	 * - Clear Debug En, Rx Hdr Pipe, EE En, I/O En, Fake Int and Intr En</span>
<span class="cm">	 * - Set Tri-State Int, Bus Master Rd/Wr, and Mem Map Disable</span>
<span class="cm">	 * - Clear Priority, Advance Pkt and Xmit Cmd</span>
<span class="cm">	 */</span>

	<span class="n">hp100_outw</span><span class="p">(</span><span class="n">HP100_DEBUG_EN</span> <span class="o">|</span>
		   <span class="n">HP100_RX_HDR</span> <span class="o">|</span>
		   <span class="n">HP100_EE_EN</span> <span class="o">|</span> <span class="n">HP100_RESET_HB</span> <span class="o">|</span>
		   <span class="n">HP100_IO_EN</span> <span class="o">|</span>
		   <span class="n">HP100_FAKE_INT</span> <span class="o">|</span>
		   <span class="n">HP100_INT_EN</span> <span class="o">|</span> <span class="n">HP100_RESET_LB</span><span class="p">,</span> <span class="n">OPTION_LSW</span><span class="p">);</span>

	<span class="n">hp100_outw</span><span class="p">(</span><span class="n">HP100_TRI_INT</span> <span class="o">|</span> <span class="n">HP100_SET_HB</span><span class="p">,</span> <span class="n">OPTION_LSW</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* busmaster */</span>
		<span class="n">hp100_outw</span><span class="p">(</span><span class="n">HP100_BM_WRITE</span> <span class="o">|</span>
			   <span class="n">HP100_BM_READ</span> <span class="o">|</span>
			   <span class="n">HP100_MMAP_DIS</span> <span class="o">|</span> <span class="n">HP100_SET_HB</span><span class="p">,</span> <span class="n">OPTION_LSW</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* memory mapped */</span>
		<span class="n">hp100_outw</span><span class="p">(</span><span class="n">HP100_BM_WRITE</span> <span class="o">|</span>
			   <span class="n">HP100_BM_READ</span> <span class="o">|</span> <span class="n">HP100_RESET_HB</span><span class="p">,</span> <span class="n">OPTION_LSW</span><span class="p">);</span>
		<span class="n">hp100_outw</span><span class="p">(</span><span class="n">HP100_MMAP_DIS</span> <span class="o">|</span> <span class="n">HP100_RESET_HB</span><span class="p">,</span> <span class="n">OPTION_LSW</span><span class="p">);</span>
		<span class="n">hp100_outw</span><span class="p">(</span><span class="n">HP100_MEM_EN</span> <span class="o">|</span> <span class="n">HP100_SET_LB</span><span class="p">,</span> <span class="n">OPTION_LSW</span><span class="p">);</span>
		<span class="n">hp100_outw</span><span class="p">(</span><span class="n">HP100_IO_EN</span> <span class="o">|</span> <span class="n">HP100_SET_LB</span><span class="p">,</span> <span class="n">OPTION_LSW</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* i/o mapped mode */</span>
		<span class="n">hp100_outw</span><span class="p">(</span><span class="n">HP100_MMAP_DIS</span> <span class="o">|</span> <span class="n">HP100_SET_HB</span> <span class="o">|</span>
			   <span class="n">HP100_IO_EN</span> <span class="o">|</span> <span class="n">HP100_SET_LB</span><span class="p">,</span> <span class="n">OPTION_LSW</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">hp100_page</span><span class="p">(</span><span class="n">HW_MAP</span><span class="p">);</span>
	<span class="n">hp100_outb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">EARLYRXCFG</span><span class="p">);</span>
	<span class="n">hp100_outw</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">EARLYTXCFG</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Enable Bus Master mode</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* busmaster */</span>
		<span class="cm">/* Experimental: Set some PCI configuration bits */</span>
		<span class="n">hp100_page</span><span class="p">(</span><span class="n">HW_MAP</span><span class="p">);</span>
		<span class="n">hp100_andb</span><span class="p">(</span><span class="o">~</span><span class="n">HP100_PDL_USE3</span><span class="p">,</span> <span class="n">MODECTRL1</span><span class="p">);</span>	<span class="cm">/* BM engine read maximum */</span>
		<span class="n">hp100_andb</span><span class="p">(</span><span class="o">~</span><span class="n">HP100_TX_DUALQ</span><span class="p">,</span> <span class="n">MODECTRL1</span><span class="p">);</span>	<span class="cm">/* No Queue for Priority TX */</span>

		<span class="cm">/* PCI Bus failures should result in a Misc. Interrupt */</span>
		<span class="n">hp100_orb</span><span class="p">(</span><span class="n">HP100_EN_BUS_FAIL</span><span class="p">,</span> <span class="n">MODECTRL2</span><span class="p">);</span>

		<span class="n">hp100_outw</span><span class="p">(</span><span class="n">HP100_BM_READ</span> <span class="o">|</span> <span class="n">HP100_BM_WRITE</span> <span class="o">|</span> <span class="n">HP100_SET_HB</span><span class="p">,</span> <span class="n">OPTION_LSW</span><span class="p">);</span>
		<span class="n">hp100_page</span><span class="p">(</span><span class="n">HW_MAP</span><span class="p">);</span>
		<span class="cm">/* Use Burst Mode and switch on PAGE_CK */</span>
		<span class="n">hp100_orb</span><span class="p">(</span><span class="n">HP100_BM_BURST_RD</span> <span class="o">|</span> <span class="n">HP100_BM_BURST_WR</span><span class="p">,</span> <span class="n">BM</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">chip</span> <span class="o">==</span> <span class="n">HP100_CHIPID_RAINIER</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">chip</span> <span class="o">==</span> <span class="n">HP100_CHIPID_SHASTA</span><span class="p">))</span>
			<span class="n">hp100_orb</span><span class="p">(</span><span class="n">HP100_BM_PAGE_CK</span><span class="p">,</span> <span class="n">BM</span><span class="p">);</span>
		<span class="n">hp100_orb</span><span class="p">(</span><span class="n">HP100_BM_MASTER</span><span class="p">,</span> <span class="n">BM</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>		<span class="cm">/* not busmaster */</span>

		<span class="n">hp100_page</span><span class="p">(</span><span class="n">HW_MAP</span><span class="p">);</span>
		<span class="n">hp100_andb</span><span class="p">(</span><span class="o">~</span><span class="n">HP100_BM_MASTER</span><span class="p">,</span> <span class="n">BM</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Divide card memory into regions for Rx, Tx and, if non-ETR chip, PDLs</span>
<span class="cm">	 */</span>
	<span class="n">hp100_page</span><span class="p">(</span><span class="n">MMU_CFG</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* only needed for Busmaster */</span>
		<span class="kt">int</span> <span class="n">xmit_stop</span><span class="p">,</span> <span class="n">recv_stop</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">chip</span> <span class="o">==</span> <span class="n">HP100_CHIPID_RAINIER</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">chip</span> <span class="o">==</span> <span class="n">HP100_CHIPID_SHASTA</span><span class="p">))</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">pdl_stop</span><span class="p">;</span>

			<span class="cm">/*</span>
<span class="cm">			 * Each pdl is 508 bytes long. (63 frags * 4 bytes for address and</span>
<span class="cm">			 * 4 bytes for header). We will leave NUM_RXPDLS * 508 (rounded</span>
<span class="cm">			 * to the next higher 1k boundary) bytes for the rx-pdl&#39;s</span>
<span class="cm">			 * Note: For non-etr chips the transmit stop register must be</span>
<span class="cm">			 * programmed on a 1k boundary, i.e. bits 9:0 must be zero.</span>
<span class="cm">			 */</span>
			<span class="n">pdl_stop</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">memory_size</span><span class="p">;</span>
			<span class="n">xmit_stop</span> <span class="o">=</span> <span class="p">(</span><span class="n">pdl_stop</span> <span class="o">-</span> <span class="mi">508</span> <span class="o">*</span> <span class="p">(</span><span class="n">MAX_RX_PDL</span><span class="p">)</span> <span class="o">-</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="mh">0x03ff</span><span class="p">);</span>
			<span class="n">recv_stop</span> <span class="o">=</span> <span class="p">(</span><span class="n">xmit_stop</span> <span class="o">*</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_ratio</span><span class="p">)</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="mh">0x03ff</span><span class="p">);</span>
			<span class="n">hp100_outw</span><span class="p">((</span><span class="n">pdl_stop</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">PDL_MEM_STOP</span><span class="p">);</span>
<span class="cp">#ifdef HP100_DEBUG_BM</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;hp100: %s: PDL_STOP = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">pdl_stop</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* ETR chip (Lassen) in busmaster mode */</span>
			<span class="n">xmit_stop</span> <span class="o">=</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">memory_size</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">recv_stop</span> <span class="o">=</span> <span class="p">((</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">memory_size</span> <span class="o">*</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_ratio</span><span class="p">)</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="mh">0x03ff</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">hp100_outw</span><span class="p">(</span><span class="n">xmit_stop</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">,</span> <span class="n">TX_MEM_STOP</span><span class="p">);</span>
		<span class="n">hp100_outw</span><span class="p">(</span><span class="n">recv_stop</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">,</span> <span class="n">RX_MEM_STOP</span><span class="p">);</span>
<span class="cp">#ifdef HP100_DEBUG_BM</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;hp100: %s: TX_STOP  = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">xmit_stop</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;hp100: %s: RX_STOP  = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">recv_stop</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Slave modes (memory mapped and programmed io)  */</span>
		<span class="n">hp100_outw</span><span class="p">((((</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">memory_size</span> <span class="o">*</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_ratio</span><span class="p">)</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">),</span> <span class="n">RX_MEM_STOP</span><span class="p">);</span>
		<span class="n">hp100_outw</span><span class="p">(((</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">memory_size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">),</span> <span class="n">TX_MEM_STOP</span><span class="p">);</span>
<span class="cp">#ifdef HP100_DEBUG</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;hp100: %s: TX_MEM_STOP: 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">hp100_inw</span><span class="p">(</span><span class="n">TX_MEM_STOP</span><span class="p">));</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;hp100: %s: RX_MEM_STOP: 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">hp100_inw</span><span class="p">(</span><span class="n">RX_MEM_STOP</span><span class="p">));</span>
<span class="cp">#endif</span>
	<span class="p">}</span>

	<span class="cm">/* Write MAC address into page 1 */</span>
	<span class="n">hp100_page</span><span class="p">(</span><span class="n">MAC_ADDRESS</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">hp100_outb</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">MAC_ADDR</span> <span class="o">+</span> <span class="n">i</span><span class="p">);</span>

	<span class="cm">/* Zero the multicast hash registers */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">hp100_outb</span><span class="p">(</span><span class="mh">0x0</span><span class="p">,</span> <span class="n">HASH_BYTE0</span> <span class="o">+</span> <span class="n">i</span><span class="p">);</span>

	<span class="cm">/* Set up MAC defaults */</span>
	<span class="n">hp100_page</span><span class="p">(</span><span class="n">MAC_CTRL</span><span class="p">);</span>

	<span class="cm">/* Go to LAN Page and zero all filter bits */</span>
	<span class="cm">/* Zero accept error, accept multicast, accept broadcast and accept */</span>
	<span class="cm">/* all directed packet bits */</span>
	<span class="n">hp100_andb</span><span class="p">(</span><span class="o">~</span><span class="p">(</span><span class="n">HP100_RX_EN</span> <span class="o">|</span>
		     <span class="n">HP100_TX_EN</span> <span class="o">|</span>
		     <span class="n">HP100_ACC_ERRORED</span> <span class="o">|</span>
		     <span class="n">HP100_ACC_MC</span> <span class="o">|</span>
		     <span class="n">HP100_ACC_BC</span> <span class="o">|</span> <span class="n">HP100_ACC_PHY</span><span class="p">),</span> <span class="n">MAC_CFG_1</span><span class="p">);</span>

	<span class="n">hp100_outb</span><span class="p">(</span><span class="mh">0x00</span><span class="p">,</span> <span class="n">MAC_CFG_2</span><span class="p">);</span>

	<span class="cm">/* Zero the frame format bit. This works around a training bug in the */</span>
	<span class="cm">/* new hubs. */</span>
	<span class="n">hp100_outb</span><span class="p">(</span><span class="mh">0x00</span><span class="p">,</span> <span class="n">VG_LAN_CFG_2</span><span class="p">);</span>	<span class="cm">/* (use 802.3) */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">priority_tx</span><span class="p">)</span>
		<span class="n">hp100_outb</span><span class="p">(</span><span class="n">HP100_PRIORITY_TX</span> <span class="o">|</span> <span class="n">HP100_SET_LB</span><span class="p">,</span> <span class="n">OPTION_MSW</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">hp100_outb</span><span class="p">(</span><span class="n">HP100_PRIORITY_TX</span> <span class="o">|</span> <span class="n">HP100_RESET_LB</span><span class="p">,</span> <span class="n">OPTION_MSW</span><span class="p">);</span>

	<span class="n">hp100_outb</span><span class="p">(</span><span class="n">HP100_ADV_NXT_PKT</span> <span class="o">|</span>
		   <span class="n">HP100_TX_CMD</span> <span class="o">|</span> <span class="n">HP100_RESET_LB</span><span class="p">,</span> <span class="n">OPTION_MSW</span><span class="p">);</span>

	<span class="cm">/* If busmaster, initialize the PDLs */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">hp100_init_pdls</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* Go to performance page and initialize isr and imr registers */</span>
	<span class="n">hp100_page</span><span class="p">(</span><span class="n">PERFORMANCE</span><span class="p">);</span>
	<span class="n">hp100_outw</span><span class="p">(</span><span class="mh">0xfefe</span><span class="p">,</span> <span class="n">IRQ_MASK</span><span class="p">);</span>	<span class="cm">/* mask off all ints */</span>
	<span class="n">hp100_outw</span><span class="p">(</span><span class="mh">0xffff</span><span class="p">,</span> <span class="n">IRQ_STATUS</span><span class="p">);</span>	<span class="cm">/* ack IRQ */</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  open/close functions</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hp100_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hp100_private</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="cp">#ifdef HP100_DEBUG_B</span>
	<span class="kt">int</span> <span class="n">ioaddr</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef HP100_DEBUG_B</span>
	<span class="n">hp100_outw</span><span class="p">(</span><span class="mh">0x4204</span><span class="p">,</span> <span class="n">TRACE</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;hp100: %s: open</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="cm">/* New: if bus is PCI or EISA, interrupts might be shared interrupts */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">request_irq</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">hp100_interrupt</span><span class="p">,</span>
			<span class="n">lp</span><span class="o">-&gt;</span><span class="n">bus</span> <span class="o">==</span> <span class="n">HP100_BUS_PCI</span> <span class="o">||</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">bus</span> <span class="o">==</span>
			<span class="n">HP100_BUS_EISA</span> <span class="o">?</span> <span class="n">IRQF_SHARED</span> <span class="o">:</span> <span class="n">IRQF_DISABLED</span><span class="p">,</span>
			<span class="s">&quot;hp100&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;hp100: %s: unable to get IRQ %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">trans_start</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span> <span class="cm">/* prevent tx timeout */</span>
	<span class="n">netif_start_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">lan_type</span> <span class="o">=</span> <span class="n">hp100_sense_lan</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">mac1_mode</span> <span class="o">=</span> <span class="n">HP100_MAC1MODE3</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">mac2_mode</span> <span class="o">=</span> <span class="n">HP100_MAC2MODE3</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">hash_bytes</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>

	<span class="n">hp100_stop_interface</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">hp100_hwinit</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">hp100_start_interface</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>	<span class="cm">/* sets mac modes, enables interrupts */</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* The close function is called when the interface is to be brought down */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">hp100_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ioaddr</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hp100_private</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

<span class="cp">#ifdef HP100_DEBUG_B</span>
	<span class="n">hp100_outw</span><span class="p">(</span><span class="mh">0x4205</span><span class="p">,</span> <span class="n">TRACE</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;hp100: %s: close</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="n">hp100_page</span><span class="p">(</span><span class="n">PERFORMANCE</span><span class="p">);</span>
	<span class="n">hp100_outw</span><span class="p">(</span><span class="mh">0xfefe</span><span class="p">,</span> <span class="n">IRQ_MASK</span><span class="p">);</span>	<span class="cm">/* mask off all IRQs */</span>

	<span class="n">hp100_stop_interface</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">lan_type</span> <span class="o">==</span> <span class="n">HP100_LAN_100</span><span class="p">)</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">hub_status</span> <span class="o">=</span> <span class="n">hp100_login_to_vg_hub</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">free_irq</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>

<span class="cp">#ifdef HP100_DEBUG</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;hp100: %s: close LSW = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
	       <span class="n">hp100_inw</span><span class="p">(</span><span class="n">OPTION_LSW</span><span class="p">));</span>
<span class="cp">#endif</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * Configure the PDL Rx rings and LAN</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">hp100_init_pdls</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hp100_private</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">hp100_ring_t</span> <span class="o">*</span><span class="n">ringptr</span><span class="p">;</span>
	<span class="n">u_int</span> <span class="o">*</span><span class="n">pageptr</span><span class="p">;</span>		<span class="cm">/* Warning : increment by 4 - Jean II */</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

<span class="cp">#ifdef HP100_DEBUG_B</span>
	<span class="kt">int</span> <span class="n">ioaddr</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef HP100_DEBUG_B</span>
	<span class="n">hp100_outw</span><span class="p">(</span><span class="mh">0x4206</span><span class="p">,</span> <span class="n">TRACE</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;hp100: %s: init pdls</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">page_vaddr_algn</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;hp100: %s: Warning: lp-&gt;page_vaddr_algn not initialised!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* pageptr shall point into the DMA accessible memory region  */</span>
		<span class="cm">/* we use this pointer to status the upper limit of allocated */</span>
		<span class="cm">/* memory in the allocated page. */</span>
		<span class="cm">/* note: align the pointers to the pci cache line size */</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">page_vaddr_algn</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">MAX_RINGSIZE</span><span class="p">);</span>	<span class="cm">/* Zero  Rx/Tx ring page */</span>
		<span class="n">pageptr</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">page_vaddr_algn</span><span class="p">;</span>

		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">rxrcommit</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ringptr</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">rxrhead</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">rxrtail</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">rxring</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>

		<span class="cm">/* Initialise Rx Ring */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">MAX_RX_PDL</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">lp</span><span class="o">-&gt;</span><span class="n">rxring</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">next</span> <span class="o">=</span> <span class="n">ringptr</span><span class="p">;</span>
			<span class="n">ringptr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">rxring</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
			<span class="n">pageptr</span> <span class="o">+=</span> <span class="n">hp100_init_rxpdl</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ringptr</span><span class="p">,</span> <span class="n">pageptr</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* Initialise Tx Ring */</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">txrcommit</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ringptr</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">txrhead</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">txrtail</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">txring</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">MAX_TX_PDL</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">lp</span><span class="o">-&gt;</span><span class="n">txring</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">next</span> <span class="o">=</span> <span class="n">ringptr</span><span class="p">;</span>
			<span class="n">ringptr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">txring</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
			<span class="n">pageptr</span> <span class="o">+=</span> <span class="n">hp100_init_txpdl</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ringptr</span><span class="p">,</span> <span class="n">pageptr</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="cm">/* These functions &quot;format&quot; the entries in the pdl structure   */</span>
<span class="cm">/* They return how much memory the fragments need.            */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">hp100_init_rxpdl</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			    <span class="k">register</span> <span class="n">hp100_ring_t</span> <span class="o">*</span> <span class="n">ringptr</span><span class="p">,</span>
			    <span class="k">register</span> <span class="n">u32</span> <span class="o">*</span> <span class="n">pdlptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* pdlptr is starting address for this pdl */</span>

	<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">!=</span> <span class="p">(((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">pdlptr</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">))</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;hp100: %s: Init rxpdl: Unaligned pdlptr 0x%lx.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">pdlptr</span><span class="p">);</span>

	<span class="n">ringptr</span><span class="o">-&gt;</span><span class="n">pdl</span> <span class="o">=</span> <span class="n">pdlptr</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">ringptr</span><span class="o">-&gt;</span><span class="n">pdl_paddr</span> <span class="o">=</span> <span class="n">virt_to_whatever</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">pdlptr</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">ringptr</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Write address and length of first PDL Fragment (which is used for</span>
<span class="cm">	 * storing the RX-Header</span>
<span class="cm">	 * We use the 4 bytes _before_ the PDH in the pdl memory area to</span>
<span class="cm">	 * store this information. (PDH is at offset 0x04)</span>
<span class="cm">	 */</span>
	<span class="cm">/* Note that pdlptr+1 and not pdlptr is the pointer to the PDH */</span>

	<span class="o">*</span><span class="p">(</span><span class="n">pdlptr</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">u_int</span><span class="p">)</span> <span class="n">virt_to_whatever</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">pdlptr</span><span class="p">);</span>	<span class="cm">/* Address Frag 1 */</span>
	<span class="o">*</span><span class="p">(</span><span class="n">pdlptr</span> <span class="o">+</span> <span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>	<span class="cm">/* Length  Frag 1 */</span>

	<span class="k">return</span> <span class="n">roundup</span><span class="p">(</span><span class="n">MAX_RX_FRAG</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">hp100_init_txpdl</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			    <span class="k">register</span> <span class="n">hp100_ring_t</span> <span class="o">*</span> <span class="n">ringptr</span><span class="p">,</span>
			    <span class="k">register</span> <span class="n">u32</span> <span class="o">*</span> <span class="n">pdlptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">!=</span> <span class="p">(((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">pdlptr</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">))</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;hp100: %s: Init txpdl: Unaligned pdlptr 0x%lx.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">pdlptr</span><span class="p">);</span>

	<span class="n">ringptr</span><span class="o">-&gt;</span><span class="n">pdl</span> <span class="o">=</span> <span class="n">pdlptr</span><span class="p">;</span>	<span class="cm">/* +1; */</span>
	<span class="n">ringptr</span><span class="o">-&gt;</span><span class="n">pdl_paddr</span> <span class="o">=</span> <span class="n">virt_to_whatever</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">pdlptr</span><span class="p">);</span>	<span class="cm">/* +1 */</span>
	<span class="n">ringptr</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">roundup</span><span class="p">(</span><span class="n">MAX_TX_FRAG</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * hp100_build_rx_pdl allocates an skb_buff of maximum size plus two bytes</span>
<span class="cm"> * for possible odd word alignment rounding up to next dword and set PDL</span>
<span class="cm"> * address for fragment#2</span>
<span class="cm"> * Returns: 0 if unable to allocate skb_buff</span>
<span class="cm"> *          1 if successful</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">hp100_build_rx_pdl</span><span class="p">(</span><span class="n">hp100_ring_t</span> <span class="o">*</span> <span class="n">ringptr</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef HP100_DEBUG_B</span>
	<span class="kt">int</span> <span class="n">ioaddr</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef HP100_DEBUG_BM</span>
	<span class="n">u_int</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef HP100_DEBUG_B</span>
	<span class="n">hp100_outw</span><span class="p">(</span><span class="mh">0x4207</span><span class="p">,</span> <span class="n">TRACE</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;hp100: %s: build rx pdl</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="cm">/* Allocate skb buffer of maximum size */</span>
	<span class="cm">/* Note: This depends on the alloc_skb functions allocating more</span>
<span class="cm">	 * space than requested, i.e. aligning to 16bytes */</span>

	<span class="n">ringptr</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">=</span> <span class="n">netdev_alloc_skb</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">roundup</span><span class="p">(</span><span class="n">MAX_ETHER_SIZE</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="nb">NULL</span> <span class="o">!=</span> <span class="n">ringptr</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Reserve 2 bytes at the head of the buffer to land the IP header</span>
<span class="cm">		 * on a long word boundary (According to the Network Driver section</span>
<span class="cm">		 * in the Linux KHG, this should help to increase performance.)</span>
<span class="cm">		 */</span>
		<span class="n">skb_reserve</span><span class="p">(</span><span class="n">ringptr</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>

		<span class="n">ringptr</span><span class="o">-&gt;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="n">u_char</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb_put</span><span class="p">(</span><span class="n">ringptr</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">,</span> <span class="n">MAX_ETHER_SIZE</span><span class="p">);</span>

		<span class="cm">/* ringptr-&gt;pdl points to the beginning of the PDL, i.e. the PDH */</span>
		<span class="cm">/* Note: 1st Fragment is used for the 4 byte packet status</span>
<span class="cm">		 * (receive header). Its PDL entries are set up by init_rxpdl. So</span>
<span class="cm">		 * here we only have to set up the PDL fragment entries for the data</span>
<span class="cm">		 * part. Those 4 bytes will be stored in the DMA memory region</span>
<span class="cm">		 * directly before the PDL.</span>
<span class="cm">		 */</span>
<span class="cp">#ifdef HP100_DEBUG_BM</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;hp100: %s: build_rx_pdl: PDH@0x%x, skb-&gt;data (len %d) at 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				     <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="p">(</span><span class="n">u_int</span><span class="p">)</span> <span class="n">ringptr</span><span class="o">-&gt;</span><span class="n">pdl</span><span class="p">,</span>
				     <span class="n">roundup</span><span class="p">(</span><span class="n">MAX_ETHER_SIZE</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
				     <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span> <span class="n">ringptr</span><span class="o">-&gt;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
<span class="cp">#endif</span>

		<span class="cm">/* Conversion to new PCI API : map skbuf data to PCI bus.</span>
<span class="cm">		 * Doc says it&#39;s OK for EISA as well - Jean II */</span>
		<span class="n">ringptr</span><span class="o">-&gt;</span><span class="n">pdl</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00020000</span><span class="p">;</span>	<span class="cm">/* Write PDH */</span>
		<span class="n">ringptr</span><span class="o">-&gt;</span><span class="n">pdl</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">pdl_map_data</span><span class="p">(</span><span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">),</span>
					       <span class="n">ringptr</span><span class="o">-&gt;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
		<span class="n">ringptr</span><span class="o">-&gt;</span><span class="n">pdl</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">MAX_ETHER_SIZE</span><span class="p">;</span>	<span class="cm">/* Length of Data */</span>

<span class="cp">#ifdef HP100_DEBUG_BM</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="n">ringptr</span><span class="o">-&gt;</span><span class="n">pdl</span><span class="p">);</span> <span class="n">p</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">ringptr</span><span class="o">-&gt;</span><span class="n">pdl</span> <span class="o">+</span> <span class="mi">5</span><span class="p">);</span> <span class="n">p</span><span class="o">++</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;hp100: %s: Adr 0x%.8x = 0x%.8x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="p">(</span><span class="n">u_int</span><span class="p">)</span> <span class="n">p</span><span class="p">,</span> <span class="p">(</span><span class="n">u_int</span><span class="p">)</span> <span class="o">*</span> <span class="n">p</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* else: */</span>
	<span class="cm">/* alloc_skb failed (no memory) -&gt; still can receive the header</span>
<span class="cm">	 * fragment into PDL memory. make PDL safe by clearing msgptr and</span>
<span class="cm">	 * making the PDL only 1 fragment (i.e. the 4 byte packet status)</span>
<span class="cm">	 */</span>
<span class="cp">#ifdef HP100_DEBUG_BM</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;hp100: %s: build_rx_pdl: PDH@0x%x, No space for skb.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="p">(</span><span class="n">u_int</span><span class="p">)</span> <span class="n">ringptr</span><span class="o">-&gt;</span><span class="n">pdl</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="n">ringptr</span><span class="o">-&gt;</span><span class="n">pdl</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00010000</span><span class="p">;</span>	<span class="cm">/* PDH: Count=1 Fragment */</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  hp100_rxfill - attempt to fill the Rx Ring will empty skb&#39;s</span>
<span class="cm"> *</span>
<span class="cm"> * Makes assumption that skb&#39;s are always contiguous memory areas and</span>
<span class="cm"> * therefore PDLs contain only 2 physical fragments.</span>
<span class="cm"> * -  While the number of Rx PDLs with buffers is less than maximum</span>
<span class="cm"> *      a.  Get a maximum packet size skb</span>
<span class="cm"> *      b.  Put the physical address of the buffer into the PDL.</span>
<span class="cm"> *      c.  Output physical address of PDL to adapter.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">hp100_rxfill</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ioaddr</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">hp100_private</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">hp100_ring_t</span> <span class="o">*</span><span class="n">ringptr</span><span class="p">;</span>

<span class="cp">#ifdef HP100_DEBUG_B</span>
	<span class="n">hp100_outw</span><span class="p">(</span><span class="mh">0x4208</span><span class="p">,</span> <span class="n">TRACE</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;hp100: %s: rxfill</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="n">hp100_page</span><span class="p">(</span><span class="n">PERFORMANCE</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">rxrcommit</span> <span class="o">&lt;</span> <span class="n">MAX_RX_PDL</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		   ** Attempt to get a buffer and build a Rx PDL.</span>
<span class="cm">		 */</span>
		<span class="n">ringptr</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">rxrtail</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">==</span> <span class="n">hp100_build_rx_pdl</span><span class="p">(</span><span class="n">ringptr</span><span class="p">,</span> <span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">return</span><span class="p">;</span>	<span class="cm">/* None available, return */</span>
		<span class="p">}</span>

		<span class="cm">/* Hand this PDL over to the card */</span>
		<span class="cm">/* Note: This needs performance page selected! */</span>
<span class="cp">#ifdef HP100_DEBUG_BM</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;hp100: %s: rxfill: Hand to card: pdl #%d @0x%x phys:0x%x, buffer: 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				     <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">rxrcommit</span><span class="p">,</span> <span class="p">(</span><span class="n">u_int</span><span class="p">)</span> <span class="n">ringptr</span><span class="o">-&gt;</span><span class="n">pdl</span><span class="p">,</span>
				     <span class="p">(</span><span class="n">u_int</span><span class="p">)</span> <span class="n">ringptr</span><span class="o">-&gt;</span><span class="n">pdl_paddr</span><span class="p">,</span> <span class="p">(</span><span class="n">u_int</span><span class="p">)</span> <span class="n">ringptr</span><span class="o">-&gt;</span><span class="n">pdl</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
<span class="cp">#endif</span>

		<span class="n">hp100_outl</span><span class="p">((</span><span class="n">u32</span><span class="p">)</span> <span class="n">ringptr</span><span class="o">-&gt;</span><span class="n">pdl_paddr</span><span class="p">,</span> <span class="n">RX_PDA</span><span class="p">);</span>

		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">rxrcommit</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">rxrtail</span> <span class="o">=</span> <span class="n">ringptr</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * BM_shutdown - shutdown bus mastering and leave chip in reset state</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hp100_BM_shutdown</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ioaddr</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hp100_private</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">time</span><span class="p">;</span>

<span class="cp">#ifdef HP100_DEBUG_B</span>
	<span class="n">hp100_outw</span><span class="p">(</span><span class="mh">0x4209</span><span class="p">,</span> <span class="n">TRACE</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;hp100: %s: bm shutdown</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="n">hp100_page</span><span class="p">(</span><span class="n">PERFORMANCE</span><span class="p">);</span>
	<span class="n">hp100_outw</span><span class="p">(</span><span class="mh">0xfefe</span><span class="p">,</span> <span class="n">IRQ_MASK</span><span class="p">);</span>	<span class="cm">/* mask off all ints */</span>
	<span class="n">hp100_outw</span><span class="p">(</span><span class="mh">0xffff</span><span class="p">,</span> <span class="n">IRQ_STATUS</span><span class="p">);</span>	<span class="cm">/* Ack all ints */</span>

	<span class="cm">/* Ensure Interrupts are off */</span>
	<span class="n">hp100_outw</span><span class="p">(</span><span class="n">HP100_INT_EN</span> <span class="o">|</span> <span class="n">HP100_RESET_LB</span><span class="p">,</span> <span class="n">OPTION_LSW</span><span class="p">);</span>

	<span class="cm">/* Disable all MAC activity */</span>
	<span class="n">hp100_page</span><span class="p">(</span><span class="n">MAC_CTRL</span><span class="p">);</span>
	<span class="n">hp100_andb</span><span class="p">(</span><span class="o">~</span><span class="p">(</span><span class="n">HP100_RX_EN</span> <span class="o">|</span> <span class="n">HP100_TX_EN</span><span class="p">),</span> <span class="n">MAC_CFG_1</span><span class="p">);</span>	<span class="cm">/* stop rx/tx */</span>

	<span class="cm">/* If cascade MMU is not already in reset */</span>
	<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">!=</span> <span class="p">(</span><span class="n">hp100_inw</span><span class="p">(</span><span class="n">OPTION_LSW</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">HP100_HW_RST</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Wait 1.3ms (10Mb max packet time) to ensure MAC is idle so</span>
<span class="cm">		 * MMU pointers will not be reset out from underneath</span>
<span class="cm">		 */</span>
		<span class="n">hp100_page</span><span class="p">(</span><span class="n">MAC_CTRL</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">time</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">time</span> <span class="o">&lt;</span> <span class="mi">5000</span><span class="p">;</span> <span class="n">time</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">hp100_inb</span><span class="p">(</span><span class="n">MAC_CFG_1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">HP100_TX_IDLE</span> <span class="o">|</span> <span class="n">HP100_RX_IDLE</span><span class="p">))</span> <span class="o">==</span> <span class="p">(</span><span class="n">HP100_TX_IDLE</span> <span class="o">|</span> <span class="n">HP100_RX_IDLE</span><span class="p">))</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Shutdown algorithm depends on the generation of Cascade */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">chip</span> <span class="o">==</span> <span class="n">HP100_CHIPID_LASSEN</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* ETR shutdown/reset */</span>
			<span class="cm">/* Disable Busmaster mode and wait for bit to go to zero. */</span>
			<span class="n">hp100_page</span><span class="p">(</span><span class="n">HW_MAP</span><span class="p">);</span>
			<span class="n">hp100_andb</span><span class="p">(</span><span class="o">~</span><span class="n">HP100_BM_MASTER</span><span class="p">,</span> <span class="n">BM</span><span class="p">);</span>
			<span class="cm">/* 100 ms timeout */</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">time</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">time</span> <span class="o">&lt;</span> <span class="mi">32000</span><span class="p">;</span> <span class="n">time</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">==</span> <span class="p">(</span><span class="n">hp100_inb</span><span class="p">(</span><span class="n">BM</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">HP100_BM_MASTER</span><span class="p">))</span>
					<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>	<span class="cm">/* Shasta or Rainier Shutdown/Reset */</span>
			<span class="cm">/* To ensure all bus master inloading activity has ceased,</span>
<span class="cm">			 * wait for no Rx PDAs or no Rx packets on card.</span>
<span class="cm">			 */</span>
			<span class="n">hp100_page</span><span class="p">(</span><span class="n">PERFORMANCE</span><span class="p">);</span>
			<span class="cm">/* 100 ms timeout */</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">time</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">time</span> <span class="o">&lt;</span> <span class="mi">10000</span><span class="p">;</span> <span class="n">time</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* RX_PDL: PDLs not executed. */</span>
				<span class="cm">/* RX_PKT_CNT: RX&#39;d packets on card. */</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">hp100_inb</span><span class="p">(</span><span class="n">RX_PDL</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">hp100_inb</span><span class="p">(</span><span class="n">RX_PKT_CNT</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span>
					<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">time</span> <span class="o">&gt;=</span> <span class="mi">10000</span><span class="p">)</span>
				<span class="n">printk</span><span class="p">(</span><span class="s">&quot;hp100: %s: BM shutdown error.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

			<span class="cm">/* To ensure all bus master outloading activity has ceased,</span>
<span class="cm">			 * wait until the Tx PDA count goes to zero or no more Tx space</span>
<span class="cm">			 * available in the Tx region of the card.</span>
<span class="cm">			 */</span>
			<span class="cm">/* 100 ms timeout */</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">time</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">time</span> <span class="o">&lt;</span> <span class="mi">10000</span><span class="p">;</span> <span class="n">time</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">((</span><span class="mi">0</span> <span class="o">==</span> <span class="n">hp100_inb</span><span class="p">(</span><span class="n">TX_PKT_CNT</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
				    <span class="p">(</span><span class="mi">0</span> <span class="o">!=</span> <span class="p">(</span><span class="n">hp100_inb</span><span class="p">(</span><span class="n">TX_MEM_FREE</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">HP100_AUTO_COMPARE</span><span class="p">)))</span>
					<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="cm">/* Disable Busmaster mode */</span>
			<span class="n">hp100_page</span><span class="p">(</span><span class="n">HW_MAP</span><span class="p">);</span>
			<span class="n">hp100_andb</span><span class="p">(</span><span class="o">~</span><span class="n">HP100_BM_MASTER</span><span class="p">,</span> <span class="n">BM</span><span class="p">);</span>
		<span class="p">}</span>	<span class="cm">/* end of shutdown procedure for non-etr parts */</span>

		<span class="n">hp100_cascade_reset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">hp100_page</span><span class="p">(</span><span class="n">PERFORMANCE</span><span class="p">);</span>
	<span class="cm">/* hp100_outw( HP100_BM_READ | HP100_BM_WRITE | HP100_RESET_HB, OPTION_LSW ); */</span>
	<span class="cm">/* Busmaster mode should be shut down now. */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hp100_check_lan</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hp100_private</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">lan_type</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* no LAN type detected yet? */</span>
		<span class="n">hp100_stop_interface</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">lan_type</span> <span class="o">=</span> <span class="n">hp100_sense_lan</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;hp100: %s: no connection found - check wire</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="n">hp100_start_interface</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>	<span class="cm">/* 10Mb/s RX packets maybe handled */</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">lan_type</span> <span class="o">==</span> <span class="n">HP100_LAN_100</span><span class="p">)</span>
			<span class="n">lp</span><span class="o">-&gt;</span><span class="n">hub_status</span> <span class="o">=</span> <span class="n">hp100_login_to_vg_hub</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>	<span class="cm">/* relogin */</span>
		<span class="n">hp100_start_interface</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  transmit functions</span>
<span class="cm"> */</span>

<span class="cm">/* tx function for busmaster mode */</span>
<span class="k">static</span> <span class="n">netdev_tx_t</span> <span class="nf">hp100_start_xmit_bm</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">ok_flag</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ioaddr</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hp100_private</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">hp100_ring_t</span> <span class="o">*</span><span class="n">ringptr</span><span class="p">;</span>

<span class="cp">#ifdef HP100_DEBUG_B</span>
	<span class="n">hp100_outw</span><span class="p">(</span><span class="mh">0x4210</span><span class="p">,</span> <span class="n">TRACE</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;hp100: %s: start_xmit_bm</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">drop</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">chip</span> <span class="o">==</span> <span class="n">HP100_CHIPID_SHASTA</span> <span class="o">&amp;&amp;</span> <span class="n">skb_padto</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">ETH_ZLEN</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">NETDEV_TX_OK</span><span class="p">;</span>

	<span class="cm">/* Get Tx ring tail pointer */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">txrtail</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">==</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">txrhead</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* No memory. */</span>
<span class="cp">#ifdef HP100_DEBUG</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;hp100: %s: start_xmit_bm: No TX PDL available.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="cm">/* not waited long enough since last tx? */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">time_before</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">dev_trans_start</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">+</span> <span class="n">HZ</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">drop</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">hp100_check_lan</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">drop</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">lan_type</span> <span class="o">==</span> <span class="n">HP100_LAN_100</span> <span class="o">&amp;&amp;</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">hub_status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* we have a 100Mb/s adapter but it isn&#39;t connected to hub */</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;hp100: %s: login to 100Mb/s hub retry</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="n">hp100_stop_interface</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="n">lp</span><span class="o">-&gt;</span><span class="n">hub_status</span> <span class="o">=</span> <span class="n">hp100_login_to_vg_hub</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">hp100_start_interface</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="n">hp100_ints_off</span><span class="p">();</span>	<span class="cm">/* Useful ? Jean II */</span>
			<span class="n">i</span> <span class="o">=</span> <span class="n">hp100_sense_lan</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="n">hp100_ints_on</span><span class="p">();</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">HP100_LAN_ERR</span><span class="p">)</span>
				<span class="n">printk</span><span class="p">(</span><span class="s">&quot;hp100: %s: link down detected</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">lan_type</span> <span class="o">!=</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* cable change! */</span>
				<span class="cm">/* it&#39;s very hard - all network settings must be changed!!! */</span>
				<span class="n">printk</span><span class="p">(</span><span class="s">&quot;hp100: %s: cable change 10Mb/s &lt;-&gt; 100Mb/s detected</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
				<span class="n">lp</span><span class="o">-&gt;</span><span class="n">lan_type</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
				<span class="n">hp100_stop_interface</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">lan_type</span> <span class="o">==</span> <span class="n">HP100_LAN_100</span><span class="p">)</span>
					<span class="n">lp</span><span class="o">-&gt;</span><span class="n">hub_status</span> <span class="o">=</span> <span class="n">hp100_login_to_vg_hub</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
				<span class="n">hp100_start_interface</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="s">&quot;hp100: %s: interface reset</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
				<span class="n">hp100_stop_interface</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">lan_type</span> <span class="o">==</span> <span class="n">HP100_LAN_100</span><span class="p">)</span>
					<span class="n">lp</span><span class="o">-&gt;</span><span class="n">hub_status</span> <span class="o">=</span> <span class="n">hp100_login_to_vg_hub</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
				<span class="n">hp100_start_interface</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">goto</span> <span class="n">drop</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * we have to turn int&#39;s off before modifying this, otherwise</span>
<span class="cm">	 * a tx_pdl_cleanup could occur at the same time</span>
<span class="cm">	 */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">ringptr</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">txrtail</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">txrtail</span> <span class="o">=</span> <span class="n">ringptr</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>

	<span class="cm">/* Check whether packet has minimal packet size */</span>
	<span class="n">ok_flag</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&gt;=</span> <span class="n">HP100_MIN_PACKET_SIZE</span><span class="p">;</span>
	<span class="n">i</span> <span class="o">=</span> <span class="n">ok_flag</span> <span class="o">?</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">:</span> <span class="n">HP100_MIN_PACKET_SIZE</span><span class="p">;</span>

	<span class="n">ringptr</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>
	<span class="n">ringptr</span><span class="o">-&gt;</span><span class="n">pdl</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="n">i</span><span class="p">);</span>	<span class="cm">/* PDH: 1 Fragment &amp; length */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">chip</span> <span class="o">==</span> <span class="n">HP100_CHIPID_SHASTA</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* TODO:Could someone who has the EISA card please check if this works? */</span>
		<span class="n">ringptr</span><span class="o">-&gt;</span><span class="n">pdl</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>		<span class="cm">/* Lassen */</span>
		<span class="cm">/* In the PDL, don&#39;t use the padded size but the real packet size: */</span>
		<span class="n">ringptr</span><span class="o">-&gt;</span><span class="n">pdl</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>	<span class="cm">/* 1st Frag: Length of frag */</span>
	<span class="p">}</span>
	<span class="cm">/* Conversion to new PCI API : map skbuf data to PCI bus.</span>
<span class="cm">	 * Doc says it&#39;s OK for EISA as well - Jean II */</span>
	<span class="n">ringptr</span><span class="o">-&gt;</span><span class="n">pdl</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">u32</span><span class="p">)</span> <span class="n">pci_map_single</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">ringptr</span><span class="o">-&gt;</span><span class="n">pdl</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">PCI_DMA_TODEVICE</span><span class="p">));</span>	<span class="cm">/* 1st Frag: Adr. of data */</span>

	<span class="cm">/* Hand this PDL to the card. */</span>
	<span class="n">hp100_outl</span><span class="p">(</span><span class="n">ringptr</span><span class="o">-&gt;</span><span class="n">pdl_paddr</span><span class="p">,</span> <span class="n">TX_PDA_L</span><span class="p">);</span>	<span class="cm">/* Low Prio. Queue */</span>

	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">txrcommit</span><span class="o">++</span><span class="p">;</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_packets</span><span class="o">++</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_bytes</span> <span class="o">+=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">NETDEV_TX_OK</span><span class="p">;</span>

<span class="nl">drop:</span>
	<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">NETDEV_TX_OK</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* clean_txring checks if packets have been sent by the card by reading</span>
<span class="cm"> * the TX_PDL register from the performance page and comparing it to the</span>
<span class="cm"> * number of committed packets. It then frees the skb&#39;s of the packets that</span>
<span class="cm"> * obviously have been sent to the network.</span>
<span class="cm"> *</span>
<span class="cm"> * Needs the PERFORMANCE page selected.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">hp100_clean_txring</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hp100_private</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ioaddr</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">donecount</span><span class="p">;</span>

<span class="cp">#ifdef HP100_DEBUG_B</span>
	<span class="n">hp100_outw</span><span class="p">(</span><span class="mh">0x4211</span><span class="p">,</span> <span class="n">TRACE</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;hp100: %s: clean txring</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="cm">/* How many PDLs have been transmitted? */</span>
	<span class="n">donecount</span> <span class="o">=</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">txrcommit</span><span class="p">)</span> <span class="o">-</span> <span class="n">hp100_inb</span><span class="p">(</span><span class="n">TX_PDL</span><span class="p">);</span>

<span class="cp">#ifdef HP100_DEBUG</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">donecount</span> <span class="o">&gt;</span> <span class="n">MAX_TX_PDL</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;hp100: %s: Warning: More PDLs transmitted than committed to card???</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="k">for</span> <span class="p">(;</span> <span class="mi">0</span> <span class="o">!=</span> <span class="n">donecount</span><span class="p">;</span> <span class="n">donecount</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifdef HP100_DEBUG_BM</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;hp100: %s: Free skb: data @0x%.8x txrcommit=0x%x TXPDL=0x%x, done=0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="p">(</span><span class="n">u_int</span><span class="p">)</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">txrhead</span><span class="o">-&gt;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span>
				<span class="n">lp</span><span class="o">-&gt;</span><span class="n">txrcommit</span><span class="p">,</span> <span class="n">hp100_inb</span><span class="p">(</span><span class="n">TX_PDL</span><span class="p">),</span> <span class="n">donecount</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="cm">/* Conversion to new PCI API : NOP */</span>
		<span class="n">pci_unmap_single</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span> <span class="p">(</span><span class="n">dma_addr_t</span><span class="p">)</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">txrhead</span><span class="o">-&gt;</span><span class="n">pdl</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">txrhead</span><span class="o">-&gt;</span><span class="n">pdl</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">PCI_DMA_TODEVICE</span><span class="p">);</span>
		<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">txrhead</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">);</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">txrhead</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">txrhead</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">txrhead</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">txrcommit</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* tx function for slave modes */</span>
<span class="k">static</span> <span class="n">netdev_tx_t</span> <span class="nf">hp100_start_xmit</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">ok_flag</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ioaddr</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>
	<span class="n">u_short</span> <span class="n">val</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hp100_private</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

<span class="cp">#ifdef HP100_DEBUG_B</span>
	<span class="n">hp100_outw</span><span class="p">(</span><span class="mh">0x4212</span><span class="p">,</span> <span class="n">TRACE</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;hp100: %s: start_xmit</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">drop</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hp100_check_lan</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">drop</span><span class="p">;</span>

	<span class="cm">/* If there is not enough free memory on the card... */</span>
	<span class="n">i</span> <span class="o">=</span> <span class="n">hp100_inl</span><span class="p">(</span><span class="n">TX_MEM_FREE</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7fffffff</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(((</span><span class="n">i</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="mi">539</span><span class="p">)</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">+</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">hp100_inb</span><span class="p">(</span><span class="n">TX_PKT_CNT</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">255</span><span class="p">)))</span> <span class="p">{</span>
<span class="cp">#ifdef HP100_DEBUG</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;hp100: %s: start_xmit: tx free mem = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="cm">/* not waited long enough since last failed tx try? */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">time_before</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">dev_trans_start</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">+</span> <span class="n">HZ</span><span class="p">))</span> <span class="p">{</span>
<span class="cp">#ifdef HP100_DEBUG</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;hp100: %s: trans_start timing problem</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
<span class="cp">#endif</span>
			<span class="k">goto</span> <span class="n">drop</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">lan_type</span> <span class="o">==</span> <span class="n">HP100_LAN_100</span> <span class="o">&amp;&amp;</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">hub_status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* we have a 100Mb/s adapter but it isn&#39;t connected to hub */</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;hp100: %s: login to 100Mb/s hub retry</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="n">hp100_stop_interface</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="n">lp</span><span class="o">-&gt;</span><span class="n">hub_status</span> <span class="o">=</span> <span class="n">hp100_login_to_vg_hub</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">hp100_start_interface</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="n">hp100_ints_off</span><span class="p">();</span>	<span class="cm">/* Useful ? Jean II */</span>
			<span class="n">i</span> <span class="o">=</span> <span class="n">hp100_sense_lan</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="n">hp100_ints_on</span><span class="p">();</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">HP100_LAN_ERR</span><span class="p">)</span>
				<span class="n">printk</span><span class="p">(</span><span class="s">&quot;hp100: %s: link down detected</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">lan_type</span> <span class="o">!=</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* cable change! */</span>
				<span class="cm">/* it&#39;s very hard - all network setting must be changed!!! */</span>
				<span class="n">printk</span><span class="p">(</span><span class="s">&quot;hp100: %s: cable change 10Mb/s &lt;-&gt; 100Mb/s detected</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
				<span class="n">lp</span><span class="o">-&gt;</span><span class="n">lan_type</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
				<span class="n">hp100_stop_interface</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">lan_type</span> <span class="o">==</span> <span class="n">HP100_LAN_100</span><span class="p">)</span>
					<span class="n">lp</span><span class="o">-&gt;</span><span class="n">hub_status</span> <span class="o">=</span> <span class="n">hp100_login_to_vg_hub</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
				<span class="n">hp100_start_interface</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="s">&quot;hp100: %s: interface reset</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
				<span class="n">hp100_stop_interface</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">lan_type</span> <span class="o">==</span> <span class="n">HP100_LAN_100</span><span class="p">)</span>
					<span class="n">lp</span><span class="o">-&gt;</span><span class="n">hub_status</span> <span class="o">=</span> <span class="n">hp100_login_to_vg_hub</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
				<span class="n">hp100_start_interface</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
				<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">goto</span> <span class="n">drop</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">6000</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">hp100_inb</span><span class="p">(</span><span class="n">OPTION_MSW</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">HP100_TX_CMD</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifdef HP100_DEBUG_TX</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;hp100: %s: start_xmit: busy</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="p">}</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">hp100_ints_off</span><span class="p">();</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">hp100_inw</span><span class="p">(</span><span class="n">IRQ_STATUS</span><span class="p">);</span>
	<span class="cm">/* Ack / clear the interrupt TX_COMPLETE interrupt - this interrupt is set</span>
<span class="cm">	 * when the current packet being transmitted on the wire is completed. */</span>
	<span class="n">hp100_outw</span><span class="p">(</span><span class="n">HP100_TX_COMPLETE</span><span class="p">,</span> <span class="n">IRQ_STATUS</span><span class="p">);</span>
<span class="cp">#ifdef HP100_DEBUG_TX</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;hp100: %s: start_xmit: irq_status=0x%.4x, irqmask=0x%.4x, len=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">hp100_inw</span><span class="p">(</span><span class="n">IRQ_MASK</span><span class="p">),</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="n">ok_flag</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&gt;=</span> <span class="n">HP100_MIN_PACKET_SIZE</span><span class="p">;</span>
	<span class="n">i</span> <span class="o">=</span> <span class="n">ok_flag</span> <span class="o">?</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">:</span> <span class="n">HP100_MIN_PACKET_SIZE</span><span class="p">;</span>

	<span class="n">hp100_outw</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">DATA32</span><span class="p">);</span>	<span class="cm">/* tell card the total packet length */</span>
	<span class="n">hp100_outw</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">FRAGMENT_LEN</span><span class="p">);</span>	<span class="cm">/* and first/only fragment length    */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* memory mapped */</span>
		<span class="cm">/* Note: The J2585B needs alignment to 32bits here!  */</span>
		<span class="n">memcpy_toio</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">mem_ptr_virt</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">+</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">3</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ok_flag</span><span class="p">)</span>
			<span class="n">memset_io</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">mem_ptr_virt</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">HP100_MIN_PACKET_SIZE</span> <span class="o">-</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>		<span class="cm">/* programmed i/o */</span>
		<span class="n">outsl</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">HP100_REG_DATA32</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span>
		      <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">+</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ok_flag</span><span class="p">)</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">+</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">3</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">HP100_MIN_PACKET_SIZE</span><span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">)</span>
				<span class="n">hp100_outl</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">DATA32</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">hp100_outb</span><span class="p">(</span><span class="n">HP100_TX_CMD</span> <span class="o">|</span> <span class="n">HP100_SET_LB</span><span class="p">,</span> <span class="n">OPTION_MSW</span><span class="p">);</span>	<span class="cm">/* send packet */</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_packets</span><span class="o">++</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_bytes</span> <span class="o">+=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
	<span class="n">hp100_ints_on</span><span class="p">();</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

<span class="cp">#ifdef HP100_DEBUG_TX</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;hp100: %s: start_xmit: end</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="k">return</span> <span class="n">NETDEV_TX_OK</span><span class="p">;</span>

<span class="nl">drop:</span>
	<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">NETDEV_TX_OK</span><span class="p">;</span>

<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * Receive Function (Non-Busmaster mode)</span>
<span class="cm"> * Called when an &quot;Receive Packet&quot; interrupt occurs, i.e. the receive</span>
<span class="cm"> * packet counter is non-zero.</span>
<span class="cm"> * For non-busmaster, this function does the whole work of transferring</span>
<span class="cm"> * the packet to the host memory and then up to higher layers via skb</span>
<span class="cm"> * and netif_rx.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hp100_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">packets</span><span class="p">,</span> <span class="n">pkt_len</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ioaddr</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hp100_private</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u_int</span> <span class="n">header</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>

<span class="cp">#ifdef DEBUG_B</span>
	<span class="n">hp100_outw</span><span class="p">(</span><span class="mh">0x4213</span><span class="p">,</span> <span class="n">TRACE</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;hp100: %s: rx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="cm">/* First get indication of received lan packet */</span>
	<span class="cm">/* RX_PKT_CND indicates the number of packets which have been fully */</span>
	<span class="cm">/* received onto the card but have not been fully transferred of the card */</span>
	<span class="n">packets</span> <span class="o">=</span> <span class="n">hp100_inb</span><span class="p">(</span><span class="n">RX_PKT_CNT</span><span class="p">);</span>
<span class="cp">#ifdef HP100_DEBUG_RX</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">packets</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;hp100: %s: rx: waiting packets = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">packets</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">packets</span><span class="o">--</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* If ADV_NXT_PKT is still set, we have to wait until the card has */</span>
		<span class="cm">/* really advanced to the next packet. */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">pkt_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">pkt_len</span> <span class="o">&lt;</span> <span class="mi">6000</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">hp100_inb</span><span class="p">(</span><span class="n">OPTION_MSW</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">HP100_ADV_NXT_PKT</span><span class="p">);</span> <span class="n">pkt_len</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifdef HP100_DEBUG_RX</span>
			<span class="n">printk</span> <span class="p">(</span><span class="s">&quot;hp100: %s: rx: busy, remaining packets = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">packets</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="p">}</span>

		<span class="cm">/* First we get the header, which contains information about the */</span>
		<span class="cm">/* actual length of the received packet. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* memory mapped mode */</span>
			<span class="n">header</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">mem_ptr_virt</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>		<span class="cm">/* programmed i/o */</span>
			<span class="n">header</span> <span class="o">=</span> <span class="n">hp100_inl</span><span class="p">(</span><span class="n">DATA32</span><span class="p">);</span>

		<span class="n">pkt_len</span> <span class="o">=</span> <span class="p">((</span><span class="n">header</span> <span class="o">&amp;</span> <span class="n">HP100_PKT_LEN_MASK</span><span class="p">)</span> <span class="o">+</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">3</span><span class="p">;</span>

<span class="cp">#ifdef HP100_DEBUG_RX</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;hp100: %s: rx: new packet - length=%d, errors=0x%x, dest=0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				     <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">header</span> <span class="o">&amp;</span> <span class="n">HP100_PKT_LEN_MASK</span><span class="p">,</span>
				     <span class="p">(</span><span class="n">header</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xfff8</span><span class="p">,</span> <span class="p">(</span><span class="n">header</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">7</span><span class="p">);</span>
<span class="cp">#endif</span>

		<span class="cm">/* Now we allocate the skb and transfer the data into it. */</span>
		<span class="n">skb</span> <span class="o">=</span> <span class="n">netdev_alloc_skb</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">pkt_len</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">skb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* Not enough memory-&gt;drop packet */</span>
<span class="cp">#ifdef HP100_DEBUG</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;hp100: %s: rx: couldn&#39;t allocate a sk_buff of size %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					     <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">pkt_len</span><span class="p">);</span>
<span class="cp">#endif</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_dropped</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>	<span class="cm">/* skb successfully allocated */</span>

			<span class="n">u_char</span> <span class="o">*</span><span class="n">ptr</span><span class="p">;</span>

			<span class="n">skb_reserve</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span><span class="mi">2</span><span class="p">);</span>

			<span class="cm">/* ptr to start of the sk_buff data area */</span>
			<span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">pkt_len</span><span class="p">);</span>
			<span class="n">ptr</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

			<span class="cm">/* Now transfer the data from the card into that area */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
				<span class="n">memcpy_fromio</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">mem_ptr_virt</span><span class="p">,</span><span class="n">pkt_len</span><span class="p">);</span>
			<span class="k">else</span>	<span class="cm">/* io mapped */</span>
				<span class="n">insl</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">HP100_REG_DATA32</span><span class="p">,</span> <span class="n">ptr</span><span class="p">,</span> <span class="n">pkt_len</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">);</span>

			<span class="n">skb</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">eth_type_trans</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>

<span class="cp">#ifdef HP100_DEBUG_RX</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;hp100: %s: rx: %02x %02x %02x %02x %02x %02x %02x %02x %02x %02x %02x %02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ptr</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ptr</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">ptr</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">ptr</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
		 			<span class="n">ptr</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">ptr</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span> <span class="n">ptr</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span> <span class="n">ptr</span><span class="p">[</span><span class="mi">7</span><span class="p">],</span> <span class="n">ptr</span><span class="p">[</span><span class="mi">8</span><span class="p">],</span>
					<span class="n">ptr</span><span class="p">[</span><span class="mi">9</span><span class="p">],</span> <span class="n">ptr</span><span class="p">[</span><span class="mi">10</span><span class="p">],</span> <span class="n">ptr</span><span class="p">[</span><span class="mi">11</span><span class="p">]);</span>
<span class="cp">#endif</span>
			<span class="n">netif_rx</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_packets</span><span class="o">++</span><span class="p">;</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_bytes</span> <span class="o">+=</span> <span class="n">pkt_len</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Indicate the card that we have got the packet */</span>
		<span class="n">hp100_outb</span><span class="p">(</span><span class="n">HP100_ADV_NXT_PKT</span> <span class="o">|</span> <span class="n">HP100_SET_LB</span><span class="p">,</span> <span class="n">OPTION_MSW</span><span class="p">);</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">header</span> <span class="o">&amp;</span> <span class="mh">0x00070000</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="p">(</span><span class="n">HP100_MULTI_ADDR_HASH</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span>:
		<span class="k">case</span> <span class="p">(</span><span class="n">HP100_MULTI_ADDR_NO_HASH</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span>:
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">multicast</span><span class="o">++</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>			<span class="cm">/* end of while(there are packets) loop */</span>
<span class="cp">#ifdef HP100_DEBUG_RX</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;hp100_rx: %s: end</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Receive Function for Busmaster Mode</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">hp100_rx_bm</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ioaddr</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hp100_private</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">hp100_ring_t</span> <span class="o">*</span><span class="n">ptr</span><span class="p">;</span>
	<span class="n">u_int</span> <span class="n">header</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">pkt_len</span><span class="p">;</span>

<span class="cp">#ifdef HP100_DEBUG_B</span>
	<span class="n">hp100_outw</span><span class="p">(</span><span class="mh">0x4214</span><span class="p">,</span> <span class="n">TRACE</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;hp100: %s: rx_bm</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef HP100_DEBUG</span>
	<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">==</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">rxrcommit</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;hp100: %s: rx_bm called although no PDLs were committed to adapter?</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="cm">/* RX_PKT_CNT states how many PDLs are currently formatted and available to</span>
<span class="cm">		 * the cards BM engine */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">hp100_inw</span><span class="p">(</span><span class="n">RX_PKT_CNT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x00ff</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">rxrcommit</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;hp100: %s: More packets received than committed? RX_PKT_CNT=0x%x, commit=0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				     <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">hp100_inw</span><span class="p">(</span><span class="n">RX_PKT_CNT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x00ff</span><span class="p">,</span>
				     <span class="n">lp</span><span class="o">-&gt;</span><span class="n">rxrcommit</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="k">while</span> <span class="p">((</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">rxrcommit</span> <span class="o">&gt;</span> <span class="n">hp100_inb</span><span class="p">(</span><span class="n">RX_PDL</span><span class="p">)))</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * The packet was received into the pdl pointed to by lp-&gt;rxrhead (</span>
<span class="cm">		 * the oldest pdl in the ring</span>
<span class="cm">		 */</span>

		<span class="cm">/* First we get the header, which contains information about the */</span>
		<span class="cm">/* actual length of the received packet. */</span>

		<span class="n">ptr</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">rxrhead</span><span class="p">;</span>

		<span class="n">header</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">ptr</span><span class="o">-&gt;</span><span class="n">pdl</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">pkt_len</span> <span class="o">=</span> <span class="p">(</span><span class="n">header</span> <span class="o">&amp;</span> <span class="n">HP100_PKT_LEN_MASK</span><span class="p">);</span>

		<span class="cm">/* Conversion to new PCI API : NOP */</span>
		<span class="n">pci_unmap_single</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span> <span class="p">(</span><span class="n">dma_addr_t</span><span class="p">)</span> <span class="n">ptr</span><span class="o">-&gt;</span><span class="n">pdl</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">MAX_ETHER_SIZE</span><span class="p">,</span> <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>

<span class="cp">#ifdef HP100_DEBUG_BM</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;hp100: %s: rx_bm: header@0x%x=0x%x length=%d, errors=0x%x, dest=0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="p">(</span><span class="n">u_int</span><span class="p">)</span> <span class="p">(</span><span class="n">ptr</span><span class="o">-&gt;</span><span class="n">pdl</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="n">u_int</span><span class="p">)</span> <span class="n">header</span><span class="p">,</span>
				<span class="n">pkt_len</span><span class="p">,</span> <span class="p">(</span><span class="n">header</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xfff8</span><span class="p">,</span> <span class="p">(</span><span class="n">header</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">7</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;hp100: %s: RX_PDL_COUNT:0x%x TX_PDL_COUNT:0x%x, RX_PKT_CNT=0x%x PDH=0x%x, Data@0x%x len=0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">hp100_inb</span><span class="p">(</span><span class="n">RX_PDL</span><span class="p">),</span> <span class="n">hp100_inb</span><span class="p">(</span><span class="n">TX_PDL</span><span class="p">),</span>
				<span class="n">hp100_inb</span><span class="p">(</span><span class="n">RX_PKT_CNT</span><span class="p">),</span> <span class="p">(</span><span class="n">u_int</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">ptr</span><span class="o">-&gt;</span><span class="n">pdl</span><span class="p">),</span>
				<span class="p">(</span><span class="n">u_int</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">ptr</span><span class="o">-&gt;</span><span class="n">pdl</span> <span class="o">+</span> <span class="mi">3</span><span class="p">),</span> <span class="p">(</span><span class="n">u_int</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">ptr</span><span class="o">-&gt;</span><span class="n">pdl</span> <span class="o">+</span> <span class="mi">4</span><span class="p">));</span>
<span class="cp">#endif</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">pkt_len</span> <span class="o">&gt;=</span> <span class="n">MIN_ETHER_SIZE</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">pkt_len</span> <span class="o">&lt;=</span> <span class="n">MAX_ETHER_SIZE</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ptr</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="s">&quot;hp100: %s: rx_bm: skb null</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
				<span class="cm">/* can happen if we only allocated room for the pdh due to memory shortage. */</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_dropped</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">skb_trim</span><span class="p">(</span><span class="n">ptr</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">,</span> <span class="n">pkt_len</span><span class="p">);</span>	<span class="cm">/* Shorten it */</span>
				<span class="n">ptr</span><span class="o">-&gt;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">=</span>
				    <span class="n">eth_type_trans</span><span class="p">(</span><span class="n">ptr</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>

				<span class="n">netif_rx</span><span class="p">(</span><span class="n">ptr</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">);</span>	<span class="cm">/* Up and away... */</span>

				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_packets</span><span class="o">++</span><span class="p">;</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_bytes</span> <span class="o">+=</span> <span class="n">pkt_len</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">switch</span> <span class="p">(</span><span class="n">header</span> <span class="o">&amp;</span> <span class="mh">0x00070000</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="p">(</span><span class="n">HP100_MULTI_ADDR_HASH</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span>:
			<span class="k">case</span> <span class="p">(</span><span class="n">HP100_MULTI_ADDR_NO_HASH</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span>:
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">multicast</span><span class="o">++</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<span class="cp">#ifdef HP100_DEBUG</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;hp100: %s: rx_bm: Received bad packet (length=%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">pkt_len</span><span class="p">);</span>
<span class="cp">#endif</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ptr</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
				<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">ptr</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">);</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_errors</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">rxrhead</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">rxrhead</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>

		<span class="cm">/* Allocate a new rx PDL (so lp-&gt;rxrcommit stays the same) */</span>
		<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">==</span> <span class="n">hp100_build_rx_pdl</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">rxrtail</span><span class="p">,</span> <span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* No space for skb, header can still be received. */</span>
<span class="cp">#ifdef HP100_DEBUG</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;hp100: %s: rx_bm: No space for new PDL.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
<span class="cp">#endif</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>	<span class="cm">/* successfully allocated new PDL - put it in ringlist at tail. */</span>
			<span class="n">hp100_outl</span><span class="p">((</span><span class="n">u32</span><span class="p">)</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">rxrtail</span><span class="o">-&gt;</span><span class="n">pdl_paddr</span><span class="p">,</span> <span class="n">RX_PDA</span><span class="p">);</span>
			<span class="n">lp</span><span class="o">-&gt;</span><span class="n">rxrtail</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">rxrtail</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
		<span class="p">}</span>

	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  statistics</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">net_device_stats</span> <span class="o">*</span><span class="nf">hp100_get_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ioaddr</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hp100_private</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

<span class="cp">#ifdef HP100_DEBUG_B</span>
	<span class="n">hp100_outw</span><span class="p">(</span><span class="mh">0x4215</span><span class="p">,</span> <span class="n">TRACE</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">hp100_ints_off</span><span class="p">();</span>	<span class="cm">/* Useful ? Jean II */</span>
	<span class="n">hp100_update_stats</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">hp100_ints_on</span><span class="p">();</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hp100_update_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ioaddr</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>
	<span class="n">u_short</span> <span class="n">val</span><span class="p">;</span>

<span class="cp">#ifdef HP100_DEBUG_B</span>
	<span class="n">hp100_outw</span><span class="p">(</span><span class="mh">0x4216</span><span class="p">,</span> <span class="n">TRACE</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;hp100: %s: update-stats</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="cm">/* Note: Statistics counters clear when read. */</span>
	<span class="n">hp100_page</span><span class="p">(</span><span class="n">MAC_CTRL</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">hp100_inw</span><span class="p">(</span><span class="n">DROPPED</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0fff</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_errors</span> <span class="o">+=</span> <span class="n">val</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_over_errors</span> <span class="o">+=</span> <span class="n">val</span><span class="p">;</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">hp100_inb</span><span class="p">(</span><span class="n">CRC</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_errors</span> <span class="o">+=</span> <span class="n">val</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_crc_errors</span> <span class="o">+=</span> <span class="n">val</span><span class="p">;</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">hp100_inb</span><span class="p">(</span><span class="n">ABORT</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_errors</span> <span class="o">+=</span> <span class="n">val</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_aborted_errors</span> <span class="o">+=</span> <span class="n">val</span><span class="p">;</span>
	<span class="n">hp100_page</span><span class="p">(</span><span class="n">PERFORMANCE</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hp100_misc_interrupt</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef HP100_DEBUG_B</span>
	<span class="kt">int</span> <span class="n">ioaddr</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef HP100_DEBUG_B</span>
	<span class="kt">int</span> <span class="n">ioaddr</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>
	<span class="n">hp100_outw</span><span class="p">(</span><span class="mh">0x4216</span><span class="p">,</span> <span class="n">TRACE</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;hp100: %s: misc_interrupt</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="cm">/* Note: Statistics counters clear when read. */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_errors</span><span class="o">++</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_errors</span><span class="o">++</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hp100_clear_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">hp100_private</span> <span class="o">*</span><span class="n">lp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ioaddr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

<span class="cp">#ifdef HP100_DEBUG_B</span>
	<span class="n">hp100_outw</span><span class="p">(</span><span class="mh">0x4217</span><span class="p">,</span> <span class="n">TRACE</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;hp100: %s: clear_stats</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">hp100_page</span><span class="p">(</span><span class="n">MAC_CTRL</span><span class="p">);</span>	<span class="cm">/* get all statistics bytes */</span>
	<span class="n">hp100_inw</span><span class="p">(</span><span class="n">DROPPED</span><span class="p">);</span>
	<span class="n">hp100_inb</span><span class="p">(</span><span class="n">CRC</span><span class="p">);</span>
	<span class="n">hp100_inb</span><span class="p">(</span><span class="n">ABORT</span><span class="p">);</span>
	<span class="n">hp100_page</span><span class="p">(</span><span class="n">PERFORMANCE</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> *  multicast setup</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> *  Set or clear the multicast filter for this adapter.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hp100_set_multicast_list</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ioaddr</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hp100_private</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

<span class="cp">#ifdef HP100_DEBUG_B</span>
	<span class="n">hp100_outw</span><span class="p">(</span><span class="mh">0x4218</span><span class="p">,</span> <span class="n">TRACE</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;hp100: %s: set_mc_list</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">hp100_ints_off</span><span class="p">();</span>
	<span class="n">hp100_page</span><span class="p">(</span><span class="n">MAC_CTRL</span><span class="p">);</span>
	<span class="n">hp100_andb</span><span class="p">(</span><span class="o">~</span><span class="p">(</span><span class="n">HP100_RX_EN</span> <span class="o">|</span> <span class="n">HP100_TX_EN</span><span class="p">),</span> <span class="n">MAC_CFG_1</span><span class="p">);</span>	<span class="cm">/* stop rx/tx */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_PROMISC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">mac2_mode</span> <span class="o">=</span> <span class="n">HP100_MAC2MODE6</span><span class="p">;</span>	<span class="cm">/* promiscuous mode = get all good */</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">mac1_mode</span> <span class="o">=</span> <span class="n">HP100_MAC1MODE6</span><span class="p">;</span>	<span class="cm">/* packets on the net */</span>
		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">hash_bytes</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">netdev_mc_empty</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_ALLMULTI</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">mac2_mode</span> <span class="o">=</span> <span class="n">HP100_MAC2MODE5</span><span class="p">;</span>	<span class="cm">/* multicast mode = get packets for */</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">mac1_mode</span> <span class="o">=</span> <span class="n">HP100_MAC1MODE5</span><span class="p">;</span>	<span class="cm">/* me, broadcasts and all multicasts */</span>
<span class="cp">#ifdef HP100_MULTICAST_FILTER	</span><span class="cm">/* doesn&#39;t work!!! */</span><span class="cp"></span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_ALLMULTI</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* set hash filter to receive all multicast packets */</span>
			<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">hash_bytes</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">idx</span><span class="p">;</span>
			<span class="n">u_char</span> <span class="o">*</span><span class="n">addrs</span><span class="p">;</span>
			<span class="k">struct</span> <span class="n">netdev_hw_addr</span> <span class="o">*</span><span class="n">ha</span><span class="p">;</span>

			<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">hash_bytes</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
<span class="cp">#ifdef HP100_DEBUG</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;hp100: %s: computing hash filter - mc_count = %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">netdev_mc_count</span><span class="p">(</span><span class="n">dev</span><span class="p">));</span>
<span class="cp">#endif</span>
			<span class="n">netdev_for_each_mc_addr</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">addrs</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">;</span>
<span class="cp">#ifdef HP100_DEBUG</span>
				<span class="n">printk</span><span class="p">(</span><span class="s">&quot;hp100: %s: multicast = %pM, &quot;</span><span class="p">,</span>
					     <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">addrs</span><span class="p">);</span>
<span class="cp">#endif</span>
				<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">idx</span> <span class="o">^=</span> <span class="o">*</span><span class="n">addrs</span><span class="o">++</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">;</span>
					<span class="n">printk</span><span class="p">(</span><span class="s">&quot;:%02x:&quot;</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>
				<span class="p">}</span>
<span class="cp">#ifdef HP100_DEBUG</span>
				<span class="n">printk</span><span class="p">(</span><span class="s">&quot;idx = %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>
<span class="cp">#endif</span>
				<span class="n">lp</span><span class="o">-&gt;</span><span class="n">hash_bytes</span><span class="p">[</span><span class="n">idx</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">]</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">idx</span> <span class="o">&amp;</span> <span class="mi">7</span><span class="p">));</span>
			<span class="p">}</span>
		<span class="p">}</span>
<span class="cp">#else</span>
		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">hash_bytes</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">mac2_mode</span> <span class="o">=</span> <span class="n">HP100_MAC2MODE3</span><span class="p">;</span>	<span class="cm">/* normal mode = get packets for me */</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">mac1_mode</span> <span class="o">=</span> <span class="n">HP100_MAC1MODE3</span><span class="p">;</span>	<span class="cm">/* and broadcasts */</span>
		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">hash_bytes</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(((</span><span class="n">hp100_inb</span><span class="p">(</span><span class="n">MAC_CFG_1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">)</span> <span class="o">!=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">mac1_mode</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">hp100_inb</span><span class="p">(</span><span class="n">MAC_CFG_2</span><span class="p">)</span> <span class="o">!=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">mac2_mode</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

		<span class="n">hp100_outb</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">mac2_mode</span><span class="p">,</span> <span class="n">MAC_CFG_2</span><span class="p">);</span>
		<span class="n">hp100_andb</span><span class="p">(</span><span class="n">HP100_MAC1MODEMASK</span><span class="p">,</span> <span class="n">MAC_CFG_1</span><span class="p">);</span>	<span class="cm">/* clear mac1 mode bits */</span>
		<span class="n">hp100_orb</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">mac1_mode</span><span class="p">,</span> <span class="n">MAC_CFG_1</span><span class="p">);</span>	<span class="cm">/* and set the new mode */</span>

		<span class="n">hp100_page</span><span class="p">(</span><span class="n">MAC_ADDRESS</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">hp100_outb</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">hash_bytes</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">HASH_BYTE0</span> <span class="o">+</span> <span class="n">i</span><span class="p">);</span>
<span class="cp">#ifdef HP100_DEBUG</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;hp100: %s: mac1 = 0x%x, mac2 = 0x%x, multicast hash = %02x:%02x:%02x:%02x:%02x:%02x:%02x:%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				     <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">mac1_mode</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">mac2_mode</span><span class="p">,</span>
				     <span class="n">lp</span><span class="o">-&gt;</span><span class="n">hash_bytes</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">hash_bytes</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
				     <span class="n">lp</span><span class="o">-&gt;</span><span class="n">hash_bytes</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">hash_bytes</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
				     <span class="n">lp</span><span class="o">-&gt;</span><span class="n">hash_bytes</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">hash_bytes</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span>
				     <span class="n">lp</span><span class="o">-&gt;</span><span class="n">hash_bytes</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">hash_bytes</span><span class="p">[</span><span class="mi">7</span><span class="p">]);</span>
<span class="cp">#endif</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">lan_type</span> <span class="o">==</span> <span class="n">HP100_LAN_100</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifdef HP100_DEBUG</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;hp100: %s: 100VG MAC settings have changed - relogin.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
<span class="cp">#endif</span>
			<span class="n">lp</span><span class="o">-&gt;</span><span class="n">hub_status</span> <span class="o">=</span> <span class="n">hp100_login_to_vg_hub</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>	<span class="cm">/* force a relogin to the hub */</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">u_char</span> <span class="n">old_hash_bytes</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>

		<span class="n">hp100_page</span><span class="p">(</span><span class="n">MAC_ADDRESS</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">old_hash_bytes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">hp100_inb</span><span class="p">(</span><span class="n">HASH_BYTE0</span> <span class="o">+</span> <span class="n">i</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="n">old_hash_bytes</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">hash_bytes</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
				<span class="n">hp100_outb</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">hash_bytes</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">HASH_BYTE0</span> <span class="o">+</span> <span class="n">i</span><span class="p">);</span>
<span class="cp">#ifdef HP100_DEBUG</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;hp100: %s: multicast hash = %02x:%02x:%02x:%02x:%02x:%02x:%02x:%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">hash_bytes</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
					<span class="n">lp</span><span class="o">-&gt;</span><span class="n">hash_bytes</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">hash_bytes</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
					<span class="n">lp</span><span class="o">-&gt;</span><span class="n">hash_bytes</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">hash_bytes</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span>
					<span class="n">lp</span><span class="o">-&gt;</span><span class="n">hash_bytes</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">hash_bytes</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span>
					<span class="n">lp</span><span class="o">-&gt;</span><span class="n">hash_bytes</span><span class="p">[</span><span class="mi">7</span><span class="p">]);</span>
<span class="cp">#endif</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">lan_type</span> <span class="o">==</span> <span class="n">HP100_LAN_100</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifdef HP100_DEBUG</span>
				<span class="n">printk</span><span class="p">(</span><span class="s">&quot;hp100: %s: 100VG MAC settings have changed - relogin.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
<span class="cp">#endif</span>
				<span class="n">lp</span><span class="o">-&gt;</span><span class="n">hub_status</span> <span class="o">=</span> <span class="n">hp100_login_to_vg_hub</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>	<span class="cm">/* force a relogin to the hub */</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">hp100_page</span><span class="p">(</span><span class="n">MAC_CTRL</span><span class="p">);</span>
	<span class="n">hp100_orb</span><span class="p">(</span><span class="n">HP100_RX_EN</span> <span class="o">|</span> <span class="n">HP100_RX_IDLE</span> <span class="o">|</span>	<span class="cm">/* enable rx */</span>
		  <span class="n">HP100_TX_EN</span> <span class="o">|</span> <span class="n">HP100_TX_IDLE</span><span class="p">,</span> <span class="n">MAC_CFG_1</span><span class="p">);</span>	<span class="cm">/* enable tx */</span>

	<span class="n">hp100_page</span><span class="p">(</span><span class="n">PERFORMANCE</span><span class="p">);</span>
	<span class="n">hp100_ints_on</span><span class="p">();</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  hardware interrupt handling</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">hp100_interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="p">)</span> <span class="n">dev_id</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hp100_private</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="kt">int</span> <span class="n">ioaddr</span><span class="p">;</span>
	<span class="n">u_int</span> <span class="n">val</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>
	<span class="n">ioaddr</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">hp100_ints_off</span><span class="p">();</span>

<span class="cp">#ifdef HP100_DEBUG_B</span>
	<span class="n">hp100_outw</span><span class="p">(</span><span class="mh">0x4219</span><span class="p">,</span> <span class="n">TRACE</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="cm">/*  hp100_page( PERFORMANCE ); */</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">hp100_inw</span><span class="p">(</span><span class="n">IRQ_STATUS</span><span class="p">);</span>
<span class="cp">#ifdef HP100_DEBUG_IRQ</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;hp100: %s: mode=%x,IRQ_STAT=0x%.4x,RXPKTCNT=0x%.2x RXPDL=0x%.2x TXPKTCNT=0x%.2x TXPDL=0x%.2x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			     <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">,</span> <span class="p">(</span><span class="n">u_int</span><span class="p">)</span> <span class="n">val</span><span class="p">,</span> <span class="n">hp100_inb</span><span class="p">(</span><span class="n">RX_PKT_CNT</span><span class="p">),</span>
			     <span class="n">hp100_inb</span><span class="p">(</span><span class="n">RX_PDL</span><span class="p">),</span> <span class="n">hp100_inb</span><span class="p">(</span><span class="n">TX_PKT_CNT</span><span class="p">),</span> <span class="n">hp100_inb</span><span class="p">(</span><span class="n">TX_PDL</span><span class="p">));</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>		<span class="cm">/* might be a shared interrupt */</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="n">hp100_ints_on</span><span class="p">();</span>
		<span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* We&#39;re only interested in those interrupts we really enabled. */</span>
	<span class="cm">/* val &amp;= hp100_inw( IRQ_MASK ); */</span>

	<span class="cm">/*</span>
<span class="cm">	 * RX_PDL_FILL_COMPL is set whenever a RX_PDL has been executed. A RX_PDL</span>
<span class="cm">	 * is considered executed whenever the RX_PDL data structure is no longer</span>
<span class="cm">	 * needed.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">HP100_RX_PDL_FILL_COMPL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">hp100_rx_bm</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;hp100: %s: rx_pdl_fill_compl interrupt although not busmaster?</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * The RX_PACKET interrupt is set, when the receive packet counter is</span>
<span class="cm">	 * non zero. We use this interrupt for receiving in slave mode. In</span>
<span class="cm">	 * busmaster mode, we use it to make sure we did not miss any rx_pdl_fill</span>
<span class="cm">	 * interrupts. If rx_pdl_fill_compl is not set and rx_packet is set, then</span>
<span class="cm">	 * we somehow have missed a rx_pdl_fill_compl interrupt.</span>
<span class="cm">	 */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">HP100_RX_PACKET</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* Receive Packet Counter is non zero */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>	<span class="cm">/* non busmaster */</span>
			<span class="n">hp100_rx</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">HP100_RX_PDL_FILL_COMPL</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* Shouldn&#39;t happen - maybe we missed a RX_PDL_FILL Interrupt?  */</span>
			<span class="n">hp100_rx_bm</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Ack. that we have noticed the interrupt and thereby allow next one.</span>
<span class="cm">	 * Note that this is now done after the slave rx function, since first</span>
<span class="cm">	 * acknowledging and then setting ADV_NXT_PKT caused an extra interrupt</span>
<span class="cm">	 * on the J2573.</span>
<span class="cm">	 */</span>
	<span class="n">hp100_outw</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">IRQ_STATUS</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * RX_ERROR is set when a packet is dropped due to no memory resources on</span>
<span class="cm">	 * the card or when a RCV_ERR occurs.</span>
<span class="cm">	 * TX_ERROR is set when a TX_ABORT condition occurs in the MAC-&gt;exists</span>
<span class="cm">	 * only in the 802.3 MAC and happens when 16 collisions occur during a TX</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">HP100_TX_ERROR</span> <span class="o">|</span> <span class="n">HP100_RX_ERROR</span><span class="p">))</span> <span class="p">{</span>
<span class="cp">#ifdef HP100_DEBUG_IRQ</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;hp100: %s: TX/RX Error IRQ</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="n">hp100_update_stats</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">hp100_rxfill</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="n">hp100_clean_txring</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * RX_PDA_ZERO is set when the PDA count goes from non-zero to zero.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">HP100_RX_PDA_ZERO</span><span class="p">)))</span>
		<span class="n">hp100_rxfill</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * HP100_TX_COMPLETE interrupt occurs when packet transmitted on wire</span>
<span class="cm">	 * is completed</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">HP100_TX_COMPLETE</span><span class="p">)))</span>
		<span class="n">hp100_clean_txring</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * MISC_ERROR is set when either the LAN link goes down or a detected</span>
<span class="cm">	 * bus error occurs.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">HP100_MISC_ERROR</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* New for J2585B */</span>
<span class="cp">#ifdef HP100_DEBUG_IRQ</span>
		<span class="n">printk</span>
		    <span class="p">(</span><span class="s">&quot;hp100: %s: Misc. Error Interrupt - Check cabling.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">hp100_clean_txring</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="n">hp100_rxfill</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">hp100_misc_interrupt</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">hp100_ints_on</span><span class="p">();</span>
	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  some misc functions</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hp100_start_interface</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ioaddr</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hp100_private</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

<span class="cp">#ifdef HP100_DEBUG_B</span>
	<span class="n">hp100_outw</span><span class="p">(</span><span class="mh">0x4220</span><span class="p">,</span> <span class="n">TRACE</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;hp100: %s: hp100_start_interface</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* Ensure the adapter does not want to request an interrupt when */</span>
	<span class="cm">/* enabling the IRQ line to be active on the bus (i.e. not tri-stated) */</span>
	<span class="n">hp100_page</span><span class="p">(</span><span class="n">PERFORMANCE</span><span class="p">);</span>
	<span class="n">hp100_outw</span><span class="p">(</span><span class="mh">0xfefe</span><span class="p">,</span> <span class="n">IRQ_MASK</span><span class="p">);</span>	<span class="cm">/* mask off all ints */</span>
	<span class="n">hp100_outw</span><span class="p">(</span><span class="mh">0xffff</span><span class="p">,</span> <span class="n">IRQ_STATUS</span><span class="p">);</span>	<span class="cm">/* ack all IRQs */</span>
	<span class="n">hp100_outw</span><span class="p">(</span><span class="n">HP100_FAKE_INT</span> <span class="o">|</span> <span class="n">HP100_INT_EN</span> <span class="o">|</span> <span class="n">HP100_RESET_LB</span><span class="p">,</span>
		   <span class="n">OPTION_LSW</span><span class="p">);</span>
	<span class="cm">/* Un Tri-state int. TODO: Check if shared interrupts can be realised? */</span>
	<span class="n">hp100_outw</span><span class="p">(</span><span class="n">HP100_TRI_INT</span> <span class="o">|</span> <span class="n">HP100_RESET_HB</span><span class="p">,</span> <span class="n">OPTION_LSW</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Make sure BM bit is set... */</span>
		<span class="n">hp100_page</span><span class="p">(</span><span class="n">HW_MAP</span><span class="p">);</span>
		<span class="n">hp100_orb</span><span class="p">(</span><span class="n">HP100_BM_MASTER</span><span class="p">,</span> <span class="n">BM</span><span class="p">);</span>
		<span class="n">hp100_rxfill</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Enable memory mapping. Note: Don&#39;t do this when busmaster. */</span>
		<span class="n">hp100_outw</span><span class="p">(</span><span class="n">HP100_MMAP_DIS</span> <span class="o">|</span> <span class="n">HP100_RESET_HB</span><span class="p">,</span> <span class="n">OPTION_LSW</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">hp100_page</span><span class="p">(</span><span class="n">PERFORMANCE</span><span class="p">);</span>
	<span class="n">hp100_outw</span><span class="p">(</span><span class="mh">0xfefe</span><span class="p">,</span> <span class="n">IRQ_MASK</span><span class="p">);</span>	<span class="cm">/* mask off all ints */</span>
	<span class="n">hp100_outw</span><span class="p">(</span><span class="mh">0xffff</span><span class="p">,</span> <span class="n">IRQ_STATUS</span><span class="p">);</span>	<span class="cm">/* ack IRQ */</span>

	<span class="cm">/* enable a few interrupts: */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* busmaster mode */</span>
		<span class="n">hp100_outw</span><span class="p">(</span><span class="n">HP100_RX_PDL_FILL_COMPL</span> <span class="o">|</span>
			   <span class="n">HP100_RX_PDA_ZERO</span> <span class="o">|</span> <span class="n">HP100_RX_ERROR</span> <span class="o">|</span>
			   <span class="cm">/* HP100_RX_PACKET    | */</span>
			   <span class="cm">/* HP100_RX_EARLY_INT |  */</span> <span class="n">HP100_SET_HB</span> <span class="o">|</span>
			   <span class="cm">/* HP100_TX_PDA_ZERO  |  */</span>
			   <span class="n">HP100_TX_COMPLETE</span> <span class="o">|</span>
			   <span class="cm">/* HP100_MISC_ERROR   |  */</span>
			   <span class="n">HP100_TX_ERROR</span> <span class="o">|</span> <span class="n">HP100_SET_LB</span><span class="p">,</span> <span class="n">IRQ_MASK</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">hp100_outw</span><span class="p">(</span><span class="n">HP100_RX_PACKET</span> <span class="o">|</span>
			   <span class="n">HP100_RX_ERROR</span> <span class="o">|</span> <span class="n">HP100_SET_HB</span> <span class="o">|</span>
			   <span class="n">HP100_TX_ERROR</span> <span class="o">|</span> <span class="n">HP100_SET_LB</span><span class="p">,</span> <span class="n">IRQ_MASK</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Note : before hp100_set_multicast_list(), because it will play with</span>
<span class="cm">	 * spinlock itself... Jean II */</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* Enable MAC Tx and RX, set MAC modes, ... */</span>
	<span class="n">hp100_set_multicast_list</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hp100_stop_interface</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hp100_private</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ioaddr</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>
	<span class="n">u_int</span> <span class="n">val</span><span class="p">;</span>

<span class="cp">#ifdef HP100_DEBUG_B</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;hp100: %s: hp100_stop_interface</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="n">hp100_outw</span><span class="p">(</span><span class="mh">0x4221</span><span class="p">,</span> <span class="n">TRACE</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">hp100_BM_shutdown</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Note: MMAP_DIS will be reenabled by start_interface */</span>
		<span class="n">hp100_outw</span><span class="p">(</span><span class="n">HP100_INT_EN</span> <span class="o">|</span> <span class="n">HP100_RESET_LB</span> <span class="o">|</span>
			   <span class="n">HP100_TRI_INT</span> <span class="o">|</span> <span class="n">HP100_MMAP_DIS</span> <span class="o">|</span> <span class="n">HP100_SET_HB</span><span class="p">,</span>
			   <span class="n">OPTION_LSW</span><span class="p">);</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">hp100_inw</span><span class="p">(</span><span class="n">OPTION_LSW</span><span class="p">);</span>

		<span class="n">hp100_page</span><span class="p">(</span><span class="n">MAC_CTRL</span><span class="p">);</span>
		<span class="n">hp100_andb</span><span class="p">(</span><span class="o">~</span><span class="p">(</span><span class="n">HP100_RX_EN</span> <span class="o">|</span> <span class="n">HP100_TX_EN</span><span class="p">),</span> <span class="n">MAC_CFG_1</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">HP100_HW_RST</span><span class="p">))</span>
			<span class="k">return</span><span class="p">;</span>	<span class="cm">/* If reset, imm. return ... */</span>
		<span class="cm">/* ... else: busy wait until idle */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">val</span> <span class="o">&lt;</span> <span class="mi">6000</span><span class="p">;</span> <span class="n">val</span><span class="o">++</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">hp100_inb</span><span class="p">(</span><span class="n">MAC_CFG_1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">HP100_TX_IDLE</span> <span class="o">|</span> <span class="n">HP100_RX_IDLE</span><span class="p">))</span> <span class="o">==</span> <span class="p">(</span><span class="n">HP100_TX_IDLE</span> <span class="o">|</span> <span class="n">HP100_RX_IDLE</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">hp100_page</span><span class="p">(</span><span class="n">PERFORMANCE</span><span class="p">);</span>
				<span class="k">return</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;hp100: %s: hp100_stop_interface - timeout</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">hp100_page</span><span class="p">(</span><span class="n">PERFORMANCE</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hp100_load_eeprom</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u_short</span> <span class="n">probe_ioaddr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ioaddr</span> <span class="o">=</span> <span class="n">probe_ioaddr</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="n">probe_ioaddr</span> <span class="o">:</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>

<span class="cp">#ifdef HP100_DEBUG_B</span>
	<span class="n">hp100_outw</span><span class="p">(</span><span class="mh">0x4222</span><span class="p">,</span> <span class="n">TRACE</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="n">hp100_page</span><span class="p">(</span><span class="n">EEPROM_CTRL</span><span class="p">);</span>
	<span class="n">hp100_andw</span><span class="p">(</span><span class="o">~</span><span class="n">HP100_EEPROM_LOAD</span><span class="p">,</span> <span class="n">EEPROM_CTRL</span><span class="p">);</span>
	<span class="n">hp100_orw</span><span class="p">(</span><span class="n">HP100_EEPROM_LOAD</span><span class="p">,</span> <span class="n">EEPROM_CTRL</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10000</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">hp100_inb</span><span class="p">(</span><span class="n">OPTION_MSW</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">HP100_EE_LOAD</span><span class="p">))</span>
			<span class="k">return</span><span class="p">;</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;hp100: %s: hp100_load_eeprom - timeout</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*  Sense connection status.</span>
<span class="cm"> *  return values: LAN_10  - Connected to 10Mbit/s network</span>
<span class="cm"> *                 LAN_100 - Connected to 100Mbit/s network</span>
<span class="cm"> *                 LAN_ERR - not connected or 100Mbit/s Hub down</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">hp100_sense_lan</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ioaddr</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>
	<span class="n">u_short</span> <span class="n">val_VG</span><span class="p">,</span> <span class="n">val_10</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hp100_private</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

<span class="cp">#ifdef HP100_DEBUG_B</span>
	<span class="n">hp100_outw</span><span class="p">(</span><span class="mh">0x4223</span><span class="p">,</span> <span class="n">TRACE</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="n">hp100_page</span><span class="p">(</span><span class="n">MAC_CTRL</span><span class="p">);</span>
	<span class="n">val_10</span> <span class="o">=</span> <span class="n">hp100_inb</span><span class="p">(</span><span class="mi">10</span><span class="n">_LAN_CFG_1</span><span class="p">);</span>
	<span class="n">val_VG</span> <span class="o">=</span> <span class="n">hp100_inb</span><span class="p">(</span><span class="n">VG_LAN_CFG_1</span><span class="p">);</span>
	<span class="n">hp100_page</span><span class="p">(</span><span class="n">PERFORMANCE</span><span class="p">);</span>
<span class="cp">#ifdef HP100_DEBUG</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;hp100: %s: sense_lan: val_VG = 0x%04x, val_10 = 0x%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">val_VG</span><span class="p">,</span> <span class="n">val_10</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">val_10</span> <span class="o">&amp;</span> <span class="n">HP100_LINK_BEAT_ST</span><span class="p">)</span>	<span class="cm">/* 10Mb connection is active */</span>
		<span class="k">return</span> <span class="n">HP100_LAN_10</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">val_10</span> <span class="o">&amp;</span> <span class="n">HP100_AUI_ST</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* have we BNC or AUI onboard? */</span>
		<span class="cm">/*</span>
<span class="cm">		 * This can be overriden by dos utility, so if this has no effect,</span>
<span class="cm">		 * perhaps you need to download that utility from HP and set card</span>
<span class="cm">		 * back to &quot;auto detect&quot;.</span>
<span class="cm">		 */</span>
		<span class="n">val_10</span> <span class="o">|=</span> <span class="n">HP100_AUI_SEL</span> <span class="o">|</span> <span class="n">HP100_LOW_TH</span><span class="p">;</span>
		<span class="n">hp100_page</span><span class="p">(</span><span class="n">MAC_CTRL</span><span class="p">);</span>
		<span class="n">hp100_outb</span><span class="p">(</span><span class="n">val_10</span><span class="p">,</span> <span class="mi">10</span><span class="n">_LAN_CFG_1</span><span class="p">);</span>
		<span class="n">hp100_page</span><span class="p">(</span><span class="n">PERFORMANCE</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">HP100_LAN_COAX</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Those cards don&#39;t have a 100 Mbit connector */</span>
	<span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="s">&quot;HWP1920&quot;</span><span class="p">)</span>  <span class="o">||</span>
	     <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">pci_dev</span> <span class="o">&amp;&amp;</span>
	      <span class="n">lp</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="o">-&gt;</span><span class="n">vendor</span> <span class="o">==</span> <span class="n">PCI_VENDOR_ID</span> <span class="o">&amp;&amp;</span>
	      <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="n">PCI_DEVICE_ID_HP_J2970A</span> <span class="o">||</span>
	       <span class="n">lp</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="n">PCI_DEVICE_ID_HP_J2973A</span><span class="p">)))</span>
		<span class="k">return</span> <span class="n">HP100_LAN_ERR</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">val_VG</span> <span class="o">&amp;</span> <span class="n">HP100_LINK_CABLE_ST</span><span class="p">)</span>	<span class="cm">/* Can hear the HUBs tone. */</span>
		<span class="k">return</span> <span class="n">HP100_LAN_100</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">HP100_LAN_ERR</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hp100_down_vg_link</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hp100_private</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ioaddr</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">time</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">savelan</span><span class="p">,</span> <span class="n">newlan</span><span class="p">;</span>

<span class="cp">#ifdef HP100_DEBUG_B</span>
	<span class="n">hp100_outw</span><span class="p">(</span><span class="mh">0x4224</span><span class="p">,</span> <span class="n">TRACE</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;hp100: %s: down_vg_link</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="n">hp100_page</span><span class="p">(</span><span class="n">MAC_CTRL</span><span class="p">);</span>
	<span class="n">time</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="p">(</span><span class="n">HZ</span> <span class="o">/</span> <span class="mi">4</span><span class="p">);</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hp100_inb</span><span class="p">(</span><span class="n">VG_LAN_CFG_1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">HP100_LINK_CABLE_ST</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">in_interrupt</span><span class="p">())</span>
			<span class="n">schedule_timeout_interruptible</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">time_after</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">jiffies</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">time_after_eq</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">time</span><span class="p">))</span>	<span class="cm">/* no signal-&gt;no logout */</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Drop the VG Link by clearing the link up cmd and load addr. */</span>

	<span class="n">hp100_andb</span><span class="p">(</span><span class="o">~</span><span class="p">(</span><span class="n">HP100_LOAD_ADDR</span> <span class="o">|</span> <span class="n">HP100_LINK_CMD</span><span class="p">),</span> <span class="n">VG_LAN_CFG_1</span><span class="p">);</span>
	<span class="n">hp100_orb</span><span class="p">(</span><span class="n">HP100_VG_SEL</span><span class="p">,</span> <span class="n">VG_LAN_CFG_1</span><span class="p">);</span>

	<span class="cm">/* Conditionally stall for &gt;250ms on Link-Up Status (to go down) */</span>
	<span class="n">time</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="p">(</span><span class="n">HZ</span> <span class="o">/</span> <span class="mi">2</span><span class="p">);</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">hp100_inb</span><span class="p">(</span><span class="n">VG_LAN_CFG_1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">HP100_LINK_UP_ST</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">in_interrupt</span><span class="p">())</span>
			<span class="n">schedule_timeout_interruptible</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">time_after</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">jiffies</span><span class="p">));</span>

<span class="cp">#ifdef HP100_DEBUG</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">time_after_eq</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">time</span><span class="p">))</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;hp100: %s: down_vg_link: Link does not go down?</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="cm">/* To prevent condition where Rev 1 VG MAC and old hubs do not complete */</span>
	<span class="cm">/* logout under traffic (even though all the status bits are cleared),  */</span>
	<span class="cm">/* do this workaround to get the Rev 1 MAC in its idle state */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">chip</span> <span class="o">==</span> <span class="n">HP100_CHIPID_LASSEN</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Reset VG MAC to insure it leaves the logoff state even if */</span>
		<span class="cm">/* the Hub is still emitting tones */</span>
		<span class="n">hp100_andb</span><span class="p">(</span><span class="o">~</span><span class="n">HP100_VG_RESET</span><span class="p">,</span> <span class="n">VG_LAN_CFG_1</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">1500</span><span class="p">);</span>	<span class="cm">/* wait for &gt;1ms */</span>
		<span class="n">hp100_orb</span><span class="p">(</span><span class="n">HP100_VG_RESET</span><span class="p">,</span> <span class="n">VG_LAN_CFG_1</span><span class="p">);</span>	<span class="cm">/* Release Reset */</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">1500</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* New: For lassen, switch to 10 Mbps mac briefly to clear training ACK */</span>
	<span class="cm">/* to get the VG mac to full reset. This is not req.d with later chips */</span>
	<span class="cm">/* Note: It will take the between 1 and 2 seconds for the VG mac to be */</span>
	<span class="cm">/* selected again! This will be left to the connect hub function to */</span>
	<span class="cm">/* perform if desired.  */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">chip</span> <span class="o">==</span> <span class="n">HP100_CHIPID_LASSEN</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Have to write to 10 and 100VG control registers simultaneously */</span>
		<span class="n">savelan</span> <span class="o">=</span> <span class="n">newlan</span> <span class="o">=</span> <span class="n">hp100_inl</span><span class="p">(</span><span class="mi">10</span><span class="n">_LAN_CFG_1</span><span class="p">);</span>	<span class="cm">/* read 10+100 LAN_CFG regs */</span>
		<span class="n">newlan</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">HP100_VG_SEL</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
		<span class="n">newlan</span> <span class="o">|=</span> <span class="p">(</span><span class="n">HP100_DOT3_MAC</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">hp100_andb</span><span class="p">(</span><span class="o">~</span><span class="n">HP100_AUTO_MODE</span><span class="p">,</span> <span class="n">MAC_CFG_3</span><span class="p">);</span>	<span class="cm">/* Autosel off */</span>
		<span class="n">hp100_outl</span><span class="p">(</span><span class="n">newlan</span><span class="p">,</span> <span class="mi">10</span><span class="n">_LAN_CFG_1</span><span class="p">);</span>

		<span class="cm">/* Conditionally stall for 5sec on VG selected. */</span>
		<span class="n">time</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="p">(</span><span class="n">HZ</span> <span class="o">*</span> <span class="mi">5</span><span class="p">);</span>
		<span class="k">do</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">hp100_inb</span><span class="p">(</span><span class="n">MAC_CFG_4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">HP100_MAC_SEL_ST</span><span class="p">))</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">in_interrupt</span><span class="p">())</span>
				<span class="n">schedule_timeout_interruptible</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">time_after</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">jiffies</span><span class="p">));</span>

		<span class="n">hp100_orb</span><span class="p">(</span><span class="n">HP100_AUTO_MODE</span><span class="p">,</span> <span class="n">MAC_CFG_3</span><span class="p">);</span>	<span class="cm">/* Autosel back on */</span>
		<span class="n">hp100_outl</span><span class="p">(</span><span class="n">savelan</span><span class="p">,</span> <span class="mi">10</span><span class="n">_LAN_CFG_1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">time</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">);</span>	<span class="cm">/* Timeout 3s */</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">hp100_inb</span><span class="p">(</span><span class="n">VG_LAN_CFG_1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">HP100_LINK_CABLE_ST</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">in_interrupt</span><span class="p">())</span>
			<span class="n">schedule_timeout_interruptible</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">time_after</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">jiffies</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">time_before_eq</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">jiffies</span><span class="p">))</span> <span class="p">{</span>
<span class="cp">#ifdef HP100_DEBUG</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;hp100: %s: down_vg_link: timeout</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">time</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">);</span>	<span class="cm">/* This seems to take a while.... */</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">in_interrupt</span><span class="p">())</span>
			<span class="n">schedule_timeout_interruptible</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">time_after</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">jiffies</span><span class="p">));</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hp100_login_to_vg_hub</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u_short</span> <span class="n">force_relogin</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ioaddr</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hp100_private</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u_short</span> <span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">time</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">startst</span><span class="p">;</span>

<span class="cp">#ifdef HP100_DEBUG_B</span>
	<span class="n">hp100_outw</span><span class="p">(</span><span class="mh">0x4225</span><span class="p">,</span> <span class="n">TRACE</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;hp100: %s: login_to_vg_hub</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="cm">/* Initiate a login sequence iff VG MAC is enabled and either Load Address</span>
<span class="cm">	 * bit is zero or the force relogin flag is set (e.g. due to MAC address or</span>
<span class="cm">	 * promiscuous mode change)</span>
<span class="cm">	 */</span>
	<span class="n">hp100_page</span><span class="p">(</span><span class="n">MAC_CTRL</span><span class="p">);</span>
	<span class="n">startst</span> <span class="o">=</span> <span class="n">hp100_inb</span><span class="p">(</span><span class="n">VG_LAN_CFG_1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">force_relogin</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">hp100_inb</span><span class="p">(</span><span class="n">MAC_CFG_4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">HP100_MAC_SEL_ST</span><span class="p">))</span> <span class="p">{</span>
<span class="cp">#ifdef HP100_DEBUG_TRAINING</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;hp100: %s: Start training</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
<span class="cp">#endif</span>

		<span class="cm">/* Ensure VG Reset bit is 1 (i.e., do not reset) */</span>
		<span class="n">hp100_orb</span><span class="p">(</span><span class="n">HP100_VG_RESET</span><span class="p">,</span> <span class="n">VG_LAN_CFG_1</span><span class="p">);</span>

		<span class="cm">/* If Lassen AND auto-select-mode AND VG tones were sensed on */</span>
		<span class="cm">/* entry then temporarily put them into force 100Mbit mode */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">chip</span> <span class="o">==</span> <span class="n">HP100_CHIPID_LASSEN</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">startst</span> <span class="o">&amp;</span> <span class="n">HP100_LINK_CABLE_ST</span><span class="p">))</span>
			<span class="n">hp100_andb</span><span class="p">(</span><span class="o">~</span><span class="n">HP100_DOT3_MAC</span><span class="p">,</span> <span class="mi">10</span><span class="n">_LAN_CFG_2</span><span class="p">);</span>

		<span class="cm">/* Drop the VG link by zeroing Link Up Command and Load Address  */</span>
		<span class="n">hp100_andb</span><span class="p">(</span><span class="o">~</span><span class="p">(</span><span class="n">HP100_LINK_CMD</span> <span class="cm">/* |HP100_LOAD_ADDR */</span> <span class="p">),</span> <span class="n">VG_LAN_CFG_1</span><span class="p">);</span>

<span class="cp">#ifdef HP100_DEBUG_TRAINING</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;hp100: %s: Bring down the link</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
<span class="cp">#endif</span>

		<span class="cm">/* Wait for link to drop */</span>
		<span class="n">time</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="p">(</span><span class="n">HZ</span> <span class="o">/</span> <span class="mi">10</span><span class="p">);</span>
		<span class="k">do</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">~</span><span class="p">(</span><span class="n">hp100_inb</span><span class="p">(</span><span class="n">VG_LAN_CFG_1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">HP100_LINK_UP_ST</span><span class="p">))</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">in_interrupt</span><span class="p">())</span>
				<span class="n">schedule_timeout_interruptible</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">time_after</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">jiffies</span><span class="p">));</span>

		<span class="cm">/* Start an addressed training and optionally request promiscuous port */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">IFF_PROMISC</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">hp100_orb</span><span class="p">(</span><span class="n">HP100_PROM_MODE</span><span class="p">,</span> <span class="n">VG_LAN_CFG_2</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">chip</span> <span class="o">==</span> <span class="n">HP100_CHIPID_LASSEN</span><span class="p">)</span>
				<span class="n">hp100_orw</span><span class="p">(</span><span class="n">HP100_MACRQ_PROMSC</span><span class="p">,</span> <span class="n">TRAIN_REQUEST</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">hp100_andb</span><span class="p">(</span><span class="o">~</span><span class="n">HP100_PROM_MODE</span><span class="p">,</span> <span class="n">VG_LAN_CFG_2</span><span class="p">);</span>
			<span class="cm">/* For ETR parts we need to reset the prom. bit in the training</span>
<span class="cm">			 * register, otherwise promiscious mode won&#39;t be disabled.</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">chip</span> <span class="o">==</span> <span class="n">HP100_CHIPID_LASSEN</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">hp100_andw</span><span class="p">(</span><span class="o">~</span><span class="n">HP100_MACRQ_PROMSC</span><span class="p">,</span> <span class="n">TRAIN_REQUEST</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="cm">/* With ETR parts, frame format request bits can be set. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">chip</span> <span class="o">==</span> <span class="n">HP100_CHIPID_LASSEN</span><span class="p">)</span>
			<span class="n">hp100_orb</span><span class="p">(</span><span class="n">HP100_MACRQ_FRAMEFMT_EITHER</span><span class="p">,</span> <span class="n">TRAIN_REQUEST</span><span class="p">);</span>

		<span class="n">hp100_orb</span><span class="p">(</span><span class="n">HP100_LINK_CMD</span> <span class="o">|</span> <span class="n">HP100_LOAD_ADDR</span> <span class="o">|</span> <span class="n">HP100_VG_RESET</span><span class="p">,</span> <span class="n">VG_LAN_CFG_1</span><span class="p">);</span>

		<span class="cm">/* Note: Next wait could be omitted for Hood and earlier chips under */</span>
		<span class="cm">/* certain circumstances */</span>
		<span class="cm">/* TODO: check if hood/earlier and skip wait. */</span>

		<span class="cm">/* Wait for either short timeout for VG tones or long for login    */</span>
		<span class="cm">/* Wait for the card hardware to signalise link cable status ok... */</span>
		<span class="n">hp100_page</span><span class="p">(</span><span class="n">MAC_CTRL</span><span class="p">);</span>
		<span class="n">time</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">);</span>	<span class="cm">/* 1 sec timeout for cable st */</span>
		<span class="k">do</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">hp100_inb</span><span class="p">(</span><span class="n">VG_LAN_CFG_1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">HP100_LINK_CABLE_ST</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">in_interrupt</span><span class="p">())</span>
				<span class="n">schedule_timeout_interruptible</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">time_before</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">time</span><span class="p">));</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">time_after_eq</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">time</span><span class="p">))</span> <span class="p">{</span>
<span class="cp">#ifdef HP100_DEBUG_TRAINING</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;hp100: %s: Link cable status not ok? Training aborted.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<span class="cp">#ifdef HP100_DEBUG_TRAINING</span>
			<span class="n">printk</span>
			    <span class="p">(</span><span class="s">&quot;hp100: %s: HUB tones detected. Trying to train.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			     <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
<span class="cp">#endif</span>

			<span class="n">time</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">);</span>	<span class="cm">/* again a timeout */</span>
			<span class="k">do</span> <span class="p">{</span>
				<span class="n">val</span> <span class="o">=</span> <span class="n">hp100_inb</span><span class="p">(</span><span class="n">VG_LAN_CFG_1</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">val</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">HP100_LINK_UP_ST</span><span class="p">)))</span> <span class="p">{</span>
<span class="cp">#ifdef HP100_DEBUG_TRAINING</span>
					<span class="n">printk</span><span class="p">(</span><span class="s">&quot;hp100: %s: Passed training.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
<span class="cp">#endif</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">in_interrupt</span><span class="p">())</span>
					<span class="n">schedule_timeout_interruptible</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">time_after</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">jiffies</span><span class="p">));</span>
		<span class="p">}</span>

		<span class="cm">/* If LINK_UP_ST is set, then we are logged into the hub. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">time_before_eq</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">time</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">HP100_LINK_UP_ST</span><span class="p">))</span> <span class="p">{</span>
<span class="cp">#ifdef HP100_DEBUG_TRAINING</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;hp100: %s: Successfully logged into the HUB.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">chip</span> <span class="o">==</span> <span class="n">HP100_CHIPID_LASSEN</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">val</span> <span class="o">=</span> <span class="n">hp100_inw</span><span class="p">(</span><span class="n">TRAIN_ALLOW</span><span class="p">);</span>
				<span class="n">printk</span><span class="p">(</span><span class="s">&quot;hp100: %s: Card supports 100VG MAC Version </span><span class="se">\&quot;</span><span class="s">%s</span><span class="se">\&quot;</span><span class="s"> &quot;</span><span class="p">,</span>
					     <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="p">(</span><span class="n">hp100_inw</span><span class="p">(</span><span class="n">TRAIN_REQUEST</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">HP100_CARD_MACVER</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;802.12&quot;</span> <span class="o">:</span> <span class="s">&quot;Pre&quot;</span><span class="p">);</span>
				<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Driver will use MAC Version </span><span class="se">\&quot;</span><span class="s">%s</span><span class="se">\&quot;\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">HP100_HUB_MACVER</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;802.12&quot;</span> <span class="o">:</span> <span class="s">&quot;Pre&quot;</span><span class="p">);</span>
				<span class="n">printk</span><span class="p">(</span><span class="s">&quot;hp100: %s: Frame format is %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">HP100_MALLOW_FRAMEFMT</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;802.5&quot;</span> <span class="o">:</span> <span class="s">&quot;802.3&quot;</span><span class="p">);</span>
			<span class="p">}</span>
<span class="cp">#endif</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* If LINK_UP_ST is not set, login was not successful */</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;hp100: %s: Problem logging into the HUB.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">chip</span> <span class="o">==</span> <span class="n">HP100_CHIPID_LASSEN</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* Check allowed Register to find out why there is a problem. */</span>
				<span class="n">val</span> <span class="o">=</span> <span class="n">hp100_inw</span><span class="p">(</span><span class="n">TRAIN_ALLOW</span><span class="p">);</span>	<span class="cm">/* won&#39;t work on non-ETR card */</span>
<span class="cp">#ifdef HP100_DEBUG_TRAINING</span>
				<span class="n">printk</span><span class="p">(</span><span class="s">&quot;hp100: %s: MAC Configuration requested: 0x%04x, HUB allowed: 0x%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">hp100_inw</span><span class="p">(</span><span class="n">TRAIN_REQUEST</span><span class="p">),</span> <span class="n">val</span><span class="p">);</span>
<span class="cp">#endif</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">HP100_MALLOW_ACCDENIED</span><span class="p">)</span>
					<span class="n">printk</span><span class="p">(</span><span class="s">&quot;hp100: %s: HUB access denied.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">HP100_MALLOW_CONFIGURE</span><span class="p">)</span>
					<span class="n">printk</span><span class="p">(</span><span class="s">&quot;hp100: %s: MAC Configuration is incompatible with the Network.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">HP100_MALLOW_DUPADDR</span><span class="p">)</span>
					<span class="n">printk</span><span class="p">(</span><span class="s">&quot;hp100: %s: Duplicate MAC Address on the Network.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="cm">/* If we have put the chip into forced 100 Mbit mode earlier, go back */</span>
		<span class="cm">/* to auto-select mode */</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">chip</span> <span class="o">==</span> <span class="n">HP100_CHIPID_LASSEN</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">startst</span> <span class="o">&amp;</span> <span class="n">HP100_LINK_CABLE_ST</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">hp100_page</span><span class="p">(</span><span class="n">MAC_CTRL</span><span class="p">);</span>
			<span class="n">hp100_orb</span><span class="p">(</span><span class="n">HP100_DOT3_MAC</span><span class="p">,</span> <span class="mi">10</span><span class="n">_LAN_CFG_2</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">val</span> <span class="o">=</span> <span class="n">hp100_inb</span><span class="p">(</span><span class="n">VG_LAN_CFG_1</span><span class="p">);</span>

		<span class="cm">/* Clear the MISC_ERROR Interrupt, which might be generated when doing the relogin */</span>
		<span class="n">hp100_page</span><span class="p">(</span><span class="n">PERFORMANCE</span><span class="p">);</span>
		<span class="n">hp100_outw</span><span class="p">(</span><span class="n">HP100_MISC_ERROR</span><span class="p">,</span> <span class="n">IRQ_STATUS</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">HP100_LINK_UP_ST</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* login was ok */</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;hp100: %s: Training failed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="n">hp100_down_vg_link</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="cm">/* no forced relogin &amp; already link there-&gt;no training. */</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hp100_cascade_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u_short</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ioaddr</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hp100_private</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

<span class="cp">#ifdef HP100_DEBUG_B</span>
	<span class="n">hp100_outw</span><span class="p">(</span><span class="mh">0x4226</span><span class="p">,</span> <span class="n">TRACE</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;hp100: %s: cascade_reset</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">enable</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hp100_outw</span><span class="p">(</span><span class="n">HP100_HW_RST</span> <span class="o">|</span> <span class="n">HP100_RESET_LB</span><span class="p">,</span> <span class="n">OPTION_LSW</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">chip</span> <span class="o">==</span> <span class="n">HP100_CHIPID_LASSEN</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Lassen requires a PCI transmit fifo reset */</span>
			<span class="n">hp100_page</span><span class="p">(</span><span class="n">HW_MAP</span><span class="p">);</span>
			<span class="n">hp100_andb</span><span class="p">(</span><span class="o">~</span><span class="n">HP100_PCI_RESET</span><span class="p">,</span> <span class="n">PCICTRL2</span><span class="p">);</span>
			<span class="n">hp100_orb</span><span class="p">(</span><span class="n">HP100_PCI_RESET</span><span class="p">,</span> <span class="n">PCICTRL2</span><span class="p">);</span>
			<span class="cm">/* Wait for min. 300 ns */</span>
			<span class="cm">/* we can&#39;t use jiffies here, because it may be */</span>
			<span class="cm">/* that we have disabled the timer... */</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">400</span><span class="p">);</span>
			<span class="n">hp100_andb</span><span class="p">(</span><span class="o">~</span><span class="n">HP100_PCI_RESET</span><span class="p">,</span> <span class="n">PCICTRL2</span><span class="p">);</span>
			<span class="n">hp100_page</span><span class="p">(</span><span class="n">PERFORMANCE</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>		<span class="cm">/* bring out of reset */</span>
		<span class="n">hp100_outw</span><span class="p">(</span><span class="n">HP100_HW_RST</span> <span class="o">|</span> <span class="n">HP100_SET_LB</span><span class="p">,</span> <span class="n">OPTION_LSW</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">400</span><span class="p">);</span>
		<span class="n">hp100_page</span><span class="p">(</span><span class="n">PERFORMANCE</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cp">#ifdef HP100_DEBUG</span>
<span class="kt">void</span> <span class="nf">hp100_RegisterDump</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ioaddr</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">Page</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">Register</span><span class="p">;</span>

	<span class="cm">/* Dump common registers */</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;hp100: %s: Cascade Register Dump</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;hardware id #1: 0x%.2x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hp100_inb</span><span class="p">(</span><span class="n">HW_ID</span><span class="p">));</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;hardware id #2/paging: 0x%.2x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hp100_inb</span><span class="p">(</span><span class="n">PAGING</span><span class="p">));</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;option #1: 0x%.4x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hp100_inw</span><span class="p">(</span><span class="n">OPTION_LSW</span><span class="p">));</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;option #2: 0x%.4x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hp100_inw</span><span class="p">(</span><span class="n">OPTION_MSW</span><span class="p">));</span>

	<span class="cm">/* Dump paged registers */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">Page</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">Page</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">Page</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Dump registers */</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;page: 0x%.2x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">Page</span><span class="p">);</span>
		<span class="n">outw</span><span class="p">(</span><span class="n">Page</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="mh">0x02</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">Register</span> <span class="o">=</span> <span class="mh">0x8</span><span class="p">;</span> <span class="n">Register</span> <span class="o">&lt;</span> <span class="mh">0x22</span><span class="p">;</span> <span class="n">Register</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Display Register contents except data port */</span>
			<span class="k">if</span> <span class="p">(((</span><span class="n">Register</span> <span class="o">!=</span> <span class="mh">0x10</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">Register</span> <span class="o">!=</span> <span class="mh">0x12</span><span class="p">))</span> <span class="o">||</span> <span class="p">(</span><span class="n">Page</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="s">&quot;0x%.2x = 0x%.4x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">Register</span><span class="p">,</span> <span class="n">inw</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">Register</span><span class="p">));</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">hp100_page</span><span class="p">(</span><span class="n">PERFORMANCE</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">cleanup_dev</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">d</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hp100_private</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>

	<span class="n">unregister_netdev</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>
	<span class="n">release_region</span><span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">,</span> <span class="n">HP100_REGION_SIZE</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>	<span class="cm">/* busmaster */</span>
		<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span> <span class="n">MAX_RINGSIZE</span> <span class="o">+</span> <span class="mh">0x0f</span><span class="p">,</span>
				    <span class="n">p</span><span class="o">-&gt;</span><span class="n">page_vaddr_algn</span><span class="p">,</span>
				    <span class="n">virt_to_whatever</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">page_vaddr_algn</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">mem_ptr_virt</span><span class="p">)</span>
		<span class="n">iounmap</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">mem_ptr_virt</span><span class="p">);</span>

	<span class="n">free_netdev</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_EISA</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">hp100_eisa_probe</span> <span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">gendev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">alloc_etherdev</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">hp100_private</span><span class="p">));</span>
	<span class="k">struct</span> <span class="n">eisa_device</span> <span class="o">*</span><span class="n">edev</span> <span class="o">=</span> <span class="n">to_eisa_device</span><span class="p">(</span><span class="n">gendev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">SET_NETDEV_DEV</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">edev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">hp100_probe1</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">edev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">+</span> <span class="mh">0xC38</span><span class="p">,</span> <span class="n">HP100_BUS_EISA</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out1</span><span class="p">;</span>

<span class="cp">#ifdef HP100_DEBUG</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;hp100: %s: EISA adapter found at 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
	       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">dev_set_drvdata</span><span class="p">(</span><span class="n">gendev</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
 <span class="nl">out1:</span>
	<span class="n">free_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devexit</span> <span class="nf">hp100_eisa_remove</span> <span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">gendev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">gendev</span><span class="p">);</span>
	<span class="n">cleanup_dev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">eisa_driver</span> <span class="n">hp100_eisa_driver</span> <span class="o">=</span> <span class="p">{</span>
        <span class="p">.</span><span class="n">id_table</span> <span class="o">=</span> <span class="n">hp100_eisa_tbl</span><span class="p">,</span>
        <span class="p">.</span><span class="n">driver</span>   <span class="o">=</span> <span class="p">{</span>
                <span class="p">.</span><span class="n">name</span>    <span class="o">=</span> <span class="s">&quot;hp100&quot;</span><span class="p">,</span>
                <span class="p">.</span><span class="n">probe</span>   <span class="o">=</span> <span class="n">hp100_eisa_probe</span><span class="p">,</span>
                <span class="p">.</span><span class="n">remove</span>  <span class="o">=</span> <span class="n">__devexit_p</span> <span class="p">(</span><span class="n">hp100_eisa_remove</span><span class="p">),</span>
        <span class="p">}</span>
<span class="p">};</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_PCI</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">hp100_pci_probe</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span>
				     <span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="o">*</span><span class="n">ent</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ioaddr</span><span class="p">;</span>
	<span class="n">u_short</span> <span class="n">pci_command</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pci_enable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">dev</span> <span class="o">=</span> <span class="n">alloc_etherdev</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">hp100_private</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">SET_NETDEV_DEV</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_COMMAND</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pci_command</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">pci_command</span> <span class="o">&amp;</span> <span class="n">PCI_COMMAND_IO</span><span class="p">))</span> <span class="p">{</span>
<span class="cp">#ifdef HP100_DEBUG</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;hp100: %s: PCI I/O Bit has not been set. Setting...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="n">pci_command</span> <span class="o">|=</span> <span class="n">PCI_COMMAND_IO</span><span class="p">;</span>
		<span class="n">pci_write_config_word</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_COMMAND</span><span class="p">,</span> <span class="n">pci_command</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">pci_command</span> <span class="o">&amp;</span> <span class="n">PCI_COMMAND_MASTER</span><span class="p">))</span> <span class="p">{</span>
<span class="cp">#ifdef HP100_DEBUG</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;hp100: %s: PCI Master Bit has not been set. Setting...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="n">pci_command</span> <span class="o">|=</span> <span class="n">PCI_COMMAND_MASTER</span><span class="p">;</span>
		<span class="n">pci_write_config_word</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_COMMAND</span><span class="p">,</span> <span class="n">pci_command</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">ioaddr</span> <span class="o">=</span> <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">hp100_probe1</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ioaddr</span><span class="p">,</span> <span class="n">HP100_BUS_PCI</span><span class="p">,</span> <span class="n">pdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out1</span><span class="p">;</span>

<span class="cp">#ifdef HP100_DEBUG</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;hp100: %s: PCI adapter found at 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ioaddr</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
 <span class="nl">out1:</span>
	<span class="n">free_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
 <span class="nl">out0:</span>
	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devexit</span> <span class="nf">hp100_pci_remove</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="n">cleanup_dev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_driver</span> <span class="n">hp100_pci_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;hp100&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span>	<span class="o">=</span> <span class="n">hp100_pci_tbl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span>		<span class="o">=</span> <span class="n">hp100_pci_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>		<span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">hp100_pci_remove</span><span class="p">),</span>
<span class="p">};</span>
<span class="cp">#endif</span>

<span class="cm">/*</span>
<span class="cm"> *  module section</span>
<span class="cm"> */</span>

<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Jaroslav Kysela &lt;perex@perex.cz&gt;, &quot;</span>
              <span class="s">&quot;Siegfried </span><span class="se">\&quot;</span><span class="s">Frieder</span><span class="se">\&quot;</span><span class="s"> Loeffler (dg1sek) &lt;floeff@mathematik.uni-stuttgart.de&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;HP CASCADE Architecture Driver for 100VG-AnyLan Network Adapters&quot;</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Note: to register three isa devices, use:</span>
<span class="cm"> * option hp100 hp100_port=0,0,0</span>
<span class="cm"> *        to register one card at io 0x280 as eth239, use:</span>
<span class="cm"> * option hp100 hp100_port=0x280</span>
<span class="cm"> */</span>
<span class="cp">#if defined(MODULE) &amp;&amp; defined(CONFIG_ISA)</span>
<span class="cp">#define HP100_DEVICES 5</span>
<span class="cm">/* Parameters set by insmod */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">hp100_port</span><span class="p">[</span><span class="n">HP100_DEVICES</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span> <span class="p">...</span> <span class="p">(</span><span class="n">HP100_DEVICES</span><span class="o">-</span><span class="mi">1</span><span class="p">)]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="p">};</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">hp100_port</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

<span class="cm">/* List of devices */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">hp100_devlist</span><span class="p">[</span><span class="n">HP100_DEVICES</span><span class="p">];</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">hp100_isa_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">err</span><span class="p">,</span> <span class="n">cards</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Don&#39;t autoprobe ISA bus */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hp100_port</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="cm">/* Loop on all possible base addresses */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">HP100_DEVICES</span> <span class="o">&amp;&amp;</span> <span class="n">hp100_port</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev</span> <span class="o">=</span> <span class="n">alloc_etherdev</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">hp100_private</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">while</span> <span class="p">(</span><span class="n">cards</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">cleanup_dev</span><span class="p">(</span><span class="n">hp100_devlist</span><span class="p">[</span><span class="o">--</span><span class="n">cards</span><span class="p">]);</span>

			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">hp100_isa_probe</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">hp100_port</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span>
			<span class="n">hp100_devlist</span><span class="p">[</span><span class="n">cards</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">free_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">cards</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hp100_isa_cleanup</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">HP100_DEVICES</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">hp100_devlist</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="p">)</span>
			<span class="n">cleanup_dev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="cp">#else</span>
<span class="cp">#define hp100_isa_init()	(0)</span>
<span class="cp">#define hp100_isa_cleanup()	do { } while(0)</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">hp100_module_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">hp100_isa_init</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&amp;&amp;</span> <span class="n">err</span> <span class="o">!=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_EISA</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">eisa_driver_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hp100_eisa_driver</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&amp;&amp;</span> <span class="n">err</span> <span class="o">!=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out2</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_PCI</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">pci_register_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hp100_pci_driver</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&amp;&amp;</span> <span class="n">err</span> <span class="o">!=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out3</span><span class="p">;</span>
<span class="cp">#endif</span>
 <span class="nl">out:</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
 <span class="nl">out3:</span>
<span class="cp">#ifdef CONFIG_EISA</span>
	<span class="n">eisa_driver_unregister</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">hp100_eisa_driver</span><span class="p">);</span>
 <span class="nl">out2:</span>
<span class="cp">#endif</span>
	<span class="n">hp100_isa_cleanup</span><span class="p">();</span>
	<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">hp100_module_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">hp100_isa_cleanup</span><span class="p">();</span>
<span class="cp">#ifdef CONFIG_EISA</span>
	<span class="n">eisa_driver_unregister</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">hp100_eisa_driver</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_PCI</span>
	<span class="n">pci_unregister_driver</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">hp100_pci_driver</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">hp100_module_init</span><span class="p">)</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">hp100_module_exit</span><span class="p">)</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
