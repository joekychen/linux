<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › ethernet › xilinx › ll_temac_main.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>ll_temac_main.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Driver for Xilinx TEMAC Ethernet device</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (c) 2008 Nissin Systems Co., Ltd.,  Yoshio Kashiwagi</span>
<span class="cm"> * Copyright (c) 2005-2008 DLA Systems,  David H. Lynch Jr. &lt;dhlii@dlasys.net&gt;</span>
<span class="cm"> * Copyright (c) 2008-2009 Secret Lab Technologies Ltd.</span>
<span class="cm"> *</span>
<span class="cm"> * This is a driver for the Xilinx ll_temac ipcore which is often used</span>
<span class="cm"> * in the Virtex and Spartan series of chips.</span>
<span class="cm"> *</span>
<span class="cm"> * Notes:</span>
<span class="cm"> * - The ll_temac hardware uses indirect access for many of the TEMAC</span>
<span class="cm"> *   registers, include the MDIO bus.  However, indirect access to MDIO</span>
<span class="cm"> *   registers take considerably more clock cycles than to TEMAC registers.</span>
<span class="cm"> *   MDIO accesses are long, so threads doing them should probably sleep</span>
<span class="cm"> *   rather than busywait.  However, since only one indirect access can be</span>
<span class="cm"> *   in progress at any given time, that means that *all* indirect accesses</span>
<span class="cm"> *   could end up sleeping (to wait for an MDIO access to complete).</span>
<span class="cm"> *   Fortunately none of the indirect accesses are on the &#39;hot&#39; path for tx</span>
<span class="cm"> *   or rx, so this should be okay.</span>
<span class="cm"> *</span>
<span class="cm"> * TODO:</span>
<span class="cm"> * - Factor out locallink DMA code into separate driver</span>
<span class="cm"> * - Fix multicast assignment.</span>
<span class="cm"> * - Fix support for hardware checksumming.</span>
<span class="cm"> * - Testing.  Lots and lots of testing.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/etherdevice.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/mii.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/mutex.h&gt;</span>
<span class="cp">#include &lt;linux/netdevice.h&gt;</span>
<span class="cp">#include &lt;linux/of.h&gt;</span>
<span class="cp">#include &lt;linux/of_device.h&gt;</span>
<span class="cp">#include &lt;linux/of_mdio.h&gt;</span>
<span class="cp">#include &lt;linux/of_platform.h&gt;</span>
<span class="cp">#include &lt;linux/of_address.h&gt;</span>
<span class="cp">#include &lt;linux/skbuff.h&gt;</span>
<span class="cp">#include &lt;linux/spinlock.h&gt;</span>
<span class="cp">#include &lt;linux/tcp.h&gt;      </span><span class="cm">/* needed for sizeof(tcphdr) */</span><span class="cp"></span>
<span class="cp">#include &lt;linux/udp.h&gt;      </span><span class="cm">/* needed for sizeof(udphdr) */</span><span class="cp"></span>
<span class="cp">#include &lt;linux/phy.h&gt;</span>
<span class="cp">#include &lt;linux/in.h&gt;</span>
<span class="cp">#include &lt;linux/io.h&gt;</span>
<span class="cp">#include &lt;linux/ip.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/dma-mapping.h&gt;</span>

<span class="cp">#include &quot;ll_temac.h&quot;</span>

<span class="cp">#define TX_BD_NUM   64</span>
<span class="cp">#define RX_BD_NUM   128</span>

<span class="cm">/* ---------------------------------------------------------------------</span>
<span class="cm"> * Low level register access functions</span>
<span class="cm"> */</span>

<span class="n">u32</span> <span class="nf">temac_ior</span><span class="p">(</span><span class="k">struct</span> <span class="n">temac_local</span> <span class="o">*</span><span class="n">lp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">in_be32</span><span class="p">((</span><span class="n">u32</span> <span class="o">*</span><span class="p">)(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">offset</span><span class="p">));</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">temac_iow</span><span class="p">(</span><span class="k">struct</span> <span class="n">temac_local</span> <span class="o">*</span><span class="n">lp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">offset</span><span class="p">,</span> <span class="n">u32</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">out_be32</span><span class="p">((</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">offset</span><span class="p">),</span> <span class="n">value</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">temac_indirect_busywait</span><span class="p">(</span><span class="k">struct</span> <span class="n">temac_local</span> <span class="o">*</span><span class="n">lp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">long</span> <span class="n">end</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">temac_ior</span><span class="p">(</span><span class="n">lp</span><span class="p">,</span> <span class="n">XTE_RDY0_OFFSET</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">XTE_RDY0_HARD_ACS_RDY_MASK</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">end</span> <span class="o">-</span> <span class="n">jiffies</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">WARN_ON</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * temac_indirect_in32</span>
<span class="cm"> *</span>
<span class="cm"> * lp-&gt;indirect_mutex must be held when calling this function</span>
<span class="cm"> */</span>
<span class="n">u32</span> <span class="nf">temac_indirect_in32</span><span class="p">(</span><span class="k">struct</span> <span class="n">temac_local</span> <span class="o">*</span><span class="n">lp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">temac_indirect_busywait</span><span class="p">(</span><span class="n">lp</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>
	<span class="n">temac_iow</span><span class="p">(</span><span class="n">lp</span><span class="p">,</span> <span class="n">XTE_CTL0_OFFSET</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">temac_indirect_busywait</span><span class="p">(</span><span class="n">lp</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">temac_ior</span><span class="p">(</span><span class="n">lp</span><span class="p">,</span> <span class="n">XTE_LSW0_OFFSET</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">val</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * temac_indirect_out32</span>
<span class="cm"> *</span>
<span class="cm"> * lp-&gt;indirect_mutex must be held when calling this function</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">temac_indirect_out32</span><span class="p">(</span><span class="k">struct</span> <span class="n">temac_local</span> <span class="o">*</span><span class="n">lp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u32</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">temac_indirect_busywait</span><span class="p">(</span><span class="n">lp</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">temac_iow</span><span class="p">(</span><span class="n">lp</span><span class="p">,</span> <span class="n">XTE_LSW0_OFFSET</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
	<span class="n">temac_iow</span><span class="p">(</span><span class="n">lp</span><span class="p">,</span> <span class="n">XTE_CTL0_OFFSET</span><span class="p">,</span> <span class="n">CNTLREG_WRITE_ENABLE_MASK</span> <span class="o">|</span> <span class="n">reg</span><span class="p">);</span>
	<span class="n">temac_indirect_busywait</span><span class="p">(</span><span class="n">lp</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * temac_dma_in32 - Memory mapped DMA read, this function expects a</span>
<span class="cm"> * register input that is based on DCR word addresses which</span>
<span class="cm"> * are then converted to memory mapped byte addresses</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">u32</span> <span class="nf">temac_dma_in32</span><span class="p">(</span><span class="k">struct</span> <span class="n">temac_local</span> <span class="o">*</span><span class="n">lp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">in_be32</span><span class="p">((</span><span class="n">u32</span> <span class="o">*</span><span class="p">)(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">sdma_regs</span> <span class="o">+</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)));</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * temac_dma_out32 - Memory mapped DMA read, this function expects a</span>
<span class="cm"> * register input that is based on DCR word addresses which</span>
<span class="cm"> * are then converted to memory mapped byte addresses</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">temac_dma_out32</span><span class="p">(</span><span class="k">struct</span> <span class="n">temac_local</span> <span class="o">*</span><span class="n">lp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u32</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">out_be32</span><span class="p">((</span><span class="n">u32</span> <span class="o">*</span><span class="p">)(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">sdma_regs</span> <span class="o">+</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)),</span> <span class="n">value</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* DMA register access functions can be DCR based or memory mapped.</span>
<span class="cm"> * The PowerPC 440 is DCR based, the PowerPC 405 and MicroBlaze are both</span>
<span class="cm"> * memory mapped.</span>
<span class="cm"> */</span>
<span class="cp">#ifdef CONFIG_PPC_DCR</span>

<span class="cm">/**</span>
<span class="cm"> * temac_dma_dcr_in32 - DCR based DMA read</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">u32</span> <span class="nf">temac_dma_dcr_in</span><span class="p">(</span><span class="k">struct</span> <span class="n">temac_local</span> <span class="o">*</span><span class="n">lp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">dcr_read</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">sdma_dcrs</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * temac_dma_dcr_out32 - DCR based DMA write</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">temac_dma_dcr_out</span><span class="p">(</span><span class="k">struct</span> <span class="n">temac_local</span> <span class="o">*</span><span class="n">lp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u32</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dcr_write</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">sdma_dcrs</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * temac_dcr_setup - If the DMA is DCR based, then setup the address and</span>
<span class="cm"> * I/O  functions</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">temac_dcr_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">temac_local</span> <span class="o">*</span><span class="n">lp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">op</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">np</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dcrs</span><span class="p">;</span>

	<span class="cm">/* setup the dcr address mapping if it&#39;s in the device tree */</span>

	<span class="n">dcrs</span> <span class="o">=</span> <span class="n">dcr_resource_start</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dcrs</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">sdma_dcrs</span> <span class="o">=</span> <span class="n">dcr_map</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">dcrs</span><span class="p">,</span> <span class="n">dcr_resource_len</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="mi">0</span><span class="p">));</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">dma_in</span> <span class="o">=</span> <span class="n">temac_dma_dcr_in</span><span class="p">;</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">dma_out</span> <span class="o">=</span> <span class="n">temac_dma_dcr_out</span><span class="p">;</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;DCR base: %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dcrs</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* no DCR in the device tree, indicate a failure */</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#else</span>

<span class="cm">/*</span>
<span class="cm"> * temac_dcr_setup - This is a stub for when DCR is not supported,</span>
<span class="cm"> * such as with MicroBlaze</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">temac_dcr_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">temac_local</span> <span class="o">*</span><span class="n">lp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">op</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">np</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#endif</span>

<span class="cm">/**</span>
<span class="cm"> *  * temac_dma_bd_release - Release buffer descriptor rings</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">temac_dma_bd_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">temac_local</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* Reset Local Link (DMA) */</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">dma_out</span><span class="p">(</span><span class="n">lp</span><span class="p">,</span> <span class="n">DMA_CONTROL_REG</span><span class="p">,</span> <span class="n">DMA_CONTROL_RST</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">RX_BD_NUM</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_skb</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">dma_unmap_single</span><span class="p">(</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_bd_v</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">phys</span><span class="p">,</span>
					<span class="n">XTE_MAX_JUMBO_FRAME_SIZE</span><span class="p">,</span> <span class="n">DMA_FROM_DEVICE</span><span class="p">);</span>
			<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_skb</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_bd_v</span><span class="p">)</span>
		<span class="n">dma_free_coherent</span><span class="p">(</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span><span class="p">,</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_bd_v</span><span class="p">)</span> <span class="o">*</span> <span class="n">RX_BD_NUM</span><span class="p">,</span>
				<span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_bd_v</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_bd_p</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_bd_v</span><span class="p">)</span>
		<span class="n">dma_free_coherent</span><span class="p">(</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span><span class="p">,</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_bd_v</span><span class="p">)</span> <span class="o">*</span> <span class="n">TX_BD_NUM</span><span class="p">,</span>
				<span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_bd_v</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_bd_p</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_skb</span><span class="p">)</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_skb</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * temac_dma_bd_init - Setup buffer descriptor rings</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">temac_dma_bd_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">temac_local</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_skb</span> <span class="o">=</span> <span class="n">kcalloc</span><span class="p">(</span><span class="n">RX_BD_NUM</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_skb</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_skb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;can&#39;t allocate memory for DMA RX buffer</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* allocate the tx and rx ring buffer descriptors. */</span>
	<span class="cm">/* returns a virtual address and a physical address. */</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_bd_v</span> <span class="o">=</span> <span class="n">dma_alloc_coherent</span><span class="p">(</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span><span class="p">,</span>
					 <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_bd_v</span><span class="p">)</span> <span class="o">*</span> <span class="n">TX_BD_NUM</span><span class="p">,</span>
					 <span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_bd_p</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_bd_v</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;unable to allocate DMA TX buffer descriptors&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_bd_v</span> <span class="o">=</span> <span class="n">dma_alloc_coherent</span><span class="p">(</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span><span class="p">,</span>
					 <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_bd_v</span><span class="p">)</span> <span class="o">*</span> <span class="n">RX_BD_NUM</span><span class="p">,</span>
					 <span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_bd_p</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_bd_v</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;unable to allocate DMA RX buffer descriptors&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_bd_v</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_bd_v</span><span class="p">)</span> <span class="o">*</span> <span class="n">TX_BD_NUM</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">TX_BD_NUM</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_bd_v</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">next</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_bd_p</span> <span class="o">+</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_bd_v</span><span class="p">)</span> <span class="o">*</span> <span class="p">((</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">TX_BD_NUM</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_bd_v</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_bd_v</span><span class="p">)</span> <span class="o">*</span> <span class="n">RX_BD_NUM</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">RX_BD_NUM</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_bd_v</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">next</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_bd_p</span> <span class="o">+</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_bd_v</span><span class="p">)</span> <span class="o">*</span> <span class="p">((</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">RX_BD_NUM</span><span class="p">);</span>

		<span class="n">skb</span> <span class="o">=</span> <span class="n">netdev_alloc_skb_ip_align</span><span class="p">(</span><span class="n">ndev</span><span class="p">,</span>
						<span class="n">XTE_MAX_JUMBO_FRAME_SIZE</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">skb</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;alloc_skb error %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_skb</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>
		<span class="cm">/* returns physical address of skb-&gt;data */</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_bd_v</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">phys</span> <span class="o">=</span> <span class="n">dma_map_single</span><span class="p">(</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span><span class="p">,</span>
						     <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span>
						     <span class="n">XTE_MAX_JUMBO_FRAME_SIZE</span><span class="p">,</span>
						     <span class="n">DMA_FROM_DEVICE</span><span class="p">);</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_bd_v</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">len</span> <span class="o">=</span> <span class="n">XTE_MAX_JUMBO_FRAME_SIZE</span><span class="p">;</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_bd_v</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">app0</span> <span class="o">=</span> <span class="n">STS_CTRL_APP0_IRQONEND</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">dma_out</span><span class="p">(</span><span class="n">lp</span><span class="p">,</span> <span class="n">TX_CHNL_CTRL</span><span class="p">,</span> <span class="mh">0x10220400</span> <span class="o">|</span>
					  <span class="n">CHNL_CTRL_IRQ_EN</span> <span class="o">|</span>
					  <span class="n">CHNL_CTRL_IRQ_DLY_EN</span> <span class="o">|</span>
					  <span class="n">CHNL_CTRL_IRQ_COAL_EN</span><span class="p">);</span>
	<span class="cm">/* 0x10220483 */</span>
	<span class="cm">/* 0x00100483 */</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">dma_out</span><span class="p">(</span><span class="n">lp</span><span class="p">,</span> <span class="n">RX_CHNL_CTRL</span><span class="p">,</span> <span class="mh">0xff070000</span> <span class="o">|</span>
					  <span class="n">CHNL_CTRL_IRQ_EN</span> <span class="o">|</span>
					  <span class="n">CHNL_CTRL_IRQ_DLY_EN</span> <span class="o">|</span>
					  <span class="n">CHNL_CTRL_IRQ_COAL_EN</span> <span class="o">|</span>
					  <span class="n">CHNL_CTRL_IRQ_IOE</span><span class="p">);</span>
	<span class="cm">/* 0xff010283 */</span>

	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">dma_out</span><span class="p">(</span><span class="n">lp</span><span class="p">,</span> <span class="n">RX_CURDESC_PTR</span><span class="p">,</span>  <span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_bd_p</span><span class="p">);</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">dma_out</span><span class="p">(</span><span class="n">lp</span><span class="p">,</span> <span class="n">RX_TAILDESC_PTR</span><span class="p">,</span>
		       <span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_bd_p</span> <span class="o">+</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_bd_v</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">RX_BD_NUM</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)));</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">dma_out</span><span class="p">(</span><span class="n">lp</span><span class="p">,</span> <span class="n">TX_CURDESC_PTR</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_bd_p</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">out:</span>
	<span class="n">temac_dma_bd_release</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* ---------------------------------------------------------------------</span>
<span class="cm"> * net_device_ops</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">temac_set_mac_address</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">address</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">temac_local</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">address</span><span class="p">)</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">address</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_valid_ether_addr</span><span class="p">(</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">))</span>
		<span class="n">eth_hw_addr_random</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">ndev</span><span class="o">-&gt;</span><span class="n">addr_assign_type</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">NET_ADDR_RANDOM</span><span class="p">;</span>

	<span class="cm">/* set up unicast MAC address filter set its mac address */</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">indirect_mutex</span><span class="p">);</span>
	<span class="n">temac_indirect_out32</span><span class="p">(</span><span class="n">lp</span><span class="p">,</span> <span class="n">XTE_UAW0_OFFSET</span><span class="p">,</span>
			     <span class="p">(</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">|</span>
			     <span class="p">(</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span>
			     <span class="p">(</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span>
			     <span class="p">(</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">));</span>
	<span class="cm">/* There are reserved bits in EUAW1</span>
<span class="cm">	 * so don&#39;t affect them Set MAC bits [47:32] in EUAW1 */</span>
	<span class="n">temac_indirect_out32</span><span class="p">(</span><span class="n">lp</span><span class="p">,</span> <span class="n">XTE_UAW1_OFFSET</span><span class="p">,</span>
			     <span class="p">(</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x000000ff</span><span class="p">)</span> <span class="o">|</span>
			     <span class="p">(</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">));</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">indirect_mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">netdev_set_mac_address</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="n">addr</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">temac_set_mac_address</span><span class="p">(</span><span class="n">ndev</span><span class="p">,</span> <span class="n">addr</span><span class="o">-&gt;</span><span class="n">sa_data</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">temac_set_multicast_list</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">temac_local</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">multi_addr_msw</span><span class="p">,</span> <span class="n">multi_addr_lsw</span><span class="p">,</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">indirect_mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">IFF_ALLMULTI</span> <span class="o">|</span> <span class="n">IFF_PROMISC</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">netdev_mc_count</span><span class="p">(</span><span class="n">ndev</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">MULTICAST_CAM_TABLE_NUM</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 *	We must make the kernel realise we had to move</span>
<span class="cm">		 *	into promisc mode or we start all out war on</span>
<span class="cm">		 *	the cable. If it was a promisc request the</span>
<span class="cm">		 *	flag is already set. If not we assert it.</span>
<span class="cm">		 */</span>
		<span class="n">ndev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">IFF_PROMISC</span><span class="p">;</span>
		<span class="n">temac_indirect_out32</span><span class="p">(</span><span class="n">lp</span><span class="p">,</span> <span class="n">XTE_AFM_OFFSET</span><span class="p">,</span> <span class="n">XTE_AFM_EPPRM_MASK</span><span class="p">);</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Promiscuous mode enabled.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">netdev_mc_empty</span><span class="p">(</span><span class="n">ndev</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">netdev_hw_addr</span> <span class="o">*</span><span class="n">ha</span><span class="p">;</span>

		<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">netdev_for_each_mc_addr</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">ndev</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="n">MULTICAST_CAM_TABLE_NUM</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">multi_addr_msw</span> <span class="o">=</span> <span class="p">((</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">|</span>
					  <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span>
					  <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span>
					  <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">[</span><span class="mi">0</span><span class="p">]));</span>
			<span class="n">temac_indirect_out32</span><span class="p">(</span><span class="n">lp</span><span class="p">,</span> <span class="n">XTE_MAW0_OFFSET</span><span class="p">,</span>
					     <span class="n">multi_addr_msw</span><span class="p">);</span>
			<span class="n">multi_addr_lsw</span> <span class="o">=</span> <span class="p">((</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span>
					  <span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span> <span class="o">|</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">));</span>
			<span class="n">temac_indirect_out32</span><span class="p">(</span><span class="n">lp</span><span class="p">,</span> <span class="n">XTE_MAW1_OFFSET</span><span class="p">,</span>
					     <span class="n">multi_addr_lsw</span><span class="p">);</span>
			<span class="n">i</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">temac_indirect_in32</span><span class="p">(</span><span class="n">lp</span><span class="p">,</span> <span class="n">XTE_AFM_OFFSET</span><span class="p">);</span>
		<span class="n">temac_indirect_out32</span><span class="p">(</span><span class="n">lp</span><span class="p">,</span> <span class="n">XTE_AFM_OFFSET</span><span class="p">,</span>
				     <span class="n">val</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">XTE_AFM_EPPRM_MASK</span><span class="p">);</span>
		<span class="n">temac_indirect_out32</span><span class="p">(</span><span class="n">lp</span><span class="p">,</span> <span class="n">XTE_MAW0_OFFSET</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">temac_indirect_out32</span><span class="p">(</span><span class="n">lp</span><span class="p">,</span> <span class="n">XTE_MAW1_OFFSET</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Promiscuous mode disabled.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">indirect_mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">temac_option</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="n">flg</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">opt</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">reg</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">m_or</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">m_and</span><span class="p">;</span>
<span class="p">}</span> <span class="n">temac_options</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/* Turn on jumbo packet support for both Rx and Tx */</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">opt</span> <span class="o">=</span> <span class="n">XTE_OPTION_JUMBO</span><span class="p">,</span>
		<span class="p">.</span><span class="n">reg</span> <span class="o">=</span> <span class="n">XTE_TXC_OFFSET</span><span class="p">,</span>
		<span class="p">.</span><span class="n">m_or</span> <span class="o">=</span> <span class="n">XTE_TXC_TXJMBO_MASK</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">opt</span> <span class="o">=</span> <span class="n">XTE_OPTION_JUMBO</span><span class="p">,</span>
		<span class="p">.</span><span class="n">reg</span> <span class="o">=</span> <span class="n">XTE_RXC1_OFFSET</span><span class="p">,</span>
		<span class="p">.</span><span class="n">m_or</span> <span class="o">=</span><span class="n">XTE_RXC1_RXJMBO_MASK</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="cm">/* Turn on VLAN packet support for both Rx and Tx */</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">opt</span> <span class="o">=</span> <span class="n">XTE_OPTION_VLAN</span><span class="p">,</span>
		<span class="p">.</span><span class="n">reg</span> <span class="o">=</span> <span class="n">XTE_TXC_OFFSET</span><span class="p">,</span>
		<span class="p">.</span><span class="n">m_or</span> <span class="o">=</span><span class="n">XTE_TXC_TXVLAN_MASK</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">opt</span> <span class="o">=</span> <span class="n">XTE_OPTION_VLAN</span><span class="p">,</span>
		<span class="p">.</span><span class="n">reg</span> <span class="o">=</span> <span class="n">XTE_RXC1_OFFSET</span><span class="p">,</span>
		<span class="p">.</span><span class="n">m_or</span> <span class="o">=</span><span class="n">XTE_RXC1_RXVLAN_MASK</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="cm">/* Turn on FCS stripping on receive packets */</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">opt</span> <span class="o">=</span> <span class="n">XTE_OPTION_FCS_STRIP</span><span class="p">,</span>
		<span class="p">.</span><span class="n">reg</span> <span class="o">=</span> <span class="n">XTE_RXC1_OFFSET</span><span class="p">,</span>
		<span class="p">.</span><span class="n">m_or</span> <span class="o">=</span><span class="n">XTE_RXC1_RXFCS_MASK</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="cm">/* Turn on FCS insertion on transmit packets */</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">opt</span> <span class="o">=</span> <span class="n">XTE_OPTION_FCS_INSERT</span><span class="p">,</span>
		<span class="p">.</span><span class="n">reg</span> <span class="o">=</span> <span class="n">XTE_TXC_OFFSET</span><span class="p">,</span>
		<span class="p">.</span><span class="n">m_or</span> <span class="o">=</span><span class="n">XTE_TXC_TXFCS_MASK</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="cm">/* Turn on length/type field checking on receive packets */</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">opt</span> <span class="o">=</span> <span class="n">XTE_OPTION_LENTYPE_ERR</span><span class="p">,</span>
		<span class="p">.</span><span class="n">reg</span> <span class="o">=</span> <span class="n">XTE_RXC1_OFFSET</span><span class="p">,</span>
		<span class="p">.</span><span class="n">m_or</span> <span class="o">=</span><span class="n">XTE_RXC1_RXLT_MASK</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="cm">/* Turn on flow control */</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">opt</span> <span class="o">=</span> <span class="n">XTE_OPTION_FLOW_CONTROL</span><span class="p">,</span>
		<span class="p">.</span><span class="n">reg</span> <span class="o">=</span> <span class="n">XTE_FCC_OFFSET</span><span class="p">,</span>
		<span class="p">.</span><span class="n">m_or</span> <span class="o">=</span><span class="n">XTE_FCC_RXFLO_MASK</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="cm">/* Turn on flow control */</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">opt</span> <span class="o">=</span> <span class="n">XTE_OPTION_FLOW_CONTROL</span><span class="p">,</span>
		<span class="p">.</span><span class="n">reg</span> <span class="o">=</span> <span class="n">XTE_FCC_OFFSET</span><span class="p">,</span>
		<span class="p">.</span><span class="n">m_or</span> <span class="o">=</span><span class="n">XTE_FCC_TXFLO_MASK</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="cm">/* Turn on promiscuous frame filtering (all frames are received ) */</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">opt</span> <span class="o">=</span> <span class="n">XTE_OPTION_PROMISC</span><span class="p">,</span>
		<span class="p">.</span><span class="n">reg</span> <span class="o">=</span> <span class="n">XTE_AFM_OFFSET</span><span class="p">,</span>
		<span class="p">.</span><span class="n">m_or</span> <span class="o">=</span><span class="n">XTE_AFM_EPPRM_MASK</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="cm">/* Enable transmitter if not already enabled */</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">opt</span> <span class="o">=</span> <span class="n">XTE_OPTION_TXEN</span><span class="p">,</span>
		<span class="p">.</span><span class="n">reg</span> <span class="o">=</span> <span class="n">XTE_TXC_OFFSET</span><span class="p">,</span>
		<span class="p">.</span><span class="n">m_or</span> <span class="o">=</span><span class="n">XTE_TXC_TXEN_MASK</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="cm">/* Enable receiver? */</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">opt</span> <span class="o">=</span> <span class="n">XTE_OPTION_RXEN</span><span class="p">,</span>
		<span class="p">.</span><span class="n">reg</span> <span class="o">=</span> <span class="n">XTE_RXC1_OFFSET</span><span class="p">,</span>
		<span class="p">.</span><span class="n">m_or</span> <span class="o">=</span><span class="n">XTE_RXC1_RXEN_MASK</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{}</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * temac_setoptions</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">u32</span> <span class="nf">temac_setoptions</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">options</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">temac_local</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">temac_option</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">temac_options</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">reg</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">indirect_mutex</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">opt</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="n">temac_indirect_in32</span><span class="p">(</span><span class="n">lp</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">m_or</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">opt</span><span class="p">)</span>
			<span class="n">reg</span> <span class="o">|=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">m_or</span><span class="p">;</span>
		<span class="n">temac_indirect_out32</span><span class="p">(</span><span class="n">lp</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
		<span class="n">tp</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">|=</span> <span class="n">options</span><span class="p">;</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">indirect_mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Initialize temac */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">temac_device_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">temac_local</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">timeout</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>

	<span class="cm">/* Perform a software reset */</span>

	<span class="cm">/* 0x300 host enable bit ? */</span>
	<span class="cm">/* reset PHY through control register ?:1 */</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">indirect_mutex</span><span class="p">);</span>
	<span class="cm">/* Reset the receiver and wait for it to finish reset */</span>
	<span class="n">temac_indirect_out32</span><span class="p">(</span><span class="n">lp</span><span class="p">,</span> <span class="n">XTE_RXC1_OFFSET</span><span class="p">,</span> <span class="n">XTE_RXC1_RXRST_MASK</span><span class="p">);</span>
	<span class="n">timeout</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">temac_indirect_in32</span><span class="p">(</span><span class="n">lp</span><span class="p">,</span> <span class="n">XTE_RXC1_OFFSET</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">XTE_RXC1_RXRST_MASK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">--</span><span class="n">timeout</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;temac_device_reset RX reset timeout!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Reset the transmitter and wait for it to finish reset */</span>
	<span class="n">temac_indirect_out32</span><span class="p">(</span><span class="n">lp</span><span class="p">,</span> <span class="n">XTE_TXC_OFFSET</span><span class="p">,</span> <span class="n">XTE_TXC_TXRST_MASK</span><span class="p">);</span>
	<span class="n">timeout</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">temac_indirect_in32</span><span class="p">(</span><span class="n">lp</span><span class="p">,</span> <span class="n">XTE_TXC_OFFSET</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">XTE_TXC_TXRST_MASK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">--</span><span class="n">timeout</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;temac_device_reset TX reset timeout!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Disable the receiver */</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">temac_indirect_in32</span><span class="p">(</span><span class="n">lp</span><span class="p">,</span> <span class="n">XTE_RXC1_OFFSET</span><span class="p">);</span>
	<span class="n">temac_indirect_out32</span><span class="p">(</span><span class="n">lp</span><span class="p">,</span> <span class="n">XTE_RXC1_OFFSET</span><span class="p">,</span> <span class="n">val</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">XTE_RXC1_RXEN_MASK</span><span class="p">);</span>

	<span class="cm">/* Reset Local Link (DMA) */</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">dma_out</span><span class="p">(</span><span class="n">lp</span><span class="p">,</span> <span class="n">DMA_CONTROL_REG</span><span class="p">,</span> <span class="n">DMA_CONTROL_RST</span><span class="p">);</span>
	<span class="n">timeout</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">dma_in</span><span class="p">(</span><span class="n">lp</span><span class="p">,</span> <span class="n">DMA_CONTROL_REG</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">DMA_CONTROL_RST</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">--</span><span class="n">timeout</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;temac_device_reset DMA reset timeout!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">dma_out</span><span class="p">(</span><span class="n">lp</span><span class="p">,</span> <span class="n">DMA_CONTROL_REG</span><span class="p">,</span> <span class="n">DMA_TAIL_ENABLE</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">temac_dma_bd_init</span><span class="p">(</span><span class="n">ndev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;temac_device_reset descriptor allocation failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">temac_indirect_out32</span><span class="p">(</span><span class="n">lp</span><span class="p">,</span> <span class="n">XTE_RXC0_OFFSET</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">temac_indirect_out32</span><span class="p">(</span><span class="n">lp</span><span class="p">,</span> <span class="n">XTE_RXC1_OFFSET</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">temac_indirect_out32</span><span class="p">(</span><span class="n">lp</span><span class="p">,</span> <span class="n">XTE_TXC_OFFSET</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">temac_indirect_out32</span><span class="p">(</span><span class="n">lp</span><span class="p">,</span> <span class="n">XTE_FCC_OFFSET</span><span class="p">,</span> <span class="n">XTE_FCC_RXFLO_MASK</span><span class="p">);</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">indirect_mutex</span><span class="p">);</span>

	<span class="cm">/* Sync default options with HW</span>
<span class="cm">	 * but leave receiver and transmitter disabled.  */</span>
	<span class="n">temac_setoptions</span><span class="p">(</span><span class="n">ndev</span><span class="p">,</span>
			 <span class="n">lp</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">XTE_OPTION_TXEN</span> <span class="o">|</span> <span class="n">XTE_OPTION_RXEN</span><span class="p">));</span>

	<span class="n">temac_set_mac_address</span><span class="p">(</span><span class="n">ndev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="cm">/* Set address filter table */</span>
	<span class="n">temac_set_multicast_list</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">temac_setoptions</span><span class="p">(</span><span class="n">ndev</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">))</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Error setting TEMAC options</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* Init Driver variable */</span>
	<span class="n">ndev</span><span class="o">-&gt;</span><span class="n">trans_start</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span> <span class="cm">/* prevent tx timeout */</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">temac_adjust_link</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">temac_local</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">phy_device</span> <span class="o">*</span><span class="n">phy</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">phy_dev</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">mii_speed</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">link_state</span><span class="p">;</span>

	<span class="cm">/* hash together the state values to decide if something has changed */</span>
	<span class="n">link_state</span> <span class="o">=</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">speed</span> <span class="o">|</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">duplex</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">indirect_mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">last_link</span> <span class="o">!=</span> <span class="n">link_state</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mii_speed</span> <span class="o">=</span> <span class="n">temac_indirect_in32</span><span class="p">(</span><span class="n">lp</span><span class="p">,</span> <span class="n">XTE_EMCFG_OFFSET</span><span class="p">);</span>
		<span class="n">mii_speed</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">XTE_EMCFG_LINKSPD_MASK</span><span class="p">;</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">speed</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">SPEED_1000</span>: <span class="n">mii_speed</span> <span class="o">|=</span> <span class="n">XTE_EMCFG_LINKSPD_1000</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">SPEED_100</span>: <span class="n">mii_speed</span> <span class="o">|=</span> <span class="n">XTE_EMCFG_LINKSPD_100</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">SPEED_10</span>: <span class="n">mii_speed</span> <span class="o">|=</span> <span class="n">XTE_EMCFG_LINKSPD_10</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Write new speed setting out to TEMAC */</span>
		<span class="n">temac_indirect_out32</span><span class="p">(</span><span class="n">lp</span><span class="p">,</span> <span class="n">XTE_EMCFG_OFFSET</span><span class="p">,</span> <span class="n">mii_speed</span><span class="p">);</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">last_link</span> <span class="o">=</span> <span class="n">link_state</span><span class="p">;</span>
		<span class="n">phy_print_status</span><span class="p">(</span><span class="n">phy</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">indirect_mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">temac_start_xmit_done</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">temac_local</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">cdmac_bd</span> <span class="o">*</span><span class="n">cur_p</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">stat</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">cur_p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_bd_v</span><span class="p">[</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_bd_ci</span><span class="p">];</span>
	<span class="n">stat</span> <span class="o">=</span> <span class="n">cur_p</span><span class="o">-&gt;</span><span class="n">app0</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="n">STS_CTRL_APP0_CMPLT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dma_unmap_single</span><span class="p">(</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span><span class="p">,</span> <span class="n">cur_p</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">,</span> <span class="n">cur_p</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span>
				 <span class="n">DMA_TO_DEVICE</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cur_p</span><span class="o">-&gt;</span><span class="n">app4</span><span class="p">)</span>
			<span class="n">dev_kfree_skb_irq</span><span class="p">((</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="p">)</span><span class="n">cur_p</span><span class="o">-&gt;</span><span class="n">app4</span><span class="p">);</span>
		<span class="n">cur_p</span><span class="o">-&gt;</span><span class="n">app0</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">cur_p</span><span class="o">-&gt;</span><span class="n">app1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">cur_p</span><span class="o">-&gt;</span><span class="n">app2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">cur_p</span><span class="o">-&gt;</span><span class="n">app3</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">cur_p</span><span class="o">-&gt;</span><span class="n">app4</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">ndev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_packets</span><span class="o">++</span><span class="p">;</span>
		<span class="n">ndev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_bytes</span> <span class="o">+=</span> <span class="n">cur_p</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>

		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_bd_ci</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_bd_ci</span> <span class="o">&gt;=</span> <span class="n">TX_BD_NUM</span><span class="p">)</span>
			<span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_bd_ci</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">cur_p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_bd_v</span><span class="p">[</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_bd_ci</span><span class="p">];</span>
		<span class="n">stat</span> <span class="o">=</span> <span class="n">cur_p</span><span class="o">-&gt;</span><span class="n">app0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">temac_check_tx_bd_space</span><span class="p">(</span><span class="k">struct</span> <span class="n">temac_local</span> <span class="o">*</span><span class="n">lp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">num_frag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cdmac_bd</span> <span class="o">*</span><span class="n">cur_p</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">tail</span><span class="p">;</span>

	<span class="n">tail</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_bd_tail</span><span class="p">;</span>
	<span class="n">cur_p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_bd_v</span><span class="p">[</span><span class="n">tail</span><span class="p">];</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cur_p</span><span class="o">-&gt;</span><span class="n">app0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">NETDEV_TX_BUSY</span><span class="p">;</span>

		<span class="n">tail</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tail</span> <span class="o">&gt;=</span> <span class="n">TX_BD_NUM</span><span class="p">)</span>
			<span class="n">tail</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">cur_p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_bd_v</span><span class="p">[</span><span class="n">tail</span><span class="p">];</span>
		<span class="n">num_frag</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">num_frag</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">temac_start_xmit</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">temac_local</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">cdmac_bd</span> <span class="o">*</span><span class="n">cur_p</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">start_p</span><span class="p">,</span> <span class="n">tail_p</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ii</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">num_frag</span><span class="p">;</span>
	<span class="n">skb_frag_t</span> <span class="o">*</span><span class="n">frag</span><span class="p">;</span>

	<span class="n">num_frag</span> <span class="o">=</span> <span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">nr_frags</span><span class="p">;</span>
	<span class="n">frag</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">frags</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">start_p</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_bd_p</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_bd_v</span><span class="p">)</span> <span class="o">*</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_bd_tail</span><span class="p">;</span>
	<span class="n">cur_p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_bd_v</span><span class="p">[</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_bd_tail</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">temac_check_tx_bd_space</span><span class="p">(</span><span class="n">lp</span><span class="p">,</span> <span class="n">num_frag</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">netif_queue_stopped</span><span class="p">(</span><span class="n">ndev</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">NETDEV_TX_BUSY</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="n">NETDEV_TX_BUSY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cur_p</span><span class="o">-&gt;</span><span class="n">app0</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">ip_summed</span> <span class="o">==</span> <span class="n">CHECKSUM_PARTIAL</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">csum_start_off</span> <span class="o">=</span> <span class="n">skb_checksum_start_offset</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">csum_index_off</span> <span class="o">=</span> <span class="n">csum_start_off</span> <span class="o">+</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">csum_offset</span><span class="p">;</span>

		<span class="n">cur_p</span><span class="o">-&gt;</span><span class="n">app0</span> <span class="o">|=</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* TX Checksum Enabled */</span>
		<span class="n">cur_p</span><span class="o">-&gt;</span><span class="n">app1</span> <span class="o">=</span> <span class="p">(</span><span class="n">csum_start_off</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="n">csum_index_off</span><span class="p">;</span>
		<span class="n">cur_p</span><span class="o">-&gt;</span><span class="n">app2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>  <span class="cm">/* initial checksum seed */</span>
	<span class="p">}</span>

	<span class="n">cur_p</span><span class="o">-&gt;</span><span class="n">app0</span> <span class="o">|=</span> <span class="n">STS_CTRL_APP0_SOP</span><span class="p">;</span>
	<span class="n">cur_p</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">skb_headlen</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">cur_p</span><span class="o">-&gt;</span><span class="n">phys</span> <span class="o">=</span> <span class="n">dma_map_single</span><span class="p">(</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span>
				     <span class="n">DMA_TO_DEVICE</span><span class="p">);</span>
	<span class="n">cur_p</span><span class="o">-&gt;</span><span class="n">app4</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">skb</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">ii</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ii</span> <span class="o">&lt;</span> <span class="n">num_frag</span><span class="p">;</span> <span class="n">ii</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_bd_tail</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_bd_tail</span> <span class="o">&gt;=</span> <span class="n">TX_BD_NUM</span><span class="p">)</span>
			<span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_bd_tail</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">cur_p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_bd_v</span><span class="p">[</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_bd_tail</span><span class="p">];</span>
		<span class="n">cur_p</span><span class="o">-&gt;</span><span class="n">phys</span> <span class="o">=</span> <span class="n">dma_map_single</span><span class="p">(</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span><span class="p">,</span>
					     <span class="n">skb_frag_address</span><span class="p">(</span><span class="n">frag</span><span class="p">),</span>
					     <span class="n">skb_frag_size</span><span class="p">(</span><span class="n">frag</span><span class="p">),</span> <span class="n">DMA_TO_DEVICE</span><span class="p">);</span>
		<span class="n">cur_p</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">skb_frag_size</span><span class="p">(</span><span class="n">frag</span><span class="p">);</span>
		<span class="n">cur_p</span><span class="o">-&gt;</span><span class="n">app0</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">frag</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">cur_p</span><span class="o">-&gt;</span><span class="n">app0</span> <span class="o">|=</span> <span class="n">STS_CTRL_APP0_EOP</span><span class="p">;</span>

	<span class="n">tail_p</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_bd_p</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_bd_v</span><span class="p">)</span> <span class="o">*</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_bd_tail</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_bd_tail</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_bd_tail</span> <span class="o">&gt;=</span> <span class="n">TX_BD_NUM</span><span class="p">)</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_bd_tail</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">skb_tx_timestamp</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

	<span class="cm">/* Kick off the transfer */</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">dma_out</span><span class="p">(</span><span class="n">lp</span><span class="p">,</span> <span class="n">TX_TAILDESC_PTR</span><span class="p">,</span> <span class="n">tail_p</span><span class="p">);</span> <span class="cm">/* DMA start */</span>

	<span class="k">return</span> <span class="n">NETDEV_TX_OK</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">ll_temac_recv</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">temac_local</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="o">*</span><span class="n">new_skb</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bdstat</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cdmac_bd</span> <span class="o">*</span><span class="n">cur_p</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">tail_p</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">length</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">tail_p</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_bd_p</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_bd_v</span><span class="p">)</span> <span class="o">*</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_bd_ci</span><span class="p">;</span>
	<span class="n">cur_p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_bd_v</span><span class="p">[</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_bd_ci</span><span class="p">];</span>

	<span class="n">bdstat</span> <span class="o">=</span> <span class="n">cur_p</span><span class="o">-&gt;</span><span class="n">app0</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">bdstat</span> <span class="o">&amp;</span> <span class="n">STS_CTRL_APP0_CMPLT</span><span class="p">))</span> <span class="p">{</span>

		<span class="n">skb</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_skb</span><span class="p">[</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_bd_ci</span><span class="p">];</span>
		<span class="n">length</span> <span class="o">=</span> <span class="n">cur_p</span><span class="o">-&gt;</span><span class="n">app4</span> <span class="o">&amp;</span> <span class="mh">0x3FFF</span><span class="p">;</span>

		<span class="n">dma_unmap_single</span><span class="p">(</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span><span class="p">,</span> <span class="n">cur_p</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span>
				 <span class="n">DMA_FROM_DEVICE</span><span class="p">);</span>

		<span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">length</span><span class="p">);</span>
		<span class="n">skb</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">ndev</span><span class="p">;</span>
		<span class="n">skb</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">eth_type_trans</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">ndev</span><span class="p">);</span>
		<span class="n">skb_checksum_none_assert</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

		<span class="cm">/* if we&#39;re doing rx csum offload, set it up */</span>
		<span class="k">if</span> <span class="p">(((</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">temac_features</span> <span class="o">&amp;</span> <span class="n">TEMAC_FEATURE_RX_CSUM</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			<span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">==</span> <span class="n">__constant_htons</span><span class="p">(</span><span class="n">ETH_P_IP</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
			<span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&gt;</span> <span class="mi">64</span><span class="p">))</span> <span class="p">{</span>

			<span class="n">skb</span><span class="o">-&gt;</span><span class="n">csum</span> <span class="o">=</span> <span class="n">cur_p</span><span class="o">-&gt;</span><span class="n">app3</span> <span class="o">&amp;</span> <span class="mh">0xFFFF</span><span class="p">;</span>
			<span class="n">skb</span><span class="o">-&gt;</span><span class="n">ip_summed</span> <span class="o">=</span> <span class="n">CHECKSUM_COMPLETE</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb_defer_rx_timestamp</span><span class="p">(</span><span class="n">skb</span><span class="p">))</span>
			<span class="n">netif_rx</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

		<span class="n">ndev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_packets</span><span class="o">++</span><span class="p">;</span>
		<span class="n">ndev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_bytes</span> <span class="o">+=</span> <span class="n">length</span><span class="p">;</span>

		<span class="n">new_skb</span> <span class="o">=</span> <span class="n">netdev_alloc_skb_ip_align</span><span class="p">(</span><span class="n">ndev</span><span class="p">,</span>
						<span class="n">XTE_MAX_JUMBO_FRAME_SIZE</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">new_skb</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;no memory for new sk_buff</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">cur_p</span><span class="o">-&gt;</span><span class="n">app0</span> <span class="o">=</span> <span class="n">STS_CTRL_APP0_IRQONEND</span><span class="p">;</span>
		<span class="n">cur_p</span><span class="o">-&gt;</span><span class="n">phys</span> <span class="o">=</span> <span class="n">dma_map_single</span><span class="p">(</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span><span class="p">,</span> <span class="n">new_skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span>
					     <span class="n">XTE_MAX_JUMBO_FRAME_SIZE</span><span class="p">,</span>
					     <span class="n">DMA_FROM_DEVICE</span><span class="p">);</span>
		<span class="n">cur_p</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">XTE_MAX_JUMBO_FRAME_SIZE</span><span class="p">;</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_skb</span><span class="p">[</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_bd_ci</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_skb</span><span class="p">;</span>

		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_bd_ci</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_bd_ci</span> <span class="o">&gt;=</span> <span class="n">RX_BD_NUM</span><span class="p">)</span>
			<span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_bd_ci</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">cur_p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_bd_v</span><span class="p">[</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_bd_ci</span><span class="p">];</span>
		<span class="n">bdstat</span> <span class="o">=</span> <span class="n">cur_p</span><span class="o">-&gt;</span><span class="n">app0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">dma_out</span><span class="p">(</span><span class="n">lp</span><span class="p">,</span> <span class="n">RX_TAILDESC_PTR</span><span class="p">,</span> <span class="n">tail_p</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">ll_temac_tx_irq</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">_ndev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span> <span class="o">=</span> <span class="n">_ndev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">temac_local</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">dma_in</span><span class="p">(</span><span class="n">lp</span><span class="p">,</span> <span class="n">TX_IRQ_REG</span><span class="p">);</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">dma_out</span><span class="p">(</span><span class="n">lp</span><span class="p">,</span> <span class="n">TX_IRQ_REG</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">IRQ_COAL</span> <span class="o">|</span> <span class="n">IRQ_DLY</span><span class="p">))</span>
		<span class="n">temac_start_xmit_done</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="mh">0x080</span><span class="p">)</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;DMA error 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">ll_temac_rx_irq</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">_ndev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span> <span class="o">=</span> <span class="n">_ndev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">temac_local</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="cm">/* Read and clear the status registers */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">dma_in</span><span class="p">(</span><span class="n">lp</span><span class="p">,</span> <span class="n">RX_IRQ_REG</span><span class="p">);</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">dma_out</span><span class="p">(</span><span class="n">lp</span><span class="p">,</span> <span class="n">RX_IRQ_REG</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">IRQ_COAL</span> <span class="o">|</span> <span class="n">IRQ_DLY</span><span class="p">))</span>
		<span class="n">ll_temac_recv</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">temac_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">temac_local</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;temac_open()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">phy_node</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">phy_dev</span> <span class="o">=</span> <span class="n">of_phy_connect</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">phy_node</span><span class="p">,</span>
					     <span class="n">temac_adjust_link</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">phy_dev</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;of_phy_connect() failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">phy_start</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">phy_dev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">temac_device_reset</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_irq</span><span class="p">,</span> <span class="n">ll_temac_tx_irq</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ndev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ndev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_tx_irq</span><span class="p">;</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_irq</span><span class="p">,</span> <span class="n">ll_temac_rx_irq</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ndev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ndev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_rx_irq</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

 <span class="nl">err_rx_irq:</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_irq</span><span class="p">,</span> <span class="n">ndev</span><span class="p">);</span>
 <span class="nl">err_tx_irq:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">phy_dev</span><span class="p">)</span>
		<span class="n">phy_disconnect</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">phy_dev</span><span class="p">);</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">phy_dev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">dev_err</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;request_irq() failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">temac_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">temac_local</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;temac_close()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">free_irq</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_irq</span><span class="p">,</span> <span class="n">ndev</span><span class="p">);</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_irq</span><span class="p">,</span> <span class="n">ndev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">phy_dev</span><span class="p">)</span>
		<span class="n">phy_disconnect</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">phy_dev</span><span class="p">);</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">phy_dev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">temac_dma_bd_release</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_NET_POLL_CONTROLLER</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">temac_poll_controller</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">temac_local</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>

	<span class="n">disable_irq</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_irq</span><span class="p">);</span>
	<span class="n">disable_irq</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_irq</span><span class="p">);</span>

	<span class="n">ll_temac_rx_irq</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_irq</span><span class="p">,</span> <span class="n">ndev</span><span class="p">);</span>
	<span class="n">ll_temac_tx_irq</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_irq</span><span class="p">,</span> <span class="n">ndev</span><span class="p">);</span>

	<span class="n">enable_irq</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_irq</span><span class="p">);</span>
	<span class="n">enable_irq</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_irq</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">temac_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ifreq</span> <span class="o">*</span><span class="n">rq</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">temac_local</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">netif_running</span><span class="p">(</span><span class="n">ndev</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">phy_dev</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">phy_mii_ioctl</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">phy_dev</span><span class="p">,</span> <span class="n">rq</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">net_device_ops</span> <span class="n">temac_netdev_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">ndo_open</span> <span class="o">=</span> <span class="n">temac_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_stop</span> <span class="o">=</span> <span class="n">temac_stop</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_start_xmit</span> <span class="o">=</span> <span class="n">temac_start_xmit</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_set_mac_address</span> <span class="o">=</span> <span class="n">netdev_set_mac_address</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_validate_addr</span> <span class="o">=</span> <span class="n">eth_validate_addr</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_do_ioctl</span> <span class="o">=</span> <span class="n">temac_ioctl</span><span class="p">,</span>
<span class="cp">#ifdef CONFIG_NET_POLL_CONTROLLER</span>
	<span class="p">.</span><span class="n">ndo_poll_controller</span> <span class="o">=</span> <span class="n">temac_poll_controller</span><span class="p">,</span>
<span class="cp">#endif</span>
<span class="p">};</span>

<span class="cm">/* ---------------------------------------------------------------------</span>
<span class="cm"> * SYSFS device attributes</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">temac_show_llink_regs</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">temac_local</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mh">0x11</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">len</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="s">&quot;%.8x%s&quot;</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">dma_in</span><span class="p">(</span><span class="n">lp</span><span class="p">,</span> <span class="n">i</span><span class="p">),</span>
			       <span class="p">(</span><span class="n">i</span> <span class="o">%</span> <span class="mi">8</span><span class="p">)</span> <span class="o">==</span> <span class="mi">7</span> <span class="o">?</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">:</span> <span class="s">&quot; &quot;</span><span class="p">);</span>
	<span class="n">len</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">llink_regs</span><span class="p">,</span> <span class="mo">0440</span><span class="p">,</span> <span class="n">temac_show_llink_regs</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">attribute</span> <span class="o">*</span><span class="n">temac_device_attrs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="o">&amp;</span><span class="n">dev_attr_llink_regs</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="nb">NULL</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">attribute_group</span> <span class="n">temac_attr_group</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="n">temac_device_attrs</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* ethtool support */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">temac_get_settings</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ethtool_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">temac_local</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">phy_ethtool_gset</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">phy_dev</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">temac_set_settings</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ethtool_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">temac_local</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">phy_ethtool_sset</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">phy_dev</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">temac_nway_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">temac_local</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">phy_start_aneg</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">phy_dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ethtool_ops</span> <span class="n">temac_ethtool_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">get_settings</span> <span class="o">=</span> <span class="n">temac_get_settings</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_settings</span> <span class="o">=</span> <span class="n">temac_set_settings</span><span class="p">,</span>
	<span class="p">.</span><span class="n">nway_reset</span> <span class="o">=</span> <span class="n">temac_nway_reset</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_link</span> <span class="o">=</span> <span class="n">ethtool_op_get_link</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_ts_info</span> <span class="o">=</span> <span class="n">ethtool_op_get_ts_info</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">temac_of_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">op</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">np</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">temac_local</span> <span class="o">*</span><span class="n">lp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">addr</span><span class="p">;</span>
	<span class="n">__be32</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">size</span><span class="p">,</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Init network device structure */</span>
	<span class="n">ndev</span> <span class="o">=</span> <span class="n">alloc_etherdev</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">lp</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ndev</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">ether_setup</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
	<span class="n">dev_set_drvdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">ndev</span><span class="p">);</span>
	<span class="n">SET_NETDEV_DEV</span><span class="p">(</span><span class="n">ndev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">ndev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">IFF_MULTICAST</span><span class="p">;</span>  <span class="cm">/* clear multicast */</span>
	<span class="n">ndev</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">=</span> <span class="n">NETIF_F_SG</span> <span class="o">|</span> <span class="n">NETIF_F_FRAGLIST</span><span class="p">;</span>
	<span class="n">ndev</span><span class="o">-&gt;</span><span class="n">netdev_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">temac_netdev_ops</span><span class="p">;</span>
	<span class="n">ndev</span><span class="o">-&gt;</span><span class="n">ethtool_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">temac_ethtool_ops</span><span class="p">;</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">	ndev-&gt;features |= NETIF_F_IP_CSUM; /* Can checksum TCP/UDP over IPv4. */</span>
<span class="c">	ndev-&gt;features |= NETIF_F_HW_CSUM; /* Can checksum all the packets. */</span>
<span class="c">	ndev-&gt;features |= NETIF_F_IPV6_CSUM; /* Can checksum IPV6 TCP/UDP */</span>
<span class="c">	ndev-&gt;features |= NETIF_F_HIGHDMA; /* Can DMA to high memory. */</span>
<span class="c">	ndev-&gt;features |= NETIF_F_HW_VLAN_TX; /* Transmit VLAN hw accel */</span>
<span class="c">	ndev-&gt;features |= NETIF_F_HW_VLAN_RX; /* Receive VLAN hw acceleration */</span>
<span class="c">	ndev-&gt;features |= NETIF_F_HW_VLAN_FILTER; /* Receive VLAN filtering */</span>
<span class="c">	ndev-&gt;features |= NETIF_F_VLAN_CHALLENGED; /* cannot handle VLAN pkts */</span>
<span class="c">	ndev-&gt;features |= NETIF_F_GSO; /* Enable software GSO. */</span>
<span class="c">	ndev-&gt;features |= NETIF_F_MULTI_QUEUE; /* Has multiple TX/RX queues */</span>
<span class="c">	ndev-&gt;features |= NETIF_F_LRO; /* large receive offload */</span>
<span class="cp">#endif</span>

	<span class="cm">/* setup temac private info structure */</span>
	<span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">ndev</span> <span class="o">=</span> <span class="n">ndev</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">=</span> <span class="n">XTE_OPTION_DEFAULTS</span><span class="p">;</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_lock</span><span class="p">);</span>
	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">indirect_mutex</span><span class="p">);</span>

	<span class="cm">/* map device registers */</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">=</span> <span class="n">of_iomap</span><span class="p">(</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">of_node</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;could not map temac regs.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">nodev</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Setup checksum offload, but default to off if not specified */</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">temac_features</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="n">__be32</span> <span class="o">*</span><span class="p">)</span><span class="n">of_get_property</span><span class="p">(</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">of_node</span><span class="p">,</span> <span class="s">&quot;xlnx,txcsum&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">p</span> <span class="o">&amp;&amp;</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">temac_features</span> <span class="o">|=</span> <span class="n">TEMAC_FEATURE_TX_CSUM</span><span class="p">;</span>
		<span class="cm">/* Can checksum TCP/UDP over IPv4. */</span>
		<span class="n">ndev</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">|=</span> <span class="n">NETIF_F_IP_CSUM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="n">__be32</span> <span class="o">*</span><span class="p">)</span><span class="n">of_get_property</span><span class="p">(</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">of_node</span><span class="p">,</span> <span class="s">&quot;xlnx,rxcsum&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">p</span> <span class="o">&amp;&amp;</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">))</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">temac_features</span> <span class="o">|=</span> <span class="n">TEMAC_FEATURE_RX_CSUM</span><span class="p">;</span>

	<span class="cm">/* Find the DMA node, map the DMA registers, and decode the DMA IRQs */</span>
	<span class="n">np</span> <span class="o">=</span> <span class="n">of_parse_phandle</span><span class="p">(</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">of_node</span><span class="p">,</span> <span class="s">&quot;llink-connected&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">np</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;could not find DMA node</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_iounmap</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Setup the DMA register accesses, could be DCR or memory mapped */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">temac_dcr_setup</span><span class="p">(</span><span class="n">lp</span><span class="p">,</span> <span class="n">op</span><span class="p">,</span> <span class="n">np</span><span class="p">))</span> <span class="p">{</span>

		<span class="cm">/* no DCR in the device tree, try non-DCR */</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">sdma_regs</span> <span class="o">=</span> <span class="n">of_iomap</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">sdma_regs</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">lp</span><span class="o">-&gt;</span><span class="n">dma_in</span> <span class="o">=</span> <span class="n">temac_dma_in32</span><span class="p">;</span>
			<span class="n">lp</span><span class="o">-&gt;</span><span class="n">dma_out</span> <span class="o">=</span> <span class="n">temac_dma_out32</span><span class="p">;</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;MEM base: %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">sdma_regs</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;unable to map DMA registers</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">of_node_put</span><span class="p">(</span><span class="n">np</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">err_iounmap</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_irq</span> <span class="o">=</span> <span class="n">irq_of_parse_and_map</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_irq</span> <span class="o">=</span> <span class="n">irq_of_parse_and_map</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">of_node_put</span><span class="p">(</span><span class="n">np</span><span class="p">);</span> <span class="cm">/* Finished with the DMA node; drop the reference */</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_irq</span> <span class="o">||</span> <span class="o">!</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_irq</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;could not determine irqs</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_iounmap_2</span><span class="p">;</span>
	<span class="p">}</span>


	<span class="cm">/* Retrieve the MAC address */</span>
	<span class="n">addr</span> <span class="o">=</span> <span class="n">of_get_property</span><span class="p">(</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">of_node</span><span class="p">,</span> <span class="s">&quot;local-mac-address&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">size</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="n">addr</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">size</span> <span class="o">!=</span> <span class="mi">6</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;could not find MAC address</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_iounmap_2</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">temac_set_mac_address</span><span class="p">(</span><span class="n">ndev</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">addr</span><span class="p">);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">temac_mdio_setup</span><span class="p">(</span><span class="n">lp</span><span class="p">,</span> <span class="n">op</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">of_node</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;error registering MDIO bus</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">phy_node</span> <span class="o">=</span> <span class="n">of_parse_phandle</span><span class="p">(</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">of_node</span><span class="p">,</span> <span class="s">&quot;phy-handle&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">phy_node</span><span class="p">)</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;using PHY node %s (%p)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">full_name</span><span class="p">,</span> <span class="n">np</span><span class="p">);</span>

	<span class="cm">/* Add the device attributes */</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">sysfs_create_group</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">kobj</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">temac_attr_group</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Error creating sysfs files</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_iounmap_2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">register_netdev</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;register_netdev() error (%i)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_register_ndev</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

 <span class="nl">err_register_ndev:</span>
	<span class="n">sysfs_remove_group</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">kobj</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">temac_attr_group</span><span class="p">);</span>
 <span class="nl">err_iounmap_2:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">sdma_regs</span><span class="p">)</span>
		<span class="n">iounmap</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">sdma_regs</span><span class="p">);</span>
 <span class="nl">err_iounmap:</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">);</span>
 <span class="nl">nodev:</span>
	<span class="n">free_netdev</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
	<span class="n">ndev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devexit</span> <span class="nf">temac_of_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">op</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">temac_local</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>

	<span class="n">temac_mdio_teardown</span><span class="p">(</span><span class="n">lp</span><span class="p">);</span>
	<span class="n">unregister_netdev</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
	<span class="n">sysfs_remove_group</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">kobj</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">temac_attr_group</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">phy_node</span><span class="p">)</span>
		<span class="n">of_node_put</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">phy_node</span><span class="p">);</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">phy_node</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">dev_set_drvdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">sdma_regs</span><span class="p">)</span>
		<span class="n">iounmap</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">sdma_regs</span><span class="p">);</span>
	<span class="n">free_netdev</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">of_device_id</span> <span class="n">temac_of_match</span><span class="p">[]</span> <span class="n">__devinitdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">compatible</span> <span class="o">=</span> <span class="s">&quot;xlnx,xps-ll-temac-1.01.b&quot;</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">compatible</span> <span class="o">=</span> <span class="s">&quot;xlnx,xps-ll-temac-2.00.a&quot;</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">compatible</span> <span class="o">=</span> <span class="s">&quot;xlnx,xps-ll-temac-2.02.a&quot;</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">compatible</span> <span class="o">=</span> <span class="s">&quot;xlnx,xps-ll-temac-2.03.a&quot;</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{},</span>
<span class="p">};</span>
<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">of</span><span class="p">,</span> <span class="n">temac_of_match</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_driver</span> <span class="n">temac_of_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">probe</span> <span class="o">=</span> <span class="n">temac_of_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span> <span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">temac_of_remove</span><span class="p">),</span>
	<span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;xilinx_temac&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">of_match_table</span> <span class="o">=</span> <span class="n">temac_of_match</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="n">module_platform_driver</span><span class="p">(</span><span class="n">temac_of_driver</span><span class="p">);</span>

<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Xilinx LL_TEMAC Ethernet driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Yoshio Kashiwagi&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
