<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › ethernet › adi › bfin_mac.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>bfin_mac.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Blackfin On-Chip MAC Driver</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright 2004-2010 Analog Devices Inc.</span>
<span class="cm"> *</span>
<span class="cm"> * Enter bugs at http://blackfin.uclinux.org/</span>
<span class="cm"> *</span>
<span class="cm"> * Licensed under the GPL-2 or later.</span>
<span class="cm"> */</span>

<span class="cp">#define DRV_VERSION	&quot;1.1&quot;</span>
<span class="cp">#define DRV_DESC	&quot;Blackfin on-chip Ethernet MAC driver&quot;</span>

<span class="cp">#define pr_fmt(fmt) KBUILD_MODNAME &quot;: &quot; fmt</span>

<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/timer.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/irq.h&gt;</span>
<span class="cp">#include &lt;linux/io.h&gt;</span>
<span class="cp">#include &lt;linux/ioport.h&gt;</span>
<span class="cp">#include &lt;linux/crc32.h&gt;</span>
<span class="cp">#include &lt;linux/device.h&gt;</span>
<span class="cp">#include &lt;linux/spinlock.h&gt;</span>
<span class="cp">#include &lt;linux/mii.h&gt;</span>
<span class="cp">#include &lt;linux/netdevice.h&gt;</span>
<span class="cp">#include &lt;linux/etherdevice.h&gt;</span>
<span class="cp">#include &lt;linux/ethtool.h&gt;</span>
<span class="cp">#include &lt;linux/skbuff.h&gt;</span>
<span class="cp">#include &lt;linux/platform_device.h&gt;</span>

<span class="cp">#include &lt;asm/dma.h&gt;</span>
<span class="cp">#include &lt;linux/dma-mapping.h&gt;</span>

<span class="cp">#include &lt;asm/div64.h&gt;</span>
<span class="cp">#include &lt;asm/dpmc.h&gt;</span>
<span class="cp">#include &lt;asm/blackfin.h&gt;</span>
<span class="cp">#include &lt;asm/cacheflush.h&gt;</span>
<span class="cp">#include &lt;asm/portmux.h&gt;</span>
<span class="cp">#include &lt;mach/pll.h&gt;</span>

<span class="cp">#include &quot;bfin_mac.h&quot;</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Bryan Wu, Luke Yang&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="n">DRV_DESC</span><span class="p">);</span>
<span class="n">MODULE_ALIAS</span><span class="p">(</span><span class="s">&quot;platform:bfin_mac&quot;</span><span class="p">);</span>

<span class="cp">#if defined(CONFIG_BFIN_MAC_USE_L1)</span>
<span class="cp"># define bfin_mac_alloc(dma_handle, size, num)  l1_data_sram_zalloc(size*num)</span>
<span class="cp"># define bfin_mac_free(dma_handle, ptr, num)    l1_data_sram_free(ptr)</span>
<span class="cp">#else</span>
<span class="cp"># define bfin_mac_alloc(dma_handle, size, num) \</span>
<span class="cp">	dma_alloc_coherent(NULL, size*num, dma_handle, GFP_KERNEL)</span>
<span class="cp"># define bfin_mac_free(dma_handle, ptr, num) \</span>
<span class="cp">	dma_free_coherent(NULL, sizeof(*ptr)*num, ptr, dma_handle)</span>
<span class="cp">#endif</span>

<span class="cp">#define PKT_BUF_SZ 1580</span>

<span class="cp">#define MAX_TIMEOUT_CNT	500</span>

<span class="cm">/* pointers to maintain transmit list */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">net_dma_desc_tx</span> <span class="o">*</span><span class="n">tx_list_head</span><span class="p">;</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">net_dma_desc_tx</span> <span class="o">*</span><span class="n">tx_list_tail</span><span class="p">;</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">net_dma_desc_rx</span> <span class="o">*</span><span class="n">rx_list_head</span><span class="p">;</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">net_dma_desc_rx</span> <span class="o">*</span><span class="n">rx_list_tail</span><span class="p">;</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">net_dma_desc_rx</span> <span class="o">*</span><span class="n">current_rx_ptr</span><span class="p">;</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">net_dma_desc_tx</span> <span class="o">*</span><span class="n">current_tx_ptr</span><span class="p">;</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">net_dma_desc_tx</span> <span class="o">*</span><span class="n">tx_desc</span><span class="p">;</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">net_dma_desc_rx</span> <span class="o">*</span><span class="n">rx_desc</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">desc_list_free</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_dma_desc_rx</span> <span class="o">*</span><span class="n">r</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_dma_desc_tx</span> <span class="o">*</span><span class="n">t</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
<span class="cp">#if !defined(CONFIG_BFIN_MAC_USE_L1)</span>
	<span class="n">dma_addr_t</span> <span class="n">dma_handle</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tx_desc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">t</span> <span class="o">=</span> <span class="n">tx_list_head</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">CONFIG_BFIN_TX_DESC_NUM</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">);</span>
					<span class="n">t</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">t</span> <span class="o">=</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">bfin_mac_free</span><span class="p">(</span><span class="n">dma_handle</span><span class="p">,</span> <span class="n">tx_desc</span><span class="p">,</span> <span class="n">CONFIG_BFIN_TX_DESC_NUM</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rx_desc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">rx_list_head</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">CONFIG_BFIN_RX_DESC_NUM</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">);</span>
					<span class="n">r</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">r</span> <span class="o">=</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">bfin_mac_free</span><span class="p">(</span><span class="n">dma_handle</span><span class="p">,</span> <span class="n">rx_desc</span><span class="p">,</span> <span class="n">CONFIG_BFIN_RX_DESC_NUM</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">desc_list_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">new_skb</span><span class="p">;</span>
<span class="cp">#if !defined(CONFIG_BFIN_MAC_USE_L1)</span>
	<span class="cm">/*</span>
<span class="cm">	 * This dma_handle is useless in Blackfin dma_alloc_coherent().</span>
<span class="cm">	 * The real dma handler is the return value of dma_alloc_coherent().</span>
<span class="cm">	 */</span>
	<span class="n">dma_addr_t</span> <span class="n">dma_handle</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="n">tx_desc</span> <span class="o">=</span> <span class="n">bfin_mac_alloc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dma_handle</span><span class="p">,</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_dma_desc_tx</span><span class="p">),</span>
				<span class="n">CONFIG_BFIN_TX_DESC_NUM</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tx_desc</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">init_error</span><span class="p">;</span>

	<span class="n">rx_desc</span> <span class="o">=</span> <span class="n">bfin_mac_alloc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dma_handle</span><span class="p">,</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_dma_desc_rx</span><span class="p">),</span>
				<span class="n">CONFIG_BFIN_RX_DESC_NUM</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rx_desc</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">init_error</span><span class="p">;</span>

	<span class="cm">/* init tx_list */</span>
	<span class="n">tx_list_head</span> <span class="o">=</span> <span class="n">tx_list_tail</span> <span class="o">=</span> <span class="n">tx_desc</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">CONFIG_BFIN_TX_DESC_NUM</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">net_dma_desc_tx</span> <span class="o">*</span><span class="n">t</span> <span class="o">=</span> <span class="n">tx_desc</span> <span class="o">+</span> <span class="n">i</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">dma_descriptor</span> <span class="o">*</span><span class="n">a</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">desc_a</span><span class="p">);</span>
		<span class="k">struct</span> <span class="n">dma_descriptor</span> <span class="o">*</span><span class="n">b</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">desc_b</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * disable DMA</span>
<span class="cm">		 * read from memory WNR = 0</span>
<span class="cm">		 * wordsize is 32 bits</span>
<span class="cm">		 * 6 half words is desc size</span>
<span class="cm">		 * large desc flow</span>
<span class="cm">		 */</span>
		<span class="n">a</span><span class="o">-&gt;</span><span class="n">config</span> <span class="o">=</span> <span class="n">WDSIZE_32</span> <span class="o">|</span> <span class="n">NDSIZE_6</span> <span class="o">|</span> <span class="n">DMAFLOW_LARGE</span><span class="p">;</span>
		<span class="n">a</span><span class="o">-&gt;</span><span class="n">start_addr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">packet</span><span class="p">;</span>
		<span class="n">a</span><span class="o">-&gt;</span><span class="n">x_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">a</span><span class="o">-&gt;</span><span class="n">next_dma_desc</span> <span class="o">=</span> <span class="n">b</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * enabled DMA</span>
<span class="cm">		 * write to memory WNR = 1</span>
<span class="cm">		 * wordsize is 32 bits</span>
<span class="cm">		 * disable interrupt</span>
<span class="cm">		 * 6 half words is desc size</span>
<span class="cm">		 * large desc flow</span>
<span class="cm">		 */</span>
		<span class="n">b</span><span class="o">-&gt;</span><span class="n">config</span> <span class="o">=</span> <span class="n">DMAEN</span> <span class="o">|</span> <span class="n">WNR</span> <span class="o">|</span> <span class="n">WDSIZE_32</span> <span class="o">|</span> <span class="n">NDSIZE_6</span> <span class="o">|</span> <span class="n">DMAFLOW_LARGE</span><span class="p">;</span>
		<span class="n">b</span><span class="o">-&gt;</span><span class="n">start_addr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">));</span>
		<span class="n">b</span><span class="o">-&gt;</span><span class="n">x_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">t</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">tx_list_tail</span><span class="o">-&gt;</span><span class="n">desc_b</span><span class="p">.</span><span class="n">next_dma_desc</span> <span class="o">=</span> <span class="n">a</span><span class="p">;</span>
		<span class="n">tx_list_tail</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">t</span><span class="p">;</span>
		<span class="n">tx_list_tail</span> <span class="o">=</span> <span class="n">t</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">tx_list_tail</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">tx_list_head</span><span class="p">;</span>	<span class="cm">/* tx_list is a circle */</span>
	<span class="n">tx_list_tail</span><span class="o">-&gt;</span><span class="n">desc_b</span><span class="p">.</span><span class="n">next_dma_desc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">tx_list_head</span><span class="o">-&gt;</span><span class="n">desc_a</span><span class="p">);</span>
	<span class="n">current_tx_ptr</span> <span class="o">=</span> <span class="n">tx_list_head</span><span class="p">;</span>

	<span class="cm">/* init rx_list */</span>
	<span class="n">rx_list_head</span> <span class="o">=</span> <span class="n">rx_list_tail</span> <span class="o">=</span> <span class="n">rx_desc</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">CONFIG_BFIN_RX_DESC_NUM</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">net_dma_desc_rx</span> <span class="o">*</span><span class="n">r</span> <span class="o">=</span> <span class="n">rx_desc</span> <span class="o">+</span> <span class="n">i</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">dma_descriptor</span> <span class="o">*</span><span class="n">a</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">desc_a</span><span class="p">);</span>
		<span class="k">struct</span> <span class="n">dma_descriptor</span> <span class="o">*</span><span class="n">b</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">desc_b</span><span class="p">);</span>

		<span class="cm">/* allocate a new skb for next time receive */</span>
		<span class="n">new_skb</span> <span class="o">=</span> <span class="n">netdev_alloc_skb</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PKT_BUF_SZ</span> <span class="o">+</span> <span class="n">NET_IP_ALIGN</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">new_skb</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_notice</span><span class="p">(</span><span class="s">&quot;init: low on mem - packet dropped</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">init_error</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">skb_reserve</span><span class="p">(</span><span class="n">new_skb</span><span class="p">,</span> <span class="n">NET_IP_ALIGN</span><span class="p">);</span>
		<span class="cm">/* Invidate the data cache of skb-&gt;data range when it is write back</span>
<span class="cm">		 * cache. It will prevent overwritting the new data from DMA</span>
<span class="cm">		 */</span>
		<span class="n">blackfin_dcache_invalidate_range</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">new_skb</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">,</span>
					 <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">new_skb</span><span class="o">-&gt;</span><span class="n">end</span><span class="p">);</span>
		<span class="n">r</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">=</span> <span class="n">new_skb</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * enabled DMA</span>
<span class="cm">		 * write to memory WNR = 1</span>
<span class="cm">		 * wordsize is 32 bits</span>
<span class="cm">		 * disable interrupt</span>
<span class="cm">		 * 6 half words is desc size</span>
<span class="cm">		 * large desc flow</span>
<span class="cm">		 */</span>
		<span class="n">a</span><span class="o">-&gt;</span><span class="n">config</span> <span class="o">=</span> <span class="n">DMAEN</span> <span class="o">|</span> <span class="n">WNR</span> <span class="o">|</span> <span class="n">WDSIZE_32</span> <span class="o">|</span> <span class="n">NDSIZE_6</span> <span class="o">|</span> <span class="n">DMAFLOW_LARGE</span><span class="p">;</span>
		<span class="cm">/* since RXDWA is enabled */</span>
		<span class="n">a</span><span class="o">-&gt;</span><span class="n">start_addr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">new_skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">-</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">a</span><span class="o">-&gt;</span><span class="n">x_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">a</span><span class="o">-&gt;</span><span class="n">next_dma_desc</span> <span class="o">=</span> <span class="n">b</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * enabled DMA</span>
<span class="cm">		 * write to memory WNR = 1</span>
<span class="cm">		 * wordsize is 32 bits</span>
<span class="cm">		 * enable interrupt</span>
<span class="cm">		 * 6 half words is desc size</span>
<span class="cm">		 * large desc flow</span>
<span class="cm">		 */</span>
		<span class="n">b</span><span class="o">-&gt;</span><span class="n">config</span> <span class="o">=</span> <span class="n">DMAEN</span> <span class="o">|</span> <span class="n">WNR</span> <span class="o">|</span> <span class="n">WDSIZE_32</span> <span class="o">|</span> <span class="n">DI_EN</span> <span class="o">|</span>
				<span class="n">NDSIZE_6</span> <span class="o">|</span> <span class="n">DMAFLOW_LARGE</span><span class="p">;</span>
		<span class="n">b</span><span class="o">-&gt;</span><span class="n">start_addr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">));</span>
		<span class="n">b</span><span class="o">-&gt;</span><span class="n">x_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">rx_list_tail</span><span class="o">-&gt;</span><span class="n">desc_b</span><span class="p">.</span><span class="n">next_dma_desc</span> <span class="o">=</span> <span class="n">a</span><span class="p">;</span>
		<span class="n">rx_list_tail</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">r</span><span class="p">;</span>
		<span class="n">rx_list_tail</span> <span class="o">=</span> <span class="n">r</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">rx_list_tail</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">rx_list_head</span><span class="p">;</span>	<span class="cm">/* rx_list is a circle */</span>
	<span class="n">rx_list_tail</span><span class="o">-&gt;</span><span class="n">desc_b</span><span class="p">.</span><span class="n">next_dma_desc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">rx_list_head</span><span class="o">-&gt;</span><span class="n">desc_a</span><span class="p">);</span>
	<span class="n">current_rx_ptr</span> <span class="o">=</span> <span class="n">rx_list_head</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">init_error:</span>
	<span class="n">desc_list_free</span><span class="p">();</span>
	<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;kmalloc failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*---PHY CONTROL AND CONFIGURATION-----------------------------------------*/</span>

<span class="cm">/*</span>
<span class="cm"> * MII operations</span>
<span class="cm"> */</span>
<span class="cm">/* Wait until the previous MDC/MDIO transaction has completed */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">bfin_mdio_poll</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">timeout_cnt</span> <span class="o">=</span> <span class="n">MAX_TIMEOUT_CNT</span><span class="p">;</span>

	<span class="cm">/* poll the STABUSY bit */</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">bfin_read_EMAC_STAADD</span><span class="p">())</span> <span class="o">&amp;</span> <span class="n">STABUSY</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">timeout_cnt</span><span class="o">--</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;wait MDC/MDIO transaction to complete timeout</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Read an off-chip register in a PHY through the MDC/MDIO port */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">bfin_mdiobus_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">mii_bus</span> <span class="o">*</span><span class="n">bus</span><span class="p">,</span> <span class="kt">int</span> <span class="n">phy_addr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">regnum</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">bfin_mdio_poll</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* read mode */</span>
	<span class="n">bfin_write_EMAC_STAADD</span><span class="p">(</span><span class="n">SET_PHYAD</span><span class="p">((</span><span class="n">u16</span><span class="p">)</span> <span class="n">phy_addr</span><span class="p">)</span> <span class="o">|</span>
				<span class="n">SET_REGAD</span><span class="p">((</span><span class="n">u16</span><span class="p">)</span> <span class="n">regnum</span><span class="p">)</span> <span class="o">|</span>
				<span class="n">STABUSY</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">bfin_mdio_poll</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">return</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">bfin_read_EMAC_STADAT</span><span class="p">();</span>
<span class="p">}</span>

<span class="cm">/* Write an off-chip register in a PHY through the MDC/MDIO port */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">bfin_mdiobus_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">mii_bus</span> <span class="o">*</span><span class="n">bus</span><span class="p">,</span> <span class="kt">int</span> <span class="n">phy_addr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">regnum</span><span class="p">,</span>
			      <span class="n">u16</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">bfin_mdio_poll</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">bfin_write_EMAC_STADAT</span><span class="p">((</span><span class="n">u32</span><span class="p">)</span> <span class="n">value</span><span class="p">);</span>

	<span class="cm">/* write mode */</span>
	<span class="n">bfin_write_EMAC_STAADD</span><span class="p">(</span><span class="n">SET_PHYAD</span><span class="p">((</span><span class="n">u16</span><span class="p">)</span> <span class="n">phy_addr</span><span class="p">)</span> <span class="o">|</span>
				<span class="n">SET_REGAD</span><span class="p">((</span><span class="n">u16</span><span class="p">)</span> <span class="n">regnum</span><span class="p">)</span> <span class="o">|</span>
				<span class="n">STAOP</span> <span class="o">|</span>
				<span class="n">STABUSY</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">bfin_mdio_poll</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bfin_mdiobus_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">mii_bus</span> <span class="o">*</span><span class="n">bus</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bfin_mac_adjust_link</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfin_mac_local</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">phy_device</span> <span class="o">*</span><span class="n">phydev</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">phydev</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">new_state</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phydev</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Now we make sure that we can be in full duplex mode.</span>
<span class="cm">		 * If not, we operate in half-duplex mode. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">phydev</span><span class="o">-&gt;</span><span class="n">duplex</span> <span class="o">!=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">old_duplex</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u32</span> <span class="n">opmode</span> <span class="o">=</span> <span class="n">bfin_read_EMAC_OPMODE</span><span class="p">();</span>
			<span class="n">new_state</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">phydev</span><span class="o">-&gt;</span><span class="n">duplex</span><span class="p">)</span>
				<span class="n">opmode</span> <span class="o">|=</span> <span class="n">FDMODE</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">opmode</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">FDMODE</span><span class="p">);</span>

			<span class="n">bfin_write_EMAC_OPMODE</span><span class="p">(</span><span class="n">opmode</span><span class="p">);</span>
			<span class="n">lp</span><span class="o">-&gt;</span><span class="n">old_duplex</span> <span class="o">=</span> <span class="n">phydev</span><span class="o">-&gt;</span><span class="n">duplex</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">phydev</span><span class="o">-&gt;</span><span class="n">speed</span> <span class="o">!=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">old_speed</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">phydev</span><span class="o">-&gt;</span><span class="n">interface</span> <span class="o">==</span> <span class="n">PHY_INTERFACE_MODE_RMII</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">u32</span> <span class="n">opmode</span> <span class="o">=</span> <span class="n">bfin_read_EMAC_OPMODE</span><span class="p">();</span>
				<span class="k">switch</span> <span class="p">(</span><span class="n">phydev</span><span class="o">-&gt;</span><span class="n">speed</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">case</span> <span class="mi">10</span>:
					<span class="n">opmode</span> <span class="o">|=</span> <span class="n">RMII_10</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="mi">100</span>:
					<span class="n">opmode</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">RMII_10</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="nl">default:</span>
					<span class="n">netdev_warn</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
						<span class="s">&quot;Ack! Speed (%d) is not 10/100!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">phydev</span><span class="o">-&gt;</span><span class="n">speed</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">bfin_write_EMAC_OPMODE</span><span class="p">(</span><span class="n">opmode</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="n">new_state</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">lp</span><span class="o">-&gt;</span><span class="n">old_speed</span> <span class="o">=</span> <span class="n">phydev</span><span class="o">-&gt;</span><span class="n">speed</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">old_link</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">new_state</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">lp</span><span class="o">-&gt;</span><span class="n">old_link</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">old_link</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">new_state</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">old_link</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">old_speed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">old_duplex</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">new_state</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">opmode</span> <span class="o">=</span> <span class="n">bfin_read_EMAC_OPMODE</span><span class="p">();</span>
		<span class="n">phy_print_status</span><span class="p">(</span><span class="n">phydev</span><span class="p">);</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;EMAC_OPMODE = 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">opmode</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* MDC  = 2.5 MHz */</span>
<span class="cp">#define MDC_CLK 2500000</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mii_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">phy_mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfin_mac_local</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">phy_device</span> <span class="o">*</span><span class="n">phydev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">sysctl</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">sclk</span><span class="p">,</span> <span class="n">mdc_div</span><span class="p">;</span>

	<span class="cm">/* Enable PHY output early */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">bfin_read_VR_CTL</span><span class="p">()</span> <span class="o">&amp;</span> <span class="n">CLKBUFOE</span><span class="p">))</span>
		<span class="n">bfin_write_VR_CTL</span><span class="p">(</span><span class="n">bfin_read_VR_CTL</span><span class="p">()</span> <span class="o">|</span> <span class="n">CLKBUFOE</span><span class="p">);</span>

	<span class="n">sclk</span> <span class="o">=</span> <span class="n">get_sclk</span><span class="p">();</span>
	<span class="n">mdc_div</span> <span class="o">=</span> <span class="p">((</span><span class="n">sclk</span> <span class="o">/</span> <span class="n">MDC_CLK</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">sysctl</span> <span class="o">=</span> <span class="n">bfin_read_EMAC_SYSCTL</span><span class="p">();</span>
	<span class="n">sysctl</span> <span class="o">=</span> <span class="p">(</span><span class="n">sysctl</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">MDCDIV</span><span class="p">)</span> <span class="o">|</span> <span class="n">SET_MDCDIV</span><span class="p">(</span><span class="n">mdc_div</span><span class="p">);</span>
	<span class="n">bfin_write_EMAC_SYSCTL</span><span class="p">(</span><span class="n">sysctl</span><span class="p">);</span>

	<span class="cm">/* search for connected PHY device */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">PHY_MAX_ADDR</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">phy_device</span> <span class="o">*</span><span class="k">const</span> <span class="n">tmp_phydev</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">mii_bus</span><span class="o">-&gt;</span><span class="n">phy_map</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tmp_phydev</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span> <span class="cm">/* no PHY here... */</span>

		<span class="n">phydev</span> <span class="o">=</span> <span class="n">tmp_phydev</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span> <span class="cm">/* found it */</span>
	<span class="p">}</span>

	<span class="cm">/* now we are supposed to have a proper phydev, to attach to... */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">phydev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netdev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;no phy device found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">phy_mode</span> <span class="o">!=</span> <span class="n">PHY_INTERFACE_MODE_RMII</span> <span class="o">&amp;&amp;</span>
		<span class="n">phy_mode</span> <span class="o">!=</span> <span class="n">PHY_INTERFACE_MODE_MII</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netdev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;invalid phy interface mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">phydev</span> <span class="o">=</span> <span class="n">phy_connect</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">dev_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phydev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">bfin_mac_adjust_link</span><span class="p">,</span>
			<span class="mi">0</span><span class="p">,</span> <span class="n">phy_mode</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">phydev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">netdev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;could not attach PHY</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">phydev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* mask with MAC supported features */</span>
	<span class="n">phydev</span><span class="o">-&gt;</span><span class="n">supported</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="n">SUPPORTED_10baseT_Half</span>
			      <span class="o">|</span> <span class="n">SUPPORTED_10baseT_Full</span>
			      <span class="o">|</span> <span class="n">SUPPORTED_100baseT_Half</span>
			      <span class="o">|</span> <span class="n">SUPPORTED_100baseT_Full</span>
			      <span class="o">|</span> <span class="n">SUPPORTED_Autoneg</span>
			      <span class="o">|</span> <span class="n">SUPPORTED_Pause</span> <span class="o">|</span> <span class="n">SUPPORTED_Asym_Pause</span>
			      <span class="o">|</span> <span class="n">SUPPORTED_MII</span>
			      <span class="o">|</span> <span class="n">SUPPORTED_TP</span><span class="p">);</span>

	<span class="n">phydev</span><span class="o">-&gt;</span><span class="n">advertising</span> <span class="o">=</span> <span class="n">phydev</span><span class="o">-&gt;</span><span class="n">supported</span><span class="p">;</span>

	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">old_link</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">old_speed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">old_duplex</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">phydev</span> <span class="o">=</span> <span class="n">phydev</span><span class="p">;</span>

	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;attached PHY driver [%s] &quot;</span>
	        <span class="s">&quot;(mii_bus:phy_addr=%s, irq=%d, mdc_clk=%dHz(mdc_div=%d)@sclk=%dMHz)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	        <span class="n">phydev</span><span class="o">-&gt;</span><span class="n">drv</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">dev_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phydev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">),</span> <span class="n">phydev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span>
	        <span class="n">MDC_CLK</span><span class="p">,</span> <span class="n">mdc_div</span><span class="p">,</span> <span class="n">sclk</span><span class="o">/</span><span class="mi">1000000</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Ethtool support</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * interrupt routine for magic packet wakeup</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">bfin_mac_wake_interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">bfin_mac_ethtool_getsettings</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ethtool_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfin_mac_local</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">phydev</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">phy_ethtool_gset</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">phydev</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">bfin_mac_ethtool_setsettings</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ethtool_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfin_mac_local</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_NET_ADMIN</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">phydev</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">phy_ethtool_sset</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">phydev</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bfin_mac_ethtool_getdrvinfo</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">ethtool_drvinfo</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">,</span> <span class="n">KBUILD_MODNAME</span><span class="p">);</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">,</span> <span class="n">DRV_VERSION</span><span class="p">);</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">fw_version</span><span class="p">,</span> <span class="s">&quot;N/A&quot;</span><span class="p">);</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">bus_info</span><span class="p">,</span> <span class="n">dev_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bfin_mac_ethtool_getwol</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">ethtool_wolinfo</span> <span class="o">*</span><span class="n">wolinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfin_mac_local</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">wolinfo</span><span class="o">-&gt;</span><span class="n">supported</span> <span class="o">=</span> <span class="n">WAKE_MAGIC</span><span class="p">;</span>
	<span class="n">wolinfo</span><span class="o">-&gt;</span><span class="n">wolopts</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">wol</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bfin_mac_ethtool_setwol</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">ethtool_wolinfo</span> <span class="o">*</span><span class="n">wolinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfin_mac_local</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wolinfo</span><span class="o">-&gt;</span><span class="n">wolopts</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">WAKE_MAGICSECURE</span> <span class="o">|</span>
				<span class="n">WAKE_UCAST</span> <span class="o">|</span>
				<span class="n">WAKE_MCAST</span> <span class="o">|</span>
				<span class="n">WAKE_BCAST</span> <span class="o">|</span>
				<span class="n">WAKE_ARP</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>

	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">wol</span> <span class="o">=</span> <span class="n">wolinfo</span><span class="o">-&gt;</span><span class="n">wolopts</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">wol</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">irq_wake_requested</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* register wake irq handler */</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">IRQ_MAC_WAKEDET</span><span class="p">,</span> <span class="n">bfin_mac_wake_interrupt</span><span class="p">,</span>
				 <span class="n">IRQF_DISABLED</span><span class="p">,</span> <span class="s">&quot;EMAC_WAKE&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">irq_wake_requested</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">wol</span> <span class="o">&amp;&amp;</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">irq_wake_requested</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">free_irq</span><span class="p">(</span><span class="n">IRQ_MAC_WAKEDET</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">irq_wake_requested</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Make sure the PHY driver doesn&#39;t suspend */</span>
	<span class="n">device_init_wakeup</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">wol</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bfin_mac_ethtool_get_ts_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">ethtool_ts_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">so_timestamping</span> <span class="o">=</span>
		<span class="n">SOF_TIMESTAMPING_TX_HARDWARE</span> <span class="o">|</span>
		<span class="n">SOF_TIMESTAMPING_RX_HARDWARE</span> <span class="o">|</span>
		<span class="n">SOF_TIMESTAMPING_SYS_HARDWARE</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">phc_index</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_types</span> <span class="o">=</span>
		<span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">HWTSTAMP_TX_OFF</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">HWTSTAMP_TX_ON</span><span class="p">);</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">rx_filters</span> <span class="o">=</span>
		<span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">HWTSTAMP_FILTER_NONE</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">HWTSTAMP_FILTER_PTP_V1_L4_EVENT</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">HWTSTAMP_FILTER_PTP_V2_L2_EVENT</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">HWTSTAMP_FILTER_PTP_V2_L4_EVENT</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ethtool_ops</span> <span class="n">bfin_mac_ethtool_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">get_settings</span> <span class="o">=</span> <span class="n">bfin_mac_ethtool_getsettings</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_settings</span> <span class="o">=</span> <span class="n">bfin_mac_ethtool_setsettings</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_link</span> <span class="o">=</span> <span class="n">ethtool_op_get_link</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_drvinfo</span> <span class="o">=</span> <span class="n">bfin_mac_ethtool_getdrvinfo</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_wol</span> <span class="o">=</span> <span class="n">bfin_mac_ethtool_getwol</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_wol</span> <span class="o">=</span> <span class="n">bfin_mac_ethtool_setwol</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_ts_info</span> <span class="o">=</span> <span class="n">bfin_mac_ethtool_get_ts_info</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/**************************************************************************/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">setup_system_regs</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfin_mac_local</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">sysctl</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Odd word alignment for Receive Frame DMA word</span>
<span class="cm">	 * Configure checksum support and rcve frame word alignment</span>
<span class="cm">	 */</span>
	<span class="n">sysctl</span> <span class="o">=</span> <span class="n">bfin_read_EMAC_SYSCTL</span><span class="p">();</span>
	<span class="cm">/*</span>
<span class="cm">	 * check if interrupt is requested for any PHY,</span>
<span class="cm">	 * enable PHY interrupt only if needed</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">PHY_MAX_ADDR</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">mii_bus</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="n">PHY_POLL</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">PHY_MAX_ADDR</span><span class="p">)</span>
		<span class="n">sysctl</span> <span class="o">|=</span> <span class="n">PHYIE</span><span class="p">;</span>
	<span class="n">sysctl</span> <span class="o">|=</span> <span class="n">RXDWA</span><span class="p">;</span>
<span class="cp">#if defined(BFIN_MAC_CSUM_OFFLOAD)</span>
	<span class="n">sysctl</span> <span class="o">|=</span> <span class="n">RXCKS</span><span class="p">;</span>
<span class="cp">#else</span>
	<span class="n">sysctl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">RXCKS</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="n">bfin_write_EMAC_SYSCTL</span><span class="p">(</span><span class="n">sysctl</span><span class="p">);</span>

	<span class="n">bfin_write_EMAC_MMC_CTL</span><span class="p">(</span><span class="n">RSTC</span> <span class="o">|</span> <span class="n">CROLL</span><span class="p">);</span>

	<span class="cm">/* Set vlan regs to let 1522 bytes long packets pass through */</span>
	<span class="n">bfin_write_EMAC_VLAN1</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">vlan1_mask</span><span class="p">);</span>
	<span class="n">bfin_write_EMAC_VLAN2</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">vlan2_mask</span><span class="p">);</span>

	<span class="cm">/* Initialize the TX DMA channel registers */</span>
	<span class="n">bfin_write_DMA2_X_COUNT</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="n">bfin_write_DMA2_X_MODIFY</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>
	<span class="n">bfin_write_DMA2_Y_COUNT</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="n">bfin_write_DMA2_Y_MODIFY</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* Initialize the RX DMA channel registers */</span>
	<span class="n">bfin_write_DMA1_X_COUNT</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="n">bfin_write_DMA1_X_MODIFY</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>
	<span class="n">bfin_write_DMA1_Y_COUNT</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="n">bfin_write_DMA1_Y_MODIFY</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">setup_mac_addr</span><span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="n">mac_addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">addr_low</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">__le32</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">mac_addr</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="n">u16</span> <span class="n">addr_hi</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">__le16</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">mac_addr</span><span class="p">[</span><span class="mi">4</span><span class="p">]);</span>

	<span class="cm">/* this depends on a little-endian machine */</span>
	<span class="n">bfin_write_EMAC_ADDRLO</span><span class="p">(</span><span class="n">addr_low</span><span class="p">);</span>
	<span class="n">bfin_write_EMAC_ADDRHI</span><span class="p">(</span><span class="n">addr_hi</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bfin_mac_set_mac_address</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="n">addr</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">netif_running</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">addr</span><span class="o">-&gt;</span><span class="n">sa_data</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">addr_len</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">addr_assign_type</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">NET_ADDR_RANDOM</span><span class="p">;</span>
	<span class="n">setup_mac_addr</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_BFIN_MAC_USE_HWSTAMP</span>
<span class="cp">#define bfin_mac_hwtstamp_is_none(cfg) ((cfg) == HWTSTAMP_FILTER_NONE)</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bfin_mac_hwtstamp_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">ifreq</span> <span class="o">*</span><span class="n">ifr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hwtstamp_config</span> <span class="n">config</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bfin_mac_local</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="n">u16</span> <span class="n">ptpctl</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ptpfv1</span><span class="p">,</span> <span class="n">ptpfv2</span><span class="p">,</span> <span class="n">ptpfv3</span><span class="p">,</span> <span class="n">ptpfoff</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">config</span><span class="p">,</span> <span class="n">ifr</span><span class="o">-&gt;</span><span class="n">ifr_data</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">config</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s config flag:0x%x, tx_type:0x%x, rx_filter:0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">config</span><span class="p">.</span><span class="n">flags</span><span class="p">,</span> <span class="n">config</span><span class="p">.</span><span class="n">tx_type</span><span class="p">,</span> <span class="n">config</span><span class="p">.</span><span class="n">rx_filter</span><span class="p">);</span>

	<span class="cm">/* reserved for future extensions */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">config</span><span class="p">.</span><span class="n">flags</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">config</span><span class="p">.</span><span class="n">tx_type</span> <span class="o">!=</span> <span class="n">HWTSTAMP_TX_OFF</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			<span class="p">(</span><span class="n">config</span><span class="p">.</span><span class="n">tx_type</span> <span class="o">!=</span> <span class="n">HWTSTAMP_TX_ON</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ERANGE</span><span class="p">;</span>

	<span class="n">ptpctl</span> <span class="o">=</span> <span class="n">bfin_read_EMAC_PTP_CTL</span><span class="p">();</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">config</span><span class="p">.</span><span class="n">rx_filter</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">HWTSTAMP_FILTER_NONE</span>:
		<span class="cm">/*</span>
<span class="cm">		 * Dont allow any timestamping</span>
<span class="cm">		 */</span>
		<span class="n">ptpfv3</span> <span class="o">=</span> <span class="mh">0xFFFFFFFF</span><span class="p">;</span>
		<span class="n">bfin_write_EMAC_PTP_FV3</span><span class="p">(</span><span class="n">ptpfv3</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HWTSTAMP_FILTER_PTP_V1_L4_EVENT</span>:
	<span class="k">case</span> <span class="n">HWTSTAMP_FILTER_PTP_V1_L4_SYNC</span>:
	<span class="k">case</span> <span class="n">HWTSTAMP_FILTER_PTP_V1_L4_DELAY_REQ</span>:
		<span class="cm">/*</span>
<span class="cm">		 * Clear the five comparison mask bits (bits[12:8]) in EMAC_PTP_CTL)</span>
<span class="cm">		 * to enable all the field matches.</span>
<span class="cm">		 */</span>
		<span class="n">ptpctl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x1F00</span><span class="p">;</span>
		<span class="n">bfin_write_EMAC_PTP_CTL</span><span class="p">(</span><span class="n">ptpctl</span><span class="p">);</span>
		<span class="cm">/*</span>
<span class="cm">		 * Keep the default values of the EMAC_PTP_FOFF register.</span>
<span class="cm">		 */</span>
		<span class="n">ptpfoff</span> <span class="o">=</span> <span class="mh">0x4A24170C</span><span class="p">;</span>
		<span class="n">bfin_write_EMAC_PTP_FOFF</span><span class="p">(</span><span class="n">ptpfoff</span><span class="p">);</span>
		<span class="cm">/*</span>
<span class="cm">		 * Keep the default values of the EMAC_PTP_FV1 and EMAC_PTP_FV2</span>
<span class="cm">		 * registers.</span>
<span class="cm">		 */</span>
		<span class="n">ptpfv1</span> <span class="o">=</span> <span class="mh">0x11040800</span><span class="p">;</span>
		<span class="n">bfin_write_EMAC_PTP_FV1</span><span class="p">(</span><span class="n">ptpfv1</span><span class="p">);</span>
		<span class="n">ptpfv2</span> <span class="o">=</span> <span class="mh">0x0140013F</span><span class="p">;</span>
		<span class="n">bfin_write_EMAC_PTP_FV2</span><span class="p">(</span><span class="n">ptpfv2</span><span class="p">);</span>
		<span class="cm">/*</span>
<span class="cm">		 * The default value (0xFFFC) allows the timestamping of both</span>
<span class="cm">		 * received Sync messages and Delay_Req messages.</span>
<span class="cm">		 */</span>
		<span class="n">ptpfv3</span> <span class="o">=</span> <span class="mh">0xFFFFFFFC</span><span class="p">;</span>
		<span class="n">bfin_write_EMAC_PTP_FV3</span><span class="p">(</span><span class="n">ptpfv3</span><span class="p">);</span>

		<span class="n">config</span><span class="p">.</span><span class="n">rx_filter</span> <span class="o">=</span> <span class="n">HWTSTAMP_FILTER_PTP_V1_L4_EVENT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HWTSTAMP_FILTER_PTP_V2_L4_EVENT</span>:
	<span class="k">case</span> <span class="n">HWTSTAMP_FILTER_PTP_V2_L4_SYNC</span>:
	<span class="k">case</span> <span class="n">HWTSTAMP_FILTER_PTP_V2_DELAY_REQ</span>:
		<span class="cm">/* Clear all five comparison mask bits (bits[12:8]) in the</span>
<span class="cm">		 * EMAC_PTP_CTL register to enable all the field matches.</span>
<span class="cm">		 */</span>
		<span class="n">ptpctl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x1F00</span><span class="p">;</span>
		<span class="n">bfin_write_EMAC_PTP_CTL</span><span class="p">(</span><span class="n">ptpctl</span><span class="p">);</span>
		<span class="cm">/*</span>
<span class="cm">		 * Keep the default values of the EMAC_PTP_FOFF register, except set</span>
<span class="cm">		 * the PTPCOF field to 0x2A.</span>
<span class="cm">		 */</span>
		<span class="n">ptpfoff</span> <span class="o">=</span> <span class="mh">0x2A24170C</span><span class="p">;</span>
		<span class="n">bfin_write_EMAC_PTP_FOFF</span><span class="p">(</span><span class="n">ptpfoff</span><span class="p">);</span>
		<span class="cm">/*</span>
<span class="cm">		 * Keep the default values of the EMAC_PTP_FV1 and EMAC_PTP_FV2</span>
<span class="cm">		 * registers.</span>
<span class="cm">		 */</span>
		<span class="n">ptpfv1</span> <span class="o">=</span> <span class="mh">0x11040800</span><span class="p">;</span>
		<span class="n">bfin_write_EMAC_PTP_FV1</span><span class="p">(</span><span class="n">ptpfv1</span><span class="p">);</span>
		<span class="n">ptpfv2</span> <span class="o">=</span> <span class="mh">0x0140013F</span><span class="p">;</span>
		<span class="n">bfin_write_EMAC_PTP_FV2</span><span class="p">(</span><span class="n">ptpfv2</span><span class="p">);</span>
		<span class="cm">/*</span>
<span class="cm">		 * To allow the timestamping of Pdelay_Req and Pdelay_Resp, set</span>
<span class="cm">		 * the value to 0xFFF0.</span>
<span class="cm">		 */</span>
		<span class="n">ptpfv3</span> <span class="o">=</span> <span class="mh">0xFFFFFFF0</span><span class="p">;</span>
		<span class="n">bfin_write_EMAC_PTP_FV3</span><span class="p">(</span><span class="n">ptpfv3</span><span class="p">);</span>

		<span class="n">config</span><span class="p">.</span><span class="n">rx_filter</span> <span class="o">=</span> <span class="n">HWTSTAMP_FILTER_PTP_V2_L4_EVENT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HWTSTAMP_FILTER_PTP_V2_L2_EVENT</span>:
	<span class="k">case</span> <span class="n">HWTSTAMP_FILTER_PTP_V2_L2_SYNC</span>:
	<span class="k">case</span> <span class="n">HWTSTAMP_FILTER_PTP_V2_L2_DELAY_REQ</span>:
		<span class="cm">/*</span>
<span class="cm">		 * Clear bits 8 and 12 of the EMAC_PTP_CTL register to enable only the</span>
<span class="cm">		 * EFTM and PTPCM field comparison.</span>
<span class="cm">		 */</span>
		<span class="n">ptpctl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x1100</span><span class="p">;</span>
		<span class="n">bfin_write_EMAC_PTP_CTL</span><span class="p">(</span><span class="n">ptpctl</span><span class="p">);</span>
		<span class="cm">/*</span>
<span class="cm">		 * Keep the default values of all the fields of the EMAC_PTP_FOFF</span>
<span class="cm">		 * register, except set the PTPCOF field to 0x0E.</span>
<span class="cm">		 */</span>
		<span class="n">ptpfoff</span> <span class="o">=</span> <span class="mh">0x0E24170C</span><span class="p">;</span>
		<span class="n">bfin_write_EMAC_PTP_FOFF</span><span class="p">(</span><span class="n">ptpfoff</span><span class="p">);</span>
		<span class="cm">/*</span>
<span class="cm">		 * Program bits [15:0] of the EMAC_PTP_FV1 register to 0x88F7, which</span>
<span class="cm">		 * corresponds to PTP messages on the MAC layer.</span>
<span class="cm">		 */</span>
		<span class="n">ptpfv1</span> <span class="o">=</span> <span class="mh">0x110488F7</span><span class="p">;</span>
		<span class="n">bfin_write_EMAC_PTP_FV1</span><span class="p">(</span><span class="n">ptpfv1</span><span class="p">);</span>
		<span class="n">ptpfv2</span> <span class="o">=</span> <span class="mh">0x0140013F</span><span class="p">;</span>
		<span class="n">bfin_write_EMAC_PTP_FV2</span><span class="p">(</span><span class="n">ptpfv2</span><span class="p">);</span>
		<span class="cm">/*</span>
<span class="cm">		 * To allow the timestamping of Pdelay_Req and Pdelay_Resp</span>
<span class="cm">		 * messages, set the value to 0xFFF0.</span>
<span class="cm">		 */</span>
		<span class="n">ptpfv3</span> <span class="o">=</span> <span class="mh">0xFFFFFFF0</span><span class="p">;</span>
		<span class="n">bfin_write_EMAC_PTP_FV3</span><span class="p">(</span><span class="n">ptpfv3</span><span class="p">);</span>

		<span class="n">config</span><span class="p">.</span><span class="n">rx_filter</span> <span class="o">=</span> <span class="n">HWTSTAMP_FILTER_PTP_V2_L2_EVENT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ERANGE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">config</span><span class="p">.</span><span class="n">tx_type</span> <span class="o">==</span> <span class="n">HWTSTAMP_TX_OFF</span> <span class="o">&amp;&amp;</span>
	    <span class="n">bfin_mac_hwtstamp_is_none</span><span class="p">(</span><span class="n">config</span><span class="p">.</span><span class="n">rx_filter</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ptpctl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PTP_EN</span><span class="p">;</span>
		<span class="n">bfin_write_EMAC_PTP_CTL</span><span class="p">(</span><span class="n">ptpctl</span><span class="p">);</span>

		<span class="n">SSYNC</span><span class="p">();</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ptpctl</span> <span class="o">|=</span> <span class="n">PTP_EN</span><span class="p">;</span>
		<span class="n">bfin_write_EMAC_PTP_CTL</span><span class="p">(</span><span class="n">ptpctl</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * clear any existing timestamp</span>
<span class="cm">		 */</span>
		<span class="n">bfin_read_EMAC_PTP_RXSNAPLO</span><span class="p">();</span>
		<span class="n">bfin_read_EMAC_PTP_RXSNAPHI</span><span class="p">();</span>

		<span class="n">bfin_read_EMAC_PTP_TXSNAPLO</span><span class="p">();</span>
		<span class="n">bfin_read_EMAC_PTP_TXSNAPHI</span><span class="p">();</span>

		<span class="cm">/*</span>
<span class="cm">		 * Set registers so that rollover occurs soon to test this.</span>
<span class="cm">		 */</span>
		<span class="n">bfin_write_EMAC_PTP_TIMELO</span><span class="p">(</span><span class="mh">0x00000000</span><span class="p">);</span>
		<span class="n">bfin_write_EMAC_PTP_TIMEHI</span><span class="p">(</span><span class="mh">0xFF800000</span><span class="p">);</span>

		<span class="n">SSYNC</span><span class="p">();</span>

		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">compare</span><span class="p">.</span><span class="n">last_update</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">timecounter_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">clock</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">cycles</span><span class="p">,</span>
				<span class="n">ktime_to_ns</span><span class="p">(</span><span class="n">ktime_get_real</span><span class="p">()));</span>
		<span class="n">timecompare_update</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">compare</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">stamp_cfg</span> <span class="o">=</span> <span class="n">config</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">copy_to_user</span><span class="p">(</span><span class="n">ifr</span><span class="o">-&gt;</span><span class="n">ifr_data</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">config</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">config</span><span class="p">))</span> <span class="o">?</span>
		<span class="o">-</span><span class="n">EFAULT</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bfin_dump_hwtamp</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="n">ktime_t</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="n">ktime_t</span> <span class="o">*</span><span class="n">ts</span><span class="p">,</span> <span class="k">struct</span> <span class="n">timecompare</span> <span class="o">*</span><span class="n">cmp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ktime_t</span> <span class="n">sys</span> <span class="o">=</span> <span class="n">ktime_get_real</span><span class="p">();</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s %s hardware:%d,%d transform system:%d,%d system:%d,%d, cmp:%lld, %lld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">tv</span><span class="p">.</span><span class="n">sec</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">tv</span><span class="p">.</span><span class="n">nsec</span><span class="p">,</span> <span class="n">ts</span><span class="o">-&gt;</span><span class="n">tv</span><span class="p">.</span><span class="n">sec</span><span class="p">,</span> <span class="n">ts</span><span class="o">-&gt;</span><span class="n">tv</span><span class="p">.</span><span class="n">nsec</span><span class="p">,</span> <span class="n">sys</span><span class="p">.</span><span class="n">tv</span><span class="p">.</span><span class="n">sec</span><span class="p">,</span>
			<span class="n">sys</span><span class="p">.</span><span class="n">tv</span><span class="p">.</span><span class="n">nsec</span><span class="p">,</span> <span class="n">cmp</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">,</span> <span class="n">cmp</span><span class="o">-&gt;</span><span class="n">skew</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bfin_tx_hwtstamp</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfin_mac_local</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">tx_flags</span> <span class="o">&amp;</span> <span class="n">SKBTX_HW_TSTAMP</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">timeout_cnt</span> <span class="o">=</span> <span class="n">MAX_TIMEOUT_CNT</span><span class="p">;</span>

		<span class="cm">/* When doing time stamping, keep the connection to the socket</span>
<span class="cm">		 * a while longer</span>
<span class="cm">		 */</span>
		<span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">tx_flags</span> <span class="o">|=</span> <span class="n">SKBTX_IN_PROGRESS</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * The timestamping is done at the EMAC module&#39;s MII/RMII interface</span>
<span class="cm">		 * when the module sees the Start of Frame of an event message packet. This</span>
<span class="cm">		 * interface is the closest possible place to the physical Ethernet transmission</span>
<span class="cm">		 * medium, providing the best timing accuracy.</span>
<span class="cm">		 */</span>
		<span class="k">while</span> <span class="p">((</span><span class="o">!</span><span class="p">(</span><span class="n">bfin_read_EMAC_PTP_ISTAT</span><span class="p">()</span> <span class="o">&amp;</span> <span class="n">TXTL</span><span class="p">))</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">--</span><span class="n">timeout_cnt</span><span class="p">))</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">timeout_cnt</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">netdev_err</span><span class="p">(</span><span class="n">netdev</span><span class="p">,</span> <span class="s">&quot;timestamp the TX packet failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">skb_shared_hwtstamps</span> <span class="n">shhwtstamps</span><span class="p">;</span>
			<span class="n">u64</span> <span class="n">ns</span><span class="p">;</span>
			<span class="n">u64</span> <span class="n">regval</span><span class="p">;</span>

			<span class="n">regval</span> <span class="o">=</span> <span class="n">bfin_read_EMAC_PTP_TXSNAPLO</span><span class="p">();</span>
			<span class="n">regval</span> <span class="o">|=</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">bfin_read_EMAC_PTP_TXSNAPHI</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span><span class="p">;</span>
			<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">shhwtstamps</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">shhwtstamps</span><span class="p">));</span>
			<span class="n">ns</span> <span class="o">=</span> <span class="n">timecounter_cyc2time</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">clock</span><span class="p">,</span>
					<span class="n">regval</span><span class="p">);</span>
			<span class="n">timecompare_update</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">compare</span><span class="p">,</span> <span class="n">ns</span><span class="p">);</span>
			<span class="n">shhwtstamps</span><span class="p">.</span><span class="n">hwtstamp</span> <span class="o">=</span> <span class="n">ns_to_ktime</span><span class="p">(</span><span class="n">ns</span><span class="p">);</span>
			<span class="n">shhwtstamps</span><span class="p">.</span><span class="n">syststamp</span> <span class="o">=</span>
				<span class="n">timecompare_transform</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">compare</span><span class="p">,</span> <span class="n">ns</span><span class="p">);</span>
			<span class="n">skb_tstamp_tx</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">shhwtstamps</span><span class="p">);</span>

			<span class="n">bfin_dump_hwtamp</span><span class="p">(</span><span class="s">&quot;TX&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">shhwtstamps</span><span class="p">.</span><span class="n">hwtstamp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">shhwtstamps</span><span class="p">.</span><span class="n">syststamp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">compare</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bfin_rx_hwtstamp</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfin_mac_local</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">valid</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">regval</span><span class="p">,</span> <span class="n">ns</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">skb_shared_hwtstamps</span> <span class="o">*</span><span class="n">shhwtstamps</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bfin_mac_hwtstamp_is_none</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">stamp_cfg</span><span class="p">.</span><span class="n">rx_filter</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">valid</span> <span class="o">=</span> <span class="n">bfin_read_EMAC_PTP_ISTAT</span><span class="p">()</span> <span class="o">&amp;</span> <span class="n">RXEL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">valid</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">shhwtstamps</span> <span class="o">=</span> <span class="n">skb_hwtstamps</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

	<span class="n">regval</span> <span class="o">=</span> <span class="n">bfin_read_EMAC_PTP_RXSNAPLO</span><span class="p">();</span>
	<span class="n">regval</span> <span class="o">|=</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">bfin_read_EMAC_PTP_RXSNAPHI</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span><span class="p">;</span>
	<span class="n">ns</span> <span class="o">=</span> <span class="n">timecounter_cyc2time</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">clock</span><span class="p">,</span> <span class="n">regval</span><span class="p">);</span>
	<span class="n">timecompare_update</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">compare</span><span class="p">,</span> <span class="n">ns</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">shhwtstamps</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">shhwtstamps</span><span class="p">));</span>
	<span class="n">shhwtstamps</span><span class="o">-&gt;</span><span class="n">hwtstamp</span> <span class="o">=</span> <span class="n">ns_to_ktime</span><span class="p">(</span><span class="n">ns</span><span class="p">);</span>
	<span class="n">shhwtstamps</span><span class="o">-&gt;</span><span class="n">syststamp</span> <span class="o">=</span> <span class="n">timecompare_transform</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">compare</span><span class="p">,</span> <span class="n">ns</span><span class="p">);</span>

	<span class="n">bfin_dump_hwtamp</span><span class="p">(</span><span class="s">&quot;RX&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">shhwtstamps</span><span class="o">-&gt;</span><span class="n">hwtstamp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">shhwtstamps</span><span class="o">-&gt;</span><span class="n">syststamp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">compare</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * bfin_read_clock - read raw cycle counter (to be used by time counter)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">cycle_t</span> <span class="nf">bfin_read_clock</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">cyclecounter</span> <span class="o">*</span><span class="n">tc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">stamp</span><span class="p">;</span>

	<span class="n">stamp</span> <span class="o">=</span>  <span class="n">bfin_read_EMAC_PTP_TIMELO</span><span class="p">();</span>
	<span class="n">stamp</span> <span class="o">|=</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">bfin_read_EMAC_PTP_TIMEHI</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="mi">32ULL</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">stamp</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define PTP_CLK 25000000</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bfin_mac_hwtstamp_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfin_mac_local</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="n">u64</span> <span class="n">append</span><span class="p">;</span>

	<span class="cm">/* Initialize hardware timer */</span>
	<span class="n">append</span> <span class="o">=</span> <span class="n">PTP_CLK</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1ULL</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span><span class="p">);</span>
	<span class="n">do_div</span><span class="p">(</span><span class="n">append</span><span class="p">,</span> <span class="n">get_sclk</span><span class="p">());</span>
	<span class="n">bfin_write_EMAC_PTP_ADDEND</span><span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">append</span><span class="p">);</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">cycles</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">cycles</span><span class="p">));</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">cycles</span><span class="p">.</span><span class="n">read</span> <span class="o">=</span> <span class="n">bfin_read_clock</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">cycles</span><span class="p">.</span><span class="n">mask</span> <span class="o">=</span> <span class="n">CLOCKSOURCE_MASK</span><span class="p">(</span><span class="mi">64</span><span class="p">);</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">cycles</span><span class="p">.</span><span class="n">mult</span> <span class="o">=</span> <span class="mi">1000000000</span> <span class="o">/</span> <span class="n">PTP_CLK</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">cycles</span><span class="p">.</span><span class="n">shift</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Synchronize our NIC clock against system wall clock */</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">compare</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">compare</span><span class="p">));</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">compare</span><span class="p">.</span><span class="n">source</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">clock</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">compare</span><span class="p">.</span><span class="n">target</span> <span class="o">=</span> <span class="n">ktime_get_real</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">compare</span><span class="p">.</span><span class="n">num_samples</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>

	<span class="cm">/* Initialize hwstamp config */</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">stamp_cfg</span><span class="p">.</span><span class="n">rx_filter</span> <span class="o">=</span> <span class="n">HWTSTAMP_FILTER_NONE</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">stamp_cfg</span><span class="p">.</span><span class="n">tx_type</span> <span class="o">=</span> <span class="n">HWTSTAMP_TX_OFF</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#else</span>
<span class="cp"># define bfin_mac_hwtstamp_is_none(cfg) 0</span>
<span class="cp"># define bfin_mac_hwtstamp_init(dev)</span>
<span class="cp"># define bfin_mac_hwtstamp_ioctl(dev, ifr, cmd) (-EOPNOTSUPP)</span>
<span class="cp"># define bfin_rx_hwtstamp(dev, skb)</span>
<span class="cp"># define bfin_tx_hwtstamp(dev, skb)</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">_tx_reclaim_skb</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">tx_list_head</span><span class="o">-&gt;</span><span class="n">desc_a</span><span class="p">.</span><span class="n">config</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">DMAEN</span><span class="p">;</span>
		<span class="n">tx_list_head</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">.</span><span class="n">status_word</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tx_list_head</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">tx_list_head</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">);</span>
			<span class="n">tx_list_head</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">tx_list_head</span> <span class="o">=</span> <span class="n">tx_list_head</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>

	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">tx_list_head</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">.</span><span class="n">status_word</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tx_reclaim_skb</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfin_mac_local</span> <span class="o">*</span><span class="n">lp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">timeout_cnt</span> <span class="o">=</span> <span class="n">MAX_TIMEOUT_CNT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tx_list_head</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">.</span><span class="n">status_word</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">_tx_reclaim_skb</span><span class="p">();</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">current_tx_ptr</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">==</span> <span class="n">tx_list_head</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">tx_list_head</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">.</span><span class="n">status_word</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* slow down polling to avoid too many queue stop. */</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
			<span class="cm">/* reclaim skb if DMA is not running. */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">bfin_read_DMA2_IRQ_STATUS</span><span class="p">()</span> <span class="o">&amp;</span> <span class="n">DMA_RUN</span><span class="p">))</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">timeout_cnt</span><span class="o">--</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">timeout_cnt</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">_tx_reclaim_skb</span><span class="p">();</span>
		<span class="k">else</span>
			<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">current_tx_ptr</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">!=</span> <span class="n">tx_list_head</span> <span class="o">&amp;&amp;</span>
		<span class="n">netif_queue_stopped</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">))</span>
		<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tx_list_head</span> <span class="o">!=</span> <span class="n">current_tx_ptr</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* shorten the timer interval if tx queue is stopped */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">netif_queue_stopped</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">))</span>
			<span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_reclaim_timer</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span>
				<span class="n">jiffies</span> <span class="o">+</span> <span class="p">(</span><span class="n">TX_RECLAIM_JIFFIES</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_reclaim_timer</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span>
				<span class="n">jiffies</span> <span class="o">+</span> <span class="n">TX_RECLAIM_JIFFIES</span><span class="p">;</span>

		<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_reclaim_timer</span><span class="p">,</span>
			<span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_reclaim_timer</span><span class="p">.</span><span class="n">expires</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tx_reclaim_skb_timeout</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">lp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">tx_reclaim_skb</span><span class="p">((</span><span class="k">struct</span> <span class="n">bfin_mac_local</span> <span class="o">*</span><span class="p">)</span><span class="n">lp</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bfin_mac_hard_start_xmit</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfin_mac_local</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u16</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">data_align</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3</span><span class="p">;</span>

	<span class="n">current_tx_ptr</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">data_align</span> <span class="o">==</span> <span class="mh">0x2</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* move skb-&gt;data to current_tx_ptr payload */</span>
		<span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span> <span class="o">*</span><span class="p">)(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
		<span class="cm">/*</span>
<span class="cm">		 * When transmitting an Ethernet packet, the PTP_TSYNC module requires</span>
<span class="cm">		 * a DMA_Length_Word field associated with the packet. The lower 12 bits</span>
<span class="cm">		 * of this field are the length of the packet payload in bytes and the higher</span>
<span class="cm">		 * 4 bits are the timestamping enable field.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">tx_flags</span> <span class="o">&amp;</span> <span class="n">SKBTX_HW_TSTAMP</span><span class="p">)</span>
			<span class="o">*</span><span class="n">data</span> <span class="o">|=</span> <span class="mh">0x1000</span><span class="p">;</span>

		<span class="n">current_tx_ptr</span><span class="o">-&gt;</span><span class="n">desc_a</span><span class="p">.</span><span class="n">start_addr</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">data</span><span class="p">;</span>
		<span class="cm">/* this is important! */</span>
		<span class="n">blackfin_dcache_flush_range</span><span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">data</span><span class="p">,</span>
				<span class="p">(</span><span class="n">u32</span><span class="p">)((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span> <span class="o">+</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">+</span> <span class="mi">4</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="o">*</span><span class="p">((</span><span class="n">u16</span> <span class="o">*</span><span class="p">)(</span><span class="n">current_tx_ptr</span><span class="o">-&gt;</span><span class="n">packet</span><span class="p">))</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
		<span class="cm">/* enable timestamping for the sent packet */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">tx_flags</span> <span class="o">&amp;</span> <span class="n">SKBTX_HW_TSTAMP</span><span class="p">)</span>
			<span class="o">*</span><span class="p">((</span><span class="n">u16</span> <span class="o">*</span><span class="p">)(</span><span class="n">current_tx_ptr</span><span class="o">-&gt;</span><span class="n">packet</span><span class="p">))</span> <span class="o">|=</span> <span class="mh">0x1000</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)(</span><span class="n">current_tx_ptr</span><span class="o">-&gt;</span><span class="n">packet</span> <span class="o">+</span> <span class="mi">2</span><span class="p">),</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span>
			<span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
		<span class="n">current_tx_ptr</span><span class="o">-&gt;</span><span class="n">desc_a</span><span class="p">.</span><span class="n">start_addr</span> <span class="o">=</span>
			<span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">current_tx_ptr</span><span class="o">-&gt;</span><span class="n">packet</span><span class="p">;</span>
		<span class="n">blackfin_dcache_flush_range</span><span class="p">(</span>
			<span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">current_tx_ptr</span><span class="o">-&gt;</span><span class="n">packet</span><span class="p">,</span>
			<span class="p">(</span><span class="n">u32</span><span class="p">)(</span><span class="n">current_tx_ptr</span><span class="o">-&gt;</span><span class="n">packet</span> <span class="o">+</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">+</span> <span class="mi">2</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="cm">/* make sure the internal data buffers in the core are drained</span>
<span class="cm">	 * so that the DMA descriptors are completely written when the</span>
<span class="cm">	 * DMA engine goes to fetch them below</span>
<span class="cm">	 */</span>
	<span class="n">SSYNC</span><span class="p">();</span>

	<span class="cm">/* always clear status buffer before start tx dma */</span>
	<span class="n">current_tx_ptr</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">.</span><span class="n">status_word</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* enable this packet&#39;s dma */</span>
	<span class="n">current_tx_ptr</span><span class="o">-&gt;</span><span class="n">desc_a</span><span class="p">.</span><span class="n">config</span> <span class="o">|=</span> <span class="n">DMAEN</span><span class="p">;</span>

	<span class="cm">/* tx dma is running, just return */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bfin_read_DMA2_IRQ_STATUS</span><span class="p">()</span> <span class="o">&amp;</span> <span class="n">DMA_RUN</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="cm">/* tx dma is not running */</span>
	<span class="n">bfin_write_DMA2_NEXT_DESC_PTR</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">current_tx_ptr</span><span class="o">-&gt;</span><span class="n">desc_a</span><span class="p">));</span>
	<span class="cm">/* dma enabled, read from memory, size is 6 */</span>
	<span class="n">bfin_write_DMA2_CONFIG</span><span class="p">(</span><span class="n">current_tx_ptr</span><span class="o">-&gt;</span><span class="n">desc_a</span><span class="p">.</span><span class="n">config</span><span class="p">);</span>
	<span class="cm">/* Turn on the EMAC tx */</span>
	<span class="n">bfin_write_EMAC_OPMODE</span><span class="p">(</span><span class="n">bfin_read_EMAC_OPMODE</span><span class="p">()</span> <span class="o">|</span> <span class="n">TE</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="n">bfin_tx_hwtstamp</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>

	<span class="n">current_tx_ptr</span> <span class="o">=</span> <span class="n">current_tx_ptr</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_packets</span><span class="o">++</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_bytes</span> <span class="o">+=</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>

	<span class="n">tx_reclaim_skb</span><span class="p">(</span><span class="n">lp</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">NETDEV_TX_OK</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define IP_HEADER_OFF  0</span>
<span class="cp">#define RX_ERROR_MASK (RX_LONG | RX_ALIGN | RX_CRC | RX_LEN | \</span>
<span class="cp">	RX_FRAG | RX_ADDR | RX_DMAO | RX_PHY | RX_LATE | RX_RANGE)</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bfin_mac_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="o">*</span><span class="n">new_skb</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">len</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bfin_mac_local</span> <span class="o">*</span><span class="n">lp</span> <span class="n">__maybe_unused</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="cp">#if defined(BFIN_MAC_CSUM_OFFLOAD)</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">fcs</span><span class="p">[</span><span class="n">ETH_FCS_LEN</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
<span class="cp">#endif</span>

	<span class="cm">/* check if frame status word reports an error condition</span>
<span class="cm">	 * we which case we simply drop the packet</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">current_rx_ptr</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">.</span><span class="n">status_word</span> <span class="o">&amp;</span> <span class="n">RX_ERROR_MASK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netdev_notice</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;rx: receive error - packet dropped</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_dropped</span><span class="o">++</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* allocate a new skb for next time receive */</span>
	<span class="n">skb</span> <span class="o">=</span> <span class="n">current_rx_ptr</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">;</span>

	<span class="n">new_skb</span> <span class="o">=</span> <span class="n">netdev_alloc_skb</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PKT_BUF_SZ</span> <span class="o">+</span> <span class="n">NET_IP_ALIGN</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">new_skb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netdev_notice</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;rx: low on mem - packet dropped</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_dropped</span><span class="o">++</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* reserve 2 bytes for RXDWA padding */</span>
	<span class="n">skb_reserve</span><span class="p">(</span><span class="n">new_skb</span><span class="p">,</span> <span class="n">NET_IP_ALIGN</span><span class="p">);</span>
	<span class="cm">/* Invidate the data cache of skb-&gt;data range when it is write back</span>
<span class="cm">	 * cache. It will prevent overwritting the new data from DMA</span>
<span class="cm">	 */</span>
	<span class="n">blackfin_dcache_invalidate_range</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">new_skb</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">,</span>
					 <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">new_skb</span><span class="o">-&gt;</span><span class="n">end</span><span class="p">);</span>

	<span class="n">current_rx_ptr</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">=</span> <span class="n">new_skb</span><span class="p">;</span>
	<span class="n">current_rx_ptr</span><span class="o">-&gt;</span><span class="n">desc_a</span><span class="p">.</span><span class="n">start_addr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">new_skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">-</span> <span class="mi">2</span><span class="p">;</span>

	<span class="n">len</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span><span class="p">)((</span><span class="n">current_rx_ptr</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">.</span><span class="n">status_word</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">RX_FRLEN</span><span class="p">);</span>
	<span class="cm">/* Deduce Ethernet FCS length from Ethernet payload length */</span>
	<span class="n">len</span> <span class="o">-=</span> <span class="n">ETH_FCS_LEN</span><span class="p">;</span>
	<span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>

	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">eth_type_trans</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>

	<span class="n">bfin_rx_hwtstamp</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>

<span class="cp">#if defined(BFIN_MAC_CSUM_OFFLOAD)</span>
	<span class="cm">/* Checksum offloading only works for IPv4 packets with the standard IP header</span>
<span class="cm">	 * length of 20 bytes, because the blackfin MAC checksum calculation is</span>
<span class="cm">	 * based on that assumption. We must NOT use the calculated checksum if our</span>
<span class="cm">	 * IP version or header break that assumption.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">IP_HEADER_OFF</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x45</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">skb</span><span class="o">-&gt;</span><span class="n">csum</span> <span class="o">=</span> <span class="n">current_rx_ptr</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">.</span><span class="n">ip_payload_csum</span><span class="p">;</span>
		<span class="cm">/*</span>
<span class="cm">		 * Deduce Ethernet FCS from hardware generated IP payload checksum.</span>
<span class="cm">		 * IP checksum is based on 16-bit one&#39;s complement algorithm.</span>
<span class="cm">		 * To deduce a value from checksum is equal to add its inversion.</span>
<span class="cm">		 * If the IP payload len is odd, the inversed FCS should also</span>
<span class="cm">		 * begin from odd address and leave first byte zero.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">%</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">fcs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ETH_FCS_LEN</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
				<span class="n">fcs</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">~</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">+</span> <span class="n">i</span><span class="p">];</span>
			<span class="n">skb</span><span class="o">-&gt;</span><span class="n">csum</span> <span class="o">=</span> <span class="n">csum_partial</span><span class="p">(</span><span class="n">fcs</span><span class="p">,</span> <span class="n">ETH_FCS_LEN</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">csum</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ETH_FCS_LEN</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
				<span class="n">fcs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="o">~</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">+</span> <span class="n">i</span><span class="p">];</span>
			<span class="n">skb</span><span class="o">-&gt;</span><span class="n">csum</span> <span class="o">=</span> <span class="n">csum_partial</span><span class="p">(</span><span class="n">fcs</span><span class="p">,</span> <span class="n">ETH_FCS_LEN</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">csum</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">skb</span><span class="o">-&gt;</span><span class="n">ip_summed</span> <span class="o">=</span> <span class="n">CHECKSUM_COMPLETE</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="n">netif_rx</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_packets</span><span class="o">++</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_bytes</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="n">current_rx_ptr</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">.</span><span class="n">status_word</span> <span class="o">=</span> <span class="mh">0x00000000</span><span class="p">;</span>
	<span class="n">current_rx_ptr</span> <span class="o">=</span> <span class="n">current_rx_ptr</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* interrupt routine to handle rx and error signal */</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">bfin_mac_interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev_id</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">number</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">get_one_packet:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">current_rx_ptr</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">.</span><span class="n">status_word</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* no more new packet received */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">number</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">current_rx_ptr</span><span class="o">-&gt;</span><span class="n">next</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">.</span><span class="n">status_word</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">current_rx_ptr</span> <span class="o">=</span> <span class="n">current_rx_ptr</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">real_rx</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">bfin_write_DMA1_IRQ_STATUS</span><span class="p">(</span><span class="n">bfin_read_DMA1_IRQ_STATUS</span><span class="p">()</span> <span class="o">|</span>
					   <span class="n">DMA_DONE</span> <span class="o">|</span> <span class="n">DMA_ERR</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">real_rx:</span>
	<span class="n">bfin_mac_rx</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">number</span><span class="o">++</span><span class="p">;</span>
	<span class="k">goto</span> <span class="n">get_one_packet</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_NET_POLL_CONTROLLER</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">bfin_mac_poll</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfin_mac_local</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">disable_irq</span><span class="p">(</span><span class="n">IRQ_MAC_RX</span><span class="p">);</span>
	<span class="n">bfin_mac_interrupt</span><span class="p">(</span><span class="n">IRQ_MAC_RX</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="n">tx_reclaim_skb</span><span class="p">(</span><span class="n">lp</span><span class="p">);</span>
	<span class="n">enable_irq</span><span class="p">(</span><span class="n">IRQ_MAC_RX</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif				</span><span class="cm">/* CONFIG_NET_POLL_CONTROLLER */</span><span class="cp"></span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bfin_mac_disable</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">opmode</span><span class="p">;</span>

	<span class="n">opmode</span> <span class="o">=</span> <span class="n">bfin_read_EMAC_OPMODE</span><span class="p">();</span>
	<span class="n">opmode</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="o">~</span><span class="n">RE</span><span class="p">);</span>
	<span class="n">opmode</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="o">~</span><span class="n">TE</span><span class="p">);</span>
	<span class="cm">/* Turn off the EMAC */</span>
	<span class="n">bfin_write_EMAC_OPMODE</span><span class="p">(</span><span class="n">opmode</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Enable Interrupts, Receive, and Transmit</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">bfin_mac_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">phy_device</span> <span class="o">*</span><span class="n">phydev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">opmode</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="cm">/* Set RX DMA */</span>
	<span class="n">bfin_write_DMA1_NEXT_DESC_PTR</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">rx_list_head</span><span class="o">-&gt;</span><span class="n">desc_a</span><span class="p">));</span>
	<span class="n">bfin_write_DMA1_CONFIG</span><span class="p">(</span><span class="n">rx_list_head</span><span class="o">-&gt;</span><span class="n">desc_a</span><span class="p">.</span><span class="n">config</span><span class="p">);</span>

	<span class="cm">/* Wait MII done */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">bfin_mdio_poll</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* We enable only RX here */</span>
	<span class="cm">/* ASTP   : Enable Automatic Pad Stripping</span>
<span class="cm">	   PR     : Promiscuous Mode for test</span>
<span class="cm">	   PSF    : Receive frames with total length less than 64 bytes.</span>
<span class="cm">	   FDMODE : Full Duplex Mode</span>
<span class="cm">	   LB     : Internal Loopback for test</span>
<span class="cm">	   RE     : Receiver Enable */</span>
	<span class="n">opmode</span> <span class="o">=</span> <span class="n">bfin_read_EMAC_OPMODE</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">opmode</span> <span class="o">&amp;</span> <span class="n">FDMODE</span><span class="p">)</span>
		<span class="n">opmode</span> <span class="o">|=</span> <span class="n">PSF</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">opmode</span> <span class="o">|=</span> <span class="n">DRO</span> <span class="o">|</span> <span class="n">DC</span> <span class="o">|</span> <span class="n">PSF</span><span class="p">;</span>
	<span class="n">opmode</span> <span class="o">|=</span> <span class="n">RE</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">phydev</span><span class="o">-&gt;</span><span class="n">interface</span> <span class="o">==</span> <span class="n">PHY_INTERFACE_MODE_RMII</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">opmode</span> <span class="o">|=</span> <span class="n">RMII</span><span class="p">;</span> <span class="cm">/* For Now only 100MBit are supported */</span>
<span class="cp">#if defined(CONFIG_BF537) || defined(CONFIG_BF536)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">__SILICON_REVISION__</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * This isn&#39;t publicly documented (fun times!), but in</span>
<span class="cm">			 * silicon &lt;=0.2, the RX and TX pins are clocked together.</span>
<span class="cm">			 * So in order to recv, we must enable the transmit side</span>
<span class="cm">			 * as well.  This will cause a spurious TX interrupt too,</span>
<span class="cm">			 * but we can easily consume that.</span>
<span class="cm">			 */</span>
			<span class="n">opmode</span> <span class="o">|=</span> <span class="n">TE</span><span class="p">;</span>
		<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="p">}</span>

	<span class="cm">/* Turn on the EMAC rx */</span>
	<span class="n">bfin_write_EMAC_OPMODE</span><span class="p">(</span><span class="n">opmode</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Our watchdog timed out. Called by the networking layer */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">bfin_mac_timeout</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfin_mac_local</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">bfin_mac_disable</span><span class="p">();</span>

	<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_reclaim_timer</span><span class="p">);</span>

	<span class="cm">/* reset tx queue and free skb */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">tx_list_head</span> <span class="o">!=</span> <span class="n">current_tx_ptr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tx_list_head</span><span class="o">-&gt;</span><span class="n">desc_a</span><span class="p">.</span><span class="n">config</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">DMAEN</span><span class="p">;</span>
		<span class="n">tx_list_head</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">.</span><span class="n">status_word</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tx_list_head</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">tx_list_head</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">);</span>
			<span class="n">tx_list_head</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">tx_list_head</span> <span class="o">=</span> <span class="n">tx_list_head</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">netif_queue_stopped</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">))</span>
		<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">);</span>

	<span class="n">bfin_mac_enable</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">phydev</span><span class="p">);</span>

	<span class="cm">/* We can accept TX packets again */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">trans_start</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span> <span class="cm">/* prevent tx timeout */</span>
	<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bfin_mac_multicast_hash</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">emac_hashhi</span><span class="p">,</span> <span class="n">emac_hashlo</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">netdev_hw_addr</span> <span class="o">*</span><span class="n">ha</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">crc</span><span class="p">;</span>

	<span class="n">emac_hashhi</span> <span class="o">=</span> <span class="n">emac_hashlo</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">netdev_for_each_mc_addr</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">crc</span> <span class="o">=</span> <span class="n">ether_crc</span><span class="p">(</span><span class="n">ETH_ALEN</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">);</span>
		<span class="n">crc</span> <span class="o">&gt;&gt;=</span> <span class="mi">26</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">crc</span> <span class="o">&amp;</span> <span class="mh">0x20</span><span class="p">)</span>
			<span class="n">emac_hashhi</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">crc</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">emac_hashlo</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">crc</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">bfin_write_EMAC_HASHHI</span><span class="p">(</span><span class="n">emac_hashhi</span><span class="p">);</span>
	<span class="n">bfin_write_EMAC_HASHLO</span><span class="p">(</span><span class="n">emac_hashlo</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This routine will, depending on the values passed to it,</span>
<span class="cm"> * either make it accept multicast packets, go into</span>
<span class="cm"> * promiscuous mode (for TCPDUMP and cousins) or accept</span>
<span class="cm"> * a select set of multicast packets</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">bfin_mac_set_multicast_list</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">sysctl</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_PROMISC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netdev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;set promisc mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">sysctl</span> <span class="o">=</span> <span class="n">bfin_read_EMAC_OPMODE</span><span class="p">();</span>
		<span class="n">sysctl</span> <span class="o">|=</span> <span class="n">PR</span><span class="p">;</span>
		<span class="n">bfin_write_EMAC_OPMODE</span><span class="p">(</span><span class="n">sysctl</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_ALLMULTI</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* accept all multicast */</span>
		<span class="n">sysctl</span> <span class="o">=</span> <span class="n">bfin_read_EMAC_OPMODE</span><span class="p">();</span>
		<span class="n">sysctl</span> <span class="o">|=</span> <span class="n">PAM</span><span class="p">;</span>
		<span class="n">bfin_write_EMAC_OPMODE</span><span class="p">(</span><span class="n">sysctl</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">netdev_mc_empty</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* set up multicast hash table */</span>
		<span class="n">sysctl</span> <span class="o">=</span> <span class="n">bfin_read_EMAC_OPMODE</span><span class="p">();</span>
		<span class="n">sysctl</span> <span class="o">|=</span> <span class="n">HM</span><span class="p">;</span>
		<span class="n">bfin_write_EMAC_OPMODE</span><span class="p">(</span><span class="n">sysctl</span><span class="p">);</span>
		<span class="n">bfin_mac_multicast_hash</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* clear promisc or multicast mode */</span>
		<span class="n">sysctl</span> <span class="o">=</span> <span class="n">bfin_read_EMAC_OPMODE</span><span class="p">();</span>
		<span class="n">sysctl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">RAF</span> <span class="o">|</span> <span class="n">PAM</span><span class="p">);</span>
		<span class="n">bfin_write_EMAC_OPMODE</span><span class="p">(</span><span class="n">sysctl</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bfin_mac_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ifreq</span> <span class="o">*</span><span class="n">ifr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfin_mac_local</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">netif_running</span><span class="p">(</span><span class="n">netdev</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SIOCSHWTSTAMP</span>:
		<span class="k">return</span> <span class="n">bfin_mac_hwtstamp_ioctl</span><span class="p">(</span><span class="n">netdev</span><span class="p">,</span> <span class="n">ifr</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
	<span class="nl">default:</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">phydev</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">phy_mii_ioctl</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">phydev</span><span class="p">,</span> <span class="n">ifr</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * this puts the device in an inactive state</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">bfin_mac_shutdown</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Turn off the EMAC */</span>
	<span class="n">bfin_write_EMAC_OPMODE</span><span class="p">(</span><span class="mh">0x00000000</span><span class="p">);</span>
	<span class="cm">/* Turn off the EMAC RX DMA */</span>
	<span class="n">bfin_write_DMA1_CONFIG</span><span class="p">(</span><span class="mh">0x0000</span><span class="p">);</span>
	<span class="n">bfin_write_DMA2_CONFIG</span><span class="p">(</span><span class="mh">0x0000</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Open and Initialize the interface</span>
<span class="cm"> *</span>
<span class="cm"> * Set up everything, reset the card, etc..</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">bfin_mac_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfin_mac_local</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Check that the address is valid.  If its not, refuse</span>
<span class="cm">	 * to bring the device up.  The user must specify an</span>
<span class="cm">	 * address using ifconfig eth0 hw ether xx:xx:xx:xx:xx:xx</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_valid_ether_addr</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">netdev_warn</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;no valid ethernet hw addr</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* initial rx and tx list */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">desc_list_init</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">phy_start</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">phydev</span><span class="p">);</span>
	<span class="n">phy_write</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">phydev</span><span class="p">,</span> <span class="n">MII_BMCR</span><span class="p">,</span> <span class="n">BMCR_RESET</span><span class="p">);</span>
	<span class="n">setup_system_regs</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">setup_mac_addr</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">);</span>

	<span class="n">bfin_mac_disable</span><span class="p">();</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">bfin_mac_enable</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">phydev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;hardware init finished</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">netif_start_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">netif_carrier_on</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * this makes the board clean up everything that it can</span>
<span class="cm"> * and not talk to the outside world.   Caused by</span>
<span class="cm"> * an &#39;ifconfig ethX down&#39;</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">bfin_mac_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bfin_mac_local</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">netif_carrier_off</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">phy_stop</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">phydev</span><span class="p">);</span>
	<span class="n">phy_write</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">phydev</span><span class="p">,</span> <span class="n">MII_BMCR</span><span class="p">,</span> <span class="n">BMCR_PDOWN</span><span class="p">);</span>

	<span class="cm">/* clear everything */</span>
	<span class="n">bfin_mac_shutdown</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* free the rx/tx buffers */</span>
	<span class="n">desc_list_free</span><span class="p">();</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">net_device_ops</span> <span class="n">bfin_mac_netdev_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">ndo_open</span>		<span class="o">=</span> <span class="n">bfin_mac_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_stop</span>		<span class="o">=</span> <span class="n">bfin_mac_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_start_xmit</span>		<span class="o">=</span> <span class="n">bfin_mac_hard_start_xmit</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_set_mac_address</span>	<span class="o">=</span> <span class="n">bfin_mac_set_mac_address</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_tx_timeout</span>		<span class="o">=</span> <span class="n">bfin_mac_timeout</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_set_rx_mode</span>	<span class="o">=</span> <span class="n">bfin_mac_set_multicast_list</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_do_ioctl</span>           <span class="o">=</span> <span class="n">bfin_mac_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_validate_addr</span>	<span class="o">=</span> <span class="n">eth_validate_addr</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_change_mtu</span>		<span class="o">=</span> <span class="n">eth_change_mtu</span><span class="p">,</span>
<span class="cp">#ifdef CONFIG_NET_POLL_CONTROLLER</span>
	<span class="p">.</span><span class="n">ndo_poll_controller</span>	<span class="o">=</span> <span class="n">bfin_mac_poll</span><span class="p">,</span>
<span class="cp">#endif</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">bfin_mac_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bfin_mac_local</span> <span class="o">*</span><span class="n">lp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bfin_mii_bus_platform_data</span> <span class="o">*</span><span class="n">mii_bus_data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">ndev</span> <span class="o">=</span> <span class="n">alloc_etherdev</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">bfin_mac_local</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ndev</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">SET_NETDEV_DEV</span><span class="p">(</span><span class="n">ndev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">platform_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">ndev</span><span class="p">);</span>
	<span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">ndev</span> <span class="o">=</span> <span class="n">ndev</span><span class="p">;</span>

	<span class="cm">/* Grab the MAC address in the MAC */</span>
	<span class="o">*</span><span class="p">(</span><span class="n">__le32</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">bfin_read_EMAC_ADDRLO</span><span class="p">());</span>
	<span class="o">*</span><span class="p">(</span><span class="n">__le16</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">4</span><span class="p">]))</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">((</span><span class="n">u16</span><span class="p">)</span> <span class="n">bfin_read_EMAC_ADDRHI</span><span class="p">());</span>

	<span class="cm">/* probe mac */</span>
	<span class="cm">/*todo: how to proble? which is revision_register */</span>
	<span class="n">bfin_write_EMAC_ADDRLO</span><span class="p">(</span><span class="mh">0x12345678</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bfin_read_EMAC_ADDRLO</span><span class="p">()</span> <span class="o">!=</span> <span class="mh">0x12345678</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Cannot detect Blackfin on-chip ethernet MAC controller!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_err_probe_mac</span><span class="p">;</span>
	<span class="p">}</span>


	<span class="cm">/*</span>
<span class="cm">	 * Is it valid? (Did bootloader initialize it?)</span>
<span class="cm">	 * Grab the MAC from the board somehow</span>
<span class="cm">	 * this is done in the arch/blackfin/mach-bfxxx/boards/eth_mac.c</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_valid_ether_addr</span><span class="p">(</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bfin_get_ether_addr</span><span class="p">(</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">)</span> <span class="o">||</span>
		     <span class="o">!</span><span class="n">is_valid_ether_addr</span><span class="p">(</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* Still not valid, get a random one */</span>
			<span class="n">netdev_warn</span><span class="p">(</span><span class="n">ndev</span><span class="p">,</span> <span class="s">&quot;Setting Ethernet MAC to a random one</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">eth_hw_addr_random</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">setup_mac_addr</span><span class="p">(</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">platform_data</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Cannot get platform device bfin_mii_bus!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_err_probe_mac</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">pd</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">platform_data</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">mii_bus</span> <span class="o">=</span> <span class="n">platform_get_drvdata</span><span class="p">(</span><span class="n">pd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">mii_bus</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Cannot get mii_bus!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_err_probe_mac</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">mii_bus</span><span class="o">-&gt;</span><span class="n">priv</span> <span class="o">=</span> <span class="n">ndev</span><span class="p">;</span>
	<span class="n">mii_bus_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">platform_data</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">mii_probe</span><span class="p">(</span><span class="n">ndev</span><span class="p">,</span> <span class="n">mii_bus_data</span><span class="o">-&gt;</span><span class="n">phy_mode</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;MII Probe failed!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_err_mii_probe</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">vlan1_mask</span> <span class="o">=</span> <span class="n">ETH_P_8021Q</span> <span class="o">|</span> <span class="n">mii_bus_data</span><span class="o">-&gt;</span><span class="n">vlan1_mask</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">vlan2_mask</span> <span class="o">=</span> <span class="n">ETH_P_8021Q</span> <span class="o">|</span> <span class="n">mii_bus_data</span><span class="o">-&gt;</span><span class="n">vlan2_mask</span><span class="p">;</span>

	<span class="cm">/* Fill in the fields of the device structure with ethernet values. */</span>
	<span class="n">ether_setup</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>

	<span class="n">ndev</span><span class="o">-&gt;</span><span class="n">netdev_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">bfin_mac_netdev_ops</span><span class="p">;</span>
	<span class="n">ndev</span><span class="o">-&gt;</span><span class="n">ethtool_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">bfin_mac_ethtool_ops</span><span class="p">;</span>

	<span class="n">init_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_reclaim_timer</span><span class="p">);</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_reclaim_timer</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">lp</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_reclaim_timer</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="n">tx_reclaim_skb_timeout</span><span class="p">;</span>

	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="cm">/* now, enable interrupts */</span>
	<span class="cm">/* register irq handler */</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">IRQ_MAC_RX</span><span class="p">,</span> <span class="n">bfin_mac_interrupt</span><span class="p">,</span>
			<span class="n">IRQF_DISABLED</span><span class="p">,</span> <span class="s">&quot;EMAC_RX&quot;</span><span class="p">,</span> <span class="n">ndev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Cannot request Blackfin MAC RX IRQ!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_err_request_irq</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">register_netdev</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Cannot register net device!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_err_reg_ndev</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">bfin_mac_hwtstamp_init</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>

	<span class="cm">/* now, print out the card info, in a short format.. */</span>
	<span class="n">netdev_info</span><span class="p">(</span><span class="n">ndev</span><span class="p">,</span> <span class="s">&quot;%s, Version %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">DRV_DESC</span><span class="p">,</span> <span class="n">DRV_VERSION</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">out_err_reg_ndev:</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">IRQ_MAC_RX</span><span class="p">,</span> <span class="n">ndev</span><span class="p">);</span>
<span class="nl">out_err_request_irq:</span>
<span class="nl">out_err_mii_probe:</span>
	<span class="n">mdiobus_unregister</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">mii_bus</span><span class="p">);</span>
	<span class="n">mdiobus_free</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">mii_bus</span><span class="p">);</span>
<span class="nl">out_err_probe_mac:</span>
	<span class="n">platform_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">free_netdev</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devexit</span> <span class="nf">bfin_mac_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span> <span class="o">=</span> <span class="n">platform_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">bfin_mac_local</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>

	<span class="n">platform_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">mii_bus</span><span class="o">-&gt;</span><span class="n">priv</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">unregister_netdev</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>

	<span class="n">free_irq</span><span class="p">(</span><span class="n">IRQ_MAC_RX</span><span class="p">,</span> <span class="n">ndev</span><span class="p">);</span>

	<span class="n">free_netdev</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_PM</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">bfin_mac_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span> <span class="n">pm_message_t</span> <span class="n">mesg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">net_dev</span> <span class="o">=</span> <span class="n">platform_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">bfin_mac_local</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">net_dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">wol</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bfin_write_EMAC_OPMODE</span><span class="p">((</span><span class="n">bfin_read_EMAC_OPMODE</span><span class="p">()</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">TE</span><span class="p">)</span> <span class="o">|</span> <span class="n">RE</span><span class="p">);</span>
		<span class="n">bfin_write_EMAC_WKUP_CTL</span><span class="p">(</span><span class="n">MPKE</span><span class="p">);</span>
		<span class="n">enable_irq_wake</span><span class="p">(</span><span class="n">IRQ_MAC_WAKEDET</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">netif_running</span><span class="p">(</span><span class="n">net_dev</span><span class="p">))</span>
			<span class="n">bfin_mac_close</span><span class="p">(</span><span class="n">net_dev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bfin_mac_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">net_dev</span> <span class="o">=</span> <span class="n">platform_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">bfin_mac_local</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">net_dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">wol</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bfin_write_EMAC_OPMODE</span><span class="p">(</span><span class="n">bfin_read_EMAC_OPMODE</span><span class="p">()</span> <span class="o">|</span> <span class="n">TE</span><span class="p">);</span>
		<span class="n">bfin_write_EMAC_WKUP_CTL</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
		<span class="n">disable_irq_wake</span><span class="p">(</span><span class="n">IRQ_MAC_WAKEDET</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">netif_running</span><span class="p">(</span><span class="n">net_dev</span><span class="p">))</span>
			<span class="n">bfin_mac_open</span><span class="p">(</span><span class="n">net_dev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#else</span>
<span class="cp">#define bfin_mac_suspend NULL</span>
<span class="cp">#define bfin_mac_resume NULL</span>
<span class="cp">#endif	</span><span class="cm">/* CONFIG_PM */</span><span class="cp"></span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">bfin_mii_bus_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mii_bus</span> <span class="o">*</span><span class="n">miibus</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bfin_mii_bus_platform_data</span> <span class="o">*</span><span class="n">mii_bus_pd</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="o">*</span><span class="n">pin_req</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">mii_bus_pd</span> <span class="o">=</span> <span class="n">dev_get_platdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mii_bus_pd</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;No peripherals in platform data!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * We are setting up a network card,</span>
<span class="cm">	 * so set the GPIO pins to Ethernet mode</span>
<span class="cm">	 */</span>
	<span class="n">pin_req</span> <span class="o">=</span> <span class="n">mii_bus_pd</span><span class="o">-&gt;</span><span class="n">mac_peripherals</span><span class="p">;</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">peripheral_request_list</span><span class="p">(</span><span class="n">pin_req</span><span class="p">,</span> <span class="n">KBUILD_MODNAME</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Requesting peripherals failed!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">miibus</span> <span class="o">=</span> <span class="n">mdiobus_alloc</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">miibus</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_err_alloc</span><span class="p">;</span>
	<span class="n">miibus</span><span class="o">-&gt;</span><span class="n">read</span> <span class="o">=</span> <span class="n">bfin_mdiobus_read</span><span class="p">;</span>
	<span class="n">miibus</span><span class="o">-&gt;</span><span class="n">write</span> <span class="o">=</span> <span class="n">bfin_mdiobus_write</span><span class="p">;</span>
	<span class="n">miibus</span><span class="o">-&gt;</span><span class="n">reset</span> <span class="o">=</span> <span class="n">bfin_mdiobus_reset</span><span class="p">;</span>

	<span class="n">miibus</span><span class="o">-&gt;</span><span class="n">parent</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">miibus</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;bfin_mii_bus&quot;</span><span class="p">;</span>
	<span class="n">miibus</span><span class="o">-&gt;</span><span class="n">phy_mask</span> <span class="o">=</span> <span class="n">mii_bus_pd</span><span class="o">-&gt;</span><span class="n">phy_mask</span><span class="p">;</span>

	<span class="n">snprintf</span><span class="p">(</span><span class="n">miibus</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">MII_BUS_ID_SIZE</span><span class="p">,</span> <span class="s">&quot;%s-%x&quot;</span><span class="p">,</span>
		<span class="n">pdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
	<span class="n">miibus</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="o">*</span><span class="n">PHY_MAX_ADDR</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">miibus</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_err_irq_alloc</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">rc</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">PHY_MAX_ADDR</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
		<span class="n">miibus</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">PHY_POLL</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">clamp</span><span class="p">(</span><span class="n">mii_bus_pd</span><span class="o">-&gt;</span><span class="n">phydev_number</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">PHY_MAX_ADDR</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="n">mii_bus_pd</span><span class="o">-&gt;</span><span class="n">phydev_number</span><span class="p">)</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Invalid number (%i) of phydevs</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">mii_bus_pd</span><span class="o">-&gt;</span><span class="n">phydev_number</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">rc</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">phyaddr</span> <span class="o">=</span> <span class="n">mii_bus_pd</span><span class="o">-&gt;</span><span class="n">phydev_data</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">addr</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">phyaddr</span> <span class="o">&lt;</span> <span class="n">PHY_MAX_ADDR</span><span class="p">)</span>
			<span class="n">miibus</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">[</span><span class="n">phyaddr</span><span class="p">]</span> <span class="o">=</span> <span class="n">mii_bus_pd</span><span class="o">-&gt;</span><span class="n">phydev_data</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">irq</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;Invalid PHY address %i for phydev %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">phyaddr</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">mdiobus_register</span><span class="p">(</span><span class="n">miibus</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Cannot register MDIO bus!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_err_mdiobus_register</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">platform_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">miibus</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">out_err_mdiobus_register:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">miibus</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
<span class="nl">out_err_irq_alloc:</span>
	<span class="n">mdiobus_free</span><span class="p">(</span><span class="n">miibus</span><span class="p">);</span>
<span class="nl">out_err_alloc:</span>
	<span class="n">peripheral_free_list</span><span class="p">(</span><span class="n">pin_req</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devexit</span> <span class="nf">bfin_mii_bus_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mii_bus</span> <span class="o">*</span><span class="n">miibus</span> <span class="o">=</span> <span class="n">platform_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">bfin_mii_bus_platform_data</span> <span class="o">*</span><span class="n">mii_bus_pd</span> <span class="o">=</span>
		<span class="n">dev_get_platdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">platform_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">mdiobus_unregister</span><span class="p">(</span><span class="n">miibus</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">miibus</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
	<span class="n">mdiobus_free</span><span class="p">(</span><span class="n">miibus</span><span class="p">);</span>
	<span class="n">peripheral_free_list</span><span class="p">(</span><span class="n">mii_bus_pd</span><span class="o">-&gt;</span><span class="n">mac_peripherals</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_driver</span> <span class="n">bfin_mii_bus_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">probe</span> <span class="o">=</span> <span class="n">bfin_mii_bus_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span> <span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">bfin_mii_bus_remove</span><span class="p">),</span>
	<span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;bfin_mii_bus&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">owner</span>	<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_driver</span> <span class="n">bfin_mac_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">probe</span> <span class="o">=</span> <span class="n">bfin_mac_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span> <span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">bfin_mac_remove</span><span class="p">),</span>
	<span class="p">.</span><span class="n">resume</span> <span class="o">=</span> <span class="n">bfin_mac_resume</span><span class="p">,</span>
	<span class="p">.</span><span class="n">suspend</span> <span class="o">=</span> <span class="n">bfin_mac_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">KBUILD_MODNAME</span><span class="p">,</span>
		<span class="p">.</span><span class="n">owner</span>	<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">bfin_mac_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">platform_driver_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bfin_mii_bus_driver</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">platform_driver_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bfin_mac_driver</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">bfin_mac_init</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">bfin_mac_cleanup</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">platform_driver_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bfin_mac_driver</span><span class="p">);</span>
	<span class="n">platform_driver_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bfin_mii_bus_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_exit</span><span class="p">(</span><span class="n">bfin_mac_cleanup</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
